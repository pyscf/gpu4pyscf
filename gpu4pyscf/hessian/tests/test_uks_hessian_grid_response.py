# Copyright 2021-2024 The PySCF Developers. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import pyscf
import numpy as np
import cupy as cp
import unittest
import pytest
from gpu4pyscf.dft import UKS
from gpu4pyscf.hessian.uks import _get_exc_deriv2, _get_vxc_deriv1
from gpu4pyscf.hessian.tests.test_vv10_hessian import numerical_d2e_dft
from gpu4pyscf.hessian.tests.test_rks_hessian_grid_response import _get_exc_deriv2_numerical, _get_vxc_deriv1_numerical

def setUpModule():
    global mol

    mol = pyscf.M(
        atom = '''
            C     0.000000    0.000000    0.000000
            H     1.090000    0.000000    0.000000
            H    -0.845000    0.943190    0.000000
            H    -0.545000   -0.943190    0.000000
        ''',
        basis = 'def2-svp',
        charge = 0,
        spin = 1,
        output='/dev/null',
        verbose = 0,
    )

def tearDownModule():
    global mol
    mol.stdout.close()
    del mol

class KnownValues(unittest.TestCase):
    # All reference results from the same calculation with mf.level_shift = 0

    def test_hessian_unrestricted_grid_response_d2edAdB_lda(self):
        mf = UKS(mol, xc = 'LDA')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-8
        mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_de2 = _get_exc_deriv2(hobj, mf.mo_coeff, mf.mo_occ, mf.make_rdm1(), max_memory = None)
        reference_de2 = _get_exc_deriv2_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_de2 - reference_de2).max() < 1e-8

    def test_hessian_unrestricted_grid_response_d2edAdB_gga(self):
        mf = UKS(mol, xc = 'PBE0')
        mf.grids.atom_grid = (99,590)
        mf.conv_tol = 1e-8
        # mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        # hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_de2 = _get_exc_deriv2(hobj, mf.mo_coeff, mf.mo_occ, mf.make_rdm1(), max_memory = None)
        reference_de2 = _get_exc_deriv2_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_de2 - reference_de2).max() < 1e-8

    def test_hessian_unrestricted_grid_response_d2edAdB_mgga(self):
        mf = UKS(mol, xc = 'wB97M-d3bj')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-8
        mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        # hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_de2 = _get_exc_deriv2(hobj, mf.mo_coeff, mf.mo_occ, mf.make_rdm1(), max_memory = None)
        reference_de2 = _get_exc_deriv2_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_de2 - reference_de2).max() < 1e-8

    def test_hessian_unrestricted_grid_response_dFdA_lda(self):
        mf = UKS(mol, xc = 'LDA')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-8
        # mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        # hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_dF = _get_vxc_deriv1(hobj, mf.mo_coeff, mf.mo_occ, max_memory = 16000)
        reference_dF = _get_vxc_deriv1_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_dF[0] - reference_dF[0]).max() < 1e-8
        assert abs(test_dF[1] - reference_dF[1]).max() < 1e-8

    def test_hessian_unrestricted_grid_response_dFdA_gga(self):
        mf = UKS(mol, xc = 'wB97X-V')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-8
        mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_dF = _get_vxc_deriv1(hobj, mf.mo_coeff, mf.mo_occ, max_memory = 16000)
        reference_dF = _get_vxc_deriv1_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_dF[0] - reference_dF[0]).max() < 1e-8
        assert abs(test_dF[1] - reference_dF[1]).max() < 1e-8

    def test_hessian_unrestricted_grid_response_dFdA_mgga(self):
        mf = UKS(mol, xc = 'r2SCAN')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-8
        # mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        # hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_dF = _get_vxc_deriv1(hobj, mf.mo_coeff, mf.mo_occ, max_memory = 16000)
        reference_dF = _get_vxc_deriv1_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_dF[0] - reference_dF[0]).max() < 1e-8
        assert abs(test_dF[1] - reference_dF[1]).max() < 1e-8

    def test_hessian_unrestricted_grid_response_lda(self):
        mf = UKS(mol, xc = 'LDA')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-12
        mf.conv_tol_cpscf = 1e-10
        mf.cphf_grids.atom_grid = mf.grids.atom_grid
        mf.cphf_grids.prune = mf.grids.prune
        mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_hessian = hobj.kernel()

        # reference_hessian = numerical_d2e_dft(mf, dx = 1e-3)
        reference_hessian = np.array([[[[ 0.5707195503009271,  0.1626560836001656, -0.0000000000004854],
         [ 0.1626615322662117,  0.4853317595055473, -0.0000000000001728],
         [-0.0000001587051324, -0.0000001219045698,  0.0048691754683673]],

        [[-0.3532369661635171, -0.0052009331668029, -0.0000000000003677],
         [-0.0125615622100783, -0.0093934226903713,  0.0000000000004777],
         [-0.0000002155066126,  0.0000002409634775,  0.0439479128668272]],

        [[-0.0924573270768558,  0.0309152475101993,  0.0000000000002951],
         [ 0.0319184449935617, -0.1169533122628019, -0.000000000000296 ],
         [ 0.0000002735031646, -0.000000296033309 , -0.0512557183869001]],

        [[-0.1250252570553778, -0.1883703979411733,  0.0000000000005382],
         [-0.1820184150488346, -0.3589850245495629, -0.0000000000000129],
         [ 0.0000001007051664,  0.0000001769766556,  0.0024386300524689]]],


       [[[-0.3532357514234655, -0.0125567460823595,  0.0000006820567955],
         [-0.0052050403485798, -0.009400931090614 ,  0.0000000000005765],
         [ 0.0000003278307487,  0.0000017176862988,  0.043946506016138 ]],

        [[ 0.3599218367590362,  0.010786392552288 , -0.0000002039267369],
         [ 0.0107881389995734, -0.0032869418718834, -0.0000000000005331],
         [-0.0000004748009763, -0.0000000642698186, -0.0507968627638495]],

        [[-0.001064249077809 , -0.0054911513606704, -0.0000005335874237],
         [ 0.0138796422120557,  0.0059157059226767, -0.0000000000000646],
         [ 0.0000006791437412, -0.0000007598125462,  0.0007307982716216]],

        [[-0.0056218362612381,  0.0072615048928304,  0.0000000554573633],
         [-0.0194627408593995,  0.0067721670380383,  0.0000000000000108],
         [-0.0000005321721952, -0.0000008936063001,  0.0061195584755978]]],


       [[[-0.0924630973193757,  0.031913522024779 , -0.0000007991760181],
         [ 0.0309169735785292, -0.116954701027322 ,  0.0000000000015305],
         [ 0.0000008437904472, -0.0000007215570363, -0.0512609106361728]],

        [[-0.0010633642338886,  0.0138807869993901, -0.0000003697764762],
         [-0.0054907303282947,  0.0059150908939768, -0.0000000000000812],
         [-0.0000066804597409,  0.0000008310433348,  0.0007339719452605]],

        [[ 0.0896025704321679, -0.0398631082857426,  0.0000005697865625],
         [-0.0398643466341664,  0.1196100047638482, -0.0000000000007319],
         [ 0.0000039312059164, -0.0000024887438776,  0.0447557834842077]],

        [[ 0.0039238911214157, -0.0059312007391066,  0.0000005991659451],
         [ 0.0144381033900243, -0.0085703946297588, -0.000000000000711 ],
         [ 0.0000019054630651,  0.0000023792552373,  0.0057711552068257]]],


       [[[-0.1250289911055719, -0.1820149912407087, -0.0000025929740717],
         [-0.1883796397237972, -0.3589829712742632, -0.0000000000011423],
         [-0.0000018194572307, -0.0000010889313062,  0.0024286967658768]],

        [[-0.0056186204128172, -0.0194655648873892,  0.000001416357078 ],
         [ 0.0072672095504656,  0.0067675269597852,  0.0000000000005616],
         [-0.0000049267481206,  0.0000008158922227,  0.0061253213060923]],

        [[ 0.0039219763677267,  0.0144372085543742,  0.0000002320348407],
         [-0.0059325125877363, -0.0085734247835534,  0.0000000000002568],
         [ 0.0000043812808936, -0.0000037051108293,  0.005771708528144 ]],

        [[ 0.1267256351498713,  0.187043347574356 ,  0.0000009445821455],
         [ 0.1870449427608945,  0.3607888690962957,  0.0000000000003318],
         [ 0.0000023649247005,  0.0000039781511418, -0.0143257266005054]]]])

        assert np.max(np.abs(test_hessian - reference_hessian)) < 1e-4
        # Translation invariance
        assert np.max(np.abs(np.sum(test_hessian, axis = 0))) < 1e-10

    def test_hessian_unrestricted_grid_response_gga(self):
        mf = UKS(mol, xc = "revPBE")
        mf.grids.atom_grid = (20,26)
        mf.conv_tol = 1e-12
        mf.conv_tol_cpscf = 1e-10
        mf.cphf_grids.atom_grid = mf.grids.atom_grid
        mf.cphf_grids.prune = mf.grids.prune
        # mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_hessian = hobj.kernel()

        # reference_hessian = numerical_d2e_dft(mf, dx = 4e-3)
        reference_hessian = np.array([[[[ 0.5881463970112706,  0.1211386971501638, -0.0000000000000529],
         [ 0.1211350605861625,  0.4506283201038339, -0.0000000000000372],
         [-0.0000006512391555,  0.0000005700882752,  0.0538879584241884]],

        [[-0.3790887888731054, -0.0032609156549784, -0.0000000000003552],
         [-0.0115750661662806, -0.0584626620944129,  0.0000000000000026],
         [ 0.0000003391386338, -0.0000003840012678, -0.0115219722890125]],

        [[-0.0944036315072005,  0.0271286206489085,  0.0000000000001547],
         [ 0.0268783983182891, -0.1173670579734665,  0.0000000000000105],
         [ 0.0000000130308264, -0.0000002605340527, -0.0326636660844471]],

        [[-0.1146539766274934, -0.1450064021440989,  0.000000000000255 ],
         [-0.1364383927401902, -0.2747986000324609,  0.0000000000000251],
         [ 0.0000002990698522,  0.0000000744473094, -0.0097023200499114]]],


       [[[-0.3790855533722243, -0.0115720371956507, -0.000000024615438 ],
         [-0.0032611921789265, -0.0584615851970116,  0.000000000001371 ],
         [ 0.0000003922406479,  0.000000088927761 , -0.0115223791193567]],

        [[ 0.3870872408233417,  0.0106814730127843, -0.0000000313542464],
         [ 0.0106817628311162,  0.0499685389765993, -0.0000000000007978],
         [-0.0000003251968694,  0.0000000245130923,  0.0068502448045267]],

        [[-0.0009306057945496, -0.0038459041618033, -0.0000012297407368],
         [ 0.0160267171118583,  0.0046151625494317, -0.0000000000023973],
         [ 0.0000000054513477, -0.0000000309846593, -0.001118484828455 ]],

        [[-0.007071081662105 ,  0.0047364683462836,  0.0000012857104234],
         [-0.0234472877671116,  0.0038778836698172,  0.0000000000018252],
         [-0.0000000724935945, -0.0000000824565971,  0.0057906191428346]]],


       [[[-0.0944091521876377,  0.0268717395024085, -0.0000002566278707],
         [ 0.0271320414713836, -0.1173639820351985, -0.000000000001018 ],
         [ 0.00000165866452  ,  0.0000015454350299, -0.0326623590818173]],

        [[-0.0009295308301127,  0.0160265092487449, -0.000000078084366 ],
         [-0.0038456821990218,  0.0046156984272487,  0.0000000000004568],
         [-0.0000011299395586, -0.0000000368010368, -0.0011186451500806]],

        [[ 0.0897687143511378, -0.0382275354718908,  0.0000007725356049],
         [-0.0382279724130824,  0.1211080808877357,  0.0000000000012136],
         [ 0.0000000820235407, -0.000000091535321 ,  0.0283197706865471]],

        [[ 0.0055699686635352, -0.0046707132755064, -0.0000004378233685],
         [ 0.0149416131413477, -0.0083597972812266, -0.0000000000006533],
         [-0.0000006107469669, -0.0000014170972729,  0.005461233545463 ]]],


       [[[-0.1146544710585035, -0.1364327413227243,  0.0000000209608242],
         [-0.14501515941     , -0.2747939657836151, -0.00000000000013  ],
         [-0.0000001200790301,  0.0000000018890514, -0.0097027237846366]],

        [[-0.0070690462636303, -0.0234472506656974,  0.0000001803752727],
         [ 0.0047426336208523,  0.0038774778584225, -0.0000000000001537],
         [-0.0000000176728354,  0.000000037716901 ,  0.0057909651482515]],

        [[ 0.0055691291103999,  0.0149416264684232, -0.0000000234109521],
         [-0.0046708890939079, -0.0083608672789282,  0.0000000000001711],
         [ 0.000000118694693 , -0.0000000402801265,  0.0054611151282856]],

        [[ 0.1161543882039345,  0.1449383655194592, -0.0000001779251459],
         [ 0.1449434148808881,  0.2792773552015571,  0.0000000000001174],
         [ 0.0000000190541471,  0.0000000006782908, -0.0015493564923762]]]])

        assert np.max(np.abs(test_hessian - reference_hessian)) < 1e-4
        # Translation invariance
        assert np.max(np.abs(np.sum(test_hessian, axis = 0))) < 1e-10

    def test_hessian_unrestricted_grid_response_mgga(self):
        mf = UKS(mol, xc = 'r2SCAN')
        mf.grids.atom_grid = (20,194)
        mf.conv_tol = 1e-12
        mf.conv_tol_cpscf = 1e-10
        mf.cphf_grids.atom_grid = mf.grids.atom_grid
        mf.cphf_grids.prune = mf.grids.prune
        # mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_hessian = hobj.kernel()

        # reference_hessian = numerical_d2e_dft(mf, dx = 4e-3)
        reference_hessian = np.array([[[[ 0.5820155221143387,  0.1166859509692322,  0.0000000000000068],
         [ 0.1166914308990807,  0.4215371295934883, -0.000000000000019 ],
         [-0.0000031473303009,  0.0000008876429591,  0.0422379005416061]],

        [[-0.3671822912818257,  0.0001641790860455, -0.0000000000001163],
         [-0.0084188365954696, -0.045232076075573 ,  0.0000000000000735],
         [ 0.0000018059421736, -0.000000696544257 ,  0.0007909441897174]],

        [[-0.0887119779785228,  0.0210857724144836,  0.0000000000000498],
         [ 0.0257029513710816, -0.0977462026366532, -0.0000000000000094],
         [ 0.0000006044114792, -0.0000007370008631, -0.0335608035483526]],

        [[-0.1261212528438083, -0.1379359024675231,  0.0000000000000598],
         [-0.1339755456715441, -0.2785588508753545, -0.0000000000000455],
         [ 0.0000007369764382,  0.0000005459006858, -0.0094680411821944]]],


       [[[-0.36718439518541  , -0.0084145827370652, -0.0000010937446911],
         [ 0.0001613660267318, -0.0452296250851095,  0.0000000000047075],
         [ 0.0000011557333458, -0.0000003566965959,  0.0007895705733541]],

        [[ 0.3720461948922005,  0.0076307092713296,  0.0000006044353657],
         [ 0.0076326721058506,  0.0370290106022019, -0.0000000000016288],
         [-0.0000007294261029,  0.0000000682071752, -0.0003285793846421]],

        [[-0.0003574875750562, -0.0046145009915538, -0.0000017249352664],
         [ 0.0141134126344089,  0.0040211384784578, -0.0000000000083034],
         [-0.0000003721849218,  0.0000003096229245, -0.0029342109973904]],

        [[-0.0045043121333632,  0.0053983744558728,  0.0000022142445921],
         [-0.021907450764691 ,  0.0041794760064773,  0.0000000000052253],
         [-0.0000000541214712, -0.0000000211295703,  0.0024732198082593]]],


       [[[-0.0887194194503661,  0.0256980264625242,  0.000000148508423 ],
         [ 0.0210853288650416, -0.0977477213169667,  0.0000000000005413],
         [ 0.0000032405625336,  0.000001767831076 , -0.0335579759419456]],

        [[-0.0003552163563569,  0.0141117532326946, -0.0000005147952575],
         [-0.0046118792429717,  0.0040227438962131,  0.0000000000001137],
         [-0.0000015905651241, -0.000000030696399 , -0.0029348152091413]],

        [[ 0.0824356948214006, -0.0330085155503534,  0.0000008643203307],
         [-0.0330096046065181,  0.1090590747974546, -0.00000000000069  ],
         [-0.0000003967634138,  0.0000002395047077,  0.0313808111003626]],

        [[ 0.0066389409815876, -0.0068012641426252, -0.0000004980334961],
         [ 0.016536154988242 , -0.0153340973802762,  0.000000000000036 ],
         [-0.0000012532340304, -0.0000019766386028,  0.0051119800508289]]],


       [[[-0.1261171771924068, -0.1339717620026659, -0.0000010840465282],
         [-0.1379348300095638, -0.2785603603433773, -0.0000000000087387],
         [ 0.0000000260601141,  0.0000011230939095, -0.0094691791798755]],

        [[-0.004504017141832 , -0.021907299380222 ,  0.0000011358784016],
         [ 0.0053978468682048,  0.0041799409876129,  0.000000000009209 ],
         [-0.0000002916932251,  0.0000000006658938,  0.0024740823052023]],

        [[ 0.0066327879852252,  0.0165384077064068,  0.000000298204179 ],
         [-0.0068089746262101, -0.0153332385975646,  0.0000000000081774],
         [ 0.0000005948822129, -0.0000005310908796,  0.0051111633828136]],

        [[ 0.123988406347697 ,  0.1393406536718544, -0.0000003500360516],
         [ 0.1393459577633538,  0.2897136579541049, -0.0000000000086471],
         [-0.000000329248323 , -0.0000005926717728,  0.0018839334914163]]]])

        assert np.max(np.abs(test_hessian - reference_hessian)) < 1e-4
        # Translation invariance
        assert np.max(np.abs(np.sum(test_hessian, axis = 0))) < 1e-10

    # def test_hessian_unrestricted_grid_response_vv10(self):
    #     mf = UKS(mol, xc = 'wB97M-V')
    #     mf.grids.atom_grid = (10,14)
    #     mf.nlcgrids.atom_grid = (15,14)
    #     mf.conv_tol = 1e-12
    #     mf.conv_tol_cpscf = 1e-10
    #     mf.cphf_grids.atom_grid = mf.grids.atom_grid
    #     mf.cphf_grids.prune = mf.grids.prune
    #     mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

    #     mf.kernel()
    #     assert mf.converged

    #     hobj = mf.Hessian()
    #     hobj.auxbasis_response = 2
    #     hobj.grid_response = True

    #     test_hessian = hobj.kernel()

    #     # reference_hessian = numerical_d2e_dft(mf, dx = 1e-3)
    #     reference_hessian = np.array([[[[ 0.5119242880652353,  0.0600552100236129,  0.3310596056884663],
    #      [ 0.0600392618100853,  0.3522280861885108,  0.0693688618416122],
    #      [ 0.3310443052255696,  0.0693448856354806,  0.1492223138748194]],

    #     [[ 0.0308251280138477, -0.0333680253703506, -0.005599868620032 ],
    #      [ 0.0294542457289979, -0.252317468694585 , -0.0537590194421567],
    #      [-0.0000980633357919, -0.0759912042447297,  0.0111281742900537]],

    #     [[-0.5466985222231102, -0.0130722299946928, -0.3309991091859921],
    #      [-0.0754200138237682, -0.0709503882117546, -0.0408666584863493],
    #      [-0.3303974530681764, -0.010527259263815 , -0.164147626015243 ]],

    #     [[ 0.0039491061278873, -0.0136149546572928,  0.0055393721119512],
    #      [-0.0140734937215115, -0.0289602293423452,  0.0252568160871158],
    #      [-0.0005487888224964,  0.0171735778803639,  0.0037971378455404]]],


    #    [[[ 0.0308214718031108,  0.029449212807009 , -0.0000881169148204],
    #      [-0.0333487353674222, -0.2523200205919451, -0.076028116420046 ],
    #      [-0.0056012422029461, -0.0537444828001554,  0.0111428811970793]],

    #     [[-0.013535855779831 ,  0.0044398683085589,  0.0391973633909748],
    #      [ 0.0044644487885367,  0.2946616204013708,  0.0991369437092215],
    #      [ 0.0391914902598198,  0.0991106174268452, -0.0482020126073568]],

    #     [[-0.0005149240169811, -0.0451818390371228, -0.0014823988582213],
    #      [ 0.0149344297191156, -0.0309069154972863,  0.0058540084142411],
    #      [ 0.0025530751499581, -0.0237451529775945,  0.0019341008570262]],

    #     [[-0.01677069200684  ,  0.0112927579201949, -0.0376268476180441],
    #      [ 0.0139498568615393, -0.0114346843808066, -0.0289628356984206],
    #      [-0.0361433232080044, -0.0216209816420454,  0.035125030558969 ]]],


    #    [[[-0.5466591996347026, -0.0754623991694459, -0.3304145171768025],
    #      [-0.0130503282580463, -0.0709486737129339, -0.0104926674910355],
    #      [-0.3310033845190796, -0.040869880543859 , -0.1641580640592832]],

    #     [[-0.0005353207638004,  0.0149760989085479,  0.0025490046078325],
    #      [-0.0452319171716647, -0.0309128825808358, -0.0237768699469232],
    #      [-0.001458751309788 ,  0.0058480319840015,  0.0019407190016141]],

    #     [[ 0.548445034233902 ,  0.0607068782965681,  0.3286525416672514],
    #      [ 0.0606905330995389,  0.1031843955936473,  0.0323626448164305],
    #      [ 0.3286423568700236,  0.0323747868162805,  0.1634653472850633]],

    #     [[-0.0012505138210495, -0.0002205780329501, -0.0007870290899548],
    #      [-0.0024082876681208, -0.001322839295187 ,  0.0019068926244703],
    #      [ 0.0038197789620775,  0.0026470617451313, -0.0012480022199557]]],


    #    [[[ 0.0039625207426397, -0.0140906595982315, -0.0005921162040678],
    #      [-0.0136156526573394, -0.0289617980460122,  0.017185508928097 ],
    #      [ 0.0055446708626672,  0.0252692762554574,  0.0037741474692154]],

    #     [[-0.016747727537833 ,  0.0140229270337855, -0.0361259722384544],
    #      [ 0.0112854386013633, -0.0114345172059771, -0.0216287835588247],
    #      [-0.0376177222767213, -0.0289570957576757,  0.0351351629871433]],

    #     [[-0.0012339905870462, -0.0024587224934924,  0.0038372855798441],
    #      [-0.0002151739453282, -0.0013231699385052,  0.0026430112562981],
    #      [-0.0007893728557473,  0.0018908784633065, -0.0012431896900811]],

    #     [[ 0.0140191973790893,  0.0025264550559956,  0.032880802861901 ],
    #      [ 0.0025453880014292,  0.0417194851861924,  0.0018002633722647],
    #      [ 0.0328624242675324,  0.0017969410377461, -0.0376661207661111]]]])

    #     assert np.max(np.abs(test_hessian - reference_hessian)) < 2e-4
    #     # Translation invariance
    #     assert np.max(np.abs(np.sum(test_hessian, axis = 0))) < 1e-8

if __name__ == "__main__":
    print("Tests for UKS hessian with grid response")
    unittest.main()

