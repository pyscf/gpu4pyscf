# Copyright 2021-2024 The PySCF Developers. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import pyscf
import numpy as np
import cupy as cp
import unittest
import pytest
from gpu4pyscf.dft import UKS
from gpu4pyscf.hessian.uks import _get_exc_deriv2, _get_vxc_deriv1
from gpu4pyscf.hessian.tests.test_vv10_hessian import numerical_d2e_dft
from gpu4pyscf.hessian.tests.test_rks_hessian_grid_response import _get_exc_deriv2_numerical, _get_vxc_deriv1_numerical

def setUpModule():
    global mol

    mol = pyscf.M(
        atom = '''
            C     0.000000    0.000000    0.000000
            H     1.090000    0.000000    0.000000
            H    -0.845000    0.943190    0.000000
            H    -0.545000   -0.943190    0.000000
        ''',
        basis = 'def2-svp',
        charge = 0,
        spin = 1,
        output='/dev/null',
        verbose = 0,
    )

def tearDownModule():
    global mol
    mol.stdout.close()
    del mol

class KnownValues(unittest.TestCase):
    # All reference results from the same calculation with mf.level_shift = 0

    def test_hessian_unrestricted_grid_response_d2edAdB_lda(self):
        mf = UKS(mol, xc = 'LDA')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-8
        mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_de2 = _get_exc_deriv2(hobj, mf.mo_coeff, mf.mo_occ, mf.make_rdm1(), max_memory = None)
        reference_de2 = _get_exc_deriv2_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_de2 - reference_de2).max() < 1e-8

    def test_hessian_unrestricted_grid_response_d2edAdB_gga(self):
        mf = UKS(mol, xc = 'PBE0')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-8
        # mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        # hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_de2 = _get_exc_deriv2(hobj, mf.mo_coeff, mf.mo_occ, mf.make_rdm1(), max_memory = None)
        reference_de2 = _get_exc_deriv2_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_de2 - reference_de2).max() < 1e-8

    def test_hessian_unrestricted_grid_response_d2edAdB_mgga(self):
        mf = UKS(mol, xc = 'wB97M-d3bj')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-8
        mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        # hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_de2 = _get_exc_deriv2(hobj, mf.mo_coeff, mf.mo_occ, mf.make_rdm1(), max_memory = None)
        reference_de2 = _get_exc_deriv2_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_de2 - reference_de2).max() < 1e-8

    def test_hessian_unrestricted_grid_response_dFdA_lda(self):
        mf = UKS(mol, xc = 'LDA')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-8
        # mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        # hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_dF = _get_vxc_deriv1(hobj, mf.mo_coeff, mf.mo_occ, max_memory = 16000)
        reference_dF = _get_vxc_deriv1_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_dF[0] - reference_dF[0]).max() < 1e-8
        assert abs(test_dF[1] - reference_dF[1]).max() < 1e-8

    def test_hessian_unrestricted_grid_response_dFdA_gga(self):
        mf = UKS(mol, xc = 'wB97X-V')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-8
        mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_dF = _get_vxc_deriv1(hobj, mf.mo_coeff, mf.mo_occ, max_memory = 16000)
        reference_dF = _get_vxc_deriv1_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_dF[0] - reference_dF[0]).max() < 1e-8
        assert abs(test_dF[1] - reference_dF[1]).max() < 1e-8

    def test_hessian_unrestricted_grid_response_dFdA_mgga(self):
        mf = UKS(mol, xc = 'r2SCAN')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-8
        # mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        # hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_dF = _get_vxc_deriv1(hobj, mf.mo_coeff, mf.mo_occ, max_memory = 16000)
        reference_dF = _get_vxc_deriv1_numerical(hobj, mf.mo_coeff, mf.mo_occ, max_memory = None)

        assert abs(test_dF[0] - reference_dF[0]).max() < 1e-8
        assert abs(test_dF[1] - reference_dF[1]).max() < 1e-8

    def test_hessian_unrestricted_grid_response_lda(self):
        mf = UKS(mol, xc = 'LDA')
        mf.grids.atom_grid = (10,14)
        mf.conv_tol = 1e-12
        mf.conv_tol_cpscf = 1e-10
        mf.cphf_grids.atom_grid = mf.grids.atom_grid
        mf.cphf_grids.prune = mf.grids.prune
        mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

        mf.kernel()
        assert mf.converged

        hobj = mf.Hessian()
        hobj.auxbasis_response = 2
        hobj.grid_response = True

        test_hessian = hobj.kernel()

        # reference_hessian = numerical_d2e_dft(mf, dx = 1e-3)
        reference_hessian = np.array([[[[ 0.5707195503009271,  0.1626560836001656, -0.0000000000004854],
         [ 0.1626615322662117,  0.4853317595055473, -0.0000000000001728],
         [-0.0000001587051324, -0.0000001219045698,  0.0048691754683673]],

        [[-0.3532369661635171, -0.0052009331668029, -0.0000000000003677],
         [-0.0125615622100783, -0.0093934226903713,  0.0000000000004777],
         [-0.0000002155066126,  0.0000002409634775,  0.0439479128668272]],

        [[-0.0924573270768558,  0.0309152475101993,  0.0000000000002951],
         [ 0.0319184449935617, -0.1169533122628019, -0.000000000000296 ],
         [ 0.0000002735031646, -0.000000296033309 , -0.0512557183869001]],

        [[-0.1250252570553778, -0.1883703979411733,  0.0000000000005382],
         [-0.1820184150488346, -0.3589850245495629, -0.0000000000000129],
         [ 0.0000001007051664,  0.0000001769766556,  0.0024386300524689]]],


       [[[-0.3532357514234655, -0.0125567460823595,  0.0000006820567955],
         [-0.0052050403485798, -0.009400931090614 ,  0.0000000000005765],
         [ 0.0000003278307487,  0.0000017176862988,  0.043946506016138 ]],

        [[ 0.3599218367590362,  0.010786392552288 , -0.0000002039267369],
         [ 0.0107881389995734, -0.0032869418718834, -0.0000000000005331],
         [-0.0000004748009763, -0.0000000642698186, -0.0507968627638495]],

        [[-0.001064249077809 , -0.0054911513606704, -0.0000005335874237],
         [ 0.0138796422120557,  0.0059157059226767, -0.0000000000000646],
         [ 0.0000006791437412, -0.0000007598125462,  0.0007307982716216]],

        [[-0.0056218362612381,  0.0072615048928304,  0.0000000554573633],
         [-0.0194627408593995,  0.0067721670380383,  0.0000000000000108],
         [-0.0000005321721952, -0.0000008936063001,  0.0061195584755978]]],


       [[[-0.0924630973193757,  0.031913522024779 , -0.0000007991760181],
         [ 0.0309169735785292, -0.116954701027322 ,  0.0000000000015305],
         [ 0.0000008437904472, -0.0000007215570363, -0.0512609106361728]],

        [[-0.0010633642338886,  0.0138807869993901, -0.0000003697764762],
         [-0.0054907303282947,  0.0059150908939768, -0.0000000000000812],
         [-0.0000066804597409,  0.0000008310433348,  0.0007339719452605]],

        [[ 0.0896025704321679, -0.0398631082857426,  0.0000005697865625],
         [-0.0398643466341664,  0.1196100047638482, -0.0000000000007319],
         [ 0.0000039312059164, -0.0000024887438776,  0.0447557834842077]],

        [[ 0.0039238911214157, -0.0059312007391066,  0.0000005991659451],
         [ 0.0144381033900243, -0.0085703946297588, -0.000000000000711 ],
         [ 0.0000019054630651,  0.0000023792552373,  0.0057711552068257]]],


       [[[-0.1250289911055719, -0.1820149912407087, -0.0000025929740717],
         [-0.1883796397237972, -0.3589829712742632, -0.0000000000011423],
         [-0.0000018194572307, -0.0000010889313062,  0.0024286967658768]],

        [[-0.0056186204128172, -0.0194655648873892,  0.000001416357078 ],
         [ 0.0072672095504656,  0.0067675269597852,  0.0000000000005616],
         [-0.0000049267481206,  0.0000008158922227,  0.0061253213060923]],

        [[ 0.0039219763677267,  0.0144372085543742,  0.0000002320348407],
         [-0.0059325125877363, -0.0085734247835534,  0.0000000000002568],
         [ 0.0000043812808936, -0.0000037051108293,  0.005771708528144 ]],

        [[ 0.1267256351498713,  0.187043347574356 ,  0.0000009445821455],
         [ 0.1870449427608945,  0.3607888690962957,  0.0000000000003318],
         [ 0.0000023649247005,  0.0000039781511418, -0.0143257266005054]]]])

        assert np.max(np.abs(test_hessian - reference_hessian)) < 1e-4
        # Translation invariance
        assert np.max(np.abs(np.sum(test_hessian, axis = 0))) < 1e-10

    # def test_hessian_unrestricted_grid_response_gga(self):
    #     mf = UKS(mol, xc = "revPBE")
    #     mf.grids.atom_grid = (10,14)
    #     mf.conv_tol = 1e-12
    #     mf.conv_tol_cpscf = 1e-10
    #     mf.cphf_grids.atom_grid = mf.grids.atom_grid
    #     mf.cphf_grids.prune = mf.grids.prune
    #     # mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

    #     mf.kernel()
    #     assert mf.converged

    #     hobj = mf.Hessian()
    #     hobj.auxbasis_response = 2
    #     hobj.grid_response = True

    #     test_hessian = hobj.kernel()

    #     # reference_hessian = numerical_d2e_dft(mf, dx = 1e-3)
    #     reference_hessian = np.array([[[[ 0.5587746732195892,  0.1723259378879904,  0.0000000000001929],
    #      [ 0.1723256945714916,  0.4912031136335704,  0.0000000000000139],
    #      [-0.0000010619924523, -0.0000004376960738,  0.0048848124433057]],

    #     [[-0.3365346720836104, -0.0060743020490629,  0.0000000000011047],
    #      [-0.0137064109690943, -0.0140742218927604,  0.0000000000006077],
    #      [ 0.0000007709527461,  0.0000002436456002,  0.0475211928157274]],

    #     [[-0.0900089732039366,  0.0225294087486394, -0.0000000000006042],
    #      [ 0.0228828636852918, -0.1146353356242247, -0.0000000000001063],
    #      [ 0.0000002275908351, -0.0000000967848579, -0.0539964613914587]],

    #     [[-0.132231027938523 , -0.1887810445851956, -0.0000000000006793],
    #      [-0.1815021472984513, -0.3624935561181708, -0.0000000000004963],
    #      [ 0.0000000634480801,  0.0000002908180363,  0.0015904561332866]]],


    #    [[[-0.3365351637394376, -0.0137073173872848,  0.0000000196728987],
    #      [-0.0060745571831902, -0.0140727740182978, -0.0000000000000927],
    #      [-0.0000001458242138, -0.0000001099668134,  0.0475215873501659]],

    #     [[ 0.3444594442091331,  0.0120835229159566, -0.0000000585776663],
    #      [ 0.0120833821963817, -0.00104164277678  ,  0.0000000000001037],
    #      [ 0.0000001639451908,  0.0000000113228159, -0.0572776145011945]],

    #     [[-0.0014940546409492, -0.0057822952415632, -0.0000001741621489],
    #      [ 0.015090624449432 ,  0.00709260207854  , -0.0000000000000929],
    #      [-0.0000000427011759,  0.0000000454466464,  0.0013672319254727]],

    #     [[-0.0064302258586113,  0.0074060897059525,  0.0000002130669207],
    #      [-0.0210994494508898,  0.0080218147009425,  0.0000000000000633],
    #      [ 0.0000000245820031,  0.0000000532026645,  0.0083887952249942]]],


    #    [[[-0.0900104660894602,  0.0228825165617397, -0.0000004531759136],
    #      [ 0.0225169666715347, -0.1146365124860271,  0.0000000000003471],
    #      [ 0.0000010223345642,  0.0000009896899689, -0.0539948969510978]],

    #     [[-0.0014936489748374,  0.0150897522792045, -0.0000000415895787],
    #      [-0.0057746094944688,  0.0070930019198893, -0.0000000000000897],
    #      [-0.0000005941415138, -0.0000000920478095,  0.0013674228079166]],

    #     [[ 0.0875342744905971, -0.0318719632662612,  0.0000007319235419],
    #      [-0.0318687488030656,  0.1169691162288267, -0.0000000000005468],
    #      [ 0.0000000277789458,  0.0000000206279993,  0.0455868715949596]],

    #     [[ 0.0039698405747135, -0.0061003055731312, -0.0000002371580451],
    #      [ 0.0151263916126632, -0.0094256056770714,  0.0000000000002859],
    #      [-0.0000004559644884, -0.0000009182542504,  0.0070406025483154]]],


    #    [[[-0.1322309132305438, -0.181501264513162 , -0.0000007418384241],
    #      [-0.1887796705452791, -0.3624937978069231,  0.00000000000001  ],
    #      [ 0.0000001209383843,  0.0000006043828493,  0.0015887008964622]],

    #     [[-0.0064304715531316, -0.0210990403517472,  0.0000007761782787],
    #      [ 0.0074055677995455,  0.00802244694859  , -0.0000000000001797],
    #      [-0.0000001716691234, -0.0000000641549739,  0.0083888622129625]],

    #     [[ 0.0039693742168723,  0.0151243623667252,  0.0000001338319125],
    #      [-0.0061022435987601, -0.0094289364321321,  0.0000000000001688],
    #      [ 0.0000002550757383, -0.0000003532916737,  0.0070403557909603]],

    #     [[ 0.1346920105687044,  0.1874759425217754, -0.0000001681717626],
    #      [ 0.1874763463320384,  0.363900287279062 , -0.000000000000007 ],
    #      [-0.0000002043258895, -0.0000001869375765, -0.0170179189008107]]]])

    #     assert np.max(np.abs(test_hessian - reference_hessian)) < 1e-14
    #     # Translation invariance
    #     assert np.max(np.abs(np.sum(test_hessian, axis = 0))) < 1e-10

    # def test_hessian_unrestricted_grid_response_mgga(self):
    #     mf = UKS(mol, xc = 'r2SCAN')
    #     mf.grids.atom_grid = (10,14)
    #     mf.conv_tol = 1e-12
    #     mf.conv_tol_cpscf = 1e-10
    #     mf.cphf_grids.atom_grid = mf.grids.atom_grid
    #     mf.cphf_grids.prune = mf.grids.prune
    #     # mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

    #     mf.kernel()
    #     assert mf.converged

    #     hobj = mf.Hessian()
    #     hobj.auxbasis_response = 2
    #     hobj.grid_response = True

    #     test_hessian = hobj.kernel()

    #     # reference_hessian = numerical_d2e_dft(mf, dx = 1e-3)
    #     reference_hessian = np.array([[[[ 0.523734706295631 ,  0.0753789823830786,  0.3793649978935942],
    #      [ 0.0753762770011601,  0.3761594584155148,  0.1084622374811772],
    #      [ 0.3793634383625344,  0.1084631234125055,  0.0961344047761825]],

    #     [[ 0.0907561758982448, -0.0288877211866989, -0.0062947318258955],
    #      [ 0.0466553225219046, -0.2363220833307977, -0.0841542128825479],
    #      [ 0.0009854169533349, -0.108869971646719 ,  0.0530936135297866]],

    #     [[-0.6196611118669537, -0.0284265817212526, -0.3817086460535801],
    #      [-0.1077274888869884, -0.1099936813466207, -0.0514502540196471],
    #      [-0.3779280116542605, -0.0213611112894752, -0.1544327194060724]],

    #     [[ 0.0051702296344214, -0.0180646794542827,  0.0086383799746126],
    #      [-0.0143041106742681, -0.0298436937953006,  0.0271422294368939],
    #      [-0.0024208437155449,  0.02176795963163  ,  0.0052047011241396]]],


    #    [[[ 0.0907596009603884,  0.046655958800379 ,  0.0009853439373875],
    #      [-0.028889606052962 , -0.2363171114190266, -0.108870066500677 ],
    #      [-0.0062881925024794, -0.0841633060373326,  0.0530954092212155]],

    #     [[-0.0703104504681251, -0.0104292962914698,  0.0443349031923335],
    #      [-0.010431751466207 ,  0.2691507548782113,  0.1339028472002735],
    #      [ 0.0443363957293441,  0.1339107285804886, -0.101393912790293 ]],

    #     [[-0.0074468736492861, -0.0513211383551537, -0.0000511330627839],
    #      [ 0.0239894623812464, -0.0235383320353888,  0.0085742039762637],
    #      [ 0.0027850558008691, -0.0213902204554417,  0.0004956117096722]],

    #     [[-0.0130022768034532,  0.0150944759143568, -0.0452691140513939],
    #      [ 0.0153318951261472, -0.0092953115116146, -0.033606984719603 ],
    #      [-0.0408332590360883, -0.0283572020258749,  0.0478028918643458]]],


    #    [[[-0.6196570434079396, -0.1077335861987549, -0.377929896557494 ],
    #      [-0.0284249016471172, -0.1099977109202399, -0.0213614520587213],
    #      [-0.3817077669772129, -0.0514508339826136, -0.154433883237437 ]],

    #     [[-0.0074432366331256,  0.0239927749650093,  0.002789353671373 ],
    #      [-0.0513205945155276, -0.0235340749110691, -0.0213901879971834],
    #      [-0.0000516546919752,  0.0085720210956097,  0.0005011542708599]],

    #     [[ 0.6284243417404856,  0.083453333562189 ,  0.3765973741294282],
    #      [ 0.0834517332783946,  0.1354568434271397,  0.0394447353755378],
    #      [ 0.3765980162564464,  0.0394454823487433,  0.1575935306153964]],

    #     [[-0.0013240616982824,  0.0002874776059147, -0.0014568312558527],
    #      [-0.003706237127088 , -0.0019250575582497,  0.003306904708511 ],
    #      [ 0.0051614054484284,  0.0034333304633205, -0.003660801644545 ]]],


    #    [[[ 0.0051896436292775, -0.0143123051934424, -0.0024156231417938],
    #      [-0.0180676261100077, -0.029837508065178 ,  0.0217677950209438],
    #      [ 0.0086225595549161,  0.0271503545405949,  0.0052017963785844]],

    #     [[-0.0129978416092136,  0.0153429380551628, -0.0408363529487143],
    #      [ 0.015094819897872 , -0.0093026903753568, -0.0283517038857095],
    #      [-0.0452734060986601, -0.0336150204942598,  0.0478064593325556]],

    #     [[-0.0013389392359286, -0.0037064449386337,  0.0051505783645878],
    #      [ 0.0002911680723194, -0.0019250909708557,  0.0034342771330076],
    #      [-0.0014460076953604,  0.0033059148360493, -0.0036517947810122]],

    #     [[ 0.0091471372143936,  0.0026758120430237,  0.0381013977220346],
    #      [ 0.0026816381184513,  0.0410652893926278,  0.0031496317139945],
    #      [ 0.0380968542328941,  0.0031587513025511, -0.0493564609190811]]]])

    #     assert np.max(np.abs(test_hessian - reference_hessian)) < 1e-4
    #     # Translation invariance
    #     assert np.max(np.abs(np.sum(test_hessian, axis = 0))) < 1e-10

    # def test_hessian_unrestricted_grid_response_vv10(self):
    #     mf = UKS(mol, xc = 'wB97M-V')
    #     mf.grids.atom_grid = (10,14)
    #     mf.nlcgrids.atom_grid = (15,14)
    #     mf.conv_tol = 1e-12
    #     mf.conv_tol_cpscf = 1e-10
    #     mf.cphf_grids.atom_grid = mf.grids.atom_grid
    #     mf.cphf_grids.prune = mf.grids.prune
    #     mf = mf.density_fit(auxbasis = "def2-universal-JKFIT")

    #     mf.kernel()
    #     assert mf.converged

    #     hobj = mf.Hessian()
    #     hobj.auxbasis_response = 2
    #     hobj.grid_response = True

    #     test_hessian = hobj.kernel()

    #     # reference_hessian = numerical_d2e_dft(mf, dx = 1e-3)
    #     reference_hessian = np.array([[[[ 0.5119242880652353,  0.0600552100236129,  0.3310596056884663],
    #      [ 0.0600392618100853,  0.3522280861885108,  0.0693688618416122],
    #      [ 0.3310443052255696,  0.0693448856354806,  0.1492223138748194]],

    #     [[ 0.0308251280138477, -0.0333680253703506, -0.005599868620032 ],
    #      [ 0.0294542457289979, -0.252317468694585 , -0.0537590194421567],
    #      [-0.0000980633357919, -0.0759912042447297,  0.0111281742900537]],

    #     [[-0.5466985222231102, -0.0130722299946928, -0.3309991091859921],
    #      [-0.0754200138237682, -0.0709503882117546, -0.0408666584863493],
    #      [-0.3303974530681764, -0.010527259263815 , -0.164147626015243 ]],

    #     [[ 0.0039491061278873, -0.0136149546572928,  0.0055393721119512],
    #      [-0.0140734937215115, -0.0289602293423452,  0.0252568160871158],
    #      [-0.0005487888224964,  0.0171735778803639,  0.0037971378455404]]],


    #    [[[ 0.0308214718031108,  0.029449212807009 , -0.0000881169148204],
    #      [-0.0333487353674222, -0.2523200205919451, -0.076028116420046 ],
    #      [-0.0056012422029461, -0.0537444828001554,  0.0111428811970793]],

    #     [[-0.013535855779831 ,  0.0044398683085589,  0.0391973633909748],
    #      [ 0.0044644487885367,  0.2946616204013708,  0.0991369437092215],
    #      [ 0.0391914902598198,  0.0991106174268452, -0.0482020126073568]],

    #     [[-0.0005149240169811, -0.0451818390371228, -0.0014823988582213],
    #      [ 0.0149344297191156, -0.0309069154972863,  0.0058540084142411],
    #      [ 0.0025530751499581, -0.0237451529775945,  0.0019341008570262]],

    #     [[-0.01677069200684  ,  0.0112927579201949, -0.0376268476180441],
    #      [ 0.0139498568615393, -0.0114346843808066, -0.0289628356984206],
    #      [-0.0361433232080044, -0.0216209816420454,  0.035125030558969 ]]],


    #    [[[-0.5466591996347026, -0.0754623991694459, -0.3304145171768025],
    #      [-0.0130503282580463, -0.0709486737129339, -0.0104926674910355],
    #      [-0.3310033845190796, -0.040869880543859 , -0.1641580640592832]],

    #     [[-0.0005353207638004,  0.0149760989085479,  0.0025490046078325],
    #      [-0.0452319171716647, -0.0309128825808358, -0.0237768699469232],
    #      [-0.001458751309788 ,  0.0058480319840015,  0.0019407190016141]],

    #     [[ 0.548445034233902 ,  0.0607068782965681,  0.3286525416672514],
    #      [ 0.0606905330995389,  0.1031843955936473,  0.0323626448164305],
    #      [ 0.3286423568700236,  0.0323747868162805,  0.1634653472850633]],

    #     [[-0.0012505138210495, -0.0002205780329501, -0.0007870290899548],
    #      [-0.0024082876681208, -0.001322839295187 ,  0.0019068926244703],
    #      [ 0.0038197789620775,  0.0026470617451313, -0.0012480022199557]]],


    #    [[[ 0.0039625207426397, -0.0140906595982315, -0.0005921162040678],
    #      [-0.0136156526573394, -0.0289617980460122,  0.017185508928097 ],
    #      [ 0.0055446708626672,  0.0252692762554574,  0.0037741474692154]],

    #     [[-0.016747727537833 ,  0.0140229270337855, -0.0361259722384544],
    #      [ 0.0112854386013633, -0.0114345172059771, -0.0216287835588247],
    #      [-0.0376177222767213, -0.0289570957576757,  0.0351351629871433]],

    #     [[-0.0012339905870462, -0.0024587224934924,  0.0038372855798441],
    #      [-0.0002151739453282, -0.0013231699385052,  0.0026430112562981],
    #      [-0.0007893728557473,  0.0018908784633065, -0.0012431896900811]],

    #     [[ 0.0140191973790893,  0.0025264550559956,  0.032880802861901 ],
    #      [ 0.0025453880014292,  0.0417194851861924,  0.0018002633722647],
    #      [ 0.0328624242675324,  0.0017969410377461, -0.0376661207661111]]]])

    #     assert np.max(np.abs(test_hessian - reference_hessian)) < 2e-4
    #     # Translation invariance
    #     assert np.max(np.abs(np.sum(test_hessian, axis = 0))) < 1e-8

if __name__ == "__main__":
    print("Tests for UKS hessian with grid response")
    unittest.main()

