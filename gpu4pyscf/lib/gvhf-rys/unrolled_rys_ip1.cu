#include <cuda.h>
#include "vhf.cuh"
#include "rys_roots.cu"
#include "create_tasks_ip1.cu"


__device__ static
void _rys_vjk_ip1_0000(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    ai2 = rjri[5];
                    double rt_aij = rt_aa * akl;
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    fx = ai2 * trr_10x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += 1 *  fy  * wt;
                    gout0z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
            }
        }
    }
}
#if CUDA_VERSION >= 12040
__global__ __maxnreg__(128)
#else
__global__
#endif
static void rys_vjk_ip1_0000(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0000(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0010(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    fx = ai2 * trr_11x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_01x = cpx * 1;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += trr_01x *  fy  * wt;
                    gout0z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    double trr_01y = cpy * 1;
                    gout1x +=  fx  * trr_01y * wt;
                    gout1y += 1 *  fy  * wt;
                    gout1z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    double trr_01z = cpz * wt;
                    gout2x +=  fx  * 1 * trr_01z;
                    gout2y += 1 *  fy  * trr_01z;
                    gout2z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout1x * dm[(l0+0)*nao+(k0+1)];
                fy += gout1y * dm[(l0+0)*nao+(k0+1)];
                fz += gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout2x * dm[(l0+0)*nao+(k0+2)];
                fy += gout2y * dm[(l0+0)*nao+(k0+2)];
                fz += gout2z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+0)];
                fy = gout2y * dm[(j0+0)*nao+(i0+0)];
                fz = gout2z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout1x * dm[(j0+0)*nao+(k0+1)];
                fy += gout1y * dm[(j0+0)*nao+(k0+1)];
                fz += gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout2x * dm[(j0+0)*nao+(k0+2)];
                fy += gout2y * dm[(j0+0)*nao+(k0+2)];
                fz += gout2z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+0)*nao+(k0+1)];
                fy += gout1y * dm[(i0+0)*nao+(k0+1)];
                fz += gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout2x * dm[(i0+0)*nao+(k0+2)];
                fy += gout2y * dm[(i0+0)*nao+(k0+2)];
                fz += gout2z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
            }
        }
    }
}
#if CUDA_VERSION >= 12040
__global__ __maxnreg__(128)
#else
__global__
#endif
static void rys_vjk_ip1_0010(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0010(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0011(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double b01 = .5/akl * (1 - rt_akl);
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double trr_01x = cpx * 1;
                    double trr_12x = cpx * trr_11x + 1*b01 * trr_10x + 1*b00 * trr_01x;
                    double hrr_1011x = trr_12x - (rl[0] - rk[0]) * trr_11x;
                    fx = ai2 * hrr_1011x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_02x = cpx * trr_01x + 1*b01 * 1;
                    double hrr_0011x = trr_02x - (rl[0] - rk[0]) * trr_01x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_0011x *  fy  * wt;
                    gout0z += hrr_0011x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_1001x = trr_11x - (rl[0] - rk[0]) * trr_10x;
                    fx = ai2 * hrr_1001x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    double hrr_0001x = trr_01x - (rl[0] - rk[0]) * 1;
                    double trr_01y = cpy * 1;
                    gout1x +=  fx  * trr_01y * wt;
                    gout1y += hrr_0001x *  fy  * wt;
                    gout1z += hrr_0001x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    double trr_01z = cpz * wt;
                    gout2x +=  fx  * 1 * trr_01z;
                    gout2y += hrr_0001x *  fy  * trr_01z;
                    gout2z += hrr_0001x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double hrr_1001y = trr_11y - (rl[1] - rk[1]) * trr_10y;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_10z;
                    double hrr_0001y = trr_01y - (rl[1] - rk[1]) * 1;
                    gout3x +=  fx  * hrr_0001y * wt;
                    gout3y += trr_01x *  fy  * wt;
                    gout3z += trr_01x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_12y = cpy * trr_11y + 1*b01 * trr_10y + 1*b00 * trr_01y;
                    double hrr_1011y = trr_12y - (rl[1] - rk[1]) * trr_11y;
                    fy = ai2 * hrr_1011y;
                    fz = ai2 * trr_10z;
                    double trr_02y = cpy * trr_01y + 1*b01 * 1;
                    double hrr_0011y = trr_02y - (rl[1] - rk[1]) * trr_01y;
                    gout4x +=  fx  * hrr_0011y * wt;
                    gout4y += 1 *  fy  * wt;
                    gout4z += 1 * hrr_0011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_11z;
                    gout5x +=  fx  * hrr_0001y * trr_01z;
                    gout5y += 1 *  fy  * trr_01z;
                    gout5z += 1 * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double hrr_1001z = trr_11z - (rl[2] - rk[2]) * trr_10z;
                    fz = ai2 * hrr_1001z;
                    double hrr_0001z = trr_01z - (rl[2] - rk[2]) * wt;
                    gout6x +=  fx  * 1 * hrr_0001z;
                    gout6y += trr_01x *  fy  * hrr_0001z;
                    gout6z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1001z;
                    gout7x +=  fx  * trr_01y * hrr_0001z;
                    gout7y += 1 *  fy  * hrr_0001z;
                    gout7z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_12z = cpz * trr_11z + 1*b01 * trr_10z + 1*b00 * trr_01z;
                    double hrr_1011z = trr_12z - (rl[2] - rk[2]) * trr_11z;
                    fz = ai2 * hrr_1011z;
                    double trr_02z = cpz * trr_01z + 1*b01 * wt;
                    double hrr_0011z = trr_02z - (rl[2] - rk[2]) * trr_01z;
                    gout8x +=  fx  * 1 * hrr_0011z;
                    gout8y += 1 *  fy  * hrr_0011z;
                    gout8z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout1x * dm[(l0+0)*nao+(k0+1)];
                fy += gout1y * dm[(l0+0)*nao+(k0+1)];
                fz += gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout2x * dm[(l0+0)*nao+(k0+2)];
                fy += gout2y * dm[(l0+0)*nao+(k0+2)];
                fz += gout2z * dm[(l0+0)*nao+(k0+2)];
                fx += gout3x * dm[(l0+1)*nao+(k0+0)];
                fy += gout3y * dm[(l0+1)*nao+(k0+0)];
                fz += gout3z * dm[(l0+1)*nao+(k0+0)];
                fx += gout4x * dm[(l0+1)*nao+(k0+1)];
                fy += gout4y * dm[(l0+1)*nao+(k0+1)];
                fz += gout4z * dm[(l0+1)*nao+(k0+1)];
                fx += gout5x * dm[(l0+1)*nao+(k0+2)];
                fy += gout5y * dm[(l0+1)*nao+(k0+2)];
                fz += gout5z * dm[(l0+1)*nao+(k0+2)];
                fx += gout6x * dm[(l0+2)*nao+(k0+0)];
                fy += gout6y * dm[(l0+2)*nao+(k0+0)];
                fz += gout6z * dm[(l0+2)*nao+(k0+0)];
                fx += gout7x * dm[(l0+2)*nao+(k0+1)];
                fy += gout7y * dm[(l0+2)*nao+(k0+1)];
                fz += gout7z * dm[(l0+2)*nao+(k0+1)];
                fx += gout8x * dm[(l0+2)*nao+(k0+2)];
                fy += gout8y * dm[(l0+2)*nao+(k0+2)];
                fz += gout8z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+0)];
                fy = gout2y * dm[(j0+0)*nao+(i0+0)];
                fz = gout2z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+0)];
                fy = gout5y * dm[(j0+0)*nao+(i0+0)];
                fz = gout5z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+0)];
                fy = gout7y * dm[(j0+0)*nao+(i0+0)];
                fz = gout7z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+0)];
                fy = gout8y * dm[(j0+0)*nao+(i0+0)];
                fz = gout8z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout1x * dm[(j0+0)*nao+(k0+1)];
                fy += gout1y * dm[(j0+0)*nao+(k0+1)];
                fz += gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout2x * dm[(j0+0)*nao+(k0+2)];
                fy += gout2y * dm[(j0+0)*nao+(k0+2)];
                fz += gout2z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(k0+0)];
                fy = gout3y * dm[(j0+0)*nao+(k0+0)];
                fz = gout3z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+0)*nao+(k0+1)];
                fy += gout4y * dm[(j0+0)*nao+(k0+1)];
                fz += gout4z * dm[(j0+0)*nao+(k0+1)];
                fx += gout5x * dm[(j0+0)*nao+(k0+2)];
                fy += gout5y * dm[(j0+0)*nao+(k0+2)];
                fz += gout5z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+0)];
                fy = gout6y * dm[(j0+0)*nao+(k0+0)];
                fz = gout6z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+0)*nao+(k0+1)];
                fy += gout7y * dm[(j0+0)*nao+(k0+1)];
                fz += gout7z * dm[(j0+0)*nao+(k0+1)];
                fx += gout8x * dm[(j0+0)*nao+(k0+2)];
                fy += gout8y * dm[(j0+0)*nao+(k0+2)];
                fz += gout8z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+0)*nao+(k0+1)];
                fy += gout1y * dm[(i0+0)*nao+(k0+1)];
                fz += gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout2x * dm[(i0+0)*nao+(k0+2)];
                fy += gout2y * dm[(i0+0)*nao+(k0+2)];
                fz += gout2z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+0)];
                fy = gout3y * dm[(i0+0)*nao+(k0+0)];
                fz = gout3z * dm[(i0+0)*nao+(k0+0)];
                fx += gout4x * dm[(i0+0)*nao+(k0+1)];
                fy += gout4y * dm[(i0+0)*nao+(k0+1)];
                fz += gout4z * dm[(i0+0)*nao+(k0+1)];
                fx += gout5x * dm[(i0+0)*nao+(k0+2)];
                fy += gout5y * dm[(i0+0)*nao+(k0+2)];
                fz += gout5z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+0)];
                fy = gout6y * dm[(i0+0)*nao+(k0+0)];
                fz = gout6z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+0)*nao+(k0+1)];
                fy += gout7y * dm[(i0+0)*nao+(k0+1)];
                fz += gout7z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+0)*nao+(k0+2)];
                fy += gout8y * dm[(i0+0)*nao+(k0+2)];
                fz += gout8z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+0)*nao+(l0+1)];
                fy += gout3y * dm[(j0+0)*nao+(l0+1)];
                fz += gout3z * dm[(j0+0)*nao+(l0+1)];
                fx += gout6x * dm[(j0+0)*nao+(l0+2)];
                fy += gout6y * dm[(j0+0)*nao+(l0+2)];
                fz += gout6z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout4x * dm[(j0+0)*nao+(l0+1)];
                fy += gout4y * dm[(j0+0)*nao+(l0+1)];
                fz += gout4z * dm[(j0+0)*nao+(l0+1)];
                fx += gout7x * dm[(j0+0)*nao+(l0+2)];
                fy += gout7y * dm[(j0+0)*nao+(l0+2)];
                fz += gout7z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout5x * dm[(j0+0)*nao+(l0+1)];
                fy += gout5y * dm[(j0+0)*nao+(l0+1)];
                fz += gout5z * dm[(j0+0)*nao+(l0+1)];
                fx += gout8x * dm[(j0+0)*nao+(l0+2)];
                fy += gout8y * dm[(j0+0)*nao+(l0+2)];
                fz += gout8z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout3x * dm[(i0+0)*nao+(l0+1)];
                fy += gout3y * dm[(i0+0)*nao+(l0+1)];
                fz += gout3z * dm[(i0+0)*nao+(l0+1)];
                fx += gout6x * dm[(i0+0)*nao+(l0+2)];
                fy += gout6y * dm[(i0+0)*nao+(l0+2)];
                fz += gout6z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout4x * dm[(i0+0)*nao+(l0+1)];
                fy += gout4y * dm[(i0+0)*nao+(l0+1)];
                fz += gout4z * dm[(i0+0)*nao+(l0+1)];
                fx += gout7x * dm[(i0+0)*nao+(l0+2)];
                fy += gout7y * dm[(i0+0)*nao+(l0+2)];
                fz += gout7z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout5x * dm[(i0+0)*nao+(l0+1)];
                fy += gout5y * dm[(i0+0)*nao+(l0+1)];
                fz += gout5z * dm[(i0+0)*nao+(l0+1)];
                fx += gout8x * dm[(i0+0)*nao+(l0+2)];
                fy += gout8y * dm[(i0+0)*nao+(l0+2)];
                fz += gout8z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0011(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0011(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0020(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double b01 = .5/akl * (1 - rt_akl);
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double trr_01x = cpx * 1;
                    double trr_12x = cpx * trr_11x + 1*b01 * trr_10x + 1*b00 * trr_01x;
                    fx = ai2 * trr_12x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_02x = cpx * trr_01x + 1*b01 * 1;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += trr_02x *  fy  * wt;
                    gout0z += trr_02x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    double trr_01y = cpy * 1;
                    gout1x +=  fx  * trr_01y * wt;
                    gout1y += trr_01x *  fy  * wt;
                    gout1z += trr_01x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    double trr_01z = cpz * wt;
                    gout2x +=  fx  * 1 * trr_01z;
                    gout2y += trr_01x *  fy  * trr_01z;
                    gout2z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_12y = cpy * trr_11y + 1*b01 * trr_10y + 1*b00 * trr_01y;
                    fy = ai2 * trr_12y;
                    fz = ai2 * trr_10z;
                    double trr_02y = cpy * trr_01y + 1*b01 * 1;
                    gout3x +=  fx  * trr_02y * wt;
                    gout3y += 1 *  fy  * wt;
                    gout3z += 1 * trr_02y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_11z;
                    gout4x +=  fx  * trr_01y * trr_01z;
                    gout4y += 1 *  fy  * trr_01z;
                    gout4z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_12z = cpz * trr_11z + 1*b01 * trr_10z + 1*b00 * trr_01z;
                    fz = ai2 * trr_12z;
                    double trr_02z = cpz * trr_01z + 1*b01 * wt;
                    gout5x +=  fx  * 1 * trr_02z;
                    gout5y += 1 *  fy  * trr_02z;
                    gout5z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout1x * dm[(l0+0)*nao+(k0+1)];
                fy += gout1y * dm[(l0+0)*nao+(k0+1)];
                fz += gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout2x * dm[(l0+0)*nao+(k0+2)];
                fy += gout2y * dm[(l0+0)*nao+(k0+2)];
                fz += gout2z * dm[(l0+0)*nao+(k0+2)];
                fx += gout3x * dm[(l0+0)*nao+(k0+3)];
                fy += gout3y * dm[(l0+0)*nao+(k0+3)];
                fz += gout3z * dm[(l0+0)*nao+(k0+3)];
                fx += gout4x * dm[(l0+0)*nao+(k0+4)];
                fy += gout4y * dm[(l0+0)*nao+(k0+4)];
                fz += gout4z * dm[(l0+0)*nao+(k0+4)];
                fx += gout5x * dm[(l0+0)*nao+(k0+5)];
                fy += gout5y * dm[(l0+0)*nao+(k0+5)];
                fz += gout5z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+0)];
                fy = gout2y * dm[(j0+0)*nao+(i0+0)];
                fz = gout2z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+0)];
                fy = gout5y * dm[(j0+0)*nao+(i0+0)];
                fz = gout5z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout1x * dm[(j0+0)*nao+(k0+1)];
                fy += gout1y * dm[(j0+0)*nao+(k0+1)];
                fz += gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout2x * dm[(j0+0)*nao+(k0+2)];
                fy += gout2y * dm[(j0+0)*nao+(k0+2)];
                fz += gout2z * dm[(j0+0)*nao+(k0+2)];
                fx += gout3x * dm[(j0+0)*nao+(k0+3)];
                fy += gout3y * dm[(j0+0)*nao+(k0+3)];
                fz += gout3z * dm[(j0+0)*nao+(k0+3)];
                fx += gout4x * dm[(j0+0)*nao+(k0+4)];
                fy += gout4y * dm[(j0+0)*nao+(k0+4)];
                fz += gout4z * dm[(j0+0)*nao+(k0+4)];
                fx += gout5x * dm[(j0+0)*nao+(k0+5)];
                fy += gout5y * dm[(j0+0)*nao+(k0+5)];
                fz += gout5z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+0)*nao+(k0+1)];
                fy += gout1y * dm[(i0+0)*nao+(k0+1)];
                fz += gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout2x * dm[(i0+0)*nao+(k0+2)];
                fy += gout2y * dm[(i0+0)*nao+(k0+2)];
                fz += gout2z * dm[(i0+0)*nao+(k0+2)];
                fx += gout3x * dm[(i0+0)*nao+(k0+3)];
                fy += gout3y * dm[(i0+0)*nao+(k0+3)];
                fz += gout3z * dm[(i0+0)*nao+(k0+3)];
                fx += gout4x * dm[(i0+0)*nao+(k0+4)];
                fy += gout4y * dm[(i0+0)*nao+(k0+4)];
                fz += gout4z * dm[(i0+0)*nao+(k0+4)];
                fx += gout5x * dm[(i0+0)*nao+(k0+5)];
                fy += gout5y * dm[(i0+0)*nao+(k0+5)];
                fz += gout5z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0020(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0020(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0021(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double b01 = .5/akl * (1 - rt_akl);
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double trr_01x = cpx * 1;
                    double trr_12x = cpx * trr_11x + 1*b01 * trr_10x + 1*b00 * trr_01x;
                    double trr_02x = cpx * trr_01x + 1*b01 * 1;
                    double trr_13x = cpx * trr_12x + 2*b01 * trr_11x + 1*b00 * trr_02x;
                    double hrr_1021x = trr_13x - (rl[0] - rk[0]) * trr_12x;
                    fx = ai2 * hrr_1021x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_03x = cpx * trr_02x + 2*b01 * trr_01x;
                    double hrr_0021x = trr_03x - (rl[0] - rk[0]) * trr_02x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_0021x *  fy  * wt;
                    gout0z += hrr_0021x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_1011x = trr_12x - (rl[0] - rk[0]) * trr_11x;
                    fx = ai2 * hrr_1011x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    double hrr_0011x = trr_02x - (rl[0] - rk[0]) * trr_01x;
                    double trr_01y = cpy * 1;
                    gout1x +=  fx  * trr_01y * wt;
                    gout1y += hrr_0011x *  fy  * wt;
                    gout1z += hrr_0011x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1011x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    double trr_01z = cpz * wt;
                    gout2x +=  fx  * 1 * trr_01z;
                    gout2y += hrr_0011x *  fy  * trr_01z;
                    gout2z += hrr_0011x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_1001x = trr_11x - (rl[0] - rk[0]) * trr_10x;
                    fx = ai2 * hrr_1001x;
                    double trr_12y = cpy * trr_11y + 1*b01 * trr_10y + 1*b00 * trr_01y;
                    fy = ai2 * trr_12y;
                    fz = ai2 * trr_10z;
                    double hrr_0001x = trr_01x - (rl[0] - rk[0]) * 1;
                    double trr_02y = cpy * trr_01y + 1*b01 * 1;
                    gout3x +=  fx  * trr_02y * wt;
                    gout3y += hrr_0001x *  fy  * wt;
                    gout3z += hrr_0001x * trr_02y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_11z;
                    gout4x +=  fx  * trr_01y * trr_01z;
                    gout4y += hrr_0001x *  fy  * trr_01z;
                    gout4z += hrr_0001x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * trr_10y;
                    double trr_12z = cpz * trr_11z + 1*b01 * trr_10z + 1*b00 * trr_01z;
                    fz = ai2 * trr_12z;
                    double trr_02z = cpz * trr_01z + 1*b01 * wt;
                    gout5x +=  fx  * 1 * trr_02z;
                    gout5y += hrr_0001x *  fy  * trr_02z;
                    gout5z += hrr_0001x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_12x;
                    double hrr_1001y = trr_11y - (rl[1] - rk[1]) * trr_10y;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_10z;
                    double hrr_0001y = trr_01y - (rl[1] - rk[1]) * 1;
                    gout6x +=  fx  * hrr_0001y * wt;
                    gout6y += trr_02x *  fy  * wt;
                    gout6z += trr_02x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double hrr_1011y = trr_12y - (rl[1] - rk[1]) * trr_11y;
                    fy = ai2 * hrr_1011y;
                    fz = ai2 * trr_10z;
                    double hrr_0011y = trr_02y - (rl[1] - rk[1]) * trr_01y;
                    gout7x +=  fx  * hrr_0011y * wt;
                    gout7y += trr_01x *  fy  * wt;
                    gout7z += trr_01x * hrr_0011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_11z;
                    gout8x +=  fx  * hrr_0001y * trr_01z;
                    gout8y += trr_01x *  fy  * trr_01z;
                    gout8z += trr_01x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_13y = cpy * trr_12y + 2*b01 * trr_11y + 1*b00 * trr_02y;
                    double hrr_1021y = trr_13y - (rl[1] - rk[1]) * trr_12y;
                    fy = ai2 * hrr_1021y;
                    fz = ai2 * trr_10z;
                    double trr_03y = cpy * trr_02y + 2*b01 * trr_01y;
                    double hrr_0021y = trr_03y - (rl[1] - rk[1]) * trr_02y;
                    gout9x +=  fx  * hrr_0021y * wt;
                    gout9y += 1 *  fy  * wt;
                    gout9z += 1 * hrr_0021y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1011y;
                    fz = ai2 * trr_11z;
                    gout10x +=  fx  * hrr_0011y * trr_01z;
                    gout10y += 1 *  fy  * trr_01z;
                    gout10z += 1 * hrr_0011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_12z;
                    gout11x +=  fx  * hrr_0001y * trr_02z;
                    gout11y += 1 *  fy  * trr_02z;
                    gout11z += 1 * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_12x;
                    fy = ai2 * trr_10y;
                    double hrr_1001z = trr_11z - (rl[2] - rk[2]) * trr_10z;
                    fz = ai2 * hrr_1001z;
                    double hrr_0001z = trr_01z - (rl[2] - rk[2]) * wt;
                    gout12x +=  fx  * 1 * hrr_0001z;
                    gout12y += trr_02x *  fy  * hrr_0001z;
                    gout12z += trr_02x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1001z;
                    gout13x +=  fx  * trr_01y * hrr_0001z;
                    gout13y += trr_01x *  fy  * hrr_0001z;
                    gout13z += trr_01x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double hrr_1011z = trr_12z - (rl[2] - rk[2]) * trr_11z;
                    fz = ai2 * hrr_1011z;
                    double hrr_0011z = trr_02z - (rl[2] - rk[2]) * trr_01z;
                    gout14x +=  fx  * 1 * hrr_0011z;
                    gout14y += trr_01x *  fy  * hrr_0011z;
                    gout14z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_12y;
                    fz = ai2 * hrr_1001z;
                    gout15x +=  fx  * trr_02y * hrr_0001z;
                    gout15y += 1 *  fy  * hrr_0001z;
                    gout15z += 1 * trr_02y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1011z;
                    gout16x +=  fx  * trr_01y * hrr_0011z;
                    gout16y += 1 *  fy  * hrr_0011z;
                    gout16z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_13z = cpz * trr_12z + 2*b01 * trr_11z + 1*b00 * trr_02z;
                    double hrr_1021z = trr_13z - (rl[2] - rk[2]) * trr_12z;
                    fz = ai2 * hrr_1021z;
                    double trr_03z = cpz * trr_02z + 2*b01 * trr_01z;
                    double hrr_0021z = trr_03z - (rl[2] - rk[2]) * trr_02z;
                    gout17x +=  fx  * 1 * hrr_0021z;
                    gout17y += 1 *  fy  * hrr_0021z;
                    gout17z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout1x * dm[(l0+0)*nao+(k0+1)];
                fy += gout1y * dm[(l0+0)*nao+(k0+1)];
                fz += gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout2x * dm[(l0+0)*nao+(k0+2)];
                fy += gout2y * dm[(l0+0)*nao+(k0+2)];
                fz += gout2z * dm[(l0+0)*nao+(k0+2)];
                fx += gout3x * dm[(l0+0)*nao+(k0+3)];
                fy += gout3y * dm[(l0+0)*nao+(k0+3)];
                fz += gout3z * dm[(l0+0)*nao+(k0+3)];
                fx += gout4x * dm[(l0+0)*nao+(k0+4)];
                fy += gout4y * dm[(l0+0)*nao+(k0+4)];
                fz += gout4z * dm[(l0+0)*nao+(k0+4)];
                fx += gout5x * dm[(l0+0)*nao+(k0+5)];
                fy += gout5y * dm[(l0+0)*nao+(k0+5)];
                fz += gout5z * dm[(l0+0)*nao+(k0+5)];
                fx += gout6x * dm[(l0+1)*nao+(k0+0)];
                fy += gout6y * dm[(l0+1)*nao+(k0+0)];
                fz += gout6z * dm[(l0+1)*nao+(k0+0)];
                fx += gout7x * dm[(l0+1)*nao+(k0+1)];
                fy += gout7y * dm[(l0+1)*nao+(k0+1)];
                fz += gout7z * dm[(l0+1)*nao+(k0+1)];
                fx += gout8x * dm[(l0+1)*nao+(k0+2)];
                fy += gout8y * dm[(l0+1)*nao+(k0+2)];
                fz += gout8z * dm[(l0+1)*nao+(k0+2)];
                fx += gout9x * dm[(l0+1)*nao+(k0+3)];
                fy += gout9y * dm[(l0+1)*nao+(k0+3)];
                fz += gout9z * dm[(l0+1)*nao+(k0+3)];
                fx += gout10x * dm[(l0+1)*nao+(k0+4)];
                fy += gout10y * dm[(l0+1)*nao+(k0+4)];
                fz += gout10z * dm[(l0+1)*nao+(k0+4)];
                fx += gout11x * dm[(l0+1)*nao+(k0+5)];
                fy += gout11y * dm[(l0+1)*nao+(k0+5)];
                fz += gout11z * dm[(l0+1)*nao+(k0+5)];
                fx += gout12x * dm[(l0+2)*nao+(k0+0)];
                fy += gout12y * dm[(l0+2)*nao+(k0+0)];
                fz += gout12z * dm[(l0+2)*nao+(k0+0)];
                fx += gout13x * dm[(l0+2)*nao+(k0+1)];
                fy += gout13y * dm[(l0+2)*nao+(k0+1)];
                fz += gout13z * dm[(l0+2)*nao+(k0+1)];
                fx += gout14x * dm[(l0+2)*nao+(k0+2)];
                fy += gout14y * dm[(l0+2)*nao+(k0+2)];
                fz += gout14z * dm[(l0+2)*nao+(k0+2)];
                fx += gout15x * dm[(l0+2)*nao+(k0+3)];
                fy += gout15y * dm[(l0+2)*nao+(k0+3)];
                fz += gout15z * dm[(l0+2)*nao+(k0+3)];
                fx += gout16x * dm[(l0+2)*nao+(k0+4)];
                fy += gout16y * dm[(l0+2)*nao+(k0+4)];
                fz += gout16z * dm[(l0+2)*nao+(k0+4)];
                fx += gout17x * dm[(l0+2)*nao+(k0+5)];
                fy += gout17y * dm[(l0+2)*nao+(k0+5)];
                fz += gout17z * dm[(l0+2)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+0)];
                fy = gout2y * dm[(j0+0)*nao+(i0+0)];
                fz = gout2z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+0)];
                fy = gout5y * dm[(j0+0)*nao+(i0+0)];
                fz = gout5z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+0)];
                fy = gout7y * dm[(j0+0)*nao+(i0+0)];
                fz = gout7z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+0)];
                fy = gout8y * dm[(j0+0)*nao+(i0+0)];
                fz = gout8z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(i0+0)];
                fy = gout10y * dm[(j0+0)*nao+(i0+0)];
                fz = gout10z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+0)];
                fy = gout11y * dm[(j0+0)*nao+(i0+0)];
                fz = gout11z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+1), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout13x * dm[(j0+0)*nao+(i0+0)];
                fy = gout13y * dm[(j0+0)*nao+(i0+0)];
                fz = gout13z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout14x * dm[(j0+0)*nao+(i0+0)];
                fy = gout14y * dm[(j0+0)*nao+(i0+0)];
                fz = gout14z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                fx = gout15x * dm[(j0+0)*nao+(i0+0)];
                fy = gout15y * dm[(j0+0)*nao+(i0+0)];
                fz = gout15z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+2), fz);
                fx = gout16x * dm[(j0+0)*nao+(i0+0)];
                fy = gout16y * dm[(j0+0)*nao+(i0+0)];
                fz = gout16z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+2), fz);
                fx = gout17x * dm[(j0+0)*nao+(i0+0)];
                fy = gout17y * dm[(j0+0)*nao+(i0+0)];
                fz = gout17z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+2), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout1x * dm[(j0+0)*nao+(k0+1)];
                fy += gout1y * dm[(j0+0)*nao+(k0+1)];
                fz += gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout2x * dm[(j0+0)*nao+(k0+2)];
                fy += gout2y * dm[(j0+0)*nao+(k0+2)];
                fz += gout2z * dm[(j0+0)*nao+(k0+2)];
                fx += gout3x * dm[(j0+0)*nao+(k0+3)];
                fy += gout3y * dm[(j0+0)*nao+(k0+3)];
                fz += gout3z * dm[(j0+0)*nao+(k0+3)];
                fx += gout4x * dm[(j0+0)*nao+(k0+4)];
                fy += gout4y * dm[(j0+0)*nao+(k0+4)];
                fz += gout4z * dm[(j0+0)*nao+(k0+4)];
                fx += gout5x * dm[(j0+0)*nao+(k0+5)];
                fy += gout5y * dm[(j0+0)*nao+(k0+5)];
                fz += gout5z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+0)];
                fy = gout6y * dm[(j0+0)*nao+(k0+0)];
                fz = gout6z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+0)*nao+(k0+1)];
                fy += gout7y * dm[(j0+0)*nao+(k0+1)];
                fz += gout7z * dm[(j0+0)*nao+(k0+1)];
                fx += gout8x * dm[(j0+0)*nao+(k0+2)];
                fy += gout8y * dm[(j0+0)*nao+(k0+2)];
                fz += gout8z * dm[(j0+0)*nao+(k0+2)];
                fx += gout9x * dm[(j0+0)*nao+(k0+3)];
                fy += gout9y * dm[(j0+0)*nao+(k0+3)];
                fz += gout9z * dm[(j0+0)*nao+(k0+3)];
                fx += gout10x * dm[(j0+0)*nao+(k0+4)];
                fy += gout10y * dm[(j0+0)*nao+(k0+4)];
                fz += gout10z * dm[(j0+0)*nao+(k0+4)];
                fx += gout11x * dm[(j0+0)*nao+(k0+5)];
                fy += gout11y * dm[(j0+0)*nao+(k0+5)];
                fz += gout11z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout12x * dm[(j0+0)*nao+(k0+0)];
                fy = gout12y * dm[(j0+0)*nao+(k0+0)];
                fz = gout12z * dm[(j0+0)*nao+(k0+0)];
                fx += gout13x * dm[(j0+0)*nao+(k0+1)];
                fy += gout13y * dm[(j0+0)*nao+(k0+1)];
                fz += gout13z * dm[(j0+0)*nao+(k0+1)];
                fx += gout14x * dm[(j0+0)*nao+(k0+2)];
                fy += gout14y * dm[(j0+0)*nao+(k0+2)];
                fz += gout14z * dm[(j0+0)*nao+(k0+2)];
                fx += gout15x * dm[(j0+0)*nao+(k0+3)];
                fy += gout15y * dm[(j0+0)*nao+(k0+3)];
                fz += gout15z * dm[(j0+0)*nao+(k0+3)];
                fx += gout16x * dm[(j0+0)*nao+(k0+4)];
                fy += gout16y * dm[(j0+0)*nao+(k0+4)];
                fz += gout16z * dm[(j0+0)*nao+(k0+4)];
                fx += gout17x * dm[(j0+0)*nao+(k0+5)];
                fy += gout17y * dm[(j0+0)*nao+(k0+5)];
                fz += gout17z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+0)*nao+(k0+1)];
                fy += gout1y * dm[(i0+0)*nao+(k0+1)];
                fz += gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout2x * dm[(i0+0)*nao+(k0+2)];
                fy += gout2y * dm[(i0+0)*nao+(k0+2)];
                fz += gout2z * dm[(i0+0)*nao+(k0+2)];
                fx += gout3x * dm[(i0+0)*nao+(k0+3)];
                fy += gout3y * dm[(i0+0)*nao+(k0+3)];
                fz += gout3z * dm[(i0+0)*nao+(k0+3)];
                fx += gout4x * dm[(i0+0)*nao+(k0+4)];
                fy += gout4y * dm[(i0+0)*nao+(k0+4)];
                fz += gout4z * dm[(i0+0)*nao+(k0+4)];
                fx += gout5x * dm[(i0+0)*nao+(k0+5)];
                fy += gout5y * dm[(i0+0)*nao+(k0+5)];
                fz += gout5z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+0)];
                fy = gout6y * dm[(i0+0)*nao+(k0+0)];
                fz = gout6z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+0)*nao+(k0+1)];
                fy += gout7y * dm[(i0+0)*nao+(k0+1)];
                fz += gout7z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+0)*nao+(k0+2)];
                fy += gout8y * dm[(i0+0)*nao+(k0+2)];
                fz += gout8z * dm[(i0+0)*nao+(k0+2)];
                fx += gout9x * dm[(i0+0)*nao+(k0+3)];
                fy += gout9y * dm[(i0+0)*nao+(k0+3)];
                fz += gout9z * dm[(i0+0)*nao+(k0+3)];
                fx += gout10x * dm[(i0+0)*nao+(k0+4)];
                fy += gout10y * dm[(i0+0)*nao+(k0+4)];
                fz += gout10z * dm[(i0+0)*nao+(k0+4)];
                fx += gout11x * dm[(i0+0)*nao+(k0+5)];
                fy += gout11y * dm[(i0+0)*nao+(k0+5)];
                fz += gout11z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout12x * dm[(i0+0)*nao+(k0+0)];
                fy = gout12y * dm[(i0+0)*nao+(k0+0)];
                fz = gout12z * dm[(i0+0)*nao+(k0+0)];
                fx += gout13x * dm[(i0+0)*nao+(k0+1)];
                fy += gout13y * dm[(i0+0)*nao+(k0+1)];
                fz += gout13z * dm[(i0+0)*nao+(k0+1)];
                fx += gout14x * dm[(i0+0)*nao+(k0+2)];
                fy += gout14y * dm[(i0+0)*nao+(k0+2)];
                fz += gout14z * dm[(i0+0)*nao+(k0+2)];
                fx += gout15x * dm[(i0+0)*nao+(k0+3)];
                fy += gout15y * dm[(i0+0)*nao+(k0+3)];
                fz += gout15z * dm[(i0+0)*nao+(k0+3)];
                fx += gout16x * dm[(i0+0)*nao+(k0+4)];
                fy += gout16y * dm[(i0+0)*nao+(k0+4)];
                fz += gout16z * dm[(i0+0)*nao+(k0+4)];
                fx += gout17x * dm[(i0+0)*nao+(k0+5)];
                fy += gout17y * dm[(i0+0)*nao+(k0+5)];
                fz += gout17z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout6x * dm[(j0+0)*nao+(l0+1)];
                fy += gout6y * dm[(j0+0)*nao+(l0+1)];
                fz += gout6z * dm[(j0+0)*nao+(l0+1)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout7x * dm[(j0+0)*nao+(l0+1)];
                fy += gout7y * dm[(j0+0)*nao+(l0+1)];
                fz += gout7z * dm[(j0+0)*nao+(l0+1)];
                fx += gout13x * dm[(j0+0)*nao+(l0+2)];
                fy += gout13y * dm[(j0+0)*nao+(l0+2)];
                fz += gout13z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout8x * dm[(j0+0)*nao+(l0+1)];
                fy += gout8y * dm[(j0+0)*nao+(l0+1)];
                fz += gout8z * dm[(j0+0)*nao+(l0+1)];
                fx += gout14x * dm[(j0+0)*nao+(l0+2)];
                fy += gout14y * dm[(j0+0)*nao+(l0+2)];
                fz += gout14z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+1)];
                fy += gout9y * dm[(j0+0)*nao+(l0+1)];
                fz += gout9z * dm[(j0+0)*nao+(l0+1)];
                fx += gout15x * dm[(j0+0)*nao+(l0+2)];
                fy += gout15y * dm[(j0+0)*nao+(l0+2)];
                fz += gout15z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+1)];
                fy += gout10y * dm[(j0+0)*nao+(l0+1)];
                fz += gout10z * dm[(j0+0)*nao+(l0+1)];
                fx += gout16x * dm[(j0+0)*nao+(l0+2)];
                fy += gout16y * dm[(j0+0)*nao+(l0+2)];
                fz += gout16z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+1)];
                fy += gout11y * dm[(j0+0)*nao+(l0+1)];
                fz += gout11z * dm[(j0+0)*nao+(l0+1)];
                fx += gout17x * dm[(j0+0)*nao+(l0+2)];
                fy += gout17y * dm[(j0+0)*nao+(l0+2)];
                fz += gout17z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout6x * dm[(i0+0)*nao+(l0+1)];
                fy += gout6y * dm[(i0+0)*nao+(l0+1)];
                fz += gout6z * dm[(i0+0)*nao+(l0+1)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+0)*nao+(l0+1)];
                fy += gout7y * dm[(i0+0)*nao+(l0+1)];
                fz += gout7z * dm[(i0+0)*nao+(l0+1)];
                fx += gout13x * dm[(i0+0)*nao+(l0+2)];
                fy += gout13y * dm[(i0+0)*nao+(l0+2)];
                fz += gout13z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout8x * dm[(i0+0)*nao+(l0+1)];
                fy += gout8y * dm[(i0+0)*nao+(l0+1)];
                fz += gout8z * dm[(i0+0)*nao+(l0+1)];
                fx += gout14x * dm[(i0+0)*nao+(l0+2)];
                fy += gout14y * dm[(i0+0)*nao+(l0+2)];
                fz += gout14z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+1)];
                fy += gout9y * dm[(i0+0)*nao+(l0+1)];
                fz += gout9z * dm[(i0+0)*nao+(l0+1)];
                fx += gout15x * dm[(i0+0)*nao+(l0+2)];
                fy += gout15y * dm[(i0+0)*nao+(l0+2)];
                fz += gout15z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+1)];
                fy += gout10y * dm[(i0+0)*nao+(l0+1)];
                fz += gout10z * dm[(i0+0)*nao+(l0+1)];
                fx += gout16x * dm[(i0+0)*nao+(l0+2)];
                fy += gout16y * dm[(i0+0)*nao+(l0+2)];
                fz += gout16z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+1)];
                fy += gout11y * dm[(i0+0)*nao+(l0+1)];
                fz += gout11z * dm[(i0+0)*nao+(l0+1)];
                fx += gout17x * dm[(i0+0)*nao+(l0+2)];
                fy += gout17y * dm[(i0+0)*nao+(l0+2)];
                fz += gout17z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0021(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0021(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0022(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double b01 = .5/akl * (1 - rt_akl);
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double trr_01x = cpx * 1;
                    double trr_12x = cpx * trr_11x + 1*b01 * trr_10x + 1*b00 * trr_01x;
                    double trr_02x = cpx * trr_01x + 1*b01 * 1;
                    double trr_13x = cpx * trr_12x + 2*b01 * trr_11x + 1*b00 * trr_02x;
                    double trr_03x = cpx * trr_02x + 2*b01 * trr_01x;
                    double trr_14x = cpx * trr_13x + 3*b01 * trr_12x + 1*b00 * trr_03x;
                    double hrr_1031x = trr_14x - (rl[0] - rk[0]) * trr_13x;
                    double hrr_1021x = trr_13x - (rl[0] - rk[0]) * trr_12x;
                    double hrr_1022x = hrr_1031x - (rl[0] - rk[0]) * hrr_1021x;
                    fx = ai2 * hrr_1022x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_04x = cpx * trr_03x + 3*b01 * trr_02x;
                    double hrr_0031x = trr_04x - (rl[0] - rk[0]) * trr_03x;
                    double hrr_0021x = trr_03x - (rl[0] - rk[0]) * trr_02x;
                    double hrr_0022x = hrr_0031x - (rl[0] - rk[0]) * hrr_0021x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_0022x *  fy  * wt;
                    gout0z += hrr_0022x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_1011x = trr_12x - (rl[0] - rk[0]) * trr_11x;
                    double hrr_1012x = hrr_1021x - (rl[0] - rk[0]) * hrr_1011x;
                    fx = ai2 * hrr_1012x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    double hrr_0011x = trr_02x - (rl[0] - rk[0]) * trr_01x;
                    double hrr_0012x = hrr_0021x - (rl[0] - rk[0]) * hrr_0011x;
                    double trr_01y = cpy * 1;
                    gout1x +=  fx  * trr_01y * wt;
                    gout1y += hrr_0012x *  fy  * wt;
                    gout1z += hrr_0012x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1012x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    double trr_01z = cpz * wt;
                    gout2x +=  fx  * 1 * trr_01z;
                    gout2y += hrr_0012x *  fy  * trr_01z;
                    gout2z += hrr_0012x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_1001x = trr_11x - (rl[0] - rk[0]) * trr_10x;
                    double hrr_1002x = hrr_1011x - (rl[0] - rk[0]) * hrr_1001x;
                    fx = ai2 * hrr_1002x;
                    double trr_12y = cpy * trr_11y + 1*b01 * trr_10y + 1*b00 * trr_01y;
                    fy = ai2 * trr_12y;
                    fz = ai2 * trr_10z;
                    double hrr_0001x = trr_01x - (rl[0] - rk[0]) * 1;
                    double hrr_0002x = hrr_0011x - (rl[0] - rk[0]) * hrr_0001x;
                    double trr_02y = cpy * trr_01y + 1*b01 * 1;
                    gout3x +=  fx  * trr_02y * wt;
                    gout3y += hrr_0002x *  fy  * wt;
                    gout3z += hrr_0002x * trr_02y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1002x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_11z;
                    gout4x +=  fx  * trr_01y * trr_01z;
                    gout4y += hrr_0002x *  fy  * trr_01z;
                    gout4z += hrr_0002x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1002x;
                    fy = ai2 * trr_10y;
                    double trr_12z = cpz * trr_11z + 1*b01 * trr_10z + 1*b00 * trr_01z;
                    fz = ai2 * trr_12z;
                    double trr_02z = cpz * trr_01z + 1*b01 * wt;
                    gout5x +=  fx  * 1 * trr_02z;
                    gout5y += hrr_0002x *  fy  * trr_02z;
                    gout5z += hrr_0002x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1021x;
                    double hrr_1001y = trr_11y - (rl[1] - rk[1]) * trr_10y;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_10z;
                    double hrr_0001y = trr_01y - (rl[1] - rk[1]) * 1;
                    gout6x +=  fx  * hrr_0001y * wt;
                    gout6y += hrr_0021x *  fy  * wt;
                    gout6z += hrr_0021x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1011x;
                    double hrr_1011y = trr_12y - (rl[1] - rk[1]) * trr_11y;
                    fy = ai2 * hrr_1011y;
                    fz = ai2 * trr_10z;
                    double hrr_0011y = trr_02y - (rl[1] - rk[1]) * trr_01y;
                    gout7x +=  fx  * hrr_0011y * wt;
                    gout7y += hrr_0011x *  fy  * wt;
                    gout7z += hrr_0011x * hrr_0011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1011x;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_11z;
                    gout8x +=  fx  * hrr_0001y * trr_01z;
                    gout8y += hrr_0011x *  fy  * trr_01z;
                    gout8z += hrr_0011x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    double trr_13y = cpy * trr_12y + 2*b01 * trr_11y + 1*b00 * trr_02y;
                    double hrr_1021y = trr_13y - (rl[1] - rk[1]) * trr_12y;
                    fy = ai2 * hrr_1021y;
                    fz = ai2 * trr_10z;
                    double trr_03y = cpy * trr_02y + 2*b01 * trr_01y;
                    double hrr_0021y = trr_03y - (rl[1] - rk[1]) * trr_02y;
                    gout9x +=  fx  * hrr_0021y * wt;
                    gout9y += hrr_0001x *  fy  * wt;
                    gout9z += hrr_0001x * hrr_0021y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * hrr_1011y;
                    fz = ai2 * trr_11z;
                    gout10x +=  fx  * hrr_0011y * trr_01z;
                    gout10y += hrr_0001x *  fy  * trr_01z;
                    gout10z += hrr_0001x * hrr_0011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_12z;
                    gout11x +=  fx  * hrr_0001y * trr_02z;
                    gout11y += hrr_0001x *  fy  * trr_02z;
                    gout11z += hrr_0001x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1021x;
                    fy = ai2 * trr_10y;
                    double hrr_1001z = trr_11z - (rl[2] - rk[2]) * trr_10z;
                    fz = ai2 * hrr_1001z;
                    double hrr_0001z = trr_01z - (rl[2] - rk[2]) * wt;
                    gout12x +=  fx  * 1 * hrr_0001z;
                    gout12y += hrr_0021x *  fy  * hrr_0001z;
                    gout12z += hrr_0021x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1011x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1001z;
                    gout13x +=  fx  * trr_01y * hrr_0001z;
                    gout13y += hrr_0011x *  fy  * hrr_0001z;
                    gout13z += hrr_0011x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1011x;
                    fy = ai2 * trr_10y;
                    double hrr_1011z = trr_12z - (rl[2] - rk[2]) * trr_11z;
                    fz = ai2 * hrr_1011z;
                    double hrr_0011z = trr_02z - (rl[2] - rk[2]) * trr_01z;
                    gout14x +=  fx  * 1 * hrr_0011z;
                    gout14y += hrr_0011x *  fy  * hrr_0011z;
                    gout14z += hrr_0011x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * trr_12y;
                    fz = ai2 * hrr_1001z;
                    gout15x +=  fx  * trr_02y * hrr_0001z;
                    gout15y += hrr_0001x *  fy  * hrr_0001z;
                    gout15z += hrr_0001x * trr_02y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1011z;
                    gout16x +=  fx  * trr_01y * hrr_0011z;
                    gout16y += hrr_0001x *  fy  * hrr_0011z;
                    gout16z += hrr_0001x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * trr_10y;
                    double trr_13z = cpz * trr_12z + 2*b01 * trr_11z + 1*b00 * trr_02z;
                    double hrr_1021z = trr_13z - (rl[2] - rk[2]) * trr_12z;
                    fz = ai2 * hrr_1021z;
                    double trr_03z = cpz * trr_02z + 2*b01 * trr_01z;
                    double hrr_0021z = trr_03z - (rl[2] - rk[2]) * trr_02z;
                    gout17x +=  fx  * 1 * hrr_0021z;
                    gout17y += hrr_0001x *  fy  * hrr_0021z;
                    gout17z += hrr_0001x * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout1x * dm[(l0+0)*nao+(k0+1)];
                fy += gout1y * dm[(l0+0)*nao+(k0+1)];
                fz += gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout2x * dm[(l0+0)*nao+(k0+2)];
                fy += gout2y * dm[(l0+0)*nao+(k0+2)];
                fz += gout2z * dm[(l0+0)*nao+(k0+2)];
                fx += gout3x * dm[(l0+0)*nao+(k0+3)];
                fy += gout3y * dm[(l0+0)*nao+(k0+3)];
                fz += gout3z * dm[(l0+0)*nao+(k0+3)];
                fx += gout4x * dm[(l0+0)*nao+(k0+4)];
                fy += gout4y * dm[(l0+0)*nao+(k0+4)];
                fz += gout4z * dm[(l0+0)*nao+(k0+4)];
                fx += gout5x * dm[(l0+0)*nao+(k0+5)];
                fy += gout5y * dm[(l0+0)*nao+(k0+5)];
                fz += gout5z * dm[(l0+0)*nao+(k0+5)];
                fx += gout6x * dm[(l0+1)*nao+(k0+0)];
                fy += gout6y * dm[(l0+1)*nao+(k0+0)];
                fz += gout6z * dm[(l0+1)*nao+(k0+0)];
                fx += gout7x * dm[(l0+1)*nao+(k0+1)];
                fy += gout7y * dm[(l0+1)*nao+(k0+1)];
                fz += gout7z * dm[(l0+1)*nao+(k0+1)];
                fx += gout8x * dm[(l0+1)*nao+(k0+2)];
                fy += gout8y * dm[(l0+1)*nao+(k0+2)];
                fz += gout8z * dm[(l0+1)*nao+(k0+2)];
                fx += gout9x * dm[(l0+1)*nao+(k0+3)];
                fy += gout9y * dm[(l0+1)*nao+(k0+3)];
                fz += gout9z * dm[(l0+1)*nao+(k0+3)];
                fx += gout10x * dm[(l0+1)*nao+(k0+4)];
                fy += gout10y * dm[(l0+1)*nao+(k0+4)];
                fz += gout10z * dm[(l0+1)*nao+(k0+4)];
                fx += gout11x * dm[(l0+1)*nao+(k0+5)];
                fy += gout11y * dm[(l0+1)*nao+(k0+5)];
                fz += gout11z * dm[(l0+1)*nao+(k0+5)];
                fx += gout12x * dm[(l0+2)*nao+(k0+0)];
                fy += gout12y * dm[(l0+2)*nao+(k0+0)];
                fz += gout12z * dm[(l0+2)*nao+(k0+0)];
                fx += gout13x * dm[(l0+2)*nao+(k0+1)];
                fy += gout13y * dm[(l0+2)*nao+(k0+1)];
                fz += gout13z * dm[(l0+2)*nao+(k0+1)];
                fx += gout14x * dm[(l0+2)*nao+(k0+2)];
                fy += gout14y * dm[(l0+2)*nao+(k0+2)];
                fz += gout14z * dm[(l0+2)*nao+(k0+2)];
                fx += gout15x * dm[(l0+2)*nao+(k0+3)];
                fy += gout15y * dm[(l0+2)*nao+(k0+3)];
                fz += gout15z * dm[(l0+2)*nao+(k0+3)];
                fx += gout16x * dm[(l0+2)*nao+(k0+4)];
                fy += gout16y * dm[(l0+2)*nao+(k0+4)];
                fz += gout16z * dm[(l0+2)*nao+(k0+4)];
                fx += gout17x * dm[(l0+2)*nao+(k0+5)];
                fy += gout17y * dm[(l0+2)*nao+(k0+5)];
                fz += gout17z * dm[(l0+2)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+0)];
                fy = gout2y * dm[(j0+0)*nao+(i0+0)];
                fz = gout2z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+0)];
                fy = gout5y * dm[(j0+0)*nao+(i0+0)];
                fz = gout5z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+0)];
                fy = gout7y * dm[(j0+0)*nao+(i0+0)];
                fz = gout7z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+0)];
                fy = gout8y * dm[(j0+0)*nao+(i0+0)];
                fz = gout8z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(i0+0)];
                fy = gout10y * dm[(j0+0)*nao+(i0+0)];
                fz = gout10z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+0)];
                fy = gout11y * dm[(j0+0)*nao+(i0+0)];
                fz = gout11z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+1), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout13x * dm[(j0+0)*nao+(i0+0)];
                fy = gout13y * dm[(j0+0)*nao+(i0+0)];
                fz = gout13z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout14x * dm[(j0+0)*nao+(i0+0)];
                fy = gout14y * dm[(j0+0)*nao+(i0+0)];
                fz = gout14z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                fx = gout15x * dm[(j0+0)*nao+(i0+0)];
                fy = gout15y * dm[(j0+0)*nao+(i0+0)];
                fz = gout15z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+2), fz);
                fx = gout16x * dm[(j0+0)*nao+(i0+0)];
                fy = gout16y * dm[(j0+0)*nao+(i0+0)];
                fz = gout16z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+2), fz);
                fx = gout17x * dm[(j0+0)*nao+(i0+0)];
                fy = gout17y * dm[(j0+0)*nao+(i0+0)];
                fz = gout17z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+2), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout1x * dm[(j0+0)*nao+(k0+1)];
                fy += gout1y * dm[(j0+0)*nao+(k0+1)];
                fz += gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout2x * dm[(j0+0)*nao+(k0+2)];
                fy += gout2y * dm[(j0+0)*nao+(k0+2)];
                fz += gout2z * dm[(j0+0)*nao+(k0+2)];
                fx += gout3x * dm[(j0+0)*nao+(k0+3)];
                fy += gout3y * dm[(j0+0)*nao+(k0+3)];
                fz += gout3z * dm[(j0+0)*nao+(k0+3)];
                fx += gout4x * dm[(j0+0)*nao+(k0+4)];
                fy += gout4y * dm[(j0+0)*nao+(k0+4)];
                fz += gout4z * dm[(j0+0)*nao+(k0+4)];
                fx += gout5x * dm[(j0+0)*nao+(k0+5)];
                fy += gout5y * dm[(j0+0)*nao+(k0+5)];
                fz += gout5z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+0)];
                fy = gout6y * dm[(j0+0)*nao+(k0+0)];
                fz = gout6z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+0)*nao+(k0+1)];
                fy += gout7y * dm[(j0+0)*nao+(k0+1)];
                fz += gout7z * dm[(j0+0)*nao+(k0+1)];
                fx += gout8x * dm[(j0+0)*nao+(k0+2)];
                fy += gout8y * dm[(j0+0)*nao+(k0+2)];
                fz += gout8z * dm[(j0+0)*nao+(k0+2)];
                fx += gout9x * dm[(j0+0)*nao+(k0+3)];
                fy += gout9y * dm[(j0+0)*nao+(k0+3)];
                fz += gout9z * dm[(j0+0)*nao+(k0+3)];
                fx += gout10x * dm[(j0+0)*nao+(k0+4)];
                fy += gout10y * dm[(j0+0)*nao+(k0+4)];
                fz += gout10z * dm[(j0+0)*nao+(k0+4)];
                fx += gout11x * dm[(j0+0)*nao+(k0+5)];
                fy += gout11y * dm[(j0+0)*nao+(k0+5)];
                fz += gout11z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout12x * dm[(j0+0)*nao+(k0+0)];
                fy = gout12y * dm[(j0+0)*nao+(k0+0)];
                fz = gout12z * dm[(j0+0)*nao+(k0+0)];
                fx += gout13x * dm[(j0+0)*nao+(k0+1)];
                fy += gout13y * dm[(j0+0)*nao+(k0+1)];
                fz += gout13z * dm[(j0+0)*nao+(k0+1)];
                fx += gout14x * dm[(j0+0)*nao+(k0+2)];
                fy += gout14y * dm[(j0+0)*nao+(k0+2)];
                fz += gout14z * dm[(j0+0)*nao+(k0+2)];
                fx += gout15x * dm[(j0+0)*nao+(k0+3)];
                fy += gout15y * dm[(j0+0)*nao+(k0+3)];
                fz += gout15z * dm[(j0+0)*nao+(k0+3)];
                fx += gout16x * dm[(j0+0)*nao+(k0+4)];
                fy += gout16y * dm[(j0+0)*nao+(k0+4)];
                fz += gout16z * dm[(j0+0)*nao+(k0+4)];
                fx += gout17x * dm[(j0+0)*nao+(k0+5)];
                fy += gout17y * dm[(j0+0)*nao+(k0+5)];
                fz += gout17z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+0)*nao+(k0+1)];
                fy += gout1y * dm[(i0+0)*nao+(k0+1)];
                fz += gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout2x * dm[(i0+0)*nao+(k0+2)];
                fy += gout2y * dm[(i0+0)*nao+(k0+2)];
                fz += gout2z * dm[(i0+0)*nao+(k0+2)];
                fx += gout3x * dm[(i0+0)*nao+(k0+3)];
                fy += gout3y * dm[(i0+0)*nao+(k0+3)];
                fz += gout3z * dm[(i0+0)*nao+(k0+3)];
                fx += gout4x * dm[(i0+0)*nao+(k0+4)];
                fy += gout4y * dm[(i0+0)*nao+(k0+4)];
                fz += gout4z * dm[(i0+0)*nao+(k0+4)];
                fx += gout5x * dm[(i0+0)*nao+(k0+5)];
                fy += gout5y * dm[(i0+0)*nao+(k0+5)];
                fz += gout5z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+0)];
                fy = gout6y * dm[(i0+0)*nao+(k0+0)];
                fz = gout6z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+0)*nao+(k0+1)];
                fy += gout7y * dm[(i0+0)*nao+(k0+1)];
                fz += gout7z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+0)*nao+(k0+2)];
                fy += gout8y * dm[(i0+0)*nao+(k0+2)];
                fz += gout8z * dm[(i0+0)*nao+(k0+2)];
                fx += gout9x * dm[(i0+0)*nao+(k0+3)];
                fy += gout9y * dm[(i0+0)*nao+(k0+3)];
                fz += gout9z * dm[(i0+0)*nao+(k0+3)];
                fx += gout10x * dm[(i0+0)*nao+(k0+4)];
                fy += gout10y * dm[(i0+0)*nao+(k0+4)];
                fz += gout10z * dm[(i0+0)*nao+(k0+4)];
                fx += gout11x * dm[(i0+0)*nao+(k0+5)];
                fy += gout11y * dm[(i0+0)*nao+(k0+5)];
                fz += gout11z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout12x * dm[(i0+0)*nao+(k0+0)];
                fy = gout12y * dm[(i0+0)*nao+(k0+0)];
                fz = gout12z * dm[(i0+0)*nao+(k0+0)];
                fx += gout13x * dm[(i0+0)*nao+(k0+1)];
                fy += gout13y * dm[(i0+0)*nao+(k0+1)];
                fz += gout13z * dm[(i0+0)*nao+(k0+1)];
                fx += gout14x * dm[(i0+0)*nao+(k0+2)];
                fy += gout14y * dm[(i0+0)*nao+(k0+2)];
                fz += gout14z * dm[(i0+0)*nao+(k0+2)];
                fx += gout15x * dm[(i0+0)*nao+(k0+3)];
                fy += gout15y * dm[(i0+0)*nao+(k0+3)];
                fz += gout15z * dm[(i0+0)*nao+(k0+3)];
                fx += gout16x * dm[(i0+0)*nao+(k0+4)];
                fy += gout16y * dm[(i0+0)*nao+(k0+4)];
                fz += gout16z * dm[(i0+0)*nao+(k0+4)];
                fx += gout17x * dm[(i0+0)*nao+(k0+5)];
                fy += gout17y * dm[(i0+0)*nao+(k0+5)];
                fz += gout17z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout6x * dm[(j0+0)*nao+(l0+1)];
                fy += gout6y * dm[(j0+0)*nao+(l0+1)];
                fz += gout6z * dm[(j0+0)*nao+(l0+1)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout7x * dm[(j0+0)*nao+(l0+1)];
                fy += gout7y * dm[(j0+0)*nao+(l0+1)];
                fz += gout7z * dm[(j0+0)*nao+(l0+1)];
                fx += gout13x * dm[(j0+0)*nao+(l0+2)];
                fy += gout13y * dm[(j0+0)*nao+(l0+2)];
                fz += gout13z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout8x * dm[(j0+0)*nao+(l0+1)];
                fy += gout8y * dm[(j0+0)*nao+(l0+1)];
                fz += gout8z * dm[(j0+0)*nao+(l0+1)];
                fx += gout14x * dm[(j0+0)*nao+(l0+2)];
                fy += gout14y * dm[(j0+0)*nao+(l0+2)];
                fz += gout14z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+1)];
                fy += gout9y * dm[(j0+0)*nao+(l0+1)];
                fz += gout9z * dm[(j0+0)*nao+(l0+1)];
                fx += gout15x * dm[(j0+0)*nao+(l0+2)];
                fy += gout15y * dm[(j0+0)*nao+(l0+2)];
                fz += gout15z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+1)];
                fy += gout10y * dm[(j0+0)*nao+(l0+1)];
                fz += gout10z * dm[(j0+0)*nao+(l0+1)];
                fx += gout16x * dm[(j0+0)*nao+(l0+2)];
                fy += gout16y * dm[(j0+0)*nao+(l0+2)];
                fz += gout16z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+1)];
                fy += gout11y * dm[(j0+0)*nao+(l0+1)];
                fz += gout11z * dm[(j0+0)*nao+(l0+1)];
                fx += gout17x * dm[(j0+0)*nao+(l0+2)];
                fy += gout17y * dm[(j0+0)*nao+(l0+2)];
                fz += gout17z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout6x * dm[(i0+0)*nao+(l0+1)];
                fy += gout6y * dm[(i0+0)*nao+(l0+1)];
                fz += gout6z * dm[(i0+0)*nao+(l0+1)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+0)*nao+(l0+1)];
                fy += gout7y * dm[(i0+0)*nao+(l0+1)];
                fz += gout7z * dm[(i0+0)*nao+(l0+1)];
                fx += gout13x * dm[(i0+0)*nao+(l0+2)];
                fy += gout13y * dm[(i0+0)*nao+(l0+2)];
                fz += gout13z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout8x * dm[(i0+0)*nao+(l0+1)];
                fy += gout8y * dm[(i0+0)*nao+(l0+1)];
                fz += gout8z * dm[(i0+0)*nao+(l0+1)];
                fx += gout14x * dm[(i0+0)*nao+(l0+2)];
                fy += gout14y * dm[(i0+0)*nao+(l0+2)];
                fz += gout14z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+1)];
                fy += gout9y * dm[(i0+0)*nao+(l0+1)];
                fz += gout9z * dm[(i0+0)*nao+(l0+1)];
                fx += gout15x * dm[(i0+0)*nao+(l0+2)];
                fy += gout15y * dm[(i0+0)*nao+(l0+2)];
                fz += gout15z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+1)];
                fy += gout10y * dm[(i0+0)*nao+(l0+1)];
                fz += gout10z * dm[(i0+0)*nao+(l0+1)];
                fx += gout16x * dm[(i0+0)*nao+(l0+2)];
                fy += gout16y * dm[(i0+0)*nao+(l0+2)];
                fz += gout16z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+1)];
                fy += gout11y * dm[(i0+0)*nao+(l0+1)];
                fz += gout11z * dm[(i0+0)*nao+(l0+1)];
                fx += gout17x * dm[(i0+0)*nao+(l0+2)];
                fy += gout17y * dm[(i0+0)*nao+(l0+2)];
                fz += gout17z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
            }
        }

        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double b01 = .5/akl * (1 - rt_akl);
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double trr_01x = cpx * 1;
                    double trr_12x = cpx * trr_11x + 1*b01 * trr_10x + 1*b00 * trr_01x;
                    fx = ai2 * trr_12x;
                    double cpy = yqc + ypq*rt_akl;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    double trr_01y = cpy * 1;
                    double trr_12y = cpy * trr_11y + 1*b01 * trr_10y + 1*b00 * trr_01y;
                    double hrr_1011y = trr_12y - (rl[1] - rk[1]) * trr_11y;
                    double hrr_1001y = trr_11y - (rl[1] - rk[1]) * trr_10y;
                    double hrr_1002y = hrr_1011y - (rl[1] - rk[1]) * hrr_1001y;
                    fy = ai2 * hrr_1002y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_02x = cpx * trr_01x + 1*b01 * 1;
                    double trr_02y = cpy * trr_01y + 1*b01 * 1;
                    double hrr_0011y = trr_02y - (rl[1] - rk[1]) * trr_01y;
                    double hrr_0001y = trr_01y - (rl[1] - rk[1]) * 1;
                    double hrr_0002y = hrr_0011y - (rl[1] - rk[1]) * hrr_0001y;
                    gout0x +=  fx  * hrr_0002y * wt;
                    gout0y += trr_02x *  fy  * wt;
                    gout0z += trr_02x * hrr_0002y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double trr_13y = cpy * trr_12y + 2*b01 * trr_11y + 1*b00 * trr_02y;
                    double hrr_1021y = trr_13y - (rl[1] - rk[1]) * trr_12y;
                    double hrr_1012y = hrr_1021y - (rl[1] - rk[1]) * hrr_1011y;
                    fy = ai2 * hrr_1012y;
                    fz = ai2 * trr_10z;
                    double trr_03y = cpy * trr_02y + 2*b01 * trr_01y;
                    double hrr_0021y = trr_03y - (rl[1] - rk[1]) * trr_02y;
                    double hrr_0012y = hrr_0021y - (rl[1] - rk[1]) * hrr_0011y;
                    gout1x +=  fx  * hrr_0012y * wt;
                    gout1y += trr_01x *  fy  * wt;
                    gout1z += trr_01x * hrr_0012y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * hrr_1002y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    double trr_01z = cpz * wt;
                    gout2x +=  fx  * hrr_0002y * trr_01z;
                    gout2y += trr_01x *  fy  * trr_01z;
                    gout2z += trr_01x * hrr_0002y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_14y = cpy * trr_13y + 3*b01 * trr_12y + 1*b00 * trr_03y;
                    double hrr_1031y = trr_14y - (rl[1] - rk[1]) * trr_13y;
                    double hrr_1022y = hrr_1031y - (rl[1] - rk[1]) * hrr_1021y;
                    fy = ai2 * hrr_1022y;
                    fz = ai2 * trr_10z;
                    double trr_04y = cpy * trr_03y + 3*b01 * trr_02y;
                    double hrr_0031y = trr_04y - (rl[1] - rk[1]) * trr_03y;
                    double hrr_0022y = hrr_0031y - (rl[1] - rk[1]) * hrr_0021y;
                    gout3x +=  fx  * hrr_0022y * wt;
                    gout3y += 1 *  fy  * wt;
                    gout3z += 1 * hrr_0022y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1012y;
                    fz = ai2 * trr_11z;
                    gout4x +=  fx  * hrr_0012y * trr_01z;
                    gout4y += 1 *  fy  * trr_01z;
                    gout4z += 1 * hrr_0012y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1002y;
                    double trr_12z = cpz * trr_11z + 1*b01 * trr_10z + 1*b00 * trr_01z;
                    fz = ai2 * trr_12z;
                    double trr_02z = cpz * trr_01z + 1*b01 * wt;
                    gout5x +=  fx  * hrr_0002y * trr_02z;
                    gout5y += 1 *  fy  * trr_02z;
                    gout5z += 1 * hrr_0002y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_12x;
                    fy = ai2 * hrr_1001y;
                    double hrr_1001z = trr_11z - (rl[2] - rk[2]) * trr_10z;
                    fz = ai2 * hrr_1001z;
                    double hrr_0001z = trr_01z - (rl[2] - rk[2]) * wt;
                    gout6x +=  fx  * hrr_0001y * hrr_0001z;
                    gout6y += trr_02x *  fy  * hrr_0001z;
                    gout6z += trr_02x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * hrr_1011y;
                    fz = ai2 * hrr_1001z;
                    gout7x +=  fx  * hrr_0011y * hrr_0001z;
                    gout7y += trr_01x *  fy  * hrr_0001z;
                    gout7z += trr_01x * hrr_0011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * hrr_1001y;
                    double hrr_1011z = trr_12z - (rl[2] - rk[2]) * trr_11z;
                    fz = ai2 * hrr_1011z;
                    double hrr_0011z = trr_02z - (rl[2] - rk[2]) * trr_01z;
                    gout8x +=  fx  * hrr_0001y * hrr_0011z;
                    gout8y += trr_01x *  fy  * hrr_0011z;
                    gout8z += trr_01x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1021y;
                    fz = ai2 * hrr_1001z;
                    gout9x +=  fx  * hrr_0021y * hrr_0001z;
                    gout9y += 1 *  fy  * hrr_0001z;
                    gout9z += 1 * hrr_0021y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1011y;
                    fz = ai2 * hrr_1011z;
                    gout10x +=  fx  * hrr_0011y * hrr_0011z;
                    gout10y += 1 *  fy  * hrr_0011z;
                    gout10z += 1 * hrr_0011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1001y;
                    double trr_13z = cpz * trr_12z + 2*b01 * trr_11z + 1*b00 * trr_02z;
                    double hrr_1021z = trr_13z - (rl[2] - rk[2]) * trr_12z;
                    fz = ai2 * hrr_1021z;
                    double trr_03z = cpz * trr_02z + 2*b01 * trr_01z;
                    double hrr_0021z = trr_03z - (rl[2] - rk[2]) * trr_02z;
                    gout11x +=  fx  * hrr_0001y * hrr_0021z;
                    gout11y += 1 *  fy  * hrr_0021z;
                    gout11z += 1 * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_12x;
                    fy = ai2 * trr_10y;
                    double hrr_1002z = hrr_1011z - (rl[2] - rk[2]) * hrr_1001z;
                    fz = ai2 * hrr_1002z;
                    double hrr_0002z = hrr_0011z - (rl[2] - rk[2]) * hrr_0001z;
                    gout12x +=  fx  * 1 * hrr_0002z;
                    gout12y += trr_02x *  fy  * hrr_0002z;
                    gout12z += trr_02x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1002z;
                    gout13x +=  fx  * trr_01y * hrr_0002z;
                    gout13y += trr_01x *  fy  * hrr_0002z;
                    gout13z += trr_01x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double hrr_1012z = hrr_1021z - (rl[2] - rk[2]) * hrr_1011z;
                    fz = ai2 * hrr_1012z;
                    double hrr_0012z = hrr_0021z - (rl[2] - rk[2]) * hrr_0011z;
                    gout14x +=  fx  * 1 * hrr_0012z;
                    gout14y += trr_01x *  fy  * hrr_0012z;
                    gout14z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_12y;
                    fz = ai2 * hrr_1002z;
                    gout15x +=  fx  * trr_02y * hrr_0002z;
                    gout15y += 1 *  fy  * hrr_0002z;
                    gout15z += 1 * trr_02y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1012z;
                    gout16x +=  fx  * trr_01y * hrr_0012z;
                    gout16y += 1 *  fy  * hrr_0012z;
                    gout16z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_14z = cpz * trr_13z + 3*b01 * trr_12z + 1*b00 * trr_03z;
                    double hrr_1031z = trr_14z - (rl[2] - rk[2]) * trr_13z;
                    double hrr_1022z = hrr_1031z - (rl[2] - rk[2]) * hrr_1021z;
                    fz = ai2 * hrr_1022z;
                    double trr_04z = cpz * trr_03z + 3*b01 * trr_02z;
                    double hrr_0031z = trr_04z - (rl[2] - rk[2]) * trr_03z;
                    double hrr_0022z = hrr_0031z - (rl[2] - rk[2]) * hrr_0021z;
                    gout17x +=  fx  * 1 * hrr_0022z;
                    gout17y += 1 *  fy  * hrr_0022z;
                    gout17z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+3)*nao+(k0+0)];
                fy = gout0y * dm[(l0+3)*nao+(k0+0)];
                fz = gout0z * dm[(l0+3)*nao+(k0+0)];
                fx += gout1x * dm[(l0+3)*nao+(k0+1)];
                fy += gout1y * dm[(l0+3)*nao+(k0+1)];
                fz += gout1z * dm[(l0+3)*nao+(k0+1)];
                fx += gout2x * dm[(l0+3)*nao+(k0+2)];
                fy += gout2y * dm[(l0+3)*nao+(k0+2)];
                fz += gout2z * dm[(l0+3)*nao+(k0+2)];
                fx += gout3x * dm[(l0+3)*nao+(k0+3)];
                fy += gout3y * dm[(l0+3)*nao+(k0+3)];
                fz += gout3z * dm[(l0+3)*nao+(k0+3)];
                fx += gout4x * dm[(l0+3)*nao+(k0+4)];
                fy += gout4y * dm[(l0+3)*nao+(k0+4)];
                fz += gout4z * dm[(l0+3)*nao+(k0+4)];
                fx += gout5x * dm[(l0+3)*nao+(k0+5)];
                fy += gout5y * dm[(l0+3)*nao+(k0+5)];
                fz += gout5z * dm[(l0+3)*nao+(k0+5)];
                fx += gout6x * dm[(l0+4)*nao+(k0+0)];
                fy += gout6y * dm[(l0+4)*nao+(k0+0)];
                fz += gout6z * dm[(l0+4)*nao+(k0+0)];
                fx += gout7x * dm[(l0+4)*nao+(k0+1)];
                fy += gout7y * dm[(l0+4)*nao+(k0+1)];
                fz += gout7z * dm[(l0+4)*nao+(k0+1)];
                fx += gout8x * dm[(l0+4)*nao+(k0+2)];
                fy += gout8y * dm[(l0+4)*nao+(k0+2)];
                fz += gout8z * dm[(l0+4)*nao+(k0+2)];
                fx += gout9x * dm[(l0+4)*nao+(k0+3)];
                fy += gout9y * dm[(l0+4)*nao+(k0+3)];
                fz += gout9z * dm[(l0+4)*nao+(k0+3)];
                fx += gout10x * dm[(l0+4)*nao+(k0+4)];
                fy += gout10y * dm[(l0+4)*nao+(k0+4)];
                fz += gout10z * dm[(l0+4)*nao+(k0+4)];
                fx += gout11x * dm[(l0+4)*nao+(k0+5)];
                fy += gout11y * dm[(l0+4)*nao+(k0+5)];
                fz += gout11z * dm[(l0+4)*nao+(k0+5)];
                fx += gout12x * dm[(l0+5)*nao+(k0+0)];
                fy += gout12y * dm[(l0+5)*nao+(k0+0)];
                fz += gout12z * dm[(l0+5)*nao+(k0+0)];
                fx += gout13x * dm[(l0+5)*nao+(k0+1)];
                fy += gout13y * dm[(l0+5)*nao+(k0+1)];
                fz += gout13z * dm[(l0+5)*nao+(k0+1)];
                fx += gout14x * dm[(l0+5)*nao+(k0+2)];
                fy += gout14y * dm[(l0+5)*nao+(k0+2)];
                fz += gout14z * dm[(l0+5)*nao+(k0+2)];
                fx += gout15x * dm[(l0+5)*nao+(k0+3)];
                fy += gout15y * dm[(l0+5)*nao+(k0+3)];
                fz += gout15z * dm[(l0+5)*nao+(k0+3)];
                fx += gout16x * dm[(l0+5)*nao+(k0+4)];
                fy += gout16y * dm[(l0+5)*nao+(k0+4)];
                fz += gout16z * dm[(l0+5)*nao+(k0+4)];
                fx += gout17x * dm[(l0+5)*nao+(k0+5)];
                fy += gout17y * dm[(l0+5)*nao+(k0+5)];
                fz += gout17z * dm[(l0+5)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+3), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+3), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+3), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+3), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+3), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+3), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+0)];
                fy = gout2y * dm[(j0+0)*nao+(i0+0)];
                fz = gout2z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+3), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+3), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+3), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+3), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+3), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+3), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+3), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+3), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+3), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+0)];
                fy = gout5y * dm[(j0+0)*nao+(i0+0)];
                fz = gout5z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+3), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+3), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+3), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+4), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+4), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+4), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+0)];
                fy = gout7y * dm[(j0+0)*nao+(i0+0)];
                fz = gout7z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+4), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+4), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+4), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+0)];
                fy = gout8y * dm[(j0+0)*nao+(i0+0)];
                fz = gout8z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+4), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+4), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+4), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+4), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+4), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+4), fz);
                fx = gout10x * dm[(j0+0)*nao+(i0+0)];
                fy = gout10y * dm[(j0+0)*nao+(i0+0)];
                fz = gout10z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+4), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+4), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+4), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+0)];
                fy = gout11y * dm[(j0+0)*nao+(i0+0)];
                fz = gout11z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+4), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+4), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+4), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+5), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+5), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+5), fz);
                fx = gout13x * dm[(j0+0)*nao+(i0+0)];
                fy = gout13y * dm[(j0+0)*nao+(i0+0)];
                fz = gout13z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+5), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+5), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+5), fz);
                fx = gout14x * dm[(j0+0)*nao+(i0+0)];
                fy = gout14y * dm[(j0+0)*nao+(i0+0)];
                fz = gout14z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+5), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+5), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+5), fz);
                fx = gout15x * dm[(j0+0)*nao+(i0+0)];
                fy = gout15y * dm[(j0+0)*nao+(i0+0)];
                fz = gout15z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+5), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+5), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+5), fz);
                fx = gout16x * dm[(j0+0)*nao+(i0+0)];
                fy = gout16y * dm[(j0+0)*nao+(i0+0)];
                fz = gout16z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+5), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+5), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+5), fz);
                fx = gout17x * dm[(j0+0)*nao+(i0+0)];
                fy = gout17y * dm[(j0+0)*nao+(i0+0)];
                fz = gout17z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+5), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+5), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+5), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout1x * dm[(j0+0)*nao+(k0+1)];
                fy += gout1y * dm[(j0+0)*nao+(k0+1)];
                fz += gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout2x * dm[(j0+0)*nao+(k0+2)];
                fy += gout2y * dm[(j0+0)*nao+(k0+2)];
                fz += gout2z * dm[(j0+0)*nao+(k0+2)];
                fx += gout3x * dm[(j0+0)*nao+(k0+3)];
                fy += gout3y * dm[(j0+0)*nao+(k0+3)];
                fz += gout3z * dm[(j0+0)*nao+(k0+3)];
                fx += gout4x * dm[(j0+0)*nao+(k0+4)];
                fy += gout4y * dm[(j0+0)*nao+(k0+4)];
                fz += gout4z * dm[(j0+0)*nao+(k0+4)];
                fx += gout5x * dm[(j0+0)*nao+(k0+5)];
                fy += gout5y * dm[(j0+0)*nao+(k0+5)];
                fz += gout5z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+3), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+0)];
                fy = gout6y * dm[(j0+0)*nao+(k0+0)];
                fz = gout6z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+0)*nao+(k0+1)];
                fy += gout7y * dm[(j0+0)*nao+(k0+1)];
                fz += gout7z * dm[(j0+0)*nao+(k0+1)];
                fx += gout8x * dm[(j0+0)*nao+(k0+2)];
                fy += gout8y * dm[(j0+0)*nao+(k0+2)];
                fz += gout8z * dm[(j0+0)*nao+(k0+2)];
                fx += gout9x * dm[(j0+0)*nao+(k0+3)];
                fy += gout9y * dm[(j0+0)*nao+(k0+3)];
                fz += gout9z * dm[(j0+0)*nao+(k0+3)];
                fx += gout10x * dm[(j0+0)*nao+(k0+4)];
                fy += gout10y * dm[(j0+0)*nao+(k0+4)];
                fz += gout10z * dm[(j0+0)*nao+(k0+4)];
                fx += gout11x * dm[(j0+0)*nao+(k0+5)];
                fy += gout11y * dm[(j0+0)*nao+(k0+5)];
                fz += gout11z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+4), fz);
                fx = gout12x * dm[(j0+0)*nao+(k0+0)];
                fy = gout12y * dm[(j0+0)*nao+(k0+0)];
                fz = gout12z * dm[(j0+0)*nao+(k0+0)];
                fx += gout13x * dm[(j0+0)*nao+(k0+1)];
                fy += gout13y * dm[(j0+0)*nao+(k0+1)];
                fz += gout13z * dm[(j0+0)*nao+(k0+1)];
                fx += gout14x * dm[(j0+0)*nao+(k0+2)];
                fy += gout14y * dm[(j0+0)*nao+(k0+2)];
                fz += gout14z * dm[(j0+0)*nao+(k0+2)];
                fx += gout15x * dm[(j0+0)*nao+(k0+3)];
                fy += gout15y * dm[(j0+0)*nao+(k0+3)];
                fz += gout15z * dm[(j0+0)*nao+(k0+3)];
                fx += gout16x * dm[(j0+0)*nao+(k0+4)];
                fy += gout16y * dm[(j0+0)*nao+(k0+4)];
                fz += gout16z * dm[(j0+0)*nao+(k0+4)];
                fx += gout17x * dm[(j0+0)*nao+(k0+5)];
                fy += gout17y * dm[(j0+0)*nao+(k0+5)];
                fz += gout17z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+0)*nao+(k0+1)];
                fy += gout1y * dm[(i0+0)*nao+(k0+1)];
                fz += gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout2x * dm[(i0+0)*nao+(k0+2)];
                fy += gout2y * dm[(i0+0)*nao+(k0+2)];
                fz += gout2z * dm[(i0+0)*nao+(k0+2)];
                fx += gout3x * dm[(i0+0)*nao+(k0+3)];
                fy += gout3y * dm[(i0+0)*nao+(k0+3)];
                fz += gout3z * dm[(i0+0)*nao+(k0+3)];
                fx += gout4x * dm[(i0+0)*nao+(k0+4)];
                fy += gout4y * dm[(i0+0)*nao+(k0+4)];
                fz += gout4z * dm[(i0+0)*nao+(k0+4)];
                fx += gout5x * dm[(i0+0)*nao+(k0+5)];
                fy += gout5y * dm[(i0+0)*nao+(k0+5)];
                fz += gout5z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+3), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+0)];
                fy = gout6y * dm[(i0+0)*nao+(k0+0)];
                fz = gout6z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+0)*nao+(k0+1)];
                fy += gout7y * dm[(i0+0)*nao+(k0+1)];
                fz += gout7z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+0)*nao+(k0+2)];
                fy += gout8y * dm[(i0+0)*nao+(k0+2)];
                fz += gout8z * dm[(i0+0)*nao+(k0+2)];
                fx += gout9x * dm[(i0+0)*nao+(k0+3)];
                fy += gout9y * dm[(i0+0)*nao+(k0+3)];
                fz += gout9z * dm[(i0+0)*nao+(k0+3)];
                fx += gout10x * dm[(i0+0)*nao+(k0+4)];
                fy += gout10y * dm[(i0+0)*nao+(k0+4)];
                fz += gout10z * dm[(i0+0)*nao+(k0+4)];
                fx += gout11x * dm[(i0+0)*nao+(k0+5)];
                fy += gout11y * dm[(i0+0)*nao+(k0+5)];
                fz += gout11z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+4), fz);
                fx = gout12x * dm[(i0+0)*nao+(k0+0)];
                fy = gout12y * dm[(i0+0)*nao+(k0+0)];
                fz = gout12z * dm[(i0+0)*nao+(k0+0)];
                fx += gout13x * dm[(i0+0)*nao+(k0+1)];
                fy += gout13y * dm[(i0+0)*nao+(k0+1)];
                fz += gout13z * dm[(i0+0)*nao+(k0+1)];
                fx += gout14x * dm[(i0+0)*nao+(k0+2)];
                fy += gout14y * dm[(i0+0)*nao+(k0+2)];
                fz += gout14z * dm[(i0+0)*nao+(k0+2)];
                fx += gout15x * dm[(i0+0)*nao+(k0+3)];
                fy += gout15y * dm[(i0+0)*nao+(k0+3)];
                fz += gout15z * dm[(i0+0)*nao+(k0+3)];
                fx += gout16x * dm[(i0+0)*nao+(k0+4)];
                fy += gout16y * dm[(i0+0)*nao+(k0+4)];
                fz += gout16z * dm[(i0+0)*nao+(k0+4)];
                fx += gout17x * dm[(i0+0)*nao+(k0+5)];
                fy += gout17y * dm[(i0+0)*nao+(k0+5)];
                fz += gout17z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+3)];
                fy = gout0y * dm[(j0+0)*nao+(l0+3)];
                fz = gout0z * dm[(j0+0)*nao+(l0+3)];
                fx += gout6x * dm[(j0+0)*nao+(l0+4)];
                fy += gout6y * dm[(j0+0)*nao+(l0+4)];
                fz += gout6z * dm[(j0+0)*nao+(l0+4)];
                fx += gout12x * dm[(j0+0)*nao+(l0+5)];
                fy += gout12y * dm[(j0+0)*nao+(l0+5)];
                fz += gout12z * dm[(j0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+3)];
                fy = gout1y * dm[(j0+0)*nao+(l0+3)];
                fz = gout1z * dm[(j0+0)*nao+(l0+3)];
                fx += gout7x * dm[(j0+0)*nao+(l0+4)];
                fy += gout7y * dm[(j0+0)*nao+(l0+4)];
                fz += gout7z * dm[(j0+0)*nao+(l0+4)];
                fx += gout13x * dm[(j0+0)*nao+(l0+5)];
                fy += gout13y * dm[(j0+0)*nao+(l0+5)];
                fz += gout13z * dm[(j0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+3)];
                fy = gout2y * dm[(j0+0)*nao+(l0+3)];
                fz = gout2z * dm[(j0+0)*nao+(l0+3)];
                fx += gout8x * dm[(j0+0)*nao+(l0+4)];
                fy += gout8y * dm[(j0+0)*nao+(l0+4)];
                fz += gout8z * dm[(j0+0)*nao+(l0+4)];
                fx += gout14x * dm[(j0+0)*nao+(l0+5)];
                fy += gout14y * dm[(j0+0)*nao+(l0+5)];
                fz += gout14z * dm[(j0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+3)];
                fy = gout3y * dm[(j0+0)*nao+(l0+3)];
                fz = gout3z * dm[(j0+0)*nao+(l0+3)];
                fx += gout9x * dm[(j0+0)*nao+(l0+4)];
                fy += gout9y * dm[(j0+0)*nao+(l0+4)];
                fz += gout9z * dm[(j0+0)*nao+(l0+4)];
                fx += gout15x * dm[(j0+0)*nao+(l0+5)];
                fy += gout15y * dm[(j0+0)*nao+(l0+5)];
                fz += gout15z * dm[(j0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+3)];
                fy = gout4y * dm[(j0+0)*nao+(l0+3)];
                fz = gout4z * dm[(j0+0)*nao+(l0+3)];
                fx += gout10x * dm[(j0+0)*nao+(l0+4)];
                fy += gout10y * dm[(j0+0)*nao+(l0+4)];
                fz += gout10z * dm[(j0+0)*nao+(l0+4)];
                fx += gout16x * dm[(j0+0)*nao+(l0+5)];
                fy += gout16y * dm[(j0+0)*nao+(l0+5)];
                fz += gout16z * dm[(j0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+3)];
                fy = gout5y * dm[(j0+0)*nao+(l0+3)];
                fz = gout5z * dm[(j0+0)*nao+(l0+3)];
                fx += gout11x * dm[(j0+0)*nao+(l0+4)];
                fy += gout11y * dm[(j0+0)*nao+(l0+4)];
                fz += gout11z * dm[(j0+0)*nao+(l0+4)];
                fx += gout17x * dm[(j0+0)*nao+(l0+5)];
                fy += gout17y * dm[(j0+0)*nao+(l0+5)];
                fz += gout17z * dm[(j0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+3)];
                fy = gout0y * dm[(i0+0)*nao+(l0+3)];
                fz = gout0z * dm[(i0+0)*nao+(l0+3)];
                fx += gout6x * dm[(i0+0)*nao+(l0+4)];
                fy += gout6y * dm[(i0+0)*nao+(l0+4)];
                fz += gout6z * dm[(i0+0)*nao+(l0+4)];
                fx += gout12x * dm[(i0+0)*nao+(l0+5)];
                fy += gout12y * dm[(i0+0)*nao+(l0+5)];
                fz += gout12z * dm[(i0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+3)];
                fy = gout1y * dm[(i0+0)*nao+(l0+3)];
                fz = gout1z * dm[(i0+0)*nao+(l0+3)];
                fx += gout7x * dm[(i0+0)*nao+(l0+4)];
                fy += gout7y * dm[(i0+0)*nao+(l0+4)];
                fz += gout7z * dm[(i0+0)*nao+(l0+4)];
                fx += gout13x * dm[(i0+0)*nao+(l0+5)];
                fy += gout13y * dm[(i0+0)*nao+(l0+5)];
                fz += gout13z * dm[(i0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+3)];
                fy = gout2y * dm[(i0+0)*nao+(l0+3)];
                fz = gout2z * dm[(i0+0)*nao+(l0+3)];
                fx += gout8x * dm[(i0+0)*nao+(l0+4)];
                fy += gout8y * dm[(i0+0)*nao+(l0+4)];
                fz += gout8z * dm[(i0+0)*nao+(l0+4)];
                fx += gout14x * dm[(i0+0)*nao+(l0+5)];
                fy += gout14y * dm[(i0+0)*nao+(l0+5)];
                fz += gout14z * dm[(i0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+3)];
                fy = gout3y * dm[(i0+0)*nao+(l0+3)];
                fz = gout3z * dm[(i0+0)*nao+(l0+3)];
                fx += gout9x * dm[(i0+0)*nao+(l0+4)];
                fy += gout9y * dm[(i0+0)*nao+(l0+4)];
                fz += gout9z * dm[(i0+0)*nao+(l0+4)];
                fx += gout15x * dm[(i0+0)*nao+(l0+5)];
                fy += gout15y * dm[(i0+0)*nao+(l0+5)];
                fz += gout15z * dm[(i0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+3)];
                fy = gout4y * dm[(i0+0)*nao+(l0+3)];
                fz = gout4z * dm[(i0+0)*nao+(l0+3)];
                fx += gout10x * dm[(i0+0)*nao+(l0+4)];
                fy += gout10y * dm[(i0+0)*nao+(l0+4)];
                fz += gout10z * dm[(i0+0)*nao+(l0+4)];
                fx += gout16x * dm[(i0+0)*nao+(l0+5)];
                fy += gout16y * dm[(i0+0)*nao+(l0+5)];
                fz += gout16z * dm[(i0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+3)];
                fy = gout5y * dm[(i0+0)*nao+(l0+3)];
                fz = gout5z * dm[(i0+0)*nao+(l0+3)];
                fx += gout11x * dm[(i0+0)*nao+(l0+4)];
                fy += gout11y * dm[(i0+0)*nao+(l0+4)];
                fz += gout11z * dm[(i0+0)*nao+(l0+4)];
                fx += gout17x * dm[(i0+0)*nao+(l0+5)];
                fy += gout17y * dm[(i0+0)*nao+(l0+5)];
                fz += gout17z * dm[(i0+0)*nao+(l0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0022(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0022(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0100(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    ai2 = rjri[5];
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double hrr_1100x = trr_20x - rjri[0] * trr_10x;
                    fx = ai2 * hrr_1100x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double hrr_0100x = trr_10x - rjri[0] * 1;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_0100x *  fy  * wt;
                    gout0z += hrr_0100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    double hrr_1100y = trr_20y - rjri[1] * trr_10y;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_10z;
                    double hrr_0100y = trr_10y - rjri[1] * 1;
                    gout1x +=  fx  * hrr_0100y * wt;
                    gout1y += 1 *  fy  * wt;
                    gout1z += 1 * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    double hrr_1100z = trr_20z - rjri[2] * trr_10z;
                    fz = ai2 * hrr_1100z;
                    double hrr_0100z = trr_10z - rjri[2] * wt;
                    gout2x +=  fx  * 1 * hrr_0100z;
                    gout2y += 1 *  fy  * hrr_0100z;
                    gout2z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+1)*nao+(i0+0)];
                fy += gout1y * dm[(j0+1)*nao+(i0+0)];
                fz += gout1z * dm[(j0+1)*nao+(i0+0)];
                fx += gout2x * dm[(j0+2)*nao+(i0+0)];
                fy += gout2y * dm[(j0+2)*nao+(i0+0)];
                fz += gout2z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout1x * dm[(j0+1)*nao+(k0+0)];
                fy += gout1y * dm[(j0+1)*nao+(k0+0)];
                fz += gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout2x * dm[(j0+2)*nao+(k0+0)];
                fy += gout2y * dm[(j0+2)*nao+(k0+0)];
                fz += gout2z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+0)];
                fy = gout2y * dm[(i0+0)*nao+(k0+0)];
                fz = gout2z * dm[(i0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout1x * dm[(j0+1)*nao+(l0+0)];
                fy += gout1y * dm[(j0+1)*nao+(l0+0)];
                fz += gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout2x * dm[(j0+2)*nao+(l0+0)];
                fy += gout2y * dm[(j0+2)*nao+(l0+0)];
                fz += gout2z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
            }
        }
    }
}
#if CUDA_VERSION >= 12040
__global__ __maxnreg__(128)
#else
__global__
#endif
static void rys_vjk_ip1_0100(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0100(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0110(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_21x = cpx * trr_20x + 2*b00 * trr_10x;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double hrr_1110x = trr_21x - rjri[0] * trr_11x;
                    fx = ai2 * hrr_1110x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_01x = cpx * 1;
                    double hrr_0110x = trr_11x - rjri[0] * trr_01x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_0110x *  fy  * wt;
                    gout0z += hrr_0110x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    double hrr_1100y = trr_20y - rjri[1] * trr_10y;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_10z;
                    double hrr_0100y = trr_10y - rjri[1] * 1;
                    gout1x +=  fx  * hrr_0100y * wt;
                    gout1y += trr_01x *  fy  * wt;
                    gout1z += trr_01x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    double hrr_1100z = trr_20z - rjri[2] * trr_10z;
                    fz = ai2 * hrr_1100z;
                    double hrr_0100z = trr_10z - rjri[2] * wt;
                    gout2x +=  fx  * 1 * hrr_0100z;
                    gout2y += trr_01x *  fy  * hrr_0100z;
                    gout2z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_1100x = trr_20x - rjri[0] * trr_10x;
                    fx = ai2 * hrr_1100x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    double hrr_0100x = trr_10x - rjri[0] * 1;
                    double trr_01y = cpy * 1;
                    gout3x +=  fx  * trr_01y * wt;
                    gout3y += hrr_0100x *  fy  * wt;
                    gout3z += hrr_0100x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_21y = cpy * trr_20y + 2*b00 * trr_10y;
                    double hrr_1110y = trr_21y - rjri[1] * trr_11y;
                    fy = ai2 * hrr_1110y;
                    fz = ai2 * trr_10z;
                    double hrr_0110y = trr_11y - rjri[1] * trr_01y;
                    gout4x +=  fx  * hrr_0110y * wt;
                    gout4y += 1 *  fy  * wt;
                    gout4z += 1 * hrr_0110y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1100z;
                    gout5x +=  fx  * trr_01y * hrr_0100z;
                    gout5y += 1 *  fy  * hrr_0100z;
                    gout5z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    double trr_01z = cpz * wt;
                    gout6x +=  fx  * 1 * trr_01z;
                    gout6y += hrr_0100x *  fy  * trr_01z;
                    gout6z += hrr_0100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_11z;
                    gout7x +=  fx  * hrr_0100y * trr_01z;
                    gout7y += 1 *  fy  * trr_01z;
                    gout7z += 1 * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_21z = cpz * trr_20z + 2*b00 * trr_10z;
                    double hrr_1110z = trr_21z - rjri[2] * trr_11z;
                    fz = ai2 * hrr_1110z;
                    double hrr_0110z = trr_11z - rjri[2] * trr_01z;
                    gout8x +=  fx  * 1 * hrr_0110z;
                    gout8y += 1 *  fy  * hrr_0110z;
                    gout8z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+1)];
                fy += gout3y * dm[(l0+0)*nao+(k0+1)];
                fz += gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout6x * dm[(l0+0)*nao+(k0+2)];
                fy += gout6y * dm[(l0+0)*nao+(k0+2)];
                fz += gout6z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+1)];
                fy += gout4y * dm[(l0+0)*nao+(k0+1)];
                fz += gout4z * dm[(l0+0)*nao+(k0+1)];
                fx += gout7x * dm[(l0+0)*nao+(k0+2)];
                fy += gout7y * dm[(l0+0)*nao+(k0+2)];
                fz += gout7z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout5x * dm[(l0+0)*nao+(k0+1)];
                fy += gout5y * dm[(l0+0)*nao+(k0+1)];
                fz += gout5z * dm[(l0+0)*nao+(k0+1)];
                fx += gout8x * dm[(l0+0)*nao+(k0+2)];
                fy += gout8y * dm[(l0+0)*nao+(k0+2)];
                fz += gout8z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+1)*nao+(i0+0)];
                fy += gout1y * dm[(j0+1)*nao+(i0+0)];
                fz += gout1z * dm[(j0+1)*nao+(i0+0)];
                fx += gout2x * dm[(j0+2)*nao+(i0+0)];
                fy += gout2y * dm[(j0+2)*nao+(i0+0)];
                fz += gout2z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                fx += gout4x * dm[(j0+1)*nao+(i0+0)];
                fy += gout4y * dm[(j0+1)*nao+(i0+0)];
                fz += gout4z * dm[(j0+1)*nao+(i0+0)];
                fx += gout5x * dm[(j0+2)*nao+(i0+0)];
                fy += gout5y * dm[(j0+2)*nao+(i0+0)];
                fz += gout5z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+1)*nao+(i0+0)];
                fy += gout7y * dm[(j0+1)*nao+(i0+0)];
                fz += gout7z * dm[(j0+1)*nao+(i0+0)];
                fx += gout8x * dm[(j0+2)*nao+(i0+0)];
                fy += gout8y * dm[(j0+2)*nao+(i0+0)];
                fz += gout8z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+1)];
                fy += gout3y * dm[(j0+0)*nao+(k0+1)];
                fz += gout3z * dm[(j0+0)*nao+(k0+1)];
                fx += gout6x * dm[(j0+0)*nao+(k0+2)];
                fy += gout6y * dm[(j0+0)*nao+(k0+2)];
                fz += gout6z * dm[(j0+0)*nao+(k0+2)];
                fx += gout1x * dm[(j0+1)*nao+(k0+0)];
                fy += gout1y * dm[(j0+1)*nao+(k0+0)];
                fz += gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout4x * dm[(j0+1)*nao+(k0+1)];
                fy += gout4y * dm[(j0+1)*nao+(k0+1)];
                fz += gout4z * dm[(j0+1)*nao+(k0+1)];
                fx += gout7x * dm[(j0+1)*nao+(k0+2)];
                fy += gout7y * dm[(j0+1)*nao+(k0+2)];
                fz += gout7z * dm[(j0+1)*nao+(k0+2)];
                fx += gout2x * dm[(j0+2)*nao+(k0+0)];
                fy += gout2y * dm[(j0+2)*nao+(k0+0)];
                fz += gout2z * dm[(j0+2)*nao+(k0+0)];
                fx += gout5x * dm[(j0+2)*nao+(k0+1)];
                fy += gout5y * dm[(j0+2)*nao+(k0+1)];
                fz += gout5z * dm[(j0+2)*nao+(k0+1)];
                fx += gout8x * dm[(j0+2)*nao+(k0+2)];
                fy += gout8y * dm[(j0+2)*nao+(k0+2)];
                fz += gout8z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+1)];
                fy += gout3y * dm[(i0+0)*nao+(k0+1)];
                fz += gout3z * dm[(i0+0)*nao+(k0+1)];
                fx += gout6x * dm[(i0+0)*nao+(k0+2)];
                fy += gout6y * dm[(i0+0)*nao+(k0+2)];
                fz += gout6z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout4x * dm[(i0+0)*nao+(k0+1)];
                fy += gout4y * dm[(i0+0)*nao+(k0+1)];
                fz += gout4z * dm[(i0+0)*nao+(k0+1)];
                fx += gout7x * dm[(i0+0)*nao+(k0+2)];
                fy += gout7y * dm[(i0+0)*nao+(k0+2)];
                fz += gout7z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+0)];
                fy = gout2y * dm[(i0+0)*nao+(k0+0)];
                fz = gout2z * dm[(i0+0)*nao+(k0+0)];
                fx += gout5x * dm[(i0+0)*nao+(k0+1)];
                fy += gout5y * dm[(i0+0)*nao+(k0+1)];
                fz += gout5z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+0)*nao+(k0+2)];
                fy += gout8y * dm[(i0+0)*nao+(k0+2)];
                fz += gout8z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout1x * dm[(j0+1)*nao+(l0+0)];
                fy += gout1y * dm[(j0+1)*nao+(l0+0)];
                fz += gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout2x * dm[(j0+2)*nao+(l0+0)];
                fy += gout2y * dm[(j0+2)*nao+(l0+0)];
                fz += gout2z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout4x * dm[(j0+1)*nao+(l0+0)];
                fy += gout4y * dm[(j0+1)*nao+(l0+0)];
                fz += gout4z * dm[(j0+1)*nao+(l0+0)];
                fx += gout5x * dm[(j0+2)*nao+(l0+0)];
                fy += gout5y * dm[(j0+2)*nao+(l0+0)];
                fz += gout5z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                fx += gout7x * dm[(j0+1)*nao+(l0+0)];
                fy += gout7y * dm[(j0+1)*nao+(l0+0)];
                fz += gout7z * dm[(j0+1)*nao+(l0+0)];
                fx += gout8x * dm[(j0+2)*nao+(l0+0)];
                fy += gout8y * dm[(j0+2)*nao+(l0+0)];
                fz += gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+0)];
                fy = gout8y * dm[(i0+0)*nao+(l0+0)];
                fz = gout8z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0110(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0110(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0111(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double gout18x, gout18y, gout18z;
    double gout19x, gout19y, gout19z;
    double gout20x, gout20y, gout20z;
    double gout21x, gout21y, gout21z;
    double gout22x, gout22y, gout22z;
    double gout23x, gout23y, gout23z;
    double gout24x, gout24y, gout24z;
    double gout25x, gout25y, gout25z;
    double gout26x, gout26y, gout26z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        gout18x = 0;
        gout18y = 0;
        gout18z = 0;
        gout19x = 0;
        gout19y = 0;
        gout19z = 0;
        gout20x = 0;
        gout20y = 0;
        gout20z = 0;
        gout21x = 0;
        gout21y = 0;
        gout21z = 0;
        gout22x = 0;
        gout22y = 0;
        gout22z = 0;
        gout23x = 0;
        gout23y = 0;
        gout23z = 0;
        gout24x = 0;
        gout24y = 0;
        gout24z = 0;
        gout25x = 0;
        gout25y = 0;
        gout25z = 0;
        gout26x = 0;
        gout26y = 0;
        gout26z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double b01 = .5/akl * (1 - rt_akl);
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_21x = cpx * trr_20x + 2*b00 * trr_10x;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double trr_22x = cpx * trr_21x + 1*b01 * trr_20x + 2*b00 * trr_11x;
                    double hrr_2011x = trr_22x - (rl[0] - rk[0]) * trr_21x;
                    double trr_01x = cpx * 1;
                    double trr_12x = cpx * trr_11x + 1*b01 * trr_10x + 1*b00 * trr_01x;
                    double hrr_1011x = trr_12x - (rl[0] - rk[0]) * trr_11x;
                    double hrr_1111x = hrr_2011x - rjri[0] * hrr_1011x;
                    fx = ai2 * hrr_1111x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_02x = cpx * trr_01x + 1*b01 * 1;
                    double hrr_0011x = trr_02x - (rl[0] - rk[0]) * trr_01x;
                    double hrr_0111x = hrr_1011x - rjri[0] * hrr_0011x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_0111x *  fy  * wt;
                    gout0z += hrr_0111x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1011x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    double hrr_1100y = trr_20y - rjri[1] * trr_10y;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_10z;
                    double hrr_0100y = trr_10y - rjri[1] * 1;
                    gout1x +=  fx  * hrr_0100y * wt;
                    gout1y += hrr_0011x *  fy  * wt;
                    gout1z += hrr_0011x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1011x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    double hrr_1100z = trr_20z - rjri[2] * trr_10z;
                    fz = ai2 * hrr_1100z;
                    double hrr_0100z = trr_10z - rjri[2] * wt;
                    gout2x +=  fx  * 1 * hrr_0100z;
                    gout2y += hrr_0011x *  fy  * hrr_0100z;
                    gout2z += hrr_0011x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_2001x = trr_21x - (rl[0] - rk[0]) * trr_20x;
                    double hrr_1001x = trr_11x - (rl[0] - rk[0]) * trr_10x;
                    double hrr_1101x = hrr_2001x - rjri[0] * hrr_1001x;
                    fx = ai2 * hrr_1101x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    double hrr_0001x = trr_01x - (rl[0] - rk[0]) * 1;
                    double hrr_0101x = hrr_1001x - rjri[0] * hrr_0001x;
                    double trr_01y = cpy * 1;
                    gout3x +=  fx  * trr_01y * wt;
                    gout3y += hrr_0101x *  fy  * wt;
                    gout3z += hrr_0101x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    double trr_21y = cpy * trr_20y + 2*b00 * trr_10y;
                    double hrr_1110y = trr_21y - rjri[1] * trr_11y;
                    fy = ai2 * hrr_1110y;
                    fz = ai2 * trr_10z;
                    double hrr_0110y = trr_11y - rjri[1] * trr_01y;
                    gout4x +=  fx  * hrr_0110y * wt;
                    gout4y += hrr_0001x *  fy  * wt;
                    gout4z += hrr_0001x * hrr_0110y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1100z;
                    gout5x +=  fx  * trr_01y * hrr_0100z;
                    gout5y += hrr_0001x *  fy  * hrr_0100z;
                    gout5z += hrr_0001x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1101x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    double trr_01z = cpz * wt;
                    gout6x +=  fx  * 1 * trr_01z;
                    gout6y += hrr_0101x *  fy  * trr_01z;
                    gout6z += hrr_0101x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_11z;
                    gout7x +=  fx  * hrr_0100y * trr_01z;
                    gout7y += hrr_0001x *  fy  * trr_01z;
                    gout7z += hrr_0001x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * trr_10y;
                    double trr_21z = cpz * trr_20z + 2*b00 * trr_10z;
                    double hrr_1110z = trr_21z - rjri[2] * trr_11z;
                    fz = ai2 * hrr_1110z;
                    double hrr_0110z = trr_11z - rjri[2] * trr_01z;
                    gout8x +=  fx  * 1 * hrr_0110z;
                    gout8y += hrr_0001x *  fy  * hrr_0110z;
                    gout8z += hrr_0001x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_1110x = trr_21x - rjri[0] * trr_11x;
                    fx = ai2 * hrr_1110x;
                    double hrr_1001y = trr_11y - (rl[1] - rk[1]) * trr_10y;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_10z;
                    double hrr_0110x = trr_11x - rjri[0] * trr_01x;
                    double hrr_0001y = trr_01y - (rl[1] - rk[1]) * 1;
                    gout9x +=  fx  * hrr_0001y * wt;
                    gout9y += hrr_0110x *  fy  * wt;
                    gout9z += hrr_0110x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double hrr_2001y = trr_21y - (rl[1] - rk[1]) * trr_20y;
                    double hrr_1101y = hrr_2001y - rjri[1] * hrr_1001y;
                    fy = ai2 * hrr_1101y;
                    fz = ai2 * trr_10z;
                    double hrr_0101y = hrr_1001y - rjri[1] * hrr_0001y;
                    gout10x +=  fx  * hrr_0101y * wt;
                    gout10y += trr_01x *  fy  * wt;
                    gout10z += trr_01x * hrr_0101y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * hrr_1100z;
                    gout11x +=  fx  * hrr_0001y * hrr_0100z;
                    gout11y += trr_01x *  fy  * hrr_0100z;
                    gout11z += trr_01x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    double hrr_1100x = trr_20x - rjri[0] * trr_10x;
                    fx = ai2 * hrr_1100x;
                    double trr_12y = cpy * trr_11y + 1*b01 * trr_10y + 1*b00 * trr_01y;
                    double hrr_1011y = trr_12y - (rl[1] - rk[1]) * trr_11y;
                    fy = ai2 * hrr_1011y;
                    fz = ai2 * trr_10z;
                    double hrr_0100x = trr_10x - rjri[0] * 1;
                    double trr_02y = cpy * trr_01y + 1*b01 * 1;
                    double hrr_0011y = trr_02y - (rl[1] - rk[1]) * trr_01y;
                    gout12x +=  fx  * hrr_0011y * wt;
                    gout12y += hrr_0100x *  fy  * wt;
                    gout12z += hrr_0100x * hrr_0011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_22y = cpy * trr_21y + 1*b01 * trr_20y + 2*b00 * trr_11y;
                    double hrr_2011y = trr_22y - (rl[1] - rk[1]) * trr_21y;
                    double hrr_1111y = hrr_2011y - rjri[1] * hrr_1011y;
                    fy = ai2 * hrr_1111y;
                    fz = ai2 * trr_10z;
                    double hrr_0111y = hrr_1011y - rjri[1] * hrr_0011y;
                    gout13x +=  fx  * hrr_0111y * wt;
                    gout13y += 1 *  fy  * wt;
                    gout13z += 1 * hrr_0111y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1011y;
                    fz = ai2 * hrr_1100z;
                    gout14x +=  fx  * hrr_0011y * hrr_0100z;
                    gout14y += 1 *  fy  * hrr_0100z;
                    gout14z += 1 * hrr_0011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_11z;
                    gout15x +=  fx  * hrr_0001y * trr_01z;
                    gout15y += hrr_0100x *  fy  * trr_01z;
                    gout15z += hrr_0100x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1101y;
                    fz = ai2 * trr_11z;
                    gout16x +=  fx  * hrr_0101y * trr_01z;
                    gout16y += 1 *  fy  * trr_01z;
                    gout16z += 1 * hrr_0101y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * hrr_1110z;
                    gout17x +=  fx  * hrr_0001y * hrr_0110z;
                    gout17y += 1 *  fy  * hrr_0110z;
                    gout17z += 1 * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1110x;
                    fy = ai2 * trr_10y;
                    double hrr_1001z = trr_11z - (rl[2] - rk[2]) * trr_10z;
                    fz = ai2 * hrr_1001z;
                    double hrr_0001z = trr_01z - (rl[2] - rk[2]) * wt;
                    gout18x +=  fx  * 1 * hrr_0001z;
                    gout18y += hrr_0110x *  fy  * hrr_0001z;
                    gout18z += hrr_0110x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * hrr_1001z;
                    gout19x +=  fx  * hrr_0100y * hrr_0001z;
                    gout19y += trr_01x *  fy  * hrr_0001z;
                    gout19z += trr_01x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double hrr_2001z = trr_21z - (rl[2] - rk[2]) * trr_20z;
                    double hrr_1101z = hrr_2001z - rjri[2] * hrr_1001z;
                    fz = ai2 * hrr_1101z;
                    double hrr_0101z = hrr_1001z - rjri[2] * hrr_0001z;
                    gout20x +=  fx  * 1 * hrr_0101z;
                    gout20y += trr_01x *  fy  * hrr_0101z;
                    gout20z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1001z;
                    gout21x +=  fx  * trr_01y * hrr_0001z;
                    gout21y += hrr_0100x *  fy  * hrr_0001z;
                    gout21z += hrr_0100x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1110y;
                    fz = ai2 * hrr_1001z;
                    gout22x +=  fx  * hrr_0110y * hrr_0001z;
                    gout22y += 1 *  fy  * hrr_0001z;
                    gout22z += 1 * hrr_0110y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1101z;
                    gout23x +=  fx  * trr_01y * hrr_0101z;
                    gout23y += 1 *  fy  * hrr_0101z;
                    gout23z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_10y;
                    double trr_12z = cpz * trr_11z + 1*b01 * trr_10z + 1*b00 * trr_01z;
                    double hrr_1011z = trr_12z - (rl[2] - rk[2]) * trr_11z;
                    fz = ai2 * hrr_1011z;
                    double trr_02z = cpz * trr_01z + 1*b01 * wt;
                    double hrr_0011z = trr_02z - (rl[2] - rk[2]) * trr_01z;
                    gout24x +=  fx  * 1 * hrr_0011z;
                    gout24y += hrr_0100x *  fy  * hrr_0011z;
                    gout24z += hrr_0100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * hrr_1011z;
                    gout25x +=  fx  * hrr_0100y * hrr_0011z;
                    gout25y += 1 *  fy  * hrr_0011z;
                    gout25z += 1 * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_22z = cpz * trr_21z + 1*b01 * trr_20z + 2*b00 * trr_11z;
                    double hrr_2011z = trr_22z - (rl[2] - rk[2]) * trr_21z;
                    double hrr_1111z = hrr_2011z - rjri[2] * hrr_1011z;
                    fz = ai2 * hrr_1111z;
                    double hrr_0111z = hrr_1011z - rjri[2] * hrr_0011z;
                    gout26x +=  fx  * 1 * hrr_0111z;
                    gout26y += 1 *  fy  * hrr_0111z;
                    gout26z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+1)];
                fy += gout3y * dm[(l0+0)*nao+(k0+1)];
                fz += gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout6x * dm[(l0+0)*nao+(k0+2)];
                fy += gout6y * dm[(l0+0)*nao+(k0+2)];
                fz += gout6z * dm[(l0+0)*nao+(k0+2)];
                fx += gout9x * dm[(l0+1)*nao+(k0+0)];
                fy += gout9y * dm[(l0+1)*nao+(k0+0)];
                fz += gout9z * dm[(l0+1)*nao+(k0+0)];
                fx += gout12x * dm[(l0+1)*nao+(k0+1)];
                fy += gout12y * dm[(l0+1)*nao+(k0+1)];
                fz += gout12z * dm[(l0+1)*nao+(k0+1)];
                fx += gout15x * dm[(l0+1)*nao+(k0+2)];
                fy += gout15y * dm[(l0+1)*nao+(k0+2)];
                fz += gout15z * dm[(l0+1)*nao+(k0+2)];
                fx += gout18x * dm[(l0+2)*nao+(k0+0)];
                fy += gout18y * dm[(l0+2)*nao+(k0+0)];
                fz += gout18z * dm[(l0+2)*nao+(k0+0)];
                fx += gout21x * dm[(l0+2)*nao+(k0+1)];
                fy += gout21y * dm[(l0+2)*nao+(k0+1)];
                fz += gout21z * dm[(l0+2)*nao+(k0+1)];
                fx += gout24x * dm[(l0+2)*nao+(k0+2)];
                fy += gout24y * dm[(l0+2)*nao+(k0+2)];
                fz += gout24z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+1)];
                fy += gout4y * dm[(l0+0)*nao+(k0+1)];
                fz += gout4z * dm[(l0+0)*nao+(k0+1)];
                fx += gout7x * dm[(l0+0)*nao+(k0+2)];
                fy += gout7y * dm[(l0+0)*nao+(k0+2)];
                fz += gout7z * dm[(l0+0)*nao+(k0+2)];
                fx += gout10x * dm[(l0+1)*nao+(k0+0)];
                fy += gout10y * dm[(l0+1)*nao+(k0+0)];
                fz += gout10z * dm[(l0+1)*nao+(k0+0)];
                fx += gout13x * dm[(l0+1)*nao+(k0+1)];
                fy += gout13y * dm[(l0+1)*nao+(k0+1)];
                fz += gout13z * dm[(l0+1)*nao+(k0+1)];
                fx += gout16x * dm[(l0+1)*nao+(k0+2)];
                fy += gout16y * dm[(l0+1)*nao+(k0+2)];
                fz += gout16z * dm[(l0+1)*nao+(k0+2)];
                fx += gout19x * dm[(l0+2)*nao+(k0+0)];
                fy += gout19y * dm[(l0+2)*nao+(k0+0)];
                fz += gout19z * dm[(l0+2)*nao+(k0+0)];
                fx += gout22x * dm[(l0+2)*nao+(k0+1)];
                fy += gout22y * dm[(l0+2)*nao+(k0+1)];
                fz += gout22z * dm[(l0+2)*nao+(k0+1)];
                fx += gout25x * dm[(l0+2)*nao+(k0+2)];
                fy += gout25y * dm[(l0+2)*nao+(k0+2)];
                fz += gout25z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout5x * dm[(l0+0)*nao+(k0+1)];
                fy += gout5y * dm[(l0+0)*nao+(k0+1)];
                fz += gout5z * dm[(l0+0)*nao+(k0+1)];
                fx += gout8x * dm[(l0+0)*nao+(k0+2)];
                fy += gout8y * dm[(l0+0)*nao+(k0+2)];
                fz += gout8z * dm[(l0+0)*nao+(k0+2)];
                fx += gout11x * dm[(l0+1)*nao+(k0+0)];
                fy += gout11y * dm[(l0+1)*nao+(k0+0)];
                fz += gout11z * dm[(l0+1)*nao+(k0+0)];
                fx += gout14x * dm[(l0+1)*nao+(k0+1)];
                fy += gout14y * dm[(l0+1)*nao+(k0+1)];
                fz += gout14z * dm[(l0+1)*nao+(k0+1)];
                fx += gout17x * dm[(l0+1)*nao+(k0+2)];
                fy += gout17y * dm[(l0+1)*nao+(k0+2)];
                fz += gout17z * dm[(l0+1)*nao+(k0+2)];
                fx += gout20x * dm[(l0+2)*nao+(k0+0)];
                fy += gout20y * dm[(l0+2)*nao+(k0+0)];
                fz += gout20z * dm[(l0+2)*nao+(k0+0)];
                fx += gout23x * dm[(l0+2)*nao+(k0+1)];
                fy += gout23y * dm[(l0+2)*nao+(k0+1)];
                fz += gout23z * dm[(l0+2)*nao+(k0+1)];
                fx += gout26x * dm[(l0+2)*nao+(k0+2)];
                fy += gout26y * dm[(l0+2)*nao+(k0+2)];
                fz += gout26z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+1)*nao+(i0+0)];
                fy += gout1y * dm[(j0+1)*nao+(i0+0)];
                fz += gout1z * dm[(j0+1)*nao+(i0+0)];
                fx += gout2x * dm[(j0+2)*nao+(i0+0)];
                fy += gout2y * dm[(j0+2)*nao+(i0+0)];
                fz += gout2z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                fx += gout4x * dm[(j0+1)*nao+(i0+0)];
                fy += gout4y * dm[(j0+1)*nao+(i0+0)];
                fz += gout4z * dm[(j0+1)*nao+(i0+0)];
                fx += gout5x * dm[(j0+2)*nao+(i0+0)];
                fy += gout5y * dm[(j0+2)*nao+(i0+0)];
                fz += gout5z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+1)*nao+(i0+0)];
                fy += gout7y * dm[(j0+1)*nao+(i0+0)];
                fz += gout7z * dm[(j0+1)*nao+(i0+0)];
                fx += gout8x * dm[(j0+2)*nao+(i0+0)];
                fy += gout8y * dm[(j0+2)*nao+(i0+0)];
                fz += gout8z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                fx += gout10x * dm[(j0+1)*nao+(i0+0)];
                fy += gout10y * dm[(j0+1)*nao+(i0+0)];
                fz += gout10z * dm[(j0+1)*nao+(i0+0)];
                fx += gout11x * dm[(j0+2)*nao+(i0+0)];
                fy += gout11y * dm[(j0+2)*nao+(i0+0)];
                fz += gout11z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                fx += gout13x * dm[(j0+1)*nao+(i0+0)];
                fy += gout13y * dm[(j0+1)*nao+(i0+0)];
                fz += gout13z * dm[(j0+1)*nao+(i0+0)];
                fx += gout14x * dm[(j0+2)*nao+(i0+0)];
                fy += gout14y * dm[(j0+2)*nao+(i0+0)];
                fz += gout14z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout15x * dm[(j0+0)*nao+(i0+0)];
                fy = gout15y * dm[(j0+0)*nao+(i0+0)];
                fz = gout15z * dm[(j0+0)*nao+(i0+0)];
                fx += gout16x * dm[(j0+1)*nao+(i0+0)];
                fy += gout16y * dm[(j0+1)*nao+(i0+0)];
                fz += gout16z * dm[(j0+1)*nao+(i0+0)];
                fx += gout17x * dm[(j0+2)*nao+(i0+0)];
                fy += gout17y * dm[(j0+2)*nao+(i0+0)];
                fz += gout17z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout18x * dm[(j0+0)*nao+(i0+0)];
                fy = gout18y * dm[(j0+0)*nao+(i0+0)];
                fz = gout18z * dm[(j0+0)*nao+(i0+0)];
                fx += gout19x * dm[(j0+1)*nao+(i0+0)];
                fy += gout19y * dm[(j0+1)*nao+(i0+0)];
                fz += gout19z * dm[(j0+1)*nao+(i0+0)];
                fx += gout20x * dm[(j0+2)*nao+(i0+0)];
                fy += gout20y * dm[(j0+2)*nao+(i0+0)];
                fz += gout20z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout21x * dm[(j0+0)*nao+(i0+0)];
                fy = gout21y * dm[(j0+0)*nao+(i0+0)];
                fz = gout21z * dm[(j0+0)*nao+(i0+0)];
                fx += gout22x * dm[(j0+1)*nao+(i0+0)];
                fy += gout22y * dm[(j0+1)*nao+(i0+0)];
                fz += gout22z * dm[(j0+1)*nao+(i0+0)];
                fx += gout23x * dm[(j0+2)*nao+(i0+0)];
                fy += gout23y * dm[(j0+2)*nao+(i0+0)];
                fz += gout23z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout24x * dm[(j0+0)*nao+(i0+0)];
                fy = gout24y * dm[(j0+0)*nao+(i0+0)];
                fz = gout24z * dm[(j0+0)*nao+(i0+0)];
                fx += gout25x * dm[(j0+1)*nao+(i0+0)];
                fy += gout25y * dm[(j0+1)*nao+(i0+0)];
                fz += gout25z * dm[(j0+1)*nao+(i0+0)];
                fx += gout26x * dm[(j0+2)*nao+(i0+0)];
                fy += gout26y * dm[(j0+2)*nao+(i0+0)];
                fz += gout26z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+1)];
                fy += gout3y * dm[(j0+0)*nao+(k0+1)];
                fz += gout3z * dm[(j0+0)*nao+(k0+1)];
                fx += gout6x * dm[(j0+0)*nao+(k0+2)];
                fy += gout6y * dm[(j0+0)*nao+(k0+2)];
                fz += gout6z * dm[(j0+0)*nao+(k0+2)];
                fx += gout1x * dm[(j0+1)*nao+(k0+0)];
                fy += gout1y * dm[(j0+1)*nao+(k0+0)];
                fz += gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout4x * dm[(j0+1)*nao+(k0+1)];
                fy += gout4y * dm[(j0+1)*nao+(k0+1)];
                fz += gout4z * dm[(j0+1)*nao+(k0+1)];
                fx += gout7x * dm[(j0+1)*nao+(k0+2)];
                fy += gout7y * dm[(j0+1)*nao+(k0+2)];
                fz += gout7z * dm[(j0+1)*nao+(k0+2)];
                fx += gout2x * dm[(j0+2)*nao+(k0+0)];
                fy += gout2y * dm[(j0+2)*nao+(k0+0)];
                fz += gout2z * dm[(j0+2)*nao+(k0+0)];
                fx += gout5x * dm[(j0+2)*nao+(k0+1)];
                fy += gout5y * dm[(j0+2)*nao+(k0+1)];
                fz += gout5z * dm[(j0+2)*nao+(k0+1)];
                fx += gout8x * dm[(j0+2)*nao+(k0+2)];
                fy += gout8y * dm[(j0+2)*nao+(k0+2)];
                fz += gout8z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+0)];
                fy = gout9y * dm[(j0+0)*nao+(k0+0)];
                fz = gout9z * dm[(j0+0)*nao+(k0+0)];
                fx += gout12x * dm[(j0+0)*nao+(k0+1)];
                fy += gout12y * dm[(j0+0)*nao+(k0+1)];
                fz += gout12z * dm[(j0+0)*nao+(k0+1)];
                fx += gout15x * dm[(j0+0)*nao+(k0+2)];
                fy += gout15y * dm[(j0+0)*nao+(k0+2)];
                fz += gout15z * dm[(j0+0)*nao+(k0+2)];
                fx += gout10x * dm[(j0+1)*nao+(k0+0)];
                fy += gout10y * dm[(j0+1)*nao+(k0+0)];
                fz += gout10z * dm[(j0+1)*nao+(k0+0)];
                fx += gout13x * dm[(j0+1)*nao+(k0+1)];
                fy += gout13y * dm[(j0+1)*nao+(k0+1)];
                fz += gout13z * dm[(j0+1)*nao+(k0+1)];
                fx += gout16x * dm[(j0+1)*nao+(k0+2)];
                fy += gout16y * dm[(j0+1)*nao+(k0+2)];
                fz += gout16z * dm[(j0+1)*nao+(k0+2)];
                fx += gout11x * dm[(j0+2)*nao+(k0+0)];
                fy += gout11y * dm[(j0+2)*nao+(k0+0)];
                fz += gout11z * dm[(j0+2)*nao+(k0+0)];
                fx += gout14x * dm[(j0+2)*nao+(k0+1)];
                fy += gout14y * dm[(j0+2)*nao+(k0+1)];
                fz += gout14z * dm[(j0+2)*nao+(k0+1)];
                fx += gout17x * dm[(j0+2)*nao+(k0+2)];
                fy += gout17y * dm[(j0+2)*nao+(k0+2)];
                fz += gout17z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout18x * dm[(j0+0)*nao+(k0+0)];
                fy = gout18y * dm[(j0+0)*nao+(k0+0)];
                fz = gout18z * dm[(j0+0)*nao+(k0+0)];
                fx += gout21x * dm[(j0+0)*nao+(k0+1)];
                fy += gout21y * dm[(j0+0)*nao+(k0+1)];
                fz += gout21z * dm[(j0+0)*nao+(k0+1)];
                fx += gout24x * dm[(j0+0)*nao+(k0+2)];
                fy += gout24y * dm[(j0+0)*nao+(k0+2)];
                fz += gout24z * dm[(j0+0)*nao+(k0+2)];
                fx += gout19x * dm[(j0+1)*nao+(k0+0)];
                fy += gout19y * dm[(j0+1)*nao+(k0+0)];
                fz += gout19z * dm[(j0+1)*nao+(k0+0)];
                fx += gout22x * dm[(j0+1)*nao+(k0+1)];
                fy += gout22y * dm[(j0+1)*nao+(k0+1)];
                fz += gout22z * dm[(j0+1)*nao+(k0+1)];
                fx += gout25x * dm[(j0+1)*nao+(k0+2)];
                fy += gout25y * dm[(j0+1)*nao+(k0+2)];
                fz += gout25z * dm[(j0+1)*nao+(k0+2)];
                fx += gout20x * dm[(j0+2)*nao+(k0+0)];
                fy += gout20y * dm[(j0+2)*nao+(k0+0)];
                fz += gout20z * dm[(j0+2)*nao+(k0+0)];
                fx += gout23x * dm[(j0+2)*nao+(k0+1)];
                fy += gout23y * dm[(j0+2)*nao+(k0+1)];
                fz += gout23z * dm[(j0+2)*nao+(k0+1)];
                fx += gout26x * dm[(j0+2)*nao+(k0+2)];
                fy += gout26y * dm[(j0+2)*nao+(k0+2)];
                fz += gout26z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+1)];
                fy += gout3y * dm[(i0+0)*nao+(k0+1)];
                fz += gout3z * dm[(i0+0)*nao+(k0+1)];
                fx += gout6x * dm[(i0+0)*nao+(k0+2)];
                fy += gout6y * dm[(i0+0)*nao+(k0+2)];
                fz += gout6z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+1)];
                fy += gout12y * dm[(i0+0)*nao+(k0+1)];
                fz += gout12z * dm[(i0+0)*nao+(k0+1)];
                fx += gout15x * dm[(i0+0)*nao+(k0+2)];
                fy += gout15y * dm[(i0+0)*nao+(k0+2)];
                fz += gout15z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout18x * dm[(i0+0)*nao+(k0+0)];
                fy = gout18y * dm[(i0+0)*nao+(k0+0)];
                fz = gout18z * dm[(i0+0)*nao+(k0+0)];
                fx += gout21x * dm[(i0+0)*nao+(k0+1)];
                fy += gout21y * dm[(i0+0)*nao+(k0+1)];
                fz += gout21z * dm[(i0+0)*nao+(k0+1)];
                fx += gout24x * dm[(i0+0)*nao+(k0+2)];
                fy += gout24y * dm[(i0+0)*nao+(k0+2)];
                fz += gout24z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout4x * dm[(i0+0)*nao+(k0+1)];
                fy += gout4y * dm[(i0+0)*nao+(k0+1)];
                fz += gout4z * dm[(i0+0)*nao+(k0+1)];
                fx += gout7x * dm[(i0+0)*nao+(k0+2)];
                fy += gout7y * dm[(i0+0)*nao+(k0+2)];
                fz += gout7z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+0)];
                fy = gout10y * dm[(i0+0)*nao+(k0+0)];
                fz = gout10z * dm[(i0+0)*nao+(k0+0)];
                fx += gout13x * dm[(i0+0)*nao+(k0+1)];
                fy += gout13y * dm[(i0+0)*nao+(k0+1)];
                fz += gout13z * dm[(i0+0)*nao+(k0+1)];
                fx += gout16x * dm[(i0+0)*nao+(k0+2)];
                fy += gout16y * dm[(i0+0)*nao+(k0+2)];
                fz += gout16z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+1), fz);
                fx = gout19x * dm[(i0+0)*nao+(k0+0)];
                fy = gout19y * dm[(i0+0)*nao+(k0+0)];
                fz = gout19z * dm[(i0+0)*nao+(k0+0)];
                fx += gout22x * dm[(i0+0)*nao+(k0+1)];
                fy += gout22y * dm[(i0+0)*nao+(k0+1)];
                fz += gout22z * dm[(i0+0)*nao+(k0+1)];
                fx += gout25x * dm[(i0+0)*nao+(k0+2)];
                fy += gout25y * dm[(i0+0)*nao+(k0+2)];
                fz += gout25z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+0)];
                fy = gout2y * dm[(i0+0)*nao+(k0+0)];
                fz = gout2z * dm[(i0+0)*nao+(k0+0)];
                fx += gout5x * dm[(i0+0)*nao+(k0+1)];
                fy += gout5y * dm[(i0+0)*nao+(k0+1)];
                fz += gout5z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+0)*nao+(k0+2)];
                fy += gout8y * dm[(i0+0)*nao+(k0+2)];
                fz += gout8z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout11x * dm[(i0+0)*nao+(k0+0)];
                fy = gout11y * dm[(i0+0)*nao+(k0+0)];
                fz = gout11z * dm[(i0+0)*nao+(k0+0)];
                fx += gout14x * dm[(i0+0)*nao+(k0+1)];
                fy += gout14y * dm[(i0+0)*nao+(k0+1)];
                fz += gout14z * dm[(i0+0)*nao+(k0+1)];
                fx += gout17x * dm[(i0+0)*nao+(k0+2)];
                fy += gout17y * dm[(i0+0)*nao+(k0+2)];
                fz += gout17z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+1), fz);
                fx = gout20x * dm[(i0+0)*nao+(k0+0)];
                fy = gout20y * dm[(i0+0)*nao+(k0+0)];
                fz = gout20z * dm[(i0+0)*nao+(k0+0)];
                fx += gout23x * dm[(i0+0)*nao+(k0+1)];
                fy += gout23y * dm[(i0+0)*nao+(k0+1)];
                fz += gout23z * dm[(i0+0)*nao+(k0+1)];
                fx += gout26x * dm[(i0+0)*nao+(k0+2)];
                fy += gout26y * dm[(i0+0)*nao+(k0+2)];
                fz += gout26z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+1)];
                fy += gout9y * dm[(j0+0)*nao+(l0+1)];
                fz += gout9z * dm[(j0+0)*nao+(l0+1)];
                fx += gout18x * dm[(j0+0)*nao+(l0+2)];
                fy += gout18y * dm[(j0+0)*nao+(l0+2)];
                fz += gout18z * dm[(j0+0)*nao+(l0+2)];
                fx += gout1x * dm[(j0+1)*nao+(l0+0)];
                fy += gout1y * dm[(j0+1)*nao+(l0+0)];
                fz += gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout10x * dm[(j0+1)*nao+(l0+1)];
                fy += gout10y * dm[(j0+1)*nao+(l0+1)];
                fz += gout10z * dm[(j0+1)*nao+(l0+1)];
                fx += gout19x * dm[(j0+1)*nao+(l0+2)];
                fy += gout19y * dm[(j0+1)*nao+(l0+2)];
                fz += gout19z * dm[(j0+1)*nao+(l0+2)];
                fx += gout2x * dm[(j0+2)*nao+(l0+0)];
                fy += gout2y * dm[(j0+2)*nao+(l0+0)];
                fz += gout2z * dm[(j0+2)*nao+(l0+0)];
                fx += gout11x * dm[(j0+2)*nao+(l0+1)];
                fy += gout11y * dm[(j0+2)*nao+(l0+1)];
                fz += gout11z * dm[(j0+2)*nao+(l0+1)];
                fx += gout20x * dm[(j0+2)*nao+(l0+2)];
                fy += gout20y * dm[(j0+2)*nao+(l0+2)];
                fz += gout20z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+1)];
                fy += gout12y * dm[(j0+0)*nao+(l0+1)];
                fz += gout12z * dm[(j0+0)*nao+(l0+1)];
                fx += gout21x * dm[(j0+0)*nao+(l0+2)];
                fy += gout21y * dm[(j0+0)*nao+(l0+2)];
                fz += gout21z * dm[(j0+0)*nao+(l0+2)];
                fx += gout4x * dm[(j0+1)*nao+(l0+0)];
                fy += gout4y * dm[(j0+1)*nao+(l0+0)];
                fz += gout4z * dm[(j0+1)*nao+(l0+0)];
                fx += gout13x * dm[(j0+1)*nao+(l0+1)];
                fy += gout13y * dm[(j0+1)*nao+(l0+1)];
                fz += gout13z * dm[(j0+1)*nao+(l0+1)];
                fx += gout22x * dm[(j0+1)*nao+(l0+2)];
                fy += gout22y * dm[(j0+1)*nao+(l0+2)];
                fz += gout22z * dm[(j0+1)*nao+(l0+2)];
                fx += gout5x * dm[(j0+2)*nao+(l0+0)];
                fy += gout5y * dm[(j0+2)*nao+(l0+0)];
                fz += gout5z * dm[(j0+2)*nao+(l0+0)];
                fx += gout14x * dm[(j0+2)*nao+(l0+1)];
                fy += gout14y * dm[(j0+2)*nao+(l0+1)];
                fz += gout14z * dm[(j0+2)*nao+(l0+1)];
                fx += gout23x * dm[(j0+2)*nao+(l0+2)];
                fy += gout23y * dm[(j0+2)*nao+(l0+2)];
                fz += gout23z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                fx += gout15x * dm[(j0+0)*nao+(l0+1)];
                fy += gout15y * dm[(j0+0)*nao+(l0+1)];
                fz += gout15z * dm[(j0+0)*nao+(l0+1)];
                fx += gout24x * dm[(j0+0)*nao+(l0+2)];
                fy += gout24y * dm[(j0+0)*nao+(l0+2)];
                fz += gout24z * dm[(j0+0)*nao+(l0+2)];
                fx += gout7x * dm[(j0+1)*nao+(l0+0)];
                fy += gout7y * dm[(j0+1)*nao+(l0+0)];
                fz += gout7z * dm[(j0+1)*nao+(l0+0)];
                fx += gout16x * dm[(j0+1)*nao+(l0+1)];
                fy += gout16y * dm[(j0+1)*nao+(l0+1)];
                fz += gout16z * dm[(j0+1)*nao+(l0+1)];
                fx += gout25x * dm[(j0+1)*nao+(l0+2)];
                fy += gout25y * dm[(j0+1)*nao+(l0+2)];
                fz += gout25z * dm[(j0+1)*nao+(l0+2)];
                fx += gout8x * dm[(j0+2)*nao+(l0+0)];
                fy += gout8y * dm[(j0+2)*nao+(l0+0)];
                fz += gout8z * dm[(j0+2)*nao+(l0+0)];
                fx += gout17x * dm[(j0+2)*nao+(l0+1)];
                fy += gout17y * dm[(j0+2)*nao+(l0+1)];
                fz += gout17z * dm[(j0+2)*nao+(l0+1)];
                fx += gout26x * dm[(j0+2)*nao+(l0+2)];
                fy += gout26y * dm[(j0+2)*nao+(l0+2)];
                fz += gout26z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+1)];
                fy += gout9y * dm[(i0+0)*nao+(l0+1)];
                fz += gout9z * dm[(i0+0)*nao+(l0+1)];
                fx += gout18x * dm[(i0+0)*nao+(l0+2)];
                fy += gout18y * dm[(i0+0)*nao+(l0+2)];
                fz += gout18z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+1)];
                fy += gout12y * dm[(i0+0)*nao+(l0+1)];
                fz += gout12z * dm[(i0+0)*nao+(l0+1)];
                fx += gout21x * dm[(i0+0)*nao+(l0+2)];
                fy += gout21y * dm[(i0+0)*nao+(l0+2)];
                fz += gout21z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout15x * dm[(i0+0)*nao+(l0+1)];
                fy += gout15y * dm[(i0+0)*nao+(l0+1)];
                fz += gout15z * dm[(i0+0)*nao+(l0+1)];
                fx += gout24x * dm[(i0+0)*nao+(l0+2)];
                fy += gout24y * dm[(i0+0)*nao+(l0+2)];
                fz += gout24z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+1)];
                fy += gout10y * dm[(i0+0)*nao+(l0+1)];
                fz += gout10z * dm[(i0+0)*nao+(l0+1)];
                fx += gout19x * dm[(i0+0)*nao+(l0+2)];
                fy += gout19y * dm[(i0+0)*nao+(l0+2)];
                fz += gout19z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+0)*nao+(l0+1)];
                fy += gout13y * dm[(i0+0)*nao+(l0+1)];
                fz += gout13z * dm[(i0+0)*nao+(l0+1)];
                fx += gout22x * dm[(i0+0)*nao+(l0+2)];
                fy += gout22y * dm[(i0+0)*nao+(l0+2)];
                fz += gout22z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                fx += gout16x * dm[(i0+0)*nao+(l0+1)];
                fy += gout16y * dm[(i0+0)*nao+(l0+1)];
                fz += gout16z * dm[(i0+0)*nao+(l0+1)];
                fx += gout25x * dm[(i0+0)*nao+(l0+2)];
                fy += gout25y * dm[(i0+0)*nao+(l0+2)];
                fz += gout25z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+1)];
                fy += gout11y * dm[(i0+0)*nao+(l0+1)];
                fz += gout11z * dm[(i0+0)*nao+(l0+1)];
                fx += gout20x * dm[(i0+0)*nao+(l0+2)];
                fy += gout20y * dm[(i0+0)*nao+(l0+2)];
                fz += gout20z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                fx += gout14x * dm[(i0+0)*nao+(l0+1)];
                fy += gout14y * dm[(i0+0)*nao+(l0+1)];
                fz += gout14z * dm[(i0+0)*nao+(l0+1)];
                fx += gout23x * dm[(i0+0)*nao+(l0+2)];
                fy += gout23y * dm[(i0+0)*nao+(l0+2)];
                fz += gout23z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+0)];
                fy = gout8y * dm[(i0+0)*nao+(l0+0)];
                fz = gout8z * dm[(i0+0)*nao+(l0+0)];
                fx += gout17x * dm[(i0+0)*nao+(l0+1)];
                fy += gout17y * dm[(i0+0)*nao+(l0+1)];
                fz += gout17z * dm[(i0+0)*nao+(l0+1)];
                fx += gout26x * dm[(i0+0)*nao+(l0+2)];
                fy += gout26y * dm[(i0+0)*nao+(l0+2)];
                fz += gout26z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0111(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0111(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0120(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double b01 = .5/akl * (1 - rt_akl);
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_21x = cpx * trr_20x + 2*b00 * trr_10x;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double trr_22x = cpx * trr_21x + 1*b01 * trr_20x + 2*b00 * trr_11x;
                    double trr_01x = cpx * 1;
                    double trr_12x = cpx * trr_11x + 1*b01 * trr_10x + 1*b00 * trr_01x;
                    double hrr_1120x = trr_22x - rjri[0] * trr_12x;
                    fx = ai2 * hrr_1120x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_02x = cpx * trr_01x + 1*b01 * 1;
                    double hrr_0120x = trr_12x - rjri[0] * trr_02x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_0120x *  fy  * wt;
                    gout0z += hrr_0120x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_12x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    double hrr_1100y = trr_20y - rjri[1] * trr_10y;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_10z;
                    double hrr_0100y = trr_10y - rjri[1] * 1;
                    gout1x +=  fx  * hrr_0100y * wt;
                    gout1y += trr_02x *  fy  * wt;
                    gout1z += trr_02x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_12x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    double hrr_1100z = trr_20z - rjri[2] * trr_10z;
                    fz = ai2 * hrr_1100z;
                    double hrr_0100z = trr_10z - rjri[2] * wt;
                    gout2x +=  fx  * 1 * hrr_0100z;
                    gout2y += trr_02x *  fy  * hrr_0100z;
                    gout2z += trr_02x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_1110x = trr_21x - rjri[0] * trr_11x;
                    fx = ai2 * hrr_1110x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    double hrr_0110x = trr_11x - rjri[0] * trr_01x;
                    double trr_01y = cpy * 1;
                    gout3x +=  fx  * trr_01y * wt;
                    gout3y += hrr_0110x *  fy  * wt;
                    gout3z += hrr_0110x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double trr_21y = cpy * trr_20y + 2*b00 * trr_10y;
                    double hrr_1110y = trr_21y - rjri[1] * trr_11y;
                    fy = ai2 * hrr_1110y;
                    fz = ai2 * trr_10z;
                    double hrr_0110y = trr_11y - rjri[1] * trr_01y;
                    gout4x +=  fx  * hrr_0110y * wt;
                    gout4y += trr_01x *  fy  * wt;
                    gout4z += trr_01x * hrr_0110y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1100z;
                    gout5x +=  fx  * trr_01y * hrr_0100z;
                    gout5y += trr_01x *  fy  * hrr_0100z;
                    gout5z += trr_01x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1110x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    double trr_01z = cpz * wt;
                    gout6x +=  fx  * 1 * trr_01z;
                    gout6y += hrr_0110x *  fy  * trr_01z;
                    gout6z += hrr_0110x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_11z;
                    gout7x +=  fx  * hrr_0100y * trr_01z;
                    gout7y += trr_01x *  fy  * trr_01z;
                    gout7z += trr_01x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double trr_21z = cpz * trr_20z + 2*b00 * trr_10z;
                    double hrr_1110z = trr_21z - rjri[2] * trr_11z;
                    fz = ai2 * hrr_1110z;
                    double hrr_0110z = trr_11z - rjri[2] * trr_01z;
                    gout8x +=  fx  * 1 * hrr_0110z;
                    gout8y += trr_01x *  fy  * hrr_0110z;
                    gout8z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_1100x = trr_20x - rjri[0] * trr_10x;
                    fx = ai2 * hrr_1100x;
                    double trr_12y = cpy * trr_11y + 1*b01 * trr_10y + 1*b00 * trr_01y;
                    fy = ai2 * trr_12y;
                    fz = ai2 * trr_10z;
                    double hrr_0100x = trr_10x - rjri[0] * 1;
                    double trr_02y = cpy * trr_01y + 1*b01 * 1;
                    gout9x +=  fx  * trr_02y * wt;
                    gout9y += hrr_0100x *  fy  * wt;
                    gout9z += hrr_0100x * trr_02y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_22y = cpy * trr_21y + 1*b01 * trr_20y + 2*b00 * trr_11y;
                    double hrr_1120y = trr_22y - rjri[1] * trr_12y;
                    fy = ai2 * hrr_1120y;
                    fz = ai2 * trr_10z;
                    double hrr_0120y = trr_12y - rjri[1] * trr_02y;
                    gout10x +=  fx  * hrr_0120y * wt;
                    gout10y += 1 *  fy  * wt;
                    gout10z += 1 * hrr_0120y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_12y;
                    fz = ai2 * hrr_1100z;
                    gout11x +=  fx  * trr_02y * hrr_0100z;
                    gout11y += 1 *  fy  * hrr_0100z;
                    gout11z += 1 * trr_02y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_11z;
                    gout12x +=  fx  * trr_01y * trr_01z;
                    gout12y += hrr_0100x *  fy  * trr_01z;
                    gout12z += hrr_0100x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1110y;
                    fz = ai2 * trr_11z;
                    gout13x +=  fx  * hrr_0110y * trr_01z;
                    gout13y += 1 *  fy  * trr_01z;
                    gout13z += 1 * hrr_0110y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1110z;
                    gout14x +=  fx  * trr_01y * hrr_0110z;
                    gout14y += 1 *  fy  * hrr_0110z;
                    gout14z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_10y;
                    double trr_12z = cpz * trr_11z + 1*b01 * trr_10z + 1*b00 * trr_01z;
                    fz = ai2 * trr_12z;
                    double trr_02z = cpz * trr_01z + 1*b01 * wt;
                    gout15x +=  fx  * 1 * trr_02z;
                    gout15y += hrr_0100x *  fy  * trr_02z;
                    gout15z += hrr_0100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_12z;
                    gout16x +=  fx  * hrr_0100y * trr_02z;
                    gout16y += 1 *  fy  * trr_02z;
                    gout16z += 1 * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_22z = cpz * trr_21z + 1*b01 * trr_20z + 2*b00 * trr_11z;
                    double hrr_1120z = trr_22z - rjri[2] * trr_12z;
                    fz = ai2 * hrr_1120z;
                    double hrr_0120z = trr_12z - rjri[2] * trr_02z;
                    gout17x +=  fx  * 1 * hrr_0120z;
                    gout17y += 1 *  fy  * hrr_0120z;
                    gout17z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+1)];
                fy += gout3y * dm[(l0+0)*nao+(k0+1)];
                fz += gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout6x * dm[(l0+0)*nao+(k0+2)];
                fy += gout6y * dm[(l0+0)*nao+(k0+2)];
                fz += gout6z * dm[(l0+0)*nao+(k0+2)];
                fx += gout9x * dm[(l0+0)*nao+(k0+3)];
                fy += gout9y * dm[(l0+0)*nao+(k0+3)];
                fz += gout9z * dm[(l0+0)*nao+(k0+3)];
                fx += gout12x * dm[(l0+0)*nao+(k0+4)];
                fy += gout12y * dm[(l0+0)*nao+(k0+4)];
                fz += gout12z * dm[(l0+0)*nao+(k0+4)];
                fx += gout15x * dm[(l0+0)*nao+(k0+5)];
                fy += gout15y * dm[(l0+0)*nao+(k0+5)];
                fz += gout15z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+1)];
                fy += gout4y * dm[(l0+0)*nao+(k0+1)];
                fz += gout4z * dm[(l0+0)*nao+(k0+1)];
                fx += gout7x * dm[(l0+0)*nao+(k0+2)];
                fy += gout7y * dm[(l0+0)*nao+(k0+2)];
                fz += gout7z * dm[(l0+0)*nao+(k0+2)];
                fx += gout10x * dm[(l0+0)*nao+(k0+3)];
                fy += gout10y * dm[(l0+0)*nao+(k0+3)];
                fz += gout10z * dm[(l0+0)*nao+(k0+3)];
                fx += gout13x * dm[(l0+0)*nao+(k0+4)];
                fy += gout13y * dm[(l0+0)*nao+(k0+4)];
                fz += gout13z * dm[(l0+0)*nao+(k0+4)];
                fx += gout16x * dm[(l0+0)*nao+(k0+5)];
                fy += gout16y * dm[(l0+0)*nao+(k0+5)];
                fz += gout16z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout5x * dm[(l0+0)*nao+(k0+1)];
                fy += gout5y * dm[(l0+0)*nao+(k0+1)];
                fz += gout5z * dm[(l0+0)*nao+(k0+1)];
                fx += gout8x * dm[(l0+0)*nao+(k0+2)];
                fy += gout8y * dm[(l0+0)*nao+(k0+2)];
                fz += gout8z * dm[(l0+0)*nao+(k0+2)];
                fx += gout11x * dm[(l0+0)*nao+(k0+3)];
                fy += gout11y * dm[(l0+0)*nao+(k0+3)];
                fz += gout11z * dm[(l0+0)*nao+(k0+3)];
                fx += gout14x * dm[(l0+0)*nao+(k0+4)];
                fy += gout14y * dm[(l0+0)*nao+(k0+4)];
                fz += gout14z * dm[(l0+0)*nao+(k0+4)];
                fx += gout17x * dm[(l0+0)*nao+(k0+5)];
                fy += gout17y * dm[(l0+0)*nao+(k0+5)];
                fz += gout17z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+1)*nao+(i0+0)];
                fy += gout1y * dm[(j0+1)*nao+(i0+0)];
                fz += gout1z * dm[(j0+1)*nao+(i0+0)];
                fx += gout2x * dm[(j0+2)*nao+(i0+0)];
                fy += gout2y * dm[(j0+2)*nao+(i0+0)];
                fz += gout2z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                fx += gout4x * dm[(j0+1)*nao+(i0+0)];
                fy += gout4y * dm[(j0+1)*nao+(i0+0)];
                fz += gout4z * dm[(j0+1)*nao+(i0+0)];
                fx += gout5x * dm[(j0+2)*nao+(i0+0)];
                fy += gout5y * dm[(j0+2)*nao+(i0+0)];
                fz += gout5z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+1)*nao+(i0+0)];
                fy += gout7y * dm[(j0+1)*nao+(i0+0)];
                fz += gout7z * dm[(j0+1)*nao+(i0+0)];
                fx += gout8x * dm[(j0+2)*nao+(i0+0)];
                fy += gout8y * dm[(j0+2)*nao+(i0+0)];
                fz += gout8z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                fx += gout10x * dm[(j0+1)*nao+(i0+0)];
                fy += gout10y * dm[(j0+1)*nao+(i0+0)];
                fz += gout10z * dm[(j0+1)*nao+(i0+0)];
                fx += gout11x * dm[(j0+2)*nao+(i0+0)];
                fy += gout11y * dm[(j0+2)*nao+(i0+0)];
                fz += gout11z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                fx += gout13x * dm[(j0+1)*nao+(i0+0)];
                fy += gout13y * dm[(j0+1)*nao+(i0+0)];
                fz += gout13z * dm[(j0+1)*nao+(i0+0)];
                fx += gout14x * dm[(j0+2)*nao+(i0+0)];
                fy += gout14y * dm[(j0+2)*nao+(i0+0)];
                fz += gout14z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout15x * dm[(j0+0)*nao+(i0+0)];
                fy = gout15y * dm[(j0+0)*nao+(i0+0)];
                fz = gout15z * dm[(j0+0)*nao+(i0+0)];
                fx += gout16x * dm[(j0+1)*nao+(i0+0)];
                fy += gout16y * dm[(j0+1)*nao+(i0+0)];
                fz += gout16z * dm[(j0+1)*nao+(i0+0)];
                fx += gout17x * dm[(j0+2)*nao+(i0+0)];
                fy += gout17y * dm[(j0+2)*nao+(i0+0)];
                fz += gout17z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+1)];
                fy += gout3y * dm[(j0+0)*nao+(k0+1)];
                fz += gout3z * dm[(j0+0)*nao+(k0+1)];
                fx += gout6x * dm[(j0+0)*nao+(k0+2)];
                fy += gout6y * dm[(j0+0)*nao+(k0+2)];
                fz += gout6z * dm[(j0+0)*nao+(k0+2)];
                fx += gout9x * dm[(j0+0)*nao+(k0+3)];
                fy += gout9y * dm[(j0+0)*nao+(k0+3)];
                fz += gout9z * dm[(j0+0)*nao+(k0+3)];
                fx += gout12x * dm[(j0+0)*nao+(k0+4)];
                fy += gout12y * dm[(j0+0)*nao+(k0+4)];
                fz += gout12z * dm[(j0+0)*nao+(k0+4)];
                fx += gout15x * dm[(j0+0)*nao+(k0+5)];
                fy += gout15y * dm[(j0+0)*nao+(k0+5)];
                fz += gout15z * dm[(j0+0)*nao+(k0+5)];
                fx += gout1x * dm[(j0+1)*nao+(k0+0)];
                fy += gout1y * dm[(j0+1)*nao+(k0+0)];
                fz += gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout4x * dm[(j0+1)*nao+(k0+1)];
                fy += gout4y * dm[(j0+1)*nao+(k0+1)];
                fz += gout4z * dm[(j0+1)*nao+(k0+1)];
                fx += gout7x * dm[(j0+1)*nao+(k0+2)];
                fy += gout7y * dm[(j0+1)*nao+(k0+2)];
                fz += gout7z * dm[(j0+1)*nao+(k0+2)];
                fx += gout10x * dm[(j0+1)*nao+(k0+3)];
                fy += gout10y * dm[(j0+1)*nao+(k0+3)];
                fz += gout10z * dm[(j0+1)*nao+(k0+3)];
                fx += gout13x * dm[(j0+1)*nao+(k0+4)];
                fy += gout13y * dm[(j0+1)*nao+(k0+4)];
                fz += gout13z * dm[(j0+1)*nao+(k0+4)];
                fx += gout16x * dm[(j0+1)*nao+(k0+5)];
                fy += gout16y * dm[(j0+1)*nao+(k0+5)];
                fz += gout16z * dm[(j0+1)*nao+(k0+5)];
                fx += gout2x * dm[(j0+2)*nao+(k0+0)];
                fy += gout2y * dm[(j0+2)*nao+(k0+0)];
                fz += gout2z * dm[(j0+2)*nao+(k0+0)];
                fx += gout5x * dm[(j0+2)*nao+(k0+1)];
                fy += gout5y * dm[(j0+2)*nao+(k0+1)];
                fz += gout5z * dm[(j0+2)*nao+(k0+1)];
                fx += gout8x * dm[(j0+2)*nao+(k0+2)];
                fy += gout8y * dm[(j0+2)*nao+(k0+2)];
                fz += gout8z * dm[(j0+2)*nao+(k0+2)];
                fx += gout11x * dm[(j0+2)*nao+(k0+3)];
                fy += gout11y * dm[(j0+2)*nao+(k0+3)];
                fz += gout11z * dm[(j0+2)*nao+(k0+3)];
                fx += gout14x * dm[(j0+2)*nao+(k0+4)];
                fy += gout14y * dm[(j0+2)*nao+(k0+4)];
                fz += gout14z * dm[(j0+2)*nao+(k0+4)];
                fx += gout17x * dm[(j0+2)*nao+(k0+5)];
                fy += gout17y * dm[(j0+2)*nao+(k0+5)];
                fz += gout17z * dm[(j0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+1)];
                fy += gout3y * dm[(i0+0)*nao+(k0+1)];
                fz += gout3z * dm[(i0+0)*nao+(k0+1)];
                fx += gout6x * dm[(i0+0)*nao+(k0+2)];
                fy += gout6y * dm[(i0+0)*nao+(k0+2)];
                fz += gout6z * dm[(i0+0)*nao+(k0+2)];
                fx += gout9x * dm[(i0+0)*nao+(k0+3)];
                fy += gout9y * dm[(i0+0)*nao+(k0+3)];
                fz += gout9z * dm[(i0+0)*nao+(k0+3)];
                fx += gout12x * dm[(i0+0)*nao+(k0+4)];
                fy += gout12y * dm[(i0+0)*nao+(k0+4)];
                fz += gout12z * dm[(i0+0)*nao+(k0+4)];
                fx += gout15x * dm[(i0+0)*nao+(k0+5)];
                fy += gout15y * dm[(i0+0)*nao+(k0+5)];
                fz += gout15z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout4x * dm[(i0+0)*nao+(k0+1)];
                fy += gout4y * dm[(i0+0)*nao+(k0+1)];
                fz += gout4z * dm[(i0+0)*nao+(k0+1)];
                fx += gout7x * dm[(i0+0)*nao+(k0+2)];
                fy += gout7y * dm[(i0+0)*nao+(k0+2)];
                fz += gout7z * dm[(i0+0)*nao+(k0+2)];
                fx += gout10x * dm[(i0+0)*nao+(k0+3)];
                fy += gout10y * dm[(i0+0)*nao+(k0+3)];
                fz += gout10z * dm[(i0+0)*nao+(k0+3)];
                fx += gout13x * dm[(i0+0)*nao+(k0+4)];
                fy += gout13y * dm[(i0+0)*nao+(k0+4)];
                fz += gout13z * dm[(i0+0)*nao+(k0+4)];
                fx += gout16x * dm[(i0+0)*nao+(k0+5)];
                fy += gout16y * dm[(i0+0)*nao+(k0+5)];
                fz += gout16z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+0)];
                fy = gout2y * dm[(i0+0)*nao+(k0+0)];
                fz = gout2z * dm[(i0+0)*nao+(k0+0)];
                fx += gout5x * dm[(i0+0)*nao+(k0+1)];
                fy += gout5y * dm[(i0+0)*nao+(k0+1)];
                fz += gout5z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+0)*nao+(k0+2)];
                fy += gout8y * dm[(i0+0)*nao+(k0+2)];
                fz += gout8z * dm[(i0+0)*nao+(k0+2)];
                fx += gout11x * dm[(i0+0)*nao+(k0+3)];
                fy += gout11y * dm[(i0+0)*nao+(k0+3)];
                fz += gout11z * dm[(i0+0)*nao+(k0+3)];
                fx += gout14x * dm[(i0+0)*nao+(k0+4)];
                fy += gout14y * dm[(i0+0)*nao+(k0+4)];
                fz += gout14z * dm[(i0+0)*nao+(k0+4)];
                fx += gout17x * dm[(i0+0)*nao+(k0+5)];
                fy += gout17y * dm[(i0+0)*nao+(k0+5)];
                fz += gout17z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout1x * dm[(j0+1)*nao+(l0+0)];
                fy += gout1y * dm[(j0+1)*nao+(l0+0)];
                fz += gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout2x * dm[(j0+2)*nao+(l0+0)];
                fy += gout2y * dm[(j0+2)*nao+(l0+0)];
                fz += gout2z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout4x * dm[(j0+1)*nao+(l0+0)];
                fy += gout4y * dm[(j0+1)*nao+(l0+0)];
                fz += gout4z * dm[(j0+1)*nao+(l0+0)];
                fx += gout5x * dm[(j0+2)*nao+(l0+0)];
                fy += gout5y * dm[(j0+2)*nao+(l0+0)];
                fz += gout5z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                fx += gout7x * dm[(j0+1)*nao+(l0+0)];
                fy += gout7y * dm[(j0+1)*nao+(l0+0)];
                fz += gout7z * dm[(j0+1)*nao+(l0+0)];
                fx += gout8x * dm[(j0+2)*nao+(l0+0)];
                fy += gout8y * dm[(j0+2)*nao+(l0+0)];
                fz += gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+1)*nao+(l0+0)];
                fy += gout10y * dm[(j0+1)*nao+(l0+0)];
                fz += gout10z * dm[(j0+1)*nao+(l0+0)];
                fx += gout11x * dm[(j0+2)*nao+(l0+0)];
                fy += gout11y * dm[(j0+2)*nao+(l0+0)];
                fz += gout11z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout12x * dm[(j0+0)*nao+(l0+0)];
                fy = gout12y * dm[(j0+0)*nao+(l0+0)];
                fz = gout12z * dm[(j0+0)*nao+(l0+0)];
                fx += gout13x * dm[(j0+1)*nao+(l0+0)];
                fy += gout13y * dm[(j0+1)*nao+(l0+0)];
                fz += gout13z * dm[(j0+1)*nao+(l0+0)];
                fx += gout14x * dm[(j0+2)*nao+(l0+0)];
                fy += gout14y * dm[(j0+2)*nao+(l0+0)];
                fz += gout14z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout15x * dm[(j0+0)*nao+(l0+0)];
                fy = gout15y * dm[(j0+0)*nao+(l0+0)];
                fz = gout15z * dm[(j0+0)*nao+(l0+0)];
                fx += gout16x * dm[(j0+1)*nao+(l0+0)];
                fy += gout16y * dm[(j0+1)*nao+(l0+0)];
                fz += gout16z * dm[(j0+1)*nao+(l0+0)];
                fx += gout17x * dm[(j0+2)*nao+(l0+0)];
                fy += gout17y * dm[(j0+2)*nao+(l0+0)];
                fz += gout17z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+0)];
                fy = gout9y * dm[(i0+0)*nao+(l0+0)];
                fz = gout9z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout15x * dm[(i0+0)*nao+(l0+0)];
                fy = gout15y * dm[(i0+0)*nao+(l0+0)];
                fz = gout15z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout10x * dm[(i0+0)*nao+(l0+0)];
                fy = gout10y * dm[(i0+0)*nao+(l0+0)];
                fz = gout10z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+3), fz);
                fx = gout13x * dm[(i0+0)*nao+(l0+0)];
                fy = gout13y * dm[(i0+0)*nao+(l0+0)];
                fz = gout13z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+4), fz);
                fx = gout16x * dm[(i0+0)*nao+(l0+0)];
                fy = gout16y * dm[(i0+0)*nao+(l0+0)];
                fz = gout16z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+5), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+0)];
                fy = gout8y * dm[(i0+0)*nao+(l0+0)];
                fz = gout8z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout11x * dm[(i0+0)*nao+(l0+0)];
                fy = gout11y * dm[(i0+0)*nao+(l0+0)];
                fz = gout11z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+3), fz);
                fx = gout14x * dm[(i0+0)*nao+(l0+0)];
                fy = gout14y * dm[(i0+0)*nao+(l0+0)];
                fz = gout14z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+4), fz);
                fx = gout17x * dm[(i0+0)*nao+(l0+0)];
                fy = gout17y * dm[(i0+0)*nao+(l0+0)];
                fz = gout17z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+5), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0120(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0120(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0121(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;
    double *gx = rw + 128 * nroots;
    double *gy = gx + 1536;
    double *gz = gy + 1536;
    double *rlrk = gz + 1536;
    double *Rpq = rlrk + 192;
    if (gout_id == 0) {
        gx[0] = 1.;
        gy[0] = 1.;
    }
    double s0, s1, s2;
    double Ix, Iy, Iz;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        if (gout_id == 0) {
            rlrk[0] = xlxk;
            rlrk[64] = ylyk;
            rlrk[128] = zlzk;
        }
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            __syncthreads();
            double xlxk = rlrk[0];
            double ylyk = rlrk[64];
            double zlzk = rlrk[128];
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xkl = rk[0] + rlrk[0] * al_akl;
                double ykl = rk[1] + rlrk[64] * al_akl;
                double zkl = rk[2] + rlrk[128] * al_akl;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                __syncthreads();
                if (gout_id == 0) {
                    Rpq[0] = xpq;
                    Rpq[64] = ypq;
                    Rpq[128] = zpq;
                }
                rys_roots_rs(nroots, theta, rr, omega, rw, 64, gout_id, 4);
                for (int irys = 0; irys < nroots; ++irys) {
                    __syncthreads();
                    double rt = rw[irys*128];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double rt_akl = rt_aa * aij;
                    double b00 = .5 * rt_aa;
                    double b01 = .5/akl * (1 - rt_akl);
                    for (int n = gout_id; n < 3; n += 4) {
                        if (n == 2) {
                            gz[0] = rw[irys*128+64] * fac;
                        }
                        double *_gx = gx + n * 1536;
                        double xjxi = rjri[n];
                        double Rpa = xjxi * aj_aij;
                        double c0x = Rpa - rt_aij * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = c0x * s0;
                        _gx[64] = s1;
                        s2 = c0x * s1 + 1 * b10 * s0;
                        _gx[128] = s2;
                        double xlxk = rlrk[n*64];
                        double Rqc = xlxk * al_akl;
                        double cpx = Rqc + rt_akl * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = cpx * s0;
                        _gx[256] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        _gx[512] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = cpx*s1 + 2 * b01 *s0;
                        _gx[768] = s2;
                        s0 = _gx[64];
                        s1 = cpx * s0;
                        s1 += 1 * b00 * _gx[0];
                        _gx[320] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 1 * b00 * _gx[256];
                        _gx[576] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = cpx*s1 + 2 * b01 *s0;
                        s2 += 1 * b00 * _gx[512];
                        _gx[832] = s2;
                        s0 = _gx[128];
                        s1 = cpx * s0;
                        s1 += 2 * b00 * _gx[64];
                        _gx[384] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 2 * b00 * _gx[320];
                        _gx[640] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = cpx*s1 + 2 * b01 *s0;
                        s2 += 2 * b00 * _gx[576];
                        _gx[896] = s2;
                        s1 = _gx[128];
                        s0 = _gx[64];
                        _gx[192] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[128] = s1 - xjxi * s0;
                        s1 = _gx[384];
                        s0 = _gx[320];
                        _gx[448] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[256];
                        _gx[384] = s1 - xjxi * s0;
                        s1 = _gx[640];
                        s0 = _gx[576];
                        _gx[704] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[512];
                        _gx[640] = s1 - xjxi * s0;
                        s1 = _gx[896];
                        s0 = _gx[832];
                        _gx[960] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[768];
                        _gx[896] = s1 - xjxi * s0;
                        s1 = _gx[768];
                        s0 = _gx[512];
                        _gx[1280] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[256];
                        _gx[1024] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[768] = s1 - xlxk * s0;
                        s1 = _gx[832];
                        s0 = _gx[576];
                        _gx[1344] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[320];
                        _gx[1088] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[832] = s1 - xlxk * s0;
                        s1 = _gx[896];
                        s0 = _gx[640];
                        _gx[1408] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[384];
                        _gx[1152] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[128];
                        _gx[896] = s1 - xlxk * s0;
                        s1 = _gx[960];
                        s0 = _gx[704];
                        _gx[1472] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[448];
                        _gx[1216] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[192];
                        _gx[960] = s1 - xlxk * s0;
                    }
                    __syncthreads();
                    switch (gout_id) {
                    case 0:
                    ai2 = rjri[5];
                    Ix = gx[1408];
                    Iy = gy[0];
                    Iz = gz[0];
                    gout0x += ai2 * gx[1472] * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[384];
                    Iz = gz[0];
                    gout1x += ai2 * gx[1088] * Iy * Iz;
                    gout1y += ai2 * gy[448] * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[0];
                    Iz = gz[384];
                    gout2x += ai2 * gx[1088] * Iy * Iz;
                    gout2y += ai2 * gy[64] * Ix * Iz;
                    gout2z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[896];
                    Iy = gy[256];
                    Iz = gz[256];
                    gout3x += ai2 * gx[960] * Iy * Iz;
                    gout3y += ai2 * gy[320] * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[128];
                    Iz = gz[512];
                    gout4x += ai2 * gx[832] * Iy * Iz;
                    gout4y += ai2 * gy[192] * Ix * Iz;
                    gout4z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[768];
                    Iz = gz[128];
                    gout5x += ai2 * gx[576] * Iy * Iz;
                    gout5y += ai2 * gy[832] * Ix * Iz;
                    gout5z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[768];
                    Iz = gz[256];
                    gout6x += ai2 * gx[448] * Iy * Iz;
                    gout6y += ai2 * gy[832] * Ix * Iz;
                    gout6z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1408];
                    Iz = gz[0];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[1472] * Ix * Iz;
                    gout7z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1024];
                    Iz = gz[384];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[1088] * Ix * Iz;
                    gout8z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[0];
                    Iz = gz[768];
                    gout9x += ai2 * gx[704] * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[384];
                    Iz = gz[768];
                    gout10x += ai2 * gx[320] * Iy * Iz;
                    gout10y += ai2 * gy[448] * Ix * Iz;
                    gout10z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[0];
                    Iz = gz[1152];
                    gout11x += ai2 * gx[320] * Iy * Iz;
                    gout11y += ai2 * gy[64] * Ix * Iz;
                    gout11z += ai2 * gz[1216] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[256];
                    Iz = gz[1024];
                    gout12x += ai2 * gx[192] * Iy * Iz;
                    gout12y += ai2 * gy[320] * Ix * Iz;
                    gout12z += ai2 * gz[1088] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[128];
                    Iz = gz[1280];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += ai2 * gy[192] * Ix * Iz;
                    gout13z += ai2 * gz[1344] * Ix * Iy;
                    break;
                    case 1:
                    ai2 = rjri[5];
                    Ix = gx[1280];
                    Iy = gy[128];
                    Iz = gz[0];
                    gout0x += ai2 * gx[1344] * Iy * Iz;
                    gout0y += ai2 * gy[192] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[256];
                    Iz = gz[128];
                    gout1x += ai2 * gx[1088] * Iy * Iz;
                    gout1y += ai2 * gy[320] * Ix * Iz;
                    gout1z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[896];
                    Iy = gy[512];
                    Iz = gz[0];
                    gout2x += ai2 * gx[960] * Iy * Iz;
                    gout2y += ai2 * gy[576] * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[384];
                    Iz = gz[256];
                    gout3x += ai2 * gx[832] * Iy * Iz;
                    gout3y += ai2 * gy[448] * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[0];
                    Iz = gz[640];
                    gout4x += ai2 * gx[832] * Iy * Iz;
                    gout4y += ai2 * gy[64] * Ix * Iz;
                    gout4z += ai2 * gz[704] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[1024];
                    Iz = gz[0];
                    gout5x += ai2 * gx[448] * Iy * Iz;
                    gout5y += ai2 * gy[1088] * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[896];
                    Iz = gz[256];
                    gout6x += ai2 * gx[320] * Iy * Iz;
                    gout6y += ai2 * gy[960] * Ix * Iz;
                    gout6z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1280];
                    Iz = gz[128];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[1344] * Ix * Iz;
                    gout7z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[768];
                    Iz = gz[512];
                    gout8x += ai2 * gx[192] * Iy * Iz;
                    gout8y += ai2 * gy[832] * Ix * Iz;
                    gout8z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[128];
                    Iz = gz[768];
                    gout9x += ai2 * gx[576] * Iy * Iz;
                    gout9y += ai2 * gy[192] * Ix * Iz;
                    gout9z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[256];
                    Iz = gz[896];
                    gout10x += ai2 * gx[320] * Iy * Iz;
                    gout10y += ai2 * gy[320] * Ix * Iz;
                    gout10z += ai2 * gz[960] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[512];
                    Iz = gz[768];
                    gout11x += ai2 * gx[192] * Iy * Iz;
                    gout11y += ai2 * gy[576] * Ix * Iz;
                    gout11z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[384];
                    Iz = gz[1024];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += ai2 * gy[448] * Ix * Iz;
                    gout12z += ai2 * gz[1088] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[0];
                    Iz = gz[1408];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += ai2 * gy[64] * Ix * Iz;
                    gout13z += ai2 * gz[1472] * Ix * Iy;
                    break;
                    case 2:
                    ai2 = rjri[5];
                    Ix = gx[1280];
                    Iy = gy[0];
                    Iz = gz[128];
                    gout0x += ai2 * gx[1344] * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1152];
                    Iy = gy[0];
                    Iz = gz[256];
                    gout1x += ai2 * gx[1216] * Iy * Iz;
                    gout1y += ai2 * gy[64] * Ix * Iz;
                    gout1z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[640];
                    Iz = gz[0];
                    gout2x += ai2 * gx[832] * Iy * Iz;
                    gout2y += ai2 * gy[704] * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[256];
                    Iz = gz[384];
                    gout3x += ai2 * gx[832] * Iy * Iz;
                    gout3y += ai2 * gy[320] * Ix * Iz;
                    gout3z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[768];
                    Iz = gz[0];
                    gout4x += ai2 * gx[704] * Iy * Iz;
                    gout4y += ai2 * gy[832] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[1152];
                    Iz = gz[0];
                    gout5x += ai2 * gx[320] * Iy * Iz;
                    gout5y += ai2 * gy[1216] * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[768];
                    Iz = gz[384];
                    gout6x += ai2 * gx[320] * Iy * Iz;
                    gout6y += ai2 * gy[832] * Ix * Iz;
                    gout6z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[1024];
                    Iz = gz[256];
                    gout7x += ai2 * gx[192] * Iy * Iz;
                    gout7y += ai2 * gy[1088] * Ix * Iz;
                    gout7z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[896];
                    Iz = gz[512];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[960] * Ix * Iz;
                    gout8z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[0];
                    Iz = gz[896];
                    gout9x += ai2 * gx[576] * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += ai2 * gz[960] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[0];
                    Iz = gz[1024];
                    gout10x += ai2 * gx[448] * Iy * Iz;
                    gout10y += ai2 * gy[64] * Ix * Iz;
                    gout10z += ai2 * gz[1088] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[640];
                    Iz = gz[768];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += ai2 * gy[704] * Ix * Iz;
                    gout11z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[256];
                    Iz = gz[1152];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += ai2 * gy[320] * Ix * Iz;
                    gout12z += ai2 * gz[1216] * Ix * Iy;
                    break;
                    case 3:
                    ai2 = rjri[5];
                    Ix = gx[1152];
                    Iy = gy[256];
                    Iz = gz[0];
                    gout0x += ai2 * gx[1216] * Iy * Iz;
                    gout0y += ai2 * gy[320] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[128];
                    Iz = gz[256];
                    gout1x += ai2 * gx[1088] * Iy * Iz;
                    gout1y += ai2 * gy[192] * Ix * Iz;
                    gout1z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[512];
                    Iz = gz[128];
                    gout2x += ai2 * gx[832] * Iy * Iz;
                    gout2y += ai2 * gy[576] * Ix * Iz;
                    gout2z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[896];
                    Iy = gy[0];
                    Iz = gz[512];
                    gout3x += ai2 * gx[960] * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[896];
                    Iz = gz[0];
                    gout4x += ai2 * gx[576] * Iy * Iz;
                    gout4y += ai2 * gy[960] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[1024];
                    Iz = gz[128];
                    gout5x += ai2 * gx[320] * Iy * Iz;
                    gout5y += ai2 * gy[1088] * Ix * Iz;
                    gout5z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[1280];
                    Iz = gz[0];
                    gout6x += ai2 * gx[192] * Iy * Iz;
                    gout6y += ai2 * gy[1344] * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1152];
                    Iz = gz[256];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[1216] * Ix * Iz;
                    gout7z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[768];
                    Iz = gz[640];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[832] * Ix * Iz;
                    gout8z += ai2 * gz[704] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[256];
                    Iz = gz[768];
                    gout9x += ai2 * gx[448] * Iy * Iz;
                    gout9y += ai2 * gy[320] * Ix * Iz;
                    gout9z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[128];
                    Iz = gz[1024];
                    gout10x += ai2 * gx[320] * Iy * Iz;
                    gout10y += ai2 * gy[192] * Ix * Iz;
                    gout10z += ai2 * gz[1088] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[512];
                    Iz = gz[896];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += ai2 * gy[576] * Ix * Iz;
                    gout11z += ai2 * gz[960] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[0];
                    Iz = gz[1280];
                    gout12x += ai2 * gx[192] * Iy * Iz;
                    gout12y += ai2 * gy[64] * Ix * Iz;
                    gout12z += ai2 * gz[1344] * Ix * Iy;
                    break;
                    }
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+4)];
                fy += gout3y * dm[(l0+0)*nao+(k0+4)];
                fz += gout3z * dm[(l0+0)*nao+(k0+4)];
                fx += gout6x * dm[(l0+1)*nao+(k0+2)];
                fy += gout6y * dm[(l0+1)*nao+(k0+2)];
                fz += gout6z * dm[(l0+1)*nao+(k0+2)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+4)];
                fy += gout12y * dm[(l0+2)*nao+(k0+4)];
                fz += gout12z * dm[(l0+2)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+0)*nao+(k0+5)];
                fy += gout4y * dm[(l0+0)*nao+(k0+5)];
                fz += gout4z * dm[(l0+0)*nao+(k0+5)];
                fx += gout7x * dm[(l0+1)*nao+(k0+3)];
                fy += gout7y * dm[(l0+1)*nao+(k0+3)];
                fz += gout7z * dm[(l0+1)*nao+(k0+3)];
                fx += gout10x * dm[(l0+2)*nao+(k0+1)];
                fy += gout10y * dm[(l0+2)*nao+(k0+1)];
                fz += gout10z * dm[(l0+2)*nao+(k0+1)];
                fx += gout13x * dm[(l0+2)*nao+(k0+5)];
                fy += gout13y * dm[(l0+2)*nao+(k0+5)];
                fz += gout13z * dm[(l0+2)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+2)];
                fy = gout2y * dm[(l0+0)*nao+(k0+2)];
                fz = gout2z * dm[(l0+0)*nao+(k0+2)];
                fx += gout5x * dm[(l0+1)*nao+(k0+0)];
                fy += gout5y * dm[(l0+1)*nao+(k0+0)];
                fz += gout5z * dm[(l0+1)*nao+(k0+0)];
                fx += gout8x * dm[(l0+1)*nao+(k0+4)];
                fy += gout8y * dm[(l0+1)*nao+(k0+4)];
                fz += gout8z * dm[(l0+1)*nao+(k0+4)];
                fx += gout11x * dm[(l0+2)*nao+(k0+2)];
                fy += gout11y * dm[(l0+2)*nao+(k0+2)];
                fz += gout11z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(i0+0)];
                fy = gout1y * dm[(j0+1)*nao+(i0+0)];
                fz = gout1z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+2)*nao+(i0+0)];
                fy = gout2y * dm[(j0+2)*nao+(i0+0)];
                fz = gout2z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+1)*nao+(i0+0)];
                fy = gout4y * dm[(j0+1)*nao+(i0+0)];
                fz = gout4z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+2)*nao+(i0+0)];
                fy = gout5y * dm[(j0+2)*nao+(i0+0)];
                fz = gout5z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+1)*nao+(i0+0)];
                fy = gout7y * dm[(j0+1)*nao+(i0+0)];
                fz = gout7z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+2)*nao+(i0+0)];
                fy = gout8y * dm[(j0+2)*nao+(i0+0)];
                fz = gout8z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+1)*nao+(i0+0)];
                fy = gout10y * dm[(j0+1)*nao+(i0+0)];
                fz = gout10z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+2)*nao+(i0+0)];
                fy = gout11y * dm[(j0+2)*nao+(i0+0)];
                fz = gout11z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+2), fz);
                fx = gout13x * dm[(j0+1)*nao+(i0+0)];
                fy = gout13y * dm[(j0+1)*nao+(i0+0)];
                fz = gout13z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+2), fz);
                break;
                case 1:
                fx = gout2x * dm[(l0+0)*nao+(k0+3)];
                fy = gout2y * dm[(l0+0)*nao+(k0+3)];
                fz = gout2z * dm[(l0+0)*nao+(k0+3)];
                fx += gout5x * dm[(l0+1)*nao+(k0+1)];
                fy += gout5y * dm[(l0+1)*nao+(k0+1)];
                fz += gout5z * dm[(l0+1)*nao+(k0+1)];
                fx += gout8x * dm[(l0+1)*nao+(k0+5)];
                fy += gout8y * dm[(l0+1)*nao+(k0+5)];
                fz += gout8z * dm[(l0+1)*nao+(k0+5)];
                fx += gout11x * dm[(l0+2)*nao+(k0+3)];
                fy += gout11y * dm[(l0+2)*nao+(k0+3)];
                fz += gout11z * dm[(l0+2)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+4)];
                fy += gout3y * dm[(l0+0)*nao+(k0+4)];
                fz += gout3z * dm[(l0+0)*nao+(k0+4)];
                fx += gout6x * dm[(l0+1)*nao+(k0+2)];
                fy += gout6y * dm[(l0+1)*nao+(k0+2)];
                fz += gout6z * dm[(l0+1)*nao+(k0+2)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+4)];
                fy += gout12y * dm[(l0+2)*nao+(k0+4)];
                fz += gout12z * dm[(l0+2)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+0)*nao+(k0+5)];
                fy += gout4y * dm[(l0+0)*nao+(k0+5)];
                fz += gout4z * dm[(l0+0)*nao+(k0+5)];
                fx += gout7x * dm[(l0+1)*nao+(k0+3)];
                fy += gout7y * dm[(l0+1)*nao+(k0+3)];
                fz += gout7z * dm[(l0+1)*nao+(k0+3)];
                fx += gout10x * dm[(l0+2)*nao+(k0+1)];
                fy += gout10y * dm[(l0+2)*nao+(k0+1)];
                fz += gout10z * dm[(l0+2)*nao+(k0+1)];
                fx += gout13x * dm[(l0+2)*nao+(k0+5)];
                fy += gout13y * dm[(l0+2)*nao+(k0+5)];
                fz += gout13z * dm[(l0+2)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+1)*nao+(i0+0)];
                fy = gout0y * dm[(j0+1)*nao+(i0+0)];
                fz = gout0z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+2)*nao+(i0+0)];
                fy = gout1y * dm[(j0+2)*nao+(i0+0)];
                fz = gout1z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+0)];
                fy = gout2y * dm[(j0+0)*nao+(i0+0)];
                fz = gout2z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+1)*nao+(i0+0)];
                fy = gout3y * dm[(j0+1)*nao+(i0+0)];
                fz = gout3z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+2)*nao+(i0+0)];
                fy = gout4y * dm[(j0+2)*nao+(i0+0)];
                fz = gout4z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+0)];
                fy = gout5y * dm[(j0+0)*nao+(i0+0)];
                fz = gout5z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+1)*nao+(i0+0)];
                fy = gout6y * dm[(j0+1)*nao+(i0+0)];
                fz = gout6z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+2)*nao+(i0+0)];
                fy = gout7y * dm[(j0+2)*nao+(i0+0)];
                fz = gout7z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+0)];
                fy = gout8y * dm[(j0+0)*nao+(i0+0)];
                fz = gout8z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+1)*nao+(i0+0)];
                fy = gout9y * dm[(j0+1)*nao+(i0+0)];
                fz = gout9z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+2)*nao+(i0+0)];
                fy = gout10y * dm[(j0+2)*nao+(i0+0)];
                fz = gout10z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+0)];
                fy = gout11y * dm[(j0+0)*nao+(i0+0)];
                fz = gout11z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+1)*nao+(i0+0)];
                fy = gout12y * dm[(j0+1)*nao+(i0+0)];
                fz = gout12z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+2), fz);
                fx = gout13x * dm[(j0+2)*nao+(i0+0)];
                fy = gout13y * dm[(j0+2)*nao+(i0+0)];
                fz = gout13z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+2), fz);
                break;
                case 2:
                fx = gout1x * dm[(l0+0)*nao+(k0+2)];
                fy = gout1y * dm[(l0+0)*nao+(k0+2)];
                fz = gout1z * dm[(l0+0)*nao+(k0+2)];
                fx += gout4x * dm[(l0+1)*nao+(k0+0)];
                fy += gout4y * dm[(l0+1)*nao+(k0+0)];
                fz += gout4z * dm[(l0+1)*nao+(k0+0)];
                fx += gout7x * dm[(l0+1)*nao+(k0+4)];
                fy += gout7y * dm[(l0+1)*nao+(k0+4)];
                fz += gout7z * dm[(l0+1)*nao+(k0+4)];
                fx += gout10x * dm[(l0+2)*nao+(k0+2)];
                fy += gout10y * dm[(l0+2)*nao+(k0+2)];
                fz += gout10z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+3)];
                fy = gout2y * dm[(l0+0)*nao+(k0+3)];
                fz = gout2z * dm[(l0+0)*nao+(k0+3)];
                fx += gout5x * dm[(l0+1)*nao+(k0+1)];
                fy += gout5y * dm[(l0+1)*nao+(k0+1)];
                fz += gout5z * dm[(l0+1)*nao+(k0+1)];
                fx += gout8x * dm[(l0+1)*nao+(k0+5)];
                fy += gout8y * dm[(l0+1)*nao+(k0+5)];
                fz += gout8z * dm[(l0+1)*nao+(k0+5)];
                fx += gout11x * dm[(l0+2)*nao+(k0+3)];
                fy += gout11y * dm[(l0+2)*nao+(k0+3)];
                fz += gout11z * dm[(l0+2)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+4)];
                fy += gout3y * dm[(l0+0)*nao+(k0+4)];
                fz += gout3z * dm[(l0+0)*nao+(k0+4)];
                fx += gout6x * dm[(l0+1)*nao+(k0+2)];
                fy += gout6y * dm[(l0+1)*nao+(k0+2)];
                fz += gout6z * dm[(l0+1)*nao+(k0+2)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+4)];
                fy += gout12y * dm[(l0+2)*nao+(k0+4)];
                fz += gout12z * dm[(l0+2)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+2)*nao+(i0+0)];
                fy = gout0y * dm[(j0+2)*nao+(i0+0)];
                fz = gout0z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+1)*nao+(i0+0)];
                fy = gout2y * dm[(j0+1)*nao+(i0+0)];
                fz = gout2z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+2)*nao+(i0+0)];
                fy = gout3y * dm[(j0+2)*nao+(i0+0)];
                fz = gout3z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout5x * dm[(j0+1)*nao+(i0+0)];
                fy = gout5y * dm[(j0+1)*nao+(i0+0)];
                fz = gout5z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+2)*nao+(i0+0)];
                fy = gout6y * dm[(j0+2)*nao+(i0+0)];
                fz = gout6z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+0)];
                fy = gout7y * dm[(j0+0)*nao+(i0+0)];
                fz = gout7z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+1)*nao+(i0+0)];
                fy = gout8y * dm[(j0+1)*nao+(i0+0)];
                fz = gout8z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+2)*nao+(i0+0)];
                fy = gout9y * dm[(j0+2)*nao+(i0+0)];
                fz = gout9z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+0)*nao+(i0+0)];
                fy = gout10y * dm[(j0+0)*nao+(i0+0)];
                fz = gout10z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+1)*nao+(i0+0)];
                fy = gout11y * dm[(j0+1)*nao+(i0+0)];
                fz = gout11z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+2)*nao+(i0+0)];
                fy = gout12y * dm[(j0+2)*nao+(i0+0)];
                fz = gout12z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+2), fz);
                break;
                case 3:
                fx = gout0x * dm[(l0+0)*nao+(k0+1)];
                fy = gout0y * dm[(l0+0)*nao+(k0+1)];
                fz = gout0z * dm[(l0+0)*nao+(k0+1)];
                fx += gout3x * dm[(l0+0)*nao+(k0+5)];
                fy += gout3y * dm[(l0+0)*nao+(k0+5)];
                fz += gout3z * dm[(l0+0)*nao+(k0+5)];
                fx += gout6x * dm[(l0+1)*nao+(k0+3)];
                fy += gout6y * dm[(l0+1)*nao+(k0+3)];
                fz += gout6z * dm[(l0+1)*nao+(k0+3)];
                fx += gout9x * dm[(l0+2)*nao+(k0+1)];
                fy += gout9y * dm[(l0+2)*nao+(k0+1)];
                fz += gout9z * dm[(l0+2)*nao+(k0+1)];
                fx += gout12x * dm[(l0+2)*nao+(k0+5)];
                fy += gout12y * dm[(l0+2)*nao+(k0+5)];
                fz += gout12z * dm[(l0+2)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+2)];
                fy = gout1y * dm[(l0+0)*nao+(k0+2)];
                fz = gout1z * dm[(l0+0)*nao+(k0+2)];
                fx += gout4x * dm[(l0+1)*nao+(k0+0)];
                fy += gout4y * dm[(l0+1)*nao+(k0+0)];
                fz += gout4z * dm[(l0+1)*nao+(k0+0)];
                fx += gout7x * dm[(l0+1)*nao+(k0+4)];
                fy += gout7y * dm[(l0+1)*nao+(k0+4)];
                fz += gout7z * dm[(l0+1)*nao+(k0+4)];
                fx += gout10x * dm[(l0+2)*nao+(k0+2)];
                fy += gout10y * dm[(l0+2)*nao+(k0+2)];
                fz += gout10z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+3)];
                fy = gout2y * dm[(l0+0)*nao+(k0+3)];
                fz = gout2z * dm[(l0+0)*nao+(k0+3)];
                fx += gout5x * dm[(l0+1)*nao+(k0+1)];
                fy += gout5y * dm[(l0+1)*nao+(k0+1)];
                fz += gout5z * dm[(l0+1)*nao+(k0+1)];
                fx += gout8x * dm[(l0+1)*nao+(k0+5)];
                fy += gout8y * dm[(l0+1)*nao+(k0+5)];
                fz += gout8z * dm[(l0+1)*nao+(k0+5)];
                fx += gout11x * dm[(l0+2)*nao+(k0+3)];
                fy += gout11y * dm[(l0+2)*nao+(k0+3)];
                fz += gout11z * dm[(l0+2)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(i0+0)];
                fy = gout1y * dm[(j0+1)*nao+(i0+0)];
                fz = gout1z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+2)*nao+(i0+0)];
                fy = gout2y * dm[(j0+2)*nao+(i0+0)];
                fz = gout2z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+1)*nao+(i0+0)];
                fy = gout4y * dm[(j0+1)*nao+(i0+0)];
                fz = gout4z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout5x * dm[(j0+2)*nao+(i0+0)];
                fy = gout5y * dm[(j0+2)*nao+(i0+0)];
                fz = gout5z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+1)*nao+(i0+0)];
                fy = gout7y * dm[(j0+1)*nao+(i0+0)];
                fz = gout7z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+2)*nao+(i0+0)];
                fy = gout8y * dm[(j0+2)*nao+(i0+0)];
                fz = gout8z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+1)*nao+(i0+0)];
                fy = gout10y * dm[(j0+1)*nao+(i0+0)];
                fz = gout10z * dm[(j0+1)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+2)*nao+(i0+0)];
                fy = gout11y * dm[(j0+2)*nao+(i0+0)];
                fz = gout11z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+2), fz);
                break;
                }
            }
            if (do_k) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+4)];
                fy += gout3y * dm[(j0+0)*nao+(k0+4)];
                fz += gout3z * dm[(j0+0)*nao+(k0+4)];
                fx += gout1x * dm[(j0+1)*nao+(k0+1)];
                fy += gout1y * dm[(j0+1)*nao+(k0+1)];
                fz += gout1z * dm[(j0+1)*nao+(k0+1)];
                fx += gout4x * dm[(j0+1)*nao+(k0+5)];
                fy += gout4y * dm[(j0+1)*nao+(k0+5)];
                fz += gout4z * dm[(j0+1)*nao+(k0+5)];
                fx += gout2x * dm[(j0+2)*nao+(k0+2)];
                fy += gout2y * dm[(j0+2)*nao+(k0+2)];
                fz += gout2z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+2)];
                fy = gout6y * dm[(j0+0)*nao+(k0+2)];
                fz = gout6z * dm[(j0+0)*nao+(k0+2)];
                fx += gout7x * dm[(j0+1)*nao+(k0+3)];
                fy += gout7y * dm[(j0+1)*nao+(k0+3)];
                fz += gout7z * dm[(j0+1)*nao+(k0+3)];
                fx += gout5x * dm[(j0+2)*nao+(k0+0)];
                fy += gout5y * dm[(j0+2)*nao+(k0+0)];
                fz += gout5z * dm[(j0+2)*nao+(k0+0)];
                fx += gout8x * dm[(j0+2)*nao+(k0+4)];
                fy += gout8y * dm[(j0+2)*nao+(k0+4)];
                fz += gout8z * dm[(j0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+0)];
                fy = gout9y * dm[(j0+0)*nao+(k0+0)];
                fz = gout9z * dm[(j0+0)*nao+(k0+0)];
                fx += gout12x * dm[(j0+0)*nao+(k0+4)];
                fy += gout12y * dm[(j0+0)*nao+(k0+4)];
                fz += gout12z * dm[(j0+0)*nao+(k0+4)];
                fx += gout10x * dm[(j0+1)*nao+(k0+1)];
                fy += gout10y * dm[(j0+1)*nao+(k0+1)];
                fz += gout10z * dm[(j0+1)*nao+(k0+1)];
                fx += gout13x * dm[(j0+1)*nao+(k0+5)];
                fy += gout13y * dm[(j0+1)*nao+(k0+5)];
                fz += gout13z * dm[(j0+1)*nao+(k0+5)];
                fx += gout11x * dm[(j0+2)*nao+(k0+2)];
                fy += gout11y * dm[(j0+2)*nao+(k0+2)];
                fz += gout11z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+4)];
                fy += gout3y * dm[(i0+0)*nao+(k0+4)];
                fz += gout3z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+2)];
                fy = gout6y * dm[(i0+0)*nao+(k0+2)];
                fz = gout6z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+4)];
                fy += gout12y * dm[(i0+0)*nao+(k0+4)];
                fz += gout12z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+1)];
                fy = gout1y * dm[(i0+0)*nao+(k0+1)];
                fz = gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout4x * dm[(i0+0)*nao+(k0+5)];
                fy += gout4y * dm[(i0+0)*nao+(k0+5)];
                fz += gout4z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(k0+3)];
                fy = gout7y * dm[(i0+0)*nao+(k0+3)];
                fz = gout7z * dm[(i0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+1)];
                fy = gout10y * dm[(i0+0)*nao+(k0+1)];
                fz = gout10z * dm[(i0+0)*nao+(k0+1)];
                fx += gout13x * dm[(i0+0)*nao+(k0+5)];
                fy += gout13y * dm[(i0+0)*nao+(k0+5)];
                fz += gout13z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+2)];
                fy = gout2y * dm[(i0+0)*nao+(k0+2)];
                fz = gout2z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+0)];
                fy = gout5y * dm[(i0+0)*nao+(k0+0)];
                fz = gout5z * dm[(i0+0)*nao+(k0+0)];
                fx += gout8x * dm[(i0+0)*nao+(k0+4)];
                fy += gout8y * dm[(i0+0)*nao+(k0+4)];
                fz += gout8z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+1), fz);
                fx = gout11x * dm[(i0+0)*nao+(k0+2)];
                fy = gout11y * dm[(i0+0)*nao+(k0+2)];
                fz = gout11z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+2)];
                fy += gout9y * dm[(j0+0)*nao+(l0+2)];
                fz += gout9z * dm[(j0+0)*nao+(l0+2)];
                fx += gout5x * dm[(j0+2)*nao+(l0+1)];
                fy += gout5y * dm[(j0+2)*nao+(l0+1)];
                fz += gout5z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout10x * dm[(j0+1)*nao+(l0+2)];
                fy += gout10y * dm[(j0+1)*nao+(l0+2)];
                fz += gout10z * dm[(j0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                fx += gout2x * dm[(j0+2)*nao+(l0+0)];
                fy += gout2y * dm[(j0+2)*nao+(l0+0)];
                fz += gout2z * dm[(j0+2)*nao+(l0+0)];
                fx += gout11x * dm[(j0+2)*nao+(l0+2)];
                fy += gout11y * dm[(j0+2)*nao+(l0+2)];
                fz += gout11z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout7x * dm[(j0+1)*nao+(l0+1)];
                fy = gout7y * dm[(j0+1)*nao+(l0+1)];
                fz = gout7z * dm[(j0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                fx += gout8x * dm[(j0+2)*nao+(l0+1)];
                fy += gout8y * dm[(j0+2)*nao+(l0+1)];
                fz += gout8z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout4x * dm[(j0+1)*nao+(l0+0)];
                fy = gout4y * dm[(j0+1)*nao+(l0+0)];
                fz = gout4z * dm[(j0+1)*nao+(l0+0)];
                fx += gout13x * dm[(j0+1)*nao+(l0+2)];
                fy += gout13y * dm[(j0+1)*nao+(l0+2)];
                fz += gout13z * dm[(j0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+2)];
                fy += gout9y * dm[(i0+0)*nao+(l0+2)];
                fz += gout9z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+2)];
                fy += gout10y * dm[(i0+0)*nao+(l0+2)];
                fz += gout10z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+1)];
                fy = gout7y * dm[(i0+0)*nao+(l0+1)];
                fz = gout7z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+3), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+0)*nao+(l0+2)];
                fy += gout13y * dm[(i0+0)*nao+(l0+2)];
                fz += gout13z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+5), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+1)];
                fy = gout5y * dm[(i0+0)*nao+(l0+1)];
                fz = gout5z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+2)];
                fy += gout11y * dm[(i0+0)*nao+(l0+2)];
                fz += gout11z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+1)];
                fy = gout8y * dm[(i0+0)*nao+(l0+1)];
                fz = gout8z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+4), fz);
                break;
                case 1:
                fx = gout2x * dm[(j0+0)*nao+(k0+3)];
                fy = gout2y * dm[(j0+0)*nao+(k0+3)];
                fz = gout2z * dm[(j0+0)*nao+(k0+3)];
                fx += gout0x * dm[(j0+1)*nao+(k0+0)];
                fy += gout0y * dm[(j0+1)*nao+(k0+0)];
                fz += gout0z * dm[(j0+1)*nao+(k0+0)];
                fx += gout3x * dm[(j0+1)*nao+(k0+4)];
                fy += gout3y * dm[(j0+1)*nao+(k0+4)];
                fz += gout3z * dm[(j0+1)*nao+(k0+4)];
                fx += gout1x * dm[(j0+2)*nao+(k0+1)];
                fy += gout1y * dm[(j0+2)*nao+(k0+1)];
                fz += gout1z * dm[(j0+2)*nao+(k0+1)];
                fx += gout4x * dm[(j0+2)*nao+(k0+5)];
                fy += gout4y * dm[(j0+2)*nao+(k0+5)];
                fz += gout4z * dm[(j0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+1)];
                fy = gout5y * dm[(j0+0)*nao+(k0+1)];
                fz = gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout8x * dm[(j0+0)*nao+(k0+5)];
                fy += gout8y * dm[(j0+0)*nao+(k0+5)];
                fz += gout8z * dm[(j0+0)*nao+(k0+5)];
                fx += gout6x * dm[(j0+1)*nao+(k0+2)];
                fy += gout6y * dm[(j0+1)*nao+(k0+2)];
                fz += gout6z * dm[(j0+1)*nao+(k0+2)];
                fx += gout7x * dm[(j0+2)*nao+(k0+3)];
                fy += gout7y * dm[(j0+2)*nao+(k0+3)];
                fz += gout7z * dm[(j0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+3)];
                fy = gout11y * dm[(j0+0)*nao+(k0+3)];
                fz = gout11z * dm[(j0+0)*nao+(k0+3)];
                fx += gout9x * dm[(j0+1)*nao+(k0+0)];
                fy += gout9y * dm[(j0+1)*nao+(k0+0)];
                fz += gout9z * dm[(j0+1)*nao+(k0+0)];
                fx += gout12x * dm[(j0+1)*nao+(k0+4)];
                fy += gout12y * dm[(j0+1)*nao+(k0+4)];
                fz += gout12z * dm[(j0+1)*nao+(k0+4)];
                fx += gout10x * dm[(j0+2)*nao+(k0+1)];
                fy += gout10y * dm[(j0+2)*nao+(k0+1)];
                fz += gout10z * dm[(j0+2)*nao+(k0+1)];
                fx += gout13x * dm[(j0+2)*nao+(k0+5)];
                fy += gout13y * dm[(j0+2)*nao+(k0+5)];
                fz += gout13z * dm[(j0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+3)];
                fy = gout2y * dm[(i0+0)*nao+(k0+3)];
                fz = gout2z * dm[(i0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+1)];
                fy = gout5y * dm[(i0+0)*nao+(k0+1)];
                fz = gout5z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+0)*nao+(k0+5)];
                fy += gout8y * dm[(i0+0)*nao+(k0+5)];
                fz += gout8z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout11x * dm[(i0+0)*nao+(k0+3)];
                fy = gout11y * dm[(i0+0)*nao+(k0+3)];
                fz = gout11z * dm[(i0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+4)];
                fy += gout3y * dm[(i0+0)*nao+(k0+4)];
                fz += gout3z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+2)];
                fy = gout6y * dm[(i0+0)*nao+(k0+2)];
                fz = gout6z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+4)];
                fy += gout12y * dm[(i0+0)*nao+(k0+4)];
                fz += gout12z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+1)];
                fy = gout1y * dm[(i0+0)*nao+(k0+1)];
                fz = gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout4x * dm[(i0+0)*nao+(k0+5)];
                fy += gout4y * dm[(i0+0)*nao+(k0+5)];
                fz += gout4z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(k0+3)];
                fy = gout7y * dm[(i0+0)*nao+(k0+3)];
                fz = gout7z * dm[(i0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+1)];
                fy = gout10y * dm[(i0+0)*nao+(k0+1)];
                fz = gout10z * dm[(i0+0)*nao+(k0+1)];
                fx += gout13x * dm[(i0+0)*nao+(k0+5)];
                fy += gout13y * dm[(i0+0)*nao+(k0+5)];
                fz += gout13z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+1)*nao+(l0+0)];
                fy = gout0y * dm[(j0+1)*nao+(l0+0)];
                fz = gout0z * dm[(j0+1)*nao+(l0+0)];
                fx += gout9x * dm[(j0+1)*nao+(l0+2)];
                fy += gout9y * dm[(j0+1)*nao+(l0+2)];
                fz += gout9z * dm[(j0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+1)];
                fy = gout5y * dm[(j0+0)*nao+(l0+1)];
                fz = gout5z * dm[(j0+0)*nao+(l0+1)];
                fx += gout1x * dm[(j0+2)*nao+(l0+0)];
                fy += gout1y * dm[(j0+2)*nao+(l0+0)];
                fz += gout1z * dm[(j0+2)*nao+(l0+0)];
                fx += gout10x * dm[(j0+2)*nao+(l0+2)];
                fy += gout10y * dm[(j0+2)*nao+(l0+2)];
                fz += gout10z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+1)*nao+(l0+1)];
                fy = gout6y * dm[(j0+1)*nao+(l0+1)];
                fz = gout6z * dm[(j0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+2)];
                fy += gout11y * dm[(j0+0)*nao+(l0+2)];
                fz += gout11z * dm[(j0+0)*nao+(l0+2)];
                fx += gout7x * dm[(j0+2)*nao+(l0+1)];
                fy += gout7y * dm[(j0+2)*nao+(l0+1)];
                fz += gout7z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout3x * dm[(j0+1)*nao+(l0+0)];
                fy = gout3y * dm[(j0+1)*nao+(l0+0)];
                fz = gout3z * dm[(j0+1)*nao+(l0+0)];
                fx += gout12x * dm[(j0+1)*nao+(l0+2)];
                fy += gout12y * dm[(j0+1)*nao+(l0+2)];
                fz += gout12z * dm[(j0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+1)];
                fy = gout8y * dm[(j0+0)*nao+(l0+1)];
                fz = gout8z * dm[(j0+0)*nao+(l0+1)];
                fx += gout4x * dm[(j0+2)*nao+(l0+0)];
                fy += gout4y * dm[(j0+2)*nao+(l0+0)];
                fz += gout4z * dm[(j0+2)*nao+(l0+0)];
                fx += gout13x * dm[(j0+2)*nao+(l0+2)];
                fy += gout13y * dm[(j0+2)*nao+(l0+2)];
                fz += gout13z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+1)];
                fy = gout5y * dm[(i0+0)*nao+(l0+1)];
                fz = gout5z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+2)];
                fy += gout11y * dm[(i0+0)*nao+(l0+2)];
                fz += gout11z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+1)];
                fy = gout8y * dm[(i0+0)*nao+(l0+1)];
                fz = gout8z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+2)];
                fy += gout9y * dm[(i0+0)*nao+(l0+2)];
                fz += gout9z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+4), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+2)];
                fy += gout10y * dm[(i0+0)*nao+(l0+2)];
                fz += gout10z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+1)];
                fy = gout7y * dm[(i0+0)*nao+(l0+1)];
                fz = gout7z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+3), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+0)*nao+(l0+2)];
                fy += gout13y * dm[(i0+0)*nao+(l0+2)];
                fz += gout13z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+5), fz);
                break;
                case 2:
                fx = gout1x * dm[(j0+0)*nao+(k0+2)];
                fy = gout1y * dm[(j0+0)*nao+(k0+2)];
                fz = gout1z * dm[(j0+0)*nao+(k0+2)];
                fx += gout2x * dm[(j0+1)*nao+(k0+3)];
                fy += gout2y * dm[(j0+1)*nao+(k0+3)];
                fz += gout2z * dm[(j0+1)*nao+(k0+3)];
                fx += gout0x * dm[(j0+2)*nao+(k0+0)];
                fy += gout0y * dm[(j0+2)*nao+(k0+0)];
                fz += gout0z * dm[(j0+2)*nao+(k0+0)];
                fx += gout3x * dm[(j0+2)*nao+(k0+4)];
                fy += gout3y * dm[(j0+2)*nao+(k0+4)];
                fz += gout3z * dm[(j0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+0)];
                fy = gout4y * dm[(j0+0)*nao+(k0+0)];
                fz = gout4z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+0)*nao+(k0+4)];
                fy += gout7y * dm[(j0+0)*nao+(k0+4)];
                fz += gout7z * dm[(j0+0)*nao+(k0+4)];
                fx += gout5x * dm[(j0+1)*nao+(k0+1)];
                fy += gout5y * dm[(j0+1)*nao+(k0+1)];
                fz += gout5z * dm[(j0+1)*nao+(k0+1)];
                fx += gout8x * dm[(j0+1)*nao+(k0+5)];
                fy += gout8y * dm[(j0+1)*nao+(k0+5)];
                fz += gout8z * dm[(j0+1)*nao+(k0+5)];
                fx += gout6x * dm[(j0+2)*nao+(k0+2)];
                fy += gout6y * dm[(j0+2)*nao+(k0+2)];
                fz += gout6z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(k0+2)];
                fy = gout10y * dm[(j0+0)*nao+(k0+2)];
                fz = gout10z * dm[(j0+0)*nao+(k0+2)];
                fx += gout11x * dm[(j0+1)*nao+(k0+3)];
                fy += gout11y * dm[(j0+1)*nao+(k0+3)];
                fz += gout11z * dm[(j0+1)*nao+(k0+3)];
                fx += gout9x * dm[(j0+2)*nao+(k0+0)];
                fy += gout9y * dm[(j0+2)*nao+(k0+0)];
                fz += gout9z * dm[(j0+2)*nao+(k0+0)];
                fx += gout12x * dm[(j0+2)*nao+(k0+4)];
                fy += gout12y * dm[(j0+2)*nao+(k0+4)];
                fz += gout12z * dm[(j0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+2)];
                fy = gout1y * dm[(i0+0)*nao+(k0+2)];
                fz = gout1z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+0)];
                fy = gout4y * dm[(i0+0)*nao+(k0+0)];
                fz = gout4z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+0)*nao+(k0+4)];
                fy += gout7y * dm[(i0+0)*nao+(k0+4)];
                fz += gout7z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+2)];
                fy = gout10y * dm[(i0+0)*nao+(k0+2)];
                fz = gout10z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+3)];
                fy = gout2y * dm[(i0+0)*nao+(k0+3)];
                fz = gout2z * dm[(i0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+1)];
                fy = gout5y * dm[(i0+0)*nao+(k0+1)];
                fz = gout5z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+0)*nao+(k0+5)];
                fy += gout8y * dm[(i0+0)*nao+(k0+5)];
                fz += gout8z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+1), fz);
                fx = gout11x * dm[(i0+0)*nao+(k0+3)];
                fy = gout11y * dm[(i0+0)*nao+(k0+3)];
                fz = gout11z * dm[(i0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+4)];
                fy += gout3y * dm[(i0+0)*nao+(k0+4)];
                fz += gout3z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+2)];
                fy = gout6y * dm[(i0+0)*nao+(k0+2)];
                fz = gout6z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+4)];
                fy += gout12y * dm[(i0+0)*nao+(k0+4)];
                fz += gout12z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+2), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+1)];
                fy = gout4y * dm[(j0+0)*nao+(l0+1)];
                fz = gout4z * dm[(j0+0)*nao+(l0+1)];
                fx += gout0x * dm[(j0+2)*nao+(l0+0)];
                fy += gout0y * dm[(j0+2)*nao+(l0+0)];
                fz += gout0z * dm[(j0+2)*nao+(l0+0)];
                fx += gout9x * dm[(j0+2)*nao+(l0+2)];
                fy += gout9y * dm[(j0+2)*nao+(l0+2)];
                fz += gout9z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+1)*nao+(l0+1)];
                fy = gout5y * dm[(j0+1)*nao+(l0+1)];
                fz = gout5z * dm[(j0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+2)];
                fy += gout10y * dm[(j0+0)*nao+(l0+2)];
                fz += gout10z * dm[(j0+0)*nao+(l0+2)];
                fx += gout6x * dm[(j0+2)*nao+(l0+1)];
                fy += gout6y * dm[(j0+2)*nao+(l0+1)];
                fz += gout6z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+1)*nao+(l0+0)];
                fy = gout2y * dm[(j0+1)*nao+(l0+0)];
                fz = gout2z * dm[(j0+1)*nao+(l0+0)];
                fx += gout11x * dm[(j0+1)*nao+(l0+2)];
                fy += gout11y * dm[(j0+1)*nao+(l0+2)];
                fz += gout11z * dm[(j0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                fx += gout3x * dm[(j0+2)*nao+(l0+0)];
                fy += gout3y * dm[(j0+2)*nao+(l0+0)];
                fz += gout3z * dm[(j0+2)*nao+(l0+0)];
                fx += gout12x * dm[(j0+2)*nao+(l0+2)];
                fy += gout12y * dm[(j0+2)*nao+(l0+2)];
                fz += gout12z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout8x * dm[(j0+1)*nao+(l0+1)];
                fy = gout8y * dm[(j0+1)*nao+(l0+1)];
                fz = gout8z * dm[(j0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+1)];
                fy = gout4y * dm[(i0+0)*nao+(l0+1)];
                fz = gout4z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+2)];
                fy += gout10y * dm[(i0+0)*nao+(l0+2)];
                fz += gout10z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+1)];
                fy = gout7y * dm[(i0+0)*nao+(l0+1)];
                fz = gout7z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+1)];
                fy = gout5y * dm[(i0+0)*nao+(l0+1)];
                fz = gout5z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+2)];
                fy += gout11y * dm[(i0+0)*nao+(l0+2)];
                fz += gout11z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+3), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+1)];
                fy = gout8y * dm[(i0+0)*nao+(l0+1)];
                fz = gout8z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+2)];
                fy += gout9y * dm[(i0+0)*nao+(l0+2)];
                fz += gout9z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+4), fz);
                break;
                case 3:
                fx = gout0x * dm[(j0+0)*nao+(k0+1)];
                fy = gout0y * dm[(j0+0)*nao+(k0+1)];
                fz = gout0z * dm[(j0+0)*nao+(k0+1)];
                fx += gout3x * dm[(j0+0)*nao+(k0+5)];
                fy += gout3y * dm[(j0+0)*nao+(k0+5)];
                fz += gout3z * dm[(j0+0)*nao+(k0+5)];
                fx += gout1x * dm[(j0+1)*nao+(k0+2)];
                fy += gout1y * dm[(j0+1)*nao+(k0+2)];
                fz += gout1z * dm[(j0+1)*nao+(k0+2)];
                fx += gout2x * dm[(j0+2)*nao+(k0+3)];
                fy += gout2y * dm[(j0+2)*nao+(k0+3)];
                fz += gout2z * dm[(j0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+3)];
                fy = gout6y * dm[(j0+0)*nao+(k0+3)];
                fz = gout6z * dm[(j0+0)*nao+(k0+3)];
                fx += gout4x * dm[(j0+1)*nao+(k0+0)];
                fy += gout4y * dm[(j0+1)*nao+(k0+0)];
                fz += gout4z * dm[(j0+1)*nao+(k0+0)];
                fx += gout7x * dm[(j0+1)*nao+(k0+4)];
                fy += gout7y * dm[(j0+1)*nao+(k0+4)];
                fz += gout7z * dm[(j0+1)*nao+(k0+4)];
                fx += gout5x * dm[(j0+2)*nao+(k0+1)];
                fy += gout5y * dm[(j0+2)*nao+(k0+1)];
                fz += gout5z * dm[(j0+2)*nao+(k0+1)];
                fx += gout8x * dm[(j0+2)*nao+(k0+5)];
                fy += gout8y * dm[(j0+2)*nao+(k0+5)];
                fz += gout8z * dm[(j0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+1)];
                fy = gout9y * dm[(j0+0)*nao+(k0+1)];
                fz = gout9z * dm[(j0+0)*nao+(k0+1)];
                fx += gout12x * dm[(j0+0)*nao+(k0+5)];
                fy += gout12y * dm[(j0+0)*nao+(k0+5)];
                fz += gout12z * dm[(j0+0)*nao+(k0+5)];
                fx += gout10x * dm[(j0+1)*nao+(k0+2)];
                fy += gout10y * dm[(j0+1)*nao+(k0+2)];
                fz += gout10z * dm[(j0+1)*nao+(k0+2)];
                fx += gout11x * dm[(j0+2)*nao+(k0+3)];
                fy += gout11y * dm[(j0+2)*nao+(k0+3)];
                fz += gout11z * dm[(j0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+1)];
                fy = gout0y * dm[(i0+0)*nao+(k0+1)];
                fz = gout0z * dm[(i0+0)*nao+(k0+1)];
                fx += gout3x * dm[(i0+0)*nao+(k0+5)];
                fy += gout3y * dm[(i0+0)*nao+(k0+5)];
                fz += gout3z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+3)];
                fy = gout6y * dm[(i0+0)*nao+(k0+3)];
                fz = gout6z * dm[(i0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+1)];
                fy = gout9y * dm[(i0+0)*nao+(k0+1)];
                fz = gout9z * dm[(i0+0)*nao+(k0+1)];
                fx += gout12x * dm[(i0+0)*nao+(k0+5)];
                fy += gout12y * dm[(i0+0)*nao+(k0+5)];
                fz += gout12z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+2)];
                fy = gout1y * dm[(i0+0)*nao+(k0+2)];
                fz = gout1z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+0)];
                fy = gout4y * dm[(i0+0)*nao+(k0+0)];
                fz = gout4z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+0)*nao+(k0+4)];
                fy += gout7y * dm[(i0+0)*nao+(k0+4)];
                fz += gout7z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+2)];
                fy = gout10y * dm[(i0+0)*nao+(k0+2)];
                fz = gout10z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+3)];
                fy = gout2y * dm[(i0+0)*nao+(k0+3)];
                fz = gout2z * dm[(i0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+1)];
                fy = gout5y * dm[(i0+0)*nao+(k0+1)];
                fz = gout5z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+0)*nao+(k0+5)];
                fy += gout8y * dm[(i0+0)*nao+(k0+5)];
                fz += gout8z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+1), fz);
                fx = gout11x * dm[(i0+0)*nao+(k0+3)];
                fy = gout11y * dm[(i0+0)*nao+(k0+3)];
                fz = gout11z * dm[(i0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+2), fz);
                fx = gout4x * dm[(j0+1)*nao+(l0+1)];
                fy = gout4y * dm[(j0+1)*nao+(l0+1)];
                fz = gout4z * dm[(j0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+2)];
                fy += gout9y * dm[(j0+0)*nao+(l0+2)];
                fz += gout9z * dm[(j0+0)*nao+(l0+2)];
                fx += gout5x * dm[(j0+2)*nao+(l0+1)];
                fy += gout5y * dm[(j0+2)*nao+(l0+1)];
                fz += gout5z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout10x * dm[(j0+1)*nao+(l0+2)];
                fy += gout10y * dm[(j0+1)*nao+(l0+2)];
                fz += gout10z * dm[(j0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                fx += gout2x * dm[(j0+2)*nao+(l0+0)];
                fy += gout2y * dm[(j0+2)*nao+(l0+0)];
                fz += gout2z * dm[(j0+2)*nao+(l0+0)];
                fx += gout11x * dm[(j0+2)*nao+(l0+2)];
                fy += gout11y * dm[(j0+2)*nao+(l0+2)];
                fz += gout11z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout7x * dm[(j0+1)*nao+(l0+1)];
                fy = gout7y * dm[(j0+1)*nao+(l0+1)];
                fz = gout7z * dm[(j0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                fx += gout8x * dm[(j0+2)*nao+(l0+1)];
                fy += gout8y * dm[(j0+2)*nao+(l0+1)];
                fz += gout8z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+2)];
                fy += gout9y * dm[(i0+0)*nao+(l0+2)];
                fz += gout9z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+1)];
                fy = gout4y * dm[(i0+0)*nao+(l0+1)];
                fz = gout4z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+2)];
                fy += gout10y * dm[(i0+0)*nao+(l0+2)];
                fz += gout10z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+1)];
                fy = gout7y * dm[(i0+0)*nao+(l0+1)];
                fz = gout7z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+4), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+1)];
                fy = gout5y * dm[(i0+0)*nao+(l0+1)];
                fz = gout5z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+2)];
                fy += gout11y * dm[(i0+0)*nao+(l0+2)];
                fz += gout11z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+3), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+1)];
                fy = gout8y * dm[(i0+0)*nao+(l0+1)];
                fz = gout8z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+5), fz);
                break;
                }
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0121(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0121(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0200(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    ai2 = rjri[5];
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_30x = c0x * trr_20x + 2*b10 * trr_10x;
                    double hrr_2100x = trr_30x - rjri[0] * trr_20x;
                    double hrr_1100x = trr_20x - rjri[0] * trr_10x;
                    double hrr_1200x = hrr_2100x - rjri[0] * hrr_1100x;
                    fx = ai2 * hrr_1200x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double hrr_0100x = trr_10x - rjri[0] * 1;
                    double hrr_0200x = hrr_1100x - rjri[0] * hrr_0100x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_0200x *  fy  * wt;
                    gout0z += hrr_0200x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    double hrr_1100y = trr_20y - rjri[1] * trr_10y;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_10z;
                    double hrr_0100y = trr_10y - rjri[1] * 1;
                    gout1x +=  fx  * hrr_0100y * wt;
                    gout1y += hrr_0100x *  fy  * wt;
                    gout1z += hrr_0100x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    double hrr_1100z = trr_20z - rjri[2] * trr_10z;
                    fz = ai2 * hrr_1100z;
                    double hrr_0100z = trr_10z - rjri[2] * wt;
                    gout2x +=  fx  * 1 * hrr_0100z;
                    gout2y += hrr_0100x *  fy  * hrr_0100z;
                    gout2z += hrr_0100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_30y = c0y * trr_20y + 2*b10 * trr_10y;
                    double hrr_2100y = trr_30y - rjri[1] * trr_20y;
                    double hrr_1200y = hrr_2100y - rjri[1] * hrr_1100y;
                    fy = ai2 * hrr_1200y;
                    fz = ai2 * trr_10z;
                    double hrr_0200y = hrr_1100y - rjri[1] * hrr_0100y;
                    gout3x +=  fx  * hrr_0200y * wt;
                    gout3y += 1 *  fy  * wt;
                    gout3z += 1 * hrr_0200y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * hrr_1100z;
                    gout4x +=  fx  * hrr_0100y * hrr_0100z;
                    gout4y += 1 *  fy  * hrr_0100z;
                    gout4z += 1 * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_30z = c0z * trr_20z + 2*b10 * trr_10z;
                    double hrr_2100z = trr_30z - rjri[2] * trr_20z;
                    double hrr_1200z = hrr_2100z - rjri[2] * hrr_1100z;
                    fz = ai2 * hrr_1200z;
                    double hrr_0200z = hrr_1100z - rjri[2] * hrr_0100z;
                    gout5x +=  fx  * 1 * hrr_0200z;
                    gout5y += 1 *  fy  * hrr_0200z;
                    gout5z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+3), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+4), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+1)*nao+(i0+0)];
                fy += gout1y * dm[(j0+1)*nao+(i0+0)];
                fz += gout1z * dm[(j0+1)*nao+(i0+0)];
                fx += gout2x * dm[(j0+2)*nao+(i0+0)];
                fy += gout2y * dm[(j0+2)*nao+(i0+0)];
                fz += gout2z * dm[(j0+2)*nao+(i0+0)];
                fx += gout3x * dm[(j0+3)*nao+(i0+0)];
                fy += gout3y * dm[(j0+3)*nao+(i0+0)];
                fz += gout3z * dm[(j0+3)*nao+(i0+0)];
                fx += gout4x * dm[(j0+4)*nao+(i0+0)];
                fy += gout4y * dm[(j0+4)*nao+(i0+0)];
                fz += gout4z * dm[(j0+4)*nao+(i0+0)];
                fx += gout5x * dm[(j0+5)*nao+(i0+0)];
                fy += gout5y * dm[(j0+5)*nao+(i0+0)];
                fz += gout5z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout1x * dm[(j0+1)*nao+(k0+0)];
                fy += gout1y * dm[(j0+1)*nao+(k0+0)];
                fz += gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout2x * dm[(j0+2)*nao+(k0+0)];
                fy += gout2y * dm[(j0+2)*nao+(k0+0)];
                fz += gout2z * dm[(j0+2)*nao+(k0+0)];
                fx += gout3x * dm[(j0+3)*nao+(k0+0)];
                fy += gout3y * dm[(j0+3)*nao+(k0+0)];
                fz += gout3z * dm[(j0+3)*nao+(k0+0)];
                fx += gout4x * dm[(j0+4)*nao+(k0+0)];
                fy += gout4y * dm[(j0+4)*nao+(k0+0)];
                fz += gout4z * dm[(j0+4)*nao+(k0+0)];
                fx += gout5x * dm[(j0+5)*nao+(k0+0)];
                fy += gout5y * dm[(j0+5)*nao+(k0+0)];
                fz += gout5z * dm[(j0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+0)];
                fy = gout2y * dm[(i0+0)*nao+(k0+0)];
                fz = gout2z * dm[(i0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+0)];
                fy = gout3y * dm[(i0+0)*nao+(k0+0)];
                fz = gout3z * dm[(i0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+0)];
                fy = gout4y * dm[(i0+0)*nao+(k0+0)];
                fz = gout4z * dm[(i0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+0)];
                fy = gout5y * dm[(i0+0)*nao+(k0+0)];
                fz = gout5z * dm[(i0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout1x * dm[(j0+1)*nao+(l0+0)];
                fy += gout1y * dm[(j0+1)*nao+(l0+0)];
                fz += gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout2x * dm[(j0+2)*nao+(l0+0)];
                fy += gout2y * dm[(j0+2)*nao+(l0+0)];
                fz += gout2z * dm[(j0+2)*nao+(l0+0)];
                fx += gout3x * dm[(j0+3)*nao+(l0+0)];
                fy += gout3y * dm[(j0+3)*nao+(l0+0)];
                fz += gout3z * dm[(j0+3)*nao+(l0+0)];
                fx += gout4x * dm[(j0+4)*nao+(l0+0)];
                fy += gout4y * dm[(j0+4)*nao+(l0+0)];
                fz += gout4z * dm[(j0+4)*nao+(l0+0)];
                fx += gout5x * dm[(j0+5)*nao+(l0+0)];
                fy += gout5y * dm[(j0+5)*nao+(l0+0)];
                fz += gout5z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0200(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0200(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0210(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_30x = c0x * trr_20x + 2*b10 * trr_10x;
                    double trr_31x = cpx * trr_30x + 3*b00 * trr_20x;
                    double trr_21x = cpx * trr_20x + 2*b00 * trr_10x;
                    double hrr_2110x = trr_31x - rjri[0] * trr_21x;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double hrr_1110x = trr_21x - rjri[0] * trr_11x;
                    double hrr_1210x = hrr_2110x - rjri[0] * hrr_1110x;
                    fx = ai2 * hrr_1210x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_01x = cpx * 1;
                    double hrr_0110x = trr_11x - rjri[0] * trr_01x;
                    double hrr_0210x = hrr_1110x - rjri[0] * hrr_0110x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_0210x *  fy  * wt;
                    gout0z += hrr_0210x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1110x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    double hrr_1100y = trr_20y - rjri[1] * trr_10y;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_10z;
                    double hrr_0100y = trr_10y - rjri[1] * 1;
                    gout1x +=  fx  * hrr_0100y * wt;
                    gout1y += hrr_0110x *  fy  * wt;
                    gout1z += hrr_0110x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1110x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    double hrr_1100z = trr_20z - rjri[2] * trr_10z;
                    fz = ai2 * hrr_1100z;
                    double hrr_0100z = trr_10z - rjri[2] * wt;
                    gout2x +=  fx  * 1 * hrr_0100z;
                    gout2y += hrr_0110x *  fy  * hrr_0100z;
                    gout2z += hrr_0110x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double trr_30y = c0y * trr_20y + 2*b10 * trr_10y;
                    double hrr_2100y = trr_30y - rjri[1] * trr_20y;
                    double hrr_1200y = hrr_2100y - rjri[1] * hrr_1100y;
                    fy = ai2 * hrr_1200y;
                    fz = ai2 * trr_10z;
                    double hrr_0200y = hrr_1100y - rjri[1] * hrr_0100y;
                    gout3x +=  fx  * hrr_0200y * wt;
                    gout3y += trr_01x *  fy  * wt;
                    gout3z += trr_01x * hrr_0200y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * hrr_1100z;
                    gout4x +=  fx  * hrr_0100y * hrr_0100z;
                    gout4y += trr_01x *  fy  * hrr_0100z;
                    gout4z += trr_01x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double trr_30z = c0z * trr_20z + 2*b10 * trr_10z;
                    double hrr_2100z = trr_30z - rjri[2] * trr_20z;
                    double hrr_1200z = hrr_2100z - rjri[2] * hrr_1100z;
                    fz = ai2 * hrr_1200z;
                    double hrr_0200z = hrr_1100z - rjri[2] * hrr_0100z;
                    gout5x +=  fx  * 1 * hrr_0200z;
                    gout5y += trr_01x *  fy  * hrr_0200z;
                    gout5z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_2100x = trr_30x - rjri[0] * trr_20x;
                    double hrr_1100x = trr_20x - rjri[0] * trr_10x;
                    double hrr_1200x = hrr_2100x - rjri[0] * hrr_1100x;
                    fx = ai2 * hrr_1200x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    double hrr_0100x = trr_10x - rjri[0] * 1;
                    double hrr_0200x = hrr_1100x - rjri[0] * hrr_0100x;
                    double trr_01y = cpy * 1;
                    gout6x +=  fx  * trr_01y * wt;
                    gout6y += hrr_0200x *  fy  * wt;
                    gout6z += hrr_0200x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    double trr_21y = cpy * trr_20y + 2*b00 * trr_10y;
                    double hrr_1110y = trr_21y - rjri[1] * trr_11y;
                    fy = ai2 * hrr_1110y;
                    fz = ai2 * trr_10z;
                    double hrr_0110y = trr_11y - rjri[1] * trr_01y;
                    gout7x +=  fx  * hrr_0110y * wt;
                    gout7y += hrr_0100x *  fy  * wt;
                    gout7z += hrr_0100x * hrr_0110y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1100z;
                    gout8x +=  fx  * trr_01y * hrr_0100z;
                    gout8y += hrr_0100x *  fy  * hrr_0100z;
                    gout8z += hrr_0100x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_31y = cpy * trr_30y + 3*b00 * trr_20y;
                    double hrr_2110y = trr_31y - rjri[1] * trr_21y;
                    double hrr_1210y = hrr_2110y - rjri[1] * hrr_1110y;
                    fy = ai2 * hrr_1210y;
                    fz = ai2 * trr_10z;
                    double hrr_0210y = hrr_1110y - rjri[1] * hrr_0110y;
                    gout9x +=  fx  * hrr_0210y * wt;
                    gout9y += 1 *  fy  * wt;
                    gout9z += 1 * hrr_0210y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1110y;
                    fz = ai2 * hrr_1100z;
                    gout10x +=  fx  * hrr_0110y * hrr_0100z;
                    gout10y += 1 *  fy  * hrr_0100z;
                    gout10z += 1 * hrr_0110y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1200z;
                    gout11x +=  fx  * trr_01y * hrr_0200z;
                    gout11y += 1 *  fy  * hrr_0200z;
                    gout11z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1200x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    double trr_01z = cpz * wt;
                    gout12x +=  fx  * 1 * trr_01z;
                    gout12y += hrr_0200x *  fy  * trr_01z;
                    gout12z += hrr_0200x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_11z;
                    gout13x +=  fx  * hrr_0100y * trr_01z;
                    gout13y += hrr_0100x *  fy  * trr_01z;
                    gout13z += hrr_0100x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_10y;
                    double trr_21z = cpz * trr_20z + 2*b00 * trr_10z;
                    double hrr_1110z = trr_21z - rjri[2] * trr_11z;
                    fz = ai2 * hrr_1110z;
                    double hrr_0110z = trr_11z - rjri[2] * trr_01z;
                    gout14x +=  fx  * 1 * hrr_0110z;
                    gout14y += hrr_0100x *  fy  * hrr_0110z;
                    gout14z += hrr_0100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1200y;
                    fz = ai2 * trr_11z;
                    gout15x +=  fx  * hrr_0200y * trr_01z;
                    gout15y += 1 *  fy  * trr_01z;
                    gout15z += 1 * hrr_0200y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * hrr_1110z;
                    gout16x +=  fx  * hrr_0100y * hrr_0110z;
                    gout16y += 1 *  fy  * hrr_0110z;
                    gout16z += 1 * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_31z = cpz * trr_30z + 3*b00 * trr_20z;
                    double hrr_2110z = trr_31z - rjri[2] * trr_21z;
                    double hrr_1210z = hrr_2110z - rjri[2] * hrr_1110z;
                    fz = ai2 * hrr_1210z;
                    double hrr_0210z = hrr_1110z - rjri[2] * hrr_0110z;
                    gout17x +=  fx  * 1 * hrr_0210z;
                    gout17y += 1 *  fy  * hrr_0210z;
                    gout17z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout6x * dm[(l0+0)*nao+(k0+1)];
                fy += gout6y * dm[(l0+0)*nao+(k0+1)];
                fz += gout6z * dm[(l0+0)*nao+(k0+1)];
                fx += gout12x * dm[(l0+0)*nao+(k0+2)];
                fy += gout12y * dm[(l0+0)*nao+(k0+2)];
                fz += gout12z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout7x * dm[(l0+0)*nao+(k0+1)];
                fy += gout7y * dm[(l0+0)*nao+(k0+1)];
                fz += gout7z * dm[(l0+0)*nao+(k0+1)];
                fx += gout13x * dm[(l0+0)*nao+(k0+2)];
                fy += gout13y * dm[(l0+0)*nao+(k0+2)];
                fz += gout13z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout8x * dm[(l0+0)*nao+(k0+1)];
                fy += gout8y * dm[(l0+0)*nao+(k0+1)];
                fz += gout8z * dm[(l0+0)*nao+(k0+1)];
                fx += gout14x * dm[(l0+0)*nao+(k0+2)];
                fy += gout14y * dm[(l0+0)*nao+(k0+2)];
                fz += gout14z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+1)];
                fy += gout9y * dm[(l0+0)*nao+(k0+1)];
                fz += gout9z * dm[(l0+0)*nao+(k0+1)];
                fx += gout15x * dm[(l0+0)*nao+(k0+2)];
                fy += gout15y * dm[(l0+0)*nao+(k0+2)];
                fz += gout15z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+3), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+1)];
                fy += gout10y * dm[(l0+0)*nao+(k0+1)];
                fz += gout10z * dm[(l0+0)*nao+(k0+1)];
                fx += gout16x * dm[(l0+0)*nao+(k0+2)];
                fy += gout16y * dm[(l0+0)*nao+(k0+2)];
                fz += gout16z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+4), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+1)];
                fy += gout11y * dm[(l0+0)*nao+(k0+1)];
                fz += gout11z * dm[(l0+0)*nao+(k0+1)];
                fx += gout17x * dm[(l0+0)*nao+(k0+2)];
                fy += gout17y * dm[(l0+0)*nao+(k0+2)];
                fz += gout17z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+1)*nao+(i0+0)];
                fy += gout1y * dm[(j0+1)*nao+(i0+0)];
                fz += gout1z * dm[(j0+1)*nao+(i0+0)];
                fx += gout2x * dm[(j0+2)*nao+(i0+0)];
                fy += gout2y * dm[(j0+2)*nao+(i0+0)];
                fz += gout2z * dm[(j0+2)*nao+(i0+0)];
                fx += gout3x * dm[(j0+3)*nao+(i0+0)];
                fy += gout3y * dm[(j0+3)*nao+(i0+0)];
                fz += gout3z * dm[(j0+3)*nao+(i0+0)];
                fx += gout4x * dm[(j0+4)*nao+(i0+0)];
                fy += gout4y * dm[(j0+4)*nao+(i0+0)];
                fz += gout4z * dm[(j0+4)*nao+(i0+0)];
                fx += gout5x * dm[(j0+5)*nao+(i0+0)];
                fy += gout5y * dm[(j0+5)*nao+(i0+0)];
                fz += gout5z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+1)*nao+(i0+0)];
                fy += gout7y * dm[(j0+1)*nao+(i0+0)];
                fz += gout7z * dm[(j0+1)*nao+(i0+0)];
                fx += gout8x * dm[(j0+2)*nao+(i0+0)];
                fy += gout8y * dm[(j0+2)*nao+(i0+0)];
                fz += gout8z * dm[(j0+2)*nao+(i0+0)];
                fx += gout9x * dm[(j0+3)*nao+(i0+0)];
                fy += gout9y * dm[(j0+3)*nao+(i0+0)];
                fz += gout9z * dm[(j0+3)*nao+(i0+0)];
                fx += gout10x * dm[(j0+4)*nao+(i0+0)];
                fy += gout10y * dm[(j0+4)*nao+(i0+0)];
                fz += gout10z * dm[(j0+4)*nao+(i0+0)];
                fx += gout11x * dm[(j0+5)*nao+(i0+0)];
                fy += gout11y * dm[(j0+5)*nao+(i0+0)];
                fz += gout11z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                fx += gout13x * dm[(j0+1)*nao+(i0+0)];
                fy += gout13y * dm[(j0+1)*nao+(i0+0)];
                fz += gout13z * dm[(j0+1)*nao+(i0+0)];
                fx += gout14x * dm[(j0+2)*nao+(i0+0)];
                fy += gout14y * dm[(j0+2)*nao+(i0+0)];
                fz += gout14z * dm[(j0+2)*nao+(i0+0)];
                fx += gout15x * dm[(j0+3)*nao+(i0+0)];
                fy += gout15y * dm[(j0+3)*nao+(i0+0)];
                fz += gout15z * dm[(j0+3)*nao+(i0+0)];
                fx += gout16x * dm[(j0+4)*nao+(i0+0)];
                fy += gout16y * dm[(j0+4)*nao+(i0+0)];
                fz += gout16z * dm[(j0+4)*nao+(i0+0)];
                fx += gout17x * dm[(j0+5)*nao+(i0+0)];
                fy += gout17y * dm[(j0+5)*nao+(i0+0)];
                fz += gout17z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout6x * dm[(j0+0)*nao+(k0+1)];
                fy += gout6y * dm[(j0+0)*nao+(k0+1)];
                fz += gout6z * dm[(j0+0)*nao+(k0+1)];
                fx += gout12x * dm[(j0+0)*nao+(k0+2)];
                fy += gout12y * dm[(j0+0)*nao+(k0+2)];
                fz += gout12z * dm[(j0+0)*nao+(k0+2)];
                fx += gout1x * dm[(j0+1)*nao+(k0+0)];
                fy += gout1y * dm[(j0+1)*nao+(k0+0)];
                fz += gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout7x * dm[(j0+1)*nao+(k0+1)];
                fy += gout7y * dm[(j0+1)*nao+(k0+1)];
                fz += gout7z * dm[(j0+1)*nao+(k0+1)];
                fx += gout13x * dm[(j0+1)*nao+(k0+2)];
                fy += gout13y * dm[(j0+1)*nao+(k0+2)];
                fz += gout13z * dm[(j0+1)*nao+(k0+2)];
                fx += gout2x * dm[(j0+2)*nao+(k0+0)];
                fy += gout2y * dm[(j0+2)*nao+(k0+0)];
                fz += gout2z * dm[(j0+2)*nao+(k0+0)];
                fx += gout8x * dm[(j0+2)*nao+(k0+1)];
                fy += gout8y * dm[(j0+2)*nao+(k0+1)];
                fz += gout8z * dm[(j0+2)*nao+(k0+1)];
                fx += gout14x * dm[(j0+2)*nao+(k0+2)];
                fy += gout14y * dm[(j0+2)*nao+(k0+2)];
                fz += gout14z * dm[(j0+2)*nao+(k0+2)];
                fx += gout3x * dm[(j0+3)*nao+(k0+0)];
                fy += gout3y * dm[(j0+3)*nao+(k0+0)];
                fz += gout3z * dm[(j0+3)*nao+(k0+0)];
                fx += gout9x * dm[(j0+3)*nao+(k0+1)];
                fy += gout9y * dm[(j0+3)*nao+(k0+1)];
                fz += gout9z * dm[(j0+3)*nao+(k0+1)];
                fx += gout15x * dm[(j0+3)*nao+(k0+2)];
                fy += gout15y * dm[(j0+3)*nao+(k0+2)];
                fz += gout15z * dm[(j0+3)*nao+(k0+2)];
                fx += gout4x * dm[(j0+4)*nao+(k0+0)];
                fy += gout4y * dm[(j0+4)*nao+(k0+0)];
                fz += gout4z * dm[(j0+4)*nao+(k0+0)];
                fx += gout10x * dm[(j0+4)*nao+(k0+1)];
                fy += gout10y * dm[(j0+4)*nao+(k0+1)];
                fz += gout10z * dm[(j0+4)*nao+(k0+1)];
                fx += gout16x * dm[(j0+4)*nao+(k0+2)];
                fy += gout16y * dm[(j0+4)*nao+(k0+2)];
                fz += gout16z * dm[(j0+4)*nao+(k0+2)];
                fx += gout5x * dm[(j0+5)*nao+(k0+0)];
                fy += gout5y * dm[(j0+5)*nao+(k0+0)];
                fz += gout5z * dm[(j0+5)*nao+(k0+0)];
                fx += gout11x * dm[(j0+5)*nao+(k0+1)];
                fy += gout11y * dm[(j0+5)*nao+(k0+1)];
                fz += gout11z * dm[(j0+5)*nao+(k0+1)];
                fx += gout17x * dm[(j0+5)*nao+(k0+2)];
                fy += gout17y * dm[(j0+5)*nao+(k0+2)];
                fz += gout17z * dm[(j0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout6x * dm[(i0+0)*nao+(k0+1)];
                fy += gout6y * dm[(i0+0)*nao+(k0+1)];
                fz += gout6z * dm[(i0+0)*nao+(k0+1)];
                fx += gout12x * dm[(i0+0)*nao+(k0+2)];
                fy += gout12y * dm[(i0+0)*nao+(k0+2)];
                fz += gout12z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+0)*nao+(k0+1)];
                fy += gout7y * dm[(i0+0)*nao+(k0+1)];
                fz += gout7z * dm[(i0+0)*nao+(k0+1)];
                fx += gout13x * dm[(i0+0)*nao+(k0+2)];
                fy += gout13y * dm[(i0+0)*nao+(k0+2)];
                fz += gout13z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+0)];
                fy = gout2y * dm[(i0+0)*nao+(k0+0)];
                fz = gout2z * dm[(i0+0)*nao+(k0+0)];
                fx += gout8x * dm[(i0+0)*nao+(k0+1)];
                fy += gout8y * dm[(i0+0)*nao+(k0+1)];
                fz += gout8z * dm[(i0+0)*nao+(k0+1)];
                fx += gout14x * dm[(i0+0)*nao+(k0+2)];
                fy += gout14y * dm[(i0+0)*nao+(k0+2)];
                fz += gout14z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+0)];
                fy = gout3y * dm[(i0+0)*nao+(k0+0)];
                fz = gout3z * dm[(i0+0)*nao+(k0+0)];
                fx += gout9x * dm[(i0+0)*nao+(k0+1)];
                fy += gout9y * dm[(i0+0)*nao+(k0+1)];
                fz += gout9z * dm[(i0+0)*nao+(k0+1)];
                fx += gout15x * dm[(i0+0)*nao+(k0+2)];
                fy += gout15y * dm[(i0+0)*nao+(k0+2)];
                fz += gout15z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+0)];
                fy = gout4y * dm[(i0+0)*nao+(k0+0)];
                fz = gout4z * dm[(i0+0)*nao+(k0+0)];
                fx += gout10x * dm[(i0+0)*nao+(k0+1)];
                fy += gout10y * dm[(i0+0)*nao+(k0+1)];
                fz += gout10z * dm[(i0+0)*nao+(k0+1)];
                fx += gout16x * dm[(i0+0)*nao+(k0+2)];
                fy += gout16y * dm[(i0+0)*nao+(k0+2)];
                fz += gout16z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+0)];
                fy = gout5y * dm[(i0+0)*nao+(k0+0)];
                fz = gout5z * dm[(i0+0)*nao+(k0+0)];
                fx += gout11x * dm[(i0+0)*nao+(k0+1)];
                fy += gout11y * dm[(i0+0)*nao+(k0+1)];
                fz += gout11z * dm[(i0+0)*nao+(k0+1)];
                fx += gout17x * dm[(i0+0)*nao+(k0+2)];
                fy += gout17y * dm[(i0+0)*nao+(k0+2)];
                fz += gout17z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout1x * dm[(j0+1)*nao+(l0+0)];
                fy += gout1y * dm[(j0+1)*nao+(l0+0)];
                fz += gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout2x * dm[(j0+2)*nao+(l0+0)];
                fy += gout2y * dm[(j0+2)*nao+(l0+0)];
                fz += gout2z * dm[(j0+2)*nao+(l0+0)];
                fx += gout3x * dm[(j0+3)*nao+(l0+0)];
                fy += gout3y * dm[(j0+3)*nao+(l0+0)];
                fz += gout3z * dm[(j0+3)*nao+(l0+0)];
                fx += gout4x * dm[(j0+4)*nao+(l0+0)];
                fy += gout4y * dm[(j0+4)*nao+(l0+0)];
                fz += gout4z * dm[(j0+4)*nao+(l0+0)];
                fx += gout5x * dm[(j0+5)*nao+(l0+0)];
                fy += gout5y * dm[(j0+5)*nao+(l0+0)];
                fz += gout5z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                fx += gout7x * dm[(j0+1)*nao+(l0+0)];
                fy += gout7y * dm[(j0+1)*nao+(l0+0)];
                fz += gout7z * dm[(j0+1)*nao+(l0+0)];
                fx += gout8x * dm[(j0+2)*nao+(l0+0)];
                fy += gout8y * dm[(j0+2)*nao+(l0+0)];
                fz += gout8z * dm[(j0+2)*nao+(l0+0)];
                fx += gout9x * dm[(j0+3)*nao+(l0+0)];
                fy += gout9y * dm[(j0+3)*nao+(l0+0)];
                fz += gout9z * dm[(j0+3)*nao+(l0+0)];
                fx += gout10x * dm[(j0+4)*nao+(l0+0)];
                fy += gout10y * dm[(j0+4)*nao+(l0+0)];
                fz += gout10z * dm[(j0+4)*nao+(l0+0)];
                fx += gout11x * dm[(j0+5)*nao+(l0+0)];
                fy += gout11y * dm[(j0+5)*nao+(l0+0)];
                fz += gout11z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout12x * dm[(j0+0)*nao+(l0+0)];
                fy = gout12y * dm[(j0+0)*nao+(l0+0)];
                fz = gout12z * dm[(j0+0)*nao+(l0+0)];
                fx += gout13x * dm[(j0+1)*nao+(l0+0)];
                fy += gout13y * dm[(j0+1)*nao+(l0+0)];
                fz += gout13z * dm[(j0+1)*nao+(l0+0)];
                fx += gout14x * dm[(j0+2)*nao+(l0+0)];
                fy += gout14y * dm[(j0+2)*nao+(l0+0)];
                fz += gout14z * dm[(j0+2)*nao+(l0+0)];
                fx += gout15x * dm[(j0+3)*nao+(l0+0)];
                fy += gout15y * dm[(j0+3)*nao+(l0+0)];
                fz += gout15z * dm[(j0+3)*nao+(l0+0)];
                fx += gout16x * dm[(j0+4)*nao+(l0+0)];
                fy += gout16y * dm[(j0+4)*nao+(l0+0)];
                fz += gout16z * dm[(j0+4)*nao+(l0+0)];
                fx += gout17x * dm[(j0+5)*nao+(l0+0)];
                fy += gout17y * dm[(j0+5)*nao+(l0+0)];
                fz += gout17z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout13x * dm[(i0+0)*nao+(l0+0)];
                fy = gout13y * dm[(i0+0)*nao+(l0+0)];
                fz = gout13z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+0)];
                fy = gout8y * dm[(i0+0)*nao+(l0+0)];
                fz = gout8z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout14x * dm[(i0+0)*nao+(l0+0)];
                fy = gout14y * dm[(i0+0)*nao+(l0+0)];
                fz = gout14z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+0)];
                fy = gout9y * dm[(i0+0)*nao+(l0+0)];
                fz = gout9z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+1), fz);
                fx = gout15x * dm[(i0+0)*nao+(l0+0)];
                fy = gout15y * dm[(i0+0)*nao+(l0+0)];
                fz = gout15z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+2), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout10x * dm[(i0+0)*nao+(l0+0)];
                fy = gout10y * dm[(i0+0)*nao+(l0+0)];
                fz = gout10z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+1), fz);
                fx = gout16x * dm[(i0+0)*nao+(l0+0)];
                fy = gout16y * dm[(i0+0)*nao+(l0+0)];
                fz = gout16z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+2), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
                fx = gout11x * dm[(i0+0)*nao+(l0+0)];
                fy = gout11y * dm[(i0+0)*nao+(l0+0)];
                fz = gout11z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+1), fz);
                fx = gout17x * dm[(i0+0)*nao+(l0+0)];
                fy = gout17y * dm[(i0+0)*nao+(l0+0)];
                fz = gout17z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+2), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0210(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0210(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0211(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;
    double *gx = rw + 128 * nroots;
    double *gy = gx + 1536;
    double *gz = gy + 1536;
    double *rlrk = gz + 1536;
    double *Rpq = rlrk + 192;
    if (gout_id == 0) {
        gx[0] = 1.;
        gy[0] = 1.;
    }
    double s0, s1, s2;
    double Ix, Iy, Iz;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        if (gout_id == 0) {
            rlrk[0] = xlxk;
            rlrk[64] = ylyk;
            rlrk[128] = zlzk;
        }
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            __syncthreads();
            double xlxk = rlrk[0];
            double ylyk = rlrk[64];
            double zlzk = rlrk[128];
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xkl = rk[0] + rlrk[0] * al_akl;
                double ykl = rk[1] + rlrk[64] * al_akl;
                double zkl = rk[2] + rlrk[128] * al_akl;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                __syncthreads();
                if (gout_id == 0) {
                    Rpq[0] = xpq;
                    Rpq[64] = ypq;
                    Rpq[128] = zpq;
                }
                rys_roots_rs(nroots, theta, rr, omega, rw, 64, gout_id, 4);
                for (int irys = 0; irys < nroots; ++irys) {
                    __syncthreads();
                    double rt = rw[irys*128];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double rt_akl = rt_aa * aij;
                    double b00 = .5 * rt_aa;
                    double b01 = .5/akl * (1 - rt_akl);
                    for (int n = gout_id; n < 3; n += 4) {
                        if (n == 2) {
                            gz[0] = rw[irys*128+64] * fac;
                        }
                        double *_gx = gx + n * 1536;
                        double xjxi = rjri[n];
                        double Rpa = xjxi * aj_aij;
                        double c0x = Rpa - rt_aij * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = c0x * s0;
                        _gx[64] = s1;
                        s2 = c0x * s1 + 1 * b10 * s0;
                        _gx[128] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 2 * b10 * s0;
                        _gx[192] = s2;
                        double xlxk = rlrk[n*64];
                        double Rqc = xlxk * al_akl;
                        double cpx = Rqc + rt_akl * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = cpx * s0;
                        _gx[384] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        _gx[768] = s2;
                        s0 = _gx[64];
                        s1 = cpx * s0;
                        s1 += 1 * b00 * _gx[0];
                        _gx[448] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 1 * b00 * _gx[384];
                        _gx[832] = s2;
                        s0 = _gx[128];
                        s1 = cpx * s0;
                        s1 += 2 * b00 * _gx[64];
                        _gx[512] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 2 * b00 * _gx[448];
                        _gx[896] = s2;
                        s0 = _gx[192];
                        s1 = cpx * s0;
                        s1 += 3 * b00 * _gx[128];
                        _gx[576] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 3 * b00 * _gx[512];
                        _gx[960] = s2;
                        s1 = _gx[192];
                        s0 = _gx[128];
                        _gx[256] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[192] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[128] = s1 - xjxi * s0;
                        s1 = _gx[256];
                        s0 = _gx[192];
                        _gx[320] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[128];
                        _gx[256] = s1 - xjxi * s0;
                        s1 = _gx[576];
                        s0 = _gx[512];
                        _gx[640] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[448];
                        _gx[576] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[384];
                        _gx[512] = s1 - xjxi * s0;
                        s1 = _gx[640];
                        s0 = _gx[576];
                        _gx[704] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[512];
                        _gx[640] = s1 - xjxi * s0;
                        s1 = _gx[960];
                        s0 = _gx[896];
                        _gx[1024] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[832];
                        _gx[960] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[768];
                        _gx[896] = s1 - xjxi * s0;
                        s1 = _gx[1024];
                        s0 = _gx[960];
                        _gx[1088] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[896];
                        _gx[1024] = s1 - xjxi * s0;
                        s1 = _gx[768];
                        s0 = _gx[384];
                        _gx[1152] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[768] = s1 - xlxk * s0;
                        s1 = _gx[832];
                        s0 = _gx[448];
                        _gx[1216] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[832] = s1 - xlxk * s0;
                        s1 = _gx[896];
                        s0 = _gx[512];
                        _gx[1280] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[128];
                        _gx[896] = s1 - xlxk * s0;
                        s1 = _gx[960];
                        s0 = _gx[576];
                        _gx[1344] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[192];
                        _gx[960] = s1 - xlxk * s0;
                        s1 = _gx[1024];
                        s0 = _gx[640];
                        _gx[1408] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[256];
                        _gx[1024] = s1 - xlxk * s0;
                        s1 = _gx[1088];
                        s0 = _gx[704];
                        _gx[1472] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[320];
                        _gx[1088] = s1 - xlxk * s0;
                    }
                    __syncthreads();
                    switch (gout_id) {
                    case 0:
                    ai2 = rjri[5];
                    Ix = gx[1408];
                    Iy = gy[0];
                    Iz = gz[0];
                    gout0x += ai2 * gx[1472] * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1152];
                    Iy = gy[128];
                    Iz = gz[128];
                    gout1x += ai2 * gx[1216] * Iy * Iz;
                    gout1y += ai2 * gy[192] * Ix * Iz;
                    gout1z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[896];
                    Iy = gy[384];
                    Iz = gz[128];
                    gout2x += ai2 * gx[960] * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[0];
                    Iz = gz[384];
                    gout3x += ai2 * gx[1088] * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[128];
                    Iz = gz[512];
                    gout4x += ai2 * gx[832] * Iy * Iz;
                    gout4y += ai2 * gy[192] * Ix * Iz;
                    gout4z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[768];
                    Iz = gz[128];
                    gout5x += ai2 * gx[576] * Iy * Iz;
                    gout5y += ai2 * gy[832] * Ix * Iz;
                    gout5z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[1152];
                    Iz = gz[0];
                    gout6x += ai2 * gx[320] * Iy * Iz;
                    gout6y += ai2 * gy[1216] * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1280];
                    Iz = gz[128];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[1344] * Ix * Iz;
                    gout7z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[768];
                    Iz = gz[512];
                    gout8x += ai2 * gx[192] * Iy * Iz;
                    gout8y += ai2 * gy[832] * Ix * Iz;
                    gout8z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[0];
                    Iz = gz[768];
                    gout9x += ai2 * gx[704] * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[128];
                    Iz = gz[896];
                    gout10x += ai2 * gx[448] * Iy * Iz;
                    gout10y += ai2 * gy[192] * Ix * Iz;
                    gout10z += ai2 * gz[960] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[384];
                    Iz = gz[896];
                    gout11x += ai2 * gx[192] * Iy * Iz;
                    gout11y += ai2 * gy[448] * Ix * Iz;
                    gout11z += ai2 * gz[960] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[0];
                    Iz = gz[1152];
                    gout12x += ai2 * gx[320] * Iy * Iz;
                    gout12y += ai2 * gy[64] * Ix * Iz;
                    gout12z += ai2 * gz[1216] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[128];
                    Iz = gz[1280];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += ai2 * gy[192] * Ix * Iz;
                    gout13z += ai2 * gz[1344] * Ix * Iy;
                    break;
                    case 1:
                    ai2 = rjri[5];
                    Ix = gx[1280];
                    Iy = gy[128];
                    Iz = gz[0];
                    gout0x += ai2 * gx[1344] * Iy * Iz;
                    gout0y += ai2 * gy[192] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1152];
                    Iy = gy[0];
                    Iz = gz[256];
                    gout1x += ai2 * gx[1216] * Iy * Iz;
                    gout1y += ai2 * gy[64] * Ix * Iz;
                    gout1z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[640];
                    Iz = gz[0];
                    gout2x += ai2 * gx[832] * Iy * Iz;
                    gout2y += ai2 * gy[704] * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[896];
                    Iy = gy[128];
                    Iz = gz[384];
                    gout3x += ai2 * gx[960] * Iy * Iz;
                    gout3y += ai2 * gy[192] * Ix * Iz;
                    gout3z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[0];
                    Iz = gz[640];
                    gout4x += ai2 * gx[832] * Iy * Iz;
                    gout4y += ai2 * gy[64] * Ix * Iz;
                    gout4z += ai2 * gz[704] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[1024];
                    Iz = gz[0];
                    gout5x += ai2 * gx[448] * Iy * Iz;
                    gout5y += ai2 * gy[1088] * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[1280];
                    Iz = gz[0];
                    gout6x += ai2 * gx[192] * Iy * Iz;
                    gout6y += ai2 * gy[1344] * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1152];
                    Iz = gz[256];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[1216] * Ix * Iz;
                    gout7z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1024];
                    Iz = gz[384];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[1088] * Ix * Iz;
                    gout8z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[128];
                    Iz = gz[768];
                    gout9x += ai2 * gx[576] * Iy * Iz;
                    gout9y += ai2 * gy[192] * Ix * Iz;
                    gout9z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[0];
                    Iz = gz[1024];
                    gout10x += ai2 * gx[448] * Iy * Iz;
                    gout10y += ai2 * gy[64] * Ix * Iz;
                    gout10z += ai2 * gz[1088] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[640];
                    Iz = gz[768];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += ai2 * gy[704] * Ix * Iz;
                    gout11z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[128];
                    Iz = gz[1152];
                    gout12x += ai2 * gx[192] * Iy * Iz;
                    gout12y += ai2 * gy[192] * Ix * Iz;
                    gout12z += ai2 * gz[1216] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[0];
                    Iz = gz[1408];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += ai2 * gy[64] * Ix * Iz;
                    gout13z += ai2 * gz[1472] * Ix * Iy;
                    break;
                    case 2:
                    ai2 = rjri[5];
                    Ix = gx[1280];
                    Iy = gy[0];
                    Iz = gz[128];
                    gout0x += ai2 * gx[1344] * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[384];
                    Iz = gz[0];
                    gout1x += ai2 * gx[1088] * Iy * Iz;
                    gout1y += ai2 * gy[448] * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[512];
                    Iz = gz[128];
                    gout2x += ai2 * gx[832] * Iy * Iz;
                    gout2y += ai2 * gy[576] * Ix * Iz;
                    gout2z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[896];
                    Iy = gy[0];
                    Iz = gz[512];
                    gout3x += ai2 * gx[960] * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[768];
                    Iz = gz[0];
                    gout4x += ai2 * gx[704] * Iy * Iz;
                    gout4y += ai2 * gy[832] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[896];
                    Iz = gz[128];
                    gout5x += ai2 * gx[448] * Iy * Iz;
                    gout5y += ai2 * gy[960] * Ix * Iz;
                    gout5z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[1152];
                    Iz = gz[128];
                    gout6x += ai2 * gx[192] * Iy * Iz;
                    gout6y += ai2 * gy[1216] * Ix * Iz;
                    gout6z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[768];
                    Iz = gz[384];
                    gout7x += ai2 * gx[320] * Iy * Iz;
                    gout7y += ai2 * gy[832] * Ix * Iz;
                    gout7z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[896];
                    Iz = gz[512];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[960] * Ix * Iz;
                    gout8z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[0];
                    Iz = gz[896];
                    gout9x += ai2 * gx[576] * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += ai2 * gz[960] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[384];
                    Iz = gz[768];
                    gout10x += ai2 * gx[320] * Iy * Iz;
                    gout10y += ai2 * gy[448] * Ix * Iz;
                    gout10z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[512];
                    Iz = gz[896];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += ai2 * gy[576] * Ix * Iz;
                    gout11z += ai2 * gz[960] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[0];
                    Iz = gz[1280];
                    gout12x += ai2 * gx[192] * Iy * Iz;
                    gout12y += ai2 * gy[64] * Ix * Iz;
                    gout12z += ai2 * gz[1344] * Ix * Iy;
                    break;
                    case 3:
                    ai2 = rjri[5];
                    Ix = gx[1152];
                    Iy = gy[256];
                    Iz = gz[0];
                    gout0x += ai2 * gx[1216] * Iy * Iz;
                    gout0y += ai2 * gy[320] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[896];
                    Iy = gy[512];
                    Iz = gz[0];
                    gout1x += ai2 * gx[960] * Iy * Iz;
                    gout1y += ai2 * gy[576] * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[384];
                    Iz = gz[256];
                    gout2x += ai2 * gx[832] * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[256];
                    Iz = gz[384];
                    gout3x += ai2 * gx[832] * Iy * Iz;
                    gout3y += ai2 * gy[320] * Ix * Iz;
                    gout3z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[896];
                    Iz = gz[0];
                    gout4x += ai2 * gx[576] * Iy * Iz;
                    gout4y += ai2 * gy[960] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[768];
                    Iz = gz[256];
                    gout5x += ai2 * gx[448] * Iy * Iz;
                    gout5y += ai2 * gy[832] * Ix * Iz;
                    gout5z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1408];
                    Iz = gz[0];
                    gout6x += ai2 * gx[64] * Iy * Iz;
                    gout6y += ai2 * gy[1472] * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[896];
                    Iz = gz[384];
                    gout7x += ai2 * gx[192] * Iy * Iz;
                    gout7y += ai2 * gy[960] * Ix * Iz;
                    gout7z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[768];
                    Iz = gz[640];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[832] * Ix * Iz;
                    gout8z += ai2 * gz[704] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[256];
                    Iz = gz[768];
                    gout9x += ai2 * gx[448] * Iy * Iz;
                    gout9y += ai2 * gy[320] * Ix * Iz;
                    gout9z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[512];
                    Iz = gz[768];
                    gout10x += ai2 * gx[192] * Iy * Iz;
                    gout10y += ai2 * gy[576] * Ix * Iz;
                    gout10z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[384];
                    Iz = gz[1024];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += ai2 * gy[448] * Ix * Iz;
                    gout11z += ai2 * gz[1088] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[256];
                    Iz = gz[1152];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += ai2 * gy[320] * Ix * Iz;
                    gout12z += ai2 * gz[1216] * Ix * Iy;
                    break;
                    }
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+1)*nao+(k0+1)];
                fy += gout6y * dm[(l0+1)*nao+(k0+1)];
                fz += gout6z * dm[(l0+1)*nao+(k0+1)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+2)];
                fy += gout12y * dm[(l0+2)*nao+(k0+2)];
                fz += gout12z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+1)*nao+(k0+0)];
                fy += gout5y * dm[(l0+1)*nao+(k0+0)];
                fz += gout5z * dm[(l0+1)*nao+(k0+0)];
                fx += gout8x * dm[(l0+1)*nao+(k0+2)];
                fy += gout8y * dm[(l0+1)*nao+(k0+2)];
                fz += gout8z * dm[(l0+1)*nao+(k0+2)];
                fx += gout11x * dm[(l0+2)*nao+(k0+1)];
                fy += gout11y * dm[(l0+2)*nao+(k0+1)];
                fz += gout11z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+2)];
                fy += gout4y * dm[(l0+0)*nao+(k0+2)];
                fz += gout4z * dm[(l0+0)*nao+(k0+2)];
                fx += gout7x * dm[(l0+1)*nao+(k0+1)];
                fy += gout7y * dm[(l0+1)*nao+(k0+1)];
                fz += gout7z * dm[(l0+1)*nao+(k0+1)];
                fx += gout10x * dm[(l0+2)*nao+(k0+0)];
                fy += gout10y * dm[(l0+2)*nao+(k0+0)];
                fz += gout10z * dm[(l0+2)*nao+(k0+0)];
                fx += gout13x * dm[(l0+2)*nao+(k0+2)];
                fy += gout13y * dm[(l0+2)*nao+(k0+2)];
                fz += gout13z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+4), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+4)*nao+(i0+0)];
                fy += gout1y * dm[(j0+4)*nao+(i0+0)];
                fz += gout1z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+2)*nao+(i0+0)];
                fy = gout2y * dm[(j0+2)*nao+(i0+0)];
                fz = gout2z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                fx += gout4x * dm[(j0+4)*nao+(i0+0)];
                fy += gout4y * dm[(j0+4)*nao+(i0+0)];
                fz += gout4z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+2)*nao+(i0+0)];
                fy = gout5y * dm[(j0+2)*nao+(i0+0)];
                fz = gout5z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+4)*nao+(i0+0)];
                fy += gout7y * dm[(j0+4)*nao+(i0+0)];
                fz += gout7z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+2)*nao+(i0+0)];
                fy = gout8y * dm[(j0+2)*nao+(i0+0)];
                fz = gout8z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                fx += gout10x * dm[(j0+4)*nao+(i0+0)];
                fy += gout10y * dm[(j0+4)*nao+(i0+0)];
                fz += gout10z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+2)*nao+(i0+0)];
                fy = gout11y * dm[(j0+2)*nao+(i0+0)];
                fz = gout11z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                fx += gout13x * dm[(j0+4)*nao+(i0+0)];
                fy += gout13y * dm[(j0+4)*nao+(i0+0)];
                fz += gout13z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                case 1:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+1)*nao+(k0+1)];
                fy += gout6y * dm[(l0+1)*nao+(k0+1)];
                fz += gout6z * dm[(l0+1)*nao+(k0+1)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+2)];
                fy += gout12y * dm[(l0+2)*nao+(k0+2)];
                fz += gout12z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+1)*nao+(k0+0)];
                fy += gout5y * dm[(l0+1)*nao+(k0+0)];
                fz += gout5z * dm[(l0+1)*nao+(k0+0)];
                fx += gout8x * dm[(l0+1)*nao+(k0+2)];
                fy += gout8y * dm[(l0+1)*nao+(k0+2)];
                fz += gout8z * dm[(l0+1)*nao+(k0+2)];
                fx += gout11x * dm[(l0+2)*nao+(k0+1)];
                fy += gout11y * dm[(l0+2)*nao+(k0+1)];
                fz += gout11z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+3), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+2)];
                fy += gout4y * dm[(l0+0)*nao+(k0+2)];
                fz += gout4z * dm[(l0+0)*nao+(k0+2)];
                fx += gout7x * dm[(l0+1)*nao+(k0+1)];
                fy += gout7y * dm[(l0+1)*nao+(k0+1)];
                fz += gout7z * dm[(l0+1)*nao+(k0+1)];
                fx += gout10x * dm[(l0+2)*nao+(k0+0)];
                fy += gout10y * dm[(l0+2)*nao+(k0+0)];
                fz += gout10z * dm[(l0+2)*nao+(k0+0)];
                fx += gout13x * dm[(l0+2)*nao+(k0+2)];
                fy += gout13y * dm[(l0+2)*nao+(k0+2)];
                fz += gout13z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+5), fz);
                fx = gout0x * dm[(j0+1)*nao+(i0+0)];
                fy = gout0y * dm[(j0+1)*nao+(i0+0)];
                fz = gout0z * dm[(j0+1)*nao+(i0+0)];
                fx += gout1x * dm[(j0+5)*nao+(i0+0)];
                fy += gout1y * dm[(j0+5)*nao+(i0+0)];
                fz += gout1z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+3)*nao+(i0+0)];
                fy = gout2y * dm[(j0+3)*nao+(i0+0)];
                fz = gout2z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+1)*nao+(i0+0)];
                fy = gout3y * dm[(j0+1)*nao+(i0+0)];
                fz = gout3z * dm[(j0+1)*nao+(i0+0)];
                fx += gout4x * dm[(j0+5)*nao+(i0+0)];
                fy += gout4y * dm[(j0+5)*nao+(i0+0)];
                fz += gout4z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+3)*nao+(i0+0)];
                fy = gout5y * dm[(j0+3)*nao+(i0+0)];
                fz = gout5z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+1)*nao+(i0+0)];
                fy = gout6y * dm[(j0+1)*nao+(i0+0)];
                fz = gout6z * dm[(j0+1)*nao+(i0+0)];
                fx += gout7x * dm[(j0+5)*nao+(i0+0)];
                fy += gout7y * dm[(j0+5)*nao+(i0+0)];
                fz += gout7z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+3)*nao+(i0+0)];
                fy = gout8y * dm[(j0+3)*nao+(i0+0)];
                fz = gout8z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+1)*nao+(i0+0)];
                fy = gout9y * dm[(j0+1)*nao+(i0+0)];
                fz = gout9z * dm[(j0+1)*nao+(i0+0)];
                fx += gout10x * dm[(j0+5)*nao+(i0+0)];
                fy += gout10y * dm[(j0+5)*nao+(i0+0)];
                fz += gout10z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+3)*nao+(i0+0)];
                fy = gout11y * dm[(j0+3)*nao+(i0+0)];
                fz = gout11z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+1)*nao+(i0+0)];
                fy = gout12y * dm[(j0+1)*nao+(i0+0)];
                fz = gout12z * dm[(j0+1)*nao+(i0+0)];
                fx += gout13x * dm[(j0+5)*nao+(i0+0)];
                fy += gout13y * dm[(j0+5)*nao+(i0+0)];
                fz += gout13z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                case 2:
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+1)*nao+(k0+0)];
                fy += gout4y * dm[(l0+1)*nao+(k0+0)];
                fz += gout4z * dm[(l0+1)*nao+(k0+0)];
                fx += gout7x * dm[(l0+1)*nao+(k0+2)];
                fy += gout7y * dm[(l0+1)*nao+(k0+2)];
                fz += gout7z * dm[(l0+1)*nao+(k0+2)];
                fx += gout10x * dm[(l0+2)*nao+(k0+1)];
                fy += gout10y * dm[(l0+2)*nao+(k0+1)];
                fz += gout10z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+1)*nao+(k0+1)];
                fy += gout6y * dm[(l0+1)*nao+(k0+1)];
                fz += gout6z * dm[(l0+1)*nao+(k0+1)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+2)];
                fy += gout12y * dm[(l0+2)*nao+(k0+2)];
                fz += gout12z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+1)*nao+(k0+0)];
                fy += gout5y * dm[(l0+1)*nao+(k0+0)];
                fz += gout5z * dm[(l0+1)*nao+(k0+0)];
                fx += gout8x * dm[(l0+1)*nao+(k0+2)];
                fy += gout8y * dm[(l0+1)*nao+(k0+2)];
                fz += gout8z * dm[(l0+1)*nao+(k0+2)];
                fx += gout11x * dm[(l0+2)*nao+(k0+1)];
                fy += gout11y * dm[(l0+2)*nao+(k0+1)];
                fz += gout11z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+4), fz);
                fx = gout0x * dm[(j0+2)*nao+(i0+0)];
                fy = gout0y * dm[(j0+2)*nao+(i0+0)];
                fz = gout0z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                fx += gout2x * dm[(j0+4)*nao+(i0+0)];
                fy += gout2y * dm[(j0+4)*nao+(i0+0)];
                fz += gout2z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+2)*nao+(i0+0)];
                fy = gout3y * dm[(j0+2)*nao+(i0+0)];
                fz = gout3z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                fx += gout5x * dm[(j0+4)*nao+(i0+0)];
                fy += gout5y * dm[(j0+4)*nao+(i0+0)];
                fz += gout5z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+2)*nao+(i0+0)];
                fy = gout6y * dm[(j0+2)*nao+(i0+0)];
                fz = gout6z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+0)];
                fy = gout7y * dm[(j0+0)*nao+(i0+0)];
                fz = gout7z * dm[(j0+0)*nao+(i0+0)];
                fx += gout8x * dm[(j0+4)*nao+(i0+0)];
                fy += gout8y * dm[(j0+4)*nao+(i0+0)];
                fz += gout8z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+2)*nao+(i0+0)];
                fy = gout9y * dm[(j0+2)*nao+(i0+0)];
                fz = gout9z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+0)*nao+(i0+0)];
                fy = gout10y * dm[(j0+0)*nao+(i0+0)];
                fz = gout10z * dm[(j0+0)*nao+(i0+0)];
                fx += gout11x * dm[(j0+4)*nao+(i0+0)];
                fy += gout11y * dm[(j0+4)*nao+(i0+0)];
                fz += gout11z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+2)*nao+(i0+0)];
                fy = gout12y * dm[(j0+2)*nao+(i0+0)];
                fz = gout12z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                case 3:
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+1)*nao+(k0+0)];
                fy += gout4y * dm[(l0+1)*nao+(k0+0)];
                fz += gout4z * dm[(l0+1)*nao+(k0+0)];
                fx += gout7x * dm[(l0+1)*nao+(k0+2)];
                fy += gout7y * dm[(l0+1)*nao+(k0+2)];
                fz += gout7z * dm[(l0+1)*nao+(k0+2)];
                fx += gout10x * dm[(l0+2)*nao+(k0+1)];
                fy += gout10y * dm[(l0+2)*nao+(k0+1)];
                fz += gout10z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+1)*nao+(k0+1)];
                fy += gout6y * dm[(l0+1)*nao+(k0+1)];
                fz += gout6z * dm[(l0+1)*nao+(k0+1)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+2)];
                fy += gout12y * dm[(l0+2)*nao+(k0+2)];
                fz += gout12z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+3), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+1)*nao+(k0+0)];
                fy += gout5y * dm[(l0+1)*nao+(k0+0)];
                fz += gout5z * dm[(l0+1)*nao+(k0+0)];
                fx += gout8x * dm[(l0+1)*nao+(k0+2)];
                fy += gout8y * dm[(l0+1)*nao+(k0+2)];
                fz += gout8z * dm[(l0+1)*nao+(k0+2)];
                fx += gout11x * dm[(l0+2)*nao+(k0+1)];
                fy += gout11y * dm[(l0+2)*nao+(k0+1)];
                fz += gout11z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+5), fz);
                fx = gout0x * dm[(j0+3)*nao+(i0+0)];
                fy = gout0y * dm[(j0+3)*nao+(i0+0)];
                fz = gout0z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(i0+0)];
                fy = gout1y * dm[(j0+1)*nao+(i0+0)];
                fz = gout1z * dm[(j0+1)*nao+(i0+0)];
                fx += gout2x * dm[(j0+5)*nao+(i0+0)];
                fy += gout2y * dm[(j0+5)*nao+(i0+0)];
                fz += gout2z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+3)*nao+(i0+0)];
                fy = gout3y * dm[(j0+3)*nao+(i0+0)];
                fz = gout3z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+1)*nao+(i0+0)];
                fy = gout4y * dm[(j0+1)*nao+(i0+0)];
                fz = gout4z * dm[(j0+1)*nao+(i0+0)];
                fx += gout5x * dm[(j0+5)*nao+(i0+0)];
                fy += gout5y * dm[(j0+5)*nao+(i0+0)];
                fz += gout5z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+3)*nao+(i0+0)];
                fy = gout6y * dm[(j0+3)*nao+(i0+0)];
                fz = gout6z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+1)*nao+(i0+0)];
                fy = gout7y * dm[(j0+1)*nao+(i0+0)];
                fz = gout7z * dm[(j0+1)*nao+(i0+0)];
                fx += gout8x * dm[(j0+5)*nao+(i0+0)];
                fy += gout8y * dm[(j0+5)*nao+(i0+0)];
                fz += gout8z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+3)*nao+(i0+0)];
                fy = gout9y * dm[(j0+3)*nao+(i0+0)];
                fz = gout9z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+1)*nao+(i0+0)];
                fy = gout10y * dm[(j0+1)*nao+(i0+0)];
                fz = gout10z * dm[(j0+1)*nao+(i0+0)];
                fx += gout11x * dm[(j0+5)*nao+(i0+0)];
                fy += gout11y * dm[(j0+5)*nao+(i0+0)];
                fz += gout11z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+3)*nao+(i0+0)];
                fy = gout12y * dm[(j0+3)*nao+(i0+0)];
                fz = gout12z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                }
            }
            if (do_k) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+2)];
                fy += gout3y * dm[(j0+0)*nao+(k0+2)];
                fz += gout3z * dm[(j0+0)*nao+(k0+2)];
                fx += gout2x * dm[(j0+2)*nao+(k0+1)];
                fy += gout2y * dm[(j0+2)*nao+(k0+1)];
                fz += gout2z * dm[(j0+2)*nao+(k0+1)];
                fx += gout1x * dm[(j0+4)*nao+(k0+0)];
                fy += gout1y * dm[(j0+4)*nao+(k0+0)];
                fz += gout1z * dm[(j0+4)*nao+(k0+0)];
                fx += gout4x * dm[(j0+4)*nao+(k0+2)];
                fy += gout4y * dm[(j0+4)*nao+(k0+2)];
                fz += gout4z * dm[(j0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+1)];
                fy = gout6y * dm[(j0+0)*nao+(k0+1)];
                fz = gout6z * dm[(j0+0)*nao+(k0+1)];
                fx += gout5x * dm[(j0+2)*nao+(k0+0)];
                fy += gout5y * dm[(j0+2)*nao+(k0+0)];
                fz += gout5z * dm[(j0+2)*nao+(k0+0)];
                fx += gout8x * dm[(j0+2)*nao+(k0+2)];
                fy += gout8y * dm[(j0+2)*nao+(k0+2)];
                fz += gout8z * dm[(j0+2)*nao+(k0+2)];
                fx += gout7x * dm[(j0+4)*nao+(k0+1)];
                fy += gout7y * dm[(j0+4)*nao+(k0+1)];
                fz += gout7z * dm[(j0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+0)];
                fy = gout9y * dm[(j0+0)*nao+(k0+0)];
                fz = gout9z * dm[(j0+0)*nao+(k0+0)];
                fx += gout12x * dm[(j0+0)*nao+(k0+2)];
                fy += gout12y * dm[(j0+0)*nao+(k0+2)];
                fz += gout12z * dm[(j0+0)*nao+(k0+2)];
                fx += gout11x * dm[(j0+2)*nao+(k0+1)];
                fy += gout11y * dm[(j0+2)*nao+(k0+1)];
                fz += gout11z * dm[(j0+2)*nao+(k0+1)];
                fx += gout10x * dm[(j0+4)*nao+(k0+0)];
                fy += gout10y * dm[(j0+4)*nao+(k0+0)];
                fz += gout10z * dm[(j0+4)*nao+(k0+0)];
                fx += gout13x * dm[(j0+4)*nao+(k0+2)];
                fy += gout13y * dm[(j0+4)*nao+(k0+2)];
                fz += gout13z * dm[(j0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+2)];
                fy += gout3y * dm[(i0+0)*nao+(k0+2)];
                fz += gout3z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+1)];
                fy = gout6y * dm[(i0+0)*nao+(k0+1)];
                fz = gout6z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+2)];
                fy += gout12y * dm[(i0+0)*nao+(k0+2)];
                fz += gout12z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+1)];
                fy = gout2y * dm[(i0+0)*nao+(k0+1)];
                fz = gout2z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+0)];
                fy = gout5y * dm[(i0+0)*nao+(k0+0)];
                fz = gout5z * dm[(i0+0)*nao+(k0+0)];
                fx += gout8x * dm[(i0+0)*nao+(k0+2)];
                fy += gout8y * dm[(i0+0)*nao+(k0+2)];
                fz += gout8z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+1), fz);
                fx = gout11x * dm[(i0+0)*nao+(k0+1)];
                fy = gout11y * dm[(i0+0)*nao+(k0+1)];
                fz = gout11z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout4x * dm[(i0+0)*nao+(k0+2)];
                fy += gout4y * dm[(i0+0)*nao+(k0+2)];
                fz += gout4z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(k0+1)];
                fy = gout7y * dm[(i0+0)*nao+(k0+1)];
                fz = gout7z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+0)];
                fy = gout10y * dm[(i0+0)*nao+(k0+0)];
                fz = gout10z * dm[(i0+0)*nao+(k0+0)];
                fx += gout13x * dm[(i0+0)*nao+(k0+2)];
                fy += gout13y * dm[(i0+0)*nao+(k0+2)];
                fz += gout13z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+2)];
                fy += gout9y * dm[(j0+0)*nao+(l0+2)];
                fz += gout9z * dm[(j0+0)*nao+(l0+2)];
                fx += gout5x * dm[(j0+2)*nao+(l0+1)];
                fy += gout5y * dm[(j0+2)*nao+(l0+1)];
                fz += gout5z * dm[(j0+2)*nao+(l0+1)];
                fx += gout1x * dm[(j0+4)*nao+(l0+0)];
                fy += gout1y * dm[(j0+4)*nao+(l0+0)];
                fz += gout1z * dm[(j0+4)*nao+(l0+0)];
                fx += gout10x * dm[(j0+4)*nao+(l0+2)];
                fy += gout10y * dm[(j0+4)*nao+(l0+2)];
                fz += gout10z * dm[(j0+4)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                fx += gout2x * dm[(j0+2)*nao+(l0+0)];
                fy += gout2y * dm[(j0+2)*nao+(l0+0)];
                fz += gout2z * dm[(j0+2)*nao+(l0+0)];
                fx += gout11x * dm[(j0+2)*nao+(l0+2)];
                fy += gout11y * dm[(j0+2)*nao+(l0+2)];
                fz += gout11z * dm[(j0+2)*nao+(l0+2)];
                fx += gout7x * dm[(j0+4)*nao+(l0+1)];
                fy += gout7y * dm[(j0+4)*nao+(l0+1)];
                fz += gout7z * dm[(j0+4)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                fx += gout8x * dm[(j0+2)*nao+(l0+1)];
                fy += gout8y * dm[(j0+2)*nao+(l0+1)];
                fz += gout8z * dm[(j0+2)*nao+(l0+1)];
                fx += gout4x * dm[(j0+4)*nao+(l0+0)];
                fy += gout4y * dm[(j0+4)*nao+(l0+0)];
                fz += gout4z * dm[(j0+4)*nao+(l0+0)];
                fx += gout13x * dm[(j0+4)*nao+(l0+2)];
                fy += gout13y * dm[(j0+4)*nao+(l0+2)];
                fz += gout13z * dm[(j0+4)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+2)];
                fy += gout9y * dm[(i0+0)*nao+(l0+2)];
                fz += gout9z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+1)];
                fy = gout5y * dm[(i0+0)*nao+(l0+1)];
                fz = gout5z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+2)];
                fy += gout11y * dm[(i0+0)*nao+(l0+2)];
                fz += gout11z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+1)];
                fy = gout8y * dm[(i0+0)*nao+(l0+1)];
                fz = gout8z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+2)];
                fy += gout10y * dm[(i0+0)*nao+(l0+2)];
                fz += gout10z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+1)];
                fy = gout7y * dm[(i0+0)*nao+(l0+1)];
                fz = gout7z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+1), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+0)*nao+(l0+2)];
                fy += gout13y * dm[(i0+0)*nao+(l0+2)];
                fz += gout13z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+2), fz);
                break;
                case 1:
                fx = gout0x * dm[(j0+1)*nao+(k0+0)];
                fy = gout0y * dm[(j0+1)*nao+(k0+0)];
                fz = gout0z * dm[(j0+1)*nao+(k0+0)];
                fx += gout3x * dm[(j0+1)*nao+(k0+2)];
                fy += gout3y * dm[(j0+1)*nao+(k0+2)];
                fz += gout3z * dm[(j0+1)*nao+(k0+2)];
                fx += gout2x * dm[(j0+3)*nao+(k0+1)];
                fy += gout2y * dm[(j0+3)*nao+(k0+1)];
                fz += gout2z * dm[(j0+3)*nao+(k0+1)];
                fx += gout1x * dm[(j0+5)*nao+(k0+0)];
                fy += gout1y * dm[(j0+5)*nao+(k0+0)];
                fz += gout1z * dm[(j0+5)*nao+(k0+0)];
                fx += gout4x * dm[(j0+5)*nao+(k0+2)];
                fy += gout4y * dm[(j0+5)*nao+(k0+2)];
                fz += gout4z * dm[(j0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+1)*nao+(k0+1)];
                fy = gout6y * dm[(j0+1)*nao+(k0+1)];
                fz = gout6z * dm[(j0+1)*nao+(k0+1)];
                fx += gout5x * dm[(j0+3)*nao+(k0+0)];
                fy += gout5y * dm[(j0+3)*nao+(k0+0)];
                fz += gout5z * dm[(j0+3)*nao+(k0+0)];
                fx += gout8x * dm[(j0+3)*nao+(k0+2)];
                fy += gout8y * dm[(j0+3)*nao+(k0+2)];
                fz += gout8z * dm[(j0+3)*nao+(k0+2)];
                fx += gout7x * dm[(j0+5)*nao+(k0+1)];
                fy += gout7y * dm[(j0+5)*nao+(k0+1)];
                fz += gout7z * dm[(j0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+1)*nao+(k0+0)];
                fy = gout9y * dm[(j0+1)*nao+(k0+0)];
                fz = gout9z * dm[(j0+1)*nao+(k0+0)];
                fx += gout12x * dm[(j0+1)*nao+(k0+2)];
                fy += gout12y * dm[(j0+1)*nao+(k0+2)];
                fz += gout12z * dm[(j0+1)*nao+(k0+2)];
                fx += gout11x * dm[(j0+3)*nao+(k0+1)];
                fy += gout11y * dm[(j0+3)*nao+(k0+1)];
                fz += gout11z * dm[(j0+3)*nao+(k0+1)];
                fx += gout10x * dm[(j0+5)*nao+(k0+0)];
                fy += gout10y * dm[(j0+5)*nao+(k0+0)];
                fz += gout10z * dm[(j0+5)*nao+(k0+0)];
                fx += gout13x * dm[(j0+5)*nao+(k0+2)];
                fy += gout13y * dm[(j0+5)*nao+(k0+2)];
                fz += gout13z * dm[(j0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+2)];
                fy += gout3y * dm[(i0+0)*nao+(k0+2)];
                fz += gout3z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+1)];
                fy = gout6y * dm[(i0+0)*nao+(k0+1)];
                fz = gout6z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+2)];
                fy += gout12y * dm[(i0+0)*nao+(k0+2)];
                fz += gout12z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+1)];
                fy = gout2y * dm[(i0+0)*nao+(k0+1)];
                fz = gout2z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+0)];
                fy = gout5y * dm[(i0+0)*nao+(k0+0)];
                fz = gout5z * dm[(i0+0)*nao+(k0+0)];
                fx += gout8x * dm[(i0+0)*nao+(k0+2)];
                fy += gout8y * dm[(i0+0)*nao+(k0+2)];
                fz += gout8z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+1), fz);
                fx = gout11x * dm[(i0+0)*nao+(k0+1)];
                fy = gout11y * dm[(i0+0)*nao+(k0+1)];
                fz = gout11z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout4x * dm[(i0+0)*nao+(k0+2)];
                fy += gout4y * dm[(i0+0)*nao+(k0+2)];
                fz += gout4z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(k0+1)];
                fy = gout7y * dm[(i0+0)*nao+(k0+1)];
                fz = gout7z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+0)];
                fy = gout10y * dm[(i0+0)*nao+(k0+0)];
                fz = gout10z * dm[(i0+0)*nao+(k0+0)];
                fx += gout13x * dm[(i0+0)*nao+(k0+2)];
                fy += gout13y * dm[(i0+0)*nao+(k0+2)];
                fz += gout13z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+1)*nao+(l0+0)];
                fy = gout0y * dm[(j0+1)*nao+(l0+0)];
                fz = gout0z * dm[(j0+1)*nao+(l0+0)];
                fx += gout9x * dm[(j0+1)*nao+(l0+2)];
                fy += gout9y * dm[(j0+1)*nao+(l0+2)];
                fz += gout9z * dm[(j0+1)*nao+(l0+2)];
                fx += gout5x * dm[(j0+3)*nao+(l0+1)];
                fy += gout5y * dm[(j0+3)*nao+(l0+1)];
                fz += gout5z * dm[(j0+3)*nao+(l0+1)];
                fx += gout1x * dm[(j0+5)*nao+(l0+0)];
                fy += gout1y * dm[(j0+5)*nao+(l0+0)];
                fz += gout1z * dm[(j0+5)*nao+(l0+0)];
                fx += gout10x * dm[(j0+5)*nao+(l0+2)];
                fy += gout10y * dm[(j0+5)*nao+(l0+2)];
                fz += gout10z * dm[(j0+5)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+1)*nao+(l0+1)];
                fy = gout6y * dm[(j0+1)*nao+(l0+1)];
                fz = gout6z * dm[(j0+1)*nao+(l0+1)];
                fx += gout2x * dm[(j0+3)*nao+(l0+0)];
                fy += gout2y * dm[(j0+3)*nao+(l0+0)];
                fz += gout2z * dm[(j0+3)*nao+(l0+0)];
                fx += gout11x * dm[(j0+3)*nao+(l0+2)];
                fy += gout11y * dm[(j0+3)*nao+(l0+2)];
                fz += gout11z * dm[(j0+3)*nao+(l0+2)];
                fx += gout7x * dm[(j0+5)*nao+(l0+1)];
                fy += gout7y * dm[(j0+5)*nao+(l0+1)];
                fz += gout7z * dm[(j0+5)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(j0+1)*nao+(l0+0)];
                fy = gout3y * dm[(j0+1)*nao+(l0+0)];
                fz = gout3z * dm[(j0+1)*nao+(l0+0)];
                fx += gout12x * dm[(j0+1)*nao+(l0+2)];
                fy += gout12y * dm[(j0+1)*nao+(l0+2)];
                fz += gout12z * dm[(j0+1)*nao+(l0+2)];
                fx += gout8x * dm[(j0+3)*nao+(l0+1)];
                fy += gout8y * dm[(j0+3)*nao+(l0+1)];
                fz += gout8z * dm[(j0+3)*nao+(l0+1)];
                fx += gout4x * dm[(j0+5)*nao+(l0+0)];
                fy += gout4y * dm[(j0+5)*nao+(l0+0)];
                fz += gout4z * dm[(j0+5)*nao+(l0+0)];
                fx += gout13x * dm[(j0+5)*nao+(l0+2)];
                fy += gout13y * dm[(j0+5)*nao+(l0+2)];
                fz += gout13z * dm[(j0+5)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+2)];
                fy += gout9y * dm[(i0+0)*nao+(l0+2)];
                fz += gout9z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+1)];
                fy = gout5y * dm[(i0+0)*nao+(l0+1)];
                fz = gout5z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+2)];
                fy += gout11y * dm[(i0+0)*nao+(l0+2)];
                fz += gout11z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+1), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+1)];
                fy = gout8y * dm[(i0+0)*nao+(l0+1)];
                fz = gout8z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+2)];
                fy += gout10y * dm[(i0+0)*nao+(l0+2)];
                fz += gout10z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+1)];
                fy = gout7y * dm[(i0+0)*nao+(l0+1)];
                fz = gout7z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+1), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+0)*nao+(l0+2)];
                fy += gout13y * dm[(i0+0)*nao+(l0+2)];
                fz += gout13z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+2), fz);
                break;
                case 2:
                fx = gout1x * dm[(j0+0)*nao+(k0+1)];
                fy = gout1y * dm[(j0+0)*nao+(k0+1)];
                fz = gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout0x * dm[(j0+2)*nao+(k0+0)];
                fy += gout0y * dm[(j0+2)*nao+(k0+0)];
                fz += gout0z * dm[(j0+2)*nao+(k0+0)];
                fx += gout3x * dm[(j0+2)*nao+(k0+2)];
                fy += gout3y * dm[(j0+2)*nao+(k0+2)];
                fz += gout3z * dm[(j0+2)*nao+(k0+2)];
                fx += gout2x * dm[(j0+4)*nao+(k0+1)];
                fy += gout2y * dm[(j0+4)*nao+(k0+1)];
                fz += gout2z * dm[(j0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+0)];
                fy = gout4y * dm[(j0+0)*nao+(k0+0)];
                fz = gout4z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+0)*nao+(k0+2)];
                fy += gout7y * dm[(j0+0)*nao+(k0+2)];
                fz += gout7z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+2)*nao+(k0+1)];
                fy += gout6y * dm[(j0+2)*nao+(k0+1)];
                fz += gout6z * dm[(j0+2)*nao+(k0+1)];
                fx += gout5x * dm[(j0+4)*nao+(k0+0)];
                fy += gout5y * dm[(j0+4)*nao+(k0+0)];
                fz += gout5z * dm[(j0+4)*nao+(k0+0)];
                fx += gout8x * dm[(j0+4)*nao+(k0+2)];
                fy += gout8y * dm[(j0+4)*nao+(k0+2)];
                fz += gout8z * dm[(j0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(k0+1)];
                fy = gout10y * dm[(j0+0)*nao+(k0+1)];
                fz = gout10z * dm[(j0+0)*nao+(k0+1)];
                fx += gout9x * dm[(j0+2)*nao+(k0+0)];
                fy += gout9y * dm[(j0+2)*nao+(k0+0)];
                fz += gout9z * dm[(j0+2)*nao+(k0+0)];
                fx += gout12x * dm[(j0+2)*nao+(k0+2)];
                fy += gout12y * dm[(j0+2)*nao+(k0+2)];
                fz += gout12z * dm[(j0+2)*nao+(k0+2)];
                fx += gout11x * dm[(j0+4)*nao+(k0+1)];
                fy += gout11y * dm[(j0+4)*nao+(k0+1)];
                fz += gout11z * dm[(j0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+1)];
                fy = gout1y * dm[(i0+0)*nao+(k0+1)];
                fz = gout1z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+0)];
                fy = gout4y * dm[(i0+0)*nao+(k0+0)];
                fz = gout4z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+0)*nao+(k0+2)];
                fy += gout7y * dm[(i0+0)*nao+(k0+2)];
                fz += gout7z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+1)];
                fy = gout10y * dm[(i0+0)*nao+(k0+1)];
                fz = gout10z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+2)];
                fy += gout3y * dm[(i0+0)*nao+(k0+2)];
                fz += gout3z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+1)];
                fy = gout6y * dm[(i0+0)*nao+(k0+1)];
                fz = gout6z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+2)];
                fy += gout12y * dm[(i0+0)*nao+(k0+2)];
                fz += gout12z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+1)];
                fy = gout2y * dm[(i0+0)*nao+(k0+1)];
                fz = gout2z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+0)];
                fy = gout5y * dm[(i0+0)*nao+(k0+0)];
                fz = gout5z * dm[(i0+0)*nao+(k0+0)];
                fx += gout8x * dm[(i0+0)*nao+(k0+2)];
                fy += gout8y * dm[(i0+0)*nao+(k0+2)];
                fz += gout8z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+1), fz);
                fx = gout11x * dm[(i0+0)*nao+(k0+1)];
                fy = gout11y * dm[(i0+0)*nao+(k0+1)];
                fz = gout11z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+2), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+1)];
                fy = gout4y * dm[(j0+0)*nao+(l0+1)];
                fz = gout4z * dm[(j0+0)*nao+(l0+1)];
                fx += gout0x * dm[(j0+2)*nao+(l0+0)];
                fy += gout0y * dm[(j0+2)*nao+(l0+0)];
                fz += gout0z * dm[(j0+2)*nao+(l0+0)];
                fx += gout9x * dm[(j0+2)*nao+(l0+2)];
                fy += gout9y * dm[(j0+2)*nao+(l0+2)];
                fz += gout9z * dm[(j0+2)*nao+(l0+2)];
                fx += gout5x * dm[(j0+4)*nao+(l0+1)];
                fy += gout5y * dm[(j0+4)*nao+(l0+1)];
                fz += gout5z * dm[(j0+4)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+2)];
                fy += gout10y * dm[(j0+0)*nao+(l0+2)];
                fz += gout10z * dm[(j0+0)*nao+(l0+2)];
                fx += gout6x * dm[(j0+2)*nao+(l0+1)];
                fy += gout6y * dm[(j0+2)*nao+(l0+1)];
                fz += gout6z * dm[(j0+2)*nao+(l0+1)];
                fx += gout2x * dm[(j0+4)*nao+(l0+0)];
                fy += gout2y * dm[(j0+4)*nao+(l0+0)];
                fz += gout2z * dm[(j0+4)*nao+(l0+0)];
                fx += gout11x * dm[(j0+4)*nao+(l0+2)];
                fy += gout11y * dm[(j0+4)*nao+(l0+2)];
                fz += gout11z * dm[(j0+4)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                fx += gout3x * dm[(j0+2)*nao+(l0+0)];
                fy += gout3y * dm[(j0+2)*nao+(l0+0)];
                fz += gout3z * dm[(j0+2)*nao+(l0+0)];
                fx += gout12x * dm[(j0+2)*nao+(l0+2)];
                fy += gout12y * dm[(j0+2)*nao+(l0+2)];
                fz += gout12z * dm[(j0+2)*nao+(l0+2)];
                fx += gout8x * dm[(j0+4)*nao+(l0+1)];
                fy += gout8y * dm[(j0+4)*nao+(l0+1)];
                fz += gout8z * dm[(j0+4)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+1)];
                fy = gout4y * dm[(i0+0)*nao+(l0+1)];
                fz = gout4z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+2)];
                fy += gout10y * dm[(i0+0)*nao+(l0+2)];
                fz += gout10z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+1)];
                fy = gout7y * dm[(i0+0)*nao+(l0+1)];
                fz = gout7z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+2)];
                fy += gout9y * dm[(i0+0)*nao+(l0+2)];
                fz += gout9z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+1)];
                fy = gout5y * dm[(i0+0)*nao+(l0+1)];
                fz = gout5z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+2)];
                fy += gout11y * dm[(i0+0)*nao+(l0+2)];
                fz += gout11z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+1), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+1)];
                fy = gout8y * dm[(i0+0)*nao+(l0+1)];
                fz = gout8z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+2), fz);
                break;
                case 3:
                fx = gout1x * dm[(j0+1)*nao+(k0+1)];
                fy = gout1y * dm[(j0+1)*nao+(k0+1)];
                fz = gout1z * dm[(j0+1)*nao+(k0+1)];
                fx += gout0x * dm[(j0+3)*nao+(k0+0)];
                fy += gout0y * dm[(j0+3)*nao+(k0+0)];
                fz += gout0z * dm[(j0+3)*nao+(k0+0)];
                fx += gout3x * dm[(j0+3)*nao+(k0+2)];
                fy += gout3y * dm[(j0+3)*nao+(k0+2)];
                fz += gout3z * dm[(j0+3)*nao+(k0+2)];
                fx += gout2x * dm[(j0+5)*nao+(k0+1)];
                fy += gout2y * dm[(j0+5)*nao+(k0+1)];
                fz += gout2z * dm[(j0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+1)*nao+(k0+0)];
                fy = gout4y * dm[(j0+1)*nao+(k0+0)];
                fz = gout4z * dm[(j0+1)*nao+(k0+0)];
                fx += gout7x * dm[(j0+1)*nao+(k0+2)];
                fy += gout7y * dm[(j0+1)*nao+(k0+2)];
                fz += gout7z * dm[(j0+1)*nao+(k0+2)];
                fx += gout6x * dm[(j0+3)*nao+(k0+1)];
                fy += gout6y * dm[(j0+3)*nao+(k0+1)];
                fz += gout6z * dm[(j0+3)*nao+(k0+1)];
                fx += gout5x * dm[(j0+5)*nao+(k0+0)];
                fy += gout5y * dm[(j0+5)*nao+(k0+0)];
                fz += gout5z * dm[(j0+5)*nao+(k0+0)];
                fx += gout8x * dm[(j0+5)*nao+(k0+2)];
                fy += gout8y * dm[(j0+5)*nao+(k0+2)];
                fz += gout8z * dm[(j0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+1)*nao+(k0+1)];
                fy = gout10y * dm[(j0+1)*nao+(k0+1)];
                fz = gout10z * dm[(j0+1)*nao+(k0+1)];
                fx += gout9x * dm[(j0+3)*nao+(k0+0)];
                fy += gout9y * dm[(j0+3)*nao+(k0+0)];
                fz += gout9z * dm[(j0+3)*nao+(k0+0)];
                fx += gout12x * dm[(j0+3)*nao+(k0+2)];
                fy += gout12y * dm[(j0+3)*nao+(k0+2)];
                fz += gout12z * dm[(j0+3)*nao+(k0+2)];
                fx += gout11x * dm[(j0+5)*nao+(k0+1)];
                fy += gout11y * dm[(j0+5)*nao+(k0+1)];
                fz += gout11z * dm[(j0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+1)];
                fy = gout1y * dm[(i0+0)*nao+(k0+1)];
                fz = gout1z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+0)];
                fy = gout4y * dm[(i0+0)*nao+(k0+0)];
                fz = gout4z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+0)*nao+(k0+2)];
                fy += gout7y * dm[(i0+0)*nao+(k0+2)];
                fz += gout7z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+1)];
                fy = gout10y * dm[(i0+0)*nao+(k0+1)];
                fz = gout10z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+2)];
                fy += gout3y * dm[(i0+0)*nao+(k0+2)];
                fz += gout3z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+1)];
                fy = gout6y * dm[(i0+0)*nao+(k0+1)];
                fz = gout6z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+2)];
                fy += gout12y * dm[(i0+0)*nao+(k0+2)];
                fz += gout12z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+1)];
                fy = gout2y * dm[(i0+0)*nao+(k0+1)];
                fz = gout2z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+0)];
                fy = gout5y * dm[(i0+0)*nao+(k0+0)];
                fz = gout5z * dm[(i0+0)*nao+(k0+0)];
                fx += gout8x * dm[(i0+0)*nao+(k0+2)];
                fy += gout8y * dm[(i0+0)*nao+(k0+2)];
                fz += gout8z * dm[(i0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+1), fz);
                fx = gout11x * dm[(i0+0)*nao+(k0+1)];
                fy = gout11y * dm[(i0+0)*nao+(k0+1)];
                fz = gout11z * dm[(i0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+2), fz);
                fx = gout4x * dm[(j0+1)*nao+(l0+1)];
                fy = gout4y * dm[(j0+1)*nao+(l0+1)];
                fz = gout4z * dm[(j0+1)*nao+(l0+1)];
                fx += gout0x * dm[(j0+3)*nao+(l0+0)];
                fy += gout0y * dm[(j0+3)*nao+(l0+0)];
                fz += gout0z * dm[(j0+3)*nao+(l0+0)];
                fx += gout9x * dm[(j0+3)*nao+(l0+2)];
                fy += gout9y * dm[(j0+3)*nao+(l0+2)];
                fz += gout9z * dm[(j0+3)*nao+(l0+2)];
                fx += gout5x * dm[(j0+5)*nao+(l0+1)];
                fy += gout5y * dm[(j0+5)*nao+(l0+1)];
                fz += gout5z * dm[(j0+5)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout10x * dm[(j0+1)*nao+(l0+2)];
                fy += gout10y * dm[(j0+1)*nao+(l0+2)];
                fz += gout10z * dm[(j0+1)*nao+(l0+2)];
                fx += gout6x * dm[(j0+3)*nao+(l0+1)];
                fy += gout6y * dm[(j0+3)*nao+(l0+1)];
                fz += gout6z * dm[(j0+3)*nao+(l0+1)];
                fx += gout2x * dm[(j0+5)*nao+(l0+0)];
                fy += gout2y * dm[(j0+5)*nao+(l0+0)];
                fz += gout2z * dm[(j0+5)*nao+(l0+0)];
                fx += gout11x * dm[(j0+5)*nao+(l0+2)];
                fy += gout11y * dm[(j0+5)*nao+(l0+2)];
                fz += gout11z * dm[(j0+5)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout7x * dm[(j0+1)*nao+(l0+1)];
                fy = gout7y * dm[(j0+1)*nao+(l0+1)];
                fz = gout7z * dm[(j0+1)*nao+(l0+1)];
                fx += gout3x * dm[(j0+3)*nao+(l0+0)];
                fy += gout3y * dm[(j0+3)*nao+(l0+0)];
                fz += gout3z * dm[(j0+3)*nao+(l0+0)];
                fx += gout12x * dm[(j0+3)*nao+(l0+2)];
                fy += gout12y * dm[(j0+3)*nao+(l0+2)];
                fz += gout12z * dm[(j0+3)*nao+(l0+2)];
                fx += gout8x * dm[(j0+5)*nao+(l0+1)];
                fy += gout8y * dm[(j0+5)*nao+(l0+1)];
                fz += gout8z * dm[(j0+5)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+1)];
                fy = gout4y * dm[(i0+0)*nao+(l0+1)];
                fz = gout4z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+2)];
                fy += gout10y * dm[(i0+0)*nao+(l0+2)];
                fz += gout10z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+1)];
                fy = gout7y * dm[(i0+0)*nao+(l0+1)];
                fz = gout7z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+2)];
                fy += gout9y * dm[(i0+0)*nao+(l0+2)];
                fz += gout9z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+2), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+1)];
                fy = gout5y * dm[(i0+0)*nao+(l0+1)];
                fz = gout5z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+2)];
                fy += gout11y * dm[(i0+0)*nao+(l0+2)];
                fz += gout11z * dm[(i0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+1), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+1)];
                fy = gout8y * dm[(i0+0)*nao+(l0+1)];
                fz = gout8z * dm[(i0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+2), fz);
                break;
                }
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0211(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0211(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_0220(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;
    double *gx = rw + 128 * nroots;
    double *gy = gx + 1152;
    double *gz = gy + 1152;
    double *rlrk = gz + 1152;
    double *Rpq = rlrk + 192;
    if (gout_id == 0) {
        gx[0] = 1.;
        gy[0] = 1.;
    }
    double s0, s1, s2;
    double Ix, Iy, Iz;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        if (gout_id == 0) {
            rlrk[0] = xlxk;
            rlrk[64] = ylyk;
            rlrk[128] = zlzk;
        }
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            __syncthreads();
            double xlxk = rlrk[0];
            double ylyk = rlrk[64];
            double zlzk = rlrk[128];
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xkl = rk[0] + rlrk[0] * al_akl;
                double ykl = rk[1] + rlrk[64] * al_akl;
                double zkl = rk[2] + rlrk[128] * al_akl;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                __syncthreads();
                if (gout_id == 0) {
                    Rpq[0] = xpq;
                    Rpq[64] = ypq;
                    Rpq[128] = zpq;
                }
                rys_roots_rs(nroots, theta, rr, omega, rw, 64, gout_id, 4);
                for (int irys = 0; irys < nroots; ++irys) {
                    __syncthreads();
                    double rt = rw[irys*128];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double rt_akl = rt_aa * aij;
                    double b00 = .5 * rt_aa;
                    double b01 = .5/akl * (1 - rt_akl);
                    for (int n = gout_id; n < 3; n += 4) {
                        if (n == 2) {
                            gz[0] = rw[irys*128+64] * fac;
                        }
                        double *_gx = gx + n * 1152;
                        double xjxi = rjri[n];
                        double Rpa = xjxi * aj_aij;
                        double c0x = Rpa - rt_aij * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = c0x * s0;
                        _gx[64] = s1;
                        s2 = c0x * s1 + 1 * b10 * s0;
                        _gx[128] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 2 * b10 * s0;
                        _gx[192] = s2;
                        double xlxk = rlrk[n*64];
                        double Rqc = xlxk * al_akl;
                        double cpx = Rqc + rt_akl * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = cpx * s0;
                        _gx[384] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        _gx[768] = s2;
                        s0 = _gx[64];
                        s1 = cpx * s0;
                        s1 += 1 * b00 * _gx[0];
                        _gx[448] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 1 * b00 * _gx[384];
                        _gx[832] = s2;
                        s0 = _gx[128];
                        s1 = cpx * s0;
                        s1 += 2 * b00 * _gx[64];
                        _gx[512] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 2 * b00 * _gx[448];
                        _gx[896] = s2;
                        s0 = _gx[192];
                        s1 = cpx * s0;
                        s1 += 3 * b00 * _gx[128];
                        _gx[576] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 3 * b00 * _gx[512];
                        _gx[960] = s2;
                        s1 = _gx[192];
                        s0 = _gx[128];
                        _gx[256] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[192] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[128] = s1 - xjxi * s0;
                        s1 = _gx[256];
                        s0 = _gx[192];
                        _gx[320] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[128];
                        _gx[256] = s1 - xjxi * s0;
                        s1 = _gx[576];
                        s0 = _gx[512];
                        _gx[640] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[448];
                        _gx[576] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[384];
                        _gx[512] = s1 - xjxi * s0;
                        s1 = _gx[640];
                        s0 = _gx[576];
                        _gx[704] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[512];
                        _gx[640] = s1 - xjxi * s0;
                        s1 = _gx[960];
                        s0 = _gx[896];
                        _gx[1024] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[832];
                        _gx[960] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[768];
                        _gx[896] = s1 - xjxi * s0;
                        s1 = _gx[1024];
                        s0 = _gx[960];
                        _gx[1088] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[896];
                        _gx[1024] = s1 - xjxi * s0;
                    }
                    __syncthreads();
                    switch (gout_id) {
                    case 0:
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[0];
                    Iz = gz[0];
                    gout0x += ai2 * gx[1088] * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[128];
                    Iz = gz[128];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += ai2 * gy[192] * Ix * Iz;
                    gout1z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[384];
                    Iz = gz[128];
                    gout2x += ai2 * gx[576] * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[0];
                    Iz = gz[384];
                    gout3x += ai2 * gx[704] * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[128];
                    Iz = gz[512];
                    gout4x += ai2 * gx[448] * Iy * Iz;
                    gout4y += ai2 * gy[192] * Ix * Iz;
                    gout4z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[768];
                    Iz = gz[128];
                    gout5x += ai2 * gx[192] * Iy * Iz;
                    gout5y += ai2 * gy[832] * Ix * Iz;
                    gout5z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[384];
                    Iz = gz[384];
                    gout6x += ai2 * gx[320] * Iy * Iz;
                    gout6y += ai2 * gy[448] * Ix * Iz;
                    gout6z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[512];
                    Iz = gz[512];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[576] * Ix * Iz;
                    gout7z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[0];
                    Iz = gz[896];
                    gout8x += ai2 * gx[192] * Iy * Iz;
                    gout8y += ai2 * gy[64] * Ix * Iz;
                    gout8z += ai2 * gz[960] * Ix * Iy;
                    break;
                    case 1:
                    ai2 = rjri[5];
                    Ix = gx[896];
                    Iy = gy[128];
                    Iz = gz[0];
                    gout0x += ai2 * gx[960] * Iy * Iz;
                    gout0y += ai2 * gy[192] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[0];
                    Iz = gz[256];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += ai2 * gy[64] * Ix * Iz;
                    gout1z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[640];
                    Iz = gz[0];
                    gout2x += ai2 * gx[448] * Iy * Iz;
                    gout2y += ai2 * gy[704] * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[128];
                    Iz = gz[384];
                    gout3x += ai2 * gx[576] * Iy * Iz;
                    gout3y += ai2 * gy[192] * Ix * Iz;
                    gout3z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[0];
                    Iz = gz[640];
                    gout4x += ai2 * gx[448] * Iy * Iz;
                    gout4y += ai2 * gy[64] * Ix * Iz;
                    gout4z += ai2 * gz[704] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1024];
                    Iz = gz[0];
                    gout5x += ai2 * gx[64] * Iy * Iz;
                    gout5y += ai2 * gy[1088] * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[512];
                    Iz = gz[384];
                    gout6x += ai2 * gx[192] * Iy * Iz;
                    gout6y += ai2 * gy[576] * Ix * Iz;
                    gout6z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[384];
                    Iz = gz[640];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[448] * Ix * Iz;
                    gout7z += ai2 * gz[704] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[256];
                    Iz = gz[768];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[320] * Ix * Iz;
                    gout8z += ai2 * gz[832] * Ix * Iy;
                    break;
                    case 2:
                    ai2 = rjri[5];
                    Ix = gx[896];
                    Iy = gy[0];
                    Iz = gz[128];
                    gout0x += ai2 * gx[960] * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[384];
                    Iz = gz[0];
                    gout1x += ai2 * gx[704] * Iy * Iz;
                    gout1y += ai2 * gy[448] * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[512];
                    Iz = gz[128];
                    gout2x += ai2 * gx[448] * Iy * Iz;
                    gout2y += ai2 * gy[576] * Ix * Iz;
                    gout2z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[0];
                    Iz = gz[512];
                    gout3x += ai2 * gx[576] * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[768];
                    Iz = gz[0];
                    gout4x += ai2 * gx[320] * Iy * Iz;
                    gout4y += ai2 * gy[832] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[896];
                    Iz = gz[128];
                    gout5x += ai2 * gx[64] * Iy * Iz;
                    gout5y += ai2 * gy[960] * Ix * Iz;
                    gout5z += ai2 * gz[192] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[384];
                    Iz = gz[512];
                    gout6x += ai2 * gx[192] * Iy * Iz;
                    gout6y += ai2 * gy[448] * Ix * Iz;
                    gout6z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[0];
                    Iz = gz[768];
                    gout7x += ai2 * gx[320] * Iy * Iz;
                    gout7y += ai2 * gy[64] * Ix * Iz;
                    gout7z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[128];
                    Iz = gz[896];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[192] * Ix * Iz;
                    gout8z += ai2 * gz[960] * Ix * Iy;
                    break;
                    case 3:
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[256];
                    Iz = gz[0];
                    gout0x += ai2 * gx[832] * Iy * Iz;
                    gout0y += ai2 * gy[320] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[512];
                    Iz = gz[0];
                    gout1x += ai2 * gx[576] * Iy * Iz;
                    gout1y += ai2 * gy[576] * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[384];
                    Iz = gz[256];
                    gout2x += ai2 * gx[448] * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[256];
                    Iz = gz[384];
                    gout3x += ai2 * gx[448] * Iy * Iz;
                    gout3y += ai2 * gy[320] * Ix * Iz;
                    gout3z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[896];
                    Iz = gz[0];
                    gout4x += ai2 * gx[192] * Iy * Iz;
                    gout4y += ai2 * gy[960] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[768];
                    Iz = gz[256];
                    gout5x += ai2 * gx[64] * Iy * Iz;
                    gout5y += ai2 * gy[832] * Ix * Iz;
                    gout5z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[640];
                    Iz = gz[384];
                    gout6x += ai2 * gx[64] * Iy * Iz;
                    gout6y += ai2 * gy[704] * Ix * Iz;
                    gout6z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[128];
                    Iz = gz[768];
                    gout7x += ai2 * gx[192] * Iy * Iz;
                    gout7y += ai2 * gy[192] * Ix * Iz;
                    gout7z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[0];
                    Iz = gz[1024];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[64] * Ix * Iz;
                    gout8z += ai2 * gz[1088] * Ix * Iy;
                    break;
                    }
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+0)*nao+(k0+4)];
                fy += gout6y * dm[(l0+0)*nao+(k0+4)];
                fz += gout6z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+0)*nao+(k0+3)];
                fy += gout5y * dm[(l0+0)*nao+(k0+3)];
                fz += gout5z * dm[(l0+0)*nao+(k0+3)];
                fx += gout8x * dm[(l0+0)*nao+(k0+5)];
                fy += gout8y * dm[(l0+0)*nao+(k0+5)];
                fz += gout8z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+2)];
                fy += gout4y * dm[(l0+0)*nao+(k0+2)];
                fz += gout4z * dm[(l0+0)*nao+(k0+2)];
                fx += gout7x * dm[(l0+0)*nao+(k0+4)];
                fy += gout7y * dm[(l0+0)*nao+(k0+4)];
                fz += gout7z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+4), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+4)*nao+(i0+0)];
                fy += gout1y * dm[(j0+4)*nao+(i0+0)];
                fz += gout1z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+2)*nao+(i0+0)];
                fy = gout2y * dm[(j0+2)*nao+(i0+0)];
                fz = gout2z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                fx += gout4x * dm[(j0+4)*nao+(i0+0)];
                fy += gout4y * dm[(j0+4)*nao+(i0+0)];
                fz += gout4z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+2)*nao+(i0+0)];
                fy = gout5y * dm[(j0+2)*nao+(i0+0)];
                fz = gout5z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+4)*nao+(i0+0)];
                fy += gout7y * dm[(j0+4)*nao+(i0+0)];
                fz += gout7z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout8x * dm[(j0+2)*nao+(i0+0)];
                fy = gout8y * dm[(j0+2)*nao+(i0+0)];
                fz = gout8z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                case 1:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+0)*nao+(k0+4)];
                fy += gout6y * dm[(l0+0)*nao+(k0+4)];
                fz += gout6z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+0)*nao+(k0+3)];
                fy += gout5y * dm[(l0+0)*nao+(k0+3)];
                fz += gout5z * dm[(l0+0)*nao+(k0+3)];
                fx += gout8x * dm[(l0+0)*nao+(k0+5)];
                fy += gout8y * dm[(l0+0)*nao+(k0+5)];
                fz += gout8z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+3), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+2)];
                fy += gout4y * dm[(l0+0)*nao+(k0+2)];
                fz += gout4z * dm[(l0+0)*nao+(k0+2)];
                fx += gout7x * dm[(l0+0)*nao+(k0+4)];
                fy += gout7y * dm[(l0+0)*nao+(k0+4)];
                fz += gout7z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+5), fz);
                fx = gout0x * dm[(j0+1)*nao+(i0+0)];
                fy = gout0y * dm[(j0+1)*nao+(i0+0)];
                fz = gout0z * dm[(j0+1)*nao+(i0+0)];
                fx += gout1x * dm[(j0+5)*nao+(i0+0)];
                fy += gout1y * dm[(j0+5)*nao+(i0+0)];
                fz += gout1z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+3)*nao+(i0+0)];
                fy = gout2y * dm[(j0+3)*nao+(i0+0)];
                fz = gout2z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+1)*nao+(i0+0)];
                fy = gout3y * dm[(j0+1)*nao+(i0+0)];
                fz = gout3z * dm[(j0+1)*nao+(i0+0)];
                fx += gout4x * dm[(j0+5)*nao+(i0+0)];
                fy += gout4y * dm[(j0+5)*nao+(i0+0)];
                fz += gout4z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+3)*nao+(i0+0)];
                fy = gout5y * dm[(j0+3)*nao+(i0+0)];
                fz = gout5z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+1)*nao+(i0+0)];
                fy = gout6y * dm[(j0+1)*nao+(i0+0)];
                fz = gout6z * dm[(j0+1)*nao+(i0+0)];
                fx += gout7x * dm[(j0+5)*nao+(i0+0)];
                fy += gout7y * dm[(j0+5)*nao+(i0+0)];
                fz += gout7z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout8x * dm[(j0+3)*nao+(i0+0)];
                fy = gout8y * dm[(j0+3)*nao+(i0+0)];
                fz = gout8z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                case 2:
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+0)*nao+(k0+3)];
                fy += gout4y * dm[(l0+0)*nao+(k0+3)];
                fz += gout4z * dm[(l0+0)*nao+(k0+3)];
                fx += gout7x * dm[(l0+0)*nao+(k0+5)];
                fy += gout7y * dm[(l0+0)*nao+(k0+5)];
                fz += gout7z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+0)*nao+(k0+4)];
                fy += gout6y * dm[(l0+0)*nao+(k0+4)];
                fz += gout6z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+0)*nao+(k0+3)];
                fy += gout5y * dm[(l0+0)*nao+(k0+3)];
                fz += gout5z * dm[(l0+0)*nao+(k0+3)];
                fx += gout8x * dm[(l0+0)*nao+(k0+5)];
                fy += gout8y * dm[(l0+0)*nao+(k0+5)];
                fz += gout8z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+4), fz);
                fx = gout0x * dm[(j0+2)*nao+(i0+0)];
                fy = gout0y * dm[(j0+2)*nao+(i0+0)];
                fz = gout0z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                fx += gout2x * dm[(j0+4)*nao+(i0+0)];
                fy += gout2y * dm[(j0+4)*nao+(i0+0)];
                fz += gout2z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+2)*nao+(i0+0)];
                fy = gout3y * dm[(j0+2)*nao+(i0+0)];
                fz = gout3z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                fx += gout5x * dm[(j0+4)*nao+(i0+0)];
                fy += gout5y * dm[(j0+4)*nao+(i0+0)];
                fz += gout5z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+2)*nao+(i0+0)];
                fy = gout6y * dm[(j0+2)*nao+(i0+0)];
                fz = gout6z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+0)];
                fy = gout7y * dm[(j0+0)*nao+(i0+0)];
                fz = gout7z * dm[(j0+0)*nao+(i0+0)];
                fx += gout8x * dm[(j0+4)*nao+(i0+0)];
                fy += gout8y * dm[(j0+4)*nao+(i0+0)];
                fz += gout8z * dm[(j0+4)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                case 3:
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+0)*nao+(k0+3)];
                fy += gout4y * dm[(l0+0)*nao+(k0+3)];
                fz += gout4z * dm[(l0+0)*nao+(k0+3)];
                fx += gout7x * dm[(l0+0)*nao+(k0+5)];
                fy += gout7y * dm[(l0+0)*nao+(k0+5)];
                fz += gout7z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+0)*nao+(k0+4)];
                fy += gout6y * dm[(l0+0)*nao+(k0+4)];
                fz += gout6z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+3), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+0)*nao+(k0+3)];
                fy += gout5y * dm[(l0+0)*nao+(k0+3)];
                fz += gout5z * dm[(l0+0)*nao+(k0+3)];
                fx += gout8x * dm[(l0+0)*nao+(k0+5)];
                fy += gout8y * dm[(l0+0)*nao+(k0+5)];
                fz += gout8z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+5), fz);
                fx = gout0x * dm[(j0+3)*nao+(i0+0)];
                fy = gout0y * dm[(j0+3)*nao+(i0+0)];
                fz = gout0z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(i0+0)];
                fy = gout1y * dm[(j0+1)*nao+(i0+0)];
                fz = gout1z * dm[(j0+1)*nao+(i0+0)];
                fx += gout2x * dm[(j0+5)*nao+(i0+0)];
                fy += gout2y * dm[(j0+5)*nao+(i0+0)];
                fz += gout2z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+3)*nao+(i0+0)];
                fy = gout3y * dm[(j0+3)*nao+(i0+0)];
                fz = gout3z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+1)*nao+(i0+0)];
                fy = gout4y * dm[(j0+1)*nao+(i0+0)];
                fz = gout4z * dm[(j0+1)*nao+(i0+0)];
                fx += gout5x * dm[(j0+5)*nao+(i0+0)];
                fy += gout5y * dm[(j0+5)*nao+(i0+0)];
                fz += gout5z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+3)*nao+(i0+0)];
                fy = gout6y * dm[(j0+3)*nao+(i0+0)];
                fz = gout6z * dm[(j0+3)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+1)*nao+(i0+0)];
                fy = gout7y * dm[(j0+1)*nao+(i0+0)];
                fz = gout7z * dm[(j0+1)*nao+(i0+0)];
                fx += gout8x * dm[(j0+5)*nao+(i0+0)];
                fy += gout8y * dm[(j0+5)*nao+(i0+0)];
                fz += gout8z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                }
            }
            if (do_k) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+2)];
                fy += gout3y * dm[(j0+0)*nao+(k0+2)];
                fz += gout3z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+0)*nao+(k0+4)];
                fy += gout6y * dm[(j0+0)*nao+(k0+4)];
                fz += gout6z * dm[(j0+0)*nao+(k0+4)];
                fx += gout2x * dm[(j0+2)*nao+(k0+1)];
                fy += gout2y * dm[(j0+2)*nao+(k0+1)];
                fz += gout2z * dm[(j0+2)*nao+(k0+1)];
                fx += gout5x * dm[(j0+2)*nao+(k0+3)];
                fy += gout5y * dm[(j0+2)*nao+(k0+3)];
                fz += gout5z * dm[(j0+2)*nao+(k0+3)];
                fx += gout8x * dm[(j0+2)*nao+(k0+5)];
                fy += gout8y * dm[(j0+2)*nao+(k0+5)];
                fz += gout8z * dm[(j0+2)*nao+(k0+5)];
                fx += gout1x * dm[(j0+4)*nao+(k0+0)];
                fy += gout1y * dm[(j0+4)*nao+(k0+0)];
                fz += gout1z * dm[(j0+4)*nao+(k0+0)];
                fx += gout4x * dm[(j0+4)*nao+(k0+2)];
                fy += gout4y * dm[(j0+4)*nao+(k0+2)];
                fz += gout4z * dm[(j0+4)*nao+(k0+2)];
                fx += gout7x * dm[(j0+4)*nao+(k0+4)];
                fy += gout7y * dm[(j0+4)*nao+(k0+4)];
                fz += gout7z * dm[(j0+4)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+2)];
                fy += gout3y * dm[(i0+0)*nao+(k0+2)];
                fz += gout3z * dm[(i0+0)*nao+(k0+2)];
                fx += gout6x * dm[(i0+0)*nao+(k0+4)];
                fy += gout6y * dm[(i0+0)*nao+(k0+4)];
                fz += gout6z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+1)];
                fy = gout2y * dm[(i0+0)*nao+(k0+1)];
                fz = gout2z * dm[(i0+0)*nao+(k0+1)];
                fx += gout5x * dm[(i0+0)*nao+(k0+3)];
                fy += gout5y * dm[(i0+0)*nao+(k0+3)];
                fz += gout5z * dm[(i0+0)*nao+(k0+3)];
                fx += gout8x * dm[(i0+0)*nao+(k0+5)];
                fy += gout8y * dm[(i0+0)*nao+(k0+5)];
                fz += gout8z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout4x * dm[(i0+0)*nao+(k0+2)];
                fy += gout4y * dm[(i0+0)*nao+(k0+2)];
                fz += gout4z * dm[(i0+0)*nao+(k0+2)];
                fx += gout7x * dm[(i0+0)*nao+(k0+4)];
                fy += gout7y * dm[(i0+0)*nao+(k0+4)];
                fz += gout7z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout1x * dm[(j0+4)*nao+(l0+0)];
                fy += gout1y * dm[(j0+4)*nao+(l0+0)];
                fz += gout1z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+2)*nao+(l0+0)];
                fy = gout2y * dm[(j0+2)*nao+(l0+0)];
                fz = gout2z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout4x * dm[(j0+4)*nao+(l0+0)];
                fy += gout4y * dm[(j0+4)*nao+(l0+0)];
                fz += gout4z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout5x * dm[(j0+2)*nao+(l0+0)];
                fy = gout5y * dm[(j0+2)*nao+(l0+0)];
                fz = gout5z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                fx += gout7x * dm[(j0+4)*nao+(l0+0)];
                fy += gout7y * dm[(j0+4)*nao+(l0+0)];
                fz += gout7z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout8x * dm[(j0+2)*nao+(l0+0)];
                fy = gout8y * dm[(j0+2)*nao+(l0+0)];
                fz = gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+3), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+0)];
                fy = gout8y * dm[(i0+0)*nao+(l0+0)];
                fz = gout8z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+5), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+2), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+4), fz);
                break;
                case 1:
                fx = gout0x * dm[(j0+1)*nao+(k0+0)];
                fy = gout0y * dm[(j0+1)*nao+(k0+0)];
                fz = gout0z * dm[(j0+1)*nao+(k0+0)];
                fx += gout3x * dm[(j0+1)*nao+(k0+2)];
                fy += gout3y * dm[(j0+1)*nao+(k0+2)];
                fz += gout3z * dm[(j0+1)*nao+(k0+2)];
                fx += gout6x * dm[(j0+1)*nao+(k0+4)];
                fy += gout6y * dm[(j0+1)*nao+(k0+4)];
                fz += gout6z * dm[(j0+1)*nao+(k0+4)];
                fx += gout2x * dm[(j0+3)*nao+(k0+1)];
                fy += gout2y * dm[(j0+3)*nao+(k0+1)];
                fz += gout2z * dm[(j0+3)*nao+(k0+1)];
                fx += gout5x * dm[(j0+3)*nao+(k0+3)];
                fy += gout5y * dm[(j0+3)*nao+(k0+3)];
                fz += gout5z * dm[(j0+3)*nao+(k0+3)];
                fx += gout8x * dm[(j0+3)*nao+(k0+5)];
                fy += gout8y * dm[(j0+3)*nao+(k0+5)];
                fz += gout8z * dm[(j0+3)*nao+(k0+5)];
                fx += gout1x * dm[(j0+5)*nao+(k0+0)];
                fy += gout1y * dm[(j0+5)*nao+(k0+0)];
                fz += gout1z * dm[(j0+5)*nao+(k0+0)];
                fx += gout4x * dm[(j0+5)*nao+(k0+2)];
                fy += gout4y * dm[(j0+5)*nao+(k0+2)];
                fz += gout4z * dm[(j0+5)*nao+(k0+2)];
                fx += gout7x * dm[(j0+5)*nao+(k0+4)];
                fy += gout7y * dm[(j0+5)*nao+(k0+4)];
                fz += gout7z * dm[(j0+5)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+2)];
                fy += gout3y * dm[(i0+0)*nao+(k0+2)];
                fz += gout3z * dm[(i0+0)*nao+(k0+2)];
                fx += gout6x * dm[(i0+0)*nao+(k0+4)];
                fy += gout6y * dm[(i0+0)*nao+(k0+4)];
                fz += gout6z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+1)];
                fy = gout2y * dm[(i0+0)*nao+(k0+1)];
                fz = gout2z * dm[(i0+0)*nao+(k0+1)];
                fx += gout5x * dm[(i0+0)*nao+(k0+3)];
                fy += gout5y * dm[(i0+0)*nao+(k0+3)];
                fz += gout5z * dm[(i0+0)*nao+(k0+3)];
                fx += gout8x * dm[(i0+0)*nao+(k0+5)];
                fy += gout8y * dm[(i0+0)*nao+(k0+5)];
                fz += gout8z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout4x * dm[(i0+0)*nao+(k0+2)];
                fy += gout4y * dm[(i0+0)*nao+(k0+2)];
                fz += gout4z * dm[(i0+0)*nao+(k0+2)];
                fx += gout7x * dm[(i0+0)*nao+(k0+4)];
                fy += gout7y * dm[(i0+0)*nao+(k0+4)];
                fz += gout7z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+1)*nao+(l0+0)];
                fy = gout0y * dm[(j0+1)*nao+(l0+0)];
                fz = gout0z * dm[(j0+1)*nao+(l0+0)];
                fx += gout1x * dm[(j0+5)*nao+(l0+0)];
                fy += gout1y * dm[(j0+5)*nao+(l0+0)];
                fz += gout1z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+3)*nao+(l0+0)];
                fy = gout2y * dm[(j0+3)*nao+(l0+0)];
                fz = gout2z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(j0+1)*nao+(l0+0)];
                fy = gout3y * dm[(j0+1)*nao+(l0+0)];
                fz = gout3z * dm[(j0+1)*nao+(l0+0)];
                fx += gout4x * dm[(j0+5)*nao+(l0+0)];
                fy += gout4y * dm[(j0+5)*nao+(l0+0)];
                fz += gout4z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout5x * dm[(j0+3)*nao+(l0+0)];
                fy = gout5y * dm[(j0+3)*nao+(l0+0)];
                fz = gout5z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout6x * dm[(j0+1)*nao+(l0+0)];
                fy = gout6y * dm[(j0+1)*nao+(l0+0)];
                fz = gout6z * dm[(j0+1)*nao+(l0+0)];
                fx += gout7x * dm[(j0+5)*nao+(l0+0)];
                fy += gout7y * dm[(j0+5)*nao+(l0+0)];
                fz += gout7z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout8x * dm[(j0+3)*nao+(l0+0)];
                fy = gout8y * dm[(j0+3)*nao+(l0+0)];
                fz = gout8z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+4), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+1), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+3), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+0)];
                fy = gout8y * dm[(i0+0)*nao+(l0+0)];
                fz = gout8z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+5), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+2), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+4), fz);
                break;
                case 2:
                fx = gout1x * dm[(j0+0)*nao+(k0+1)];
                fy = gout1y * dm[(j0+0)*nao+(k0+1)];
                fz = gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout4x * dm[(j0+0)*nao+(k0+3)];
                fy += gout4y * dm[(j0+0)*nao+(k0+3)];
                fz += gout4z * dm[(j0+0)*nao+(k0+3)];
                fx += gout7x * dm[(j0+0)*nao+(k0+5)];
                fy += gout7y * dm[(j0+0)*nao+(k0+5)];
                fz += gout7z * dm[(j0+0)*nao+(k0+5)];
                fx += gout0x * dm[(j0+2)*nao+(k0+0)];
                fy += gout0y * dm[(j0+2)*nao+(k0+0)];
                fz += gout0z * dm[(j0+2)*nao+(k0+0)];
                fx += gout3x * dm[(j0+2)*nao+(k0+2)];
                fy += gout3y * dm[(j0+2)*nao+(k0+2)];
                fz += gout3z * dm[(j0+2)*nao+(k0+2)];
                fx += gout6x * dm[(j0+2)*nao+(k0+4)];
                fy += gout6y * dm[(j0+2)*nao+(k0+4)];
                fz += gout6z * dm[(j0+2)*nao+(k0+4)];
                fx += gout2x * dm[(j0+4)*nao+(k0+1)];
                fy += gout2y * dm[(j0+4)*nao+(k0+1)];
                fz += gout2z * dm[(j0+4)*nao+(k0+1)];
                fx += gout5x * dm[(j0+4)*nao+(k0+3)];
                fy += gout5y * dm[(j0+4)*nao+(k0+3)];
                fz += gout5z * dm[(j0+4)*nao+(k0+3)];
                fx += gout8x * dm[(j0+4)*nao+(k0+5)];
                fy += gout8y * dm[(j0+4)*nao+(k0+5)];
                fz += gout8z * dm[(j0+4)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+1)];
                fy = gout1y * dm[(i0+0)*nao+(k0+1)];
                fz = gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout4x * dm[(i0+0)*nao+(k0+3)];
                fy += gout4y * dm[(i0+0)*nao+(k0+3)];
                fz += gout4z * dm[(i0+0)*nao+(k0+3)];
                fx += gout7x * dm[(i0+0)*nao+(k0+5)];
                fy += gout7y * dm[(i0+0)*nao+(k0+5)];
                fz += gout7z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+2)];
                fy += gout3y * dm[(i0+0)*nao+(k0+2)];
                fz += gout3z * dm[(i0+0)*nao+(k0+2)];
                fx += gout6x * dm[(i0+0)*nao+(k0+4)];
                fy += gout6y * dm[(i0+0)*nao+(k0+4)];
                fz += gout6z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+1)];
                fy = gout2y * dm[(i0+0)*nao+(k0+1)];
                fz = gout2z * dm[(i0+0)*nao+(k0+1)];
                fx += gout5x * dm[(i0+0)*nao+(k0+3)];
                fy += gout5y * dm[(i0+0)*nao+(k0+3)];
                fz += gout5z * dm[(i0+0)*nao+(k0+3)];
                fx += gout8x * dm[(i0+0)*nao+(k0+5)];
                fy += gout8y * dm[(i0+0)*nao+(k0+5)];
                fz += gout8z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+2)*nao+(l0+0)];
                fy = gout0y * dm[(j0+2)*nao+(l0+0)];
                fz = gout0z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout2x * dm[(j0+4)*nao+(l0+0)];
                fy += gout2y * dm[(j0+4)*nao+(l0+0)];
                fz += gout2z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(j0+2)*nao+(l0+0)];
                fy = gout3y * dm[(j0+2)*nao+(l0+0)];
                fz = gout3z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout5x * dm[(j0+4)*nao+(l0+0)];
                fy += gout5y * dm[(j0+4)*nao+(l0+0)];
                fz += gout5z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout6x * dm[(j0+2)*nao+(l0+0)];
                fy = gout6y * dm[(j0+2)*nao+(l0+0)];
                fz = gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+0)];
                fy = gout7y * dm[(j0+0)*nao+(l0+0)];
                fz = gout7z * dm[(j0+0)*nao+(l0+0)];
                fx += gout8x * dm[(j0+4)*nao+(l0+0)];
                fy += gout8y * dm[(j0+4)*nao+(l0+0)];
                fz += gout8z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+4), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+1), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+3), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+0)];
                fy = gout8y * dm[(i0+0)*nao+(l0+0)];
                fz = gout8z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+5), fz);
                break;
                case 3:
                fx = gout1x * dm[(j0+1)*nao+(k0+1)];
                fy = gout1y * dm[(j0+1)*nao+(k0+1)];
                fz = gout1z * dm[(j0+1)*nao+(k0+1)];
                fx += gout4x * dm[(j0+1)*nao+(k0+3)];
                fy += gout4y * dm[(j0+1)*nao+(k0+3)];
                fz += gout4z * dm[(j0+1)*nao+(k0+3)];
                fx += gout7x * dm[(j0+1)*nao+(k0+5)];
                fy += gout7y * dm[(j0+1)*nao+(k0+5)];
                fz += gout7z * dm[(j0+1)*nao+(k0+5)];
                fx += gout0x * dm[(j0+3)*nao+(k0+0)];
                fy += gout0y * dm[(j0+3)*nao+(k0+0)];
                fz += gout0z * dm[(j0+3)*nao+(k0+0)];
                fx += gout3x * dm[(j0+3)*nao+(k0+2)];
                fy += gout3y * dm[(j0+3)*nao+(k0+2)];
                fz += gout3z * dm[(j0+3)*nao+(k0+2)];
                fx += gout6x * dm[(j0+3)*nao+(k0+4)];
                fy += gout6y * dm[(j0+3)*nao+(k0+4)];
                fz += gout6z * dm[(j0+3)*nao+(k0+4)];
                fx += gout2x * dm[(j0+5)*nao+(k0+1)];
                fy += gout2y * dm[(j0+5)*nao+(k0+1)];
                fz += gout2z * dm[(j0+5)*nao+(k0+1)];
                fx += gout5x * dm[(j0+5)*nao+(k0+3)];
                fy += gout5y * dm[(j0+5)*nao+(k0+3)];
                fz += gout5z * dm[(j0+5)*nao+(k0+3)];
                fx += gout8x * dm[(j0+5)*nao+(k0+5)];
                fy += gout8y * dm[(j0+5)*nao+(k0+5)];
                fz += gout8z * dm[(j0+5)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+1)];
                fy = gout1y * dm[(i0+0)*nao+(k0+1)];
                fz = gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout4x * dm[(i0+0)*nao+(k0+3)];
                fy += gout4y * dm[(i0+0)*nao+(k0+3)];
                fz += gout4z * dm[(i0+0)*nao+(k0+3)];
                fx += gout7x * dm[(i0+0)*nao+(k0+5)];
                fy += gout7y * dm[(i0+0)*nao+(k0+5)];
                fz += gout7z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+2)];
                fy += gout3y * dm[(i0+0)*nao+(k0+2)];
                fz += gout3z * dm[(i0+0)*nao+(k0+2)];
                fx += gout6x * dm[(i0+0)*nao+(k0+4)];
                fy += gout6y * dm[(i0+0)*nao+(k0+4)];
                fz += gout6z * dm[(i0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+1)];
                fy = gout2y * dm[(i0+0)*nao+(k0+1)];
                fz = gout2z * dm[(i0+0)*nao+(k0+1)];
                fx += gout5x * dm[(i0+0)*nao+(k0+3)];
                fy += gout5y * dm[(i0+0)*nao+(k0+3)];
                fz += gout5z * dm[(i0+0)*nao+(k0+3)];
                fx += gout8x * dm[(i0+0)*nao+(k0+5)];
                fy += gout8y * dm[(i0+0)*nao+(k0+5)];
                fz += gout8z * dm[(i0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+3)*nao+(l0+0)];
                fy = gout0y * dm[(j0+3)*nao+(l0+0)];
                fz = gout0z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout2x * dm[(j0+5)*nao+(l0+0)];
                fy += gout2y * dm[(j0+5)*nao+(l0+0)];
                fz += gout2z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(j0+3)*nao+(l0+0)];
                fy = gout3y * dm[(j0+3)*nao+(l0+0)];
                fz = gout3z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout4x * dm[(j0+1)*nao+(l0+0)];
                fy = gout4y * dm[(j0+1)*nao+(l0+0)];
                fz = gout4z * dm[(j0+1)*nao+(l0+0)];
                fx += gout5x * dm[(j0+5)*nao+(l0+0)];
                fy += gout5y * dm[(j0+5)*nao+(l0+0)];
                fz += gout5z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout6x * dm[(j0+3)*nao+(l0+0)];
                fy = gout6y * dm[(j0+3)*nao+(l0+0)];
                fz = gout6z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout7x * dm[(j0+1)*nao+(l0+0)];
                fy = gout7y * dm[(j0+1)*nao+(l0+0)];
                fz = gout7z * dm[(j0+1)*nao+(l0+0)];
                fx += gout8x * dm[(j0+5)*nao+(l0+0)];
                fy += gout8y * dm[(j0+5)*nao+(l0+0)];
                fz += gout8z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+3), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+2), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+4), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+1), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+3), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+0)];
                fy = gout8y * dm[(i0+0)*nao+(l0+0)];
                fz = gout8z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+5), fz);
                break;
                }
            }
        }
    }
}
__global__
static void rys_vjk_ip1_0220(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_0220(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_1000(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    ai2 = rjri[5];
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    fx = ai2 * trr_20x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    fx -= 1 * 1;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += trr_10x *  fy  * wt;
                    gout0z += trr_10x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * 1;
                    gout1x +=  fx  * trr_10y * wt;
                    gout1y += 1 *  fy  * wt;
                    gout1z += 1 * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout2x +=  fx  * 1 * trr_10z;
                    gout2y += 1 *  fy  * trr_10z;
                    gout2z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+1)];
                fy += gout1y * dm[(j0+0)*nao+(i0+1)];
                fz += gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+2)];
                fy += gout2y * dm[(j0+0)*nao+(i0+2)];
                fz += gout2z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+0)];
                fy = gout2y * dm[(j0+0)*nao+(k0+0)];
                fz = gout2z * dm[(j0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+1)*nao+(l0+0)];
                fy += gout1y * dm[(i0+1)*nao+(l0+0)];
                fz += gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
            }
        }
    }
}
#if CUDA_VERSION >= 12040
__global__ __maxnreg__(128)
#else
__global__
#endif
static void rys_vjk_ip1_1000(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_1000(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_1010(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_21x = cpx * trr_20x + 2*b00 * trr_10x;
                    fx = ai2 * trr_21x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_01x = cpx * 1;
                    fx -= 1 * trr_01x;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += trr_11x *  fy  * wt;
                    gout0z += trr_11x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * 1;
                    gout1x +=  fx  * trr_10y * wt;
                    gout1y += trr_01x *  fy  * wt;
                    gout1z += trr_01x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout2x +=  fx  * 1 * trr_10z;
                    gout2y += trr_01x *  fy  * trr_10z;
                    gout2z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * 1;
                    double trr_01y = cpy * 1;
                    gout3x +=  fx  * trr_01y * wt;
                    gout3y += trr_10x *  fy  * wt;
                    gout3z += trr_10x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_21y = cpy * trr_20y + 2*b00 * trr_10y;
                    fy = ai2 * trr_21y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * trr_01y;
                    gout4x +=  fx  * trr_11y * wt;
                    gout4y += 1 *  fy  * wt;
                    gout4z += 1 * trr_11y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout5x +=  fx  * trr_01y * trr_10z;
                    gout5y += 1 *  fy  * trr_10z;
                    gout5z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    fx -= 1 * 1;
                    double trr_01z = cpz * wt;
                    gout6x +=  fx  * 1 * trr_01z;
                    gout6y += trr_10x *  fy  * trr_01z;
                    gout6z += trr_10x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_11z;
                    fy -= 1 * 1;
                    gout7x +=  fx  * trr_10y * trr_01z;
                    gout7y += 1 *  fy  * trr_01z;
                    gout7z += 1 * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_21z = cpz * trr_20z + 2*b00 * trr_10z;
                    fz = ai2 * trr_21z;
                    fz -= 1 * trr_01z;
                    gout8x +=  fx  * 1 * trr_11z;
                    gout8y += 1 *  fy  * trr_11z;
                    gout8z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+1)];
                fy += gout3y * dm[(l0+0)*nao+(k0+1)];
                fz += gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout6x * dm[(l0+0)*nao+(k0+2)];
                fy += gout6y * dm[(l0+0)*nao+(k0+2)];
                fz += gout6z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+1)];
                fy += gout4y * dm[(l0+0)*nao+(k0+1)];
                fz += gout4z * dm[(l0+0)*nao+(k0+1)];
                fx += gout7x * dm[(l0+0)*nao+(k0+2)];
                fy += gout7y * dm[(l0+0)*nao+(k0+2)];
                fz += gout7z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout5x * dm[(l0+0)*nao+(k0+1)];
                fy += gout5y * dm[(l0+0)*nao+(k0+1)];
                fz += gout5z * dm[(l0+0)*nao+(k0+1)];
                fx += gout8x * dm[(l0+0)*nao+(k0+2)];
                fy += gout8y * dm[(l0+0)*nao+(k0+2)];
                fz += gout8z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+1)];
                fy += gout1y * dm[(j0+0)*nao+(i0+1)];
                fz += gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+2)];
                fy += gout2y * dm[(j0+0)*nao+(i0+2)];
                fz += gout2z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                fx += gout4x * dm[(j0+0)*nao+(i0+1)];
                fy += gout4y * dm[(j0+0)*nao+(i0+1)];
                fz += gout4z * dm[(j0+0)*nao+(i0+1)];
                fx += gout5x * dm[(j0+0)*nao+(i0+2)];
                fy += gout5y * dm[(j0+0)*nao+(i0+2)];
                fz += gout5z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+0)*nao+(i0+1)];
                fy += gout7y * dm[(j0+0)*nao+(i0+1)];
                fz += gout7z * dm[(j0+0)*nao+(i0+1)];
                fx += gout8x * dm[(j0+0)*nao+(i0+2)];
                fy += gout8y * dm[(j0+0)*nao+(i0+2)];
                fz += gout8z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+1)];
                fy += gout3y * dm[(j0+0)*nao+(k0+1)];
                fz += gout3z * dm[(j0+0)*nao+(k0+1)];
                fx += gout6x * dm[(j0+0)*nao+(k0+2)];
                fy += gout6y * dm[(j0+0)*nao+(k0+2)];
                fz += gout6z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+0)*nao+(k0+1)];
                fy += gout4y * dm[(j0+0)*nao+(k0+1)];
                fz += gout4z * dm[(j0+0)*nao+(k0+1)];
                fx += gout7x * dm[(j0+0)*nao+(k0+2)];
                fy += gout7y * dm[(j0+0)*nao+(k0+2)];
                fz += gout7z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+0)];
                fy = gout2y * dm[(j0+0)*nao+(k0+0)];
                fz = gout2z * dm[(j0+0)*nao+(k0+0)];
                fx += gout5x * dm[(j0+0)*nao+(k0+1)];
                fy += gout5y * dm[(j0+0)*nao+(k0+1)];
                fz += gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout8x * dm[(j0+0)*nao+(k0+2)];
                fy += gout8y * dm[(j0+0)*nao+(k0+2)];
                fz += gout8z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+1)];
                fy += gout3y * dm[(i0+0)*nao+(k0+1)];
                fz += gout3z * dm[(i0+0)*nao+(k0+1)];
                fx += gout6x * dm[(i0+0)*nao+(k0+2)];
                fy += gout6y * dm[(i0+0)*nao+(k0+2)];
                fz += gout6z * dm[(i0+0)*nao+(k0+2)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout4x * dm[(i0+1)*nao+(k0+1)];
                fy += gout4y * dm[(i0+1)*nao+(k0+1)];
                fz += gout4z * dm[(i0+1)*nao+(k0+1)];
                fx += gout7x * dm[(i0+1)*nao+(k0+2)];
                fy += gout7y * dm[(i0+1)*nao+(k0+2)];
                fz += gout7z * dm[(i0+1)*nao+(k0+2)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                fx += gout5x * dm[(i0+2)*nao+(k0+1)];
                fy += gout5y * dm[(i0+2)*nao+(k0+1)];
                fz += gout5z * dm[(i0+2)*nao+(k0+1)];
                fx += gout8x * dm[(i0+2)*nao+(k0+2)];
                fy += gout8y * dm[(i0+2)*nao+(k0+2)];
                fz += gout8z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+0)];
                fy = gout7y * dm[(j0+0)*nao+(l0+0)];
                fz = gout7z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+0)];
                fy = gout8y * dm[(j0+0)*nao+(l0+0)];
                fz = gout8z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+1)*nao+(l0+0)];
                fy += gout1y * dm[(i0+1)*nao+(l0+0)];
                fz += gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout4x * dm[(i0+1)*nao+(l0+0)];
                fy += gout4y * dm[(i0+1)*nao+(l0+0)];
                fz += gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout5x * dm[(i0+2)*nao+(l0+0)];
                fy += gout5y * dm[(i0+2)*nao+(l0+0)];
                fz += gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+1)*nao+(l0+0)];
                fy += gout7y * dm[(i0+1)*nao+(l0+0)];
                fz += gout7z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+2)*nao+(l0+0)];
                fy += gout8y * dm[(i0+2)*nao+(l0+0)];
                fz += gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_1010(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_1010(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_1011(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double gout18x, gout18y, gout18z;
    double gout19x, gout19y, gout19z;
    double gout20x, gout20y, gout20z;
    double gout21x, gout21y, gout21z;
    double gout22x, gout22y, gout22z;
    double gout23x, gout23y, gout23z;
    double gout24x, gout24y, gout24z;
    double gout25x, gout25y, gout25z;
    double gout26x, gout26y, gout26z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        gout18x = 0;
        gout18y = 0;
        gout18z = 0;
        gout19x = 0;
        gout19y = 0;
        gout19z = 0;
        gout20x = 0;
        gout20y = 0;
        gout20z = 0;
        gout21x = 0;
        gout21y = 0;
        gout21z = 0;
        gout22x = 0;
        gout22y = 0;
        gout22z = 0;
        gout23x = 0;
        gout23y = 0;
        gout23z = 0;
        gout24x = 0;
        gout24y = 0;
        gout24z = 0;
        gout25x = 0;
        gout25y = 0;
        gout25z = 0;
        gout26x = 0;
        gout26y = 0;
        gout26z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double b01 = .5/akl * (1 - rt_akl);
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_21x = cpx * trr_20x + 2*b00 * trr_10x;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double trr_22x = cpx * trr_21x + 1*b01 * trr_20x + 2*b00 * trr_11x;
                    double hrr_2011x = trr_22x - (rl[0] - rk[0]) * trr_21x;
                    fx = ai2 * hrr_2011x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_01x = cpx * 1;
                    double trr_02x = cpx * trr_01x + 1*b01 * 1;
                    double hrr_0011x = trr_02x - (rl[0] - rk[0]) * trr_01x;
                    fx -= 1 * hrr_0011x;
                    double trr_12x = cpx * trr_11x + 1*b01 * trr_10x + 1*b00 * trr_01x;
                    double hrr_1011x = trr_12x - (rl[0] - rk[0]) * trr_11x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_1011x *  fy  * wt;
                    gout0z += hrr_1011x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1011x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * 1;
                    gout1x +=  fx  * trr_10y * wt;
                    gout1y += hrr_0011x *  fy  * wt;
                    gout1z += hrr_0011x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1011x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout2x +=  fx  * 1 * trr_10z;
                    gout2y += hrr_0011x *  fy  * trr_10z;
                    gout2z += hrr_0011x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_2001x = trr_21x - (rl[0] - rk[0]) * trr_20x;
                    fx = ai2 * hrr_2001x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    double hrr_0001x = trr_01x - (rl[0] - rk[0]) * 1;
                    fx -= 1 * hrr_0001x;
                    double hrr_1001x = trr_11x - (rl[0] - rk[0]) * trr_10x;
                    double trr_01y = cpy * 1;
                    gout3x +=  fx  * trr_01y * wt;
                    gout3y += hrr_1001x *  fy  * wt;
                    gout3z += hrr_1001x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    double trr_21y = cpy * trr_20y + 2*b00 * trr_10y;
                    fy = ai2 * trr_21y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * trr_01y;
                    gout4x +=  fx  * trr_11y * wt;
                    gout4y += hrr_0001x *  fy  * wt;
                    gout4z += hrr_0001x * trr_11y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout5x +=  fx  * trr_01y * trr_10z;
                    gout5y += hrr_0001x *  fy  * trr_10z;
                    gout5z += hrr_0001x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_2001x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    fx -= 1 * hrr_0001x;
                    double trr_01z = cpz * wt;
                    gout6x +=  fx  * 1 * trr_01z;
                    gout6y += hrr_1001x *  fy  * trr_01z;
                    gout6z += hrr_1001x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_11z;
                    fy -= 1 * 1;
                    gout7x +=  fx  * trr_10y * trr_01z;
                    gout7y += hrr_0001x *  fy  * trr_01z;
                    gout7z += hrr_0001x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1001x;
                    fy = ai2 * trr_10y;
                    double trr_21z = cpz * trr_20z + 2*b00 * trr_10z;
                    fz = ai2 * trr_21z;
                    fz -= 1 * trr_01z;
                    gout8x +=  fx  * 1 * trr_11z;
                    gout8y += hrr_0001x *  fy  * trr_11z;
                    gout8z += hrr_0001x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_21x;
                    double hrr_1001y = trr_11y - (rl[1] - rk[1]) * trr_10y;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * trr_01x;
                    double hrr_0001y = trr_01y - (rl[1] - rk[1]) * 1;
                    gout9x +=  fx  * hrr_0001y * wt;
                    gout9y += trr_11x *  fy  * wt;
                    gout9z += trr_11x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double hrr_2001y = trr_21y - (rl[1] - rk[1]) * trr_20y;
                    fy = ai2 * hrr_2001y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * hrr_0001y;
                    gout10x +=  fx  * hrr_1001y * wt;
                    gout10y += trr_01x *  fy  * wt;
                    gout10z += trr_01x * hrr_1001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout11x +=  fx  * hrr_0001y * trr_10z;
                    gout11y += trr_01x *  fy  * trr_10z;
                    gout11z += trr_01x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    double trr_12y = cpy * trr_11y + 1*b01 * trr_10y + 1*b00 * trr_01y;
                    double hrr_1011y = trr_12y - (rl[1] - rk[1]) * trr_11y;
                    fy = ai2 * hrr_1011y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * 1;
                    double trr_02y = cpy * trr_01y + 1*b01 * 1;
                    double hrr_0011y = trr_02y - (rl[1] - rk[1]) * trr_01y;
                    gout12x +=  fx  * hrr_0011y * wt;
                    gout12y += trr_10x *  fy  * wt;
                    gout12z += trr_10x * hrr_0011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_22y = cpy * trr_21y + 1*b01 * trr_20y + 2*b00 * trr_11y;
                    double hrr_2011y = trr_22y - (rl[1] - rk[1]) * trr_21y;
                    fy = ai2 * hrr_2011y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * hrr_0011y;
                    gout13x +=  fx  * hrr_1011y * wt;
                    gout13y += 1 *  fy  * wt;
                    gout13z += 1 * hrr_1011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1011y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout14x +=  fx  * hrr_0011y * trr_10z;
                    gout14y += 1 *  fy  * trr_10z;
                    gout14z += 1 * hrr_0011y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_11z;
                    fx -= 1 * 1;
                    gout15x +=  fx  * hrr_0001y * trr_01z;
                    gout15y += trr_10x *  fy  * trr_01z;
                    gout15z += trr_10x * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_2001y;
                    fz = ai2 * trr_11z;
                    fy -= 1 * hrr_0001y;
                    gout16x +=  fx  * hrr_1001y * trr_01z;
                    gout16y += 1 *  fy  * trr_01z;
                    gout16z += 1 * hrr_1001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1001y;
                    fz = ai2 * trr_21z;
                    fz -= 1 * trr_01z;
                    gout17x +=  fx  * hrr_0001y * trr_11z;
                    gout17y += 1 *  fy  * trr_11z;
                    gout17z += 1 * hrr_0001y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_21x;
                    fy = ai2 * trr_10y;
                    double hrr_1001z = trr_11z - (rl[2] - rk[2]) * trr_10z;
                    fz = ai2 * hrr_1001z;
                    fx -= 1 * trr_01x;
                    double hrr_0001z = trr_01z - (rl[2] - rk[2]) * wt;
                    gout18x +=  fx  * 1 * hrr_0001z;
                    gout18y += trr_11x *  fy  * hrr_0001z;
                    gout18z += trr_11x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * hrr_1001z;
                    fy -= 1 * 1;
                    gout19x +=  fx  * trr_10y * hrr_0001z;
                    gout19y += trr_01x *  fy  * hrr_0001z;
                    gout19z += trr_01x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double hrr_2001z = trr_21z - (rl[2] - rk[2]) * trr_20z;
                    fz = ai2 * hrr_2001z;
                    fz -= 1 * hrr_0001z;
                    gout20x +=  fx  * 1 * hrr_1001z;
                    gout20y += trr_01x *  fy  * hrr_1001z;
                    gout20z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1001z;
                    fx -= 1 * 1;
                    gout21x +=  fx  * trr_01y * hrr_0001z;
                    gout21y += trr_10x *  fy  * hrr_0001z;
                    gout21z += trr_10x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_21y;
                    fz = ai2 * hrr_1001z;
                    fy -= 1 * trr_01y;
                    gout22x +=  fx  * trr_11y * hrr_0001z;
                    gout22y += 1 *  fy  * hrr_0001z;
                    gout22z += 1 * trr_11y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_2001z;
                    fz -= 1 * hrr_0001z;
                    gout23x +=  fx  * trr_01y * hrr_1001z;
                    gout23y += 1 *  fy  * hrr_1001z;
                    gout23z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_10y;
                    double trr_12z = cpz * trr_11z + 1*b01 * trr_10z + 1*b00 * trr_01z;
                    double hrr_1011z = trr_12z - (rl[2] - rk[2]) * trr_11z;
                    fz = ai2 * hrr_1011z;
                    fx -= 1 * 1;
                    double trr_02z = cpz * trr_01z + 1*b01 * wt;
                    double hrr_0011z = trr_02z - (rl[2] - rk[2]) * trr_01z;
                    gout24x +=  fx  * 1 * hrr_0011z;
                    gout24y += trr_10x *  fy  * hrr_0011z;
                    gout24z += trr_10x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * hrr_1011z;
                    fy -= 1 * 1;
                    gout25x +=  fx  * trr_10y * hrr_0011z;
                    gout25y += 1 *  fy  * hrr_0011z;
                    gout25z += 1 * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_22z = cpz * trr_21z + 1*b01 * trr_20z + 2*b00 * trr_11z;
                    double hrr_2011z = trr_22z - (rl[2] - rk[2]) * trr_21z;
                    fz = ai2 * hrr_2011z;
                    fz -= 1 * hrr_0011z;
                    gout26x +=  fx  * 1 * hrr_1011z;
                    gout26y += 1 *  fy  * hrr_1011z;
                    gout26z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+1)];
                fy += gout3y * dm[(l0+0)*nao+(k0+1)];
                fz += gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout6x * dm[(l0+0)*nao+(k0+2)];
                fy += gout6y * dm[(l0+0)*nao+(k0+2)];
                fz += gout6z * dm[(l0+0)*nao+(k0+2)];
                fx += gout9x * dm[(l0+1)*nao+(k0+0)];
                fy += gout9y * dm[(l0+1)*nao+(k0+0)];
                fz += gout9z * dm[(l0+1)*nao+(k0+0)];
                fx += gout12x * dm[(l0+1)*nao+(k0+1)];
                fy += gout12y * dm[(l0+1)*nao+(k0+1)];
                fz += gout12z * dm[(l0+1)*nao+(k0+1)];
                fx += gout15x * dm[(l0+1)*nao+(k0+2)];
                fy += gout15y * dm[(l0+1)*nao+(k0+2)];
                fz += gout15z * dm[(l0+1)*nao+(k0+2)];
                fx += gout18x * dm[(l0+2)*nao+(k0+0)];
                fy += gout18y * dm[(l0+2)*nao+(k0+0)];
                fz += gout18z * dm[(l0+2)*nao+(k0+0)];
                fx += gout21x * dm[(l0+2)*nao+(k0+1)];
                fy += gout21y * dm[(l0+2)*nao+(k0+1)];
                fz += gout21z * dm[(l0+2)*nao+(k0+1)];
                fx += gout24x * dm[(l0+2)*nao+(k0+2)];
                fy += gout24y * dm[(l0+2)*nao+(k0+2)];
                fz += gout24z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+1)];
                fy += gout4y * dm[(l0+0)*nao+(k0+1)];
                fz += gout4z * dm[(l0+0)*nao+(k0+1)];
                fx += gout7x * dm[(l0+0)*nao+(k0+2)];
                fy += gout7y * dm[(l0+0)*nao+(k0+2)];
                fz += gout7z * dm[(l0+0)*nao+(k0+2)];
                fx += gout10x * dm[(l0+1)*nao+(k0+0)];
                fy += gout10y * dm[(l0+1)*nao+(k0+0)];
                fz += gout10z * dm[(l0+1)*nao+(k0+0)];
                fx += gout13x * dm[(l0+1)*nao+(k0+1)];
                fy += gout13y * dm[(l0+1)*nao+(k0+1)];
                fz += gout13z * dm[(l0+1)*nao+(k0+1)];
                fx += gout16x * dm[(l0+1)*nao+(k0+2)];
                fy += gout16y * dm[(l0+1)*nao+(k0+2)];
                fz += gout16z * dm[(l0+1)*nao+(k0+2)];
                fx += gout19x * dm[(l0+2)*nao+(k0+0)];
                fy += gout19y * dm[(l0+2)*nao+(k0+0)];
                fz += gout19z * dm[(l0+2)*nao+(k0+0)];
                fx += gout22x * dm[(l0+2)*nao+(k0+1)];
                fy += gout22y * dm[(l0+2)*nao+(k0+1)];
                fz += gout22z * dm[(l0+2)*nao+(k0+1)];
                fx += gout25x * dm[(l0+2)*nao+(k0+2)];
                fy += gout25y * dm[(l0+2)*nao+(k0+2)];
                fz += gout25z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout5x * dm[(l0+0)*nao+(k0+1)];
                fy += gout5y * dm[(l0+0)*nao+(k0+1)];
                fz += gout5z * dm[(l0+0)*nao+(k0+1)];
                fx += gout8x * dm[(l0+0)*nao+(k0+2)];
                fy += gout8y * dm[(l0+0)*nao+(k0+2)];
                fz += gout8z * dm[(l0+0)*nao+(k0+2)];
                fx += gout11x * dm[(l0+1)*nao+(k0+0)];
                fy += gout11y * dm[(l0+1)*nao+(k0+0)];
                fz += gout11z * dm[(l0+1)*nao+(k0+0)];
                fx += gout14x * dm[(l0+1)*nao+(k0+1)];
                fy += gout14y * dm[(l0+1)*nao+(k0+1)];
                fz += gout14z * dm[(l0+1)*nao+(k0+1)];
                fx += gout17x * dm[(l0+1)*nao+(k0+2)];
                fy += gout17y * dm[(l0+1)*nao+(k0+2)];
                fz += gout17z * dm[(l0+1)*nao+(k0+2)];
                fx += gout20x * dm[(l0+2)*nao+(k0+0)];
                fy += gout20y * dm[(l0+2)*nao+(k0+0)];
                fz += gout20z * dm[(l0+2)*nao+(k0+0)];
                fx += gout23x * dm[(l0+2)*nao+(k0+1)];
                fy += gout23y * dm[(l0+2)*nao+(k0+1)];
                fz += gout23z * dm[(l0+2)*nao+(k0+1)];
                fx += gout26x * dm[(l0+2)*nao+(k0+2)];
                fy += gout26y * dm[(l0+2)*nao+(k0+2)];
                fz += gout26z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+1)];
                fy += gout1y * dm[(j0+0)*nao+(i0+1)];
                fz += gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+2)];
                fy += gout2y * dm[(j0+0)*nao+(i0+2)];
                fz += gout2z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                fx += gout4x * dm[(j0+0)*nao+(i0+1)];
                fy += gout4y * dm[(j0+0)*nao+(i0+1)];
                fz += gout4z * dm[(j0+0)*nao+(i0+1)];
                fx += gout5x * dm[(j0+0)*nao+(i0+2)];
                fy += gout5y * dm[(j0+0)*nao+(i0+2)];
                fz += gout5z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+0)*nao+(i0+1)];
                fy += gout7y * dm[(j0+0)*nao+(i0+1)];
                fz += gout7z * dm[(j0+0)*nao+(i0+1)];
                fx += gout8x * dm[(j0+0)*nao+(i0+2)];
                fy += gout8y * dm[(j0+0)*nao+(i0+2)];
                fz += gout8z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                fx += gout10x * dm[(j0+0)*nao+(i0+1)];
                fy += gout10y * dm[(j0+0)*nao+(i0+1)];
                fz += gout10z * dm[(j0+0)*nao+(i0+1)];
                fx += gout11x * dm[(j0+0)*nao+(i0+2)];
                fy += gout11y * dm[(j0+0)*nao+(i0+2)];
                fz += gout11z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                fx += gout13x * dm[(j0+0)*nao+(i0+1)];
                fy += gout13y * dm[(j0+0)*nao+(i0+1)];
                fz += gout13z * dm[(j0+0)*nao+(i0+1)];
                fx += gout14x * dm[(j0+0)*nao+(i0+2)];
                fy += gout14y * dm[(j0+0)*nao+(i0+2)];
                fz += gout14z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout15x * dm[(j0+0)*nao+(i0+0)];
                fy = gout15y * dm[(j0+0)*nao+(i0+0)];
                fz = gout15z * dm[(j0+0)*nao+(i0+0)];
                fx += gout16x * dm[(j0+0)*nao+(i0+1)];
                fy += gout16y * dm[(j0+0)*nao+(i0+1)];
                fz += gout16z * dm[(j0+0)*nao+(i0+1)];
                fx += gout17x * dm[(j0+0)*nao+(i0+2)];
                fy += gout17y * dm[(j0+0)*nao+(i0+2)];
                fz += gout17z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout18x * dm[(j0+0)*nao+(i0+0)];
                fy = gout18y * dm[(j0+0)*nao+(i0+0)];
                fz = gout18z * dm[(j0+0)*nao+(i0+0)];
                fx += gout19x * dm[(j0+0)*nao+(i0+1)];
                fy += gout19y * dm[(j0+0)*nao+(i0+1)];
                fz += gout19z * dm[(j0+0)*nao+(i0+1)];
                fx += gout20x * dm[(j0+0)*nao+(i0+2)];
                fy += gout20y * dm[(j0+0)*nao+(i0+2)];
                fz += gout20z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout21x * dm[(j0+0)*nao+(i0+0)];
                fy = gout21y * dm[(j0+0)*nao+(i0+0)];
                fz = gout21z * dm[(j0+0)*nao+(i0+0)];
                fx += gout22x * dm[(j0+0)*nao+(i0+1)];
                fy += gout22y * dm[(j0+0)*nao+(i0+1)];
                fz += gout22z * dm[(j0+0)*nao+(i0+1)];
                fx += gout23x * dm[(j0+0)*nao+(i0+2)];
                fy += gout23y * dm[(j0+0)*nao+(i0+2)];
                fz += gout23z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout24x * dm[(j0+0)*nao+(i0+0)];
                fy = gout24y * dm[(j0+0)*nao+(i0+0)];
                fz = gout24z * dm[(j0+0)*nao+(i0+0)];
                fx += gout25x * dm[(j0+0)*nao+(i0+1)];
                fy += gout25y * dm[(j0+0)*nao+(i0+1)];
                fz += gout25z * dm[(j0+0)*nao+(i0+1)];
                fx += gout26x * dm[(j0+0)*nao+(i0+2)];
                fy += gout26y * dm[(j0+0)*nao+(i0+2)];
                fz += gout26z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+1)];
                fy += gout3y * dm[(j0+0)*nao+(k0+1)];
                fz += gout3z * dm[(j0+0)*nao+(k0+1)];
                fx += gout6x * dm[(j0+0)*nao+(k0+2)];
                fy += gout6y * dm[(j0+0)*nao+(k0+2)];
                fz += gout6z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+0)];
                fy = gout9y * dm[(j0+0)*nao+(k0+0)];
                fz = gout9z * dm[(j0+0)*nao+(k0+0)];
                fx += gout12x * dm[(j0+0)*nao+(k0+1)];
                fy += gout12y * dm[(j0+0)*nao+(k0+1)];
                fz += gout12z * dm[(j0+0)*nao+(k0+1)];
                fx += gout15x * dm[(j0+0)*nao+(k0+2)];
                fy += gout15y * dm[(j0+0)*nao+(k0+2)];
                fz += gout15z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout18x * dm[(j0+0)*nao+(k0+0)];
                fy = gout18y * dm[(j0+0)*nao+(k0+0)];
                fz = gout18z * dm[(j0+0)*nao+(k0+0)];
                fx += gout21x * dm[(j0+0)*nao+(k0+1)];
                fy += gout21y * dm[(j0+0)*nao+(k0+1)];
                fz += gout21z * dm[(j0+0)*nao+(k0+1)];
                fx += gout24x * dm[(j0+0)*nao+(k0+2)];
                fy += gout24y * dm[(j0+0)*nao+(k0+2)];
                fz += gout24z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+0)*nao+(k0+1)];
                fy += gout4y * dm[(j0+0)*nao+(k0+1)];
                fz += gout4z * dm[(j0+0)*nao+(k0+1)];
                fx += gout7x * dm[(j0+0)*nao+(k0+2)];
                fy += gout7y * dm[(j0+0)*nao+(k0+2)];
                fz += gout7z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout10x * dm[(j0+0)*nao+(k0+0)];
                fy = gout10y * dm[(j0+0)*nao+(k0+0)];
                fz = gout10z * dm[(j0+0)*nao+(k0+0)];
                fx += gout13x * dm[(j0+0)*nao+(k0+1)];
                fy += gout13y * dm[(j0+0)*nao+(k0+1)];
                fz += gout13z * dm[(j0+0)*nao+(k0+1)];
                fx += gout16x * dm[(j0+0)*nao+(k0+2)];
                fy += gout16y * dm[(j0+0)*nao+(k0+2)];
                fz += gout16z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+1), fz);
                fx = gout19x * dm[(j0+0)*nao+(k0+0)];
                fy = gout19y * dm[(j0+0)*nao+(k0+0)];
                fz = gout19z * dm[(j0+0)*nao+(k0+0)];
                fx += gout22x * dm[(j0+0)*nao+(k0+1)];
                fy += gout22y * dm[(j0+0)*nao+(k0+1)];
                fz += gout22z * dm[(j0+0)*nao+(k0+1)];
                fx += gout25x * dm[(j0+0)*nao+(k0+2)];
                fy += gout25y * dm[(j0+0)*nao+(k0+2)];
                fz += gout25z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+0)];
                fy = gout2y * dm[(j0+0)*nao+(k0+0)];
                fz = gout2z * dm[(j0+0)*nao+(k0+0)];
                fx += gout5x * dm[(j0+0)*nao+(k0+1)];
                fy += gout5y * dm[(j0+0)*nao+(k0+1)];
                fz += gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout8x * dm[(j0+0)*nao+(k0+2)];
                fy += gout8y * dm[(j0+0)*nao+(k0+2)];
                fz += gout8z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+0)];
                fy = gout11y * dm[(j0+0)*nao+(k0+0)];
                fz = gout11z * dm[(j0+0)*nao+(k0+0)];
                fx += gout14x * dm[(j0+0)*nao+(k0+1)];
                fy += gout14y * dm[(j0+0)*nao+(k0+1)];
                fz += gout14z * dm[(j0+0)*nao+(k0+1)];
                fx += gout17x * dm[(j0+0)*nao+(k0+2)];
                fy += gout17y * dm[(j0+0)*nao+(k0+2)];
                fz += gout17z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+1), fz);
                fx = gout20x * dm[(j0+0)*nao+(k0+0)];
                fy = gout20y * dm[(j0+0)*nao+(k0+0)];
                fz = gout20z * dm[(j0+0)*nao+(k0+0)];
                fx += gout23x * dm[(j0+0)*nao+(k0+1)];
                fy += gout23y * dm[(j0+0)*nao+(k0+1)];
                fz += gout23z * dm[(j0+0)*nao+(k0+1)];
                fx += gout26x * dm[(j0+0)*nao+(k0+2)];
                fy += gout26y * dm[(j0+0)*nao+(k0+2)];
                fz += gout26z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+1)];
                fy += gout3y * dm[(i0+0)*nao+(k0+1)];
                fz += gout3z * dm[(i0+0)*nao+(k0+1)];
                fx += gout6x * dm[(i0+0)*nao+(k0+2)];
                fy += gout6y * dm[(i0+0)*nao+(k0+2)];
                fz += gout6z * dm[(i0+0)*nao+(k0+2)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout4x * dm[(i0+1)*nao+(k0+1)];
                fy += gout4y * dm[(i0+1)*nao+(k0+1)];
                fz += gout4z * dm[(i0+1)*nao+(k0+1)];
                fx += gout7x * dm[(i0+1)*nao+(k0+2)];
                fy += gout7y * dm[(i0+1)*nao+(k0+2)];
                fz += gout7z * dm[(i0+1)*nao+(k0+2)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                fx += gout5x * dm[(i0+2)*nao+(k0+1)];
                fy += gout5y * dm[(i0+2)*nao+(k0+1)];
                fz += gout5z * dm[(i0+2)*nao+(k0+1)];
                fx += gout8x * dm[(i0+2)*nao+(k0+2)];
                fy += gout8y * dm[(i0+2)*nao+(k0+2)];
                fz += gout8z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+1)];
                fy += gout12y * dm[(i0+0)*nao+(k0+1)];
                fz += gout12z * dm[(i0+0)*nao+(k0+1)];
                fx += gout15x * dm[(i0+0)*nao+(k0+2)];
                fy += gout15y * dm[(i0+0)*nao+(k0+2)];
                fz += gout15z * dm[(i0+0)*nao+(k0+2)];
                fx += gout10x * dm[(i0+1)*nao+(k0+0)];
                fy += gout10y * dm[(i0+1)*nao+(k0+0)];
                fz += gout10z * dm[(i0+1)*nao+(k0+0)];
                fx += gout13x * dm[(i0+1)*nao+(k0+1)];
                fy += gout13y * dm[(i0+1)*nao+(k0+1)];
                fz += gout13z * dm[(i0+1)*nao+(k0+1)];
                fx += gout16x * dm[(i0+1)*nao+(k0+2)];
                fy += gout16y * dm[(i0+1)*nao+(k0+2)];
                fz += gout16z * dm[(i0+1)*nao+(k0+2)];
                fx += gout11x * dm[(i0+2)*nao+(k0+0)];
                fy += gout11y * dm[(i0+2)*nao+(k0+0)];
                fz += gout11z * dm[(i0+2)*nao+(k0+0)];
                fx += gout14x * dm[(i0+2)*nao+(k0+1)];
                fy += gout14y * dm[(i0+2)*nao+(k0+1)];
                fz += gout14z * dm[(i0+2)*nao+(k0+1)];
                fx += gout17x * dm[(i0+2)*nao+(k0+2)];
                fy += gout17y * dm[(i0+2)*nao+(k0+2)];
                fz += gout17z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout18x * dm[(i0+0)*nao+(k0+0)];
                fy = gout18y * dm[(i0+0)*nao+(k0+0)];
                fz = gout18z * dm[(i0+0)*nao+(k0+0)];
                fx += gout21x * dm[(i0+0)*nao+(k0+1)];
                fy += gout21y * dm[(i0+0)*nao+(k0+1)];
                fz += gout21z * dm[(i0+0)*nao+(k0+1)];
                fx += gout24x * dm[(i0+0)*nao+(k0+2)];
                fy += gout24y * dm[(i0+0)*nao+(k0+2)];
                fz += gout24z * dm[(i0+0)*nao+(k0+2)];
                fx += gout19x * dm[(i0+1)*nao+(k0+0)];
                fy += gout19y * dm[(i0+1)*nao+(k0+0)];
                fz += gout19z * dm[(i0+1)*nao+(k0+0)];
                fx += gout22x * dm[(i0+1)*nao+(k0+1)];
                fy += gout22y * dm[(i0+1)*nao+(k0+1)];
                fz += gout22z * dm[(i0+1)*nao+(k0+1)];
                fx += gout25x * dm[(i0+1)*nao+(k0+2)];
                fy += gout25y * dm[(i0+1)*nao+(k0+2)];
                fz += gout25z * dm[(i0+1)*nao+(k0+2)];
                fx += gout20x * dm[(i0+2)*nao+(k0+0)];
                fy += gout20y * dm[(i0+2)*nao+(k0+0)];
                fz += gout20z * dm[(i0+2)*nao+(k0+0)];
                fx += gout23x * dm[(i0+2)*nao+(k0+1)];
                fy += gout23y * dm[(i0+2)*nao+(k0+1)];
                fz += gout23z * dm[(i0+2)*nao+(k0+1)];
                fx += gout26x * dm[(i0+2)*nao+(k0+2)];
                fy += gout26y * dm[(i0+2)*nao+(k0+2)];
                fz += gout26z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+1)];
                fy += gout9y * dm[(j0+0)*nao+(l0+1)];
                fz += gout9z * dm[(j0+0)*nao+(l0+1)];
                fx += gout18x * dm[(j0+0)*nao+(l0+2)];
                fy += gout18y * dm[(j0+0)*nao+(l0+2)];
                fz += gout18z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+1)];
                fy += gout12y * dm[(j0+0)*nao+(l0+1)];
                fz += gout12z * dm[(j0+0)*nao+(l0+1)];
                fx += gout21x * dm[(j0+0)*nao+(l0+2)];
                fy += gout21y * dm[(j0+0)*nao+(l0+2)];
                fz += gout21z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                fx += gout15x * dm[(j0+0)*nao+(l0+1)];
                fy += gout15y * dm[(j0+0)*nao+(l0+1)];
                fz += gout15z * dm[(j0+0)*nao+(l0+1)];
                fx += gout24x * dm[(j0+0)*nao+(l0+2)];
                fy += gout24y * dm[(j0+0)*nao+(l0+2)];
                fz += gout24z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+1)];
                fy += gout10y * dm[(j0+0)*nao+(l0+1)];
                fz += gout10z * dm[(j0+0)*nao+(l0+1)];
                fx += gout19x * dm[(j0+0)*nao+(l0+2)];
                fy += gout19y * dm[(j0+0)*nao+(l0+2)];
                fz += gout19z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout13x * dm[(j0+0)*nao+(l0+1)];
                fy += gout13y * dm[(j0+0)*nao+(l0+1)];
                fz += gout13z * dm[(j0+0)*nao+(l0+1)];
                fx += gout22x * dm[(j0+0)*nao+(l0+2)];
                fy += gout22y * dm[(j0+0)*nao+(l0+2)];
                fz += gout22z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+0)];
                fy = gout7y * dm[(j0+0)*nao+(l0+0)];
                fz = gout7z * dm[(j0+0)*nao+(l0+0)];
                fx += gout16x * dm[(j0+0)*nao+(l0+1)];
                fy += gout16y * dm[(j0+0)*nao+(l0+1)];
                fz += gout16z * dm[(j0+0)*nao+(l0+1)];
                fx += gout25x * dm[(j0+0)*nao+(l0+2)];
                fy += gout25y * dm[(j0+0)*nao+(l0+2)];
                fz += gout25z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+1)];
                fy += gout11y * dm[(j0+0)*nao+(l0+1)];
                fz += gout11z * dm[(j0+0)*nao+(l0+1)];
                fx += gout20x * dm[(j0+0)*nao+(l0+2)];
                fy += gout20y * dm[(j0+0)*nao+(l0+2)];
                fz += gout20z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                fx += gout14x * dm[(j0+0)*nao+(l0+1)];
                fy += gout14y * dm[(j0+0)*nao+(l0+1)];
                fz += gout14z * dm[(j0+0)*nao+(l0+1)];
                fx += gout23x * dm[(j0+0)*nao+(l0+2)];
                fy += gout23y * dm[(j0+0)*nao+(l0+2)];
                fz += gout23z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+0)];
                fy = gout8y * dm[(j0+0)*nao+(l0+0)];
                fz = gout8z * dm[(j0+0)*nao+(l0+0)];
                fx += gout17x * dm[(j0+0)*nao+(l0+1)];
                fy += gout17y * dm[(j0+0)*nao+(l0+1)];
                fz += gout17z * dm[(j0+0)*nao+(l0+1)];
                fx += gout26x * dm[(j0+0)*nao+(l0+2)];
                fy += gout26y * dm[(j0+0)*nao+(l0+2)];
                fz += gout26z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+1)];
                fy += gout9y * dm[(i0+0)*nao+(l0+1)];
                fz += gout9z * dm[(i0+0)*nao+(l0+1)];
                fx += gout18x * dm[(i0+0)*nao+(l0+2)];
                fy += gout18y * dm[(i0+0)*nao+(l0+2)];
                fz += gout18z * dm[(i0+0)*nao+(l0+2)];
                fx += gout1x * dm[(i0+1)*nao+(l0+0)];
                fy += gout1y * dm[(i0+1)*nao+(l0+0)];
                fz += gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout10x * dm[(i0+1)*nao+(l0+1)];
                fy += gout10y * dm[(i0+1)*nao+(l0+1)];
                fz += gout10z * dm[(i0+1)*nao+(l0+1)];
                fx += gout19x * dm[(i0+1)*nao+(l0+2)];
                fy += gout19y * dm[(i0+1)*nao+(l0+2)];
                fz += gout19z * dm[(i0+1)*nao+(l0+2)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                fx += gout11x * dm[(i0+2)*nao+(l0+1)];
                fy += gout11y * dm[(i0+2)*nao+(l0+1)];
                fz += gout11z * dm[(i0+2)*nao+(l0+1)];
                fx += gout20x * dm[(i0+2)*nao+(l0+2)];
                fy += gout20y * dm[(i0+2)*nao+(l0+2)];
                fz += gout20z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+1)];
                fy += gout12y * dm[(i0+0)*nao+(l0+1)];
                fz += gout12z * dm[(i0+0)*nao+(l0+1)];
                fx += gout21x * dm[(i0+0)*nao+(l0+2)];
                fy += gout21y * dm[(i0+0)*nao+(l0+2)];
                fz += gout21z * dm[(i0+0)*nao+(l0+2)];
                fx += gout4x * dm[(i0+1)*nao+(l0+0)];
                fy += gout4y * dm[(i0+1)*nao+(l0+0)];
                fz += gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout13x * dm[(i0+1)*nao+(l0+1)];
                fy += gout13y * dm[(i0+1)*nao+(l0+1)];
                fz += gout13z * dm[(i0+1)*nao+(l0+1)];
                fx += gout22x * dm[(i0+1)*nao+(l0+2)];
                fy += gout22y * dm[(i0+1)*nao+(l0+2)];
                fz += gout22z * dm[(i0+1)*nao+(l0+2)];
                fx += gout5x * dm[(i0+2)*nao+(l0+0)];
                fy += gout5y * dm[(i0+2)*nao+(l0+0)];
                fz += gout5z * dm[(i0+2)*nao+(l0+0)];
                fx += gout14x * dm[(i0+2)*nao+(l0+1)];
                fy += gout14y * dm[(i0+2)*nao+(l0+1)];
                fz += gout14z * dm[(i0+2)*nao+(l0+1)];
                fx += gout23x * dm[(i0+2)*nao+(l0+2)];
                fy += gout23y * dm[(i0+2)*nao+(l0+2)];
                fz += gout23z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout15x * dm[(i0+0)*nao+(l0+1)];
                fy += gout15y * dm[(i0+0)*nao+(l0+1)];
                fz += gout15z * dm[(i0+0)*nao+(l0+1)];
                fx += gout24x * dm[(i0+0)*nao+(l0+2)];
                fy += gout24y * dm[(i0+0)*nao+(l0+2)];
                fz += gout24z * dm[(i0+0)*nao+(l0+2)];
                fx += gout7x * dm[(i0+1)*nao+(l0+0)];
                fy += gout7y * dm[(i0+1)*nao+(l0+0)];
                fz += gout7z * dm[(i0+1)*nao+(l0+0)];
                fx += gout16x * dm[(i0+1)*nao+(l0+1)];
                fy += gout16y * dm[(i0+1)*nao+(l0+1)];
                fz += gout16z * dm[(i0+1)*nao+(l0+1)];
                fx += gout25x * dm[(i0+1)*nao+(l0+2)];
                fy += gout25y * dm[(i0+1)*nao+(l0+2)];
                fz += gout25z * dm[(i0+1)*nao+(l0+2)];
                fx += gout8x * dm[(i0+2)*nao+(l0+0)];
                fy += gout8y * dm[(i0+2)*nao+(l0+0)];
                fz += gout8z * dm[(i0+2)*nao+(l0+0)];
                fx += gout17x * dm[(i0+2)*nao+(l0+1)];
                fy += gout17y * dm[(i0+2)*nao+(l0+1)];
                fz += gout17z * dm[(i0+2)*nao+(l0+1)];
                fx += gout26x * dm[(i0+2)*nao+(l0+2)];
                fy += gout26y * dm[(i0+2)*nao+(l0+2)];
                fz += gout26z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_1011(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_1011(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_1020(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double b01 = .5/akl * (1 - rt_akl);
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_21x = cpx * trr_20x + 2*b00 * trr_10x;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double trr_22x = cpx * trr_21x + 1*b01 * trr_20x + 2*b00 * trr_11x;
                    fx = ai2 * trr_22x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_01x = cpx * 1;
                    double trr_02x = cpx * trr_01x + 1*b01 * 1;
                    fx -= 1 * trr_02x;
                    double trr_12x = cpx * trr_11x + 1*b01 * trr_10x + 1*b00 * trr_01x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += trr_12x *  fy  * wt;
                    gout0z += trr_12x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_12x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * 1;
                    gout1x +=  fx  * trr_10y * wt;
                    gout1y += trr_02x *  fy  * wt;
                    gout1z += trr_02x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_12x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout2x +=  fx  * 1 * trr_10z;
                    gout2y += trr_02x *  fy  * trr_10z;
                    gout2z += trr_02x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_21x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * trr_01x;
                    double trr_01y = cpy * 1;
                    gout3x +=  fx  * trr_01y * wt;
                    gout3y += trr_11x *  fy  * wt;
                    gout3z += trr_11x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double trr_21y = cpy * trr_20y + 2*b00 * trr_10y;
                    fy = ai2 * trr_21y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * trr_01y;
                    gout4x +=  fx  * trr_11y * wt;
                    gout4y += trr_01x *  fy  * wt;
                    gout4z += trr_01x * trr_11y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout5x +=  fx  * trr_01y * trr_10z;
                    gout5y += trr_01x *  fy  * trr_10z;
                    gout5z += trr_01x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_21x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    fx -= 1 * trr_01x;
                    double trr_01z = cpz * wt;
                    gout6x +=  fx  * 1 * trr_01z;
                    gout6y += trr_11x *  fy  * trr_01z;
                    gout6z += trr_11x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_11z;
                    fy -= 1 * 1;
                    gout7x +=  fx  * trr_10y * trr_01z;
                    gout7y += trr_01x *  fy  * trr_01z;
                    gout7z += trr_01x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double trr_21z = cpz * trr_20z + 2*b00 * trr_10z;
                    fz = ai2 * trr_21z;
                    fz -= 1 * trr_01z;
                    gout8x +=  fx  * 1 * trr_11z;
                    gout8y += trr_01x *  fy  * trr_11z;
                    gout8z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    double trr_12y = cpy * trr_11y + 1*b01 * trr_10y + 1*b00 * trr_01y;
                    fy = ai2 * trr_12y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * 1;
                    double trr_02y = cpy * trr_01y + 1*b01 * 1;
                    gout9x +=  fx  * trr_02y * wt;
                    gout9y += trr_10x *  fy  * wt;
                    gout9z += trr_10x * trr_02y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_22y = cpy * trr_21y + 1*b01 * trr_20y + 2*b00 * trr_11y;
                    fy = ai2 * trr_22y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * trr_02y;
                    gout10x +=  fx  * trr_12y * wt;
                    gout10y += 1 *  fy  * wt;
                    gout10z += 1 * trr_12y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_12y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout11x +=  fx  * trr_02y * trr_10z;
                    gout11y += 1 *  fy  * trr_10z;
                    gout11z += 1 * trr_02y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_11z;
                    fx -= 1 * 1;
                    gout12x +=  fx  * trr_01y * trr_01z;
                    gout12y += trr_10x *  fy  * trr_01z;
                    gout12z += trr_10x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_21y;
                    fz = ai2 * trr_11z;
                    fy -= 1 * trr_01y;
                    gout13x +=  fx  * trr_11y * trr_01z;
                    gout13y += 1 *  fy  * trr_01z;
                    gout13z += 1 * trr_11y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_21z;
                    fz -= 1 * trr_01z;
                    gout14x +=  fx  * trr_01y * trr_11z;
                    gout14y += 1 *  fy  * trr_11z;
                    gout14z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_10y;
                    double trr_12z = cpz * trr_11z + 1*b01 * trr_10z + 1*b00 * trr_01z;
                    fz = ai2 * trr_12z;
                    fx -= 1 * 1;
                    double trr_02z = cpz * trr_01z + 1*b01 * wt;
                    gout15x +=  fx  * 1 * trr_02z;
                    gout15y += trr_10x *  fy  * trr_02z;
                    gout15z += trr_10x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_12z;
                    fy -= 1 * 1;
                    gout16x +=  fx  * trr_10y * trr_02z;
                    gout16y += 1 *  fy  * trr_02z;
                    gout16z += 1 * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_22z = cpz * trr_21z + 1*b01 * trr_20z + 2*b00 * trr_11z;
                    fz = ai2 * trr_22z;
                    fz -= 1 * trr_02z;
                    gout17x +=  fx  * 1 * trr_12z;
                    gout17y += 1 *  fy  * trr_12z;
                    gout17z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+1)];
                fy += gout3y * dm[(l0+0)*nao+(k0+1)];
                fz += gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout6x * dm[(l0+0)*nao+(k0+2)];
                fy += gout6y * dm[(l0+0)*nao+(k0+2)];
                fz += gout6z * dm[(l0+0)*nao+(k0+2)];
                fx += gout9x * dm[(l0+0)*nao+(k0+3)];
                fy += gout9y * dm[(l0+0)*nao+(k0+3)];
                fz += gout9z * dm[(l0+0)*nao+(k0+3)];
                fx += gout12x * dm[(l0+0)*nao+(k0+4)];
                fy += gout12y * dm[(l0+0)*nao+(k0+4)];
                fz += gout12z * dm[(l0+0)*nao+(k0+4)];
                fx += gout15x * dm[(l0+0)*nao+(k0+5)];
                fy += gout15y * dm[(l0+0)*nao+(k0+5)];
                fz += gout15z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+1)];
                fy += gout4y * dm[(l0+0)*nao+(k0+1)];
                fz += gout4z * dm[(l0+0)*nao+(k0+1)];
                fx += gout7x * dm[(l0+0)*nao+(k0+2)];
                fy += gout7y * dm[(l0+0)*nao+(k0+2)];
                fz += gout7z * dm[(l0+0)*nao+(k0+2)];
                fx += gout10x * dm[(l0+0)*nao+(k0+3)];
                fy += gout10y * dm[(l0+0)*nao+(k0+3)];
                fz += gout10z * dm[(l0+0)*nao+(k0+3)];
                fx += gout13x * dm[(l0+0)*nao+(k0+4)];
                fy += gout13y * dm[(l0+0)*nao+(k0+4)];
                fz += gout13z * dm[(l0+0)*nao+(k0+4)];
                fx += gout16x * dm[(l0+0)*nao+(k0+5)];
                fy += gout16y * dm[(l0+0)*nao+(k0+5)];
                fz += gout16z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout5x * dm[(l0+0)*nao+(k0+1)];
                fy += gout5y * dm[(l0+0)*nao+(k0+1)];
                fz += gout5z * dm[(l0+0)*nao+(k0+1)];
                fx += gout8x * dm[(l0+0)*nao+(k0+2)];
                fy += gout8y * dm[(l0+0)*nao+(k0+2)];
                fz += gout8z * dm[(l0+0)*nao+(k0+2)];
                fx += gout11x * dm[(l0+0)*nao+(k0+3)];
                fy += gout11y * dm[(l0+0)*nao+(k0+3)];
                fz += gout11z * dm[(l0+0)*nao+(k0+3)];
                fx += gout14x * dm[(l0+0)*nao+(k0+4)];
                fy += gout14y * dm[(l0+0)*nao+(k0+4)];
                fz += gout14z * dm[(l0+0)*nao+(k0+4)];
                fx += gout17x * dm[(l0+0)*nao+(k0+5)];
                fy += gout17y * dm[(l0+0)*nao+(k0+5)];
                fz += gout17z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+1)];
                fy += gout1y * dm[(j0+0)*nao+(i0+1)];
                fz += gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+2)];
                fy += gout2y * dm[(j0+0)*nao+(i0+2)];
                fz += gout2z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                fx += gout4x * dm[(j0+0)*nao+(i0+1)];
                fy += gout4y * dm[(j0+0)*nao+(i0+1)];
                fz += gout4z * dm[(j0+0)*nao+(i0+1)];
                fx += gout5x * dm[(j0+0)*nao+(i0+2)];
                fy += gout5y * dm[(j0+0)*nao+(i0+2)];
                fz += gout5z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+0)*nao+(i0+1)];
                fy += gout7y * dm[(j0+0)*nao+(i0+1)];
                fz += gout7z * dm[(j0+0)*nao+(i0+1)];
                fx += gout8x * dm[(j0+0)*nao+(i0+2)];
                fy += gout8y * dm[(j0+0)*nao+(i0+2)];
                fz += gout8z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                fx += gout10x * dm[(j0+0)*nao+(i0+1)];
                fy += gout10y * dm[(j0+0)*nao+(i0+1)];
                fz += gout10z * dm[(j0+0)*nao+(i0+1)];
                fx += gout11x * dm[(j0+0)*nao+(i0+2)];
                fy += gout11y * dm[(j0+0)*nao+(i0+2)];
                fz += gout11z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                fx += gout13x * dm[(j0+0)*nao+(i0+1)];
                fy += gout13y * dm[(j0+0)*nao+(i0+1)];
                fz += gout13z * dm[(j0+0)*nao+(i0+1)];
                fx += gout14x * dm[(j0+0)*nao+(i0+2)];
                fy += gout14y * dm[(j0+0)*nao+(i0+2)];
                fz += gout14z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout15x * dm[(j0+0)*nao+(i0+0)];
                fy = gout15y * dm[(j0+0)*nao+(i0+0)];
                fz = gout15z * dm[(j0+0)*nao+(i0+0)];
                fx += gout16x * dm[(j0+0)*nao+(i0+1)];
                fy += gout16y * dm[(j0+0)*nao+(i0+1)];
                fz += gout16z * dm[(j0+0)*nao+(i0+1)];
                fx += gout17x * dm[(j0+0)*nao+(i0+2)];
                fy += gout17y * dm[(j0+0)*nao+(i0+2)];
                fz += gout17z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+1)];
                fy += gout3y * dm[(j0+0)*nao+(k0+1)];
                fz += gout3z * dm[(j0+0)*nao+(k0+1)];
                fx += gout6x * dm[(j0+0)*nao+(k0+2)];
                fy += gout6y * dm[(j0+0)*nao+(k0+2)];
                fz += gout6z * dm[(j0+0)*nao+(k0+2)];
                fx += gout9x * dm[(j0+0)*nao+(k0+3)];
                fy += gout9y * dm[(j0+0)*nao+(k0+3)];
                fz += gout9z * dm[(j0+0)*nao+(k0+3)];
                fx += gout12x * dm[(j0+0)*nao+(k0+4)];
                fy += gout12y * dm[(j0+0)*nao+(k0+4)];
                fz += gout12z * dm[(j0+0)*nao+(k0+4)];
                fx += gout15x * dm[(j0+0)*nao+(k0+5)];
                fy += gout15y * dm[(j0+0)*nao+(k0+5)];
                fz += gout15z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+0)*nao+(k0+1)];
                fy += gout4y * dm[(j0+0)*nao+(k0+1)];
                fz += gout4z * dm[(j0+0)*nao+(k0+1)];
                fx += gout7x * dm[(j0+0)*nao+(k0+2)];
                fy += gout7y * dm[(j0+0)*nao+(k0+2)];
                fz += gout7z * dm[(j0+0)*nao+(k0+2)];
                fx += gout10x * dm[(j0+0)*nao+(k0+3)];
                fy += gout10y * dm[(j0+0)*nao+(k0+3)];
                fz += gout10z * dm[(j0+0)*nao+(k0+3)];
                fx += gout13x * dm[(j0+0)*nao+(k0+4)];
                fy += gout13y * dm[(j0+0)*nao+(k0+4)];
                fz += gout13z * dm[(j0+0)*nao+(k0+4)];
                fx += gout16x * dm[(j0+0)*nao+(k0+5)];
                fy += gout16y * dm[(j0+0)*nao+(k0+5)];
                fz += gout16z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+0)];
                fy = gout2y * dm[(j0+0)*nao+(k0+0)];
                fz = gout2z * dm[(j0+0)*nao+(k0+0)];
                fx += gout5x * dm[(j0+0)*nao+(k0+1)];
                fy += gout5y * dm[(j0+0)*nao+(k0+1)];
                fz += gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout8x * dm[(j0+0)*nao+(k0+2)];
                fy += gout8y * dm[(j0+0)*nao+(k0+2)];
                fz += gout8z * dm[(j0+0)*nao+(k0+2)];
                fx += gout11x * dm[(j0+0)*nao+(k0+3)];
                fy += gout11y * dm[(j0+0)*nao+(k0+3)];
                fz += gout11z * dm[(j0+0)*nao+(k0+3)];
                fx += gout14x * dm[(j0+0)*nao+(k0+4)];
                fy += gout14y * dm[(j0+0)*nao+(k0+4)];
                fz += gout14z * dm[(j0+0)*nao+(k0+4)];
                fx += gout17x * dm[(j0+0)*nao+(k0+5)];
                fy += gout17y * dm[(j0+0)*nao+(k0+5)];
                fz += gout17z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+1)];
                fy += gout3y * dm[(i0+0)*nao+(k0+1)];
                fz += gout3z * dm[(i0+0)*nao+(k0+1)];
                fx += gout6x * dm[(i0+0)*nao+(k0+2)];
                fy += gout6y * dm[(i0+0)*nao+(k0+2)];
                fz += gout6z * dm[(i0+0)*nao+(k0+2)];
                fx += gout9x * dm[(i0+0)*nao+(k0+3)];
                fy += gout9y * dm[(i0+0)*nao+(k0+3)];
                fz += gout9z * dm[(i0+0)*nao+(k0+3)];
                fx += gout12x * dm[(i0+0)*nao+(k0+4)];
                fy += gout12y * dm[(i0+0)*nao+(k0+4)];
                fz += gout12z * dm[(i0+0)*nao+(k0+4)];
                fx += gout15x * dm[(i0+0)*nao+(k0+5)];
                fy += gout15y * dm[(i0+0)*nao+(k0+5)];
                fz += gout15z * dm[(i0+0)*nao+(k0+5)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout4x * dm[(i0+1)*nao+(k0+1)];
                fy += gout4y * dm[(i0+1)*nao+(k0+1)];
                fz += gout4z * dm[(i0+1)*nao+(k0+1)];
                fx += gout7x * dm[(i0+1)*nao+(k0+2)];
                fy += gout7y * dm[(i0+1)*nao+(k0+2)];
                fz += gout7z * dm[(i0+1)*nao+(k0+2)];
                fx += gout10x * dm[(i0+1)*nao+(k0+3)];
                fy += gout10y * dm[(i0+1)*nao+(k0+3)];
                fz += gout10z * dm[(i0+1)*nao+(k0+3)];
                fx += gout13x * dm[(i0+1)*nao+(k0+4)];
                fy += gout13y * dm[(i0+1)*nao+(k0+4)];
                fz += gout13z * dm[(i0+1)*nao+(k0+4)];
                fx += gout16x * dm[(i0+1)*nao+(k0+5)];
                fy += gout16y * dm[(i0+1)*nao+(k0+5)];
                fz += gout16z * dm[(i0+1)*nao+(k0+5)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                fx += gout5x * dm[(i0+2)*nao+(k0+1)];
                fy += gout5y * dm[(i0+2)*nao+(k0+1)];
                fz += gout5z * dm[(i0+2)*nao+(k0+1)];
                fx += gout8x * dm[(i0+2)*nao+(k0+2)];
                fy += gout8y * dm[(i0+2)*nao+(k0+2)];
                fz += gout8z * dm[(i0+2)*nao+(k0+2)];
                fx += gout11x * dm[(i0+2)*nao+(k0+3)];
                fy += gout11y * dm[(i0+2)*nao+(k0+3)];
                fz += gout11z * dm[(i0+2)*nao+(k0+3)];
                fx += gout14x * dm[(i0+2)*nao+(k0+4)];
                fy += gout14y * dm[(i0+2)*nao+(k0+4)];
                fz += gout14z * dm[(i0+2)*nao+(k0+4)];
                fx += gout17x * dm[(i0+2)*nao+(k0+5)];
                fy += gout17y * dm[(i0+2)*nao+(k0+5)];
                fz += gout17z * dm[(i0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout12x * dm[(j0+0)*nao+(l0+0)];
                fy = gout12y * dm[(j0+0)*nao+(l0+0)];
                fz = gout12z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout15x * dm[(j0+0)*nao+(l0+0)];
                fy = gout15y * dm[(j0+0)*nao+(l0+0)];
                fz = gout15z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+0)];
                fy = gout7y * dm[(j0+0)*nao+(l0+0)];
                fz = gout7z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout10x * dm[(j0+0)*nao+(l0+0)];
                fy = gout10y * dm[(j0+0)*nao+(l0+0)];
                fz = gout10z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+3), fz);
                fx = gout13x * dm[(j0+0)*nao+(l0+0)];
                fy = gout13y * dm[(j0+0)*nao+(l0+0)];
                fz = gout13z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+4), fz);
                fx = gout16x * dm[(j0+0)*nao+(l0+0)];
                fy = gout16y * dm[(j0+0)*nao+(l0+0)];
                fz = gout16z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+5), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+0)];
                fy = gout8y * dm[(j0+0)*nao+(l0+0)];
                fz = gout8z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout11x * dm[(j0+0)*nao+(l0+0)];
                fy = gout11y * dm[(j0+0)*nao+(l0+0)];
                fz = gout11z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+3), fz);
                fx = gout14x * dm[(j0+0)*nao+(l0+0)];
                fy = gout14y * dm[(j0+0)*nao+(l0+0)];
                fz = gout14z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+4), fz);
                fx = gout17x * dm[(j0+0)*nao+(l0+0)];
                fy = gout17y * dm[(j0+0)*nao+(l0+0)];
                fz = gout17z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+1)*nao+(l0+0)];
                fy += gout1y * dm[(i0+1)*nao+(l0+0)];
                fz += gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout4x * dm[(i0+1)*nao+(l0+0)];
                fy += gout4y * dm[(i0+1)*nao+(l0+0)];
                fz += gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout5x * dm[(i0+2)*nao+(l0+0)];
                fy += gout5y * dm[(i0+2)*nao+(l0+0)];
                fz += gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+1)*nao+(l0+0)];
                fy += gout7y * dm[(i0+1)*nao+(l0+0)];
                fz += gout7z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+2)*nao+(l0+0)];
                fy += gout8y * dm[(i0+2)*nao+(l0+0)];
                fz += gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+0)];
                fy = gout9y * dm[(i0+0)*nao+(l0+0)];
                fz = gout9z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+1)*nao+(l0+0)];
                fy += gout10y * dm[(i0+1)*nao+(l0+0)];
                fz += gout10z * dm[(i0+1)*nao+(l0+0)];
                fx += gout11x * dm[(i0+2)*nao+(l0+0)];
                fy += gout11y * dm[(i0+2)*nao+(l0+0)];
                fz += gout11z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+1)*nao+(l0+0)];
                fy += gout13y * dm[(i0+1)*nao+(l0+0)];
                fz += gout13z * dm[(i0+1)*nao+(l0+0)];
                fx += gout14x * dm[(i0+2)*nao+(l0+0)];
                fy += gout14y * dm[(i0+2)*nao+(l0+0)];
                fz += gout14z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout15x * dm[(i0+0)*nao+(l0+0)];
                fy = gout15y * dm[(i0+0)*nao+(l0+0)];
                fz = gout15z * dm[(i0+0)*nao+(l0+0)];
                fx += gout16x * dm[(i0+1)*nao+(l0+0)];
                fy += gout16y * dm[(i0+1)*nao+(l0+0)];
                fz += gout16z * dm[(i0+1)*nao+(l0+0)];
                fx += gout17x * dm[(i0+2)*nao+(l0+0)];
                fy += gout17y * dm[(i0+2)*nao+(l0+0)];
                fz += gout17z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_1020(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_1020(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_1021(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;
    double *gx = rw + 128 * nroots;
    double *gy = gx + 1152;
    double *gz = gy + 1152;
    double *rlrk = gz + 1152;
    double *Rpq = rlrk + 192;
    if (gout_id == 0) {
        gx[0] = 1.;
        gy[0] = 1.;
    }
    double s0, s1, s2;
    double Ix, Iy, Iz;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        if (gout_id == 0) {
            rlrk[0] = xlxk;
            rlrk[64] = ylyk;
            rlrk[128] = zlzk;
        }
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            __syncthreads();
            double xlxk = rlrk[0];
            double ylyk = rlrk[64];
            double zlzk = rlrk[128];
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xkl = rk[0] + rlrk[0] * al_akl;
                double ykl = rk[1] + rlrk[64] * al_akl;
                double zkl = rk[2] + rlrk[128] * al_akl;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                __syncthreads();
                if (gout_id == 0) {
                    Rpq[0] = xpq;
                    Rpq[64] = ypq;
                    Rpq[128] = zpq;
                }
                rys_roots_rs(nroots, theta, rr, omega, rw, 64, gout_id, 4);
                for (int irys = 0; irys < nroots; ++irys) {
                    __syncthreads();
                    double rt = rw[irys*128];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double rt_akl = rt_aa * aij;
                    double b00 = .5 * rt_aa;
                    double b01 = .5/akl * (1 - rt_akl);
                    for (int n = gout_id; n < 3; n += 4) {
                        if (n == 2) {
                            gz[0] = rw[irys*128+64] * fac;
                        }
                        double *_gx = gx + n * 1152;
                        double xjxi = rjri[n];
                        double Rpa = xjxi * aj_aij;
                        double c0x = Rpa - rt_aij * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = c0x * s0;
                        _gx[64] = s1;
                        s2 = c0x * s1 + 1 * b10 * s0;
                        _gx[128] = s2;
                        double xlxk = rlrk[n*64];
                        double Rqc = xlxk * al_akl;
                        double cpx = Rqc + rt_akl * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = cpx * s0;
                        _gx[192] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        _gx[384] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = cpx*s1 + 2 * b01 *s0;
                        _gx[576] = s2;
                        s0 = _gx[64];
                        s1 = cpx * s0;
                        s1 += 1 * b00 * _gx[0];
                        _gx[256] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 1 * b00 * _gx[192];
                        _gx[448] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = cpx*s1 + 2 * b01 *s0;
                        s2 += 1 * b00 * _gx[384];
                        _gx[640] = s2;
                        s0 = _gx[128];
                        s1 = cpx * s0;
                        s1 += 2 * b00 * _gx[64];
                        _gx[320] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 2 * b00 * _gx[256];
                        _gx[512] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = cpx*s1 + 2 * b01 *s0;
                        s2 += 2 * b00 * _gx[448];
                        _gx[704] = s2;
                        s1 = _gx[576];
                        s0 = _gx[384];
                        _gx[960] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[192];
                        _gx[768] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[576] = s1 - xlxk * s0;
                        s1 = _gx[640];
                        s0 = _gx[448];
                        _gx[1024] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[256];
                        _gx[832] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[640] = s1 - xlxk * s0;
                        s1 = _gx[704];
                        s0 = _gx[512];
                        _gx[1088] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[320];
                        _gx[896] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[128];
                        _gx[704] = s1 - xlxk * s0;
                    }
                    __syncthreads();
                    switch (gout_id) {
                    case 0:
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[0];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[1088] - 1 * gx[960]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[256];
                    Iz = gz[0];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[0];
                    Iz = gz[256];
                    gout2x += ai2 * gx[832] * Iy * Iz;
                    gout2y += ai2 * gy[64] * Ix * Iz;
                    gout2z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[192];
                    Iz = gz[192];
                    gout3x += (ai2 * gx[704] - 1 * gx[576]) * Iy * Iz;
                    gout3y += ai2 * gy[256] * Ix * Iz;
                    gout3z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[64];
                    Iz = gz[384];
                    gout4x += ai2 * gx[640] * Iy * Iz;
                    gout4y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout4z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[576];
                    Iz = gz[64];
                    gout5x += ai2 * gx[448] * Iy * Iz;
                    gout5y += ai2 * gy[640] * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[576];
                    Iz = gz[192];
                    gout6x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout6y += ai2 * gy[640] * Ix * Iz;
                    gout6z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1024];
                    Iz = gz[0];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += (ai2 * gy[1088] - 1 * gy[960]) * Ix * Iz;
                    gout7z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[768];
                    Iz = gz[256];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[832] * Ix * Iz;
                    gout8z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[0];
                    Iz = gz[576];
                    gout9x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[256];
                    Iz = gz[576];
                    gout10x += ai2 * gx[256] * Iy * Iz;
                    gout10y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout10z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[0];
                    Iz = gz[832];
                    gout11x += ai2 * gx[256] * Iy * Iz;
                    gout11y += ai2 * gy[64] * Ix * Iz;
                    gout11z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[192];
                    Iz = gz[768];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += ai2 * gy[256] * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[64];
                    Iz = gz[960];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout13z += ai2 * gz[1024] * Ix * Iy;
                    break;
                    case 1:
                    ai2 = rjri[5];
                    Ix = gx[960];
                    Iy = gy[64];
                    Iz = gz[0];
                    gout0x += ai2 * gx[1024] * Iy * Iz;
                    gout0y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[192];
                    Iz = gz[64];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += ai2 * gy[256] * Ix * Iz;
                    gout1z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[384];
                    Iz = gz[0];
                    gout2x += (ai2 * gx[704] - 1 * gx[576]) * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[256];
                    Iz = gz[192];
                    gout3x += ai2 * gx[640] * Iy * Iz;
                    gout3y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout3z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[0];
                    Iz = gz[448];
                    gout4x += ai2 * gx[640] * Iy * Iz;
                    gout4y += ai2 * gy[64] * Ix * Iz;
                    gout4z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[768];
                    Iz = gz[0];
                    gout5x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout5y += ai2 * gy[832] * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[640];
                    Iz = gz[192];
                    gout6x += ai2 * gx[256] * Iy * Iz;
                    gout6y += (ai2 * gy[704] - 1 * gy[576]) * Ix * Iz;
                    gout6z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[960];
                    Iz = gz[64];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[1024] * Ix * Iz;
                    gout7z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[576];
                    Iz = gz[384];
                    gout8x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout8y += ai2 * gy[640] * Ix * Iz;
                    gout8z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[64];
                    Iz = gz[576];
                    gout9x += ai2 * gx[448] * Iy * Iz;
                    gout9y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout9z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[192];
                    Iz = gz[640];
                    gout10x += ai2 * gx[256] * Iy * Iz;
                    gout10y += ai2 * gy[256] * Ix * Iz;
                    gout10z += (ai2 * gz[704] - 1 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[384];
                    Iz = gz[576];
                    gout11x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout11y += ai2 * gy[448] * Ix * Iz;
                    gout11z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[256];
                    Iz = gz[768];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[0];
                    Iz = gz[1024];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += ai2 * gy[64] * Ix * Iz;
                    gout13z += (ai2 * gz[1088] - 1 * gz[960]) * Ix * Iy;
                    break;
                    case 2:
                    ai2 = rjri[5];
                    Ix = gx[960];
                    Iy = gy[0];
                    Iz = gz[64];
                    gout0x += ai2 * gx[1024] * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[0];
                    Iz = gz[192];
                    gout1x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout1y += ai2 * gy[64] * Ix * Iz;
                    gout1z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[448];
                    Iz = gz[0];
                    gout2x += ai2 * gx[640] * Iy * Iz;
                    gout2y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[192];
                    Iz = gz[256];
                    gout3x += ai2 * gx[640] * Iy * Iz;
                    gout3y += ai2 * gy[256] * Ix * Iz;
                    gout3z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[576];
                    Iz = gz[0];
                    gout4x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout4y += ai2 * gy[640] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[832];
                    Iz = gz[0];
                    gout5x += ai2 * gx[256] * Iy * Iz;
                    gout5y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[576];
                    Iz = gz[256];
                    gout6x += ai2 * gx[256] * Iy * Iz;
                    gout6y += ai2 * gy[640] * Ix * Iz;
                    gout6z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[768];
                    Iz = gz[192];
                    gout7x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout7y += ai2 * gy[832] * Ix * Iz;
                    gout7z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[640];
                    Iz = gz[384];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += (ai2 * gy[704] - 1 * gy[576]) * Ix * Iz;
                    gout8z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[0];
                    Iz = gz[640];
                    gout9x += ai2 * gx[448] * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += (ai2 * gz[704] - 1 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[0];
                    Iz = gz[768];
                    gout10x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout10y += ai2 * gy[64] * Ix * Iz;
                    gout10z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[448];
                    Iz = gz[576];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout11z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[192];
                    Iz = gz[832];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += ai2 * gy[256] * Ix * Iz;
                    gout12z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    break;
                    case 3:
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[192];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout0y += ai2 * gy[256] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[64];
                    Iz = gz[192];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout1z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[384];
                    Iz = gz[64];
                    gout2x += ai2 * gx[640] * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[0];
                    Iz = gz[384];
                    gout3x += (ai2 * gx[704] - 1 * gx[576]) * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[640];
                    Iz = gz[0];
                    gout4x += ai2 * gx[448] * Iy * Iz;
                    gout4y += (ai2 * gy[704] - 1 * gy[576]) * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[768];
                    Iz = gz[64];
                    gout5x += ai2 * gx[256] * Iy * Iz;
                    gout5y += ai2 * gy[832] * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[960];
                    Iz = gz[0];
                    gout6x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout6y += ai2 * gy[1024] * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[832];
                    Iz = gz[192];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout7z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[576];
                    Iz = gz[448];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[640] * Ix * Iz;
                    gout8z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[192];
                    Iz = gz[576];
                    gout9x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout9y += ai2 * gy[256] * Ix * Iz;
                    gout9z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[64];
                    Iz = gz[768];
                    gout10x += ai2 * gx[256] * Iy * Iz;
                    gout10y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout10z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[384];
                    Iz = gz[640];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += ai2 * gy[448] * Ix * Iz;
                    gout11z += (ai2 * gz[704] - 1 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[0];
                    Iz = gz[960];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += ai2 * gy[64] * Ix * Iz;
                    gout12z += ai2 * gz[1024] * Ix * Iy;
                    break;
                    }
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+4)];
                fy += gout3y * dm[(l0+0)*nao+(k0+4)];
                fz += gout3z * dm[(l0+0)*nao+(k0+4)];
                fx += gout6x * dm[(l0+1)*nao+(k0+2)];
                fy += gout6y * dm[(l0+1)*nao+(k0+2)];
                fz += gout6z * dm[(l0+1)*nao+(k0+2)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+4)];
                fy += gout12y * dm[(l0+2)*nao+(k0+4)];
                fz += gout12z * dm[(l0+2)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+0)*nao+(k0+5)];
                fy += gout4y * dm[(l0+0)*nao+(k0+5)];
                fz += gout4z * dm[(l0+0)*nao+(k0+5)];
                fx += gout7x * dm[(l0+1)*nao+(k0+3)];
                fy += gout7y * dm[(l0+1)*nao+(k0+3)];
                fz += gout7z * dm[(l0+1)*nao+(k0+3)];
                fx += gout10x * dm[(l0+2)*nao+(k0+1)];
                fy += gout10y * dm[(l0+2)*nao+(k0+1)];
                fz += gout10z * dm[(l0+2)*nao+(k0+1)];
                fx += gout13x * dm[(l0+2)*nao+(k0+5)];
                fy += gout13y * dm[(l0+2)*nao+(k0+5)];
                fz += gout13z * dm[(l0+2)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+2)];
                fy = gout2y * dm[(l0+0)*nao+(k0+2)];
                fz = gout2z * dm[(l0+0)*nao+(k0+2)];
                fx += gout5x * dm[(l0+1)*nao+(k0+0)];
                fy += gout5y * dm[(l0+1)*nao+(k0+0)];
                fz += gout5z * dm[(l0+1)*nao+(k0+0)];
                fx += gout8x * dm[(l0+1)*nao+(k0+4)];
                fy += gout8y * dm[(l0+1)*nao+(k0+4)];
                fz += gout8z * dm[(l0+1)*nao+(k0+4)];
                fx += gout11x * dm[(l0+2)*nao+(k0+2)];
                fy += gout11y * dm[(l0+2)*nao+(k0+2)];
                fz += gout11z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+1)];
                fy = gout1y * dm[(j0+0)*nao+(i0+1)];
                fz = gout1z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+2)];
                fy = gout2y * dm[(j0+0)*nao+(i0+2)];
                fz = gout2z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+1)];
                fy = gout4y * dm[(j0+0)*nao+(i0+1)];
                fz = gout4z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+2)];
                fy = gout5y * dm[(j0+0)*nao+(i0+2)];
                fz = gout5z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+1)];
                fy = gout7y * dm[(j0+0)*nao+(i0+1)];
                fz = gout7z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+2)];
                fy = gout8y * dm[(j0+0)*nao+(i0+2)];
                fz = gout8z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+0)*nao+(i0+1)];
                fy = gout10y * dm[(j0+0)*nao+(i0+1)];
                fz = gout10z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+2)];
                fy = gout11y * dm[(j0+0)*nao+(i0+2)];
                fz = gout11z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+2), fz);
                fx = gout13x * dm[(j0+0)*nao+(i0+1)];
                fy = gout13y * dm[(j0+0)*nao+(i0+1)];
                fz = gout13z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+2), fz);
                break;
                case 1:
                fx = gout2x * dm[(l0+0)*nao+(k0+3)];
                fy = gout2y * dm[(l0+0)*nao+(k0+3)];
                fz = gout2z * dm[(l0+0)*nao+(k0+3)];
                fx += gout5x * dm[(l0+1)*nao+(k0+1)];
                fy += gout5y * dm[(l0+1)*nao+(k0+1)];
                fz += gout5z * dm[(l0+1)*nao+(k0+1)];
                fx += gout8x * dm[(l0+1)*nao+(k0+5)];
                fy += gout8y * dm[(l0+1)*nao+(k0+5)];
                fz += gout8z * dm[(l0+1)*nao+(k0+5)];
                fx += gout11x * dm[(l0+2)*nao+(k0+3)];
                fy += gout11y * dm[(l0+2)*nao+(k0+3)];
                fz += gout11z * dm[(l0+2)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+4)];
                fy += gout3y * dm[(l0+0)*nao+(k0+4)];
                fz += gout3z * dm[(l0+0)*nao+(k0+4)];
                fx += gout6x * dm[(l0+1)*nao+(k0+2)];
                fy += gout6y * dm[(l0+1)*nao+(k0+2)];
                fz += gout6z * dm[(l0+1)*nao+(k0+2)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+4)];
                fy += gout12y * dm[(l0+2)*nao+(k0+4)];
                fz += gout12z * dm[(l0+2)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+0)*nao+(k0+5)];
                fy += gout4y * dm[(l0+0)*nao+(k0+5)];
                fz += gout4z * dm[(l0+0)*nao+(k0+5)];
                fx += gout7x * dm[(l0+1)*nao+(k0+3)];
                fy += gout7y * dm[(l0+1)*nao+(k0+3)];
                fz += gout7z * dm[(l0+1)*nao+(k0+3)];
                fx += gout10x * dm[(l0+2)*nao+(k0+1)];
                fy += gout10y * dm[(l0+2)*nao+(k0+1)];
                fz += gout10z * dm[(l0+2)*nao+(k0+1)];
                fx += gout13x * dm[(l0+2)*nao+(k0+5)];
                fy += gout13y * dm[(l0+2)*nao+(k0+5)];
                fz += gout13z * dm[(l0+2)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+1)];
                fy = gout0y * dm[(j0+0)*nao+(i0+1)];
                fz = gout0z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+2)];
                fy = gout1y * dm[(j0+0)*nao+(i0+2)];
                fz = gout1z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+0)];
                fy = gout2y * dm[(j0+0)*nao+(i0+0)];
                fz = gout2z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+1)];
                fy = gout3y * dm[(j0+0)*nao+(i0+1)];
                fz = gout3z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+2)];
                fy = gout4y * dm[(j0+0)*nao+(i0+2)];
                fz = gout4z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+0)];
                fy = gout5y * dm[(j0+0)*nao+(i0+0)];
                fz = gout5z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+1)];
                fy = gout6y * dm[(j0+0)*nao+(i0+1)];
                fz = gout6z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+2)];
                fy = gout7y * dm[(j0+0)*nao+(i0+2)];
                fz = gout7z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+0)];
                fy = gout8y * dm[(j0+0)*nao+(i0+0)];
                fz = gout8z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+1)];
                fy = gout9y * dm[(j0+0)*nao+(i0+1)];
                fz = gout9z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+0)*nao+(i0+2)];
                fy = gout10y * dm[(j0+0)*nao+(i0+2)];
                fz = gout10z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+0)];
                fy = gout11y * dm[(j0+0)*nao+(i0+0)];
                fz = gout11z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+1)];
                fy = gout12y * dm[(j0+0)*nao+(i0+1)];
                fz = gout12z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+2), fz);
                fx = gout13x * dm[(j0+0)*nao+(i0+2)];
                fy = gout13y * dm[(j0+0)*nao+(i0+2)];
                fz = gout13z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+2), fz);
                break;
                case 2:
                fx = gout1x * dm[(l0+0)*nao+(k0+2)];
                fy = gout1y * dm[(l0+0)*nao+(k0+2)];
                fz = gout1z * dm[(l0+0)*nao+(k0+2)];
                fx += gout4x * dm[(l0+1)*nao+(k0+0)];
                fy += gout4y * dm[(l0+1)*nao+(k0+0)];
                fz += gout4z * dm[(l0+1)*nao+(k0+0)];
                fx += gout7x * dm[(l0+1)*nao+(k0+4)];
                fy += gout7y * dm[(l0+1)*nao+(k0+4)];
                fz += gout7z * dm[(l0+1)*nao+(k0+4)];
                fx += gout10x * dm[(l0+2)*nao+(k0+2)];
                fy += gout10y * dm[(l0+2)*nao+(k0+2)];
                fz += gout10z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+3)];
                fy = gout2y * dm[(l0+0)*nao+(k0+3)];
                fz = gout2z * dm[(l0+0)*nao+(k0+3)];
                fx += gout5x * dm[(l0+1)*nao+(k0+1)];
                fy += gout5y * dm[(l0+1)*nao+(k0+1)];
                fz += gout5z * dm[(l0+1)*nao+(k0+1)];
                fx += gout8x * dm[(l0+1)*nao+(k0+5)];
                fy += gout8y * dm[(l0+1)*nao+(k0+5)];
                fz += gout8z * dm[(l0+1)*nao+(k0+5)];
                fx += gout11x * dm[(l0+2)*nao+(k0+3)];
                fy += gout11y * dm[(l0+2)*nao+(k0+3)];
                fz += gout11z * dm[(l0+2)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+4)];
                fy += gout3y * dm[(l0+0)*nao+(k0+4)];
                fz += gout3z * dm[(l0+0)*nao+(k0+4)];
                fx += gout6x * dm[(l0+1)*nao+(k0+2)];
                fy += gout6y * dm[(l0+1)*nao+(k0+2)];
                fz += gout6z * dm[(l0+1)*nao+(k0+2)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+4)];
                fy += gout12y * dm[(l0+2)*nao+(k0+4)];
                fz += gout12z * dm[(l0+2)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+2)];
                fy = gout0y * dm[(j0+0)*nao+(i0+2)];
                fz = gout0z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+1)];
                fy = gout2y * dm[(j0+0)*nao+(i0+1)];
                fz = gout2z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+2)];
                fy = gout3y * dm[(j0+0)*nao+(i0+2)];
                fz = gout3z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+1)];
                fy = gout5y * dm[(j0+0)*nao+(i0+1)];
                fz = gout5z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+2)];
                fy = gout6y * dm[(j0+0)*nao+(i0+2)];
                fz = gout6z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+0)];
                fy = gout7y * dm[(j0+0)*nao+(i0+0)];
                fz = gout7z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+1)];
                fy = gout8y * dm[(j0+0)*nao+(i0+1)];
                fz = gout8z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+2)];
                fy = gout9y * dm[(j0+0)*nao+(i0+2)];
                fz = gout9z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+0)*nao+(i0+0)];
                fy = gout10y * dm[(j0+0)*nao+(i0+0)];
                fz = gout10z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+1)];
                fy = gout11y * dm[(j0+0)*nao+(i0+1)];
                fz = gout11z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+2)];
                fy = gout12y * dm[(j0+0)*nao+(i0+2)];
                fz = gout12z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+2), fz);
                break;
                case 3:
                fx = gout0x * dm[(l0+0)*nao+(k0+1)];
                fy = gout0y * dm[(l0+0)*nao+(k0+1)];
                fz = gout0z * dm[(l0+0)*nao+(k0+1)];
                fx += gout3x * dm[(l0+0)*nao+(k0+5)];
                fy += gout3y * dm[(l0+0)*nao+(k0+5)];
                fz += gout3z * dm[(l0+0)*nao+(k0+5)];
                fx += gout6x * dm[(l0+1)*nao+(k0+3)];
                fy += gout6y * dm[(l0+1)*nao+(k0+3)];
                fz += gout6z * dm[(l0+1)*nao+(k0+3)];
                fx += gout9x * dm[(l0+2)*nao+(k0+1)];
                fy += gout9y * dm[(l0+2)*nao+(k0+1)];
                fz += gout9z * dm[(l0+2)*nao+(k0+1)];
                fx += gout12x * dm[(l0+2)*nao+(k0+5)];
                fy += gout12y * dm[(l0+2)*nao+(k0+5)];
                fz += gout12z * dm[(l0+2)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+2)];
                fy = gout1y * dm[(l0+0)*nao+(k0+2)];
                fz = gout1z * dm[(l0+0)*nao+(k0+2)];
                fx += gout4x * dm[(l0+1)*nao+(k0+0)];
                fy += gout4y * dm[(l0+1)*nao+(k0+0)];
                fz += gout4z * dm[(l0+1)*nao+(k0+0)];
                fx += gout7x * dm[(l0+1)*nao+(k0+4)];
                fy += gout7y * dm[(l0+1)*nao+(k0+4)];
                fz += gout7z * dm[(l0+1)*nao+(k0+4)];
                fx += gout10x * dm[(l0+2)*nao+(k0+2)];
                fy += gout10y * dm[(l0+2)*nao+(k0+2)];
                fz += gout10z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+3)];
                fy = gout2y * dm[(l0+0)*nao+(k0+3)];
                fz = gout2z * dm[(l0+0)*nao+(k0+3)];
                fx += gout5x * dm[(l0+1)*nao+(k0+1)];
                fy += gout5y * dm[(l0+1)*nao+(k0+1)];
                fz += gout5z * dm[(l0+1)*nao+(k0+1)];
                fx += gout8x * dm[(l0+1)*nao+(k0+5)];
                fy += gout8y * dm[(l0+1)*nao+(k0+5)];
                fz += gout8z * dm[(l0+1)*nao+(k0+5)];
                fx += gout11x * dm[(l0+2)*nao+(k0+3)];
                fy += gout11y * dm[(l0+2)*nao+(k0+3)];
                fz += gout11z * dm[(l0+2)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+1)];
                fy = gout1y * dm[(j0+0)*nao+(i0+1)];
                fz = gout1z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+2)];
                fy = gout2y * dm[(j0+0)*nao+(i0+2)];
                fz = gout2z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+1)];
                fy = gout4y * dm[(j0+0)*nao+(i0+1)];
                fz = gout4z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+2)];
                fy = gout5y * dm[(j0+0)*nao+(i0+2)];
                fz = gout5z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+1)];
                fy = gout7y * dm[(j0+0)*nao+(i0+1)];
                fz = gout7z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+2)];
                fy = gout8y * dm[(j0+0)*nao+(i0+2)];
                fz = gout8z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+0)*nao+(i0+1)];
                fy = gout10y * dm[(j0+0)*nao+(i0+1)];
                fz = gout10z * dm[(j0+0)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+2)];
                fy = gout11y * dm[(j0+0)*nao+(i0+2)];
                fz = gout11z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+2), fz);
                break;
                }
            }
            if (do_k) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+4)];
                fy += gout3y * dm[(j0+0)*nao+(k0+4)];
                fz += gout3z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+2)];
                fy = gout6y * dm[(j0+0)*nao+(k0+2)];
                fz = gout6z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+0)];
                fy = gout9y * dm[(j0+0)*nao+(k0+0)];
                fz = gout9z * dm[(j0+0)*nao+(k0+0)];
                fx += gout12x * dm[(j0+0)*nao+(k0+4)];
                fy += gout12y * dm[(j0+0)*nao+(k0+4)];
                fz += gout12z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+1)];
                fy = gout1y * dm[(j0+0)*nao+(k0+1)];
                fz = gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout4x * dm[(j0+0)*nao+(k0+5)];
                fy += gout4y * dm[(j0+0)*nao+(k0+5)];
                fz += gout4z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(k0+3)];
                fy = gout7y * dm[(j0+0)*nao+(k0+3)];
                fz = gout7z * dm[(j0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(k0+1)];
                fy = gout10y * dm[(j0+0)*nao+(k0+1)];
                fz = gout10z * dm[(j0+0)*nao+(k0+1)];
                fx += gout13x * dm[(j0+0)*nao+(k0+5)];
                fy += gout13y * dm[(j0+0)*nao+(k0+5)];
                fz += gout13z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+2)];
                fy = gout2y * dm[(j0+0)*nao+(k0+2)];
                fz = gout2z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+0)];
                fy = gout5y * dm[(j0+0)*nao+(k0+0)];
                fz = gout5z * dm[(j0+0)*nao+(k0+0)];
                fx += gout8x * dm[(j0+0)*nao+(k0+4)];
                fy += gout8y * dm[(j0+0)*nao+(k0+4)];
                fz += gout8z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+2)];
                fy = gout11y * dm[(j0+0)*nao+(k0+2)];
                fz = gout11z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+4)];
                fy += gout3y * dm[(i0+0)*nao+(k0+4)];
                fz += gout3z * dm[(i0+0)*nao+(k0+4)];
                fx += gout1x * dm[(i0+1)*nao+(k0+1)];
                fy += gout1y * dm[(i0+1)*nao+(k0+1)];
                fz += gout1z * dm[(i0+1)*nao+(k0+1)];
                fx += gout4x * dm[(i0+1)*nao+(k0+5)];
                fy += gout4y * dm[(i0+1)*nao+(k0+5)];
                fz += gout4z * dm[(i0+1)*nao+(k0+5)];
                fx += gout2x * dm[(i0+2)*nao+(k0+2)];
                fy += gout2y * dm[(i0+2)*nao+(k0+2)];
                fz += gout2z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+2)];
                fy = gout6y * dm[(i0+0)*nao+(k0+2)];
                fz = gout6z * dm[(i0+0)*nao+(k0+2)];
                fx += gout7x * dm[(i0+1)*nao+(k0+3)];
                fy += gout7y * dm[(i0+1)*nao+(k0+3)];
                fz += gout7z * dm[(i0+1)*nao+(k0+3)];
                fx += gout5x * dm[(i0+2)*nao+(k0+0)];
                fy += gout5y * dm[(i0+2)*nao+(k0+0)];
                fz += gout5z * dm[(i0+2)*nao+(k0+0)];
                fx += gout8x * dm[(i0+2)*nao+(k0+4)];
                fy += gout8y * dm[(i0+2)*nao+(k0+4)];
                fz += gout8z * dm[(i0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+4)];
                fy += gout12y * dm[(i0+0)*nao+(k0+4)];
                fz += gout12z * dm[(i0+0)*nao+(k0+4)];
                fx += gout10x * dm[(i0+1)*nao+(k0+1)];
                fy += gout10y * dm[(i0+1)*nao+(k0+1)];
                fz += gout10z * dm[(i0+1)*nao+(k0+1)];
                fx += gout13x * dm[(i0+1)*nao+(k0+5)];
                fy += gout13y * dm[(i0+1)*nao+(k0+5)];
                fz += gout13z * dm[(i0+1)*nao+(k0+5)];
                fx += gout11x * dm[(i0+2)*nao+(k0+2)];
                fy += gout11y * dm[(i0+2)*nao+(k0+2)];
                fz += gout11z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+2)];
                fy += gout9y * dm[(j0+0)*nao+(l0+2)];
                fz += gout9z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+2)];
                fy += gout10y * dm[(j0+0)*nao+(l0+2)];
                fz += gout10z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+3), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout13x * dm[(j0+0)*nao+(l0+2)];
                fy += gout13y * dm[(j0+0)*nao+(l0+2)];
                fz += gout13z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+5), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+1)];
                fy = gout5y * dm[(j0+0)*nao+(l0+1)];
                fz = gout5z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+2)];
                fy += gout11y * dm[(j0+0)*nao+(l0+2)];
                fz += gout11z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+1)];
                fy = gout8y * dm[(j0+0)*nao+(l0+1)];
                fz = gout8z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+4), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+2)];
                fy += gout9y * dm[(i0+0)*nao+(l0+2)];
                fz += gout9z * dm[(i0+0)*nao+(l0+2)];
                fx += gout5x * dm[(i0+2)*nao+(l0+1)];
                fy += gout5y * dm[(i0+2)*nao+(l0+1)];
                fz += gout5z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout10x * dm[(i0+1)*nao+(l0+2)];
                fy += gout10y * dm[(i0+1)*nao+(l0+2)];
                fz += gout10z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                fx += gout11x * dm[(i0+2)*nao+(l0+2)];
                fy += gout11y * dm[(i0+2)*nao+(l0+2)];
                fz += gout11z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout7x * dm[(i0+1)*nao+(l0+1)];
                fy = gout7y * dm[(i0+1)*nao+(l0+1)];
                fz = gout7z * dm[(i0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                fx += gout8x * dm[(i0+2)*nao+(l0+1)];
                fy += gout8y * dm[(i0+2)*nao+(l0+1)];
                fz += gout8z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+0)];
                fy = gout4y * dm[(i0+1)*nao+(l0+0)];
                fz = gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout13x * dm[(i0+1)*nao+(l0+2)];
                fy += gout13y * dm[(i0+1)*nao+(l0+2)];
                fz += gout13z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                break;
                case 1:
                fx = gout2x * dm[(j0+0)*nao+(k0+3)];
                fy = gout2y * dm[(j0+0)*nao+(k0+3)];
                fz = gout2z * dm[(j0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+1)];
                fy = gout5y * dm[(j0+0)*nao+(k0+1)];
                fz = gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout8x * dm[(j0+0)*nao+(k0+5)];
                fy += gout8y * dm[(j0+0)*nao+(k0+5)];
                fz += gout8z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+3)];
                fy = gout11y * dm[(j0+0)*nao+(k0+3)];
                fz = gout11z * dm[(j0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+4)];
                fy += gout3y * dm[(j0+0)*nao+(k0+4)];
                fz += gout3z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+2)];
                fy = gout6y * dm[(j0+0)*nao+(k0+2)];
                fz = gout6z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+0)];
                fy = gout9y * dm[(j0+0)*nao+(k0+0)];
                fz = gout9z * dm[(j0+0)*nao+(k0+0)];
                fx += gout12x * dm[(j0+0)*nao+(k0+4)];
                fy += gout12y * dm[(j0+0)*nao+(k0+4)];
                fz += gout12z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+1)];
                fy = gout1y * dm[(j0+0)*nao+(k0+1)];
                fz = gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout4x * dm[(j0+0)*nao+(k0+5)];
                fy += gout4y * dm[(j0+0)*nao+(k0+5)];
                fz += gout4z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(k0+3)];
                fy = gout7y * dm[(j0+0)*nao+(k0+3)];
                fz = gout7z * dm[(j0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(k0+1)];
                fy = gout10y * dm[(j0+0)*nao+(k0+1)];
                fz = gout10z * dm[(j0+0)*nao+(k0+1)];
                fx += gout13x * dm[(j0+0)*nao+(k0+5)];
                fy += gout13y * dm[(j0+0)*nao+(k0+5)];
                fz += gout13z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+3)];
                fy = gout2y * dm[(i0+0)*nao+(k0+3)];
                fz = gout2z * dm[(i0+0)*nao+(k0+3)];
                fx += gout0x * dm[(i0+1)*nao+(k0+0)];
                fy += gout0y * dm[(i0+1)*nao+(k0+0)];
                fz += gout0z * dm[(i0+1)*nao+(k0+0)];
                fx += gout3x * dm[(i0+1)*nao+(k0+4)];
                fy += gout3y * dm[(i0+1)*nao+(k0+4)];
                fz += gout3z * dm[(i0+1)*nao+(k0+4)];
                fx += gout1x * dm[(i0+2)*nao+(k0+1)];
                fy += gout1y * dm[(i0+2)*nao+(k0+1)];
                fz += gout1z * dm[(i0+2)*nao+(k0+1)];
                fx += gout4x * dm[(i0+2)*nao+(k0+5)];
                fy += gout4y * dm[(i0+2)*nao+(k0+5)];
                fz += gout4z * dm[(i0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+1)];
                fy = gout5y * dm[(i0+0)*nao+(k0+1)];
                fz = gout5z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+0)*nao+(k0+5)];
                fy += gout8y * dm[(i0+0)*nao+(k0+5)];
                fz += gout8z * dm[(i0+0)*nao+(k0+5)];
                fx += gout6x * dm[(i0+1)*nao+(k0+2)];
                fy += gout6y * dm[(i0+1)*nao+(k0+2)];
                fz += gout6z * dm[(i0+1)*nao+(k0+2)];
                fx += gout7x * dm[(i0+2)*nao+(k0+3)];
                fy += gout7y * dm[(i0+2)*nao+(k0+3)];
                fz += gout7z * dm[(i0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout11x * dm[(i0+0)*nao+(k0+3)];
                fy = gout11y * dm[(i0+0)*nao+(k0+3)];
                fz = gout11z * dm[(i0+0)*nao+(k0+3)];
                fx += gout9x * dm[(i0+1)*nao+(k0+0)];
                fy += gout9y * dm[(i0+1)*nao+(k0+0)];
                fz += gout9z * dm[(i0+1)*nao+(k0+0)];
                fx += gout12x * dm[(i0+1)*nao+(k0+4)];
                fy += gout12y * dm[(i0+1)*nao+(k0+4)];
                fz += gout12z * dm[(i0+1)*nao+(k0+4)];
                fx += gout10x * dm[(i0+2)*nao+(k0+1)];
                fy += gout10y * dm[(i0+2)*nao+(k0+1)];
                fz += gout10z * dm[(i0+2)*nao+(k0+1)];
                fx += gout13x * dm[(i0+2)*nao+(k0+5)];
                fy += gout13y * dm[(i0+2)*nao+(k0+5)];
                fz += gout13z * dm[(i0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+1)];
                fy = gout5y * dm[(j0+0)*nao+(l0+1)];
                fz = gout5z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+2)];
                fy += gout11y * dm[(j0+0)*nao+(l0+2)];
                fz += gout11z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+1)];
                fy = gout8y * dm[(j0+0)*nao+(l0+1)];
                fz = gout8z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+2)];
                fy += gout9y * dm[(j0+0)*nao+(l0+2)];
                fz += gout9z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+4), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+2)];
                fy += gout10y * dm[(j0+0)*nao+(l0+2)];
                fz += gout10z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+3), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout13x * dm[(j0+0)*nao+(l0+2)];
                fy += gout13y * dm[(j0+0)*nao+(l0+2)];
                fz += gout13z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+1)*nao+(l0+0)];
                fy = gout0y * dm[(i0+1)*nao+(l0+0)];
                fz = gout0z * dm[(i0+1)*nao+(l0+0)];
                fx += gout9x * dm[(i0+1)*nao+(l0+2)];
                fy += gout9y * dm[(i0+1)*nao+(l0+2)];
                fz += gout9z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+1)];
                fy = gout5y * dm[(i0+0)*nao+(l0+1)];
                fz = gout5z * dm[(i0+0)*nao+(l0+1)];
                fx += gout1x * dm[(i0+2)*nao+(l0+0)];
                fy += gout1y * dm[(i0+2)*nao+(l0+0)];
                fz += gout1z * dm[(i0+2)*nao+(l0+0)];
                fx += gout10x * dm[(i0+2)*nao+(l0+2)];
                fy += gout10y * dm[(i0+2)*nao+(l0+2)];
                fz += gout10z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+1)*nao+(l0+1)];
                fy = gout6y * dm[(i0+1)*nao+(l0+1)];
                fz = gout6z * dm[(i0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+0)*nao+(l0+2)];
                fy += gout11y * dm[(i0+0)*nao+(l0+2)];
                fz += gout11z * dm[(i0+0)*nao+(l0+2)];
                fx += gout7x * dm[(i0+2)*nao+(l0+1)];
                fy += gout7y * dm[(i0+2)*nao+(l0+1)];
                fz += gout7z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout3x * dm[(i0+1)*nao+(l0+0)];
                fy = gout3y * dm[(i0+1)*nao+(l0+0)];
                fz = gout3z * dm[(i0+1)*nao+(l0+0)];
                fx += gout12x * dm[(i0+1)*nao+(l0+2)];
                fy += gout12y * dm[(i0+1)*nao+(l0+2)];
                fz += gout12z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+1)];
                fy = gout8y * dm[(i0+0)*nao+(l0+1)];
                fz = gout8z * dm[(i0+0)*nao+(l0+1)];
                fx += gout4x * dm[(i0+2)*nao+(l0+0)];
                fy += gout4y * dm[(i0+2)*nao+(l0+0)];
                fz += gout4z * dm[(i0+2)*nao+(l0+0)];
                fx += gout13x * dm[(i0+2)*nao+(l0+2)];
                fy += gout13y * dm[(i0+2)*nao+(l0+2)];
                fz += gout13z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                break;
                case 2:
                fx = gout1x * dm[(j0+0)*nao+(k0+2)];
                fy = gout1y * dm[(j0+0)*nao+(k0+2)];
                fz = gout1z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+0)];
                fy = gout4y * dm[(j0+0)*nao+(k0+0)];
                fz = gout4z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+0)*nao+(k0+4)];
                fy += gout7y * dm[(j0+0)*nao+(k0+4)];
                fz += gout7z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(k0+2)];
                fy = gout10y * dm[(j0+0)*nao+(k0+2)];
                fz = gout10z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+3)];
                fy = gout2y * dm[(j0+0)*nao+(k0+3)];
                fz = gout2z * dm[(j0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+1)];
                fy = gout5y * dm[(j0+0)*nao+(k0+1)];
                fz = gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout8x * dm[(j0+0)*nao+(k0+5)];
                fy += gout8y * dm[(j0+0)*nao+(k0+5)];
                fz += gout8z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+3)];
                fy = gout11y * dm[(j0+0)*nao+(k0+3)];
                fz = gout11z * dm[(j0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+4)];
                fy += gout3y * dm[(j0+0)*nao+(k0+4)];
                fz += gout3z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+2)];
                fy = gout6y * dm[(j0+0)*nao+(k0+2)];
                fz = gout6z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+0)];
                fy = gout9y * dm[(j0+0)*nao+(k0+0)];
                fz = gout9z * dm[(j0+0)*nao+(k0+0)];
                fx += gout12x * dm[(j0+0)*nao+(k0+4)];
                fy += gout12y * dm[(j0+0)*nao+(k0+4)];
                fz += gout12z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+2)];
                fy = gout1y * dm[(i0+0)*nao+(k0+2)];
                fz = gout1z * dm[(i0+0)*nao+(k0+2)];
                fx += gout2x * dm[(i0+1)*nao+(k0+3)];
                fy += gout2y * dm[(i0+1)*nao+(k0+3)];
                fz += gout2z * dm[(i0+1)*nao+(k0+3)];
                fx += gout0x * dm[(i0+2)*nao+(k0+0)];
                fy += gout0y * dm[(i0+2)*nao+(k0+0)];
                fz += gout0z * dm[(i0+2)*nao+(k0+0)];
                fx += gout3x * dm[(i0+2)*nao+(k0+4)];
                fy += gout3y * dm[(i0+2)*nao+(k0+4)];
                fz += gout3z * dm[(i0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+0)];
                fy = gout4y * dm[(i0+0)*nao+(k0+0)];
                fz = gout4z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+0)*nao+(k0+4)];
                fy += gout7y * dm[(i0+0)*nao+(k0+4)];
                fz += gout7z * dm[(i0+0)*nao+(k0+4)];
                fx += gout5x * dm[(i0+1)*nao+(k0+1)];
                fy += gout5y * dm[(i0+1)*nao+(k0+1)];
                fz += gout5z * dm[(i0+1)*nao+(k0+1)];
                fx += gout8x * dm[(i0+1)*nao+(k0+5)];
                fy += gout8y * dm[(i0+1)*nao+(k0+5)];
                fz += gout8z * dm[(i0+1)*nao+(k0+5)];
                fx += gout6x * dm[(i0+2)*nao+(k0+2)];
                fy += gout6y * dm[(i0+2)*nao+(k0+2)];
                fz += gout6z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+2)];
                fy = gout10y * dm[(i0+0)*nao+(k0+2)];
                fz = gout10z * dm[(i0+0)*nao+(k0+2)];
                fx += gout11x * dm[(i0+1)*nao+(k0+3)];
                fy += gout11y * dm[(i0+1)*nao+(k0+3)];
                fz += gout11z * dm[(i0+1)*nao+(k0+3)];
                fx += gout9x * dm[(i0+2)*nao+(k0+0)];
                fy += gout9y * dm[(i0+2)*nao+(k0+0)];
                fz += gout9z * dm[(i0+2)*nao+(k0+0)];
                fx += gout12x * dm[(i0+2)*nao+(k0+4)];
                fy += gout12y * dm[(i0+2)*nao+(k0+4)];
                fz += gout12z * dm[(i0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+1)];
                fy = gout4y * dm[(j0+0)*nao+(l0+1)];
                fz = gout4z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+2)];
                fy += gout10y * dm[(j0+0)*nao+(l0+2)];
                fz += gout10z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+1)];
                fy = gout5y * dm[(j0+0)*nao+(l0+1)];
                fz = gout5z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+2)];
                fy += gout11y * dm[(j0+0)*nao+(l0+2)];
                fz += gout11z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+3), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+1)];
                fy = gout8y * dm[(j0+0)*nao+(l0+1)];
                fz = gout8z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+2)];
                fy += gout9y * dm[(j0+0)*nao+(l0+2)];
                fz += gout9z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+4), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+1)];
                fy = gout4y * dm[(i0+0)*nao+(l0+1)];
                fz = gout4z * dm[(i0+0)*nao+(l0+1)];
                fx += gout0x * dm[(i0+2)*nao+(l0+0)];
                fy += gout0y * dm[(i0+2)*nao+(l0+0)];
                fz += gout0z * dm[(i0+2)*nao+(l0+0)];
                fx += gout9x * dm[(i0+2)*nao+(l0+2)];
                fy += gout9y * dm[(i0+2)*nao+(l0+2)];
                fz += gout9z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+1)*nao+(l0+1)];
                fy = gout5y * dm[(i0+1)*nao+(l0+1)];
                fz = gout5z * dm[(i0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+2)];
                fy += gout10y * dm[(i0+0)*nao+(l0+2)];
                fz += gout10z * dm[(i0+0)*nao+(l0+2)];
                fx += gout6x * dm[(i0+2)*nao+(l0+1)];
                fy += gout6y * dm[(i0+2)*nao+(l0+1)];
                fz += gout6z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout2x * dm[(i0+1)*nao+(l0+0)];
                fy = gout2y * dm[(i0+1)*nao+(l0+0)];
                fz = gout2z * dm[(i0+1)*nao+(l0+0)];
                fx += gout11x * dm[(i0+1)*nao+(l0+2)];
                fy += gout11y * dm[(i0+1)*nao+(l0+2)];
                fz += gout11z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+1)];
                fy = gout7y * dm[(i0+0)*nao+(l0+1)];
                fz = gout7z * dm[(i0+0)*nao+(l0+1)];
                fx += gout3x * dm[(i0+2)*nao+(l0+0)];
                fy += gout3y * dm[(i0+2)*nao+(l0+0)];
                fz += gout3z * dm[(i0+2)*nao+(l0+0)];
                fx += gout12x * dm[(i0+2)*nao+(l0+2)];
                fy += gout12y * dm[(i0+2)*nao+(l0+2)];
                fz += gout12z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout8x * dm[(i0+1)*nao+(l0+1)];
                fy = gout8y * dm[(i0+1)*nao+(l0+1)];
                fz = gout8z * dm[(i0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                break;
                case 3:
                fx = gout0x * dm[(j0+0)*nao+(k0+1)];
                fy = gout0y * dm[(j0+0)*nao+(k0+1)];
                fz = gout0z * dm[(j0+0)*nao+(k0+1)];
                fx += gout3x * dm[(j0+0)*nao+(k0+5)];
                fy += gout3y * dm[(j0+0)*nao+(k0+5)];
                fz += gout3z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+3)];
                fy = gout6y * dm[(j0+0)*nao+(k0+3)];
                fz = gout6z * dm[(j0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+1)];
                fy = gout9y * dm[(j0+0)*nao+(k0+1)];
                fz = gout9z * dm[(j0+0)*nao+(k0+1)];
                fx += gout12x * dm[(j0+0)*nao+(k0+5)];
                fy += gout12y * dm[(j0+0)*nao+(k0+5)];
                fz += gout12z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+2)];
                fy = gout1y * dm[(j0+0)*nao+(k0+2)];
                fz = gout1z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+0)];
                fy = gout4y * dm[(j0+0)*nao+(k0+0)];
                fz = gout4z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+0)*nao+(k0+4)];
                fy += gout7y * dm[(j0+0)*nao+(k0+4)];
                fz += gout7z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(k0+2)];
                fy = gout10y * dm[(j0+0)*nao+(k0+2)];
                fz = gout10z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+3)];
                fy = gout2y * dm[(j0+0)*nao+(k0+3)];
                fz = gout2z * dm[(j0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+1)];
                fy = gout5y * dm[(j0+0)*nao+(k0+1)];
                fz = gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout8x * dm[(j0+0)*nao+(k0+5)];
                fy += gout8y * dm[(j0+0)*nao+(k0+5)];
                fz += gout8z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+3)];
                fy = gout11y * dm[(j0+0)*nao+(k0+3)];
                fz = gout11z * dm[(j0+0)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+1)];
                fy = gout0y * dm[(i0+0)*nao+(k0+1)];
                fz = gout0z * dm[(i0+0)*nao+(k0+1)];
                fx += gout3x * dm[(i0+0)*nao+(k0+5)];
                fy += gout3y * dm[(i0+0)*nao+(k0+5)];
                fz += gout3z * dm[(i0+0)*nao+(k0+5)];
                fx += gout1x * dm[(i0+1)*nao+(k0+2)];
                fy += gout1y * dm[(i0+1)*nao+(k0+2)];
                fz += gout1z * dm[(i0+1)*nao+(k0+2)];
                fx += gout2x * dm[(i0+2)*nao+(k0+3)];
                fy += gout2y * dm[(i0+2)*nao+(k0+3)];
                fz += gout2z * dm[(i0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+3)];
                fy = gout6y * dm[(i0+0)*nao+(k0+3)];
                fz = gout6z * dm[(i0+0)*nao+(k0+3)];
                fx += gout4x * dm[(i0+1)*nao+(k0+0)];
                fy += gout4y * dm[(i0+1)*nao+(k0+0)];
                fz += gout4z * dm[(i0+1)*nao+(k0+0)];
                fx += gout7x * dm[(i0+1)*nao+(k0+4)];
                fy += gout7y * dm[(i0+1)*nao+(k0+4)];
                fz += gout7z * dm[(i0+1)*nao+(k0+4)];
                fx += gout5x * dm[(i0+2)*nao+(k0+1)];
                fy += gout5y * dm[(i0+2)*nao+(k0+1)];
                fz += gout5z * dm[(i0+2)*nao+(k0+1)];
                fx += gout8x * dm[(i0+2)*nao+(k0+5)];
                fy += gout8y * dm[(i0+2)*nao+(k0+5)];
                fz += gout8z * dm[(i0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+1)];
                fy = gout9y * dm[(i0+0)*nao+(k0+1)];
                fz = gout9z * dm[(i0+0)*nao+(k0+1)];
                fx += gout12x * dm[(i0+0)*nao+(k0+5)];
                fy += gout12y * dm[(i0+0)*nao+(k0+5)];
                fz += gout12z * dm[(i0+0)*nao+(k0+5)];
                fx += gout10x * dm[(i0+1)*nao+(k0+2)];
                fy += gout10y * dm[(i0+1)*nao+(k0+2)];
                fz += gout10z * dm[(i0+1)*nao+(k0+2)];
                fx += gout11x * dm[(i0+2)*nao+(k0+3)];
                fy += gout11y * dm[(i0+2)*nao+(k0+3)];
                fz += gout11z * dm[(i0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+2)];
                fy += gout9y * dm[(j0+0)*nao+(l0+2)];
                fz += gout9z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+1)];
                fy = gout4y * dm[(j0+0)*nao+(l0+1)];
                fz = gout4z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+2)];
                fy += gout10y * dm[(j0+0)*nao+(l0+2)];
                fz += gout10z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+4), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+1)];
                fy = gout5y * dm[(j0+0)*nao+(l0+1)];
                fz = gout5z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+2)];
                fy += gout11y * dm[(j0+0)*nao+(l0+2)];
                fz += gout11z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+3), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+1)];
                fy = gout8y * dm[(j0+0)*nao+(l0+1)];
                fz = gout8z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+5), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+1)];
                fy = gout4y * dm[(i0+1)*nao+(l0+1)];
                fz = gout4z * dm[(i0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+2)];
                fy += gout9y * dm[(i0+0)*nao+(l0+2)];
                fz += gout9z * dm[(i0+0)*nao+(l0+2)];
                fx += gout5x * dm[(i0+2)*nao+(l0+1)];
                fy += gout5y * dm[(i0+2)*nao+(l0+1)];
                fz += gout5z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout10x * dm[(i0+1)*nao+(l0+2)];
                fy += gout10y * dm[(i0+1)*nao+(l0+2)];
                fz += gout10z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                fx += gout11x * dm[(i0+2)*nao+(l0+2)];
                fy += gout11y * dm[(i0+2)*nao+(l0+2)];
                fz += gout11z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout7x * dm[(i0+1)*nao+(l0+1)];
                fy = gout7y * dm[(i0+1)*nao+(l0+1)];
                fz = gout7z * dm[(i0+1)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                fx += gout8x * dm[(i0+2)*nao+(l0+1)];
                fy += gout8y * dm[(i0+2)*nao+(l0+1)];
                fz += gout8z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                break;
                }
            }
        }
    }
}
__global__
static void rys_vjk_ip1_1021(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_1021(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_1100(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    ai2 = rjri[5];
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_30x = c0x * trr_20x + 2*b10 * trr_10x;
                    double hrr_2100x = trr_30x - rjri[0] * trr_20x;
                    fx = ai2 * hrr_2100x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double hrr_0100x = trr_10x - rjri[0] * 1;
                    fx -= 1 * hrr_0100x;
                    double hrr_1100x = trr_20x - rjri[0] * trr_10x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_1100x *  fy  * wt;
                    gout0z += hrr_1100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * 1;
                    gout1x +=  fx  * trr_10y * wt;
                    gout1y += hrr_0100x *  fy  * wt;
                    gout1z += hrr_0100x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout2x +=  fx  * 1 * trr_10z;
                    gout2y += hrr_0100x *  fy  * trr_10z;
                    gout2z += hrr_0100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    double hrr_1100y = trr_20y - rjri[1] * trr_10y;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * 1;
                    double hrr_0100y = trr_10y - rjri[1] * 1;
                    gout3x +=  fx  * hrr_0100y * wt;
                    gout3y += trr_10x *  fy  * wt;
                    gout3z += trr_10x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_30y = c0y * trr_20y + 2*b10 * trr_10y;
                    double hrr_2100y = trr_30y - rjri[1] * trr_20y;
                    fy = ai2 * hrr_2100y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * hrr_0100y;
                    gout4x +=  fx  * hrr_1100y * wt;
                    gout4y += 1 *  fy  * wt;
                    gout4z += 1 * hrr_1100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout5x +=  fx  * hrr_0100y * trr_10z;
                    gout5y += 1 *  fy  * trr_10z;
                    gout5z += 1 * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_10y;
                    double hrr_1100z = trr_20z - rjri[2] * trr_10z;
                    fz = ai2 * hrr_1100z;
                    fx -= 1 * 1;
                    double hrr_0100z = trr_10z - rjri[2] * wt;
                    gout6x +=  fx  * 1 * hrr_0100z;
                    gout6y += trr_10x *  fy  * hrr_0100z;
                    gout6z += trr_10x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * hrr_1100z;
                    fy -= 1 * 1;
                    gout7x +=  fx  * trr_10y * hrr_0100z;
                    gout7y += 1 *  fy  * hrr_0100z;
                    gout7z += 1 * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_30z = c0z * trr_20z + 2*b10 * trr_10z;
                    double hrr_2100z = trr_30z - rjri[2] * trr_20z;
                    fz = ai2 * hrr_2100z;
                    fz -= 1 * hrr_0100z;
                    gout8x +=  fx  * 1 * hrr_1100z;
                    gout8y += 1 *  fy  * hrr_1100z;
                    gout8z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+0)];
                fy = gout6y * dm[(l0+0)*nao+(k0+0)];
                fz = gout6z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+0)];
                fy = gout7y * dm[(l0+0)*nao+(k0+0)];
                fz = gout7z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+0)];
                fy = gout8y * dm[(l0+0)*nao+(k0+0)];
                fz = gout8z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+1)];
                fy += gout1y * dm[(j0+0)*nao+(i0+1)];
                fz += gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+2)];
                fy += gout2y * dm[(j0+0)*nao+(i0+2)];
                fz += gout2z * dm[(j0+0)*nao+(i0+2)];
                fx += gout3x * dm[(j0+1)*nao+(i0+0)];
                fy += gout3y * dm[(j0+1)*nao+(i0+0)];
                fz += gout3z * dm[(j0+1)*nao+(i0+0)];
                fx += gout4x * dm[(j0+1)*nao+(i0+1)];
                fy += gout4y * dm[(j0+1)*nao+(i0+1)];
                fz += gout4z * dm[(j0+1)*nao+(i0+1)];
                fx += gout5x * dm[(j0+1)*nao+(i0+2)];
                fy += gout5y * dm[(j0+1)*nao+(i0+2)];
                fz += gout5z * dm[(j0+1)*nao+(i0+2)];
                fx += gout6x * dm[(j0+2)*nao+(i0+0)];
                fy += gout6y * dm[(j0+2)*nao+(i0+0)];
                fz += gout6z * dm[(j0+2)*nao+(i0+0)];
                fx += gout7x * dm[(j0+2)*nao+(i0+1)];
                fy += gout7y * dm[(j0+2)*nao+(i0+1)];
                fz += gout7z * dm[(j0+2)*nao+(i0+1)];
                fx += gout8x * dm[(j0+2)*nao+(i0+2)];
                fy += gout8y * dm[(j0+2)*nao+(i0+2)];
                fz += gout8z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+1)*nao+(k0+0)];
                fy += gout3y * dm[(j0+1)*nao+(k0+0)];
                fz += gout3z * dm[(j0+1)*nao+(k0+0)];
                fx += gout6x * dm[(j0+2)*nao+(k0+0)];
                fy += gout6y * dm[(j0+2)*nao+(k0+0)];
                fz += gout6z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+1)*nao+(k0+0)];
                fy += gout4y * dm[(j0+1)*nao+(k0+0)];
                fz += gout4z * dm[(j0+1)*nao+(k0+0)];
                fx += gout7x * dm[(j0+2)*nao+(k0+0)];
                fy += gout7y * dm[(j0+2)*nao+(k0+0)];
                fz += gout7z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+0)];
                fy = gout2y * dm[(j0+0)*nao+(k0+0)];
                fz = gout2z * dm[(j0+0)*nao+(k0+0)];
                fx += gout5x * dm[(j0+1)*nao+(k0+0)];
                fy += gout5y * dm[(j0+1)*nao+(k0+0)];
                fz += gout5z * dm[(j0+1)*nao+(k0+0)];
                fx += gout8x * dm[(j0+2)*nao+(k0+0)];
                fy += gout8y * dm[(j0+2)*nao+(k0+0)];
                fz += gout8z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+0)];
                fy = gout3y * dm[(i0+0)*nao+(k0+0)];
                fz = gout3z * dm[(i0+0)*nao+(k0+0)];
                fx += gout4x * dm[(i0+1)*nao+(k0+0)];
                fy += gout4y * dm[(i0+1)*nao+(k0+0)];
                fz += gout4z * dm[(i0+1)*nao+(k0+0)];
                fx += gout5x * dm[(i0+2)*nao+(k0+0)];
                fy += gout5y * dm[(i0+2)*nao+(k0+0)];
                fz += gout5z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+0)];
                fy = gout6y * dm[(i0+0)*nao+(k0+0)];
                fz = gout6z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+1)*nao+(k0+0)];
                fy += gout7y * dm[(i0+1)*nao+(k0+0)];
                fz += gout7z * dm[(i0+1)*nao+(k0+0)];
                fx += gout8x * dm[(i0+2)*nao+(k0+0)];
                fy += gout8y * dm[(i0+2)*nao+(k0+0)];
                fz += gout8z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+1)*nao+(l0+0)];
                fy += gout3y * dm[(j0+1)*nao+(l0+0)];
                fz += gout3z * dm[(j0+1)*nao+(l0+0)];
                fx += gout6x * dm[(j0+2)*nao+(l0+0)];
                fy += gout6y * dm[(j0+2)*nao+(l0+0)];
                fz += gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout4x * dm[(j0+1)*nao+(l0+0)];
                fy += gout4y * dm[(j0+1)*nao+(l0+0)];
                fz += gout4z * dm[(j0+1)*nao+(l0+0)];
                fx += gout7x * dm[(j0+2)*nao+(l0+0)];
                fy += gout7y * dm[(j0+2)*nao+(l0+0)];
                fz += gout7z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout5x * dm[(j0+1)*nao+(l0+0)];
                fy += gout5y * dm[(j0+1)*nao+(l0+0)];
                fz += gout5z * dm[(j0+1)*nao+(l0+0)];
                fx += gout8x * dm[(j0+2)*nao+(l0+0)];
                fy += gout8y * dm[(j0+2)*nao+(l0+0)];
                fz += gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+1)*nao+(l0+0)];
                fy += gout1y * dm[(i0+1)*nao+(l0+0)];
                fz += gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout4x * dm[(i0+1)*nao+(l0+0)];
                fy += gout4y * dm[(i0+1)*nao+(l0+0)];
                fz += gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout5x * dm[(i0+2)*nao+(l0+0)];
                fy += gout5y * dm[(i0+2)*nao+(l0+0)];
                fz += gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+1)*nao+(l0+0)];
                fy += gout7y * dm[(i0+1)*nao+(l0+0)];
                fz += gout7z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+2)*nao+(l0+0)];
                fy += gout8y * dm[(i0+2)*nao+(l0+0)];
                fz += gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_1100(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_1100(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_1110(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double gout18x, gout18y, gout18z;
    double gout19x, gout19y, gout19z;
    double gout20x, gout20y, gout20z;
    double gout21x, gout21y, gout21z;
    double gout22x, gout22y, gout22z;
    double gout23x, gout23y, gout23z;
    double gout24x, gout24y, gout24z;
    double gout25x, gout25y, gout25z;
    double gout26x, gout26y, gout26z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        gout18x = 0;
        gout18y = 0;
        gout18z = 0;
        gout19x = 0;
        gout19y = 0;
        gout19z = 0;
        gout20x = 0;
        gout20y = 0;
        gout20z = 0;
        gout21x = 0;
        gout21y = 0;
        gout21z = 0;
        gout22x = 0;
        gout22y = 0;
        gout22z = 0;
        gout23x = 0;
        gout23y = 0;
        gout23z = 0;
        gout24x = 0;
        gout24y = 0;
        gout24z = 0;
        gout25x = 0;
        gout25y = 0;
        gout25z = 0;
        gout26x = 0;
        gout26y = 0;
        gout26z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_30x = c0x * trr_20x + 2*b10 * trr_10x;
                    double trr_31x = cpx * trr_30x + 3*b00 * trr_20x;
                    double trr_21x = cpx * trr_20x + 2*b00 * trr_10x;
                    double hrr_2110x = trr_31x - rjri[0] * trr_21x;
                    fx = ai2 * hrr_2110x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    double trr_01x = cpx * 1;
                    double hrr_0110x = trr_11x - rjri[0] * trr_01x;
                    fx -= 1 * hrr_0110x;
                    double hrr_1110x = trr_21x - rjri[0] * trr_11x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_1110x *  fy  * wt;
                    gout0z += hrr_1110x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1110x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * 1;
                    gout1x +=  fx  * trr_10y * wt;
                    gout1y += hrr_0110x *  fy  * wt;
                    gout1z += hrr_0110x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1110x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout2x +=  fx  * 1 * trr_10z;
                    gout2y += hrr_0110x *  fy  * trr_10z;
                    gout2z += hrr_0110x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_21x;
                    double hrr_1100y = trr_20y - rjri[1] * trr_10y;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * trr_01x;
                    double hrr_0100y = trr_10y - rjri[1] * 1;
                    gout3x +=  fx  * hrr_0100y * wt;
                    gout3y += trr_11x *  fy  * wt;
                    gout3z += trr_11x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double trr_30y = c0y * trr_20y + 2*b10 * trr_10y;
                    double hrr_2100y = trr_30y - rjri[1] * trr_20y;
                    fy = ai2 * hrr_2100y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * hrr_0100y;
                    gout4x +=  fx  * hrr_1100y * wt;
                    gout4y += trr_01x *  fy  * wt;
                    gout4z += trr_01x * hrr_1100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout5x +=  fx  * hrr_0100y * trr_10z;
                    gout5y += trr_01x *  fy  * trr_10z;
                    gout5z += trr_01x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_21x;
                    fy = ai2 * trr_10y;
                    double hrr_1100z = trr_20z - rjri[2] * trr_10z;
                    fz = ai2 * hrr_1100z;
                    fx -= 1 * trr_01x;
                    double hrr_0100z = trr_10z - rjri[2] * wt;
                    gout6x +=  fx  * 1 * hrr_0100z;
                    gout6y += trr_11x *  fy  * hrr_0100z;
                    gout6z += trr_11x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * hrr_1100z;
                    fy -= 1 * 1;
                    gout7x +=  fx  * trr_10y * hrr_0100z;
                    gout7y += trr_01x *  fy  * hrr_0100z;
                    gout7z += trr_01x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double trr_30z = c0z * trr_20z + 2*b10 * trr_10z;
                    double hrr_2100z = trr_30z - rjri[2] * trr_20z;
                    fz = ai2 * hrr_2100z;
                    fz -= 1 * hrr_0100z;
                    gout8x +=  fx  * 1 * hrr_1100z;
                    gout8y += trr_01x *  fy  * hrr_1100z;
                    gout8z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    double hrr_2100x = trr_30x - rjri[0] * trr_20x;
                    fx = ai2 * hrr_2100x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    double hrr_0100x = trr_10x - rjri[0] * 1;
                    fx -= 1 * hrr_0100x;
                    double hrr_1100x = trr_20x - rjri[0] * trr_10x;
                    double trr_01y = cpy * 1;
                    gout9x +=  fx  * trr_01y * wt;
                    gout9y += hrr_1100x *  fy  * wt;
                    gout9z += hrr_1100x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    double trr_21y = cpy * trr_20y + 2*b00 * trr_10y;
                    fy = ai2 * trr_21y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * trr_01y;
                    gout10x +=  fx  * trr_11y * wt;
                    gout10y += hrr_0100x *  fy  * wt;
                    gout10z += hrr_0100x * trr_11y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout11x +=  fx  * trr_01y * trr_10z;
                    gout11y += hrr_0100x *  fy  * trr_10z;
                    gout11z += hrr_0100x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    double hrr_1110y = trr_21y - rjri[1] * trr_11y;
                    fy = ai2 * hrr_1110y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * 1;
                    double hrr_0110y = trr_11y - rjri[1] * trr_01y;
                    gout12x +=  fx  * hrr_0110y * wt;
                    gout12y += trr_10x *  fy  * wt;
                    gout12z += trr_10x * hrr_0110y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_31y = cpy * trr_30y + 3*b00 * trr_20y;
                    double hrr_2110y = trr_31y - rjri[1] * trr_21y;
                    fy = ai2 * hrr_2110y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * hrr_0110y;
                    gout13x +=  fx  * hrr_1110y * wt;
                    gout13y += 1 *  fy  * wt;
                    gout13z += 1 * hrr_1110y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1110y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout14x +=  fx  * hrr_0110y * trr_10z;
                    gout14y += 1 *  fy  * trr_10z;
                    gout14z += 1 * hrr_0110y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_1100z;
                    fx -= 1 * 1;
                    gout15x +=  fx  * trr_01y * hrr_0100z;
                    gout15y += trr_10x *  fy  * hrr_0100z;
                    gout15z += trr_10x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_21y;
                    fz = ai2 * hrr_1100z;
                    fy -= 1 * trr_01y;
                    gout16x +=  fx  * trr_11y * hrr_0100z;
                    gout16y += 1 *  fy  * hrr_0100z;
                    gout16z += 1 * trr_11y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * hrr_2100z;
                    fz -= 1 * hrr_0100z;
                    gout17x +=  fx  * trr_01y * hrr_1100z;
                    gout17y += 1 *  fy  * hrr_1100z;
                    gout17z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_2100x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    fx -= 1 * hrr_0100x;
                    double trr_01z = cpz * wt;
                    gout18x +=  fx  * 1 * trr_01z;
                    gout18y += hrr_1100x *  fy  * trr_01z;
                    gout18z += hrr_1100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_11z;
                    fy -= 1 * 1;
                    gout19x +=  fx  * trr_10y * trr_01z;
                    gout19y += hrr_0100x *  fy  * trr_01z;
                    gout19z += hrr_0100x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_10y;
                    double trr_21z = cpz * trr_20z + 2*b00 * trr_10z;
                    fz = ai2 * trr_21z;
                    fz -= 1 * trr_01z;
                    gout20x +=  fx  * 1 * trr_11z;
                    gout20y += hrr_0100x *  fy  * trr_11z;
                    gout20z += hrr_0100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_11z;
                    fx -= 1 * 1;
                    gout21x +=  fx  * hrr_0100y * trr_01z;
                    gout21y += trr_10x *  fy  * trr_01z;
                    gout21z += trr_10x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_2100y;
                    fz = ai2 * trr_11z;
                    fy -= 1 * hrr_0100y;
                    gout22x +=  fx  * hrr_1100y * trr_01z;
                    gout22y += 1 *  fy  * trr_01z;
                    gout22z += 1 * hrr_1100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_21z;
                    fz -= 1 * trr_01z;
                    gout23x +=  fx  * hrr_0100y * trr_11z;
                    gout23y += 1 *  fy  * trr_11z;
                    gout23z += 1 * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_10y;
                    double hrr_1110z = trr_21z - rjri[2] * trr_11z;
                    fz = ai2 * hrr_1110z;
                    fx -= 1 * 1;
                    double hrr_0110z = trr_11z - rjri[2] * trr_01z;
                    gout24x +=  fx  * 1 * hrr_0110z;
                    gout24y += trr_10x *  fy  * hrr_0110z;
                    gout24z += trr_10x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * hrr_1110z;
                    fy -= 1 * 1;
                    gout25x +=  fx  * trr_10y * hrr_0110z;
                    gout25y += 1 *  fy  * hrr_0110z;
                    gout25z += 1 * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_31z = cpz * trr_30z + 3*b00 * trr_20z;
                    double hrr_2110z = trr_31z - rjri[2] * trr_21z;
                    fz = ai2 * hrr_2110z;
                    fz -= 1 * hrr_0110z;
                    gout26x +=  fx  * 1 * hrr_1110z;
                    gout26y += 1 *  fy  * hrr_1110z;
                    gout26z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+1)];
                fy += gout9y * dm[(l0+0)*nao+(k0+1)];
                fz += gout9z * dm[(l0+0)*nao+(k0+1)];
                fx += gout18x * dm[(l0+0)*nao+(k0+2)];
                fy += gout18y * dm[(l0+0)*nao+(k0+2)];
                fz += gout18z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                fx += gout12x * dm[(l0+0)*nao+(k0+1)];
                fy += gout12y * dm[(l0+0)*nao+(k0+1)];
                fz += gout12z * dm[(l0+0)*nao+(k0+1)];
                fx += gout21x * dm[(l0+0)*nao+(k0+2)];
                fy += gout21y * dm[(l0+0)*nao+(k0+2)];
                fz += gout21z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+0)];
                fy = gout6y * dm[(l0+0)*nao+(k0+0)];
                fz = gout6z * dm[(l0+0)*nao+(k0+0)];
                fx += gout15x * dm[(l0+0)*nao+(k0+1)];
                fy += gout15y * dm[(l0+0)*nao+(k0+1)];
                fz += gout15z * dm[(l0+0)*nao+(k0+1)];
                fx += gout24x * dm[(l0+0)*nao+(k0+2)];
                fy += gout24y * dm[(l0+0)*nao+(k0+2)];
                fz += gout24z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+1)];
                fy += gout10y * dm[(l0+0)*nao+(k0+1)];
                fz += gout10z * dm[(l0+0)*nao+(k0+1)];
                fx += gout19x * dm[(l0+0)*nao+(k0+2)];
                fy += gout19y * dm[(l0+0)*nao+(k0+2)];
                fz += gout19z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                fx += gout13x * dm[(l0+0)*nao+(k0+1)];
                fy += gout13y * dm[(l0+0)*nao+(k0+1)];
                fz += gout13z * dm[(l0+0)*nao+(k0+1)];
                fx += gout22x * dm[(l0+0)*nao+(k0+2)];
                fy += gout22y * dm[(l0+0)*nao+(k0+2)];
                fz += gout22z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+0)];
                fy = gout7y * dm[(l0+0)*nao+(k0+0)];
                fz = gout7z * dm[(l0+0)*nao+(k0+0)];
                fx += gout16x * dm[(l0+0)*nao+(k0+1)];
                fy += gout16y * dm[(l0+0)*nao+(k0+1)];
                fz += gout16z * dm[(l0+0)*nao+(k0+1)];
                fx += gout25x * dm[(l0+0)*nao+(k0+2)];
                fy += gout25y * dm[(l0+0)*nao+(k0+2)];
                fz += gout25z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+1)];
                fy += gout11y * dm[(l0+0)*nao+(k0+1)];
                fz += gout11z * dm[(l0+0)*nao+(k0+1)];
                fx += gout20x * dm[(l0+0)*nao+(k0+2)];
                fy += gout20y * dm[(l0+0)*nao+(k0+2)];
                fz += gout20z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                fx += gout14x * dm[(l0+0)*nao+(k0+1)];
                fy += gout14y * dm[(l0+0)*nao+(k0+1)];
                fz += gout14z * dm[(l0+0)*nao+(k0+1)];
                fx += gout23x * dm[(l0+0)*nao+(k0+2)];
                fy += gout23y * dm[(l0+0)*nao+(k0+2)];
                fz += gout23z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+0)];
                fy = gout8y * dm[(l0+0)*nao+(k0+0)];
                fz = gout8z * dm[(l0+0)*nao+(k0+0)];
                fx += gout17x * dm[(l0+0)*nao+(k0+1)];
                fy += gout17y * dm[(l0+0)*nao+(k0+1)];
                fz += gout17z * dm[(l0+0)*nao+(k0+1)];
                fx += gout26x * dm[(l0+0)*nao+(k0+2)];
                fy += gout26y * dm[(l0+0)*nao+(k0+2)];
                fz += gout26z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+1)];
                fy += gout1y * dm[(j0+0)*nao+(i0+1)];
                fz += gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+2)];
                fy += gout2y * dm[(j0+0)*nao+(i0+2)];
                fz += gout2z * dm[(j0+0)*nao+(i0+2)];
                fx += gout3x * dm[(j0+1)*nao+(i0+0)];
                fy += gout3y * dm[(j0+1)*nao+(i0+0)];
                fz += gout3z * dm[(j0+1)*nao+(i0+0)];
                fx += gout4x * dm[(j0+1)*nao+(i0+1)];
                fy += gout4y * dm[(j0+1)*nao+(i0+1)];
                fz += gout4z * dm[(j0+1)*nao+(i0+1)];
                fx += gout5x * dm[(j0+1)*nao+(i0+2)];
                fy += gout5y * dm[(j0+1)*nao+(i0+2)];
                fz += gout5z * dm[(j0+1)*nao+(i0+2)];
                fx += gout6x * dm[(j0+2)*nao+(i0+0)];
                fy += gout6y * dm[(j0+2)*nao+(i0+0)];
                fz += gout6z * dm[(j0+2)*nao+(i0+0)];
                fx += gout7x * dm[(j0+2)*nao+(i0+1)];
                fy += gout7y * dm[(j0+2)*nao+(i0+1)];
                fz += gout7z * dm[(j0+2)*nao+(i0+1)];
                fx += gout8x * dm[(j0+2)*nao+(i0+2)];
                fy += gout8y * dm[(j0+2)*nao+(i0+2)];
                fz += gout8z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                fx += gout10x * dm[(j0+0)*nao+(i0+1)];
                fy += gout10y * dm[(j0+0)*nao+(i0+1)];
                fz += gout10z * dm[(j0+0)*nao+(i0+1)];
                fx += gout11x * dm[(j0+0)*nao+(i0+2)];
                fy += gout11y * dm[(j0+0)*nao+(i0+2)];
                fz += gout11z * dm[(j0+0)*nao+(i0+2)];
                fx += gout12x * dm[(j0+1)*nao+(i0+0)];
                fy += gout12y * dm[(j0+1)*nao+(i0+0)];
                fz += gout12z * dm[(j0+1)*nao+(i0+0)];
                fx += gout13x * dm[(j0+1)*nao+(i0+1)];
                fy += gout13y * dm[(j0+1)*nao+(i0+1)];
                fz += gout13z * dm[(j0+1)*nao+(i0+1)];
                fx += gout14x * dm[(j0+1)*nao+(i0+2)];
                fy += gout14y * dm[(j0+1)*nao+(i0+2)];
                fz += gout14z * dm[(j0+1)*nao+(i0+2)];
                fx += gout15x * dm[(j0+2)*nao+(i0+0)];
                fy += gout15y * dm[(j0+2)*nao+(i0+0)];
                fz += gout15z * dm[(j0+2)*nao+(i0+0)];
                fx += gout16x * dm[(j0+2)*nao+(i0+1)];
                fy += gout16y * dm[(j0+2)*nao+(i0+1)];
                fz += gout16z * dm[(j0+2)*nao+(i0+1)];
                fx += gout17x * dm[(j0+2)*nao+(i0+2)];
                fy += gout17y * dm[(j0+2)*nao+(i0+2)];
                fz += gout17z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout18x * dm[(j0+0)*nao+(i0+0)];
                fy = gout18y * dm[(j0+0)*nao+(i0+0)];
                fz = gout18z * dm[(j0+0)*nao+(i0+0)];
                fx += gout19x * dm[(j0+0)*nao+(i0+1)];
                fy += gout19y * dm[(j0+0)*nao+(i0+1)];
                fz += gout19z * dm[(j0+0)*nao+(i0+1)];
                fx += gout20x * dm[(j0+0)*nao+(i0+2)];
                fy += gout20y * dm[(j0+0)*nao+(i0+2)];
                fz += gout20z * dm[(j0+0)*nao+(i0+2)];
                fx += gout21x * dm[(j0+1)*nao+(i0+0)];
                fy += gout21y * dm[(j0+1)*nao+(i0+0)];
                fz += gout21z * dm[(j0+1)*nao+(i0+0)];
                fx += gout22x * dm[(j0+1)*nao+(i0+1)];
                fy += gout22y * dm[(j0+1)*nao+(i0+1)];
                fz += gout22z * dm[(j0+1)*nao+(i0+1)];
                fx += gout23x * dm[(j0+1)*nao+(i0+2)];
                fy += gout23y * dm[(j0+1)*nao+(i0+2)];
                fz += gout23z * dm[(j0+1)*nao+(i0+2)];
                fx += gout24x * dm[(j0+2)*nao+(i0+0)];
                fy += gout24y * dm[(j0+2)*nao+(i0+0)];
                fz += gout24z * dm[(j0+2)*nao+(i0+0)];
                fx += gout25x * dm[(j0+2)*nao+(i0+1)];
                fy += gout25y * dm[(j0+2)*nao+(i0+1)];
                fz += gout25z * dm[(j0+2)*nao+(i0+1)];
                fx += gout26x * dm[(j0+2)*nao+(i0+2)];
                fy += gout26y * dm[(j0+2)*nao+(i0+2)];
                fz += gout26z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+1)];
                fy += gout9y * dm[(j0+0)*nao+(k0+1)];
                fz += gout9z * dm[(j0+0)*nao+(k0+1)];
                fx += gout18x * dm[(j0+0)*nao+(k0+2)];
                fy += gout18y * dm[(j0+0)*nao+(k0+2)];
                fz += gout18z * dm[(j0+0)*nao+(k0+2)];
                fx += gout3x * dm[(j0+1)*nao+(k0+0)];
                fy += gout3y * dm[(j0+1)*nao+(k0+0)];
                fz += gout3z * dm[(j0+1)*nao+(k0+0)];
                fx += gout12x * dm[(j0+1)*nao+(k0+1)];
                fy += gout12y * dm[(j0+1)*nao+(k0+1)];
                fz += gout12z * dm[(j0+1)*nao+(k0+1)];
                fx += gout21x * dm[(j0+1)*nao+(k0+2)];
                fy += gout21y * dm[(j0+1)*nao+(k0+2)];
                fz += gout21z * dm[(j0+1)*nao+(k0+2)];
                fx += gout6x * dm[(j0+2)*nao+(k0+0)];
                fy += gout6y * dm[(j0+2)*nao+(k0+0)];
                fz += gout6z * dm[(j0+2)*nao+(k0+0)];
                fx += gout15x * dm[(j0+2)*nao+(k0+1)];
                fy += gout15y * dm[(j0+2)*nao+(k0+1)];
                fz += gout15z * dm[(j0+2)*nao+(k0+1)];
                fx += gout24x * dm[(j0+2)*nao+(k0+2)];
                fy += gout24y * dm[(j0+2)*nao+(k0+2)];
                fz += gout24z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout10x * dm[(j0+0)*nao+(k0+1)];
                fy += gout10y * dm[(j0+0)*nao+(k0+1)];
                fz += gout10z * dm[(j0+0)*nao+(k0+1)];
                fx += gout19x * dm[(j0+0)*nao+(k0+2)];
                fy += gout19y * dm[(j0+0)*nao+(k0+2)];
                fz += gout19z * dm[(j0+0)*nao+(k0+2)];
                fx += gout4x * dm[(j0+1)*nao+(k0+0)];
                fy += gout4y * dm[(j0+1)*nao+(k0+0)];
                fz += gout4z * dm[(j0+1)*nao+(k0+0)];
                fx += gout13x * dm[(j0+1)*nao+(k0+1)];
                fy += gout13y * dm[(j0+1)*nao+(k0+1)];
                fz += gout13z * dm[(j0+1)*nao+(k0+1)];
                fx += gout22x * dm[(j0+1)*nao+(k0+2)];
                fy += gout22y * dm[(j0+1)*nao+(k0+2)];
                fz += gout22z * dm[(j0+1)*nao+(k0+2)];
                fx += gout7x * dm[(j0+2)*nao+(k0+0)];
                fy += gout7y * dm[(j0+2)*nao+(k0+0)];
                fz += gout7z * dm[(j0+2)*nao+(k0+0)];
                fx += gout16x * dm[(j0+2)*nao+(k0+1)];
                fy += gout16y * dm[(j0+2)*nao+(k0+1)];
                fz += gout16z * dm[(j0+2)*nao+(k0+1)];
                fx += gout25x * dm[(j0+2)*nao+(k0+2)];
                fy += gout25y * dm[(j0+2)*nao+(k0+2)];
                fz += gout25z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+0)];
                fy = gout2y * dm[(j0+0)*nao+(k0+0)];
                fz = gout2z * dm[(j0+0)*nao+(k0+0)];
                fx += gout11x * dm[(j0+0)*nao+(k0+1)];
                fy += gout11y * dm[(j0+0)*nao+(k0+1)];
                fz += gout11z * dm[(j0+0)*nao+(k0+1)];
                fx += gout20x * dm[(j0+0)*nao+(k0+2)];
                fy += gout20y * dm[(j0+0)*nao+(k0+2)];
                fz += gout20z * dm[(j0+0)*nao+(k0+2)];
                fx += gout5x * dm[(j0+1)*nao+(k0+0)];
                fy += gout5y * dm[(j0+1)*nao+(k0+0)];
                fz += gout5z * dm[(j0+1)*nao+(k0+0)];
                fx += gout14x * dm[(j0+1)*nao+(k0+1)];
                fy += gout14y * dm[(j0+1)*nao+(k0+1)];
                fz += gout14z * dm[(j0+1)*nao+(k0+1)];
                fx += gout23x * dm[(j0+1)*nao+(k0+2)];
                fy += gout23y * dm[(j0+1)*nao+(k0+2)];
                fz += gout23z * dm[(j0+1)*nao+(k0+2)];
                fx += gout8x * dm[(j0+2)*nao+(k0+0)];
                fy += gout8y * dm[(j0+2)*nao+(k0+0)];
                fz += gout8z * dm[(j0+2)*nao+(k0+0)];
                fx += gout17x * dm[(j0+2)*nao+(k0+1)];
                fy += gout17y * dm[(j0+2)*nao+(k0+1)];
                fz += gout17z * dm[(j0+2)*nao+(k0+1)];
                fx += gout26x * dm[(j0+2)*nao+(k0+2)];
                fy += gout26y * dm[(j0+2)*nao+(k0+2)];
                fz += gout26z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout9x * dm[(i0+0)*nao+(k0+1)];
                fy += gout9y * dm[(i0+0)*nao+(k0+1)];
                fz += gout9z * dm[(i0+0)*nao+(k0+1)];
                fx += gout18x * dm[(i0+0)*nao+(k0+2)];
                fy += gout18y * dm[(i0+0)*nao+(k0+2)];
                fz += gout18z * dm[(i0+0)*nao+(k0+2)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout10x * dm[(i0+1)*nao+(k0+1)];
                fy += gout10y * dm[(i0+1)*nao+(k0+1)];
                fz += gout10z * dm[(i0+1)*nao+(k0+1)];
                fx += gout19x * dm[(i0+1)*nao+(k0+2)];
                fy += gout19y * dm[(i0+1)*nao+(k0+2)];
                fz += gout19z * dm[(i0+1)*nao+(k0+2)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                fx += gout11x * dm[(i0+2)*nao+(k0+1)];
                fy += gout11y * dm[(i0+2)*nao+(k0+1)];
                fz += gout11z * dm[(i0+2)*nao+(k0+1)];
                fx += gout20x * dm[(i0+2)*nao+(k0+2)];
                fy += gout20y * dm[(i0+2)*nao+(k0+2)];
                fz += gout20z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+0)];
                fy = gout3y * dm[(i0+0)*nao+(k0+0)];
                fz = gout3z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+1)];
                fy += gout12y * dm[(i0+0)*nao+(k0+1)];
                fz += gout12z * dm[(i0+0)*nao+(k0+1)];
                fx += gout21x * dm[(i0+0)*nao+(k0+2)];
                fy += gout21y * dm[(i0+0)*nao+(k0+2)];
                fz += gout21z * dm[(i0+0)*nao+(k0+2)];
                fx += gout4x * dm[(i0+1)*nao+(k0+0)];
                fy += gout4y * dm[(i0+1)*nao+(k0+0)];
                fz += gout4z * dm[(i0+1)*nao+(k0+0)];
                fx += gout13x * dm[(i0+1)*nao+(k0+1)];
                fy += gout13y * dm[(i0+1)*nao+(k0+1)];
                fz += gout13z * dm[(i0+1)*nao+(k0+1)];
                fx += gout22x * dm[(i0+1)*nao+(k0+2)];
                fy += gout22y * dm[(i0+1)*nao+(k0+2)];
                fz += gout22z * dm[(i0+1)*nao+(k0+2)];
                fx += gout5x * dm[(i0+2)*nao+(k0+0)];
                fy += gout5y * dm[(i0+2)*nao+(k0+0)];
                fz += gout5z * dm[(i0+2)*nao+(k0+0)];
                fx += gout14x * dm[(i0+2)*nao+(k0+1)];
                fy += gout14y * dm[(i0+2)*nao+(k0+1)];
                fz += gout14z * dm[(i0+2)*nao+(k0+1)];
                fx += gout23x * dm[(i0+2)*nao+(k0+2)];
                fy += gout23y * dm[(i0+2)*nao+(k0+2)];
                fz += gout23z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+0)];
                fy = gout6y * dm[(i0+0)*nao+(k0+0)];
                fz = gout6z * dm[(i0+0)*nao+(k0+0)];
                fx += gout15x * dm[(i0+0)*nao+(k0+1)];
                fy += gout15y * dm[(i0+0)*nao+(k0+1)];
                fz += gout15z * dm[(i0+0)*nao+(k0+1)];
                fx += gout24x * dm[(i0+0)*nao+(k0+2)];
                fy += gout24y * dm[(i0+0)*nao+(k0+2)];
                fz += gout24z * dm[(i0+0)*nao+(k0+2)];
                fx += gout7x * dm[(i0+1)*nao+(k0+0)];
                fy += gout7y * dm[(i0+1)*nao+(k0+0)];
                fz += gout7z * dm[(i0+1)*nao+(k0+0)];
                fx += gout16x * dm[(i0+1)*nao+(k0+1)];
                fy += gout16y * dm[(i0+1)*nao+(k0+1)];
                fz += gout16z * dm[(i0+1)*nao+(k0+1)];
                fx += gout25x * dm[(i0+1)*nao+(k0+2)];
                fy += gout25y * dm[(i0+1)*nao+(k0+2)];
                fz += gout25z * dm[(i0+1)*nao+(k0+2)];
                fx += gout8x * dm[(i0+2)*nao+(k0+0)];
                fy += gout8y * dm[(i0+2)*nao+(k0+0)];
                fz += gout8z * dm[(i0+2)*nao+(k0+0)];
                fx += gout17x * dm[(i0+2)*nao+(k0+1)];
                fy += gout17y * dm[(i0+2)*nao+(k0+1)];
                fz += gout17z * dm[(i0+2)*nao+(k0+1)];
                fx += gout26x * dm[(i0+2)*nao+(k0+2)];
                fy += gout26y * dm[(i0+2)*nao+(k0+2)];
                fz += gout26z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+1)*nao+(l0+0)];
                fy += gout3y * dm[(j0+1)*nao+(l0+0)];
                fz += gout3z * dm[(j0+1)*nao+(l0+0)];
                fx += gout6x * dm[(j0+2)*nao+(l0+0)];
                fy += gout6y * dm[(j0+2)*nao+(l0+0)];
                fz += gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+1)*nao+(l0+0)];
                fy += gout12y * dm[(j0+1)*nao+(l0+0)];
                fz += gout12z * dm[(j0+1)*nao+(l0+0)];
                fx += gout15x * dm[(j0+2)*nao+(l0+0)];
                fy += gout15y * dm[(j0+2)*nao+(l0+0)];
                fz += gout15z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout18x * dm[(j0+0)*nao+(l0+0)];
                fy = gout18y * dm[(j0+0)*nao+(l0+0)];
                fz = gout18z * dm[(j0+0)*nao+(l0+0)];
                fx += gout21x * dm[(j0+1)*nao+(l0+0)];
                fy += gout21y * dm[(j0+1)*nao+(l0+0)];
                fz += gout21z * dm[(j0+1)*nao+(l0+0)];
                fx += gout24x * dm[(j0+2)*nao+(l0+0)];
                fy += gout24y * dm[(j0+2)*nao+(l0+0)];
                fz += gout24z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout4x * dm[(j0+1)*nao+(l0+0)];
                fy += gout4y * dm[(j0+1)*nao+(l0+0)];
                fz += gout4z * dm[(j0+1)*nao+(l0+0)];
                fx += gout7x * dm[(j0+2)*nao+(l0+0)];
                fy += gout7y * dm[(j0+2)*nao+(l0+0)];
                fz += gout7z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout10x * dm[(j0+0)*nao+(l0+0)];
                fy = gout10y * dm[(j0+0)*nao+(l0+0)];
                fz = gout10z * dm[(j0+0)*nao+(l0+0)];
                fx += gout13x * dm[(j0+1)*nao+(l0+0)];
                fy += gout13y * dm[(j0+1)*nao+(l0+0)];
                fz += gout13z * dm[(j0+1)*nao+(l0+0)];
                fx += gout16x * dm[(j0+2)*nao+(l0+0)];
                fy += gout16y * dm[(j0+2)*nao+(l0+0)];
                fz += gout16z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout19x * dm[(j0+0)*nao+(l0+0)];
                fy = gout19y * dm[(j0+0)*nao+(l0+0)];
                fz = gout19z * dm[(j0+0)*nao+(l0+0)];
                fx += gout22x * dm[(j0+1)*nao+(l0+0)];
                fy += gout22y * dm[(j0+1)*nao+(l0+0)];
                fz += gout22z * dm[(j0+1)*nao+(l0+0)];
                fx += gout25x * dm[(j0+2)*nao+(l0+0)];
                fy += gout25y * dm[(j0+2)*nao+(l0+0)];
                fz += gout25z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout5x * dm[(j0+1)*nao+(l0+0)];
                fy += gout5y * dm[(j0+1)*nao+(l0+0)];
                fz += gout5z * dm[(j0+1)*nao+(l0+0)];
                fx += gout8x * dm[(j0+2)*nao+(l0+0)];
                fy += gout8y * dm[(j0+2)*nao+(l0+0)];
                fz += gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout11x * dm[(j0+0)*nao+(l0+0)];
                fy = gout11y * dm[(j0+0)*nao+(l0+0)];
                fz = gout11z * dm[(j0+0)*nao+(l0+0)];
                fx += gout14x * dm[(j0+1)*nao+(l0+0)];
                fy += gout14y * dm[(j0+1)*nao+(l0+0)];
                fz += gout14z * dm[(j0+1)*nao+(l0+0)];
                fx += gout17x * dm[(j0+2)*nao+(l0+0)];
                fy += gout17y * dm[(j0+2)*nao+(l0+0)];
                fz += gout17z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout20x * dm[(j0+0)*nao+(l0+0)];
                fy = gout20y * dm[(j0+0)*nao+(l0+0)];
                fz = gout20z * dm[(j0+0)*nao+(l0+0)];
                fx += gout23x * dm[(j0+1)*nao+(l0+0)];
                fy += gout23y * dm[(j0+1)*nao+(l0+0)];
                fz += gout23z * dm[(j0+1)*nao+(l0+0)];
                fx += gout26x * dm[(j0+2)*nao+(l0+0)];
                fy += gout26y * dm[(j0+2)*nao+(l0+0)];
                fz += gout26z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+1)*nao+(l0+0)];
                fy += gout1y * dm[(i0+1)*nao+(l0+0)];
                fz += gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+0)];
                fy = gout9y * dm[(i0+0)*nao+(l0+0)];
                fz = gout9z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+1)*nao+(l0+0)];
                fy += gout10y * dm[(i0+1)*nao+(l0+0)];
                fz += gout10z * dm[(i0+1)*nao+(l0+0)];
                fx += gout11x * dm[(i0+2)*nao+(l0+0)];
                fy += gout11y * dm[(i0+2)*nao+(l0+0)];
                fz += gout11z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout18x * dm[(i0+0)*nao+(l0+0)];
                fy = gout18y * dm[(i0+0)*nao+(l0+0)];
                fz = gout18z * dm[(i0+0)*nao+(l0+0)];
                fx += gout19x * dm[(i0+1)*nao+(l0+0)];
                fy += gout19y * dm[(i0+1)*nao+(l0+0)];
                fz += gout19z * dm[(i0+1)*nao+(l0+0)];
                fx += gout20x * dm[(i0+2)*nao+(l0+0)];
                fy += gout20y * dm[(i0+2)*nao+(l0+0)];
                fz += gout20z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout4x * dm[(i0+1)*nao+(l0+0)];
                fy += gout4y * dm[(i0+1)*nao+(l0+0)];
                fz += gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout5x * dm[(i0+2)*nao+(l0+0)];
                fy += gout5y * dm[(i0+2)*nao+(l0+0)];
                fz += gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+1)*nao+(l0+0)];
                fy += gout13y * dm[(i0+1)*nao+(l0+0)];
                fz += gout13z * dm[(i0+1)*nao+(l0+0)];
                fx += gout14x * dm[(i0+2)*nao+(l0+0)];
                fy += gout14y * dm[(i0+2)*nao+(l0+0)];
                fz += gout14z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout21x * dm[(i0+0)*nao+(l0+0)];
                fy = gout21y * dm[(i0+0)*nao+(l0+0)];
                fz = gout21z * dm[(i0+0)*nao+(l0+0)];
                fx += gout22x * dm[(i0+1)*nao+(l0+0)];
                fy += gout22y * dm[(i0+1)*nao+(l0+0)];
                fz += gout22z * dm[(i0+1)*nao+(l0+0)];
                fx += gout23x * dm[(i0+2)*nao+(l0+0)];
                fy += gout23y * dm[(i0+2)*nao+(l0+0)];
                fz += gout23z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+1)*nao+(l0+0)];
                fy += gout7y * dm[(i0+1)*nao+(l0+0)];
                fz += gout7z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+2)*nao+(l0+0)];
                fy += gout8y * dm[(i0+2)*nao+(l0+0)];
                fz += gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout15x * dm[(i0+0)*nao+(l0+0)];
                fy = gout15y * dm[(i0+0)*nao+(l0+0)];
                fz = gout15z * dm[(i0+0)*nao+(l0+0)];
                fx += gout16x * dm[(i0+1)*nao+(l0+0)];
                fy += gout16y * dm[(i0+1)*nao+(l0+0)];
                fz += gout16z * dm[(i0+1)*nao+(l0+0)];
                fx += gout17x * dm[(i0+2)*nao+(l0+0)];
                fy += gout17y * dm[(i0+2)*nao+(l0+0)];
                fz += gout17z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout24x * dm[(i0+0)*nao+(l0+0)];
                fy = gout24y * dm[(i0+0)*nao+(l0+0)];
                fz = gout24z * dm[(i0+0)*nao+(l0+0)];
                fx += gout25x * dm[(i0+1)*nao+(l0+0)];
                fy += gout25y * dm[(i0+1)*nao+(l0+0)];
                fz += gout25z * dm[(i0+1)*nao+(l0+0)];
                fx += gout26x * dm[(i0+2)*nao+(l0+0)];
                fy += gout26y * dm[(i0+2)*nao+(l0+0)];
                fz += gout26z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_1110(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_1110(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_1111(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;
    double *gx = rw + 128 * nroots;
    double *gy = gx + 1536;
    double *gz = gy + 1536;
    double *rlrk = gz + 1536;
    double *Rpq = rlrk + 192;
    if (gout_id == 0) {
        gx[0] = 1.;
        gy[0] = 1.;
    }
    double s0, s1, s2;
    double Ix, Iy, Iz;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double gout18x, gout18y, gout18z;
    double gout19x, gout19y, gout19z;
    double gout20x, gout20y, gout20z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        if (gout_id == 0) {
            rlrk[0] = xlxk;
            rlrk[64] = ylyk;
            rlrk[128] = zlzk;
        }
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        gout18x = 0;
        gout18y = 0;
        gout18z = 0;
        gout19x = 0;
        gout19y = 0;
        gout19z = 0;
        gout20x = 0;
        gout20y = 0;
        gout20z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            __syncthreads();
            double xlxk = rlrk[0];
            double ylyk = rlrk[64];
            double zlzk = rlrk[128];
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xkl = rk[0] + rlrk[0] * al_akl;
                double ykl = rk[1] + rlrk[64] * al_akl;
                double zkl = rk[2] + rlrk[128] * al_akl;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                __syncthreads();
                if (gout_id == 0) {
                    Rpq[0] = xpq;
                    Rpq[64] = ypq;
                    Rpq[128] = zpq;
                }
                rys_roots_rs(nroots, theta, rr, omega, rw, 64, gout_id, 4);
                for (int irys = 0; irys < nroots; ++irys) {
                    __syncthreads();
                    double rt = rw[irys*128];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double rt_akl = rt_aa * aij;
                    double b00 = .5 * rt_aa;
                    double b01 = .5/akl * (1 - rt_akl);
                    for (int n = gout_id; n < 3; n += 4) {
                        if (n == 2) {
                            gz[0] = rw[irys*128+64] * fac;
                        }
                        double *_gx = gx + n * 1536;
                        double xjxi = rjri[n];
                        double Rpa = xjxi * aj_aij;
                        double c0x = Rpa - rt_aij * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = c0x * s0;
                        _gx[64] = s1;
                        s2 = c0x * s1 + 1 * b10 * s0;
                        _gx[128] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 2 * b10 * s0;
                        _gx[192] = s2;
                        double xlxk = rlrk[n*64];
                        double Rqc = xlxk * al_akl;
                        double cpx = Rqc + rt_akl * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = cpx * s0;
                        _gx[384] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        _gx[768] = s2;
                        s0 = _gx[64];
                        s1 = cpx * s0;
                        s1 += 1 * b00 * _gx[0];
                        _gx[448] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 1 * b00 * _gx[384];
                        _gx[832] = s2;
                        s0 = _gx[128];
                        s1 = cpx * s0;
                        s1 += 2 * b00 * _gx[64];
                        _gx[512] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 2 * b00 * _gx[448];
                        _gx[896] = s2;
                        s0 = _gx[192];
                        s1 = cpx * s0;
                        s1 += 3 * b00 * _gx[128];
                        _gx[576] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 3 * b00 * _gx[512];
                        _gx[960] = s2;
                        s1 = _gx[192];
                        s0 = _gx[128];
                        _gx[320] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[256] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[192] = s1 - xjxi * s0;
                        s1 = _gx[576];
                        s0 = _gx[512];
                        _gx[704] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[448];
                        _gx[640] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[384];
                        _gx[576] = s1 - xjxi * s0;
                        s1 = _gx[960];
                        s0 = _gx[896];
                        _gx[1088] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[832];
                        _gx[1024] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[768];
                        _gx[960] = s1 - xjxi * s0;
                        s1 = _gx[768];
                        s0 = _gx[384];
                        _gx[1152] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[768] = s1 - xlxk * s0;
                        s1 = _gx[832];
                        s0 = _gx[448];
                        _gx[1216] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[832] = s1 - xlxk * s0;
                        s1 = _gx[896];
                        s0 = _gx[512];
                        _gx[1280] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[128];
                        _gx[896] = s1 - xlxk * s0;
                        s1 = _gx[960];
                        s0 = _gx[576];
                        _gx[1344] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[192];
                        _gx[960] = s1 - xlxk * s0;
                        s1 = _gx[1024];
                        s0 = _gx[640];
                        _gx[1408] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[256];
                        _gx[1024] = s1 - xlxk * s0;
                        s1 = _gx[1088];
                        s0 = _gx[704];
                        _gx[1472] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[320];
                        _gx[1088] = s1 - xlxk * s0;
                    }
                    __syncthreads();
                    switch (gout_id) {
                    case 0:
                    ai2 = rjri[5];
                    Ix = gx[1408];
                    Iy = gy[0];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[1472] - 1 * gx[1344]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1152];
                    Iy = gy[256];
                    Iz = gz[0];
                    gout1x += ai2 * gx[1216] * Iy * Iz;
                    gout1y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1152];
                    Iy = gy[0];
                    Iz = gz[256];
                    gout2x += ai2 * gx[1216] * Iy * Iz;
                    gout2y += ai2 * gy[64] * Ix * Iz;
                    gout2z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[576];
                    Iz = gz[0];
                    gout3x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout3y += ai2 * gy[640] * Ix * Iz;
                    gout3z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[448];
                    Iz = gz[192];
                    gout4x += ai2 * gx[832] * Iy * Iz;
                    gout4y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout4z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[960];
                    Iy = gy[0];
                    Iz = gz[448];
                    gout5x += ai2 * gx[1024] * Iy * Iz;
                    gout5y += ai2 * gy[64] * Ix * Iz;
                    gout5z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[0];
                    Iz = gz[576];
                    gout6x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout6y += ai2 * gy[64] * Ix * Iz;
                    gout6z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[832];
                    Iz = gz[0];
                    gout7x += ai2 * gx[640] * Iy * Iz;
                    gout7y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout7z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[960];
                    Iz = gz[64];
                    gout8x += ai2 * gx[448] * Iy * Iz;
                    gout8y += ai2 * gy[1024] * Ix * Iz;
                    gout8z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[1152];
                    Iz = gz[0];
                    gout9x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout9y += ai2 * gy[1216] * Ix * Iz;
                    gout9z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1408];
                    Iz = gz[0];
                    gout10x += ai2 * gx[64] * Iy * Iz;
                    gout10y += (ai2 * gy[1472] - 1 * gy[1344]) * Ix * Iz;
                    gout10z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1152];
                    Iz = gz[256];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += ai2 * gy[1216] * Ix * Iz;
                    gout11z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[960];
                    Iz = gz[384];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += ai2 * gy[1024] * Ix * Iz;
                    gout12z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[832];
                    Iz = gz[576];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout13z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[0];
                    Iz = gz[832];
                    gout14x += ai2 * gx[640] * Iy * Iz;
                    gout14y += ai2 * gy[64] * Ix * Iz;
                    gout14z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[0];
                    Iz = gz[960];
                    gout15x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout15y += ai2 * gy[64] * Ix * Iz;
                    gout15z += ai2 * gz[1024] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[448];
                    Iz = gz[768];
                    gout16x += ai2 * gx[256] * Iy * Iz;
                    gout16y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout16z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[576];
                    Iz = gz[832];
                    gout17x += ai2 * gx[64] * Iy * Iz;
                    gout17y += ai2 * gy[640] * Ix * Iz;
                    gout17z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[0];
                    Iz = gz[1152];
                    gout18x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout18y += ai2 * gy[64] * Ix * Iz;
                    gout18z += ai2 * gz[1216] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[256];
                    Iz = gz[1152];
                    gout19x += ai2 * gx[64] * Iy * Iz;
                    gout19y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout19z += ai2 * gz[1216] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[0];
                    Iz = gz[1408];
                    gout20x += ai2 * gx[64] * Iy * Iz;
                    gout20y += ai2 * gy[64] * Ix * Iz;
                    gout20z += (ai2 * gz[1472] - 1 * gz[1344]) * Ix * Iy;
                    break;
                    case 1:
                    ai2 = rjri[5];
                    Ix = gx[1344];
                    Iy = gy[64];
                    Iz = gz[0];
                    gout0x += ai2 * gx[1408] * Iy * Iz;
                    gout0y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1152];
                    Iy = gy[192];
                    Iz = gz[64];
                    gout1x += ai2 * gx[1216] * Iy * Iz;
                    gout1y += ai2 * gy[256] * Ix * Iz;
                    gout1z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[384];
                    Iz = gz[0];
                    gout2x += (ai2 * gx[1088] - 1 * gx[960]) * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[640];
                    Iz = gz[0];
                    gout3x += ai2 * gx[832] * Iy * Iz;
                    gout3y += (ai2 * gy[704] - 1 * gy[576]) * Ix * Iz;
                    gout3z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[384];
                    Iz = gz[256];
                    gout4x += ai2 * gx[832] * Iy * Iz;
                    gout4y += ai2 * gy[448] * Ix * Iz;
                    gout4z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[192];
                    Iz = gz[384];
                    gout5x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout5y += ai2 * gy[256] * Ix * Iz;
                    gout5z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[64];
                    Iz = gz[576];
                    gout6x += ai2 * gx[832] * Iy * Iz;
                    gout6y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout6z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[768];
                    Iz = gz[64];
                    gout7x += ai2 * gx[640] * Iy * Iz;
                    gout7y += ai2 * gy[832] * Ix * Iz;
                    gout7z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[768];
                    Iz = gz[192];
                    gout8x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout8y += ai2 * gy[832] * Ix * Iz;
                    gout8z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[1216];
                    Iz = gz[0];
                    gout9x += ai2 * gx[256] * Iy * Iz;
                    gout9y += (ai2 * gy[1280] - 1 * gy[1152]) * Ix * Iz;
                    gout9z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1344];
                    Iz = gz[64];
                    gout10x += ai2 * gx[64] * Iy * Iz;
                    gout10y += ai2 * gy[1408] * Ix * Iz;
                    gout10z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[768];
                    Iz = gz[384];
                    gout11x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout11y += ai2 * gy[832] * Ix * Iz;
                    gout11z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1024];
                    Iz = gz[384];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += (ai2 * gy[1088] - 1 * gy[960]) * Ix * Iz;
                    gout12z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[768];
                    Iz = gz[640];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += ai2 * gy[832] * Ix * Iz;
                    gout13z += (ai2 * gz[704] - 1 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[192];
                    Iz = gz[768];
                    gout14x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout14y += ai2 * gy[256] * Ix * Iz;
                    gout14z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[64];
                    Iz = gz[960];
                    gout15x += ai2 * gx[448] * Iy * Iz;
                    gout15y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout15z += ai2 * gz[1024] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[384];
                    Iz = gz[832];
                    gout16x += ai2 * gx[256] * Iy * Iz;
                    gout16y += ai2 * gy[448] * Ix * Iz;
                    gout16z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[384];
                    Iz = gz[960];
                    gout17x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout17y += ai2 * gy[448] * Ix * Iz;
                    gout17z += ai2 * gz[1024] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[64];
                    Iz = gz[1152];
                    gout18x += ai2 * gx[256] * Iy * Iz;
                    gout18y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout18z += ai2 * gz[1216] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[192];
                    Iz = gz[1216];
                    gout19x += ai2 * gx[64] * Iy * Iz;
                    gout19y += ai2 * gy[256] * Ix * Iz;
                    gout19z += (ai2 * gz[1280] - 1 * gz[1152]) * Ix * Iy;
                    break;
                    case 2:
                    ai2 = rjri[5];
                    Ix = gx[1344];
                    Iy = gy[0];
                    Iz = gz[64];
                    gout0x += ai2 * gx[1408] * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1216];
                    Iy = gy[0];
                    Iz = gz[192];
                    gout1x += (ai2 * gx[1280] - 1 * gx[1152]) * Iy * Iz;
                    gout1y += ai2 * gy[64] * Ix * Iz;
                    gout1z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[960];
                    Iy = gy[448];
                    Iz = gz[0];
                    gout2x += ai2 * gx[1024] * Iy * Iz;
                    gout2y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[576];
                    Iz = gz[64];
                    gout3x += ai2 * gx[832] * Iy * Iz;
                    gout3y += ai2 * gy[640] * Ix * Iz;
                    gout3z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[0];
                    Iz = gz[384];
                    gout4x += (ai2 * gx[1088] - 1 * gx[960]) * Iy * Iz;
                    gout4y += ai2 * gy[64] * Ix * Iz;
                    gout4z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[256];
                    Iz = gz[384];
                    gout5x += ai2 * gx[832] * Iy * Iz;
                    gout5y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout5z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[0];
                    Iz = gz[640];
                    gout6x += ai2 * gx[832] * Iy * Iz;
                    gout6y += ai2 * gy[64] * Ix * Iz;
                    gout6z += (ai2 * gz[704] - 1 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[960];
                    Iz = gz[0];
                    gout7x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout7y += ai2 * gy[1024] * Ix * Iz;
                    gout7z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[832];
                    Iz = gz[192];
                    gout8x += ai2 * gx[448] * Iy * Iz;
                    gout8y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout8z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[1152];
                    Iz = gz[64];
                    gout9x += ai2 * gx[256] * Iy * Iz;
                    gout9y += ai2 * gy[1216] * Ix * Iz;
                    gout9z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[1152];
                    Iz = gz[192];
                    gout10x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout10y += ai2 * gy[1216] * Ix * Iz;
                    gout10z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[832];
                    Iz = gz[384];
                    gout11x += ai2 * gx[256] * Iy * Iz;
                    gout11y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout11z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[960];
                    Iz = gz[448];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += ai2 * gy[1024] * Ix * Iz;
                    gout12z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[0];
                    Iz = gz[768];
                    gout13x += (ai2 * gx[704] - 1 * gx[576]) * Iy * Iz;
                    gout13y += ai2 * gy[64] * Ix * Iz;
                    gout13z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[256];
                    Iz = gz[768];
                    gout14x += ai2 * gx[448] * Iy * Iz;
                    gout14y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout14z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[0];
                    Iz = gz[1024];
                    gout15x += ai2 * gx[448] * Iy * Iz;
                    gout15y += ai2 * gy[64] * Ix * Iz;
                    gout15z += (ai2 * gz[1088] - 1 * gz[960]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[576];
                    Iz = gz[768];
                    gout16x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout16y += ai2 * gy[640] * Ix * Iz;
                    gout16z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[448];
                    Iz = gz[960];
                    gout17x += ai2 * gx[64] * Iy * Iz;
                    gout17y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout17z += ai2 * gz[1024] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[0];
                    Iz = gz[1216];
                    gout18x += ai2 * gx[256] * Iy * Iz;
                    gout18y += ai2 * gy[64] * Ix * Iz;
                    gout18z += (ai2 * gz[1280] - 1 * gz[1152]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[0];
                    Iz = gz[1344];
                    gout19x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout19y += ai2 * gy[64] * Ix * Iz;
                    gout19z += ai2 * gz[1408] * Ix * Iy;
                    break;
                    case 3:
                    ai2 = rjri[5];
                    Ix = gx[1216];
                    Iy = gy[192];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[1280] - 1 * gx[1152]) * Iy * Iz;
                    gout0y += ai2 * gy[256] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[1152];
                    Iy = gy[64];
                    Iz = gz[192];
                    gout1x += ai2 * gx[1216] * Iy * Iz;
                    gout1y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout1z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[960];
                    Iy = gy[384];
                    Iz = gz[64];
                    gout2x += ai2 * gx[1024] * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[384];
                    Iz = gz[192];
                    gout3x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout3y += ai2 * gy[448] * Ix * Iz;
                    gout3z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[960];
                    Iy = gy[64];
                    Iz = gz[384];
                    gout4x += ai2 * gx[1024] * Iy * Iz;
                    gout4y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout4z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[192];
                    Iz = gz[448];
                    gout5x += ai2 * gx[832] * Iy * Iz;
                    gout5y += ai2 * gy[256] * Ix * Iz;
                    gout5z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[768];
                    Iz = gz[0];
                    gout6x += (ai2 * gx[704] - 1 * gx[576]) * Iy * Iz;
                    gout6y += ai2 * gy[832] * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[1024];
                    Iz = gz[0];
                    gout7x += ai2 * gx[448] * Iy * Iz;
                    gout7y += (ai2 * gy[1088] - 1 * gy[960]) * Ix * Iz;
                    gout7z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[768];
                    Iz = gz[256];
                    gout8x += ai2 * gx[448] * Iy * Iz;
                    gout8y += ai2 * gy[832] * Ix * Iz;
                    gout8z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[1344];
                    Iz = gz[0];
                    gout9x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout9y += ai2 * gy[1408] * Ix * Iz;
                    gout9z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1216];
                    Iz = gz[192];
                    gout10x += ai2 * gx[64] * Iy * Iz;
                    gout10y += (ai2 * gy[1280] - 1 * gy[1152]) * Ix * Iz;
                    gout10z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[768];
                    Iz = gz[448];
                    gout11x += ai2 * gx[256] * Iy * Iz;
                    gout11y += ai2 * gy[832] * Ix * Iz;
                    gout11z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[768];
                    Iz = gz[576];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += ai2 * gy[832] * Ix * Iz;
                    gout12z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[64];
                    Iz = gz[768];
                    gout13x += ai2 * gx[640] * Iy * Iz;
                    gout13y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout13z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[192];
                    Iz = gz[832];
                    gout14x += ai2 * gx[448] * Iy * Iz;
                    gout14y += ai2 * gy[256] * Ix * Iz;
                    gout14z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[384];
                    Iz = gz[768];
                    gout15x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout15y += ai2 * gy[448] * Ix * Iz;
                    gout15z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[640];
                    Iz = gz[768];
                    gout16x += ai2 * gx[64] * Iy * Iz;
                    gout16y += (ai2 * gy[704] - 1 * gy[576]) * Ix * Iz;
                    gout16z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[384];
                    Iz = gz[1024];
                    gout17x += ai2 * gx[64] * Iy * Iz;
                    gout17y += ai2 * gy[448] * Ix * Iz;
                    gout17z += (ai2 * gz[1088] - 1 * gz[960]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[192];
                    Iz = gz[1152];
                    gout18x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout18y += ai2 * gy[256] * Ix * Iz;
                    gout18z += ai2 * gz[1216] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[64];
                    Iz = gz[1344];
                    gout19x += ai2 * gx[64] * Iy * Iz;
                    gout19y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout19z += ai2 * gz[1408] * Ix * Iy;
                    break;
                    }
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+1)*nao+(k0+1)];
                fy += gout9y * dm[(l0+1)*nao+(k0+1)];
                fz += gout9z * dm[(l0+1)*nao+(k0+1)];
                fx += gout18x * dm[(l0+2)*nao+(k0+2)];
                fy += gout18y * dm[(l0+2)*nao+(k0+2)];
                fz += gout18z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+1)];
                fy = gout3y * dm[(l0+0)*nao+(k0+1)];
                fz = gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout12x * dm[(l0+1)*nao+(k0+2)];
                fy += gout12y * dm[(l0+1)*nao+(k0+2)];
                fz += gout12z * dm[(l0+1)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+2)];
                fy = gout6y * dm[(l0+0)*nao+(k0+2)];
                fz = gout6z * dm[(l0+0)*nao+(k0+2)];
                fx += gout15x * dm[(l0+2)*nao+(k0+0)];
                fy += gout15y * dm[(l0+2)*nao+(k0+0)];
                fz += gout15z * dm[(l0+2)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout7x * dm[(l0+1)*nao+(k0+0)];
                fy = gout7y * dm[(l0+1)*nao+(k0+0)];
                fz = gout7z * dm[(l0+1)*nao+(k0+0)];
                fx += gout16x * dm[(l0+2)*nao+(k0+1)];
                fy += gout16y * dm[(l0+2)*nao+(k0+1)];
                fz += gout16z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+1)*nao+(k0+1)];
                fy += gout10y * dm[(l0+1)*nao+(k0+1)];
                fz += gout10z * dm[(l0+1)*nao+(k0+1)];
                fx += gout19x * dm[(l0+2)*nao+(k0+2)];
                fy += gout19y * dm[(l0+2)*nao+(k0+2)];
                fz += gout19z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+1)];
                fy = gout4y * dm[(l0+0)*nao+(k0+1)];
                fz = gout4z * dm[(l0+0)*nao+(k0+1)];
                fx += gout13x * dm[(l0+1)*nao+(k0+2)];
                fy += gout13y * dm[(l0+1)*nao+(k0+2)];
                fz += gout13z * dm[(l0+1)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+2)];
                fy = gout5y * dm[(l0+0)*nao+(k0+2)];
                fz = gout5z * dm[(l0+0)*nao+(k0+2)];
                fx += gout14x * dm[(l0+2)*nao+(k0+0)];
                fy += gout14y * dm[(l0+2)*nao+(k0+0)];
                fz += gout14z * dm[(l0+2)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout8x * dm[(l0+1)*nao+(k0+0)];
                fy = gout8y * dm[(l0+1)*nao+(k0+0)];
                fz = gout8z * dm[(l0+1)*nao+(k0+0)];
                fx += gout17x * dm[(l0+2)*nao+(k0+1)];
                fy += gout17y * dm[(l0+2)*nao+(k0+1)];
                fz += gout17z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+1)*nao+(k0+1)];
                fy += gout11y * dm[(l0+1)*nao+(k0+1)];
                fz += gout11z * dm[(l0+1)*nao+(k0+1)];
                fx += gout20x * dm[(l0+2)*nao+(k0+2)];
                fy += gout20y * dm[(l0+2)*nao+(k0+2)];
                fz += gout20z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+1)*nao+(i0+1)];
                fy += gout1y * dm[(j0+1)*nao+(i0+1)];
                fz += gout1z * dm[(j0+1)*nao+(i0+1)];
                fx += gout2x * dm[(j0+2)*nao+(i0+2)];
                fy += gout2y * dm[(j0+2)*nao+(i0+2)];
                fz += gout2z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+1)*nao+(i0+0)];
                fy = gout3y * dm[(j0+1)*nao+(i0+0)];
                fz = gout3z * dm[(j0+1)*nao+(i0+0)];
                fx += gout4x * dm[(j0+2)*nao+(i0+1)];
                fy += gout4y * dm[(j0+2)*nao+(i0+1)];
                fz += gout4z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+2)];
                fy = gout5y * dm[(j0+0)*nao+(i0+2)];
                fz = gout5z * dm[(j0+0)*nao+(i0+2)];
                fx += gout6x * dm[(j0+2)*nao+(i0+0)];
                fy += gout6y * dm[(j0+2)*nao+(i0+0)];
                fz += gout6z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+1)];
                fy = gout7y * dm[(j0+0)*nao+(i0+1)];
                fz = gout7z * dm[(j0+0)*nao+(i0+1)];
                fx += gout8x * dm[(j0+1)*nao+(i0+2)];
                fy += gout8y * dm[(j0+1)*nao+(i0+2)];
                fz += gout8z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                fx += gout10x * dm[(j0+1)*nao+(i0+1)];
                fy += gout10y * dm[(j0+1)*nao+(i0+1)];
                fz += gout10z * dm[(j0+1)*nao+(i0+1)];
                fx += gout11x * dm[(j0+2)*nao+(i0+2)];
                fy += gout11y * dm[(j0+2)*nao+(i0+2)];
                fz += gout11z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout12x * dm[(j0+1)*nao+(i0+0)];
                fy = gout12y * dm[(j0+1)*nao+(i0+0)];
                fz = gout12z * dm[(j0+1)*nao+(i0+0)];
                fx += gout13x * dm[(j0+2)*nao+(i0+1)];
                fy += gout13y * dm[(j0+2)*nao+(i0+1)];
                fz += gout13z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout14x * dm[(j0+0)*nao+(i0+2)];
                fy = gout14y * dm[(j0+0)*nao+(i0+2)];
                fz = gout14z * dm[(j0+0)*nao+(i0+2)];
                fx += gout15x * dm[(j0+2)*nao+(i0+0)];
                fy += gout15y * dm[(j0+2)*nao+(i0+0)];
                fz += gout15z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout16x * dm[(j0+0)*nao+(i0+1)];
                fy = gout16y * dm[(j0+0)*nao+(i0+1)];
                fz = gout16z * dm[(j0+0)*nao+(i0+1)];
                fx += gout17x * dm[(j0+1)*nao+(i0+2)];
                fy += gout17y * dm[(j0+1)*nao+(i0+2)];
                fz += gout17z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout18x * dm[(j0+0)*nao+(i0+0)];
                fy = gout18y * dm[(j0+0)*nao+(i0+0)];
                fz = gout18z * dm[(j0+0)*nao+(i0+0)];
                fx += gout19x * dm[(j0+1)*nao+(i0+1)];
                fy += gout19y * dm[(j0+1)*nao+(i0+1)];
                fz += gout19z * dm[(j0+1)*nao+(i0+1)];
                fx += gout20x * dm[(j0+2)*nao+(i0+2)];
                fy += gout20y * dm[(j0+2)*nao+(i0+2)];
                fz += gout20z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                case 1:
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout11x * dm[(l0+1)*nao+(k0+2)];
                fy += gout11y * dm[(l0+1)*nao+(k0+2)];
                fz += gout11z * dm[(l0+1)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+2)];
                fy = gout5y * dm[(l0+0)*nao+(k0+2)];
                fz = gout5z * dm[(l0+0)*nao+(k0+2)];
                fx += gout14x * dm[(l0+2)*nao+(k0+0)];
                fy += gout14y * dm[(l0+2)*nao+(k0+0)];
                fz += gout14z * dm[(l0+2)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+1)*nao+(k0+0)];
                fy = gout8y * dm[(l0+1)*nao+(k0+0)];
                fz = gout8z * dm[(l0+1)*nao+(k0+0)];
                fx += gout17x * dm[(l0+2)*nao+(k0+1)];
                fy += gout17y * dm[(l0+2)*nao+(k0+1)];
                fz += gout17z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+1)*nao+(k0+1)];
                fy += gout9y * dm[(l0+1)*nao+(k0+1)];
                fz += gout9z * dm[(l0+1)*nao+(k0+1)];
                fx += gout18x * dm[(l0+2)*nao+(k0+2)];
                fy += gout18y * dm[(l0+2)*nao+(k0+2)];
                fz += gout18z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+1)];
                fy = gout3y * dm[(l0+0)*nao+(k0+1)];
                fz = gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout12x * dm[(l0+1)*nao+(k0+2)];
                fy += gout12y * dm[(l0+1)*nao+(k0+2)];
                fz += gout12z * dm[(l0+1)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+2)];
                fy = gout6y * dm[(l0+0)*nao+(k0+2)];
                fz = gout6z * dm[(l0+0)*nao+(k0+2)];
                fx += gout15x * dm[(l0+2)*nao+(k0+0)];
                fy += gout15y * dm[(l0+2)*nao+(k0+0)];
                fz += gout15z * dm[(l0+2)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout7x * dm[(l0+1)*nao+(k0+0)];
                fy = gout7y * dm[(l0+1)*nao+(k0+0)];
                fz = gout7z * dm[(l0+1)*nao+(k0+0)];
                fx += gout16x * dm[(l0+2)*nao+(k0+1)];
                fy += gout16y * dm[(l0+2)*nao+(k0+1)];
                fz += gout16z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+1)*nao+(k0+1)];
                fy += gout10y * dm[(l0+1)*nao+(k0+1)];
                fz += gout10z * dm[(l0+1)*nao+(k0+1)];
                fx += gout19x * dm[(l0+2)*nao+(k0+2)];
                fy += gout19y * dm[(l0+2)*nao+(k0+2)];
                fz += gout19z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+1)];
                fy = gout4y * dm[(l0+0)*nao+(k0+1)];
                fz = gout4z * dm[(l0+0)*nao+(k0+1)];
                fx += gout13x * dm[(l0+1)*nao+(k0+2)];
                fy += gout13y * dm[(l0+1)*nao+(k0+2)];
                fz += gout13z * dm[(l0+1)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+1)];
                fy = gout0y * dm[(j0+0)*nao+(i0+1)];
                fz = gout0z * dm[(j0+0)*nao+(i0+1)];
                fx += gout1x * dm[(j0+1)*nao+(i0+2)];
                fy += gout1y * dm[(j0+1)*nao+(i0+2)];
                fz += gout1z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+0)];
                fy = gout2y * dm[(j0+0)*nao+(i0+0)];
                fz = gout2z * dm[(j0+0)*nao+(i0+0)];
                fx += gout3x * dm[(j0+1)*nao+(i0+1)];
                fy += gout3y * dm[(j0+1)*nao+(i0+1)];
                fz += gout3z * dm[(j0+1)*nao+(i0+1)];
                fx += gout4x * dm[(j0+2)*nao+(i0+2)];
                fy += gout4y * dm[(j0+2)*nao+(i0+2)];
                fz += gout4z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+1)*nao+(i0+0)];
                fy = gout5y * dm[(j0+1)*nao+(i0+0)];
                fz = gout5z * dm[(j0+1)*nao+(i0+0)];
                fx += gout6x * dm[(j0+2)*nao+(i0+1)];
                fy += gout6y * dm[(j0+2)*nao+(i0+1)];
                fz += gout6z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+2)];
                fy = gout7y * dm[(j0+0)*nao+(i0+2)];
                fz = gout7z * dm[(j0+0)*nao+(i0+2)];
                fx += gout8x * dm[(j0+2)*nao+(i0+0)];
                fy += gout8y * dm[(j0+2)*nao+(i0+0)];
                fz += gout8z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+1)];
                fy = gout9y * dm[(j0+0)*nao+(i0+1)];
                fz = gout9z * dm[(j0+0)*nao+(i0+1)];
                fx += gout10x * dm[(j0+1)*nao+(i0+2)];
                fy += gout10y * dm[(j0+1)*nao+(i0+2)];
                fz += gout10z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+0)];
                fy = gout11y * dm[(j0+0)*nao+(i0+0)];
                fz = gout11z * dm[(j0+0)*nao+(i0+0)];
                fx += gout12x * dm[(j0+1)*nao+(i0+1)];
                fy += gout12y * dm[(j0+1)*nao+(i0+1)];
                fz += gout12z * dm[(j0+1)*nao+(i0+1)];
                fx += gout13x * dm[(j0+2)*nao+(i0+2)];
                fy += gout13y * dm[(j0+2)*nao+(i0+2)];
                fz += gout13z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout14x * dm[(j0+1)*nao+(i0+0)];
                fy = gout14y * dm[(j0+1)*nao+(i0+0)];
                fz = gout14z * dm[(j0+1)*nao+(i0+0)];
                fx += gout15x * dm[(j0+2)*nao+(i0+1)];
                fy += gout15y * dm[(j0+2)*nao+(i0+1)];
                fz += gout15z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout16x * dm[(j0+0)*nao+(i0+2)];
                fy = gout16y * dm[(j0+0)*nao+(i0+2)];
                fz = gout16z * dm[(j0+0)*nao+(i0+2)];
                fx += gout17x * dm[(j0+2)*nao+(i0+0)];
                fy += gout17y * dm[(j0+2)*nao+(i0+0)];
                fz += gout17z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout18x * dm[(j0+0)*nao+(i0+1)];
                fy = gout18y * dm[(j0+0)*nao+(i0+1)];
                fz = gout18z * dm[(j0+0)*nao+(i0+1)];
                fx += gout19x * dm[(j0+1)*nao+(i0+2)];
                fy += gout19y * dm[(j0+1)*nao+(i0+2)];
                fz += gout19z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                case 2:
                fx = gout4x * dm[(l0+0)*nao+(k0+2)];
                fy = gout4y * dm[(l0+0)*nao+(k0+2)];
                fz = gout4z * dm[(l0+0)*nao+(k0+2)];
                fx += gout13x * dm[(l0+2)*nao+(k0+0)];
                fy += gout13y * dm[(l0+2)*nao+(k0+0)];
                fz += gout13z * dm[(l0+2)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout7x * dm[(l0+1)*nao+(k0+0)];
                fy = gout7y * dm[(l0+1)*nao+(k0+0)];
                fz = gout7z * dm[(l0+1)*nao+(k0+0)];
                fx += gout16x * dm[(l0+2)*nao+(k0+1)];
                fy += gout16y * dm[(l0+2)*nao+(k0+1)];
                fz += gout16z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+1)*nao+(k0+1)];
                fy += gout10y * dm[(l0+1)*nao+(k0+1)];
                fz += gout10z * dm[(l0+1)*nao+(k0+1)];
                fx += gout19x * dm[(l0+2)*nao+(k0+2)];
                fy += gout19y * dm[(l0+2)*nao+(k0+2)];
                fz += gout19z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout11x * dm[(l0+1)*nao+(k0+2)];
                fy += gout11y * dm[(l0+1)*nao+(k0+2)];
                fz += gout11z * dm[(l0+1)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+2)];
                fy = gout5y * dm[(l0+0)*nao+(k0+2)];
                fz = gout5z * dm[(l0+0)*nao+(k0+2)];
                fx += gout14x * dm[(l0+2)*nao+(k0+0)];
                fy += gout14y * dm[(l0+2)*nao+(k0+0)];
                fz += gout14z * dm[(l0+2)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+1)*nao+(k0+0)];
                fy = gout8y * dm[(l0+1)*nao+(k0+0)];
                fz = gout8z * dm[(l0+1)*nao+(k0+0)];
                fx += gout17x * dm[(l0+2)*nao+(k0+1)];
                fy += gout17y * dm[(l0+2)*nao+(k0+1)];
                fz += gout17z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+1)*nao+(k0+1)];
                fy += gout9y * dm[(l0+1)*nao+(k0+1)];
                fz += gout9z * dm[(l0+1)*nao+(k0+1)];
                fx += gout18x * dm[(l0+2)*nao+(k0+2)];
                fy += gout18y * dm[(l0+2)*nao+(k0+2)];
                fz += gout18z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+1)];
                fy = gout3y * dm[(l0+0)*nao+(k0+1)];
                fz = gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout12x * dm[(l0+1)*nao+(k0+2)];
                fy += gout12y * dm[(l0+1)*nao+(k0+2)];
                fz += gout12z * dm[(l0+1)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+2)];
                fy = gout6y * dm[(l0+0)*nao+(k0+2)];
                fz = gout6z * dm[(l0+0)*nao+(k0+2)];
                fx += gout15x * dm[(l0+2)*nao+(k0+0)];
                fy += gout15y * dm[(l0+2)*nao+(k0+0)];
                fz += gout15z * dm[(l0+2)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+2)];
                fy = gout0y * dm[(j0+0)*nao+(i0+2)];
                fz = gout0z * dm[(j0+0)*nao+(i0+2)];
                fx += gout1x * dm[(j0+2)*nao+(i0+0)];
                fy += gout1y * dm[(j0+2)*nao+(i0+0)];
                fz += gout1z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+1)];
                fy = gout2y * dm[(j0+0)*nao+(i0+1)];
                fz = gout2z * dm[(j0+0)*nao+(i0+1)];
                fx += gout3x * dm[(j0+1)*nao+(i0+2)];
                fy += gout3y * dm[(j0+1)*nao+(i0+2)];
                fz += gout3z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                fx += gout5x * dm[(j0+1)*nao+(i0+1)];
                fy += gout5y * dm[(j0+1)*nao+(i0+1)];
                fz += gout5z * dm[(j0+1)*nao+(i0+1)];
                fx += gout6x * dm[(j0+2)*nao+(i0+2)];
                fy += gout6y * dm[(j0+2)*nao+(i0+2)];
                fz += gout6z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+1)*nao+(i0+0)];
                fy = gout7y * dm[(j0+1)*nao+(i0+0)];
                fz = gout7z * dm[(j0+1)*nao+(i0+0)];
                fx += gout8x * dm[(j0+2)*nao+(i0+1)];
                fy += gout8y * dm[(j0+2)*nao+(i0+1)];
                fz += gout8z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+2)];
                fy = gout9y * dm[(j0+0)*nao+(i0+2)];
                fz = gout9z * dm[(j0+0)*nao+(i0+2)];
                fx += gout10x * dm[(j0+2)*nao+(i0+0)];
                fy += gout10y * dm[(j0+2)*nao+(i0+0)];
                fz += gout10z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+1)];
                fy = gout11y * dm[(j0+0)*nao+(i0+1)];
                fz = gout11z * dm[(j0+0)*nao+(i0+1)];
                fx += gout12x * dm[(j0+1)*nao+(i0+2)];
                fy += gout12y * dm[(j0+1)*nao+(i0+2)];
                fz += gout12z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout13x * dm[(j0+0)*nao+(i0+0)];
                fy = gout13y * dm[(j0+0)*nao+(i0+0)];
                fz = gout13z * dm[(j0+0)*nao+(i0+0)];
                fx += gout14x * dm[(j0+1)*nao+(i0+1)];
                fy += gout14y * dm[(j0+1)*nao+(i0+1)];
                fz += gout14z * dm[(j0+1)*nao+(i0+1)];
                fx += gout15x * dm[(j0+2)*nao+(i0+2)];
                fy += gout15y * dm[(j0+2)*nao+(i0+2)];
                fz += gout15z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout16x * dm[(j0+1)*nao+(i0+0)];
                fy = gout16y * dm[(j0+1)*nao+(i0+0)];
                fz = gout16z * dm[(j0+1)*nao+(i0+0)];
                fx += gout17x * dm[(j0+2)*nao+(i0+1)];
                fy += gout17y * dm[(j0+2)*nao+(i0+1)];
                fz += gout17z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout18x * dm[(j0+0)*nao+(i0+2)];
                fy = gout18y * dm[(j0+0)*nao+(i0+2)];
                fz = gout18z * dm[(j0+0)*nao+(i0+2)];
                fx += gout19x * dm[(j0+2)*nao+(i0+0)];
                fy += gout19y * dm[(j0+2)*nao+(i0+0)];
                fz += gout19z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                case 3:
                fx = gout6x * dm[(l0+1)*nao+(k0+0)];
                fy = gout6y * dm[(l0+1)*nao+(k0+0)];
                fz = gout6z * dm[(l0+1)*nao+(k0+0)];
                fx += gout15x * dm[(l0+2)*nao+(k0+1)];
                fy += gout15y * dm[(l0+2)*nao+(k0+1)];
                fz += gout15z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+1)*nao+(k0+1)];
                fy += gout9y * dm[(l0+1)*nao+(k0+1)];
                fz += gout9z * dm[(l0+1)*nao+(k0+1)];
                fx += gout18x * dm[(l0+2)*nao+(k0+2)];
                fy += gout18y * dm[(l0+2)*nao+(k0+2)];
                fz += gout18z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+1)];
                fy = gout3y * dm[(l0+0)*nao+(k0+1)];
                fz = gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout12x * dm[(l0+1)*nao+(k0+2)];
                fy += gout12y * dm[(l0+1)*nao+(k0+2)];
                fz += gout12z * dm[(l0+1)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+2)];
                fy = gout4y * dm[(l0+0)*nao+(k0+2)];
                fz = gout4z * dm[(l0+0)*nao+(k0+2)];
                fx += gout13x * dm[(l0+2)*nao+(k0+0)];
                fy += gout13y * dm[(l0+2)*nao+(k0+0)];
                fz += gout13z * dm[(l0+2)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout7x * dm[(l0+1)*nao+(k0+0)];
                fy = gout7y * dm[(l0+1)*nao+(k0+0)];
                fz = gout7z * dm[(l0+1)*nao+(k0+0)];
                fx += gout16x * dm[(l0+2)*nao+(k0+1)];
                fy += gout16y * dm[(l0+2)*nao+(k0+1)];
                fz += gout16z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+1)*nao+(k0+1)];
                fy += gout10y * dm[(l0+1)*nao+(k0+1)];
                fz += gout10z * dm[(l0+1)*nao+(k0+1)];
                fx += gout19x * dm[(l0+2)*nao+(k0+2)];
                fy += gout19y * dm[(l0+2)*nao+(k0+2)];
                fz += gout19z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout11x * dm[(l0+1)*nao+(k0+2)];
                fy += gout11y * dm[(l0+1)*nao+(k0+2)];
                fz += gout11z * dm[(l0+1)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+2)];
                fy = gout5y * dm[(l0+0)*nao+(k0+2)];
                fz = gout5z * dm[(l0+0)*nao+(k0+2)];
                fx += gout14x * dm[(l0+2)*nao+(k0+0)];
                fy += gout14y * dm[(l0+2)*nao+(k0+0)];
                fz += gout14z * dm[(l0+2)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+1)*nao+(k0+0)];
                fy = gout8y * dm[(l0+1)*nao+(k0+0)];
                fz = gout8z * dm[(l0+1)*nao+(k0+0)];
                fx += gout17x * dm[(l0+2)*nao+(k0+1)];
                fy += gout17y * dm[(l0+2)*nao+(k0+1)];
                fz += gout17z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+1)*nao+(i0+0)];
                fy = gout0y * dm[(j0+1)*nao+(i0+0)];
                fz = gout0z * dm[(j0+1)*nao+(i0+0)];
                fx += gout1x * dm[(j0+2)*nao+(i0+1)];
                fy += gout1y * dm[(j0+2)*nao+(i0+1)];
                fz += gout1z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+2)];
                fy = gout2y * dm[(j0+0)*nao+(i0+2)];
                fz = gout2z * dm[(j0+0)*nao+(i0+2)];
                fx += gout3x * dm[(j0+2)*nao+(i0+0)];
                fy += gout3y * dm[(j0+2)*nao+(i0+0)];
                fz += gout3z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+1)];
                fy = gout4y * dm[(j0+0)*nao+(i0+1)];
                fz = gout4z * dm[(j0+0)*nao+(i0+1)];
                fx += gout5x * dm[(j0+1)*nao+(i0+2)];
                fy += gout5y * dm[(j0+1)*nao+(i0+2)];
                fz += gout5z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+1)*nao+(i0+1)];
                fy += gout7y * dm[(j0+1)*nao+(i0+1)];
                fz += gout7z * dm[(j0+1)*nao+(i0+1)];
                fx += gout8x * dm[(j0+2)*nao+(i0+2)];
                fy += gout8y * dm[(j0+2)*nao+(i0+2)];
                fz += gout8z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+1)*nao+(i0+0)];
                fy = gout9y * dm[(j0+1)*nao+(i0+0)];
                fz = gout9z * dm[(j0+1)*nao+(i0+0)];
                fx += gout10x * dm[(j0+2)*nao+(i0+1)];
                fy += gout10y * dm[(j0+2)*nao+(i0+1)];
                fz += gout10z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+2)];
                fy = gout11y * dm[(j0+0)*nao+(i0+2)];
                fz = gout11z * dm[(j0+0)*nao+(i0+2)];
                fx += gout12x * dm[(j0+2)*nao+(i0+0)];
                fy += gout12y * dm[(j0+2)*nao+(i0+0)];
                fz += gout12z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout13x * dm[(j0+0)*nao+(i0+1)];
                fy = gout13y * dm[(j0+0)*nao+(i0+1)];
                fz = gout13z * dm[(j0+0)*nao+(i0+1)];
                fx += gout14x * dm[(j0+1)*nao+(i0+2)];
                fy += gout14y * dm[(j0+1)*nao+(i0+2)];
                fz += gout14z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout15x * dm[(j0+0)*nao+(i0+0)];
                fy = gout15y * dm[(j0+0)*nao+(i0+0)];
                fz = gout15z * dm[(j0+0)*nao+(i0+0)];
                fx += gout16x * dm[(j0+1)*nao+(i0+1)];
                fy += gout16y * dm[(j0+1)*nao+(i0+1)];
                fz += gout16z * dm[(j0+1)*nao+(i0+1)];
                fx += gout17x * dm[(j0+2)*nao+(i0+2)];
                fy += gout17y * dm[(j0+2)*nao+(i0+2)];
                fz += gout17z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout18x * dm[(j0+1)*nao+(i0+0)];
                fy = gout18y * dm[(j0+1)*nao+(i0+0)];
                fz = gout18z * dm[(j0+1)*nao+(i0+0)];
                fx += gout19x * dm[(j0+2)*nao+(i0+1)];
                fy += gout19y * dm[(j0+2)*nao+(i0+1)];
                fz += gout19z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                }
            }
            if (do_k) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+1)*nao+(k0+1)];
                fy += gout3y * dm[(j0+1)*nao+(k0+1)];
                fz += gout3z * dm[(j0+1)*nao+(k0+1)];
                fx += gout6x * dm[(j0+2)*nao+(k0+2)];
                fy += gout6y * dm[(j0+2)*nao+(k0+2)];
                fz += gout6z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+1)];
                fy = gout9y * dm[(j0+0)*nao+(k0+1)];
                fz = gout9z * dm[(j0+0)*nao+(k0+1)];
                fx += gout12x * dm[(j0+1)*nao+(k0+2)];
                fy += gout12y * dm[(j0+1)*nao+(k0+2)];
                fz += gout12z * dm[(j0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout18x * dm[(j0+0)*nao+(k0+2)];
                fy = gout18y * dm[(j0+0)*nao+(k0+2)];
                fz = gout18z * dm[(j0+0)*nao+(k0+2)];
                fx += gout15x * dm[(j0+2)*nao+(k0+0)];
                fy += gout15y * dm[(j0+2)*nao+(k0+0)];
                fz += gout15z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout1x * dm[(j0+1)*nao+(k0+0)];
                fy = gout1y * dm[(j0+1)*nao+(k0+0)];
                fz = gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout4x * dm[(j0+2)*nao+(k0+1)];
                fy += gout4y * dm[(j0+2)*nao+(k0+1)];
                fz += gout4z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(k0+0)];
                fy = gout7y * dm[(j0+0)*nao+(k0+0)];
                fz = gout7z * dm[(j0+0)*nao+(k0+0)];
                fx += gout10x * dm[(j0+1)*nao+(k0+1)];
                fy += gout10y * dm[(j0+1)*nao+(k0+1)];
                fz += gout10z * dm[(j0+1)*nao+(k0+1)];
                fx += gout13x * dm[(j0+2)*nao+(k0+2)];
                fy += gout13y * dm[(j0+2)*nao+(k0+2)];
                fz += gout13z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+1), fz);
                fx = gout16x * dm[(j0+0)*nao+(k0+1)];
                fy = gout16y * dm[(j0+0)*nao+(k0+1)];
                fz = gout16z * dm[(j0+0)*nao+(k0+1)];
                fx += gout19x * dm[(j0+1)*nao+(k0+2)];
                fy += gout19y * dm[(j0+1)*nao+(k0+2)];
                fz += gout19z * dm[(j0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+2), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+2)];
                fy = gout5y * dm[(j0+0)*nao+(k0+2)];
                fz = gout5z * dm[(j0+0)*nao+(k0+2)];
                fx += gout2x * dm[(j0+2)*nao+(k0+0)];
                fy += gout2y * dm[(j0+2)*nao+(k0+0)];
                fz += gout2z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout8x * dm[(j0+1)*nao+(k0+0)];
                fy = gout8y * dm[(j0+1)*nao+(k0+0)];
                fz = gout8z * dm[(j0+1)*nao+(k0+0)];
                fx += gout11x * dm[(j0+2)*nao+(k0+1)];
                fy += gout11y * dm[(j0+2)*nao+(k0+1)];
                fz += gout11z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+1), fz);
                fx = gout14x * dm[(j0+0)*nao+(k0+0)];
                fy = gout14y * dm[(j0+0)*nao+(k0+0)];
                fz = gout14z * dm[(j0+0)*nao+(k0+0)];
                fx += gout17x * dm[(j0+1)*nao+(k0+1)];
                fy += gout17y * dm[(j0+1)*nao+(k0+1)];
                fz += gout17z * dm[(j0+1)*nao+(k0+1)];
                fx += gout20x * dm[(j0+2)*nao+(k0+2)];
                fy += gout20y * dm[(j0+2)*nao+(k0+2)];
                fz += gout20z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout5x * dm[(i0+2)*nao+(k0+2)];
                fy += gout5y * dm[(i0+2)*nao+(k0+2)];
                fz += gout5z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+1)];
                fy = gout9y * dm[(i0+0)*nao+(k0+1)];
                fz = gout9z * dm[(i0+0)*nao+(k0+1)];
                fx += gout7x * dm[(i0+1)*nao+(k0+0)];
                fy += gout7y * dm[(i0+1)*nao+(k0+0)];
                fz += gout7z * dm[(i0+1)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout18x * dm[(i0+0)*nao+(k0+2)];
                fy = gout18y * dm[(i0+0)*nao+(k0+2)];
                fz = gout18z * dm[(i0+0)*nao+(k0+2)];
                fx += gout16x * dm[(i0+1)*nao+(k0+1)];
                fy += gout16y * dm[(i0+1)*nao+(k0+1)];
                fz += gout16z * dm[(i0+1)*nao+(k0+1)];
                fx += gout14x * dm[(i0+2)*nao+(k0+0)];
                fy += gout14y * dm[(i0+2)*nao+(k0+0)];
                fz += gout14z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+1)];
                fy = gout3y * dm[(i0+0)*nao+(k0+1)];
                fz = gout3z * dm[(i0+0)*nao+(k0+1)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout12x * dm[(i0+0)*nao+(k0+2)];
                fy = gout12y * dm[(i0+0)*nao+(k0+2)];
                fz = gout12z * dm[(i0+0)*nao+(k0+2)];
                fx += gout10x * dm[(i0+1)*nao+(k0+1)];
                fy += gout10y * dm[(i0+1)*nao+(k0+1)];
                fz += gout10z * dm[(i0+1)*nao+(k0+1)];
                fx += gout8x * dm[(i0+2)*nao+(k0+0)];
                fy += gout8y * dm[(i0+2)*nao+(k0+0)];
                fz += gout8z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+1), fz);
                fx = gout19x * dm[(i0+1)*nao+(k0+2)];
                fy = gout19y * dm[(i0+1)*nao+(k0+2)];
                fz = gout19z * dm[(i0+1)*nao+(k0+2)];
                fx += gout17x * dm[(i0+2)*nao+(k0+1)];
                fy += gout17y * dm[(i0+2)*nao+(k0+1)];
                fz += gout17z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+2), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+2)];
                fy = gout6y * dm[(i0+0)*nao+(k0+2)];
                fz = gout6z * dm[(i0+0)*nao+(k0+2)];
                fx += gout4x * dm[(i0+1)*nao+(k0+1)];
                fy += gout4y * dm[(i0+1)*nao+(k0+1)];
                fz += gout4z * dm[(i0+1)*nao+(k0+1)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout13x * dm[(i0+1)*nao+(k0+2)];
                fy = gout13y * dm[(i0+1)*nao+(k0+2)];
                fz = gout13z * dm[(i0+1)*nao+(k0+2)];
                fx += gout11x * dm[(i0+2)*nao+(k0+1)];
                fy += gout11y * dm[(i0+2)*nao+(k0+1)];
                fz += gout11z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+1), fz);
                fx = gout15x * dm[(i0+0)*nao+(k0+0)];
                fy = gout15y * dm[(i0+0)*nao+(k0+0)];
                fz = gout15z * dm[(i0+0)*nao+(k0+0)];
                fx += gout20x * dm[(i0+2)*nao+(k0+2)];
                fy += gout20y * dm[(i0+2)*nao+(k0+2)];
                fz += gout20z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout15x * dm[(j0+2)*nao+(l0+2)];
                fy += gout15y * dm[(j0+2)*nao+(l0+2)];
                fz += gout15z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+1)];
                fy = gout9y * dm[(j0+0)*nao+(l0+1)];
                fz = gout9z * dm[(j0+0)*nao+(l0+1)];
                fx += gout3x * dm[(j0+1)*nao+(l0+0)];
                fy += gout3y * dm[(j0+1)*nao+(l0+0)];
                fz += gout3z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout18x * dm[(j0+0)*nao+(l0+2)];
                fy = gout18y * dm[(j0+0)*nao+(l0+2)];
                fz = gout18z * dm[(j0+0)*nao+(l0+2)];
                fx += gout12x * dm[(j0+1)*nao+(l0+1)];
                fy += gout12y * dm[(j0+1)*nao+(l0+1)];
                fz += gout12z * dm[(j0+1)*nao+(l0+1)];
                fx += gout6x * dm[(j0+2)*nao+(l0+0)];
                fy += gout6y * dm[(j0+2)*nao+(l0+0)];
                fz += gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                fx += gout1x * dm[(j0+1)*nao+(l0+0)];
                fy += gout1y * dm[(j0+1)*nao+(l0+0)];
                fz += gout1z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout16x * dm[(j0+0)*nao+(l0+2)];
                fy = gout16y * dm[(j0+0)*nao+(l0+2)];
                fz = gout16z * dm[(j0+0)*nao+(l0+2)];
                fx += gout10x * dm[(j0+1)*nao+(l0+1)];
                fy += gout10y * dm[(j0+1)*nao+(l0+1)];
                fz += gout10z * dm[(j0+1)*nao+(l0+1)];
                fx += gout4x * dm[(j0+2)*nao+(l0+0)];
                fy += gout4y * dm[(j0+2)*nao+(l0+0)];
                fz += gout4z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout19x * dm[(j0+1)*nao+(l0+2)];
                fy = gout19y * dm[(j0+1)*nao+(l0+2)];
                fz = gout19z * dm[(j0+1)*nao+(l0+2)];
                fx += gout13x * dm[(j0+2)*nao+(l0+1)];
                fy += gout13y * dm[(j0+2)*nao+(l0+1)];
                fz += gout13z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout14x * dm[(j0+0)*nao+(l0+2)];
                fy = gout14y * dm[(j0+0)*nao+(l0+2)];
                fz = gout14z * dm[(j0+0)*nao+(l0+2)];
                fx += gout8x * dm[(j0+1)*nao+(l0+1)];
                fy += gout8y * dm[(j0+1)*nao+(l0+1)];
                fz += gout8z * dm[(j0+1)*nao+(l0+1)];
                fx += gout2x * dm[(j0+2)*nao+(l0+0)];
                fy += gout2y * dm[(j0+2)*nao+(l0+0)];
                fz += gout2z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout17x * dm[(j0+1)*nao+(l0+2)];
                fy = gout17y * dm[(j0+1)*nao+(l0+2)];
                fz = gout17z * dm[(j0+1)*nao+(l0+2)];
                fx += gout11x * dm[(j0+2)*nao+(l0+1)];
                fy += gout11y * dm[(j0+2)*nao+(l0+1)];
                fz += gout11z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                fx += gout20x * dm[(j0+2)*nao+(l0+2)];
                fy += gout20y * dm[(j0+2)*nao+(l0+2)];
                fz += gout20z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+1)*nao+(l0+1)];
                fy += gout7y * dm[(i0+1)*nao+(l0+1)];
                fz += gout7z * dm[(i0+1)*nao+(l0+1)];
                fx += gout14x * dm[(i0+2)*nao+(l0+2)];
                fy += gout14y * dm[(i0+2)*nao+(l0+2)];
                fz += gout14z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+1)];
                fy = gout9y * dm[(i0+0)*nao+(l0+1)];
                fz = gout9z * dm[(i0+0)*nao+(l0+1)];
                fx += gout16x * dm[(i0+1)*nao+(l0+2)];
                fy += gout16y * dm[(i0+1)*nao+(l0+2)];
                fz += gout16z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout18x * dm[(i0+0)*nao+(l0+2)];
                fy = gout18y * dm[(i0+0)*nao+(l0+2)];
                fz = gout18z * dm[(i0+0)*nao+(l0+2)];
                fx += gout5x * dm[(i0+2)*nao+(l0+0)];
                fy += gout5y * dm[(i0+2)*nao+(l0+0)];
                fz += gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+2)*nao+(l0+1)];
                fy += gout8y * dm[(i0+2)*nao+(l0+1)];
                fz += gout8z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+1)*nao+(l0+1)];
                fy += gout10y * dm[(i0+1)*nao+(l0+1)];
                fz += gout10z * dm[(i0+1)*nao+(l0+1)];
                fx += gout17x * dm[(i0+2)*nao+(l0+2)];
                fy += gout17y * dm[(i0+2)*nao+(l0+2)];
                fz += gout17z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+1)];
                fy = gout12y * dm[(i0+0)*nao+(l0+1)];
                fz = gout12z * dm[(i0+0)*nao+(l0+1)];
                fx += gout19x * dm[(i0+1)*nao+(l0+2)];
                fy += gout19y * dm[(i0+1)*nao+(l0+2)];
                fz += gout19z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout15x * dm[(i0+0)*nao+(l0+2)];
                fy = gout15y * dm[(i0+0)*nao+(l0+2)];
                fz = gout15z * dm[(i0+0)*nao+(l0+2)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+0)];
                fy = gout4y * dm[(i0+1)*nao+(l0+0)];
                fz = gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout11x * dm[(i0+2)*nao+(l0+1)];
                fy += gout11y * dm[(i0+2)*nao+(l0+1)];
                fz += gout11z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+1)*nao+(l0+1)];
                fy += gout13y * dm[(i0+1)*nao+(l0+1)];
                fz += gout13z * dm[(i0+1)*nao+(l0+1)];
                fx += gout20x * dm[(i0+2)*nao+(l0+2)];
                fy += gout20y * dm[(i0+2)*nao+(l0+2)];
                fz += gout20z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                break;
                case 1:
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                fx += gout5x * dm[(j0+1)*nao+(k0+2)];
                fy += gout5y * dm[(j0+1)*nao+(k0+2)];
                fz += gout5z * dm[(j0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+2)];
                fy = gout11y * dm[(j0+0)*nao+(k0+2)];
                fz = gout11z * dm[(j0+0)*nao+(k0+2)];
                fx += gout8x * dm[(j0+2)*nao+(k0+0)];
                fy += gout8y * dm[(j0+2)*nao+(k0+0)];
                fz += gout8z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout14x * dm[(j0+1)*nao+(k0+0)];
                fy = gout14y * dm[(j0+1)*nao+(k0+0)];
                fz = gout14z * dm[(j0+1)*nao+(k0+0)];
                fx += gout17x * dm[(j0+2)*nao+(k0+1)];
                fy += gout17y * dm[(j0+2)*nao+(k0+1)];
                fz += gout17z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+1)*nao+(k0+1)];
                fy += gout3y * dm[(j0+1)*nao+(k0+1)];
                fz += gout3z * dm[(j0+1)*nao+(k0+1)];
                fx += gout6x * dm[(j0+2)*nao+(k0+2)];
                fy += gout6y * dm[(j0+2)*nao+(k0+2)];
                fz += gout6z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+1)];
                fy = gout9y * dm[(j0+0)*nao+(k0+1)];
                fz = gout9z * dm[(j0+0)*nao+(k0+1)];
                fx += gout12x * dm[(j0+1)*nao+(k0+2)];
                fy += gout12y * dm[(j0+1)*nao+(k0+2)];
                fz += gout12z * dm[(j0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+1), fz);
                fx = gout18x * dm[(j0+0)*nao+(k0+2)];
                fy = gout18y * dm[(j0+0)*nao+(k0+2)];
                fz = gout18z * dm[(j0+0)*nao+(k0+2)];
                fx += gout15x * dm[(j0+2)*nao+(k0+0)];
                fy += gout15y * dm[(j0+2)*nao+(k0+0)];
                fz += gout15z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+2), fz);
                fx = gout1x * dm[(j0+1)*nao+(k0+0)];
                fy = gout1y * dm[(j0+1)*nao+(k0+0)];
                fz = gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout4x * dm[(j0+2)*nao+(k0+1)];
                fy += gout4y * dm[(j0+2)*nao+(k0+1)];
                fz += gout4z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(k0+0)];
                fy = gout7y * dm[(j0+0)*nao+(k0+0)];
                fz = gout7z * dm[(j0+0)*nao+(k0+0)];
                fx += gout10x * dm[(j0+1)*nao+(k0+1)];
                fy += gout10y * dm[(j0+1)*nao+(k0+1)];
                fz += gout10z * dm[(j0+1)*nao+(k0+1)];
                fx += gout13x * dm[(j0+2)*nao+(k0+2)];
                fy += gout13y * dm[(j0+2)*nao+(k0+2)];
                fz += gout13z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+1), fz);
                fx = gout16x * dm[(j0+0)*nao+(k0+1)];
                fy = gout16y * dm[(j0+0)*nao+(k0+1)];
                fz = gout16z * dm[(j0+0)*nao+(k0+1)];
                fx += gout19x * dm[(j0+1)*nao+(k0+2)];
                fy += gout19y * dm[(j0+1)*nao+(k0+2)];
                fz += gout19z * dm[(j0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+2), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+1)];
                fy = gout2y * dm[(i0+0)*nao+(k0+1)];
                fz = gout2z * dm[(i0+0)*nao+(k0+1)];
                fx += gout0x * dm[(i0+1)*nao+(k0+0)];
                fy += gout0y * dm[(i0+1)*nao+(k0+0)];
                fz += gout0z * dm[(i0+1)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout11x * dm[(i0+0)*nao+(k0+2)];
                fy = gout11y * dm[(i0+0)*nao+(k0+2)];
                fz = gout11z * dm[(i0+0)*nao+(k0+2)];
                fx += gout9x * dm[(i0+1)*nao+(k0+1)];
                fy += gout9y * dm[(i0+1)*nao+(k0+1)];
                fz += gout9z * dm[(i0+1)*nao+(k0+1)];
                fx += gout7x * dm[(i0+2)*nao+(k0+0)];
                fy += gout7y * dm[(i0+2)*nao+(k0+0)];
                fz += gout7z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout18x * dm[(i0+1)*nao+(k0+2)];
                fy = gout18y * dm[(i0+1)*nao+(k0+2)];
                fz = gout18z * dm[(i0+1)*nao+(k0+2)];
                fx += gout16x * dm[(i0+2)*nao+(k0+1)];
                fy += gout16y * dm[(i0+2)*nao+(k0+1)];
                fz += gout16z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+2)];
                fy = gout5y * dm[(i0+0)*nao+(k0+2)];
                fz = gout5z * dm[(i0+0)*nao+(k0+2)];
                fx += gout3x * dm[(i0+1)*nao+(k0+1)];
                fy += gout3y * dm[(i0+1)*nao+(k0+1)];
                fz += gout3z * dm[(i0+1)*nao+(k0+1)];
                fx += gout1x * dm[(i0+2)*nao+(k0+0)];
                fy += gout1y * dm[(i0+2)*nao+(k0+0)];
                fz += gout1z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout12x * dm[(i0+1)*nao+(k0+2)];
                fy = gout12y * dm[(i0+1)*nao+(k0+2)];
                fz = gout12z * dm[(i0+1)*nao+(k0+2)];
                fx += gout10x * dm[(i0+2)*nao+(k0+1)];
                fy += gout10y * dm[(i0+2)*nao+(k0+1)];
                fz += gout10z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+1), fz);
                fx = gout14x * dm[(i0+0)*nao+(k0+0)];
                fy = gout14y * dm[(i0+0)*nao+(k0+0)];
                fz = gout14z * dm[(i0+0)*nao+(k0+0)];
                fx += gout19x * dm[(i0+2)*nao+(k0+2)];
                fy += gout19y * dm[(i0+2)*nao+(k0+2)];
                fz += gout19z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+2), fz);
                fx = gout6x * dm[(i0+1)*nao+(k0+2)];
                fy = gout6y * dm[(i0+1)*nao+(k0+2)];
                fz = gout6z * dm[(i0+1)*nao+(k0+2)];
                fx += gout4x * dm[(i0+2)*nao+(k0+1)];
                fy += gout4y * dm[(i0+2)*nao+(k0+1)];
                fz += gout4z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout8x * dm[(i0+0)*nao+(k0+0)];
                fy = gout8y * dm[(i0+0)*nao+(k0+0)];
                fz = gout8z * dm[(i0+0)*nao+(k0+0)];
                fx += gout13x * dm[(i0+2)*nao+(k0+2)];
                fy += gout13y * dm[(i0+2)*nao+(k0+2)];
                fz += gout13z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+1), fz);
                fx = gout17x * dm[(i0+0)*nao+(k0+1)];
                fy = gout17y * dm[(i0+0)*nao+(k0+1)];
                fz = gout17z * dm[(i0+0)*nao+(k0+1)];
                fx += gout15x * dm[(i0+1)*nao+(k0+0)];
                fy += gout15y * dm[(i0+1)*nao+(k0+0)];
                fz += gout15z * dm[(i0+1)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+2), fz);
                fx = gout14x * dm[(j0+1)*nao+(l0+2)];
                fy = gout14y * dm[(j0+1)*nao+(l0+2)];
                fz = gout14z * dm[(j0+1)*nao+(l0+2)];
                fx += gout8x * dm[(j0+2)*nao+(l0+1)];
                fy += gout8y * dm[(j0+2)*nao+(l0+1)];
                fz += gout8z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout17x * dm[(j0+2)*nao+(l0+2)];
                fy += gout17y * dm[(j0+2)*nao+(l0+2)];
                fz += gout17z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(l0+1)];
                fy = gout11y * dm[(j0+0)*nao+(l0+1)];
                fz = gout11z * dm[(j0+0)*nao+(l0+1)];
                fx += gout5x * dm[(j0+1)*nao+(l0+0)];
                fy += gout5y * dm[(j0+1)*nao+(l0+0)];
                fz += gout5z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout15x * dm[(j0+2)*nao+(l0+2)];
                fy += gout15y * dm[(j0+2)*nao+(l0+2)];
                fz += gout15z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+1)];
                fy = gout9y * dm[(j0+0)*nao+(l0+1)];
                fz = gout9z * dm[(j0+0)*nao+(l0+1)];
                fx += gout3x * dm[(j0+1)*nao+(l0+0)];
                fy += gout3y * dm[(j0+1)*nao+(l0+0)];
                fz += gout3z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout18x * dm[(j0+0)*nao+(l0+2)];
                fy = gout18y * dm[(j0+0)*nao+(l0+2)];
                fz = gout18z * dm[(j0+0)*nao+(l0+2)];
                fx += gout12x * dm[(j0+1)*nao+(l0+1)];
                fy += gout12y * dm[(j0+1)*nao+(l0+1)];
                fz += gout12z * dm[(j0+1)*nao+(l0+1)];
                fx += gout6x * dm[(j0+2)*nao+(l0+0)];
                fy += gout6y * dm[(j0+2)*nao+(l0+0)];
                fz += gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                fx += gout1x * dm[(j0+1)*nao+(l0+0)];
                fy += gout1y * dm[(j0+1)*nao+(l0+0)];
                fz += gout1z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout16x * dm[(j0+0)*nao+(l0+2)];
                fy = gout16y * dm[(j0+0)*nao+(l0+2)];
                fz = gout16z * dm[(j0+0)*nao+(l0+2)];
                fx += gout10x * dm[(j0+1)*nao+(l0+1)];
                fy += gout10y * dm[(j0+1)*nao+(l0+1)];
                fz += gout10z * dm[(j0+1)*nao+(l0+1)];
                fx += gout4x * dm[(j0+2)*nao+(l0+0)];
                fy += gout4y * dm[(j0+2)*nao+(l0+0)];
                fz += gout4z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout19x * dm[(j0+1)*nao+(l0+2)];
                fy = gout19y * dm[(j0+1)*nao+(l0+2)];
                fz = gout19z * dm[(j0+1)*nao+(l0+2)];
                fx += gout13x * dm[(j0+2)*nao+(l0+1)];
                fy += gout13y * dm[(j0+2)*nao+(l0+1)];
                fz += gout13z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+1)*nao+(l0+0)];
                fy = gout0y * dm[(i0+1)*nao+(l0+0)];
                fz = gout0z * dm[(i0+1)*nao+(l0+0)];
                fx += gout7x * dm[(i0+2)*nao+(l0+1)];
                fy += gout7y * dm[(i0+2)*nao+(l0+1)];
                fz += gout7z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+1)*nao+(l0+1)];
                fy += gout9y * dm[(i0+1)*nao+(l0+1)];
                fz += gout9z * dm[(i0+1)*nao+(l0+1)];
                fx += gout16x * dm[(i0+2)*nao+(l0+2)];
                fy += gout16y * dm[(i0+2)*nao+(l0+2)];
                fz += gout16z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout11x * dm[(i0+0)*nao+(l0+1)];
                fy = gout11y * dm[(i0+0)*nao+(l0+1)];
                fz = gout11z * dm[(i0+0)*nao+(l0+1)];
                fx += gout18x * dm[(i0+1)*nao+(l0+2)];
                fy += gout18y * dm[(i0+1)*nao+(l0+2)];
                fz += gout18z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout14x * dm[(i0+0)*nao+(l0+2)];
                fy = gout14y * dm[(i0+0)*nao+(l0+2)];
                fz = gout14z * dm[(i0+0)*nao+(l0+2)];
                fx += gout1x * dm[(i0+2)*nao+(l0+0)];
                fy += gout1y * dm[(i0+2)*nao+(l0+0)];
                fz += gout1z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+1)*nao+(l0+0)];
                fy = gout3y * dm[(i0+1)*nao+(l0+0)];
                fz = gout3z * dm[(i0+1)*nao+(l0+0)];
                fx += gout10x * dm[(i0+2)*nao+(l0+1)];
                fy += gout10y * dm[(i0+2)*nao+(l0+1)];
                fz += gout10z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+1)*nao+(l0+1)];
                fy += gout12y * dm[(i0+1)*nao+(l0+1)];
                fz += gout12z * dm[(i0+1)*nao+(l0+1)];
                fx += gout19x * dm[(i0+2)*nao+(l0+2)];
                fy += gout19y * dm[(i0+2)*nao+(l0+2)];
                fz += gout19z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+1)];
                fy = gout8y * dm[(i0+0)*nao+(l0+1)];
                fz = gout8z * dm[(i0+0)*nao+(l0+1)];
                fx += gout15x * dm[(i0+1)*nao+(l0+2)];
                fy += gout15y * dm[(i0+1)*nao+(l0+2)];
                fz += gout15z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout17x * dm[(i0+0)*nao+(l0+2)];
                fy = gout17y * dm[(i0+0)*nao+(l0+2)];
                fz = gout17z * dm[(i0+0)*nao+(l0+2)];
                fx += gout4x * dm[(i0+2)*nao+(l0+0)];
                fy += gout4y * dm[(i0+2)*nao+(l0+0)];
                fz += gout4z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+1)*nao+(l0+0)];
                fy = gout6y * dm[(i0+1)*nao+(l0+0)];
                fz = gout6z * dm[(i0+1)*nao+(l0+0)];
                fx += gout13x * dm[(i0+2)*nao+(l0+1)];
                fy += gout13y * dm[(i0+2)*nao+(l0+1)];
                fz += gout13z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                break;
                case 2:
                fx = gout4x * dm[(j0+0)*nao+(k0+2)];
                fy = gout4y * dm[(j0+0)*nao+(k0+2)];
                fz = gout4z * dm[(j0+0)*nao+(k0+2)];
                fx += gout1x * dm[(j0+2)*nao+(k0+0)];
                fy += gout1y * dm[(j0+2)*nao+(k0+0)];
                fz += gout1z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+1)*nao+(k0+0)];
                fy = gout7y * dm[(j0+1)*nao+(k0+0)];
                fz = gout7z * dm[(j0+1)*nao+(k0+0)];
                fx += gout10x * dm[(j0+2)*nao+(k0+1)];
                fy += gout10y * dm[(j0+2)*nao+(k0+1)];
                fz += gout10z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout13x * dm[(j0+0)*nao+(k0+0)];
                fy = gout13y * dm[(j0+0)*nao+(k0+0)];
                fz = gout13z * dm[(j0+0)*nao+(k0+0)];
                fx += gout16x * dm[(j0+1)*nao+(k0+1)];
                fy += gout16y * dm[(j0+1)*nao+(k0+1)];
                fz += gout16z * dm[(j0+1)*nao+(k0+1)];
                fx += gout19x * dm[(j0+2)*nao+(k0+2)];
                fy += gout19y * dm[(j0+2)*nao+(k0+2)];
                fz += gout19z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                fx += gout5x * dm[(j0+1)*nao+(k0+2)];
                fy += gout5y * dm[(j0+1)*nao+(k0+2)];
                fz += gout5z * dm[(j0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+2)];
                fy = gout11y * dm[(j0+0)*nao+(k0+2)];
                fz = gout11z * dm[(j0+0)*nao+(k0+2)];
                fx += gout8x * dm[(j0+2)*nao+(k0+0)];
                fy += gout8y * dm[(j0+2)*nao+(k0+0)];
                fz += gout8z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+1), fz);
                fx = gout14x * dm[(j0+1)*nao+(k0+0)];
                fy = gout14y * dm[(j0+1)*nao+(k0+0)];
                fz = gout14z * dm[(j0+1)*nao+(k0+0)];
                fx += gout17x * dm[(j0+2)*nao+(k0+1)];
                fy += gout17y * dm[(j0+2)*nao+(k0+1)];
                fz += gout17z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+1)*nao+(k0+1)];
                fy += gout3y * dm[(j0+1)*nao+(k0+1)];
                fz += gout3z * dm[(j0+1)*nao+(k0+1)];
                fx += gout6x * dm[(j0+2)*nao+(k0+2)];
                fy += gout6y * dm[(j0+2)*nao+(k0+2)];
                fz += gout6z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+1)];
                fy = gout9y * dm[(j0+0)*nao+(k0+1)];
                fz = gout9z * dm[(j0+0)*nao+(k0+1)];
                fx += gout12x * dm[(j0+1)*nao+(k0+2)];
                fy += gout12y * dm[(j0+1)*nao+(k0+2)];
                fz += gout12z * dm[(j0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+1), fz);
                fx = gout18x * dm[(j0+0)*nao+(k0+2)];
                fy = gout18y * dm[(j0+0)*nao+(k0+2)];
                fz = gout18z * dm[(j0+0)*nao+(k0+2)];
                fx += gout15x * dm[(j0+2)*nao+(k0+0)];
                fy += gout15y * dm[(j0+2)*nao+(k0+0)];
                fz += gout15z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+2), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+2)];
                fy = gout4y * dm[(i0+0)*nao+(k0+2)];
                fz = gout4z * dm[(i0+0)*nao+(k0+2)];
                fx += gout2x * dm[(i0+1)*nao+(k0+1)];
                fy += gout2y * dm[(i0+1)*nao+(k0+1)];
                fz += gout2z * dm[(i0+1)*nao+(k0+1)];
                fx += gout0x * dm[(i0+2)*nao+(k0+0)];
                fy += gout0y * dm[(i0+2)*nao+(k0+0)];
                fz += gout0z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout11x * dm[(i0+1)*nao+(k0+2)];
                fy = gout11y * dm[(i0+1)*nao+(k0+2)];
                fz = gout11z * dm[(i0+1)*nao+(k0+2)];
                fx += gout9x * dm[(i0+2)*nao+(k0+1)];
                fy += gout9y * dm[(i0+2)*nao+(k0+1)];
                fz += gout9z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout13x * dm[(i0+0)*nao+(k0+0)];
                fy = gout13y * dm[(i0+0)*nao+(k0+0)];
                fz = gout13z * dm[(i0+0)*nao+(k0+0)];
                fx += gout18x * dm[(i0+2)*nao+(k0+2)];
                fy += gout18y * dm[(i0+2)*nao+(k0+2)];
                fz += gout18z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout5x * dm[(i0+1)*nao+(k0+2)];
                fy = gout5y * dm[(i0+1)*nao+(k0+2)];
                fz = gout5z * dm[(i0+1)*nao+(k0+2)];
                fx += gout3x * dm[(i0+2)*nao+(k0+1)];
                fy += gout3y * dm[(i0+2)*nao+(k0+1)];
                fz += gout3z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(k0+0)];
                fy = gout7y * dm[(i0+0)*nao+(k0+0)];
                fz = gout7z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+2)*nao+(k0+2)];
                fy += gout12y * dm[(i0+2)*nao+(k0+2)];
                fz += gout12z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+1), fz);
                fx = gout16x * dm[(i0+0)*nao+(k0+1)];
                fy = gout16y * dm[(i0+0)*nao+(k0+1)];
                fz = gout16z * dm[(i0+0)*nao+(k0+1)];
                fx += gout14x * dm[(i0+1)*nao+(k0+0)];
                fy += gout14y * dm[(i0+1)*nao+(k0+0)];
                fz += gout14z * dm[(i0+1)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout6x * dm[(i0+2)*nao+(k0+2)];
                fy += gout6y * dm[(i0+2)*nao+(k0+2)];
                fz += gout6z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+1)];
                fy = gout10y * dm[(i0+0)*nao+(k0+1)];
                fz = gout10z * dm[(i0+0)*nao+(k0+1)];
                fx += gout8x * dm[(i0+1)*nao+(k0+0)];
                fy += gout8y * dm[(i0+1)*nao+(k0+0)];
                fz += gout8z * dm[(i0+1)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+1), fz);
                fx = gout19x * dm[(i0+0)*nao+(k0+2)];
                fy = gout19y * dm[(i0+0)*nao+(k0+2)];
                fz = gout19z * dm[(i0+0)*nao+(k0+2)];
                fx += gout17x * dm[(i0+1)*nao+(k0+1)];
                fy += gout17y * dm[(i0+1)*nao+(k0+1)];
                fz += gout17z * dm[(i0+1)*nao+(k0+1)];
                fx += gout15x * dm[(i0+2)*nao+(k0+0)];
                fy += gout15y * dm[(i0+2)*nao+(k0+0)];
                fz += gout15z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+2), fz);
                fx = gout13x * dm[(j0+0)*nao+(l0+2)];
                fy = gout13y * dm[(j0+0)*nao+(l0+2)];
                fz = gout13z * dm[(j0+0)*nao+(l0+2)];
                fx += gout7x * dm[(j0+1)*nao+(l0+1)];
                fy += gout7y * dm[(j0+1)*nao+(l0+1)];
                fz += gout7z * dm[(j0+1)*nao+(l0+1)];
                fx += gout1x * dm[(j0+2)*nao+(l0+0)];
                fy += gout1y * dm[(j0+2)*nao+(l0+0)];
                fz += gout1z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout16x * dm[(j0+1)*nao+(l0+2)];
                fy = gout16y * dm[(j0+1)*nao+(l0+2)];
                fz = gout16z * dm[(j0+1)*nao+(l0+2)];
                fx += gout10x * dm[(j0+2)*nao+(l0+1)];
                fy += gout10y * dm[(j0+2)*nao+(l0+1)];
                fz += gout10z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout19x * dm[(j0+2)*nao+(l0+2)];
                fy += gout19y * dm[(j0+2)*nao+(l0+2)];
                fz += gout19z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout14x * dm[(j0+1)*nao+(l0+2)];
                fy = gout14y * dm[(j0+1)*nao+(l0+2)];
                fz = gout14z * dm[(j0+1)*nao+(l0+2)];
                fx += gout8x * dm[(j0+2)*nao+(l0+1)];
                fy += gout8y * dm[(j0+2)*nao+(l0+1)];
                fz += gout8z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout17x * dm[(j0+2)*nao+(l0+2)];
                fy += gout17y * dm[(j0+2)*nao+(l0+2)];
                fz += gout17z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(l0+1)];
                fy = gout11y * dm[(j0+0)*nao+(l0+1)];
                fz = gout11z * dm[(j0+0)*nao+(l0+1)];
                fx += gout5x * dm[(j0+1)*nao+(l0+0)];
                fy += gout5y * dm[(j0+1)*nao+(l0+0)];
                fz += gout5z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout15x * dm[(j0+2)*nao+(l0+2)];
                fy += gout15y * dm[(j0+2)*nao+(l0+2)];
                fz += gout15z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+1)];
                fy = gout9y * dm[(j0+0)*nao+(l0+1)];
                fz = gout9z * dm[(j0+0)*nao+(l0+1)];
                fx += gout3x * dm[(j0+1)*nao+(l0+0)];
                fy += gout3y * dm[(j0+1)*nao+(l0+0)];
                fz += gout3z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout18x * dm[(j0+0)*nao+(l0+2)];
                fy = gout18y * dm[(j0+0)*nao+(l0+2)];
                fz = gout18z * dm[(j0+0)*nao+(l0+2)];
                fx += gout12x * dm[(j0+1)*nao+(l0+1)];
                fy += gout12y * dm[(j0+1)*nao+(l0+1)];
                fz += gout12z * dm[(j0+1)*nao+(l0+1)];
                fx += gout6x * dm[(j0+2)*nao+(l0+0)];
                fy += gout6y * dm[(j0+2)*nao+(l0+0)];
                fz += gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout13x * dm[(i0+0)*nao+(l0+2)];
                fy = gout13y * dm[(i0+0)*nao+(l0+2)];
                fz = gout13z * dm[(i0+0)*nao+(l0+2)];
                fx += gout0x * dm[(i0+2)*nao+(l0+0)];
                fy += gout0y * dm[(i0+2)*nao+(l0+0)];
                fz += gout0z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+1)*nao+(l0+0)];
                fy = gout2y * dm[(i0+1)*nao+(l0+0)];
                fz = gout2z * dm[(i0+1)*nao+(l0+0)];
                fx += gout9x * dm[(i0+2)*nao+(l0+1)];
                fy += gout9y * dm[(i0+2)*nao+(l0+1)];
                fz += gout9z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+1)*nao+(l0+1)];
                fy += gout11y * dm[(i0+1)*nao+(l0+1)];
                fz += gout11z * dm[(i0+1)*nao+(l0+1)];
                fx += gout18x * dm[(i0+2)*nao+(l0+2)];
                fy += gout18y * dm[(i0+2)*nao+(l0+2)];
                fz += gout18z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+1)];
                fy = gout7y * dm[(i0+0)*nao+(l0+1)];
                fz = gout7z * dm[(i0+0)*nao+(l0+1)];
                fx += gout14x * dm[(i0+1)*nao+(l0+2)];
                fy += gout14y * dm[(i0+1)*nao+(l0+2)];
                fz += gout14z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout16x * dm[(i0+0)*nao+(l0+2)];
                fy = gout16y * dm[(i0+0)*nao+(l0+2)];
                fz = gout16z * dm[(i0+0)*nao+(l0+2)];
                fx += gout3x * dm[(i0+2)*nao+(l0+0)];
                fy += gout3y * dm[(i0+2)*nao+(l0+0)];
                fz += gout3z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout5x * dm[(i0+1)*nao+(l0+0)];
                fy = gout5y * dm[(i0+1)*nao+(l0+0)];
                fz = gout5z * dm[(i0+1)*nao+(l0+0)];
                fx += gout12x * dm[(i0+2)*nao+(l0+1)];
                fy += gout12y * dm[(i0+2)*nao+(l0+1)];
                fz += gout12z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout8x * dm[(i0+1)*nao+(l0+1)];
                fy += gout8y * dm[(i0+1)*nao+(l0+1)];
                fz += gout8z * dm[(i0+1)*nao+(l0+1)];
                fx += gout15x * dm[(i0+2)*nao+(l0+2)];
                fy += gout15y * dm[(i0+2)*nao+(l0+2)];
                fz += gout15z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout10x * dm[(i0+0)*nao+(l0+1)];
                fy = gout10y * dm[(i0+0)*nao+(l0+1)];
                fz = gout10z * dm[(i0+0)*nao+(l0+1)];
                fx += gout17x * dm[(i0+1)*nao+(l0+2)];
                fy += gout17y * dm[(i0+1)*nao+(l0+2)];
                fz += gout17z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout19x * dm[(i0+0)*nao+(l0+2)];
                fy = gout19y * dm[(i0+0)*nao+(l0+2)];
                fz = gout19z * dm[(i0+0)*nao+(l0+2)];
                fx += gout6x * dm[(i0+2)*nao+(l0+0)];
                fy += gout6y * dm[(i0+2)*nao+(l0+0)];
                fz += gout6z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                break;
                case 3:
                fx = gout0x * dm[(j0+1)*nao+(k0+0)];
                fy = gout0y * dm[(j0+1)*nao+(k0+0)];
                fz = gout0z * dm[(j0+1)*nao+(k0+0)];
                fx += gout3x * dm[(j0+2)*nao+(k0+1)];
                fy += gout3y * dm[(j0+2)*nao+(k0+1)];
                fz += gout3z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+0)];
                fy = gout6y * dm[(j0+0)*nao+(k0+0)];
                fz = gout6z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+1)*nao+(k0+1)];
                fy += gout9y * dm[(j0+1)*nao+(k0+1)];
                fz += gout9z * dm[(j0+1)*nao+(k0+1)];
                fx += gout12x * dm[(j0+2)*nao+(k0+2)];
                fy += gout12y * dm[(j0+2)*nao+(k0+2)];
                fz += gout12z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout15x * dm[(j0+0)*nao+(k0+1)];
                fy = gout15y * dm[(j0+0)*nao+(k0+1)];
                fz = gout15z * dm[(j0+0)*nao+(k0+1)];
                fx += gout18x * dm[(j0+1)*nao+(k0+2)];
                fy += gout18y * dm[(j0+1)*nao+(k0+2)];
                fz += gout18z * dm[(j0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+2)];
                fy = gout4y * dm[(j0+0)*nao+(k0+2)];
                fz = gout4z * dm[(j0+0)*nao+(k0+2)];
                fx += gout1x * dm[(j0+2)*nao+(k0+0)];
                fy += gout1y * dm[(j0+2)*nao+(k0+0)];
                fz += gout1z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+1)*nao+(k0+0)];
                fy = gout7y * dm[(j0+1)*nao+(k0+0)];
                fz = gout7z * dm[(j0+1)*nao+(k0+0)];
                fx += gout10x * dm[(j0+2)*nao+(k0+1)];
                fy += gout10y * dm[(j0+2)*nao+(k0+1)];
                fz += gout10z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+1), fz);
                fx = gout13x * dm[(j0+0)*nao+(k0+0)];
                fy = gout13y * dm[(j0+0)*nao+(k0+0)];
                fz = gout13z * dm[(j0+0)*nao+(k0+0)];
                fx += gout16x * dm[(j0+1)*nao+(k0+1)];
                fy += gout16y * dm[(j0+1)*nao+(k0+1)];
                fz += gout16z * dm[(j0+1)*nao+(k0+1)];
                fx += gout19x * dm[(j0+2)*nao+(k0+2)];
                fy += gout19y * dm[(j0+2)*nao+(k0+2)];
                fz += gout19z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                fx += gout5x * dm[(j0+1)*nao+(k0+2)];
                fy += gout5y * dm[(j0+1)*nao+(k0+2)];
                fz += gout5z * dm[(j0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+2)];
                fy = gout11y * dm[(j0+0)*nao+(k0+2)];
                fz = gout11z * dm[(j0+0)*nao+(k0+2)];
                fx += gout8x * dm[(j0+2)*nao+(k0+0)];
                fy += gout8y * dm[(j0+2)*nao+(k0+0)];
                fz += gout8z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+1), fz);
                fx = gout14x * dm[(j0+1)*nao+(k0+0)];
                fy = gout14y * dm[(j0+1)*nao+(k0+0)];
                fz = gout14z * dm[(j0+1)*nao+(k0+0)];
                fx += gout17x * dm[(j0+2)*nao+(k0+1)];
                fy += gout17y * dm[(j0+2)*nao+(k0+1)];
                fz += gout17z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+2), fz);
                fx = gout4x * dm[(i0+1)*nao+(k0+2)];
                fy = gout4y * dm[(i0+1)*nao+(k0+2)];
                fz = gout4z * dm[(i0+1)*nao+(k0+2)];
                fx += gout2x * dm[(i0+2)*nao+(k0+1)];
                fy += gout2y * dm[(i0+2)*nao+(k0+1)];
                fz += gout2z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+0)];
                fy = gout6y * dm[(i0+0)*nao+(k0+0)];
                fz = gout6z * dm[(i0+0)*nao+(k0+0)];
                fx += gout11x * dm[(i0+2)*nao+(k0+2)];
                fy += gout11y * dm[(i0+2)*nao+(k0+2)];
                fz += gout11z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout15x * dm[(i0+0)*nao+(k0+1)];
                fy = gout15y * dm[(i0+0)*nao+(k0+1)];
                fz = gout15z * dm[(i0+0)*nao+(k0+1)];
                fx += gout13x * dm[(i0+1)*nao+(k0+0)];
                fy += gout13y * dm[(i0+1)*nao+(k0+0)];
                fz += gout13z * dm[(i0+1)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout5x * dm[(i0+2)*nao+(k0+2)];
                fy += gout5y * dm[(i0+2)*nao+(k0+2)];
                fz += gout5z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+1)];
                fy = gout9y * dm[(i0+0)*nao+(k0+1)];
                fz = gout9z * dm[(i0+0)*nao+(k0+1)];
                fx += gout7x * dm[(i0+1)*nao+(k0+0)];
                fy += gout7y * dm[(i0+1)*nao+(k0+0)];
                fz += gout7z * dm[(i0+1)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+1), fz);
                fx = gout18x * dm[(i0+0)*nao+(k0+2)];
                fy = gout18y * dm[(i0+0)*nao+(k0+2)];
                fz = gout18z * dm[(i0+0)*nao+(k0+2)];
                fx += gout16x * dm[(i0+1)*nao+(k0+1)];
                fy += gout16y * dm[(i0+1)*nao+(k0+1)];
                fz += gout16z * dm[(i0+1)*nao+(k0+1)];
                fx += gout14x * dm[(i0+2)*nao+(k0+0)];
                fy += gout14y * dm[(i0+2)*nao+(k0+0)];
                fz += gout14z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+1)];
                fy = gout3y * dm[(i0+0)*nao+(k0+1)];
                fz = gout3z * dm[(i0+0)*nao+(k0+1)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout12x * dm[(i0+0)*nao+(k0+2)];
                fy = gout12y * dm[(i0+0)*nao+(k0+2)];
                fz = gout12z * dm[(i0+0)*nao+(k0+2)];
                fx += gout10x * dm[(i0+1)*nao+(k0+1)];
                fy += gout10y * dm[(i0+1)*nao+(k0+1)];
                fz += gout10z * dm[(i0+1)*nao+(k0+1)];
                fx += gout8x * dm[(i0+2)*nao+(k0+0)];
                fy += gout8y * dm[(i0+2)*nao+(k0+0)];
                fz += gout8z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+1), fz);
                fx = gout19x * dm[(i0+1)*nao+(k0+2)];
                fy = gout19y * dm[(i0+1)*nao+(k0+2)];
                fz = gout19z * dm[(i0+1)*nao+(k0+2)];
                fx += gout17x * dm[(i0+2)*nao+(k0+1)];
                fy += gout17y * dm[(i0+2)*nao+(k0+1)];
                fz += gout17z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+2), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                fx += gout0x * dm[(j0+1)*nao+(l0+0)];
                fy += gout0y * dm[(j0+1)*nao+(l0+0)];
                fz += gout0z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout15x * dm[(j0+0)*nao+(l0+2)];
                fy = gout15y * dm[(j0+0)*nao+(l0+2)];
                fz = gout15z * dm[(j0+0)*nao+(l0+2)];
                fx += gout9x * dm[(j0+1)*nao+(l0+1)];
                fy += gout9y * dm[(j0+1)*nao+(l0+1)];
                fz += gout9z * dm[(j0+1)*nao+(l0+1)];
                fx += gout3x * dm[(j0+2)*nao+(l0+0)];
                fy += gout3y * dm[(j0+2)*nao+(l0+0)];
                fz += gout3z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout18x * dm[(j0+1)*nao+(l0+2)];
                fy = gout18y * dm[(j0+1)*nao+(l0+2)];
                fz = gout18z * dm[(j0+1)*nao+(l0+2)];
                fx += gout12x * dm[(j0+2)*nao+(l0+1)];
                fy += gout12y * dm[(j0+2)*nao+(l0+1)];
                fz += gout12z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout13x * dm[(j0+0)*nao+(l0+2)];
                fy = gout13y * dm[(j0+0)*nao+(l0+2)];
                fz = gout13z * dm[(j0+0)*nao+(l0+2)];
                fx += gout7x * dm[(j0+1)*nao+(l0+1)];
                fy += gout7y * dm[(j0+1)*nao+(l0+1)];
                fz += gout7z * dm[(j0+1)*nao+(l0+1)];
                fx += gout1x * dm[(j0+2)*nao+(l0+0)];
                fy += gout1y * dm[(j0+2)*nao+(l0+0)];
                fz += gout1z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout16x * dm[(j0+1)*nao+(l0+2)];
                fy = gout16y * dm[(j0+1)*nao+(l0+2)];
                fz = gout16z * dm[(j0+1)*nao+(l0+2)];
                fx += gout10x * dm[(j0+2)*nao+(l0+1)];
                fy += gout10y * dm[(j0+2)*nao+(l0+1)];
                fz += gout10z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout19x * dm[(j0+2)*nao+(l0+2)];
                fy += gout19y * dm[(j0+2)*nao+(l0+2)];
                fz += gout19z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout14x * dm[(j0+1)*nao+(l0+2)];
                fy = gout14y * dm[(j0+1)*nao+(l0+2)];
                fz = gout14z * dm[(j0+1)*nao+(l0+2)];
                fx += gout8x * dm[(j0+2)*nao+(l0+1)];
                fy += gout8y * dm[(j0+2)*nao+(l0+1)];
                fz += gout8z * dm[(j0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout17x * dm[(j0+2)*nao+(l0+2)];
                fy += gout17y * dm[(j0+2)*nao+(l0+2)];
                fz += gout17z * dm[(j0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(l0+1)];
                fy = gout11y * dm[(j0+0)*nao+(l0+1)];
                fz = gout11z * dm[(j0+0)*nao+(l0+1)];
                fx += gout5x * dm[(j0+1)*nao+(l0+0)];
                fy += gout5y * dm[(j0+1)*nao+(l0+0)];
                fz += gout5z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                fx += gout13x * dm[(i0+1)*nao+(l0+2)];
                fy += gout13y * dm[(i0+1)*nao+(l0+2)];
                fz += gout13z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout15x * dm[(i0+0)*nao+(l0+2)];
                fy = gout15y * dm[(i0+0)*nao+(l0+2)];
                fz = gout15z * dm[(i0+0)*nao+(l0+2)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+0)];
                fy = gout4y * dm[(i0+1)*nao+(l0+0)];
                fz = gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout11x * dm[(i0+2)*nao+(l0+1)];
                fy += gout11y * dm[(i0+2)*nao+(l0+1)];
                fz += gout11z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+1)*nao+(l0+1)];
                fy += gout7y * dm[(i0+1)*nao+(l0+1)];
                fz += gout7z * dm[(i0+1)*nao+(l0+1)];
                fx += gout14x * dm[(i0+2)*nao+(l0+2)];
                fy += gout14y * dm[(i0+2)*nao+(l0+2)];
                fz += gout14z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+1)];
                fy = gout9y * dm[(i0+0)*nao+(l0+1)];
                fz = gout9z * dm[(i0+0)*nao+(l0+1)];
                fx += gout16x * dm[(i0+1)*nao+(l0+2)];
                fy += gout16y * dm[(i0+1)*nao+(l0+2)];
                fz += gout16z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout18x * dm[(i0+0)*nao+(l0+2)];
                fy = gout18y * dm[(i0+0)*nao+(l0+2)];
                fz = gout18z * dm[(i0+0)*nao+(l0+2)];
                fx += gout5x * dm[(i0+2)*nao+(l0+0)];
                fy += gout5y * dm[(i0+2)*nao+(l0+0)];
                fz += gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+2)*nao+(l0+1)];
                fy += gout8y * dm[(i0+2)*nao+(l0+1)];
                fz += gout8z * dm[(i0+2)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+1)*nao+(l0+1)];
                fy += gout10y * dm[(i0+1)*nao+(l0+1)];
                fz += gout10z * dm[(i0+1)*nao+(l0+1)];
                fx += gout17x * dm[(i0+2)*nao+(l0+2)];
                fy += gout17y * dm[(i0+2)*nao+(l0+2)];
                fz += gout17z * dm[(i0+2)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+1)];
                fy = gout12y * dm[(i0+0)*nao+(l0+1)];
                fz = gout12z * dm[(i0+0)*nao+(l0+1)];
                fx += gout19x * dm[(i0+1)*nao+(l0+2)];
                fy += gout19y * dm[(i0+1)*nao+(l0+2)];
                fz += gout19z * dm[(i0+1)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                break;
                }
            }
        }
    }
}
__global__
static void rys_vjk_ip1_1111(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_1111(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_1120(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;
    double *gx = rw + 128 * nroots;
    double *gy = gx + 1152;
    double *gz = gy + 1152;
    double *rlrk = gz + 1152;
    double *Rpq = rlrk + 192;
    if (gout_id == 0) {
        gx[0] = 1.;
        gy[0] = 1.;
    }
    double s0, s1, s2;
    double Ix, Iy, Iz;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        if (gout_id == 0) {
            rlrk[0] = xlxk;
            rlrk[64] = ylyk;
            rlrk[128] = zlzk;
        }
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            __syncthreads();
            double xlxk = rlrk[0];
            double ylyk = rlrk[64];
            double zlzk = rlrk[128];
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xkl = rk[0] + rlrk[0] * al_akl;
                double ykl = rk[1] + rlrk[64] * al_akl;
                double zkl = rk[2] + rlrk[128] * al_akl;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                __syncthreads();
                if (gout_id == 0) {
                    Rpq[0] = xpq;
                    Rpq[64] = ypq;
                    Rpq[128] = zpq;
                }
                rys_roots_rs(nroots, theta, rr, omega, rw, 64, gout_id, 4);
                for (int irys = 0; irys < nroots; ++irys) {
                    __syncthreads();
                    double rt = rw[irys*128];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double rt_akl = rt_aa * aij;
                    double b00 = .5 * rt_aa;
                    double b01 = .5/akl * (1 - rt_akl);
                    for (int n = gout_id; n < 3; n += 4) {
                        if (n == 2) {
                            gz[0] = rw[irys*128+64] * fac;
                        }
                        double *_gx = gx + n * 1152;
                        double xjxi = rjri[n];
                        double Rpa = xjxi * aj_aij;
                        double c0x = Rpa - rt_aij * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = c0x * s0;
                        _gx[64] = s1;
                        s2 = c0x * s1 + 1 * b10 * s0;
                        _gx[128] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 2 * b10 * s0;
                        _gx[192] = s2;
                        double xlxk = rlrk[n*64];
                        double Rqc = xlxk * al_akl;
                        double cpx = Rqc + rt_akl * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = cpx * s0;
                        _gx[384] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        _gx[768] = s2;
                        s0 = _gx[64];
                        s1 = cpx * s0;
                        s1 += 1 * b00 * _gx[0];
                        _gx[448] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 1 * b00 * _gx[384];
                        _gx[832] = s2;
                        s0 = _gx[128];
                        s1 = cpx * s0;
                        s1 += 2 * b00 * _gx[64];
                        _gx[512] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 2 * b00 * _gx[448];
                        _gx[896] = s2;
                        s0 = _gx[192];
                        s1 = cpx * s0;
                        s1 += 3 * b00 * _gx[128];
                        _gx[576] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 3 * b00 * _gx[512];
                        _gx[960] = s2;
                        s1 = _gx[192];
                        s0 = _gx[128];
                        _gx[320] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[256] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[192] = s1 - xjxi * s0;
                        s1 = _gx[576];
                        s0 = _gx[512];
                        _gx[704] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[448];
                        _gx[640] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[384];
                        _gx[576] = s1 - xjxi * s0;
                        s1 = _gx[960];
                        s0 = _gx[896];
                        _gx[1088] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[832];
                        _gx[1024] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[768];
                        _gx[960] = s1 - xjxi * s0;
                    }
                    __syncthreads();
                    switch (gout_id) {
                    case 0:
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[0];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[1088] - 1 * gx[960]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[256];
                    Iz = gz[0];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[0];
                    Iz = gz[256];
                    gout2x += ai2 * gx[832] * Iy * Iz;
                    gout2y += ai2 * gy[64] * Ix * Iz;
                    gout2z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[576];
                    Iz = gz[0];
                    gout3x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout3y += ai2 * gy[640] * Ix * Iz;
                    gout3z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[448];
                    Iz = gz[192];
                    gout4x += ai2 * gx[448] * Iy * Iz;
                    gout4y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout4z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[0];
                    Iz = gz[448];
                    gout5x += ai2 * gx[640] * Iy * Iz;
                    gout5y += ai2 * gy[64] * Ix * Iz;
                    gout5z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[0];
                    Iz = gz[576];
                    gout6x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout6y += ai2 * gy[64] * Ix * Iz;
                    gout6z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[832];
                    Iz = gz[0];
                    gout7x += ai2 * gx[256] * Iy * Iz;
                    gout7y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout7z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[960];
                    Iz = gz[64];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[1024] * Ix * Iz;
                    gout8z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[384];
                    Iz = gz[384];
                    gout9x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout9y += ai2 * gy[448] * Ix * Iz;
                    gout9z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[640];
                    Iz = gz[384];
                    gout10x += ai2 * gx[64] * Iy * Iz;
                    gout10y += (ai2 * gy[704] - 1 * gy[576]) * Ix * Iz;
                    gout10z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[384];
                    Iz = gz[640];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += ai2 * gy[448] * Ix * Iz;
                    gout11z += (ai2 * gz[704] - 1 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[192];
                    Iz = gz[768];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += ai2 * gy[256] * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[64];
                    Iz = gz[960];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout13z += ai2 * gz[1024] * Ix * Iy;
                    break;
                    case 1:
                    ai2 = rjri[5];
                    Ix = gx[960];
                    Iy = gy[64];
                    Iz = gz[0];
                    gout0x += ai2 * gx[1024] * Iy * Iz;
                    gout0y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[192];
                    Iz = gz[64];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += ai2 * gy[256] * Ix * Iz;
                    gout1z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[384];
                    Iz = gz[0];
                    gout2x += (ai2 * gx[704] - 1 * gx[576]) * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[640];
                    Iz = gz[0];
                    gout3x += ai2 * gx[448] * Iy * Iz;
                    gout3y += (ai2 * gy[704] - 1 * gy[576]) * Ix * Iz;
                    gout3z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[384];
                    Iz = gz[256];
                    gout4x += ai2 * gx[448] * Iy * Iz;
                    gout4y += ai2 * gy[448] * Ix * Iz;
                    gout4z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[192];
                    Iz = gz[384];
                    gout5x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout5y += ai2 * gy[256] * Ix * Iz;
                    gout5z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[64];
                    Iz = gz[576];
                    gout6x += ai2 * gx[448] * Iy * Iz;
                    gout6y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout6z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[768];
                    Iz = gz[64];
                    gout7x += ai2 * gx[256] * Iy * Iz;
                    gout7y += ai2 * gy[832] * Ix * Iz;
                    gout7z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[768];
                    Iz = gz[192];
                    gout8x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout8y += ai2 * gy[832] * Ix * Iz;
                    gout8z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[448];
                    Iz = gz[384];
                    gout9x += ai2 * gx[256] * Iy * Iz;
                    gout9y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout9z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[576];
                    Iz = gz[448];
                    gout10x += ai2 * gx[64] * Iy * Iz;
                    gout10y += ai2 * gy[640] * Ix * Iz;
                    gout10z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[0];
                    Iz = gz[768];
                    gout11x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout11y += ai2 * gy[64] * Ix * Iz;
                    gout11z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[256];
                    Iz = gz[768];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[0];
                    Iz = gz[1024];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += ai2 * gy[64] * Ix * Iz;
                    gout13z += (ai2 * gz[1088] - 1 * gz[960]) * Ix * Iy;
                    break;
                    case 2:
                    ai2 = rjri[5];
                    Ix = gx[960];
                    Iy = gy[0];
                    Iz = gz[64];
                    gout0x += ai2 * gx[1024] * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[0];
                    Iz = gz[192];
                    gout1x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout1y += ai2 * gy[64] * Ix * Iz;
                    gout1z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[448];
                    Iz = gz[0];
                    gout2x += ai2 * gx[640] * Iy * Iz;
                    gout2y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[576];
                    Iz = gz[64];
                    gout3x += ai2 * gx[448] * Iy * Iz;
                    gout3y += ai2 * gy[640] * Ix * Iz;
                    gout3z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[0];
                    Iz = gz[384];
                    gout4x += (ai2 * gx[704] - 1 * gx[576]) * Iy * Iz;
                    gout4y += ai2 * gy[64] * Ix * Iz;
                    gout4z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[256];
                    Iz = gz[384];
                    gout5x += ai2 * gx[448] * Iy * Iz;
                    gout5y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout5z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[0];
                    Iz = gz[640];
                    gout6x += ai2 * gx[448] * Iy * Iz;
                    gout6y += ai2 * gy[64] * Ix * Iz;
                    gout6z += (ai2 * gz[704] - 1 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[960];
                    Iz = gz[0];
                    gout7x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout7y += ai2 * gy[1024] * Ix * Iz;
                    gout7z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[832];
                    Iz = gz[192];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout8z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[384];
                    Iz = gz[448];
                    gout9x += ai2 * gx[256] * Iy * Iz;
                    gout9y += ai2 * gy[448] * Ix * Iz;
                    gout9z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[384];
                    Iz = gz[576];
                    gout10x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout10y += ai2 * gy[448] * Ix * Iz;
                    gout10z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[64];
                    Iz = gz[768];
                    gout11x += ai2 * gx[256] * Iy * Iz;
                    gout11y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout11z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[192];
                    Iz = gz[832];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += ai2 * gy[256] * Ix * Iz;
                    gout12z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    break;
                    case 3:
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[192];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout0y += ai2 * gy[256] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[64];
                    Iz = gz[192];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout1z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[384];
                    Iz = gz[64];
                    gout2x += ai2 * gx[640] * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[384];
                    Iz = gz[192];
                    gout3x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout3y += ai2 * gy[448] * Ix * Iz;
                    gout3z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[64];
                    Iz = gz[384];
                    gout4x += ai2 * gx[640] * Iy * Iz;
                    gout4y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout4z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[192];
                    Iz = gz[448];
                    gout5x += ai2 * gx[448] * Iy * Iz;
                    gout5y += ai2 * gy[256] * Ix * Iz;
                    gout5z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[768];
                    Iz = gz[0];
                    gout6x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout6y += ai2 * gy[832] * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1024];
                    Iz = gz[0];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += (ai2 * gy[1088] - 1 * gy[960]) * Ix * Iz;
                    gout7z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[768];
                    Iz = gz[256];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[832] * Ix * Iz;
                    gout8z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[576];
                    Iz = gz[384];
                    gout9x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout9y += ai2 * gy[640] * Ix * Iz;
                    gout9z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[448];
                    Iz = gz[576];
                    gout10x += ai2 * gx[64] * Iy * Iz;
                    gout10y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout10z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[0];
                    Iz = gz[832];
                    gout11x += ai2 * gx[256] * Iy * Iz;
                    gout11y += ai2 * gy[64] * Ix * Iz;
                    gout11z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[0];
                    Iz = gz[960];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += ai2 * gy[64] * Ix * Iz;
                    gout12z += ai2 * gz[1024] * Ix * Iy;
                    break;
                    }
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+4)];
                fy += gout9y * dm[(l0+0)*nao+(k0+4)];
                fz += gout9z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+1)];
                fy = gout3y * dm[(l0+0)*nao+(k0+1)];
                fz = gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout12x * dm[(l0+0)*nao+(k0+5)];
                fy += gout12y * dm[(l0+0)*nao+(k0+5)];
                fz += gout12z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+2)];
                fy = gout6y * dm[(l0+0)*nao+(k0+2)];
                fz = gout6z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+3)];
                fy = gout7y * dm[(l0+0)*nao+(k0+3)];
                fz = gout7z * dm[(l0+0)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+4)];
                fy += gout10y * dm[(l0+0)*nao+(k0+4)];
                fz += gout10z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+1)];
                fy = gout4y * dm[(l0+0)*nao+(k0+1)];
                fz = gout4z * dm[(l0+0)*nao+(k0+1)];
                fx += gout13x * dm[(l0+0)*nao+(k0+5)];
                fy += gout13y * dm[(l0+0)*nao+(k0+5)];
                fz += gout13z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+2)];
                fy = gout5y * dm[(l0+0)*nao+(k0+2)];
                fz = gout5z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+3)];
                fy = gout8y * dm[(l0+0)*nao+(k0+3)];
                fz = gout8z * dm[(l0+0)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+4)];
                fy += gout11y * dm[(l0+0)*nao+(k0+4)];
                fz += gout11z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+1)*nao+(i0+1)];
                fy += gout1y * dm[(j0+1)*nao+(i0+1)];
                fz += gout1z * dm[(j0+1)*nao+(i0+1)];
                fx += gout2x * dm[(j0+2)*nao+(i0+2)];
                fy += gout2y * dm[(j0+2)*nao+(i0+2)];
                fz += gout2z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+1)*nao+(i0+0)];
                fy = gout3y * dm[(j0+1)*nao+(i0+0)];
                fz = gout3z * dm[(j0+1)*nao+(i0+0)];
                fx += gout4x * dm[(j0+2)*nao+(i0+1)];
                fy += gout4y * dm[(j0+2)*nao+(i0+1)];
                fz += gout4z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+2)];
                fy = gout5y * dm[(j0+0)*nao+(i0+2)];
                fz = gout5z * dm[(j0+0)*nao+(i0+2)];
                fx += gout6x * dm[(j0+2)*nao+(i0+0)];
                fy += gout6y * dm[(j0+2)*nao+(i0+0)];
                fz += gout6z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+1)];
                fy = gout7y * dm[(j0+0)*nao+(i0+1)];
                fz = gout7z * dm[(j0+0)*nao+(i0+1)];
                fx += gout8x * dm[(j0+1)*nao+(i0+2)];
                fy += gout8y * dm[(j0+1)*nao+(i0+2)];
                fz += gout8z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                fx += gout10x * dm[(j0+1)*nao+(i0+1)];
                fy += gout10y * dm[(j0+1)*nao+(i0+1)];
                fz += gout10z * dm[(j0+1)*nao+(i0+1)];
                fx += gout11x * dm[(j0+2)*nao+(i0+2)];
                fy += gout11y * dm[(j0+2)*nao+(i0+2)];
                fz += gout11z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout12x * dm[(j0+1)*nao+(i0+0)];
                fy = gout12y * dm[(j0+1)*nao+(i0+0)];
                fz = gout12z * dm[(j0+1)*nao+(i0+0)];
                fx += gout13x * dm[(j0+2)*nao+(i0+1)];
                fy += gout13y * dm[(j0+2)*nao+(i0+1)];
                fz += gout13z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                case 1:
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout11x * dm[(l0+0)*nao+(k0+5)];
                fy += gout11y * dm[(l0+0)*nao+(k0+5)];
                fz += gout11z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+2)];
                fy = gout5y * dm[(l0+0)*nao+(k0+2)];
                fz = gout5z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+3)];
                fy = gout8y * dm[(l0+0)*nao+(k0+3)];
                fz = gout8z * dm[(l0+0)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+4)];
                fy += gout9y * dm[(l0+0)*nao+(k0+4)];
                fz += gout9z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+1)];
                fy = gout3y * dm[(l0+0)*nao+(k0+1)];
                fz = gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout12x * dm[(l0+0)*nao+(k0+5)];
                fy += gout12y * dm[(l0+0)*nao+(k0+5)];
                fz += gout12z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+2)];
                fy = gout6y * dm[(l0+0)*nao+(k0+2)];
                fz = gout6z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+3)];
                fy = gout7y * dm[(l0+0)*nao+(k0+3)];
                fz = gout7z * dm[(l0+0)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+4)];
                fy += gout10y * dm[(l0+0)*nao+(k0+4)];
                fz += gout10z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+1)];
                fy = gout4y * dm[(l0+0)*nao+(k0+1)];
                fz = gout4z * dm[(l0+0)*nao+(k0+1)];
                fx += gout13x * dm[(l0+0)*nao+(k0+5)];
                fy += gout13y * dm[(l0+0)*nao+(k0+5)];
                fz += gout13z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+1)];
                fy = gout0y * dm[(j0+0)*nao+(i0+1)];
                fz = gout0z * dm[(j0+0)*nao+(i0+1)];
                fx += gout1x * dm[(j0+1)*nao+(i0+2)];
                fy += gout1y * dm[(j0+1)*nao+(i0+2)];
                fz += gout1z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+0)];
                fy = gout2y * dm[(j0+0)*nao+(i0+0)];
                fz = gout2z * dm[(j0+0)*nao+(i0+0)];
                fx += gout3x * dm[(j0+1)*nao+(i0+1)];
                fy += gout3y * dm[(j0+1)*nao+(i0+1)];
                fz += gout3z * dm[(j0+1)*nao+(i0+1)];
                fx += gout4x * dm[(j0+2)*nao+(i0+2)];
                fy += gout4y * dm[(j0+2)*nao+(i0+2)];
                fz += gout4z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+1)*nao+(i0+0)];
                fy = gout5y * dm[(j0+1)*nao+(i0+0)];
                fz = gout5z * dm[(j0+1)*nao+(i0+0)];
                fx += gout6x * dm[(j0+2)*nao+(i0+1)];
                fy += gout6y * dm[(j0+2)*nao+(i0+1)];
                fz += gout6z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+2)];
                fy = gout7y * dm[(j0+0)*nao+(i0+2)];
                fz = gout7z * dm[(j0+0)*nao+(i0+2)];
                fx += gout8x * dm[(j0+2)*nao+(i0+0)];
                fy += gout8y * dm[(j0+2)*nao+(i0+0)];
                fz += gout8z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+1)];
                fy = gout9y * dm[(j0+0)*nao+(i0+1)];
                fz = gout9z * dm[(j0+0)*nao+(i0+1)];
                fx += gout10x * dm[(j0+1)*nao+(i0+2)];
                fy += gout10y * dm[(j0+1)*nao+(i0+2)];
                fz += gout10z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+0)];
                fy = gout11y * dm[(j0+0)*nao+(i0+0)];
                fz = gout11z * dm[(j0+0)*nao+(i0+0)];
                fx += gout12x * dm[(j0+1)*nao+(i0+1)];
                fy += gout12y * dm[(j0+1)*nao+(i0+1)];
                fz += gout12z * dm[(j0+1)*nao+(i0+1)];
                fx += gout13x * dm[(j0+2)*nao+(i0+2)];
                fy += gout13y * dm[(j0+2)*nao+(i0+2)];
                fz += gout13z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                case 2:
                fx = gout4x * dm[(l0+0)*nao+(k0+2)];
                fy = gout4y * dm[(l0+0)*nao+(k0+2)];
                fz = gout4z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+3)];
                fy = gout7y * dm[(l0+0)*nao+(k0+3)];
                fz = gout7z * dm[(l0+0)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+4)];
                fy += gout10y * dm[(l0+0)*nao+(k0+4)];
                fz += gout10z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout11x * dm[(l0+0)*nao+(k0+5)];
                fy += gout11y * dm[(l0+0)*nao+(k0+5)];
                fz += gout11z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+2)];
                fy = gout5y * dm[(l0+0)*nao+(k0+2)];
                fz = gout5z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+3)];
                fy = gout8y * dm[(l0+0)*nao+(k0+3)];
                fz = gout8z * dm[(l0+0)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+4)];
                fy += gout9y * dm[(l0+0)*nao+(k0+4)];
                fz += gout9z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+1)];
                fy = gout3y * dm[(l0+0)*nao+(k0+1)];
                fz = gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout12x * dm[(l0+0)*nao+(k0+5)];
                fy += gout12y * dm[(l0+0)*nao+(k0+5)];
                fz += gout12z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+2)];
                fy = gout6y * dm[(l0+0)*nao+(k0+2)];
                fz = gout6z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+2)];
                fy = gout0y * dm[(j0+0)*nao+(i0+2)];
                fz = gout0z * dm[(j0+0)*nao+(i0+2)];
                fx += gout1x * dm[(j0+2)*nao+(i0+0)];
                fy += gout1y * dm[(j0+2)*nao+(i0+0)];
                fz += gout1z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+1)];
                fy = gout2y * dm[(j0+0)*nao+(i0+1)];
                fz = gout2z * dm[(j0+0)*nao+(i0+1)];
                fx += gout3x * dm[(j0+1)*nao+(i0+2)];
                fy += gout3y * dm[(j0+1)*nao+(i0+2)];
                fz += gout3z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                fx += gout5x * dm[(j0+1)*nao+(i0+1)];
                fy += gout5y * dm[(j0+1)*nao+(i0+1)];
                fz += gout5z * dm[(j0+1)*nao+(i0+1)];
                fx += gout6x * dm[(j0+2)*nao+(i0+2)];
                fy += gout6y * dm[(j0+2)*nao+(i0+2)];
                fz += gout6z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+1)*nao+(i0+0)];
                fy = gout7y * dm[(j0+1)*nao+(i0+0)];
                fz = gout7z * dm[(j0+1)*nao+(i0+0)];
                fx += gout8x * dm[(j0+2)*nao+(i0+1)];
                fy += gout8y * dm[(j0+2)*nao+(i0+1)];
                fz += gout8z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+2)];
                fy = gout9y * dm[(j0+0)*nao+(i0+2)];
                fz = gout9z * dm[(j0+0)*nao+(i0+2)];
                fx += gout10x * dm[(j0+2)*nao+(i0+0)];
                fy += gout10y * dm[(j0+2)*nao+(i0+0)];
                fz += gout10z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+1)];
                fy = gout11y * dm[(j0+0)*nao+(i0+1)];
                fz = gout11z * dm[(j0+0)*nao+(i0+1)];
                fx += gout12x * dm[(j0+1)*nao+(i0+2)];
                fy += gout12y * dm[(j0+1)*nao+(i0+2)];
                fz += gout12z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                case 3:
                fx = gout6x * dm[(l0+0)*nao+(k0+3)];
                fy = gout6y * dm[(l0+0)*nao+(k0+3)];
                fz = gout6z * dm[(l0+0)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+4)];
                fy += gout9y * dm[(l0+0)*nao+(k0+4)];
                fz += gout9z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+1)];
                fy = gout3y * dm[(l0+0)*nao+(k0+1)];
                fz = gout3z * dm[(l0+0)*nao+(k0+1)];
                fx += gout12x * dm[(l0+0)*nao+(k0+5)];
                fy += gout12y * dm[(l0+0)*nao+(k0+5)];
                fz += gout12z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+2)];
                fy = gout4y * dm[(l0+0)*nao+(k0+2)];
                fz = gout4z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+3)];
                fy = gout7y * dm[(l0+0)*nao+(k0+3)];
                fz = gout7z * dm[(l0+0)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+4)];
                fy += gout10y * dm[(l0+0)*nao+(k0+4)];
                fz += gout10z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout11x * dm[(l0+0)*nao+(k0+5)];
                fy += gout11y * dm[(l0+0)*nao+(k0+5)];
                fz += gout11z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+2)];
                fy = gout5y * dm[(l0+0)*nao+(k0+2)];
                fz = gout5z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+3)];
                fy = gout8y * dm[(l0+0)*nao+(k0+3)];
                fz = gout8z * dm[(l0+0)*nao+(k0+3)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+1)*nao+(i0+0)];
                fy = gout0y * dm[(j0+1)*nao+(i0+0)];
                fz = gout0z * dm[(j0+1)*nao+(i0+0)];
                fx += gout1x * dm[(j0+2)*nao+(i0+1)];
                fy += gout1y * dm[(j0+2)*nao+(i0+1)];
                fz += gout1z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+2)];
                fy = gout2y * dm[(j0+0)*nao+(i0+2)];
                fz = gout2z * dm[(j0+0)*nao+(i0+2)];
                fx += gout3x * dm[(j0+2)*nao+(i0+0)];
                fy += gout3y * dm[(j0+2)*nao+(i0+0)];
                fz += gout3z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+1)];
                fy = gout4y * dm[(j0+0)*nao+(i0+1)];
                fz = gout4z * dm[(j0+0)*nao+(i0+1)];
                fx += gout5x * dm[(j0+1)*nao+(i0+2)];
                fy += gout5y * dm[(j0+1)*nao+(i0+2)];
                fz += gout5z * dm[(j0+1)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+1)*nao+(i0+1)];
                fy += gout7y * dm[(j0+1)*nao+(i0+1)];
                fz += gout7z * dm[(j0+1)*nao+(i0+1)];
                fx += gout8x * dm[(j0+2)*nao+(i0+2)];
                fy += gout8y * dm[(j0+2)*nao+(i0+2)];
                fz += gout8z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+1)*nao+(i0+0)];
                fy = gout9y * dm[(j0+1)*nao+(i0+0)];
                fz = gout9z * dm[(j0+1)*nao+(i0+0)];
                fx += gout10x * dm[(j0+2)*nao+(i0+1)];
                fy += gout10y * dm[(j0+2)*nao+(i0+1)];
                fz += gout10z * dm[(j0+2)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+2)];
                fy = gout11y * dm[(j0+0)*nao+(i0+2)];
                fz = gout11z * dm[(j0+0)*nao+(i0+2)];
                fx += gout12x * dm[(j0+2)*nao+(i0+0)];
                fy += gout12y * dm[(j0+2)*nao+(i0+0)];
                fz += gout12z * dm[(j0+2)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                }
            }
            if (do_k) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+4)];
                fy += gout9y * dm[(j0+0)*nao+(k0+4)];
                fz += gout9z * dm[(j0+0)*nao+(k0+4)];
                fx += gout3x * dm[(j0+1)*nao+(k0+1)];
                fy += gout3y * dm[(j0+1)*nao+(k0+1)];
                fz += gout3z * dm[(j0+1)*nao+(k0+1)];
                fx += gout12x * dm[(j0+1)*nao+(k0+5)];
                fy += gout12y * dm[(j0+1)*nao+(k0+5)];
                fz += gout12z * dm[(j0+1)*nao+(k0+5)];
                fx += gout6x * dm[(j0+2)*nao+(k0+2)];
                fy += gout6y * dm[(j0+2)*nao+(k0+2)];
                fz += gout6z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(k0+3)];
                fy = gout7y * dm[(j0+0)*nao+(k0+3)];
                fz = gout7z * dm[(j0+0)*nao+(k0+3)];
                fx += gout1x * dm[(j0+1)*nao+(k0+0)];
                fy += gout1y * dm[(j0+1)*nao+(k0+0)];
                fz += gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout10x * dm[(j0+1)*nao+(k0+4)];
                fy += gout10y * dm[(j0+1)*nao+(k0+4)];
                fz += gout10z * dm[(j0+1)*nao+(k0+4)];
                fx += gout4x * dm[(j0+2)*nao+(k0+1)];
                fy += gout4y * dm[(j0+2)*nao+(k0+1)];
                fz += gout4z * dm[(j0+2)*nao+(k0+1)];
                fx += gout13x * dm[(j0+2)*nao+(k0+5)];
                fy += gout13y * dm[(j0+2)*nao+(k0+5)];
                fz += gout13z * dm[(j0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+2)];
                fy = gout5y * dm[(j0+0)*nao+(k0+2)];
                fz = gout5z * dm[(j0+0)*nao+(k0+2)];
                fx += gout8x * dm[(j0+1)*nao+(k0+3)];
                fy += gout8y * dm[(j0+1)*nao+(k0+3)];
                fz += gout8z * dm[(j0+1)*nao+(k0+3)];
                fx += gout2x * dm[(j0+2)*nao+(k0+0)];
                fy += gout2y * dm[(j0+2)*nao+(k0+0)];
                fz += gout2z * dm[(j0+2)*nao+(k0+0)];
                fx += gout11x * dm[(j0+2)*nao+(k0+4)];
                fy += gout11y * dm[(j0+2)*nao+(k0+4)];
                fz += gout11z * dm[(j0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout9x * dm[(i0+0)*nao+(k0+4)];
                fy += gout9y * dm[(i0+0)*nao+(k0+4)];
                fz += gout9z * dm[(i0+0)*nao+(k0+4)];
                fx += gout7x * dm[(i0+1)*nao+(k0+3)];
                fy += gout7y * dm[(i0+1)*nao+(k0+3)];
                fz += gout7z * dm[(i0+1)*nao+(k0+3)];
                fx += gout5x * dm[(i0+2)*nao+(k0+2)];
                fy += gout5y * dm[(i0+2)*nao+(k0+2)];
                fz += gout5z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+1)];
                fy = gout3y * dm[(i0+0)*nao+(k0+1)];
                fz = gout3z * dm[(i0+0)*nao+(k0+1)];
                fx += gout12x * dm[(i0+0)*nao+(k0+5)];
                fy += gout12y * dm[(i0+0)*nao+(k0+5)];
                fz += gout12z * dm[(i0+0)*nao+(k0+5)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout10x * dm[(i0+1)*nao+(k0+4)];
                fy += gout10y * dm[(i0+1)*nao+(k0+4)];
                fz += gout10z * dm[(i0+1)*nao+(k0+4)];
                fx += gout8x * dm[(i0+2)*nao+(k0+3)];
                fy += gout8y * dm[(i0+2)*nao+(k0+3)];
                fz += gout8z * dm[(i0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+2)];
                fy = gout6y * dm[(i0+0)*nao+(k0+2)];
                fz = gout6z * dm[(i0+0)*nao+(k0+2)];
                fx += gout4x * dm[(i0+1)*nao+(k0+1)];
                fy += gout4y * dm[(i0+1)*nao+(k0+1)];
                fz += gout4z * dm[(i0+1)*nao+(k0+1)];
                fx += gout13x * dm[(i0+1)*nao+(k0+5)];
                fy += gout13y * dm[(i0+1)*nao+(k0+5)];
                fz += gout13z * dm[(i0+1)*nao+(k0+5)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                fx += gout11x * dm[(i0+2)*nao+(k0+4)];
                fy += gout11y * dm[(i0+2)*nao+(k0+4)];
                fz += gout11z * dm[(i0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+1)*nao+(l0+0)];
                fy = gout3y * dm[(j0+1)*nao+(l0+0)];
                fz = gout3z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+2)*nao+(l0+0)];
                fy = gout6y * dm[(j0+2)*nao+(l0+0)];
                fz = gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout12x * dm[(j0+1)*nao+(l0+0)];
                fy = gout12y * dm[(j0+1)*nao+(l0+0)];
                fz = gout12z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+2)*nao+(l0+0)];
                fy = gout4y * dm[(j0+2)*nao+(l0+0)];
                fz = gout4z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+0)];
                fy = gout7y * dm[(j0+0)*nao+(l0+0)];
                fz = gout7z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+3), fz);
                fx = gout10x * dm[(j0+1)*nao+(l0+0)];
                fy = gout10y * dm[(j0+1)*nao+(l0+0)];
                fz = gout10z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+4), fz);
                fx = gout13x * dm[(j0+2)*nao+(l0+0)];
                fy = gout13y * dm[(j0+2)*nao+(l0+0)];
                fz = gout13z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+5), fz);
                fx = gout2x * dm[(j0+2)*nao+(l0+0)];
                fy = gout2y * dm[(j0+2)*nao+(l0+0)];
                fz = gout2z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout8x * dm[(j0+1)*nao+(l0+0)];
                fy = gout8y * dm[(j0+1)*nao+(l0+0)];
                fz = gout8z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+3), fz);
                fx = gout11x * dm[(j0+2)*nao+(l0+0)];
                fy = gout11y * dm[(j0+2)*nao+(l0+0)];
                fz = gout11z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+4), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+2)*nao+(l0+0)];
                fy = gout5y * dm[(i0+2)*nao+(l0+0)];
                fz = gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout7x * dm[(i0+1)*nao+(l0+0)];
                fy = gout7y * dm[(i0+1)*nao+(l0+0)];
                fz = gout7z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+0)];
                fy = gout9y * dm[(i0+0)*nao+(l0+0)];
                fz = gout9z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout8x * dm[(i0+2)*nao+(l0+0)];
                fy = gout8y * dm[(i0+2)*nao+(l0+0)];
                fz = gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+3), fz);
                fx = gout10x * dm[(i0+1)*nao+(l0+0)];
                fy = gout10y * dm[(i0+1)*nao+(l0+0)];
                fz = gout10z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+4), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+5), fz);
                fx = gout2x * dm[(i0+2)*nao+(l0+0)];
                fy = gout2y * dm[(i0+2)*nao+(l0+0)];
                fz = gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+0)];
                fy = gout4y * dm[(i0+1)*nao+(l0+0)];
                fz = gout4z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout11x * dm[(i0+2)*nao+(l0+0)];
                fy = gout11y * dm[(i0+2)*nao+(l0+0)];
                fz = gout11z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+4), fz);
                fx = gout13x * dm[(i0+1)*nao+(l0+0)];
                fy = gout13y * dm[(i0+1)*nao+(l0+0)];
                fz = gout13z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+5), fz);
                break;
                case 1:
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                fx += gout11x * dm[(j0+0)*nao+(k0+5)];
                fy += gout11y * dm[(j0+0)*nao+(k0+5)];
                fz += gout11z * dm[(j0+0)*nao+(k0+5)];
                fx += gout5x * dm[(j0+1)*nao+(k0+2)];
                fy += gout5y * dm[(j0+1)*nao+(k0+2)];
                fz += gout5z * dm[(j0+1)*nao+(k0+2)];
                fx += gout8x * dm[(j0+2)*nao+(k0+3)];
                fy += gout8y * dm[(j0+2)*nao+(k0+3)];
                fz += gout8z * dm[(j0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+4)];
                fy += gout9y * dm[(j0+0)*nao+(k0+4)];
                fz += gout9z * dm[(j0+0)*nao+(k0+4)];
                fx += gout3x * dm[(j0+1)*nao+(k0+1)];
                fy += gout3y * dm[(j0+1)*nao+(k0+1)];
                fz += gout3z * dm[(j0+1)*nao+(k0+1)];
                fx += gout12x * dm[(j0+1)*nao+(k0+5)];
                fy += gout12y * dm[(j0+1)*nao+(k0+5)];
                fz += gout12z * dm[(j0+1)*nao+(k0+5)];
                fx += gout6x * dm[(j0+2)*nao+(k0+2)];
                fy += gout6y * dm[(j0+2)*nao+(k0+2)];
                fz += gout6z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(k0+3)];
                fy = gout7y * dm[(j0+0)*nao+(k0+3)];
                fz = gout7z * dm[(j0+0)*nao+(k0+3)];
                fx += gout1x * dm[(j0+1)*nao+(k0+0)];
                fy += gout1y * dm[(j0+1)*nao+(k0+0)];
                fz += gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout10x * dm[(j0+1)*nao+(k0+4)];
                fy += gout10y * dm[(j0+1)*nao+(k0+4)];
                fz += gout10z * dm[(j0+1)*nao+(k0+4)];
                fx += gout4x * dm[(j0+2)*nao+(k0+1)];
                fy += gout4y * dm[(j0+2)*nao+(k0+1)];
                fz += gout4z * dm[(j0+2)*nao+(k0+1)];
                fx += gout13x * dm[(j0+2)*nao+(k0+5)];
                fy += gout13y * dm[(j0+2)*nao+(k0+5)];
                fz += gout13z * dm[(j0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+1)];
                fy = gout2y * dm[(i0+0)*nao+(k0+1)];
                fz = gout2z * dm[(i0+0)*nao+(k0+1)];
                fx += gout11x * dm[(i0+0)*nao+(k0+5)];
                fy += gout11y * dm[(i0+0)*nao+(k0+5)];
                fz += gout11z * dm[(i0+0)*nao+(k0+5)];
                fx += gout0x * dm[(i0+1)*nao+(k0+0)];
                fy += gout0y * dm[(i0+1)*nao+(k0+0)];
                fz += gout0z * dm[(i0+1)*nao+(k0+0)];
                fx += gout9x * dm[(i0+1)*nao+(k0+4)];
                fy += gout9y * dm[(i0+1)*nao+(k0+4)];
                fz += gout9z * dm[(i0+1)*nao+(k0+4)];
                fx += gout7x * dm[(i0+2)*nao+(k0+3)];
                fy += gout7y * dm[(i0+2)*nao+(k0+3)];
                fz += gout7z * dm[(i0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+2)];
                fy = gout5y * dm[(i0+0)*nao+(k0+2)];
                fz = gout5z * dm[(i0+0)*nao+(k0+2)];
                fx += gout3x * dm[(i0+1)*nao+(k0+1)];
                fy += gout3y * dm[(i0+1)*nao+(k0+1)];
                fz += gout3z * dm[(i0+1)*nao+(k0+1)];
                fx += gout12x * dm[(i0+1)*nao+(k0+5)];
                fy += gout12y * dm[(i0+1)*nao+(k0+5)];
                fz += gout12z * dm[(i0+1)*nao+(k0+5)];
                fx += gout1x * dm[(i0+2)*nao+(k0+0)];
                fy += gout1y * dm[(i0+2)*nao+(k0+0)];
                fz += gout1z * dm[(i0+2)*nao+(k0+0)];
                fx += gout10x * dm[(i0+2)*nao+(k0+4)];
                fy += gout10y * dm[(i0+2)*nao+(k0+4)];
                fz += gout10z * dm[(i0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout8x * dm[(i0+0)*nao+(k0+3)];
                fy = gout8y * dm[(i0+0)*nao+(k0+3)];
                fz = gout8z * dm[(i0+0)*nao+(k0+3)];
                fx += gout6x * dm[(i0+1)*nao+(k0+2)];
                fy += gout6y * dm[(i0+1)*nao+(k0+2)];
                fz += gout6z * dm[(i0+1)*nao+(k0+2)];
                fx += gout4x * dm[(i0+2)*nao+(k0+1)];
                fy += gout4y * dm[(i0+2)*nao+(k0+1)];
                fz += gout4z * dm[(i0+2)*nao+(k0+1)];
                fx += gout13x * dm[(i0+2)*nao+(k0+5)];
                fy += gout13y * dm[(i0+2)*nao+(k0+5)];
                fz += gout13z * dm[(i0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout5x * dm[(j0+1)*nao+(l0+0)];
                fy = gout5y * dm[(j0+1)*nao+(l0+0)];
                fz = gout5z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout8x * dm[(j0+2)*nao+(l0+0)];
                fy = gout8y * dm[(j0+2)*nao+(l0+0)];
                fz = gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout11x * dm[(j0+0)*nao+(l0+0)];
                fy = gout11y * dm[(j0+0)*nao+(l0+0)];
                fz = gout11z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+1)*nao+(l0+0)];
                fy = gout3y * dm[(j0+1)*nao+(l0+0)];
                fz = gout3z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+2)*nao+(l0+0)];
                fy = gout6y * dm[(j0+2)*nao+(l0+0)];
                fz = gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+4), fz);
                fx = gout12x * dm[(j0+1)*nao+(l0+0)];
                fy = gout12y * dm[(j0+1)*nao+(l0+0)];
                fz = gout12z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+5), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+2)*nao+(l0+0)];
                fy = gout4y * dm[(j0+2)*nao+(l0+0)];
                fz = gout4z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+0)];
                fy = gout7y * dm[(j0+0)*nao+(l0+0)];
                fz = gout7z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+3), fz);
                fx = gout10x * dm[(j0+1)*nao+(l0+0)];
                fy = gout10y * dm[(j0+1)*nao+(l0+0)];
                fz = gout10z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+4), fz);
                fx = gout13x * dm[(j0+2)*nao+(l0+0)];
                fy = gout13y * dm[(j0+2)*nao+(l0+0)];
                fz = gout13z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+1)*nao+(l0+0)];
                fy = gout0y * dm[(i0+1)*nao+(l0+0)];
                fz = gout0z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout7x * dm[(i0+2)*nao+(l0+0)];
                fy = gout7y * dm[(i0+2)*nao+(l0+0)];
                fz = gout7z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout9x * dm[(i0+1)*nao+(l0+0)];
                fy = gout9y * dm[(i0+1)*nao+(l0+0)];
                fz = gout9z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout11x * dm[(i0+0)*nao+(l0+0)];
                fy = gout11y * dm[(i0+0)*nao+(l0+0)];
                fz = gout11z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                fx = gout1x * dm[(i0+2)*nao+(l0+0)];
                fy = gout1y * dm[(i0+2)*nao+(l0+0)];
                fz = gout1z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+1)*nao+(l0+0)];
                fy = gout3y * dm[(i0+1)*nao+(l0+0)];
                fz = gout3z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout10x * dm[(i0+2)*nao+(l0+0)];
                fy = gout10y * dm[(i0+2)*nao+(l0+0)];
                fz = gout10z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+4), fz);
                fx = gout12x * dm[(i0+1)*nao+(l0+0)];
                fy = gout12y * dm[(i0+1)*nao+(l0+0)];
                fz = gout12z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+5), fz);
                fx = gout4x * dm[(i0+2)*nao+(l0+0)];
                fy = gout4y * dm[(i0+2)*nao+(l0+0)];
                fz = gout4z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout6x * dm[(i0+1)*nao+(l0+0)];
                fy = gout6y * dm[(i0+1)*nao+(l0+0)];
                fz = gout6z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+0)];
                fy = gout8y * dm[(i0+0)*nao+(l0+0)];
                fz = gout8z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+3), fz);
                fx = gout13x * dm[(i0+2)*nao+(l0+0)];
                fy = gout13y * dm[(i0+2)*nao+(l0+0)];
                fz = gout13z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+5), fz);
                break;
                case 2:
                fx = gout4x * dm[(j0+0)*nao+(k0+2)];
                fy = gout4y * dm[(j0+0)*nao+(k0+2)];
                fz = gout4z * dm[(j0+0)*nao+(k0+2)];
                fx += gout7x * dm[(j0+1)*nao+(k0+3)];
                fy += gout7y * dm[(j0+1)*nao+(k0+3)];
                fz += gout7z * dm[(j0+1)*nao+(k0+3)];
                fx += gout1x * dm[(j0+2)*nao+(k0+0)];
                fy += gout1y * dm[(j0+2)*nao+(k0+0)];
                fz += gout1z * dm[(j0+2)*nao+(k0+0)];
                fx += gout10x * dm[(j0+2)*nao+(k0+4)];
                fy += gout10y * dm[(j0+2)*nao+(k0+4)];
                fz += gout10z * dm[(j0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                fx += gout11x * dm[(j0+0)*nao+(k0+5)];
                fy += gout11y * dm[(j0+0)*nao+(k0+5)];
                fz += gout11z * dm[(j0+0)*nao+(k0+5)];
                fx += gout5x * dm[(j0+1)*nao+(k0+2)];
                fy += gout5y * dm[(j0+1)*nao+(k0+2)];
                fz += gout5z * dm[(j0+1)*nao+(k0+2)];
                fx += gout8x * dm[(j0+2)*nao+(k0+3)];
                fy += gout8y * dm[(j0+2)*nao+(k0+3)];
                fz += gout8z * dm[(j0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+4)];
                fy += gout9y * dm[(j0+0)*nao+(k0+4)];
                fz += gout9z * dm[(j0+0)*nao+(k0+4)];
                fx += gout3x * dm[(j0+1)*nao+(k0+1)];
                fy += gout3y * dm[(j0+1)*nao+(k0+1)];
                fz += gout3z * dm[(j0+1)*nao+(k0+1)];
                fx += gout12x * dm[(j0+1)*nao+(k0+5)];
                fy += gout12y * dm[(j0+1)*nao+(k0+5)];
                fz += gout12z * dm[(j0+1)*nao+(k0+5)];
                fx += gout6x * dm[(j0+2)*nao+(k0+2)];
                fy += gout6y * dm[(j0+2)*nao+(k0+2)];
                fz += gout6z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+2)];
                fy = gout4y * dm[(i0+0)*nao+(k0+2)];
                fz = gout4z * dm[(i0+0)*nao+(k0+2)];
                fx += gout2x * dm[(i0+1)*nao+(k0+1)];
                fy += gout2y * dm[(i0+1)*nao+(k0+1)];
                fz += gout2z * dm[(i0+1)*nao+(k0+1)];
                fx += gout11x * dm[(i0+1)*nao+(k0+5)];
                fy += gout11y * dm[(i0+1)*nao+(k0+5)];
                fz += gout11z * dm[(i0+1)*nao+(k0+5)];
                fx += gout0x * dm[(i0+2)*nao+(k0+0)];
                fy += gout0y * dm[(i0+2)*nao+(k0+0)];
                fz += gout0z * dm[(i0+2)*nao+(k0+0)];
                fx += gout9x * dm[(i0+2)*nao+(k0+4)];
                fy += gout9y * dm[(i0+2)*nao+(k0+4)];
                fz += gout9z * dm[(i0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(k0+3)];
                fy = gout7y * dm[(i0+0)*nao+(k0+3)];
                fz = gout7z * dm[(i0+0)*nao+(k0+3)];
                fx += gout5x * dm[(i0+1)*nao+(k0+2)];
                fy += gout5y * dm[(i0+1)*nao+(k0+2)];
                fz += gout5z * dm[(i0+1)*nao+(k0+2)];
                fx += gout3x * dm[(i0+2)*nao+(k0+1)];
                fy += gout3y * dm[(i0+2)*nao+(k0+1)];
                fz += gout3z * dm[(i0+2)*nao+(k0+1)];
                fx += gout12x * dm[(i0+2)*nao+(k0+5)];
                fy += gout12y * dm[(i0+2)*nao+(k0+5)];
                fz += gout12z * dm[(i0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout10x * dm[(i0+0)*nao+(k0+4)];
                fy += gout10y * dm[(i0+0)*nao+(k0+4)];
                fz += gout10z * dm[(i0+0)*nao+(k0+4)];
                fx += gout8x * dm[(i0+1)*nao+(k0+3)];
                fy += gout8y * dm[(i0+1)*nao+(k0+3)];
                fz += gout8z * dm[(i0+1)*nao+(k0+3)];
                fx += gout6x * dm[(i0+2)*nao+(k0+2)];
                fy += gout6y * dm[(i0+2)*nao+(k0+2)];
                fz += gout6z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+2)*nao+(l0+0)];
                fy = gout1y * dm[(j0+2)*nao+(l0+0)];
                fz = gout1z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout7x * dm[(j0+1)*nao+(l0+0)];
                fy = gout7y * dm[(j0+1)*nao+(l0+0)];
                fz = gout7z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout10x * dm[(j0+2)*nao+(l0+0)];
                fy = gout10y * dm[(j0+2)*nao+(l0+0)];
                fz = gout10z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout5x * dm[(j0+1)*nao+(l0+0)];
                fy = gout5y * dm[(j0+1)*nao+(l0+0)];
                fz = gout5z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout8x * dm[(j0+2)*nao+(l0+0)];
                fy = gout8y * dm[(j0+2)*nao+(l0+0)];
                fz = gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+3), fz);
                fx = gout11x * dm[(j0+0)*nao+(l0+0)];
                fy = gout11y * dm[(j0+0)*nao+(l0+0)];
                fz = gout11z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+1)*nao+(l0+0)];
                fy = gout3y * dm[(j0+1)*nao+(l0+0)];
                fz = gout3z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+2)*nao+(l0+0)];
                fy = gout6y * dm[(j0+2)*nao+(l0+0)];
                fz = gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+4), fz);
                fx = gout12x * dm[(j0+1)*nao+(l0+0)];
                fy = gout12y * dm[(j0+1)*nao+(l0+0)];
                fz = gout12z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+2)*nao+(l0+0)];
                fy = gout0y * dm[(i0+2)*nao+(l0+0)];
                fz = gout0z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+1)*nao+(l0+0)];
                fy = gout2y * dm[(i0+1)*nao+(l0+0)];
                fz = gout2z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout9x * dm[(i0+2)*nao+(l0+0)];
                fy = gout9y * dm[(i0+2)*nao+(l0+0)];
                fz = gout9z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout11x * dm[(i0+1)*nao+(l0+0)];
                fy = gout11y * dm[(i0+1)*nao+(l0+0)];
                fz = gout11z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                fx = gout3x * dm[(i0+2)*nao+(l0+0)];
                fy = gout3y * dm[(i0+2)*nao+(l0+0)];
                fz = gout3z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout5x * dm[(i0+1)*nao+(l0+0)];
                fy = gout5y * dm[(i0+1)*nao+(l0+0)];
                fz = gout5z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+3), fz);
                fx = gout12x * dm[(i0+2)*nao+(l0+0)];
                fy = gout12y * dm[(i0+2)*nao+(l0+0)];
                fz = gout12z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+5), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+2)*nao+(l0+0)];
                fy = gout6y * dm[(i0+2)*nao+(l0+0)];
                fz = gout6z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout8x * dm[(i0+1)*nao+(l0+0)];
                fy = gout8y * dm[(i0+1)*nao+(l0+0)];
                fz = gout8z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+3), fz);
                fx = gout10x * dm[(i0+0)*nao+(l0+0)];
                fy = gout10y * dm[(i0+0)*nao+(l0+0)];
                fz = gout10z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+4), fz);
                break;
                case 3:
                fx = gout6x * dm[(j0+0)*nao+(k0+3)];
                fy = gout6y * dm[(j0+0)*nao+(k0+3)];
                fz = gout6z * dm[(j0+0)*nao+(k0+3)];
                fx += gout0x * dm[(j0+1)*nao+(k0+0)];
                fy += gout0y * dm[(j0+1)*nao+(k0+0)];
                fz += gout0z * dm[(j0+1)*nao+(k0+0)];
                fx += gout9x * dm[(j0+1)*nao+(k0+4)];
                fy += gout9y * dm[(j0+1)*nao+(k0+4)];
                fz += gout9z * dm[(j0+1)*nao+(k0+4)];
                fx += gout3x * dm[(j0+2)*nao+(k0+1)];
                fy += gout3y * dm[(j0+2)*nao+(k0+1)];
                fz += gout3z * dm[(j0+2)*nao+(k0+1)];
                fx += gout12x * dm[(j0+2)*nao+(k0+5)];
                fy += gout12y * dm[(j0+2)*nao+(k0+5)];
                fz += gout12z * dm[(j0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+2)];
                fy = gout4y * dm[(j0+0)*nao+(k0+2)];
                fz = gout4z * dm[(j0+0)*nao+(k0+2)];
                fx += gout7x * dm[(j0+1)*nao+(k0+3)];
                fy += gout7y * dm[(j0+1)*nao+(k0+3)];
                fz += gout7z * dm[(j0+1)*nao+(k0+3)];
                fx += gout1x * dm[(j0+2)*nao+(k0+0)];
                fy += gout1y * dm[(j0+2)*nao+(k0+0)];
                fz += gout1z * dm[(j0+2)*nao+(k0+0)];
                fx += gout10x * dm[(j0+2)*nao+(k0+4)];
                fy += gout10y * dm[(j0+2)*nao+(k0+4)];
                fz += gout10z * dm[(j0+2)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                fx += gout11x * dm[(j0+0)*nao+(k0+5)];
                fy += gout11y * dm[(j0+0)*nao+(k0+5)];
                fz += gout11z * dm[(j0+0)*nao+(k0+5)];
                fx += gout5x * dm[(j0+1)*nao+(k0+2)];
                fy += gout5y * dm[(j0+1)*nao+(k0+2)];
                fz += gout5z * dm[(j0+1)*nao+(k0+2)];
                fx += gout8x * dm[(j0+2)*nao+(k0+3)];
                fy += gout8y * dm[(j0+2)*nao+(k0+3)];
                fz += gout8z * dm[(j0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+3)];
                fy = gout6y * dm[(i0+0)*nao+(k0+3)];
                fz = gout6z * dm[(i0+0)*nao+(k0+3)];
                fx += gout4x * dm[(i0+1)*nao+(k0+2)];
                fy += gout4y * dm[(i0+1)*nao+(k0+2)];
                fz += gout4z * dm[(i0+1)*nao+(k0+2)];
                fx += gout2x * dm[(i0+2)*nao+(k0+1)];
                fy += gout2y * dm[(i0+2)*nao+(k0+1)];
                fz += gout2z * dm[(i0+2)*nao+(k0+1)];
                fx += gout11x * dm[(i0+2)*nao+(k0+5)];
                fy += gout11y * dm[(i0+2)*nao+(k0+5)];
                fz += gout11z * dm[(i0+2)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout9x * dm[(i0+0)*nao+(k0+4)];
                fy += gout9y * dm[(i0+0)*nao+(k0+4)];
                fz += gout9z * dm[(i0+0)*nao+(k0+4)];
                fx += gout7x * dm[(i0+1)*nao+(k0+3)];
                fy += gout7y * dm[(i0+1)*nao+(k0+3)];
                fz += gout7z * dm[(i0+1)*nao+(k0+3)];
                fx += gout5x * dm[(i0+2)*nao+(k0+2)];
                fy += gout5y * dm[(i0+2)*nao+(k0+2)];
                fz += gout5z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+1)];
                fy = gout3y * dm[(i0+0)*nao+(k0+1)];
                fz = gout3z * dm[(i0+0)*nao+(k0+1)];
                fx += gout12x * dm[(i0+0)*nao+(k0+5)];
                fy += gout12y * dm[(i0+0)*nao+(k0+5)];
                fz += gout12z * dm[(i0+0)*nao+(k0+5)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout10x * dm[(i0+1)*nao+(k0+4)];
                fy += gout10y * dm[(i0+1)*nao+(k0+4)];
                fz += gout10z * dm[(i0+1)*nao+(k0+4)];
                fx += gout8x * dm[(i0+2)*nao+(k0+3)];
                fy += gout8y * dm[(i0+2)*nao+(k0+3)];
                fz += gout8z * dm[(i0+2)*nao+(k0+3)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+1)*nao+(l0+0)];
                fy = gout0y * dm[(j0+1)*nao+(l0+0)];
                fz = gout0z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+2)*nao+(l0+0)];
                fy = gout3y * dm[(j0+2)*nao+(l0+0)];
                fz = gout3z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout9x * dm[(j0+1)*nao+(l0+0)];
                fy = gout9y * dm[(j0+1)*nao+(l0+0)];
                fz = gout9z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout12x * dm[(j0+2)*nao+(l0+0)];
                fy = gout12y * dm[(j0+2)*nao+(l0+0)];
                fz = gout12z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout1x * dm[(j0+2)*nao+(l0+0)];
                fy = gout1y * dm[(j0+2)*nao+(l0+0)];
                fz = gout1z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout7x * dm[(j0+1)*nao+(l0+0)];
                fy = gout7y * dm[(j0+1)*nao+(l0+0)];
                fz = gout7z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+3), fz);
                fx = gout10x * dm[(j0+2)*nao+(l0+0)];
                fy = gout10y * dm[(j0+2)*nao+(l0+0)];
                fz = gout10z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+4), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout5x * dm[(j0+1)*nao+(l0+0)];
                fy = gout5y * dm[(j0+1)*nao+(l0+0)];
                fz = gout5z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout8x * dm[(j0+2)*nao+(l0+0)];
                fy = gout8y * dm[(j0+2)*nao+(l0+0)];
                fz = gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+3), fz);
                fx = gout11x * dm[(j0+0)*nao+(l0+0)];
                fy = gout11y * dm[(j0+0)*nao+(l0+0)];
                fz = gout11z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+5), fz);
                fx = gout2x * dm[(i0+2)*nao+(l0+0)];
                fy = gout2y * dm[(i0+2)*nao+(l0+0)];
                fz = gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+0)];
                fy = gout4y * dm[(i0+1)*nao+(l0+0)];
                fz = gout4z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout11x * dm[(i0+2)*nao+(l0+0)];
                fy = gout11y * dm[(i0+2)*nao+(l0+0)];
                fz = gout11z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+2)*nao+(l0+0)];
                fy = gout5y * dm[(i0+2)*nao+(l0+0)];
                fz = gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout7x * dm[(i0+1)*nao+(l0+0)];
                fy = gout7y * dm[(i0+1)*nao+(l0+0)];
                fz = gout7z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+3), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+0)];
                fy = gout9y * dm[(i0+0)*nao+(l0+0)];
                fz = gout9z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+4), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout8x * dm[(i0+2)*nao+(l0+0)];
                fy = gout8y * dm[(i0+2)*nao+(l0+0)];
                fz = gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+3), fz);
                fx = gout10x * dm[(i0+1)*nao+(l0+0)];
                fy = gout10y * dm[(i0+1)*nao+(l0+0)];
                fz = gout10z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+4), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+5), fz);
                break;
                }
            }
        }
    }
}
__global__
static void rys_vjk_ip1_1120(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_1120(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_1200(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    ai2 = rjri[5];
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_30x = c0x * trr_20x + 2*b10 * trr_10x;
                    double trr_40x = c0x * trr_30x + 3*b10 * trr_20x;
                    double hrr_3100x = trr_40x - rjri[0] * trr_30x;
                    double hrr_2100x = trr_30x - rjri[0] * trr_20x;
                    double hrr_2200x = hrr_3100x - rjri[0] * hrr_2100x;
                    fx = ai2 * hrr_2200x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double hrr_1100x = trr_20x - rjri[0] * trr_10x;
                    double hrr_0100x = trr_10x - rjri[0] * 1;
                    double hrr_0200x = hrr_1100x - rjri[0] * hrr_0100x;
                    fx -= 1 * hrr_0200x;
                    double hrr_1200x = hrr_2100x - rjri[0] * hrr_1100x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_1200x *  fy  * wt;
                    gout0z += hrr_1200x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1200x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * 1;
                    gout1x +=  fx  * trr_10y * wt;
                    gout1y += hrr_0200x *  fy  * wt;
                    gout1z += hrr_0200x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1200x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout2x +=  fx  * 1 * trr_10z;
                    gout2y += hrr_0200x *  fy  * trr_10z;
                    gout2z += hrr_0200x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_2100x;
                    double hrr_1100y = trr_20y - rjri[1] * trr_10y;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * hrr_0100x;
                    double hrr_0100y = trr_10y - rjri[1] * 1;
                    gout3x +=  fx  * hrr_0100y * wt;
                    gout3y += hrr_1100x *  fy  * wt;
                    gout3z += hrr_1100x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    double trr_30y = c0y * trr_20y + 2*b10 * trr_10y;
                    double hrr_2100y = trr_30y - rjri[1] * trr_20y;
                    fy = ai2 * hrr_2100y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * hrr_0100y;
                    gout4x +=  fx  * hrr_1100y * wt;
                    gout4y += hrr_0100x *  fy  * wt;
                    gout4z += hrr_0100x * hrr_1100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout5x +=  fx  * hrr_0100y * trr_10z;
                    gout5y += hrr_0100x *  fy  * trr_10z;
                    gout5z += hrr_0100x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_2100x;
                    fy = ai2 * trr_10y;
                    double hrr_1100z = trr_20z - rjri[2] * trr_10z;
                    fz = ai2 * hrr_1100z;
                    fx -= 1 * hrr_0100x;
                    double hrr_0100z = trr_10z - rjri[2] * wt;
                    gout6x +=  fx  * 1 * hrr_0100z;
                    gout6y += hrr_1100x *  fy  * hrr_0100z;
                    gout6z += hrr_1100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * hrr_1100z;
                    fy -= 1 * 1;
                    gout7x +=  fx  * trr_10y * hrr_0100z;
                    gout7y += hrr_0100x *  fy  * hrr_0100z;
                    gout7z += hrr_0100x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_10y;
                    double trr_30z = c0z * trr_20z + 2*b10 * trr_10z;
                    double hrr_2100z = trr_30z - rjri[2] * trr_20z;
                    fz = ai2 * hrr_2100z;
                    fz -= 1 * hrr_0100z;
                    gout8x +=  fx  * 1 * hrr_1100z;
                    gout8y += hrr_0100x *  fy  * hrr_1100z;
                    gout8z += hrr_0100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    double hrr_1200y = hrr_2100y - rjri[1] * hrr_1100y;
                    fy = ai2 * hrr_1200y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * 1;
                    double hrr_0200y = hrr_1100y - rjri[1] * hrr_0100y;
                    gout9x +=  fx  * hrr_0200y * wt;
                    gout9y += trr_10x *  fy  * wt;
                    gout9z += trr_10x * hrr_0200y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_40y = c0y * trr_30y + 3*b10 * trr_20y;
                    double hrr_3100y = trr_40y - rjri[1] * trr_30y;
                    double hrr_2200y = hrr_3100y - rjri[1] * hrr_2100y;
                    fy = ai2 * hrr_2200y;
                    fz = ai2 * trr_10z;
                    fy -= 1 * hrr_0200y;
                    gout10x +=  fx  * hrr_1200y * wt;
                    gout10y += 1 *  fy  * wt;
                    gout10z += 1 * hrr_1200y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1200y;
                    fz = ai2 * trr_20z;
                    fz -= 1 * wt;
                    gout11x +=  fx  * hrr_0200y * trr_10z;
                    gout11y += 1 *  fy  * trr_10z;
                    gout11z += 1 * hrr_0200y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * hrr_1100z;
                    fx -= 1 * 1;
                    gout12x +=  fx  * hrr_0100y * hrr_0100z;
                    gout12y += trr_10x *  fy  * hrr_0100z;
                    gout12z += trr_10x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_2100y;
                    fz = ai2 * hrr_1100z;
                    fy -= 1 * hrr_0100y;
                    gout13x +=  fx  * hrr_1100y * hrr_0100z;
                    gout13y += 1 *  fy  * hrr_0100z;
                    gout13z += 1 * hrr_1100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * hrr_2100z;
                    fz -= 1 * hrr_0100z;
                    gout14x +=  fx  * hrr_0100y * hrr_1100z;
                    gout14y += 1 *  fy  * hrr_1100z;
                    gout14z += 1 * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_10y;
                    double hrr_1200z = hrr_2100z - rjri[2] * hrr_1100z;
                    fz = ai2 * hrr_1200z;
                    fx -= 1 * 1;
                    double hrr_0200z = hrr_1100z - rjri[2] * hrr_0100z;
                    gout15x +=  fx  * 1 * hrr_0200z;
                    gout15y += trr_10x *  fy  * hrr_0200z;
                    gout15z += trr_10x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * hrr_1200z;
                    fy -= 1 * 1;
                    gout16x +=  fx  * trr_10y * hrr_0200z;
                    gout16y += 1 *  fy  * hrr_0200z;
                    gout16z += 1 * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_40z = c0z * trr_30z + 3*b10 * trr_20z;
                    double hrr_3100z = trr_40z - rjri[2] * trr_30z;
                    double hrr_2200z = hrr_3100z - rjri[2] * hrr_2100z;
                    fz = ai2 * hrr_2200z;
                    fz -= 1 * hrr_0200z;
                    gout17x +=  fx  * 1 * hrr_1200z;
                    gout17y += 1 *  fy  * hrr_1200z;
                    gout17z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+0)];
                fy = gout6y * dm[(l0+0)*nao+(k0+0)];
                fz = gout6z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout9x * dm[(l0+0)*nao+(k0+0)];
                fy = gout9y * dm[(l0+0)*nao+(k0+0)];
                fz = gout9z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+3), fz);
                fx = gout12x * dm[(l0+0)*nao+(k0+0)];
                fy = gout12y * dm[(l0+0)*nao+(k0+0)];
                fz = gout12z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+4), fz);
                fx = gout15x * dm[(l0+0)*nao+(k0+0)];
                fy = gout15y * dm[(l0+0)*nao+(k0+0)];
                fz = gout15z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+5), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+0)];
                fy = gout7y * dm[(l0+0)*nao+(k0+0)];
                fz = gout7z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout10x * dm[(l0+0)*nao+(k0+0)];
                fy = gout10y * dm[(l0+0)*nao+(k0+0)];
                fz = gout10z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+3), fz);
                fx = gout13x * dm[(l0+0)*nao+(k0+0)];
                fy = gout13y * dm[(l0+0)*nao+(k0+0)];
                fz = gout13z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+4), fz);
                fx = gout16x * dm[(l0+0)*nao+(k0+0)];
                fy = gout16y * dm[(l0+0)*nao+(k0+0)];
                fz = gout16z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+5), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+0)];
                fy = gout8y * dm[(l0+0)*nao+(k0+0)];
                fz = gout8z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout11x * dm[(l0+0)*nao+(k0+0)];
                fy = gout11y * dm[(l0+0)*nao+(k0+0)];
                fz = gout11z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+3), fz);
                fx = gout14x * dm[(l0+0)*nao+(k0+0)];
                fy = gout14y * dm[(l0+0)*nao+(k0+0)];
                fz = gout14z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+4), fz);
                fx = gout17x * dm[(l0+0)*nao+(k0+0)];
                fy = gout17y * dm[(l0+0)*nao+(k0+0)];
                fz = gout17z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+1)];
                fy += gout1y * dm[(j0+0)*nao+(i0+1)];
                fz += gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+2)];
                fy += gout2y * dm[(j0+0)*nao+(i0+2)];
                fz += gout2z * dm[(j0+0)*nao+(i0+2)];
                fx += gout3x * dm[(j0+1)*nao+(i0+0)];
                fy += gout3y * dm[(j0+1)*nao+(i0+0)];
                fz += gout3z * dm[(j0+1)*nao+(i0+0)];
                fx += gout4x * dm[(j0+1)*nao+(i0+1)];
                fy += gout4y * dm[(j0+1)*nao+(i0+1)];
                fz += gout4z * dm[(j0+1)*nao+(i0+1)];
                fx += gout5x * dm[(j0+1)*nao+(i0+2)];
                fy += gout5y * dm[(j0+1)*nao+(i0+2)];
                fz += gout5z * dm[(j0+1)*nao+(i0+2)];
                fx += gout6x * dm[(j0+2)*nao+(i0+0)];
                fy += gout6y * dm[(j0+2)*nao+(i0+0)];
                fz += gout6z * dm[(j0+2)*nao+(i0+0)];
                fx += gout7x * dm[(j0+2)*nao+(i0+1)];
                fy += gout7y * dm[(j0+2)*nao+(i0+1)];
                fz += gout7z * dm[(j0+2)*nao+(i0+1)];
                fx += gout8x * dm[(j0+2)*nao+(i0+2)];
                fy += gout8y * dm[(j0+2)*nao+(i0+2)];
                fz += gout8z * dm[(j0+2)*nao+(i0+2)];
                fx += gout9x * dm[(j0+3)*nao+(i0+0)];
                fy += gout9y * dm[(j0+3)*nao+(i0+0)];
                fz += gout9z * dm[(j0+3)*nao+(i0+0)];
                fx += gout10x * dm[(j0+3)*nao+(i0+1)];
                fy += gout10y * dm[(j0+3)*nao+(i0+1)];
                fz += gout10z * dm[(j0+3)*nao+(i0+1)];
                fx += gout11x * dm[(j0+3)*nao+(i0+2)];
                fy += gout11y * dm[(j0+3)*nao+(i0+2)];
                fz += gout11z * dm[(j0+3)*nao+(i0+2)];
                fx += gout12x * dm[(j0+4)*nao+(i0+0)];
                fy += gout12y * dm[(j0+4)*nao+(i0+0)];
                fz += gout12z * dm[(j0+4)*nao+(i0+0)];
                fx += gout13x * dm[(j0+4)*nao+(i0+1)];
                fy += gout13y * dm[(j0+4)*nao+(i0+1)];
                fz += gout13z * dm[(j0+4)*nao+(i0+1)];
                fx += gout14x * dm[(j0+4)*nao+(i0+2)];
                fy += gout14y * dm[(j0+4)*nao+(i0+2)];
                fz += gout14z * dm[(j0+4)*nao+(i0+2)];
                fx += gout15x * dm[(j0+5)*nao+(i0+0)];
                fy += gout15y * dm[(j0+5)*nao+(i0+0)];
                fz += gout15z * dm[(j0+5)*nao+(i0+0)];
                fx += gout16x * dm[(j0+5)*nao+(i0+1)];
                fy += gout16y * dm[(j0+5)*nao+(i0+1)];
                fz += gout16z * dm[(j0+5)*nao+(i0+1)];
                fx += gout17x * dm[(j0+5)*nao+(i0+2)];
                fy += gout17y * dm[(j0+5)*nao+(i0+2)];
                fz += gout17z * dm[(j0+5)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+1)*nao+(k0+0)];
                fy += gout3y * dm[(j0+1)*nao+(k0+0)];
                fz += gout3z * dm[(j0+1)*nao+(k0+0)];
                fx += gout6x * dm[(j0+2)*nao+(k0+0)];
                fy += gout6y * dm[(j0+2)*nao+(k0+0)];
                fz += gout6z * dm[(j0+2)*nao+(k0+0)];
                fx += gout9x * dm[(j0+3)*nao+(k0+0)];
                fy += gout9y * dm[(j0+3)*nao+(k0+0)];
                fz += gout9z * dm[(j0+3)*nao+(k0+0)];
                fx += gout12x * dm[(j0+4)*nao+(k0+0)];
                fy += gout12y * dm[(j0+4)*nao+(k0+0)];
                fz += gout12z * dm[(j0+4)*nao+(k0+0)];
                fx += gout15x * dm[(j0+5)*nao+(k0+0)];
                fy += gout15y * dm[(j0+5)*nao+(k0+0)];
                fz += gout15z * dm[(j0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+1)*nao+(k0+0)];
                fy += gout4y * dm[(j0+1)*nao+(k0+0)];
                fz += gout4z * dm[(j0+1)*nao+(k0+0)];
                fx += gout7x * dm[(j0+2)*nao+(k0+0)];
                fy += gout7y * dm[(j0+2)*nao+(k0+0)];
                fz += gout7z * dm[(j0+2)*nao+(k0+0)];
                fx += gout10x * dm[(j0+3)*nao+(k0+0)];
                fy += gout10y * dm[(j0+3)*nao+(k0+0)];
                fz += gout10z * dm[(j0+3)*nao+(k0+0)];
                fx += gout13x * dm[(j0+4)*nao+(k0+0)];
                fy += gout13y * dm[(j0+4)*nao+(k0+0)];
                fz += gout13z * dm[(j0+4)*nao+(k0+0)];
                fx += gout16x * dm[(j0+5)*nao+(k0+0)];
                fy += gout16y * dm[(j0+5)*nao+(k0+0)];
                fz += gout16z * dm[(j0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+0)];
                fy = gout2y * dm[(j0+0)*nao+(k0+0)];
                fz = gout2z * dm[(j0+0)*nao+(k0+0)];
                fx += gout5x * dm[(j0+1)*nao+(k0+0)];
                fy += gout5y * dm[(j0+1)*nao+(k0+0)];
                fz += gout5z * dm[(j0+1)*nao+(k0+0)];
                fx += gout8x * dm[(j0+2)*nao+(k0+0)];
                fy += gout8y * dm[(j0+2)*nao+(k0+0)];
                fz += gout8z * dm[(j0+2)*nao+(k0+0)];
                fx += gout11x * dm[(j0+3)*nao+(k0+0)];
                fy += gout11y * dm[(j0+3)*nao+(k0+0)];
                fz += gout11z * dm[(j0+3)*nao+(k0+0)];
                fx += gout14x * dm[(j0+4)*nao+(k0+0)];
                fy += gout14y * dm[(j0+4)*nao+(k0+0)];
                fz += gout14z * dm[(j0+4)*nao+(k0+0)];
                fx += gout17x * dm[(j0+5)*nao+(k0+0)];
                fy += gout17y * dm[(j0+5)*nao+(k0+0)];
                fz += gout17z * dm[(j0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+0)];
                fy = gout3y * dm[(i0+0)*nao+(k0+0)];
                fz = gout3z * dm[(i0+0)*nao+(k0+0)];
                fx += gout4x * dm[(i0+1)*nao+(k0+0)];
                fy += gout4y * dm[(i0+1)*nao+(k0+0)];
                fz += gout4z * dm[(i0+1)*nao+(k0+0)];
                fx += gout5x * dm[(i0+2)*nao+(k0+0)];
                fy += gout5y * dm[(i0+2)*nao+(k0+0)];
                fz += gout5z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+0)];
                fy = gout6y * dm[(i0+0)*nao+(k0+0)];
                fz = gout6z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+1)*nao+(k0+0)];
                fy += gout7y * dm[(i0+1)*nao+(k0+0)];
                fz += gout7z * dm[(i0+1)*nao+(k0+0)];
                fx += gout8x * dm[(i0+2)*nao+(k0+0)];
                fy += gout8y * dm[(i0+2)*nao+(k0+0)];
                fz += gout8z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout10x * dm[(i0+1)*nao+(k0+0)];
                fy += gout10y * dm[(i0+1)*nao+(k0+0)];
                fz += gout10z * dm[(i0+1)*nao+(k0+0)];
                fx += gout11x * dm[(i0+2)*nao+(k0+0)];
                fy += gout11y * dm[(i0+2)*nao+(k0+0)];
                fz += gout11z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout12x * dm[(i0+0)*nao+(k0+0)];
                fy = gout12y * dm[(i0+0)*nao+(k0+0)];
                fz = gout12z * dm[(i0+0)*nao+(k0+0)];
                fx += gout13x * dm[(i0+1)*nao+(k0+0)];
                fy += gout13y * dm[(i0+1)*nao+(k0+0)];
                fz += gout13z * dm[(i0+1)*nao+(k0+0)];
                fx += gout14x * dm[(i0+2)*nao+(k0+0)];
                fy += gout14y * dm[(i0+2)*nao+(k0+0)];
                fz += gout14z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout15x * dm[(i0+0)*nao+(k0+0)];
                fy = gout15y * dm[(i0+0)*nao+(k0+0)];
                fz = gout15z * dm[(i0+0)*nao+(k0+0)];
                fx += gout16x * dm[(i0+1)*nao+(k0+0)];
                fy += gout16y * dm[(i0+1)*nao+(k0+0)];
                fz += gout16z * dm[(i0+1)*nao+(k0+0)];
                fx += gout17x * dm[(i0+2)*nao+(k0+0)];
                fy += gout17y * dm[(i0+2)*nao+(k0+0)];
                fz += gout17z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+1)*nao+(l0+0)];
                fy += gout3y * dm[(j0+1)*nao+(l0+0)];
                fz += gout3z * dm[(j0+1)*nao+(l0+0)];
                fx += gout6x * dm[(j0+2)*nao+(l0+0)];
                fy += gout6y * dm[(j0+2)*nao+(l0+0)];
                fz += gout6z * dm[(j0+2)*nao+(l0+0)];
                fx += gout9x * dm[(j0+3)*nao+(l0+0)];
                fy += gout9y * dm[(j0+3)*nao+(l0+0)];
                fz += gout9z * dm[(j0+3)*nao+(l0+0)];
                fx += gout12x * dm[(j0+4)*nao+(l0+0)];
                fy += gout12y * dm[(j0+4)*nao+(l0+0)];
                fz += gout12z * dm[(j0+4)*nao+(l0+0)];
                fx += gout15x * dm[(j0+5)*nao+(l0+0)];
                fy += gout15y * dm[(j0+5)*nao+(l0+0)];
                fz += gout15z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout4x * dm[(j0+1)*nao+(l0+0)];
                fy += gout4y * dm[(j0+1)*nao+(l0+0)];
                fz += gout4z * dm[(j0+1)*nao+(l0+0)];
                fx += gout7x * dm[(j0+2)*nao+(l0+0)];
                fy += gout7y * dm[(j0+2)*nao+(l0+0)];
                fz += gout7z * dm[(j0+2)*nao+(l0+0)];
                fx += gout10x * dm[(j0+3)*nao+(l0+0)];
                fy += gout10y * dm[(j0+3)*nao+(l0+0)];
                fz += gout10z * dm[(j0+3)*nao+(l0+0)];
                fx += gout13x * dm[(j0+4)*nao+(l0+0)];
                fy += gout13y * dm[(j0+4)*nao+(l0+0)];
                fz += gout13z * dm[(j0+4)*nao+(l0+0)];
                fx += gout16x * dm[(j0+5)*nao+(l0+0)];
                fy += gout16y * dm[(j0+5)*nao+(l0+0)];
                fz += gout16z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout5x * dm[(j0+1)*nao+(l0+0)];
                fy += gout5y * dm[(j0+1)*nao+(l0+0)];
                fz += gout5z * dm[(j0+1)*nao+(l0+0)];
                fx += gout8x * dm[(j0+2)*nao+(l0+0)];
                fy += gout8y * dm[(j0+2)*nao+(l0+0)];
                fz += gout8z * dm[(j0+2)*nao+(l0+0)];
                fx += gout11x * dm[(j0+3)*nao+(l0+0)];
                fy += gout11y * dm[(j0+3)*nao+(l0+0)];
                fz += gout11z * dm[(j0+3)*nao+(l0+0)];
                fx += gout14x * dm[(j0+4)*nao+(l0+0)];
                fy += gout14y * dm[(j0+4)*nao+(l0+0)];
                fz += gout14z * dm[(j0+4)*nao+(l0+0)];
                fx += gout17x * dm[(j0+5)*nao+(l0+0)];
                fy += gout17y * dm[(j0+5)*nao+(l0+0)];
                fz += gout17z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+1)*nao+(l0+0)];
                fy += gout1y * dm[(i0+1)*nao+(l0+0)];
                fz += gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout4x * dm[(i0+1)*nao+(l0+0)];
                fy += gout4y * dm[(i0+1)*nao+(l0+0)];
                fz += gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout5x * dm[(i0+2)*nao+(l0+0)];
                fy += gout5y * dm[(i0+2)*nao+(l0+0)];
                fz += gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+1)*nao+(l0+0)];
                fy += gout7y * dm[(i0+1)*nao+(l0+0)];
                fz += gout7z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+2)*nao+(l0+0)];
                fy += gout8y * dm[(i0+2)*nao+(l0+0)];
                fz += gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+0)];
                fy = gout9y * dm[(i0+0)*nao+(l0+0)];
                fz = gout9z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+1)*nao+(l0+0)];
                fy += gout10y * dm[(i0+1)*nao+(l0+0)];
                fz += gout10z * dm[(i0+1)*nao+(l0+0)];
                fx += gout11x * dm[(i0+2)*nao+(l0+0)];
                fy += gout11y * dm[(i0+2)*nao+(l0+0)];
                fz += gout11z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+1)*nao+(l0+0)];
                fy += gout13y * dm[(i0+1)*nao+(l0+0)];
                fz += gout13z * dm[(i0+1)*nao+(l0+0)];
                fx += gout14x * dm[(i0+2)*nao+(l0+0)];
                fy += gout14y * dm[(i0+2)*nao+(l0+0)];
                fz += gout14z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout15x * dm[(i0+0)*nao+(l0+0)];
                fy = gout15y * dm[(i0+0)*nao+(l0+0)];
                fz = gout15z * dm[(i0+0)*nao+(l0+0)];
                fx += gout16x * dm[(i0+1)*nao+(l0+0)];
                fy += gout16y * dm[(i0+1)*nao+(l0+0)];
                fz += gout16z * dm[(i0+1)*nao+(l0+0)];
                fx += gout17x * dm[(i0+2)*nao+(l0+0)];
                fy += gout17y * dm[(i0+2)*nao+(l0+0)];
                fz += gout17z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_1200(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_1200(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_1210(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;
    double *gx = rw + 128 * nroots;
    double *gy = gx + 1152;
    double *gz = gy + 1152;
    double *rlrk = gz + 1152;
    double *Rpq = rlrk + 192;
    if (gout_id == 0) {
        gx[0] = 1.;
        gy[0] = 1.;
    }
    double s0, s1, s2;
    double Ix, Iy, Iz;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        if (gout_id == 0) {
            rlrk[0] = xlxk;
            rlrk[64] = ylyk;
            rlrk[128] = zlzk;
        }
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            __syncthreads();
            double xlxk = rlrk[0];
            double ylyk = rlrk[64];
            double zlzk = rlrk[128];
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xkl = rk[0] + rlrk[0] * al_akl;
                double ykl = rk[1] + rlrk[64] * al_akl;
                double zkl = rk[2] + rlrk[128] * al_akl;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                __syncthreads();
                if (gout_id == 0) {
                    Rpq[0] = xpq;
                    Rpq[64] = ypq;
                    Rpq[128] = zpq;
                }
                rys_roots_rs(nroots, theta, rr, omega, rw, 64, gout_id, 4);
                for (int irys = 0; irys < nroots; ++irys) {
                    __syncthreads();
                    double rt = rw[irys*128];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double rt_akl = rt_aa * aij;
                    double b00 = .5 * rt_aa;
                    for (int n = gout_id; n < 3; n += 4) {
                        if (n == 2) {
                            gz[0] = rw[irys*128+64] * fac;
                        }
                        double *_gx = gx + n * 1152;
                        double xjxi = rjri[n];
                        double Rpa = xjxi * aj_aij;
                        double c0x = Rpa - rt_aij * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = c0x * s0;
                        _gx[64] = s1;
                        s2 = c0x * s1 + 1 * b10 * s0;
                        _gx[128] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 2 * b10 * s0;
                        _gx[192] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 3 * b10 * s0;
                        _gx[256] = s2;
                        double xlxk = rlrk[n*64];
                        double Rqc = xlxk * al_akl;
                        double cpx = Rqc + rt_akl * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = cpx * s0;
                        _gx[576] = s1;
                        s0 = _gx[64];
                        s1 = cpx * s0;
                        s1 += 1 * b00 * _gx[0];
                        _gx[640] = s1;
                        s0 = _gx[128];
                        s1 = cpx * s0;
                        s1 += 2 * b00 * _gx[64];
                        _gx[704] = s1;
                        s0 = _gx[192];
                        s1 = cpx * s0;
                        s1 += 3 * b00 * _gx[128];
                        _gx[768] = s1;
                        s0 = _gx[256];
                        s1 = cpx * s0;
                        s1 += 4 * b00 * _gx[192];
                        _gx[832] = s1;
                        s1 = _gx[256];
                        s0 = _gx[192];
                        _gx[384] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[128];
                        _gx[320] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[256] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[192] = s1 - xjxi * s0;
                        s1 = _gx[384];
                        s0 = _gx[320];
                        _gx[512] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[256];
                        _gx[448] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[192];
                        _gx[384] = s1 - xjxi * s0;
                        s1 = _gx[832];
                        s0 = _gx[768];
                        _gx[960] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[704];
                        _gx[896] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[640];
                        _gx[832] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[576];
                        _gx[768] = s1 - xjxi * s0;
                        s1 = _gx[960];
                        s0 = _gx[896];
                        _gx[1088] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[832];
                        _gx[1024] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[768];
                        _gx[960] = s1 - xjxi * s0;
                    }
                    __syncthreads();
                    switch (gout_id) {
                    case 0:
                    ai2 = rjri[5];
                    Ix = gx[1024];
                    Iy = gy[0];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[1088] - 1 * gx[960]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[256];
                    Iz = gz[0];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[0];
                    Iz = gz[256];
                    gout2x += ai2 * gx[832] * Iy * Iz;
                    gout2y += ai2 * gy[64] * Ix * Iz;
                    gout2z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[192];
                    Iz = gz[192];
                    gout3x += (ai2 * gx[704] - 1 * gx[576]) * Iy * Iz;
                    gout3y += ai2 * gy[256] * Ix * Iz;
                    gout3z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[64];
                    Iz = gz[384];
                    gout4x += ai2 * gx[640] * Iy * Iz;
                    gout4y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout4z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[576];
                    Iz = gz[64];
                    gout5x += ai2 * gx[448] * Iy * Iz;
                    gout5y += ai2 * gy[640] * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[576];
                    Iz = gz[192];
                    gout6x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout6y += ai2 * gy[640] * Ix * Iz;
                    gout6z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[1024];
                    Iz = gz[0];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += (ai2 * gy[1088] - 1 * gy[960]) * Ix * Iz;
                    gout7z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[768];
                    Iz = gz[256];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[832] * Ix * Iz;
                    gout8z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[0];
                    Iz = gz[576];
                    gout9x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[256];
                    Iz = gz[576];
                    gout10x += ai2 * gx[256] * Iy * Iz;
                    gout10y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout10z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[0];
                    Iz = gz[832];
                    gout11x += ai2 * gx[256] * Iy * Iz;
                    gout11y += ai2 * gy[64] * Ix * Iz;
                    gout11z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[192];
                    Iz = gz[768];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += ai2 * gy[256] * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[64];
                    Iz = gz[960];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout13z += ai2 * gz[1024] * Ix * Iy;
                    break;
                    case 1:
                    ai2 = rjri[5];
                    Ix = gx[960];
                    Iy = gy[64];
                    Iz = gz[0];
                    gout0x += ai2 * gx[1024] * Iy * Iz;
                    gout0y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[192];
                    Iz = gz[64];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += ai2 * gy[256] * Ix * Iz;
                    gout1z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[384];
                    Iz = gz[0];
                    gout2x += (ai2 * gx[704] - 1 * gx[576]) * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[256];
                    Iz = gz[192];
                    gout3x += ai2 * gx[640] * Iy * Iz;
                    gout3y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout3z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[0];
                    Iz = gz[448];
                    gout4x += ai2 * gx[640] * Iy * Iz;
                    gout4y += ai2 * gy[64] * Ix * Iz;
                    gout4z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[768];
                    Iz = gz[0];
                    gout5x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout5y += ai2 * gy[832] * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[640];
                    Iz = gz[192];
                    gout6x += ai2 * gx[256] * Iy * Iz;
                    gout6y += (ai2 * gy[704] - 1 * gy[576]) * Ix * Iz;
                    gout6z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[960];
                    Iz = gz[64];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[1024] * Ix * Iz;
                    gout7z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[576];
                    Iz = gz[384];
                    gout8x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout8y += ai2 * gy[640] * Ix * Iz;
                    gout8z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[64];
                    Iz = gz[576];
                    gout9x += ai2 * gx[448] * Iy * Iz;
                    gout9y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout9z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[192];
                    Iz = gz[640];
                    gout10x += ai2 * gx[256] * Iy * Iz;
                    gout10y += ai2 * gy[256] * Ix * Iz;
                    gout10z += (ai2 * gz[704] - 1 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[384];
                    Iz = gz[576];
                    gout11x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout11y += ai2 * gy[448] * Ix * Iz;
                    gout11z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[256];
                    Iz = gz[768];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += (ai2 * gy[320] - 1 * gy[192]) * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[0];
                    Iz = gz[1024];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += ai2 * gy[64] * Ix * Iz;
                    gout13z += (ai2 * gz[1088] - 1 * gz[960]) * Ix * Iy;
                    break;
                    case 2:
                    ai2 = rjri[5];
                    Ix = gx[960];
                    Iy = gy[0];
                    Iz = gz[64];
                    gout0x += ai2 * gx[1024] * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[0];
                    Iz = gz[192];
                    gout1x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout1y += ai2 * gy[64] * Ix * Iz;
                    gout1z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[448];
                    Iz = gz[0];
                    gout2x += ai2 * gx[640] * Iy * Iz;
                    gout2y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[192];
                    Iz = gz[256];
                    gout3x += ai2 * gx[640] * Iy * Iz;
                    gout3y += ai2 * gy[256] * Ix * Iz;
                    gout3z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[448];
                    Iy = gy[576];
                    Iz = gz[0];
                    gout4x += (ai2 * gx[512] - 1 * gx[384]) * Iy * Iz;
                    gout4y += ai2 * gy[640] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[832];
                    Iz = gz[0];
                    gout5x += ai2 * gx[256] * Iy * Iz;
                    gout5y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[576];
                    Iz = gz[256];
                    gout6x += ai2 * gx[256] * Iy * Iz;
                    gout6y += ai2 * gy[640] * Ix * Iz;
                    gout6z += (ai2 * gz[320] - 1 * gz[192]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[768];
                    Iz = gz[192];
                    gout7x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout7y += ai2 * gy[832] * Ix * Iz;
                    gout7z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[640];
                    Iz = gz[384];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += (ai2 * gy[704] - 1 * gy[576]) * Ix * Iz;
                    gout8z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[0];
                    Iz = gz[640];
                    gout9x += ai2 * gx[448] * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += (ai2 * gz[704] - 1 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[0];
                    Iz = gz[768];
                    gout10x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout10y += ai2 * gy[64] * Ix * Iz;
                    gout10z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[448];
                    Iz = gz[576];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += (ai2 * gy[512] - 1 * gy[384]) * Ix * Iz;
                    gout11z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[192];
                    Iz = gz[832];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += ai2 * gy[256] * Ix * Iz;
                    gout12z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    break;
                    case 3:
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[192];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout0y += ai2 * gy[256] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[64];
                    Iz = gz[192];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout1z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[384];
                    Iz = gz[64];
                    gout2x += ai2 * gx[640] * Iy * Iz;
                    gout2y += ai2 * gy[448] * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[0];
                    Iz = gz[384];
                    gout3x += (ai2 * gx[704] - 1 * gx[576]) * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += ai2 * gz[448] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[640];
                    Iz = gz[0];
                    gout4x += ai2 * gx[448] * Iy * Iz;
                    gout4y += (ai2 * gy[704] - 1 * gy[576]) * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[768];
                    Iz = gz[64];
                    gout5x += ai2 * gx[256] * Iy * Iz;
                    gout5y += ai2 * gy[832] * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[960];
                    Iz = gz[0];
                    gout6x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout6y += ai2 * gy[1024] * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[832];
                    Iz = gz[192];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout7z += ai2 * gz[256] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[576];
                    Iz = gz[448];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[640] * Ix * Iz;
                    gout8z += (ai2 * gz[512] - 1 * gz[384]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[192];
                    Iz = gz[576];
                    gout9x += (ai2 * gx[320] - 1 * gx[192]) * Iy * Iz;
                    gout9y += ai2 * gy[256] * Ix * Iz;
                    gout9z += ai2 * gz[640] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[192];
                    Iy = gy[64];
                    Iz = gz[768];
                    gout10x += ai2 * gx[256] * Iy * Iz;
                    gout10y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout10z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[384];
                    Iz = gz[640];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += ai2 * gy[448] * Ix * Iz;
                    gout11z += (ai2 * gz[704] - 1 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[0];
                    Iz = gz[960];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += ai2 * gy[64] * Ix * Iz;
                    gout12z += ai2 * gz[1024] * Ix * Iy;
                    break;
                    }
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+2)];
                fy += gout9y * dm[(l0+0)*nao+(k0+2)];
                fz += gout9z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+1)];
                fy = gout6y * dm[(l0+0)*nao+(k0+1)];
                fz = gout6z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                fx += gout12x * dm[(l0+0)*nao+(k0+2)];
                fy += gout12y * dm[(l0+0)*nao+(k0+2)];
                fz += gout12z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+4), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+2)];
                fy += gout10y * dm[(l0+0)*nao+(k0+2)];
                fz += gout10z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+1)];
                fy = gout7y * dm[(l0+0)*nao+(k0+1)];
                fz = gout7z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+3), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                fx += gout13x * dm[(l0+0)*nao+(k0+2)];
                fy += gout13y * dm[(l0+0)*nao+(k0+2)];
                fz += gout13z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+5), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+1)];
                fy = gout5y * dm[(l0+0)*nao+(k0+1)];
                fz = gout5z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+2)];
                fy += gout11y * dm[(l0+0)*nao+(k0+2)];
                fz += gout11z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+1)];
                fy = gout8y * dm[(l0+0)*nao+(k0+1)];
                fz = gout8z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+4), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+1)*nao+(i0+1)];
                fy += gout1y * dm[(j0+1)*nao+(i0+1)];
                fz += gout1z * dm[(j0+1)*nao+(i0+1)];
                fx += gout2x * dm[(j0+2)*nao+(i0+2)];
                fy += gout2y * dm[(j0+2)*nao+(i0+2)];
                fz += gout2z * dm[(j0+2)*nao+(i0+2)];
                fx += gout3x * dm[(j0+4)*nao+(i0+0)];
                fy += gout3y * dm[(j0+4)*nao+(i0+0)];
                fz += gout3z * dm[(j0+4)*nao+(i0+0)];
                fx += gout4x * dm[(j0+5)*nao+(i0+1)];
                fy += gout4y * dm[(j0+5)*nao+(i0+1)];
                fz += gout4z * dm[(j0+5)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+2)];
                fy = gout5y * dm[(j0+0)*nao+(i0+2)];
                fz = gout5z * dm[(j0+0)*nao+(i0+2)];
                fx += gout6x * dm[(j0+2)*nao+(i0+0)];
                fy += gout6y * dm[(j0+2)*nao+(i0+0)];
                fz += gout6z * dm[(j0+2)*nao+(i0+0)];
                fx += gout7x * dm[(j0+3)*nao+(i0+1)];
                fy += gout7y * dm[(j0+3)*nao+(i0+1)];
                fz += gout7z * dm[(j0+3)*nao+(i0+1)];
                fx += gout8x * dm[(j0+4)*nao+(i0+2)];
                fy += gout8y * dm[(j0+4)*nao+(i0+2)];
                fz += gout8z * dm[(j0+4)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                fx += gout10x * dm[(j0+1)*nao+(i0+1)];
                fy += gout10y * dm[(j0+1)*nao+(i0+1)];
                fz += gout10z * dm[(j0+1)*nao+(i0+1)];
                fx += gout11x * dm[(j0+2)*nao+(i0+2)];
                fy += gout11y * dm[(j0+2)*nao+(i0+2)];
                fz += gout11z * dm[(j0+2)*nao+(i0+2)];
                fx += gout12x * dm[(j0+4)*nao+(i0+0)];
                fy += gout12y * dm[(j0+4)*nao+(i0+0)];
                fz += gout12z * dm[(j0+4)*nao+(i0+0)];
                fx += gout13x * dm[(j0+5)*nao+(i0+1)];
                fy += gout13y * dm[(j0+5)*nao+(i0+1)];
                fz += gout13z * dm[(j0+5)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                break;
                case 1:
                fx = gout5x * dm[(l0+0)*nao+(k0+1)];
                fy = gout5y * dm[(l0+0)*nao+(k0+1)];
                fz = gout5z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+2)];
                fy += gout11y * dm[(l0+0)*nao+(k0+2)];
                fz += gout11z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+3), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+1)];
                fy = gout8y * dm[(l0+0)*nao+(k0+1)];
                fz = gout8z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+5), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+2)];
                fy += gout9y * dm[(l0+0)*nao+(k0+2)];
                fz += gout9z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+1)];
                fy = gout6y * dm[(l0+0)*nao+(k0+1)];
                fz = gout6z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                fx += gout12x * dm[(l0+0)*nao+(k0+2)];
                fy += gout12y * dm[(l0+0)*nao+(k0+2)];
                fz += gout12z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+4), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+2)];
                fy += gout10y * dm[(l0+0)*nao+(k0+2)];
                fz += gout10z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+1)];
                fy = gout7y * dm[(l0+0)*nao+(k0+1)];
                fz = gout7z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+3), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                fx += gout13x * dm[(l0+0)*nao+(k0+2)];
                fy += gout13y * dm[(l0+0)*nao+(k0+2)];
                fz += gout13z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+1)];
                fy = gout0y * dm[(j0+0)*nao+(i0+1)];
                fz = gout0z * dm[(j0+0)*nao+(i0+1)];
                fx += gout1x * dm[(j0+1)*nao+(i0+2)];
                fy += gout1y * dm[(j0+1)*nao+(i0+2)];
                fz += gout1z * dm[(j0+1)*nao+(i0+2)];
                fx += gout2x * dm[(j0+3)*nao+(i0+0)];
                fy += gout2y * dm[(j0+3)*nao+(i0+0)];
                fz += gout2z * dm[(j0+3)*nao+(i0+0)];
                fx += gout3x * dm[(j0+4)*nao+(i0+1)];
                fy += gout3y * dm[(j0+4)*nao+(i0+1)];
                fz += gout3z * dm[(j0+4)*nao+(i0+1)];
                fx += gout4x * dm[(j0+5)*nao+(i0+2)];
                fy += gout4y * dm[(j0+5)*nao+(i0+2)];
                fz += gout4z * dm[(j0+5)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+1)*nao+(i0+0)];
                fy = gout5y * dm[(j0+1)*nao+(i0+0)];
                fz = gout5z * dm[(j0+1)*nao+(i0+0)];
                fx += gout6x * dm[(j0+2)*nao+(i0+1)];
                fy += gout6y * dm[(j0+2)*nao+(i0+1)];
                fz += gout6z * dm[(j0+2)*nao+(i0+1)];
                fx += gout7x * dm[(j0+3)*nao+(i0+2)];
                fy += gout7y * dm[(j0+3)*nao+(i0+2)];
                fz += gout7z * dm[(j0+3)*nao+(i0+2)];
                fx += gout8x * dm[(j0+5)*nao+(i0+0)];
                fy += gout8y * dm[(j0+5)*nao+(i0+0)];
                fz += gout8z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+1)];
                fy = gout9y * dm[(j0+0)*nao+(i0+1)];
                fz = gout9z * dm[(j0+0)*nao+(i0+1)];
                fx += gout10x * dm[(j0+1)*nao+(i0+2)];
                fy += gout10y * dm[(j0+1)*nao+(i0+2)];
                fz += gout10z * dm[(j0+1)*nao+(i0+2)];
                fx += gout11x * dm[(j0+3)*nao+(i0+0)];
                fy += gout11y * dm[(j0+3)*nao+(i0+0)];
                fz += gout11z * dm[(j0+3)*nao+(i0+0)];
                fx += gout12x * dm[(j0+4)*nao+(i0+1)];
                fy += gout12y * dm[(j0+4)*nao+(i0+1)];
                fz += gout12z * dm[(j0+4)*nao+(i0+1)];
                fx += gout13x * dm[(j0+5)*nao+(i0+2)];
                fy += gout13y * dm[(j0+5)*nao+(i0+2)];
                fz += gout13z * dm[(j0+5)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                break;
                case 2:
                fx = gout4x * dm[(l0+0)*nao+(k0+1)];
                fy = gout4y * dm[(l0+0)*nao+(k0+1)];
                fz = gout4z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+2)];
                fy += gout10y * dm[(l0+0)*nao+(k0+2)];
                fz += gout10z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+1)];
                fy = gout7y * dm[(l0+0)*nao+(k0+1)];
                fz = gout7z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+4), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+1)];
                fy = gout5y * dm[(l0+0)*nao+(k0+1)];
                fz = gout5z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+2)];
                fy += gout11y * dm[(l0+0)*nao+(k0+2)];
                fz += gout11z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+3), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+1)];
                fy = gout8y * dm[(l0+0)*nao+(k0+1)];
                fz = gout8z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+5), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+2)];
                fy += gout9y * dm[(l0+0)*nao+(k0+2)];
                fz += gout9z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+1)];
                fy = gout6y * dm[(l0+0)*nao+(k0+1)];
                fz = gout6z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                fx += gout12x * dm[(l0+0)*nao+(k0+2)];
                fy += gout12y * dm[(l0+0)*nao+(k0+2)];
                fz += gout12z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+4), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+2)];
                fy = gout0y * dm[(j0+0)*nao+(i0+2)];
                fz = gout0z * dm[(j0+0)*nao+(i0+2)];
                fx += gout1x * dm[(j0+2)*nao+(i0+0)];
                fy += gout1y * dm[(j0+2)*nao+(i0+0)];
                fz += gout1z * dm[(j0+2)*nao+(i0+0)];
                fx += gout2x * dm[(j0+3)*nao+(i0+1)];
                fy += gout2y * dm[(j0+3)*nao+(i0+1)];
                fz += gout2z * dm[(j0+3)*nao+(i0+1)];
                fx += gout3x * dm[(j0+4)*nao+(i0+2)];
                fy += gout3y * dm[(j0+4)*nao+(i0+2)];
                fz += gout3z * dm[(j0+4)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                fx += gout5x * dm[(j0+1)*nao+(i0+1)];
                fy += gout5y * dm[(j0+1)*nao+(i0+1)];
                fz += gout5z * dm[(j0+1)*nao+(i0+1)];
                fx += gout6x * dm[(j0+2)*nao+(i0+2)];
                fy += gout6y * dm[(j0+2)*nao+(i0+2)];
                fz += gout6z * dm[(j0+2)*nao+(i0+2)];
                fx += gout7x * dm[(j0+4)*nao+(i0+0)];
                fy += gout7y * dm[(j0+4)*nao+(i0+0)];
                fz += gout7z * dm[(j0+4)*nao+(i0+0)];
                fx += gout8x * dm[(j0+5)*nao+(i0+1)];
                fy += gout8y * dm[(j0+5)*nao+(i0+1)];
                fz += gout8z * dm[(j0+5)*nao+(i0+1)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+2)];
                fy = gout9y * dm[(j0+0)*nao+(i0+2)];
                fz = gout9z * dm[(j0+0)*nao+(i0+2)];
                fx += gout10x * dm[(j0+2)*nao+(i0+0)];
                fy += gout10y * dm[(j0+2)*nao+(i0+0)];
                fz += gout10z * dm[(j0+2)*nao+(i0+0)];
                fx += gout11x * dm[(j0+3)*nao+(i0+1)];
                fy += gout11y * dm[(j0+3)*nao+(i0+1)];
                fz += gout11z * dm[(j0+3)*nao+(i0+1)];
                fx += gout12x * dm[(j0+4)*nao+(i0+2)];
                fy += gout12y * dm[(j0+4)*nao+(i0+2)];
                fz += gout12z * dm[(j0+4)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                break;
                case 3:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+2)];
                fy += gout9y * dm[(l0+0)*nao+(k0+2)];
                fz += gout9z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+1)];
                fy = gout6y * dm[(l0+0)*nao+(k0+1)];
                fz = gout6z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+3), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                fx += gout12x * dm[(l0+0)*nao+(k0+2)];
                fy += gout12y * dm[(l0+0)*nao+(k0+2)];
                fz += gout12z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+5), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+1)];
                fy = gout4y * dm[(l0+0)*nao+(k0+1)];
                fz = gout4z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+2)];
                fy += gout10y * dm[(l0+0)*nao+(k0+2)];
                fz += gout10z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+1)];
                fy = gout7y * dm[(l0+0)*nao+(k0+1)];
                fz = gout7z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+4), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+1)];
                fy = gout5y * dm[(l0+0)*nao+(k0+1)];
                fz = gout5z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+2)];
                fy += gout11y * dm[(l0+0)*nao+(k0+2)];
                fz += gout11z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+3), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+1)];
                fy = gout8y * dm[(l0+0)*nao+(k0+1)];
                fz = gout8z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+5), fz);
                fx = gout0x * dm[(j0+1)*nao+(i0+0)];
                fy = gout0y * dm[(j0+1)*nao+(i0+0)];
                fz = gout0z * dm[(j0+1)*nao+(i0+0)];
                fx += gout1x * dm[(j0+2)*nao+(i0+1)];
                fy += gout1y * dm[(j0+2)*nao+(i0+1)];
                fz += gout1z * dm[(j0+2)*nao+(i0+1)];
                fx += gout2x * dm[(j0+3)*nao+(i0+2)];
                fy += gout2y * dm[(j0+3)*nao+(i0+2)];
                fz += gout2z * dm[(j0+3)*nao+(i0+2)];
                fx += gout3x * dm[(j0+5)*nao+(i0+0)];
                fy += gout3y * dm[(j0+5)*nao+(i0+0)];
                fz += gout3z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+1)];
                fy = gout4y * dm[(j0+0)*nao+(i0+1)];
                fz = gout4z * dm[(j0+0)*nao+(i0+1)];
                fx += gout5x * dm[(j0+1)*nao+(i0+2)];
                fy += gout5y * dm[(j0+1)*nao+(i0+2)];
                fz += gout5z * dm[(j0+1)*nao+(i0+2)];
                fx += gout6x * dm[(j0+3)*nao+(i0+0)];
                fy += gout6y * dm[(j0+3)*nao+(i0+0)];
                fz += gout6z * dm[(j0+3)*nao+(i0+0)];
                fx += gout7x * dm[(j0+4)*nao+(i0+1)];
                fy += gout7y * dm[(j0+4)*nao+(i0+1)];
                fz += gout7z * dm[(j0+4)*nao+(i0+1)];
                fx += gout8x * dm[(j0+5)*nao+(i0+2)];
                fy += gout8y * dm[(j0+5)*nao+(i0+2)];
                fz += gout8z * dm[(j0+5)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+1)*nao+(i0+0)];
                fy = gout9y * dm[(j0+1)*nao+(i0+0)];
                fz = gout9z * dm[(j0+1)*nao+(i0+0)];
                fx += gout10x * dm[(j0+2)*nao+(i0+1)];
                fy += gout10y * dm[(j0+2)*nao+(i0+1)];
                fz += gout10z * dm[(j0+2)*nao+(i0+1)];
                fx += gout11x * dm[(j0+3)*nao+(i0+2)];
                fy += gout11y * dm[(j0+3)*nao+(i0+2)];
                fz += gout11z * dm[(j0+3)*nao+(i0+2)];
                fx += gout12x * dm[(j0+5)*nao+(i0+0)];
                fy += gout12y * dm[(j0+5)*nao+(i0+0)];
                fz += gout12z * dm[(j0+5)*nao+(i0+0)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                break;
                }
            }
            if (do_k) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+2)];
                fy += gout9y * dm[(j0+0)*nao+(k0+2)];
                fz += gout9z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+2)*nao+(k0+1)];
                fy += gout6y * dm[(j0+2)*nao+(k0+1)];
                fz += gout6z * dm[(j0+2)*nao+(k0+1)];
                fx += gout3x * dm[(j0+4)*nao+(k0+0)];
                fy += gout3y * dm[(j0+4)*nao+(k0+0)];
                fz += gout3z * dm[(j0+4)*nao+(k0+0)];
                fx += gout12x * dm[(j0+4)*nao+(k0+2)];
                fy += gout12y * dm[(j0+4)*nao+(k0+2)];
                fz += gout12z * dm[(j0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(k0+0)];
                fy = gout1y * dm[(j0+1)*nao+(k0+0)];
                fz = gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout10x * dm[(j0+1)*nao+(k0+2)];
                fy += gout10y * dm[(j0+1)*nao+(k0+2)];
                fz += gout10z * dm[(j0+1)*nao+(k0+2)];
                fx += gout7x * dm[(j0+3)*nao+(k0+1)];
                fy += gout7y * dm[(j0+3)*nao+(k0+1)];
                fz += gout7z * dm[(j0+3)*nao+(k0+1)];
                fx += gout4x * dm[(j0+5)*nao+(k0+0)];
                fy += gout4y * dm[(j0+5)*nao+(k0+0)];
                fz += gout4z * dm[(j0+5)*nao+(k0+0)];
                fx += gout13x * dm[(j0+5)*nao+(k0+2)];
                fy += gout13y * dm[(j0+5)*nao+(k0+2)];
                fz += gout13z * dm[(j0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+1)];
                fy = gout5y * dm[(j0+0)*nao+(k0+1)];
                fz = gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout2x * dm[(j0+2)*nao+(k0+0)];
                fy += gout2y * dm[(j0+2)*nao+(k0+0)];
                fz += gout2z * dm[(j0+2)*nao+(k0+0)];
                fx += gout11x * dm[(j0+2)*nao+(k0+2)];
                fy += gout11y * dm[(j0+2)*nao+(k0+2)];
                fz += gout11z * dm[(j0+2)*nao+(k0+2)];
                fx += gout8x * dm[(j0+4)*nao+(k0+1)];
                fy += gout8y * dm[(j0+4)*nao+(k0+1)];
                fz += gout8z * dm[(j0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout9x * dm[(i0+0)*nao+(k0+2)];
                fy += gout9y * dm[(i0+0)*nao+(k0+2)];
                fz += gout9z * dm[(i0+0)*nao+(k0+2)];
                fx += gout5x * dm[(i0+2)*nao+(k0+1)];
                fy += gout5y * dm[(i0+2)*nao+(k0+1)];
                fz += gout5z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+1)*nao+(k0+0)];
                fy = gout1y * dm[(i0+1)*nao+(k0+0)];
                fz = gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout10x * dm[(i0+1)*nao+(k0+2)];
                fy += gout10y * dm[(i0+1)*nao+(k0+2)];
                fz += gout10z * dm[(i0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+1)];
                fy = gout6y * dm[(i0+0)*nao+(k0+1)];
                fz = gout6z * dm[(i0+0)*nao+(k0+1)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                fx += gout11x * dm[(i0+2)*nao+(k0+2)];
                fy += gout11y * dm[(i0+2)*nao+(k0+2)];
                fz += gout11z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+1)*nao+(k0+1)];
                fy = gout7y * dm[(i0+1)*nao+(k0+1)];
                fz = gout7z * dm[(i0+1)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+0)];
                fy = gout3y * dm[(i0+0)*nao+(k0+0)];
                fz = gout3z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+2)];
                fy += gout12y * dm[(i0+0)*nao+(k0+2)];
                fz += gout12z * dm[(i0+0)*nao+(k0+2)];
                fx += gout8x * dm[(i0+2)*nao+(k0+1)];
                fy += gout8y * dm[(i0+2)*nao+(k0+1)];
                fz += gout8z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+1)*nao+(k0+0)];
                fy = gout4y * dm[(i0+1)*nao+(k0+0)];
                fz = gout4z * dm[(i0+1)*nao+(k0+0)];
                fx += gout13x * dm[(i0+1)*nao+(k0+2)];
                fy += gout13y * dm[(i0+1)*nao+(k0+2)];
                fz += gout13z * dm[(i0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+4)*nao+(l0+0)];
                fy += gout3y * dm[(j0+4)*nao+(l0+0)];
                fz += gout3z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+2)*nao+(l0+0)];
                fy = gout6y * dm[(j0+2)*nao+(l0+0)];
                fz = gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+4)*nao+(l0+0)];
                fy += gout12y * dm[(j0+4)*nao+(l0+0)];
                fz += gout12z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout4x * dm[(j0+5)*nao+(l0+0)];
                fy += gout4y * dm[(j0+5)*nao+(l0+0)];
                fz += gout4z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout7x * dm[(j0+3)*nao+(l0+0)];
                fy = gout7y * dm[(j0+3)*nao+(l0+0)];
                fz = gout7z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout10x * dm[(j0+1)*nao+(l0+0)];
                fy = gout10y * dm[(j0+1)*nao+(l0+0)];
                fz = gout10z * dm[(j0+1)*nao+(l0+0)];
                fx += gout13x * dm[(j0+5)*nao+(l0+0)];
                fy += gout13y * dm[(j0+5)*nao+(l0+0)];
                fz += gout13z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+2)*nao+(l0+0)];
                fy = gout2y * dm[(j0+2)*nao+(l0+0)];
                fz = gout2z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                fx += gout8x * dm[(j0+4)*nao+(l0+0)];
                fy += gout8y * dm[(j0+4)*nao+(l0+0)];
                fz += gout8z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout11x * dm[(j0+2)*nao+(l0+0)];
                fy = gout11y * dm[(j0+2)*nao+(l0+0)];
                fz = gout11z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+2)*nao+(l0+0)];
                fy = gout5y * dm[(i0+2)*nao+(l0+0)];
                fz = gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+0)];
                fy = gout9y * dm[(i0+0)*nao+(l0+0)];
                fz = gout9z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout10x * dm[(i0+1)*nao+(l0+0)];
                fy = gout10y * dm[(i0+1)*nao+(l0+0)];
                fz = gout10z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout2x * dm[(i0+2)*nao+(l0+0)];
                fy = gout2y * dm[(i0+2)*nao+(l0+0)];
                fz = gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout11x * dm[(i0+2)*nao+(l0+0)];
                fy = gout11y * dm[(i0+2)*nao+(l0+0)];
                fz = gout11z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout7x * dm[(i0+1)*nao+(l0+0)];
                fy = gout7y * dm[(i0+1)*nao+(l0+0)];
                fz = gout7z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout8x * dm[(i0+2)*nao+(l0+0)];
                fy = gout8y * dm[(i0+2)*nao+(l0+0)];
                fz = gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+1), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+2), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+0)];
                fy = gout4y * dm[(i0+1)*nao+(l0+0)];
                fz = gout4z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
                fx = gout13x * dm[(i0+1)*nao+(l0+0)];
                fy = gout13y * dm[(i0+1)*nao+(l0+0)];
                fz = gout13z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+2), fz);
                break;
                case 1:
                fx = gout5x * dm[(j0+1)*nao+(k0+1)];
                fy = gout5y * dm[(j0+1)*nao+(k0+1)];
                fz = gout5z * dm[(j0+1)*nao+(k0+1)];
                fx += gout2x * dm[(j0+3)*nao+(k0+0)];
                fy += gout2y * dm[(j0+3)*nao+(k0+0)];
                fz += gout2z * dm[(j0+3)*nao+(k0+0)];
                fx += gout11x * dm[(j0+3)*nao+(k0+2)];
                fy += gout11y * dm[(j0+3)*nao+(k0+2)];
                fz += gout11z * dm[(j0+3)*nao+(k0+2)];
                fx += gout8x * dm[(j0+5)*nao+(k0+1)];
                fy += gout8y * dm[(j0+5)*nao+(k0+1)];
                fz += gout8z * dm[(j0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+2)];
                fy += gout9y * dm[(j0+0)*nao+(k0+2)];
                fz += gout9z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+2)*nao+(k0+1)];
                fy += gout6y * dm[(j0+2)*nao+(k0+1)];
                fz += gout6z * dm[(j0+2)*nao+(k0+1)];
                fx += gout3x * dm[(j0+4)*nao+(k0+0)];
                fy += gout3y * dm[(j0+4)*nao+(k0+0)];
                fz += gout3z * dm[(j0+4)*nao+(k0+0)];
                fx += gout12x * dm[(j0+4)*nao+(k0+2)];
                fy += gout12y * dm[(j0+4)*nao+(k0+2)];
                fz += gout12z * dm[(j0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(k0+0)];
                fy = gout1y * dm[(j0+1)*nao+(k0+0)];
                fz = gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout10x * dm[(j0+1)*nao+(k0+2)];
                fy += gout10y * dm[(j0+1)*nao+(k0+2)];
                fz += gout10z * dm[(j0+1)*nao+(k0+2)];
                fx += gout7x * dm[(j0+3)*nao+(k0+1)];
                fy += gout7y * dm[(j0+3)*nao+(k0+1)];
                fz += gout7z * dm[(j0+3)*nao+(k0+1)];
                fx += gout4x * dm[(j0+5)*nao+(k0+0)];
                fy += gout4y * dm[(j0+5)*nao+(k0+0)];
                fz += gout4z * dm[(j0+5)*nao+(k0+0)];
                fx += gout13x * dm[(j0+5)*nao+(k0+2)];
                fy += gout13y * dm[(j0+5)*nao+(k0+2)];
                fz += gout13z * dm[(j0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+1)*nao+(k0+0)];
                fy = gout0y * dm[(i0+1)*nao+(k0+0)];
                fz = gout0z * dm[(i0+1)*nao+(k0+0)];
                fx += gout9x * dm[(i0+1)*nao+(k0+2)];
                fy += gout9y * dm[(i0+1)*nao+(k0+2)];
                fz += gout9z * dm[(i0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(k0+1)];
                fy = gout5y * dm[(i0+0)*nao+(k0+1)];
                fz = gout5z * dm[(i0+0)*nao+(k0+1)];
                fx += gout1x * dm[(i0+2)*nao+(k0+0)];
                fy += gout1y * dm[(i0+2)*nao+(k0+0)];
                fz += gout1z * dm[(i0+2)*nao+(k0+0)];
                fx += gout10x * dm[(i0+2)*nao+(k0+2)];
                fy += gout10y * dm[(i0+2)*nao+(k0+2)];
                fz += gout10z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+1)*nao+(k0+1)];
                fy = gout6y * dm[(i0+1)*nao+(k0+1)];
                fz = gout6z * dm[(i0+1)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+0)*nao+(k0+0)];
                fy = gout2y * dm[(i0+0)*nao+(k0+0)];
                fz = gout2z * dm[(i0+0)*nao+(k0+0)];
                fx += gout11x * dm[(i0+0)*nao+(k0+2)];
                fy += gout11y * dm[(i0+0)*nao+(k0+2)];
                fz += gout11z * dm[(i0+0)*nao+(k0+2)];
                fx += gout7x * dm[(i0+2)*nao+(k0+1)];
                fy += gout7y * dm[(i0+2)*nao+(k0+1)];
                fz += gout7z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+1)*nao+(k0+0)];
                fy = gout3y * dm[(i0+1)*nao+(k0+0)];
                fz = gout3z * dm[(i0+1)*nao+(k0+0)];
                fx += gout12x * dm[(i0+1)*nao+(k0+2)];
                fy += gout12y * dm[(i0+1)*nao+(k0+2)];
                fz += gout12z * dm[(i0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout8x * dm[(i0+0)*nao+(k0+1)];
                fy = gout8y * dm[(i0+0)*nao+(k0+1)];
                fz = gout8z * dm[(i0+0)*nao+(k0+1)];
                fx += gout4x * dm[(i0+2)*nao+(k0+0)];
                fy += gout4y * dm[(i0+2)*nao+(k0+0)];
                fz += gout4z * dm[(i0+2)*nao+(k0+0)];
                fx += gout13x * dm[(i0+2)*nao+(k0+2)];
                fy += gout13y * dm[(i0+2)*nao+(k0+2)];
                fz += gout13z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+3)*nao+(l0+0)];
                fy = gout2y * dm[(j0+3)*nao+(l0+0)];
                fz = gout2z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+1)*nao+(l0+0)];
                fy = gout5y * dm[(j0+1)*nao+(l0+0)];
                fz = gout5z * dm[(j0+1)*nao+(l0+0)];
                fx += gout8x * dm[(j0+5)*nao+(l0+0)];
                fy += gout8y * dm[(j0+5)*nao+(l0+0)];
                fz += gout8z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout11x * dm[(j0+3)*nao+(l0+0)];
                fy = gout11y * dm[(j0+3)*nao+(l0+0)];
                fz = gout11z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+4)*nao+(l0+0)];
                fy += gout3y * dm[(j0+4)*nao+(l0+0)];
                fz += gout3z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+2)*nao+(l0+0)];
                fy = gout6y * dm[(j0+2)*nao+(l0+0)];
                fz = gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+4)*nao+(l0+0)];
                fy += gout12y * dm[(j0+4)*nao+(l0+0)];
                fz += gout12z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout4x * dm[(j0+5)*nao+(l0+0)];
                fy += gout4y * dm[(j0+5)*nao+(l0+0)];
                fz += gout4z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout7x * dm[(j0+3)*nao+(l0+0)];
                fy = gout7y * dm[(j0+3)*nao+(l0+0)];
                fz = gout7z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout10x * dm[(j0+1)*nao+(l0+0)];
                fy = gout10y * dm[(j0+1)*nao+(l0+0)];
                fz = gout10z * dm[(j0+1)*nao+(l0+0)];
                fx += gout13x * dm[(j0+5)*nao+(l0+0)];
                fy += gout13y * dm[(j0+5)*nao+(l0+0)];
                fz += gout13z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+1)*nao+(l0+0)];
                fy = gout0y * dm[(i0+1)*nao+(l0+0)];
                fz = gout0z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout9x * dm[(i0+1)*nao+(l0+0)];
                fy = gout9y * dm[(i0+1)*nao+(l0+0)];
                fz = gout9z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+2)*nao+(l0+0)];
                fy = gout1y * dm[(i0+2)*nao+(l0+0)];
                fz = gout1z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+0)*nao+(l0+0)];
                fy = gout5y * dm[(i0+0)*nao+(l0+0)];
                fz = gout5z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout10x * dm[(i0+2)*nao+(l0+0)];
                fy = gout10y * dm[(i0+2)*nao+(l0+0)];
                fz = gout10z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout6x * dm[(i0+1)*nao+(l0+0)];
                fy = gout6y * dm[(i0+1)*nao+(l0+0)];
                fz = gout6z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout2x * dm[(i0+0)*nao+(l0+0)];
                fy = gout2y * dm[(i0+0)*nao+(l0+0)];
                fz = gout2z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout7x * dm[(i0+2)*nao+(l0+0)];
                fy = gout7y * dm[(i0+2)*nao+(l0+0)];
                fz = gout7z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+1), fz);
                fx = gout11x * dm[(i0+0)*nao+(l0+0)];
                fy = gout11y * dm[(i0+0)*nao+(l0+0)];
                fz = gout11z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+1)*nao+(l0+0)];
                fy = gout3y * dm[(i0+1)*nao+(l0+0)];
                fz = gout3z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout12x * dm[(i0+1)*nao+(l0+0)];
                fy = gout12y * dm[(i0+1)*nao+(l0+0)];
                fz = gout12z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+2), fz);
                fx = gout4x * dm[(i0+2)*nao+(l0+0)];
                fy = gout4y * dm[(i0+2)*nao+(l0+0)];
                fz = gout4z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
                fx = gout8x * dm[(i0+0)*nao+(l0+0)];
                fy = gout8y * dm[(i0+0)*nao+(l0+0)];
                fz = gout8z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+1), fz);
                fx = gout13x * dm[(i0+2)*nao+(l0+0)];
                fy = gout13y * dm[(i0+2)*nao+(l0+0)];
                fz = gout13z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+2), fz);
                break;
                case 2:
                fx = gout4x * dm[(j0+0)*nao+(k0+1)];
                fy = gout4y * dm[(j0+0)*nao+(k0+1)];
                fz = gout4z * dm[(j0+0)*nao+(k0+1)];
                fx += gout1x * dm[(j0+2)*nao+(k0+0)];
                fy += gout1y * dm[(j0+2)*nao+(k0+0)];
                fz += gout1z * dm[(j0+2)*nao+(k0+0)];
                fx += gout10x * dm[(j0+2)*nao+(k0+2)];
                fy += gout10y * dm[(j0+2)*nao+(k0+2)];
                fz += gout10z * dm[(j0+2)*nao+(k0+2)];
                fx += gout7x * dm[(j0+4)*nao+(k0+1)];
                fy += gout7y * dm[(j0+4)*nao+(k0+1)];
                fz += gout7z * dm[(j0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+1)*nao+(k0+1)];
                fy = gout5y * dm[(j0+1)*nao+(k0+1)];
                fz = gout5z * dm[(j0+1)*nao+(k0+1)];
                fx += gout2x * dm[(j0+3)*nao+(k0+0)];
                fy += gout2y * dm[(j0+3)*nao+(k0+0)];
                fz += gout2z * dm[(j0+3)*nao+(k0+0)];
                fx += gout11x * dm[(j0+3)*nao+(k0+2)];
                fy += gout11y * dm[(j0+3)*nao+(k0+2)];
                fz += gout11z * dm[(j0+3)*nao+(k0+2)];
                fx += gout8x * dm[(j0+5)*nao+(k0+1)];
                fy += gout8y * dm[(j0+5)*nao+(k0+1)];
                fz += gout8z * dm[(j0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+2)];
                fy += gout9y * dm[(j0+0)*nao+(k0+2)];
                fz += gout9z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+2)*nao+(k0+1)];
                fy += gout6y * dm[(j0+2)*nao+(k0+1)];
                fz += gout6z * dm[(j0+2)*nao+(k0+1)];
                fx += gout3x * dm[(j0+4)*nao+(k0+0)];
                fy += gout3y * dm[(j0+4)*nao+(k0+0)];
                fz += gout3z * dm[(j0+4)*nao+(k0+0)];
                fx += gout12x * dm[(j0+4)*nao+(k0+2)];
                fy += gout12y * dm[(j0+4)*nao+(k0+2)];
                fz += gout12z * dm[(j0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+1)];
                fy = gout4y * dm[(i0+0)*nao+(k0+1)];
                fz = gout4z * dm[(i0+0)*nao+(k0+1)];
                fx += gout0x * dm[(i0+2)*nao+(k0+0)];
                fy += gout0y * dm[(i0+2)*nao+(k0+0)];
                fz += gout0z * dm[(i0+2)*nao+(k0+0)];
                fx += gout9x * dm[(i0+2)*nao+(k0+2)];
                fy += gout9y * dm[(i0+2)*nao+(k0+2)];
                fz += gout9z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+1)*nao+(k0+1)];
                fy = gout5y * dm[(i0+1)*nao+(k0+1)];
                fz = gout5z * dm[(i0+1)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout10x * dm[(i0+0)*nao+(k0+2)];
                fy += gout10y * dm[(i0+0)*nao+(k0+2)];
                fz += gout10z * dm[(i0+0)*nao+(k0+2)];
                fx += gout6x * dm[(i0+2)*nao+(k0+1)];
                fy += gout6y * dm[(i0+2)*nao+(k0+1)];
                fz += gout6z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+1)*nao+(k0+0)];
                fy = gout2y * dm[(i0+1)*nao+(k0+0)];
                fz = gout2z * dm[(i0+1)*nao+(k0+0)];
                fx += gout11x * dm[(i0+1)*nao+(k0+2)];
                fy += gout11y * dm[(i0+1)*nao+(k0+2)];
                fz += gout11z * dm[(i0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(k0+1)];
                fy = gout7y * dm[(i0+0)*nao+(k0+1)];
                fz = gout7z * dm[(i0+0)*nao+(k0+1)];
                fx += gout3x * dm[(i0+2)*nao+(k0+0)];
                fy += gout3y * dm[(i0+2)*nao+(k0+0)];
                fz += gout3z * dm[(i0+2)*nao+(k0+0)];
                fx += gout12x * dm[(i0+2)*nao+(k0+2)];
                fy += gout12y * dm[(i0+2)*nao+(k0+2)];
                fz += gout12z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout8x * dm[(i0+1)*nao+(k0+1)];
                fy = gout8y * dm[(i0+1)*nao+(k0+1)];
                fz = gout8z * dm[(i0+1)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+2)*nao+(l0+0)];
                fy = gout1y * dm[(j0+2)*nao+(l0+0)];
                fz = gout1z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout7x * dm[(j0+4)*nao+(l0+0)];
                fy += gout7y * dm[(j0+4)*nao+(l0+0)];
                fz += gout7z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout10x * dm[(j0+2)*nao+(l0+0)];
                fy = gout10y * dm[(j0+2)*nao+(l0+0)];
                fz = gout10z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+3)*nao+(l0+0)];
                fy = gout2y * dm[(j0+3)*nao+(l0+0)];
                fz = gout2z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+1)*nao+(l0+0)];
                fy = gout5y * dm[(j0+1)*nao+(l0+0)];
                fz = gout5z * dm[(j0+1)*nao+(l0+0)];
                fx += gout8x * dm[(j0+5)*nao+(l0+0)];
                fy += gout8y * dm[(j0+5)*nao+(l0+0)];
                fz += gout8z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout11x * dm[(j0+3)*nao+(l0+0)];
                fy = gout11y * dm[(j0+3)*nao+(l0+0)];
                fz = gout11z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+4)*nao+(l0+0)];
                fy += gout3y * dm[(j0+4)*nao+(l0+0)];
                fz += gout3z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+2)*nao+(l0+0)];
                fy = gout6y * dm[(j0+2)*nao+(l0+0)];
                fz = gout6z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+4)*nao+(l0+0)];
                fy += gout12y * dm[(j0+4)*nao+(l0+0)];
                fz += gout12z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+2)*nao+(l0+0)];
                fy = gout0y * dm[(i0+2)*nao+(l0+0)];
                fz = gout0z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout9x * dm[(i0+2)*nao+(l0+0)];
                fy = gout9y * dm[(i0+2)*nao+(l0+0)];
                fz = gout9z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout5x * dm[(i0+1)*nao+(l0+0)];
                fy = gout5y * dm[(i0+1)*nao+(l0+0)];
                fz = gout5z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+2)*nao+(l0+0)];
                fy = gout6y * dm[(i0+2)*nao+(l0+0)];
                fz = gout6z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(l0+0)];
                fy = gout10y * dm[(i0+0)*nao+(l0+0)];
                fz = gout10z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout2x * dm[(i0+1)*nao+(l0+0)];
                fy = gout2y * dm[(i0+1)*nao+(l0+0)];
                fz = gout2z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout11x * dm[(i0+1)*nao+(l0+0)];
                fy = gout11y * dm[(i0+1)*nao+(l0+0)];
                fz = gout11z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+2)*nao+(l0+0)];
                fy = gout3y * dm[(i0+2)*nao+(l0+0)];
                fz = gout3z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+1), fz);
                fx = gout12x * dm[(i0+2)*nao+(l0+0)];
                fy = gout12y * dm[(i0+2)*nao+(l0+0)];
                fz = gout12z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+2), fz);
                fx = gout8x * dm[(i0+1)*nao+(l0+0)];
                fy = gout8y * dm[(i0+1)*nao+(l0+0)];
                fz = gout8z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+1), fz);
                break;
                case 3:
                fx = gout0x * dm[(j0+1)*nao+(k0+0)];
                fy = gout0y * dm[(j0+1)*nao+(k0+0)];
                fz = gout0z * dm[(j0+1)*nao+(k0+0)];
                fx += gout9x * dm[(j0+1)*nao+(k0+2)];
                fy += gout9y * dm[(j0+1)*nao+(k0+2)];
                fz += gout9z * dm[(j0+1)*nao+(k0+2)];
                fx += gout6x * dm[(j0+3)*nao+(k0+1)];
                fy += gout6y * dm[(j0+3)*nao+(k0+1)];
                fz += gout6z * dm[(j0+3)*nao+(k0+1)];
                fx += gout3x * dm[(j0+5)*nao+(k0+0)];
                fy += gout3y * dm[(j0+5)*nao+(k0+0)];
                fz += gout3z * dm[(j0+5)*nao+(k0+0)];
                fx += gout12x * dm[(j0+5)*nao+(k0+2)];
                fy += gout12y * dm[(j0+5)*nao+(k0+2)];
                fz += gout12z * dm[(j0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+1)];
                fy = gout4y * dm[(j0+0)*nao+(k0+1)];
                fz = gout4z * dm[(j0+0)*nao+(k0+1)];
                fx += gout1x * dm[(j0+2)*nao+(k0+0)];
                fy += gout1y * dm[(j0+2)*nao+(k0+0)];
                fz += gout1z * dm[(j0+2)*nao+(k0+0)];
                fx += gout10x * dm[(j0+2)*nao+(k0+2)];
                fy += gout10y * dm[(j0+2)*nao+(k0+2)];
                fz += gout10z * dm[(j0+2)*nao+(k0+2)];
                fx += gout7x * dm[(j0+4)*nao+(k0+1)];
                fy += gout7y * dm[(j0+4)*nao+(k0+1)];
                fz += gout7z * dm[(j0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+1)*nao+(k0+1)];
                fy = gout5y * dm[(j0+1)*nao+(k0+1)];
                fz = gout5z * dm[(j0+1)*nao+(k0+1)];
                fx += gout2x * dm[(j0+3)*nao+(k0+0)];
                fy += gout2y * dm[(j0+3)*nao+(k0+0)];
                fz += gout2z * dm[(j0+3)*nao+(k0+0)];
                fx += gout11x * dm[(j0+3)*nao+(k0+2)];
                fy += gout11y * dm[(j0+3)*nao+(k0+2)];
                fz += gout11z * dm[(j0+3)*nao+(k0+2)];
                fx += gout8x * dm[(j0+5)*nao+(k0+1)];
                fy += gout8y * dm[(j0+5)*nao+(k0+1)];
                fz += gout8z * dm[(j0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+1)*nao+(k0+1)];
                fy = gout4y * dm[(i0+1)*nao+(k0+1)];
                fz = gout4z * dm[(i0+1)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout9x * dm[(i0+0)*nao+(k0+2)];
                fy += gout9y * dm[(i0+0)*nao+(k0+2)];
                fz += gout9z * dm[(i0+0)*nao+(k0+2)];
                fx += gout5x * dm[(i0+2)*nao+(k0+1)];
                fy += gout5y * dm[(i0+2)*nao+(k0+1)];
                fz += gout5z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+1)*nao+(k0+0)];
                fy = gout1y * dm[(i0+1)*nao+(k0+0)];
                fz = gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout10x * dm[(i0+1)*nao+(k0+2)];
                fy += gout10y * dm[(i0+1)*nao+(k0+2)];
                fz += gout10z * dm[(i0+1)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+1)];
                fy = gout6y * dm[(i0+0)*nao+(k0+1)];
                fz = gout6z * dm[(i0+0)*nao+(k0+1)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                fx += gout11x * dm[(i0+2)*nao+(k0+2)];
                fy += gout11y * dm[(i0+2)*nao+(k0+2)];
                fz += gout11z * dm[(i0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+1)*nao+(k0+1)];
                fy = gout7y * dm[(i0+1)*nao+(k0+1)];
                fz = gout7z * dm[(i0+1)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+0)];
                fy = gout3y * dm[(i0+0)*nao+(k0+0)];
                fz = gout3z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+2)];
                fy += gout12y * dm[(i0+0)*nao+(k0+2)];
                fz += gout12z * dm[(i0+0)*nao+(k0+2)];
                fx += gout8x * dm[(i0+2)*nao+(k0+1)];
                fy += gout8y * dm[(i0+2)*nao+(k0+1)];
                fz += gout8z * dm[(i0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+1)*nao+(l0+0)];
                fy = gout0y * dm[(j0+1)*nao+(l0+0)];
                fz = gout0z * dm[(j0+1)*nao+(l0+0)];
                fx += gout3x * dm[(j0+5)*nao+(l0+0)];
                fy += gout3y * dm[(j0+5)*nao+(l0+0)];
                fz += gout3z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+3)*nao+(l0+0)];
                fy = gout6y * dm[(j0+3)*nao+(l0+0)];
                fz = gout6z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout9x * dm[(j0+1)*nao+(l0+0)];
                fy = gout9y * dm[(j0+1)*nao+(l0+0)];
                fz = gout9z * dm[(j0+1)*nao+(l0+0)];
                fx += gout12x * dm[(j0+5)*nao+(l0+0)];
                fy += gout12y * dm[(j0+5)*nao+(l0+0)];
                fz += gout12z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(j0+2)*nao+(l0+0)];
                fy = gout1y * dm[(j0+2)*nao+(l0+0)];
                fz = gout1z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout7x * dm[(j0+4)*nao+(l0+0)];
                fy += gout7y * dm[(j0+4)*nao+(l0+0)];
                fz += gout7z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout10x * dm[(j0+2)*nao+(l0+0)];
                fy = gout10y * dm[(j0+2)*nao+(l0+0)];
                fz = gout10z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+3)*nao+(l0+0)];
                fy = gout2y * dm[(j0+3)*nao+(l0+0)];
                fz = gout2z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+1)*nao+(l0+0)];
                fy = gout5y * dm[(j0+1)*nao+(l0+0)];
                fz = gout5z * dm[(j0+1)*nao+(l0+0)];
                fx += gout8x * dm[(j0+5)*nao+(l0+0)];
                fy += gout8y * dm[(j0+5)*nao+(l0+0)];
                fz += gout8z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout11x * dm[(j0+3)*nao+(l0+0)];
                fy = gout11y * dm[(j0+3)*nao+(l0+0)];
                fz = gout11z * dm[(j0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+0)];
                fy = gout4y * dm[(i0+1)*nao+(l0+0)];
                fz = gout4z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+2)*nao+(l0+0)];
                fy = gout5y * dm[(i0+2)*nao+(l0+0)];
                fz = gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+0)];
                fy = gout9y * dm[(i0+0)*nao+(l0+0)];
                fz = gout9z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout10x * dm[(i0+1)*nao+(l0+0)];
                fy = gout10y * dm[(i0+1)*nao+(l0+0)];
                fz = gout10z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                fx = gout2x * dm[(i0+2)*nao+(l0+0)];
                fy = gout2y * dm[(i0+2)*nao+(l0+0)];
                fz = gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+1), fz);
                fx = gout11x * dm[(i0+2)*nao+(l0+0)];
                fy = gout11y * dm[(i0+2)*nao+(l0+0)];
                fz = gout11z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+2), fz);
                fx = gout7x * dm[(i0+1)*nao+(l0+0)];
                fy = gout7y * dm[(i0+1)*nao+(l0+0)];
                fz = gout7z * dm[(i0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
                fx = gout8x * dm[(i0+2)*nao+(l0+0)];
                fy = gout8y * dm[(i0+2)*nao+(l0+0)];
                fz = gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+1), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+2), fz);
                break;
                }
            }
        }
    }
}
__global__
static void rys_vjk_ip1_1210(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_1210(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_2000(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    ai2 = rjri[5];
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_30x = c0x * trr_20x + 2*b10 * trr_10x;
                    fx = ai2 * trr_30x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    fx -= 2 * trr_10x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += trr_20x *  fy  * wt;
                    gout0z += trr_20x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * 1;
                    fy -= 1 * 1;
                    gout1x +=  fx  * trr_10y * wt;
                    gout1y += trr_10x *  fy  * wt;
                    gout1z += trr_10x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    fz = ai2 * trr_20z;
                    fx -= 1 * 1;
                    fz -= 1 * wt;
                    gout2x +=  fx  * 1 * trr_10z;
                    gout2y += trr_10x *  fy  * trr_10z;
                    gout2z += trr_10x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_30y = c0y * trr_20y + 2*b10 * trr_10y;
                    fy = ai2 * trr_30y;
                    fz = ai2 * trr_10z;
                    fy -= 2 * trr_10y;
                    gout3x +=  fx  * trr_20y * wt;
                    gout3y += 1 *  fy  * wt;
                    gout3z += 1 * trr_20y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_20z;
                    fy -= 1 * 1;
                    fz -= 1 * wt;
                    gout4x +=  fx  * trr_10y * trr_10z;
                    gout4y += 1 *  fy  * trr_10z;
                    gout4z += 1 * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_30z = c0z * trr_20z + 2*b10 * trr_10z;
                    fz = ai2 * trr_30z;
                    fz -= 2 * trr_10z;
                    gout5x +=  fx  * 1 * trr_20z;
                    gout5y += 1 *  fy  * trr_20z;
                    gout5z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+0), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+0), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+1)];
                fy += gout1y * dm[(j0+0)*nao+(i0+1)];
                fz += gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+2)];
                fy += gout2y * dm[(j0+0)*nao+(i0+2)];
                fz += gout2z * dm[(j0+0)*nao+(i0+2)];
                fx += gout3x * dm[(j0+0)*nao+(i0+3)];
                fy += gout3y * dm[(j0+0)*nao+(i0+3)];
                fz += gout3z * dm[(j0+0)*nao+(i0+3)];
                fx += gout4x * dm[(j0+0)*nao+(i0+4)];
                fy += gout4y * dm[(j0+0)*nao+(i0+4)];
                fz += gout4z * dm[(j0+0)*nao+(i0+4)];
                fx += gout5x * dm[(j0+0)*nao+(i0+5)];
                fy += gout5y * dm[(j0+0)*nao+(i0+5)];
                fz += gout5z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+0)];
                fy = gout2y * dm[(j0+0)*nao+(k0+0)];
                fz = gout2z * dm[(j0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(k0+0)];
                fy = gout3y * dm[(j0+0)*nao+(k0+0)];
                fz = gout3z * dm[(j0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+0)];
                fy = gout4y * dm[(j0+0)*nao+(k0+0)];
                fz = gout4z * dm[(j0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+0)];
                fy = gout5y * dm[(j0+0)*nao+(k0+0)];
                fz = gout5z * dm[(j0+0)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                fx += gout3x * dm[(i0+3)*nao+(k0+0)];
                fy += gout3y * dm[(i0+3)*nao+(k0+0)];
                fz += gout3z * dm[(i0+3)*nao+(k0+0)];
                fx += gout4x * dm[(i0+4)*nao+(k0+0)];
                fy += gout4y * dm[(i0+4)*nao+(k0+0)];
                fz += gout4z * dm[(i0+4)*nao+(k0+0)];
                fx += gout5x * dm[(i0+5)*nao+(k0+0)];
                fy += gout5y * dm[(i0+5)*nao+(k0+0)];
                fz += gout5z * dm[(i0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+1)*nao+(l0+0)];
                fy += gout1y * dm[(i0+1)*nao+(l0+0)];
                fz += gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                fx += gout3x * dm[(i0+3)*nao+(l0+0)];
                fy += gout3y * dm[(i0+3)*nao+(l0+0)];
                fz += gout3z * dm[(i0+3)*nao+(l0+0)];
                fx += gout4x * dm[(i0+4)*nao+(l0+0)];
                fy += gout4y * dm[(i0+4)*nao+(l0+0)];
                fz += gout4z * dm[(i0+4)*nao+(l0+0)];
                fx += gout5x * dm[(i0+5)*nao+(l0+0)];
                fy += gout5y * dm[(i0+5)*nao+(l0+0)];
                fz += gout5z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_2000(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_2000(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_2010(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double b00 = .5 * rt_aa;
                    ai2 = rjri[5];
                    double rt_akl = rt_aa * aij;
                    double cpx = xqc + xpq*rt_akl;
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_30x = c0x * trr_20x + 2*b10 * trr_10x;
                    double trr_31x = cpx * trr_30x + 3*b00 * trr_20x;
                    fx = ai2 * trr_31x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double trr_11x = cpx * trr_10x + 1*b00 * 1;
                    fx -= 2 * trr_11x;
                    double trr_21x = cpx * trr_20x + 2*b00 * trr_10x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += trr_21x *  fy  * wt;
                    gout0z += trr_21x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_21x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_10z;
                    double trr_01x = cpx * 1;
                    fx -= 1 * trr_01x;
                    fy -= 1 * 1;
                    gout1x +=  fx  * trr_10y * wt;
                    gout1y += trr_11x *  fy  * wt;
                    gout1z += trr_11x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_21x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    fz = ai2 * trr_20z;
                    fx -= 1 * trr_01x;
                    fz -= 1 * wt;
                    gout2x +=  fx  * 1 * trr_10z;
                    gout2y += trr_11x *  fy  * trr_10z;
                    gout2z += trr_11x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    double trr_30y = c0y * trr_20y + 2*b10 * trr_10y;
                    fy = ai2 * trr_30y;
                    fz = ai2 * trr_10z;
                    fy -= 2 * trr_10y;
                    gout3x +=  fx  * trr_20y * wt;
                    gout3y += trr_01x *  fy  * wt;
                    gout3z += trr_01x * trr_20y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_20z;
                    fy -= 1 * 1;
                    fz -= 1 * wt;
                    gout4x +=  fx  * trr_10y * trr_10z;
                    gout4y += trr_01x *  fy  * trr_10z;
                    gout4z += trr_01x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_11x;
                    fy = ai2 * trr_10y;
                    double trr_30z = c0z * trr_20z + 2*b10 * trr_10z;
                    fz = ai2 * trr_30z;
                    fz -= 2 * trr_10z;
                    gout5x +=  fx  * 1 * trr_20z;
                    gout5y += trr_01x *  fy  * trr_20z;
                    gout5z += trr_01x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_30x;
                    double cpy = yqc + ypq*rt_akl;
                    double trr_11y = cpy * trr_10y + 1*b00 * 1;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_10z;
                    fx -= 2 * trr_10x;
                    double trr_01y = cpy * 1;
                    gout6x +=  fx  * trr_01y * wt;
                    gout6y += trr_20x *  fy  * wt;
                    gout6z += trr_20x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    double trr_21y = cpy * trr_20y + 2*b00 * trr_10y;
                    fy = ai2 * trr_21y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * 1;
                    fy -= 1 * trr_01y;
                    gout7x +=  fx  * trr_11y * wt;
                    gout7y += trr_10x *  fy  * wt;
                    gout7z += trr_10x * trr_11y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_20z;
                    fx -= 1 * 1;
                    fz -= 1 * wt;
                    gout8x +=  fx  * trr_01y * trr_10z;
                    gout8y += trr_10x *  fy  * trr_10z;
                    gout8z += trr_10x * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_31y = cpy * trr_30y + 3*b00 * trr_20y;
                    fy = ai2 * trr_31y;
                    fz = ai2 * trr_10z;
                    fy -= 2 * trr_11y;
                    gout9x +=  fx  * trr_21y * wt;
                    gout9y += 1 *  fy  * wt;
                    gout9z += 1 * trr_21y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_21y;
                    fz = ai2 * trr_20z;
                    fy -= 1 * trr_01y;
                    fz -= 1 * wt;
                    gout10x +=  fx  * trr_11y * trr_10z;
                    gout10y += 1 *  fy  * trr_10z;
                    gout10z += 1 * trr_11y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_11y;
                    fz = ai2 * trr_30z;
                    fz -= 2 * trr_10z;
                    gout11x +=  fx  * trr_01y * trr_20z;
                    gout11y += 1 *  fy  * trr_20z;
                    gout11z += 1 * trr_01y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_30x;
                    fy = ai2 * trr_10y;
                    double cpz = zqc + zpq*rt_akl;
                    double trr_11z = cpz * trr_10z + 1*b00 * wt;
                    fz = ai2 * trr_11z;
                    fx -= 2 * trr_10x;
                    double trr_01z = cpz * wt;
                    gout12x +=  fx  * 1 * trr_01z;
                    gout12y += trr_20x *  fy  * trr_01z;
                    gout12z += trr_20x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_11z;
                    fx -= 1 * 1;
                    fy -= 1 * 1;
                    gout13x +=  fx  * trr_10y * trr_01z;
                    gout13y += trr_10x *  fy  * trr_01z;
                    gout13z += trr_10x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_10y;
                    double trr_21z = cpz * trr_20z + 2*b00 * trr_10z;
                    fz = ai2 * trr_21z;
                    fx -= 1 * 1;
                    fz -= 1 * trr_01z;
                    gout14x +=  fx  * 1 * trr_11z;
                    gout14y += trr_10x *  fy  * trr_11z;
                    gout14z += trr_10x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_30y;
                    fz = ai2 * trr_11z;
                    fy -= 2 * trr_10y;
                    gout15x +=  fx  * trr_20y * trr_01z;
                    gout15y += 1 *  fy  * trr_01z;
                    gout15z += 1 * trr_20y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_21z;
                    fy -= 1 * 1;
                    fz -= 1 * trr_01z;
                    gout16x +=  fx  * trr_10y * trr_11z;
                    gout16y += 1 *  fy  * trr_11z;
                    gout16z += 1 * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_31z = cpz * trr_30z + 3*b00 * trr_20z;
                    fz = ai2 * trr_31z;
                    fz -= 2 * trr_11z;
                    gout17x +=  fx  * 1 * trr_21z;
                    gout17y += 1 *  fy  * trr_21z;
                    gout17z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout6x * dm[(l0+0)*nao+(k0+1)];
                fy += gout6y * dm[(l0+0)*nao+(k0+1)];
                fz += gout6z * dm[(l0+0)*nao+(k0+1)];
                fx += gout12x * dm[(l0+0)*nao+(k0+2)];
                fy += gout12y * dm[(l0+0)*nao+(k0+2)];
                fz += gout12z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout7x * dm[(l0+0)*nao+(k0+1)];
                fy += gout7y * dm[(l0+0)*nao+(k0+1)];
                fz += gout7z * dm[(l0+0)*nao+(k0+1)];
                fx += gout13x * dm[(l0+0)*nao+(k0+2)];
                fy += gout13y * dm[(l0+0)*nao+(k0+2)];
                fz += gout13z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout8x * dm[(l0+0)*nao+(k0+1)];
                fy += gout8y * dm[(l0+0)*nao+(k0+1)];
                fz += gout8z * dm[(l0+0)*nao+(k0+1)];
                fx += gout14x * dm[(l0+0)*nao+(k0+2)];
                fy += gout14y * dm[(l0+0)*nao+(k0+2)];
                fz += gout14z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+1)];
                fy += gout9y * dm[(l0+0)*nao+(k0+1)];
                fz += gout9z * dm[(l0+0)*nao+(k0+1)];
                fx += gout15x * dm[(l0+0)*nao+(k0+2)];
                fy += gout15y * dm[(l0+0)*nao+(k0+2)];
                fz += gout15z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+0), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+1)];
                fy += gout10y * dm[(l0+0)*nao+(k0+1)];
                fz += gout10z * dm[(l0+0)*nao+(k0+1)];
                fx += gout16x * dm[(l0+0)*nao+(k0+2)];
                fy += gout16y * dm[(l0+0)*nao+(k0+2)];
                fz += gout16z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+0), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+1)];
                fy += gout11y * dm[(l0+0)*nao+(k0+1)];
                fz += gout11z * dm[(l0+0)*nao+(k0+1)];
                fx += gout17x * dm[(l0+0)*nao+(k0+2)];
                fy += gout17y * dm[(l0+0)*nao+(k0+2)];
                fz += gout17z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+1)];
                fy += gout1y * dm[(j0+0)*nao+(i0+1)];
                fz += gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+2)];
                fy += gout2y * dm[(j0+0)*nao+(i0+2)];
                fz += gout2z * dm[(j0+0)*nao+(i0+2)];
                fx += gout3x * dm[(j0+0)*nao+(i0+3)];
                fy += gout3y * dm[(j0+0)*nao+(i0+3)];
                fz += gout3z * dm[(j0+0)*nao+(i0+3)];
                fx += gout4x * dm[(j0+0)*nao+(i0+4)];
                fy += gout4y * dm[(j0+0)*nao+(i0+4)];
                fz += gout4z * dm[(j0+0)*nao+(i0+4)];
                fx += gout5x * dm[(j0+0)*nao+(i0+5)];
                fy += gout5y * dm[(j0+0)*nao+(i0+5)];
                fz += gout5z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+0)*nao+(i0+1)];
                fy += gout7y * dm[(j0+0)*nao+(i0+1)];
                fz += gout7z * dm[(j0+0)*nao+(i0+1)];
                fx += gout8x * dm[(j0+0)*nao+(i0+2)];
                fy += gout8y * dm[(j0+0)*nao+(i0+2)];
                fz += gout8z * dm[(j0+0)*nao+(i0+2)];
                fx += gout9x * dm[(j0+0)*nao+(i0+3)];
                fy += gout9y * dm[(j0+0)*nao+(i0+3)];
                fz += gout9z * dm[(j0+0)*nao+(i0+3)];
                fx += gout10x * dm[(j0+0)*nao+(i0+4)];
                fy += gout10y * dm[(j0+0)*nao+(i0+4)];
                fz += gout10z * dm[(j0+0)*nao+(i0+4)];
                fx += gout11x * dm[(j0+0)*nao+(i0+5)];
                fy += gout11y * dm[(j0+0)*nao+(i0+5)];
                fz += gout11z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                fx += gout13x * dm[(j0+0)*nao+(i0+1)];
                fy += gout13y * dm[(j0+0)*nao+(i0+1)];
                fz += gout13z * dm[(j0+0)*nao+(i0+1)];
                fx += gout14x * dm[(j0+0)*nao+(i0+2)];
                fy += gout14y * dm[(j0+0)*nao+(i0+2)];
                fz += gout14z * dm[(j0+0)*nao+(i0+2)];
                fx += gout15x * dm[(j0+0)*nao+(i0+3)];
                fy += gout15y * dm[(j0+0)*nao+(i0+3)];
                fz += gout15z * dm[(j0+0)*nao+(i0+3)];
                fx += gout16x * dm[(j0+0)*nao+(i0+4)];
                fy += gout16y * dm[(j0+0)*nao+(i0+4)];
                fz += gout16z * dm[(j0+0)*nao+(i0+4)];
                fx += gout17x * dm[(j0+0)*nao+(i0+5)];
                fy += gout17y * dm[(j0+0)*nao+(i0+5)];
                fz += gout17z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout6x * dm[(j0+0)*nao+(k0+1)];
                fy += gout6y * dm[(j0+0)*nao+(k0+1)];
                fz += gout6z * dm[(j0+0)*nao+(k0+1)];
                fx += gout12x * dm[(j0+0)*nao+(k0+2)];
                fy += gout12y * dm[(j0+0)*nao+(k0+2)];
                fz += gout12z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+0)*nao+(k0+1)];
                fy += gout7y * dm[(j0+0)*nao+(k0+1)];
                fz += gout7z * dm[(j0+0)*nao+(k0+1)];
                fx += gout13x * dm[(j0+0)*nao+(k0+2)];
                fy += gout13y * dm[(j0+0)*nao+(k0+2)];
                fz += gout13z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+0)];
                fy = gout2y * dm[(j0+0)*nao+(k0+0)];
                fz = gout2z * dm[(j0+0)*nao+(k0+0)];
                fx += gout8x * dm[(j0+0)*nao+(k0+1)];
                fy += gout8y * dm[(j0+0)*nao+(k0+1)];
                fz += gout8z * dm[(j0+0)*nao+(k0+1)];
                fx += gout14x * dm[(j0+0)*nao+(k0+2)];
                fy += gout14y * dm[(j0+0)*nao+(k0+2)];
                fz += gout14z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(k0+0)];
                fy = gout3y * dm[(j0+0)*nao+(k0+0)];
                fz = gout3z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+1)];
                fy += gout9y * dm[(j0+0)*nao+(k0+1)];
                fz += gout9z * dm[(j0+0)*nao+(k0+1)];
                fx += gout15x * dm[(j0+0)*nao+(k0+2)];
                fy += gout15y * dm[(j0+0)*nao+(k0+2)];
                fz += gout15z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+0)];
                fy = gout4y * dm[(j0+0)*nao+(k0+0)];
                fz = gout4z * dm[(j0+0)*nao+(k0+0)];
                fx += gout10x * dm[(j0+0)*nao+(k0+1)];
                fy += gout10y * dm[(j0+0)*nao+(k0+1)];
                fz += gout10z * dm[(j0+0)*nao+(k0+1)];
                fx += gout16x * dm[(j0+0)*nao+(k0+2)];
                fy += gout16y * dm[(j0+0)*nao+(k0+2)];
                fz += gout16z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+0)];
                fy = gout5y * dm[(j0+0)*nao+(k0+0)];
                fz = gout5z * dm[(j0+0)*nao+(k0+0)];
                fx += gout11x * dm[(j0+0)*nao+(k0+1)];
                fy += gout11y * dm[(j0+0)*nao+(k0+1)];
                fz += gout11z * dm[(j0+0)*nao+(k0+1)];
                fx += gout17x * dm[(j0+0)*nao+(k0+2)];
                fy += gout17y * dm[(j0+0)*nao+(k0+2)];
                fz += gout17z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout6x * dm[(i0+0)*nao+(k0+1)];
                fy += gout6y * dm[(i0+0)*nao+(k0+1)];
                fz += gout6z * dm[(i0+0)*nao+(k0+1)];
                fx += gout12x * dm[(i0+0)*nao+(k0+2)];
                fy += gout12y * dm[(i0+0)*nao+(k0+2)];
                fz += gout12z * dm[(i0+0)*nao+(k0+2)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout7x * dm[(i0+1)*nao+(k0+1)];
                fy += gout7y * dm[(i0+1)*nao+(k0+1)];
                fz += gout7z * dm[(i0+1)*nao+(k0+1)];
                fx += gout13x * dm[(i0+1)*nao+(k0+2)];
                fy += gout13y * dm[(i0+1)*nao+(k0+2)];
                fz += gout13z * dm[(i0+1)*nao+(k0+2)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                fx += gout8x * dm[(i0+2)*nao+(k0+1)];
                fy += gout8y * dm[(i0+2)*nao+(k0+1)];
                fz += gout8z * dm[(i0+2)*nao+(k0+1)];
                fx += gout14x * dm[(i0+2)*nao+(k0+2)];
                fy += gout14y * dm[(i0+2)*nao+(k0+2)];
                fz += gout14z * dm[(i0+2)*nao+(k0+2)];
                fx += gout3x * dm[(i0+3)*nao+(k0+0)];
                fy += gout3y * dm[(i0+3)*nao+(k0+0)];
                fz += gout3z * dm[(i0+3)*nao+(k0+0)];
                fx += gout9x * dm[(i0+3)*nao+(k0+1)];
                fy += gout9y * dm[(i0+3)*nao+(k0+1)];
                fz += gout9z * dm[(i0+3)*nao+(k0+1)];
                fx += gout15x * dm[(i0+3)*nao+(k0+2)];
                fy += gout15y * dm[(i0+3)*nao+(k0+2)];
                fz += gout15z * dm[(i0+3)*nao+(k0+2)];
                fx += gout4x * dm[(i0+4)*nao+(k0+0)];
                fy += gout4y * dm[(i0+4)*nao+(k0+0)];
                fz += gout4z * dm[(i0+4)*nao+(k0+0)];
                fx += gout10x * dm[(i0+4)*nao+(k0+1)];
                fy += gout10y * dm[(i0+4)*nao+(k0+1)];
                fz += gout10z * dm[(i0+4)*nao+(k0+1)];
                fx += gout16x * dm[(i0+4)*nao+(k0+2)];
                fy += gout16y * dm[(i0+4)*nao+(k0+2)];
                fz += gout16z * dm[(i0+4)*nao+(k0+2)];
                fx += gout5x * dm[(i0+5)*nao+(k0+0)];
                fy += gout5y * dm[(i0+5)*nao+(k0+0)];
                fz += gout5z * dm[(i0+5)*nao+(k0+0)];
                fx += gout11x * dm[(i0+5)*nao+(k0+1)];
                fy += gout11y * dm[(i0+5)*nao+(k0+1)];
                fz += gout11z * dm[(i0+5)*nao+(k0+1)];
                fx += gout17x * dm[(i0+5)*nao+(k0+2)];
                fy += gout17y * dm[(i0+5)*nao+(k0+2)];
                fz += gout17z * dm[(i0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout12x * dm[(j0+0)*nao+(l0+0)];
                fy = gout12y * dm[(j0+0)*nao+(l0+0)];
                fz = gout12z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+0)];
                fy = gout7y * dm[(j0+0)*nao+(l0+0)];
                fz = gout7z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout13x * dm[(j0+0)*nao+(l0+0)];
                fy = gout13y * dm[(j0+0)*nao+(l0+0)];
                fz = gout13z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+0)];
                fy = gout8y * dm[(j0+0)*nao+(l0+0)];
                fz = gout8z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout14x * dm[(j0+0)*nao+(l0+0)];
                fy = gout14y * dm[(j0+0)*nao+(l0+0)];
                fz = gout14z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+1), fz);
                fx = gout15x * dm[(j0+0)*nao+(l0+0)];
                fy = gout15y * dm[(j0+0)*nao+(l0+0)];
                fz = gout15z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+2), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+0), fz);
                fx = gout10x * dm[(j0+0)*nao+(l0+0)];
                fy = gout10y * dm[(j0+0)*nao+(l0+0)];
                fz = gout10z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+1), fz);
                fx = gout16x * dm[(j0+0)*nao+(l0+0)];
                fy = gout16y * dm[(j0+0)*nao+(l0+0)];
                fz = gout16z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+2), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+0), fz);
                fx = gout11x * dm[(j0+0)*nao+(l0+0)];
                fy = gout11y * dm[(j0+0)*nao+(l0+0)];
                fz = gout11z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+1), fz);
                fx = gout17x * dm[(j0+0)*nao+(l0+0)];
                fy = gout17y * dm[(j0+0)*nao+(l0+0)];
                fz = gout17z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+1)*nao+(l0+0)];
                fy += gout1y * dm[(i0+1)*nao+(l0+0)];
                fz += gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                fx += gout3x * dm[(i0+3)*nao+(l0+0)];
                fy += gout3y * dm[(i0+3)*nao+(l0+0)];
                fz += gout3z * dm[(i0+3)*nao+(l0+0)];
                fx += gout4x * dm[(i0+4)*nao+(l0+0)];
                fy += gout4y * dm[(i0+4)*nao+(l0+0)];
                fz += gout4z * dm[(i0+4)*nao+(l0+0)];
                fx += gout5x * dm[(i0+5)*nao+(l0+0)];
                fy += gout5y * dm[(i0+5)*nao+(l0+0)];
                fz += gout5z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+1)*nao+(l0+0)];
                fy += gout7y * dm[(i0+1)*nao+(l0+0)];
                fz += gout7z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+2)*nao+(l0+0)];
                fy += gout8y * dm[(i0+2)*nao+(l0+0)];
                fz += gout8z * dm[(i0+2)*nao+(l0+0)];
                fx += gout9x * dm[(i0+3)*nao+(l0+0)];
                fy += gout9y * dm[(i0+3)*nao+(l0+0)];
                fz += gout9z * dm[(i0+3)*nao+(l0+0)];
                fx += gout10x * dm[(i0+4)*nao+(l0+0)];
                fy += gout10y * dm[(i0+4)*nao+(l0+0)];
                fz += gout10z * dm[(i0+4)*nao+(l0+0)];
                fx += gout11x * dm[(i0+5)*nao+(l0+0)];
                fy += gout11y * dm[(i0+5)*nao+(l0+0)];
                fz += gout11z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+1)*nao+(l0+0)];
                fy += gout13y * dm[(i0+1)*nao+(l0+0)];
                fz += gout13z * dm[(i0+1)*nao+(l0+0)];
                fx += gout14x * dm[(i0+2)*nao+(l0+0)];
                fy += gout14y * dm[(i0+2)*nao+(l0+0)];
                fz += gout14z * dm[(i0+2)*nao+(l0+0)];
                fx += gout15x * dm[(i0+3)*nao+(l0+0)];
                fy += gout15y * dm[(i0+3)*nao+(l0+0)];
                fz += gout15z * dm[(i0+3)*nao+(l0+0)];
                fx += gout16x * dm[(i0+4)*nao+(l0+0)];
                fy += gout16y * dm[(i0+4)*nao+(l0+0)];
                fz += gout16z * dm[(i0+4)*nao+(l0+0)];
                fx += gout17x * dm[(i0+5)*nao+(l0+0)];
                fy += gout17y * dm[(i0+5)*nao+(l0+0)];
                fz += gout17z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_2010(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_2010(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_2011(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;
    double *gx = rw + 128 * nroots;
    double *gy = gx + 1024;
    double *gz = gy + 1024;
    double *rlrk = gz + 1024;
    double *Rpq = rlrk + 192;
    if (gout_id == 0) {
        gx[0] = 1.;
        gy[0] = 1.;
    }
    double s0, s1, s2;
    double Ix, Iy, Iz;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        if (gout_id == 0) {
            rlrk[0] = xlxk;
            rlrk[64] = ylyk;
            rlrk[128] = zlzk;
        }
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            __syncthreads();
            double xlxk = rlrk[0];
            double ylyk = rlrk[64];
            double zlzk = rlrk[128];
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xkl = rk[0] + rlrk[0] * al_akl;
                double ykl = rk[1] + rlrk[64] * al_akl;
                double zkl = rk[2] + rlrk[128] * al_akl;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                __syncthreads();
                if (gout_id == 0) {
                    Rpq[0] = xpq;
                    Rpq[64] = ypq;
                    Rpq[128] = zpq;
                }
                rys_roots_rs(nroots, theta, rr, omega, rw, 64, gout_id, 4);
                for (int irys = 0; irys < nroots; ++irys) {
                    __syncthreads();
                    double rt = rw[irys*128];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double rt_akl = rt_aa * aij;
                    double b00 = .5 * rt_aa;
                    double b01 = .5/akl * (1 - rt_akl);
                    for (int n = gout_id; n < 3; n += 4) {
                        if (n == 2) {
                            gz[0] = rw[irys*128+64] * fac;
                        }
                        double *_gx = gx + n * 1024;
                        double xjxi = rjri[n];
                        double Rpa = xjxi * aj_aij;
                        double c0x = Rpa - rt_aij * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = c0x * s0;
                        _gx[64] = s1;
                        s2 = c0x * s1 + 1 * b10 * s0;
                        _gx[128] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 2 * b10 * s0;
                        _gx[192] = s2;
                        double xlxk = rlrk[n*64];
                        double Rqc = xlxk * al_akl;
                        double cpx = Rqc + rt_akl * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = cpx * s0;
                        _gx[256] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        _gx[512] = s2;
                        s0 = _gx[64];
                        s1 = cpx * s0;
                        s1 += 1 * b00 * _gx[0];
                        _gx[320] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 1 * b00 * _gx[256];
                        _gx[576] = s2;
                        s0 = _gx[128];
                        s1 = cpx * s0;
                        s1 += 2 * b00 * _gx[64];
                        _gx[384] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 2 * b00 * _gx[320];
                        _gx[640] = s2;
                        s0 = _gx[192];
                        s1 = cpx * s0;
                        s1 += 3 * b00 * _gx[128];
                        _gx[448] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 3 * b00 * _gx[384];
                        _gx[704] = s2;
                        s1 = _gx[512];
                        s0 = _gx[256];
                        _gx[768] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[512] = s1 - xlxk * s0;
                        s1 = _gx[576];
                        s0 = _gx[320];
                        _gx[832] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[576] = s1 - xlxk * s0;
                        s1 = _gx[640];
                        s0 = _gx[384];
                        _gx[896] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[128];
                        _gx[640] = s1 - xlxk * s0;
                        s1 = _gx[704];
                        s0 = _gx[448];
                        _gx[960] = s1 - xlxk * s0;
                        s1 = s0;
                        s0 = _gx[192];
                        _gx[704] = s1 - xlxk * s0;
                    }
                    __syncthreads();
                    switch (gout_id) {
                    case 0:
                    ai2 = rjri[5];
                    Ix = gx[896];
                    Iy = gy[0];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[960] - 2 * gx[832]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[64];
                    Iz = gz[64];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout1z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[256];
                    Iz = gz[64];
                    gout2x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout2y += ai2 * gy[320] * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[0];
                    Iz = gz[256];
                    gout3x += (ai2 * gx[704] - 2 * gx[576]) * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[64];
                    Iz = gz[320];
                    gout4x += ai2 * gx[576] * Iy * Iz;
                    gout4y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout4z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[512];
                    Iz = gz[64];
                    gout5x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout5y += ai2 * gy[576] * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[768];
                    Iz = gz[0];
                    gout6x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout6y += ai2 * gy[832] * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[832];
                    Iz = gz[64];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout7z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[512];
                    Iz = gz[320];
                    gout8x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout8y += ai2 * gy[576] * Ix * Iz;
                    gout8z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[0];
                    Iz = gz[512];
                    gout9x += (ai2 * gx[448] - 2 * gx[320]) * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[64];
                    Iz = gz[576];
                    gout10x += ai2 * gx[320] * Iy * Iz;
                    gout10y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout10z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[256];
                    Iz = gz[576];
                    gout11x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout11y += ai2 * gy[320] * Ix * Iz;
                    gout11z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[0];
                    Iz = gz[768];
                    gout12x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout12y += ai2 * gy[64] * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[64];
                    Iz = gz[832];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout13z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    break;
                    case 1:
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[64];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout0y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[0];
                    Iz = gz[128];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += ai2 * gy[64] * Ix * Iz;
                    gout1z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[384];
                    Iz = gz[0];
                    gout2x += ai2 * gx[576] * Iy * Iz;
                    gout2y += (ai2 * gy[448] - 2 * gy[320]) * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[64];
                    Iz = gz[256];
                    gout3x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout3y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[0];
                    Iz = gz[384];
                    gout4x += ai2 * gx[576] * Iy * Iz;
                    gout4y += ai2 * gy[64] * Ix * Iz;
                    gout4z += (ai2 * gz[448] - 2 * gz[320]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[640];
                    Iz = gz[0];
                    gout5x += ai2 * gx[320] * Iy * Iz;
                    gout5y += (ai2 * gy[704] - 2 * gy[576]) * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[832];
                    Iz = gz[0];
                    gout6x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout6y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[768];
                    Iz = gz[128];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[832] * Ix * Iz;
                    gout7z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[640];
                    Iz = gz[256];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += (ai2 * gy[704] - 2 * gy[576]) * Ix * Iz;
                    gout8z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[64];
                    Iz = gz[512];
                    gout9x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout9y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout9z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[0];
                    Iz = gz[640];
                    gout10x += ai2 * gx[320] * Iy * Iz;
                    gout10y += ai2 * gy[64] * Ix * Iz;
                    gout10z += (ai2 * gz[704] - 2 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[384];
                    Iz = gz[512];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += (ai2 * gy[448] - 2 * gy[320]) * Ix * Iz;
                    gout11z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[64];
                    Iz = gz[768];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[0];
                    Iz = gz[896];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += ai2 * gy[64] * Ix * Iz;
                    gout13z += (ai2 * gz[960] - 2 * gz[832]) * Ix * Iy;
                    break;
                    case 2:
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[0];
                    Iz = gz[64];
                    gout0x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[256];
                    Iz = gz[0];
                    gout1x += (ai2 * gx[704] - 2 * gx[576]) * Iy * Iz;
                    gout1y += ai2 * gy[320] * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[320];
                    Iz = gz[64];
                    gout2x += ai2 * gx[576] * Iy * Iz;
                    gout2y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[0];
                    Iz = gz[320];
                    gout3x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[512];
                    Iz = gz[0];
                    gout4x += (ai2 * gx[448] - 2 * gx[320]) * Iy * Iz;
                    gout4y += ai2 * gy[576] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[576];
                    Iz = gz[64];
                    gout5x += ai2 * gx[320] * Iy * Iz;
                    gout5y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[768];
                    Iz = gz[64];
                    gout6x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout6y += ai2 * gy[832] * Ix * Iz;
                    gout6z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[512];
                    Iz = gz[256];
                    gout7x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout7y += ai2 * gy[576] * Ix * Iz;
                    gout7z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[576];
                    Iz = gz[320];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout8z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[0];
                    Iz = gz[576];
                    gout9x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[256];
                    Iz = gz[512];
                    gout10x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout10y += ai2 * gy[320] * Ix * Iz;
                    gout10z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[320];
                    Iz = gz[576];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout11z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[0];
                    Iz = gz[832];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += ai2 * gy[64] * Ix * Iz;
                    gout12z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    break;
                    case 3:
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[128];
                    Iz = gz[0];
                    gout0x += ai2 * gx[832] * Iy * Iz;
                    gout0y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[320];
                    Iz = gz[0];
                    gout1x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout1y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[256];
                    Iz = gz[128];
                    gout2x += ai2 * gx[576] * Iy * Iz;
                    gout2y += ai2 * gy[320] * Ix * Iz;
                    gout2z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[128];
                    Iz = gz[256];
                    gout3x += ai2 * gx[576] * Iy * Iz;
                    gout3y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[576];
                    Iz = gz[0];
                    gout4x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout4y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[512];
                    Iz = gz[128];
                    gout5x += ai2 * gx[320] * Iy * Iz;
                    gout5y += ai2 * gy[576] * Ix * Iz;
                    gout5z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[896];
                    Iz = gz[0];
                    gout6x += ai2 * gx[64] * Iy * Iz;
                    gout6y += (ai2 * gy[960] - 2 * gy[832]) * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[576];
                    Iz = gz[256];
                    gout7x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout7y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout7z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[512];
                    Iz = gz[384];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[576] * Ix * Iz;
                    gout8z += (ai2 * gz[448] - 2 * gz[320]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[128];
                    Iz = gz[512];
                    gout9x += ai2 * gx[320] * Iy * Iz;
                    gout9y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout9z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[320];
                    Iz = gz[512];
                    gout10x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout10y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout10z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[256];
                    Iz = gz[640];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += ai2 * gy[320] * Ix * Iz;
                    gout11z += (ai2 * gz[704] - 2 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[128];
                    Iz = gz[768];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    break;
                    }
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+1)*nao+(k0+1)];
                fy += gout6y * dm[(l0+1)*nao+(k0+1)];
                fz += gout6z * dm[(l0+1)*nao+(k0+1)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+2)];
                fy += gout12y * dm[(l0+2)*nao+(k0+2)];
                fz += gout12z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+1)*nao+(k0+0)];
                fy += gout5y * dm[(l0+1)*nao+(k0+0)];
                fz += gout5z * dm[(l0+1)*nao+(k0+0)];
                fx += gout8x * dm[(l0+1)*nao+(k0+2)];
                fy += gout8y * dm[(l0+1)*nao+(k0+2)];
                fz += gout8z * dm[(l0+1)*nao+(k0+2)];
                fx += gout11x * dm[(l0+2)*nao+(k0+1)];
                fy += gout11y * dm[(l0+2)*nao+(k0+1)];
                fz += gout11z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+2)];
                fy += gout4y * dm[(l0+0)*nao+(k0+2)];
                fz += gout4z * dm[(l0+0)*nao+(k0+2)];
                fx += gout7x * dm[(l0+1)*nao+(k0+1)];
                fy += gout7y * dm[(l0+1)*nao+(k0+1)];
                fz += gout7z * dm[(l0+1)*nao+(k0+1)];
                fx += gout10x * dm[(l0+2)*nao+(k0+0)];
                fy += gout10y * dm[(l0+2)*nao+(k0+0)];
                fz += gout10z * dm[(l0+2)*nao+(k0+0)];
                fx += gout13x * dm[(l0+2)*nao+(k0+2)];
                fy += gout13y * dm[(l0+2)*nao+(k0+2)];
                fz += gout13z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+4)];
                fy += gout1y * dm[(j0+0)*nao+(i0+4)];
                fz += gout1z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+2)];
                fy = gout2y * dm[(j0+0)*nao+(i0+2)];
                fz = gout2z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                fx += gout4x * dm[(j0+0)*nao+(i0+4)];
                fy += gout4y * dm[(j0+0)*nao+(i0+4)];
                fz += gout4z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+2)];
                fy = gout5y * dm[(j0+0)*nao+(i0+2)];
                fz = gout5z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+0)*nao+(i0+4)];
                fy += gout7y * dm[(j0+0)*nao+(i0+4)];
                fz += gout7z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+2)];
                fy = gout8y * dm[(j0+0)*nao+(i0+2)];
                fz = gout8z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                fx += gout10x * dm[(j0+0)*nao+(i0+4)];
                fy += gout10y * dm[(j0+0)*nao+(i0+4)];
                fz += gout10z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+2)];
                fy = gout11y * dm[(j0+0)*nao+(i0+2)];
                fz = gout11z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+0)];
                fy = gout12y * dm[(j0+0)*nao+(i0+0)];
                fz = gout12z * dm[(j0+0)*nao+(i0+0)];
                fx += gout13x * dm[(j0+0)*nao+(i0+4)];
                fy += gout13y * dm[(j0+0)*nao+(i0+4)];
                fz += gout13z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                case 1:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+1)*nao+(k0+1)];
                fy += gout6y * dm[(l0+1)*nao+(k0+1)];
                fz += gout6z * dm[(l0+1)*nao+(k0+1)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+2)];
                fy += gout12y * dm[(l0+2)*nao+(k0+2)];
                fz += gout12z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+1)*nao+(k0+0)];
                fy += gout5y * dm[(l0+1)*nao+(k0+0)];
                fz += gout5z * dm[(l0+1)*nao+(k0+0)];
                fx += gout8x * dm[(l0+1)*nao+(k0+2)];
                fy += gout8y * dm[(l0+1)*nao+(k0+2)];
                fz += gout8z * dm[(l0+1)*nao+(k0+2)];
                fx += gout11x * dm[(l0+2)*nao+(k0+1)];
                fy += gout11y * dm[(l0+2)*nao+(k0+1)];
                fz += gout11z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+2)];
                fy += gout4y * dm[(l0+0)*nao+(k0+2)];
                fz += gout4z * dm[(l0+0)*nao+(k0+2)];
                fx += gout7x * dm[(l0+1)*nao+(k0+1)];
                fy += gout7y * dm[(l0+1)*nao+(k0+1)];
                fz += gout7z * dm[(l0+1)*nao+(k0+1)];
                fx += gout10x * dm[(l0+2)*nao+(k0+0)];
                fy += gout10y * dm[(l0+2)*nao+(k0+0)];
                fz += gout10z * dm[(l0+2)*nao+(k0+0)];
                fx += gout13x * dm[(l0+2)*nao+(k0+2)];
                fy += gout13y * dm[(l0+2)*nao+(k0+2)];
                fz += gout13z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+1)];
                fy = gout0y * dm[(j0+0)*nao+(i0+1)];
                fz = gout0z * dm[(j0+0)*nao+(i0+1)];
                fx += gout1x * dm[(j0+0)*nao+(i0+5)];
                fy += gout1y * dm[(j0+0)*nao+(i0+5)];
                fz += gout1z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+3)];
                fy = gout2y * dm[(j0+0)*nao+(i0+3)];
                fz = gout2z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+1)];
                fy = gout3y * dm[(j0+0)*nao+(i0+1)];
                fz = gout3z * dm[(j0+0)*nao+(i0+1)];
                fx += gout4x * dm[(j0+0)*nao+(i0+5)];
                fy += gout4y * dm[(j0+0)*nao+(i0+5)];
                fz += gout4z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+3)];
                fy = gout5y * dm[(j0+0)*nao+(i0+3)];
                fz = gout5z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+1)];
                fy = gout6y * dm[(j0+0)*nao+(i0+1)];
                fz = gout6z * dm[(j0+0)*nao+(i0+1)];
                fx += gout7x * dm[(j0+0)*nao+(i0+5)];
                fy += gout7y * dm[(j0+0)*nao+(i0+5)];
                fz += gout7z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+3)];
                fy = gout8y * dm[(j0+0)*nao+(i0+3)];
                fz = gout8z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+1)];
                fy = gout9y * dm[(j0+0)*nao+(i0+1)];
                fz = gout9z * dm[(j0+0)*nao+(i0+1)];
                fx += gout10x * dm[(j0+0)*nao+(i0+5)];
                fy += gout10y * dm[(j0+0)*nao+(i0+5)];
                fz += gout10z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout11x * dm[(j0+0)*nao+(i0+3)];
                fy = gout11y * dm[(j0+0)*nao+(i0+3)];
                fz = gout11z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+1)];
                fy = gout12y * dm[(j0+0)*nao+(i0+1)];
                fz = gout12z * dm[(j0+0)*nao+(i0+1)];
                fx += gout13x * dm[(j0+0)*nao+(i0+5)];
                fy += gout13y * dm[(j0+0)*nao+(i0+5)];
                fz += gout13z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                case 2:
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+1)*nao+(k0+0)];
                fy += gout4y * dm[(l0+1)*nao+(k0+0)];
                fz += gout4z * dm[(l0+1)*nao+(k0+0)];
                fx += gout7x * dm[(l0+1)*nao+(k0+2)];
                fy += gout7y * dm[(l0+1)*nao+(k0+2)];
                fz += gout7z * dm[(l0+1)*nao+(k0+2)];
                fx += gout10x * dm[(l0+2)*nao+(k0+1)];
                fy += gout10y * dm[(l0+2)*nao+(k0+1)];
                fz += gout10z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+1)*nao+(k0+1)];
                fy += gout6y * dm[(l0+1)*nao+(k0+1)];
                fz += gout6z * dm[(l0+1)*nao+(k0+1)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+2)];
                fy += gout12y * dm[(l0+2)*nao+(k0+2)];
                fz += gout12z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+1)*nao+(k0+0)];
                fy += gout5y * dm[(l0+1)*nao+(k0+0)];
                fz += gout5z * dm[(l0+1)*nao+(k0+0)];
                fx += gout8x * dm[(l0+1)*nao+(k0+2)];
                fy += gout8y * dm[(l0+1)*nao+(k0+2)];
                fz += gout8z * dm[(l0+1)*nao+(k0+2)];
                fx += gout11x * dm[(l0+2)*nao+(k0+1)];
                fy += gout11y * dm[(l0+2)*nao+(k0+1)];
                fz += gout11z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+2)];
                fy = gout0y * dm[(j0+0)*nao+(i0+2)];
                fz = gout0z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                fx += gout2x * dm[(j0+0)*nao+(i0+4)];
                fy += gout2y * dm[(j0+0)*nao+(i0+4)];
                fz += gout2z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+2)];
                fy = gout3y * dm[(j0+0)*nao+(i0+2)];
                fz = gout3z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                fx += gout5x * dm[(j0+0)*nao+(i0+4)];
                fy += gout5y * dm[(j0+0)*nao+(i0+4)];
                fz += gout5z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+2)];
                fy = gout6y * dm[(j0+0)*nao+(i0+2)];
                fz = gout6z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+0)];
                fy = gout7y * dm[(j0+0)*nao+(i0+0)];
                fz = gout7z * dm[(j0+0)*nao+(i0+0)];
                fx += gout8x * dm[(j0+0)*nao+(i0+4)];
                fy += gout8y * dm[(j0+0)*nao+(i0+4)];
                fz += gout8z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+2)];
                fy = gout9y * dm[(j0+0)*nao+(i0+2)];
                fz = gout9z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+0)*nao+(i0+0)];
                fy = gout10y * dm[(j0+0)*nao+(i0+0)];
                fz = gout10z * dm[(j0+0)*nao+(i0+0)];
                fx += gout11x * dm[(j0+0)*nao+(i0+4)];
                fy += gout11y * dm[(j0+0)*nao+(i0+4)];
                fz += gout11z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+2)];
                fy = gout12y * dm[(j0+0)*nao+(i0+2)];
                fz = gout12z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                case 3:
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+1)*nao+(k0+0)];
                fy += gout4y * dm[(l0+1)*nao+(k0+0)];
                fz += gout4z * dm[(l0+1)*nao+(k0+0)];
                fx += gout7x * dm[(l0+1)*nao+(k0+2)];
                fy += gout7y * dm[(l0+1)*nao+(k0+2)];
                fz += gout7z * dm[(l0+1)*nao+(k0+2)];
                fx += gout10x * dm[(l0+2)*nao+(k0+1)];
                fy += gout10y * dm[(l0+2)*nao+(k0+1)];
                fz += gout10z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+1)*nao+(k0+1)];
                fy += gout6y * dm[(l0+1)*nao+(k0+1)];
                fz += gout6z * dm[(l0+1)*nao+(k0+1)];
                fx += gout9x * dm[(l0+2)*nao+(k0+0)];
                fy += gout9y * dm[(l0+2)*nao+(k0+0)];
                fz += gout9z * dm[(l0+2)*nao+(k0+0)];
                fx += gout12x * dm[(l0+2)*nao+(k0+2)];
                fy += gout12y * dm[(l0+2)*nao+(k0+2)];
                fz += gout12z * dm[(l0+2)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+1)*nao+(k0+0)];
                fy += gout5y * dm[(l0+1)*nao+(k0+0)];
                fz += gout5z * dm[(l0+1)*nao+(k0+0)];
                fx += gout8x * dm[(l0+1)*nao+(k0+2)];
                fy += gout8y * dm[(l0+1)*nao+(k0+2)];
                fz += gout8z * dm[(l0+1)*nao+(k0+2)];
                fx += gout11x * dm[(l0+2)*nao+(k0+1)];
                fy += gout11y * dm[(l0+2)*nao+(k0+1)];
                fz += gout11z * dm[(l0+2)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+3)];
                fy = gout0y * dm[(j0+0)*nao+(i0+3)];
                fz = gout0z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+1)];
                fy = gout1y * dm[(j0+0)*nao+(i0+1)];
                fz = gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+5)];
                fy += gout2y * dm[(j0+0)*nao+(i0+5)];
                fz += gout2z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+3)];
                fy = gout3y * dm[(j0+0)*nao+(i0+3)];
                fz = gout3z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+1)];
                fy = gout4y * dm[(j0+0)*nao+(i0+1)];
                fz = gout4z * dm[(j0+0)*nao+(i0+1)];
                fx += gout5x * dm[(j0+0)*nao+(i0+5)];
                fy += gout5y * dm[(j0+0)*nao+(i0+5)];
                fz += gout5z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+1), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+3)];
                fy = gout6y * dm[(j0+0)*nao+(i0+3)];
                fz = gout6z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+1)];
                fy = gout7y * dm[(j0+0)*nao+(i0+1)];
                fz = gout7z * dm[(j0+0)*nao+(i0+1)];
                fx += gout8x * dm[(j0+0)*nao+(i0+5)];
                fy += gout8y * dm[(j0+0)*nao+(i0+5)];
                fz += gout8z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+1), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+1), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+3)];
                fy = gout9y * dm[(j0+0)*nao+(i0+3)];
                fz = gout9z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+2), fz);
                fx = gout10x * dm[(j0+0)*nao+(i0+1)];
                fy = gout10y * dm[(j0+0)*nao+(i0+1)];
                fz = gout10z * dm[(j0+0)*nao+(i0+1)];
                fx += gout11x * dm[(j0+0)*nao+(i0+5)];
                fy += gout11y * dm[(j0+0)*nao+(i0+5)];
                fz += gout11z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+2), fz);
                fx = gout12x * dm[(j0+0)*nao+(i0+3)];
                fy = gout12y * dm[(j0+0)*nao+(i0+3)];
                fz = gout12z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+2), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+2), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+2), fz);
                break;
                }
            }
            if (do_k) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+2)];
                fy += gout3y * dm[(j0+0)*nao+(k0+2)];
                fz += gout3z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+1)];
                fy = gout6y * dm[(j0+0)*nao+(k0+1)];
                fz = gout6z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+0)];
                fy = gout9y * dm[(j0+0)*nao+(k0+0)];
                fz = gout9z * dm[(j0+0)*nao+(k0+0)];
                fx += gout12x * dm[(j0+0)*nao+(k0+2)];
                fy += gout12y * dm[(j0+0)*nao+(k0+2)];
                fz += gout12z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+0)];
                fy = gout5y * dm[(j0+0)*nao+(k0+0)];
                fz = gout5z * dm[(j0+0)*nao+(k0+0)];
                fx += gout8x * dm[(j0+0)*nao+(k0+2)];
                fy += gout8y * dm[(j0+0)*nao+(k0+2)];
                fz += gout8z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+1)];
                fy = gout11y * dm[(j0+0)*nao+(k0+1)];
                fz = gout11z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+0)*nao+(k0+2)];
                fy += gout4y * dm[(j0+0)*nao+(k0+2)];
                fz += gout4z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(k0+1)];
                fy = gout7y * dm[(j0+0)*nao+(k0+1)];
                fz = gout7z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(k0+0)];
                fy = gout10y * dm[(j0+0)*nao+(k0+0)];
                fz = gout10z * dm[(j0+0)*nao+(k0+0)];
                fx += gout13x * dm[(j0+0)*nao+(k0+2)];
                fy += gout13y * dm[(j0+0)*nao+(k0+2)];
                fz += gout13z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+2)];
                fy += gout3y * dm[(i0+0)*nao+(k0+2)];
                fz += gout3z * dm[(i0+0)*nao+(k0+2)];
                fx += gout2x * dm[(i0+2)*nao+(k0+1)];
                fy += gout2y * dm[(i0+2)*nao+(k0+1)];
                fz += gout2z * dm[(i0+2)*nao+(k0+1)];
                fx += gout1x * dm[(i0+4)*nao+(k0+0)];
                fy += gout1y * dm[(i0+4)*nao+(k0+0)];
                fz += gout1z * dm[(i0+4)*nao+(k0+0)];
                fx += gout4x * dm[(i0+4)*nao+(k0+2)];
                fy += gout4y * dm[(i0+4)*nao+(k0+2)];
                fz += gout4z * dm[(i0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+1)];
                fy = gout6y * dm[(i0+0)*nao+(k0+1)];
                fz = gout6z * dm[(i0+0)*nao+(k0+1)];
                fx += gout5x * dm[(i0+2)*nao+(k0+0)];
                fy += gout5y * dm[(i0+2)*nao+(k0+0)];
                fz += gout5z * dm[(i0+2)*nao+(k0+0)];
                fx += gout8x * dm[(i0+2)*nao+(k0+2)];
                fy += gout8y * dm[(i0+2)*nao+(k0+2)];
                fz += gout8z * dm[(i0+2)*nao+(k0+2)];
                fx += gout7x * dm[(i0+4)*nao+(k0+1)];
                fy += gout7y * dm[(i0+4)*nao+(k0+1)];
                fz += gout7z * dm[(i0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(k0+0)];
                fy = gout9y * dm[(i0+0)*nao+(k0+0)];
                fz = gout9z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+2)];
                fy += gout12y * dm[(i0+0)*nao+(k0+2)];
                fz += gout12z * dm[(i0+0)*nao+(k0+2)];
                fx += gout11x * dm[(i0+2)*nao+(k0+1)];
                fy += gout11y * dm[(i0+2)*nao+(k0+1)];
                fz += gout11z * dm[(i0+2)*nao+(k0+1)];
                fx += gout10x * dm[(i0+4)*nao+(k0+0)];
                fy += gout10y * dm[(i0+4)*nao+(k0+0)];
                fz += gout10z * dm[(i0+4)*nao+(k0+0)];
                fx += gout13x * dm[(i0+4)*nao+(k0+2)];
                fy += gout13y * dm[(i0+4)*nao+(k0+2)];
                fz += gout13z * dm[(i0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+2)];
                fy += gout9y * dm[(j0+0)*nao+(l0+2)];
                fz += gout9z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+1)];
                fy = gout5y * dm[(j0+0)*nao+(l0+1)];
                fz = gout5z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+2)];
                fy += gout11y * dm[(j0+0)*nao+(l0+2)];
                fz += gout11z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+1)];
                fy = gout8y * dm[(j0+0)*nao+(l0+1)];
                fz = gout8z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+2)];
                fy += gout10y * dm[(j0+0)*nao+(l0+2)];
                fz += gout10z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+1), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout13x * dm[(j0+0)*nao+(l0+2)];
                fy += gout13y * dm[(j0+0)*nao+(l0+2)];
                fz += gout13z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout9x * dm[(i0+0)*nao+(l0+2)];
                fy += gout9y * dm[(i0+0)*nao+(l0+2)];
                fz += gout9z * dm[(i0+0)*nao+(l0+2)];
                fx += gout5x * dm[(i0+2)*nao+(l0+1)];
                fy += gout5y * dm[(i0+2)*nao+(l0+1)];
                fz += gout5z * dm[(i0+2)*nao+(l0+1)];
                fx += gout1x * dm[(i0+4)*nao+(l0+0)];
                fy += gout1y * dm[(i0+4)*nao+(l0+0)];
                fz += gout1z * dm[(i0+4)*nao+(l0+0)];
                fx += gout10x * dm[(i0+4)*nao+(l0+2)];
                fy += gout10y * dm[(i0+4)*nao+(l0+2)];
                fz += gout10z * dm[(i0+4)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+1)];
                fy = gout6y * dm[(i0+0)*nao+(l0+1)];
                fz = gout6z * dm[(i0+0)*nao+(l0+1)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                fx += gout11x * dm[(i0+2)*nao+(l0+2)];
                fy += gout11y * dm[(i0+2)*nao+(l0+2)];
                fz += gout11z * dm[(i0+2)*nao+(l0+2)];
                fx += gout7x * dm[(i0+4)*nao+(l0+1)];
                fy += gout7y * dm[(i0+4)*nao+(l0+1)];
                fz += gout7z * dm[(i0+4)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout12x * dm[(i0+0)*nao+(l0+2)];
                fy += gout12y * dm[(i0+0)*nao+(l0+2)];
                fz += gout12z * dm[(i0+0)*nao+(l0+2)];
                fx += gout8x * dm[(i0+2)*nao+(l0+1)];
                fy += gout8y * dm[(i0+2)*nao+(l0+1)];
                fz += gout8z * dm[(i0+2)*nao+(l0+1)];
                fx += gout4x * dm[(i0+4)*nao+(l0+0)];
                fy += gout4y * dm[(i0+4)*nao+(l0+0)];
                fz += gout4z * dm[(i0+4)*nao+(l0+0)];
                fx += gout13x * dm[(i0+4)*nao+(l0+2)];
                fy += gout13y * dm[(i0+4)*nao+(l0+2)];
                fz += gout13z * dm[(i0+4)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                break;
                case 1:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+2)];
                fy += gout3y * dm[(j0+0)*nao+(k0+2)];
                fz += gout3z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+1)];
                fy = gout6y * dm[(j0+0)*nao+(k0+1)];
                fz = gout6z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+0)];
                fy = gout9y * dm[(j0+0)*nao+(k0+0)];
                fz = gout9z * dm[(j0+0)*nao+(k0+0)];
                fx += gout12x * dm[(j0+0)*nao+(k0+2)];
                fy += gout12y * dm[(j0+0)*nao+(k0+2)];
                fz += gout12z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+0)];
                fy = gout5y * dm[(j0+0)*nao+(k0+0)];
                fz = gout5z * dm[(j0+0)*nao+(k0+0)];
                fx += gout8x * dm[(j0+0)*nao+(k0+2)];
                fy += gout8y * dm[(j0+0)*nao+(k0+2)];
                fz += gout8z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+1)];
                fy = gout11y * dm[(j0+0)*nao+(k0+1)];
                fz = gout11z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+0)*nao+(k0+2)];
                fy += gout4y * dm[(j0+0)*nao+(k0+2)];
                fz += gout4z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(k0+1)];
                fy = gout7y * dm[(j0+0)*nao+(k0+1)];
                fz = gout7z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(k0+0)];
                fy = gout10y * dm[(j0+0)*nao+(k0+0)];
                fz = gout10z * dm[(j0+0)*nao+(k0+0)];
                fx += gout13x * dm[(j0+0)*nao+(k0+2)];
                fy += gout13y * dm[(j0+0)*nao+(k0+2)];
                fz += gout13z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+2), fz);
                fx = gout0x * dm[(i0+1)*nao+(k0+0)];
                fy = gout0y * dm[(i0+1)*nao+(k0+0)];
                fz = gout0z * dm[(i0+1)*nao+(k0+0)];
                fx += gout3x * dm[(i0+1)*nao+(k0+2)];
                fy += gout3y * dm[(i0+1)*nao+(k0+2)];
                fz += gout3z * dm[(i0+1)*nao+(k0+2)];
                fx += gout2x * dm[(i0+3)*nao+(k0+1)];
                fy += gout2y * dm[(i0+3)*nao+(k0+1)];
                fz += gout2z * dm[(i0+3)*nao+(k0+1)];
                fx += gout1x * dm[(i0+5)*nao+(k0+0)];
                fy += gout1y * dm[(i0+5)*nao+(k0+0)];
                fz += gout1z * dm[(i0+5)*nao+(k0+0)];
                fx += gout4x * dm[(i0+5)*nao+(k0+2)];
                fy += gout4y * dm[(i0+5)*nao+(k0+2)];
                fz += gout4z * dm[(i0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+1)*nao+(k0+1)];
                fy = gout6y * dm[(i0+1)*nao+(k0+1)];
                fz = gout6z * dm[(i0+1)*nao+(k0+1)];
                fx += gout5x * dm[(i0+3)*nao+(k0+0)];
                fy += gout5y * dm[(i0+3)*nao+(k0+0)];
                fz += gout5z * dm[(i0+3)*nao+(k0+0)];
                fx += gout8x * dm[(i0+3)*nao+(k0+2)];
                fy += gout8y * dm[(i0+3)*nao+(k0+2)];
                fz += gout8z * dm[(i0+3)*nao+(k0+2)];
                fx += gout7x * dm[(i0+5)*nao+(k0+1)];
                fy += gout7y * dm[(i0+5)*nao+(k0+1)];
                fz += gout7z * dm[(i0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout9x * dm[(i0+1)*nao+(k0+0)];
                fy = gout9y * dm[(i0+1)*nao+(k0+0)];
                fz = gout9z * dm[(i0+1)*nao+(k0+0)];
                fx += gout12x * dm[(i0+1)*nao+(k0+2)];
                fy += gout12y * dm[(i0+1)*nao+(k0+2)];
                fz += gout12z * dm[(i0+1)*nao+(k0+2)];
                fx += gout11x * dm[(i0+3)*nao+(k0+1)];
                fy += gout11y * dm[(i0+3)*nao+(k0+1)];
                fz += gout11z * dm[(i0+3)*nao+(k0+1)];
                fx += gout10x * dm[(i0+5)*nao+(k0+0)];
                fy += gout10y * dm[(i0+5)*nao+(k0+0)];
                fz += gout10z * dm[(i0+5)*nao+(k0+0)];
                fx += gout13x * dm[(i0+5)*nao+(k0+2)];
                fy += gout13y * dm[(i0+5)*nao+(k0+2)];
                fz += gout13z * dm[(i0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+2)];
                fy += gout9y * dm[(j0+0)*nao+(l0+2)];
                fz += gout9z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+1)];
                fy = gout5y * dm[(j0+0)*nao+(l0+1)];
                fz = gout5z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+2)];
                fy += gout11y * dm[(j0+0)*nao+(l0+2)];
                fz += gout11z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+1)];
                fy = gout8y * dm[(j0+0)*nao+(l0+1)];
                fz = gout8z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+2)];
                fy += gout10y * dm[(j0+0)*nao+(l0+2)];
                fz += gout10z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+1), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout13x * dm[(j0+0)*nao+(l0+2)];
                fy += gout13y * dm[(j0+0)*nao+(l0+2)];
                fz += gout13z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+1)*nao+(l0+0)];
                fy = gout0y * dm[(i0+1)*nao+(l0+0)];
                fz = gout0z * dm[(i0+1)*nao+(l0+0)];
                fx += gout9x * dm[(i0+1)*nao+(l0+2)];
                fy += gout9y * dm[(i0+1)*nao+(l0+2)];
                fz += gout9z * dm[(i0+1)*nao+(l0+2)];
                fx += gout5x * dm[(i0+3)*nao+(l0+1)];
                fy += gout5y * dm[(i0+3)*nao+(l0+1)];
                fz += gout5z * dm[(i0+3)*nao+(l0+1)];
                fx += gout1x * dm[(i0+5)*nao+(l0+0)];
                fy += gout1y * dm[(i0+5)*nao+(l0+0)];
                fz += gout1z * dm[(i0+5)*nao+(l0+0)];
                fx += gout10x * dm[(i0+5)*nao+(l0+2)];
                fy += gout10y * dm[(i0+5)*nao+(l0+2)];
                fz += gout10z * dm[(i0+5)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+1)*nao+(l0+1)];
                fy = gout6y * dm[(i0+1)*nao+(l0+1)];
                fz = gout6z * dm[(i0+1)*nao+(l0+1)];
                fx += gout2x * dm[(i0+3)*nao+(l0+0)];
                fy += gout2y * dm[(i0+3)*nao+(l0+0)];
                fz += gout2z * dm[(i0+3)*nao+(l0+0)];
                fx += gout11x * dm[(i0+3)*nao+(l0+2)];
                fy += gout11y * dm[(i0+3)*nao+(l0+2)];
                fz += gout11z * dm[(i0+3)*nao+(l0+2)];
                fx += gout7x * dm[(i0+5)*nao+(l0+1)];
                fy += gout7y * dm[(i0+5)*nao+(l0+1)];
                fz += gout7z * dm[(i0+5)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+1)*nao+(l0+0)];
                fy = gout3y * dm[(i0+1)*nao+(l0+0)];
                fz = gout3z * dm[(i0+1)*nao+(l0+0)];
                fx += gout12x * dm[(i0+1)*nao+(l0+2)];
                fy += gout12y * dm[(i0+1)*nao+(l0+2)];
                fz += gout12z * dm[(i0+1)*nao+(l0+2)];
                fx += gout8x * dm[(i0+3)*nao+(l0+1)];
                fy += gout8y * dm[(i0+3)*nao+(l0+1)];
                fz += gout8z * dm[(i0+3)*nao+(l0+1)];
                fx += gout4x * dm[(i0+5)*nao+(l0+0)];
                fy += gout4y * dm[(i0+5)*nao+(l0+0)];
                fz += gout4z * dm[(i0+5)*nao+(l0+0)];
                fx += gout13x * dm[(i0+5)*nao+(l0+2)];
                fy += gout13y * dm[(i0+5)*nao+(l0+2)];
                fz += gout13z * dm[(i0+5)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                break;
                case 2:
                fx = gout1x * dm[(j0+0)*nao+(k0+1)];
                fy = gout1y * dm[(j0+0)*nao+(k0+1)];
                fz = gout1z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+0)];
                fy = gout4y * dm[(j0+0)*nao+(k0+0)];
                fz = gout4z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+0)*nao+(k0+2)];
                fy += gout7y * dm[(j0+0)*nao+(k0+2)];
                fz += gout7z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(k0+1)];
                fy = gout10y * dm[(j0+0)*nao+(k0+1)];
                fz = gout10z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+2)];
                fy += gout3y * dm[(j0+0)*nao+(k0+2)];
                fz += gout3z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+1)];
                fy = gout6y * dm[(j0+0)*nao+(k0+1)];
                fz = gout6z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+0)];
                fy = gout9y * dm[(j0+0)*nao+(k0+0)];
                fz = gout9z * dm[(j0+0)*nao+(k0+0)];
                fx += gout12x * dm[(j0+0)*nao+(k0+2)];
                fy += gout12y * dm[(j0+0)*nao+(k0+2)];
                fz += gout12z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+0)];
                fy = gout5y * dm[(j0+0)*nao+(k0+0)];
                fz = gout5z * dm[(j0+0)*nao+(k0+0)];
                fx += gout8x * dm[(j0+0)*nao+(k0+2)];
                fy += gout8y * dm[(j0+0)*nao+(k0+2)];
                fz += gout8z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+1)];
                fy = gout11y * dm[(j0+0)*nao+(k0+1)];
                fz = gout11z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+1)];
                fy = gout1y * dm[(i0+0)*nao+(k0+1)];
                fz = gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout0x * dm[(i0+2)*nao+(k0+0)];
                fy += gout0y * dm[(i0+2)*nao+(k0+0)];
                fz += gout0z * dm[(i0+2)*nao+(k0+0)];
                fx += gout3x * dm[(i0+2)*nao+(k0+2)];
                fy += gout3y * dm[(i0+2)*nao+(k0+2)];
                fz += gout3z * dm[(i0+2)*nao+(k0+2)];
                fx += gout2x * dm[(i0+4)*nao+(k0+1)];
                fy += gout2y * dm[(i0+4)*nao+(k0+1)];
                fz += gout2z * dm[(i0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+0)];
                fy = gout4y * dm[(i0+0)*nao+(k0+0)];
                fz = gout4z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+0)*nao+(k0+2)];
                fy += gout7y * dm[(i0+0)*nao+(k0+2)];
                fz += gout7z * dm[(i0+0)*nao+(k0+2)];
                fx += gout6x * dm[(i0+2)*nao+(k0+1)];
                fy += gout6y * dm[(i0+2)*nao+(k0+1)];
                fz += gout6z * dm[(i0+2)*nao+(k0+1)];
                fx += gout5x * dm[(i0+4)*nao+(k0+0)];
                fy += gout5y * dm[(i0+4)*nao+(k0+0)];
                fz += gout5z * dm[(i0+4)*nao+(k0+0)];
                fx += gout8x * dm[(i0+4)*nao+(k0+2)];
                fy += gout8y * dm[(i0+4)*nao+(k0+2)];
                fz += gout8z * dm[(i0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(k0+1)];
                fy = gout10y * dm[(i0+0)*nao+(k0+1)];
                fz = gout10z * dm[(i0+0)*nao+(k0+1)];
                fx += gout9x * dm[(i0+2)*nao+(k0+0)];
                fy += gout9y * dm[(i0+2)*nao+(k0+0)];
                fz += gout9z * dm[(i0+2)*nao+(k0+0)];
                fx += gout12x * dm[(i0+2)*nao+(k0+2)];
                fy += gout12y * dm[(i0+2)*nao+(k0+2)];
                fz += gout12z * dm[(i0+2)*nao+(k0+2)];
                fx += gout11x * dm[(i0+4)*nao+(k0+1)];
                fy += gout11y * dm[(i0+4)*nao+(k0+1)];
                fz += gout11z * dm[(i0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+1)];
                fy = gout4y * dm[(j0+0)*nao+(l0+1)];
                fz = gout4z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+2)];
                fy += gout10y * dm[(j0+0)*nao+(l0+2)];
                fz += gout10z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+2)];
                fy += gout9y * dm[(j0+0)*nao+(l0+2)];
                fz += gout9z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+1)];
                fy = gout5y * dm[(j0+0)*nao+(l0+1)];
                fz = gout5z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+2)];
                fy += gout11y * dm[(j0+0)*nao+(l0+2)];
                fz += gout11z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+1)];
                fy = gout8y * dm[(j0+0)*nao+(l0+1)];
                fz = gout8z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+2), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+1)];
                fy = gout4y * dm[(i0+0)*nao+(l0+1)];
                fz = gout4z * dm[(i0+0)*nao+(l0+1)];
                fx += gout0x * dm[(i0+2)*nao+(l0+0)];
                fy += gout0y * dm[(i0+2)*nao+(l0+0)];
                fz += gout0z * dm[(i0+2)*nao+(l0+0)];
                fx += gout9x * dm[(i0+2)*nao+(l0+2)];
                fy += gout9y * dm[(i0+2)*nao+(l0+2)];
                fz += gout9z * dm[(i0+2)*nao+(l0+2)];
                fx += gout5x * dm[(i0+4)*nao+(l0+1)];
                fy += gout5y * dm[(i0+4)*nao+(l0+1)];
                fz += gout5z * dm[(i0+4)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+0)*nao+(l0+2)];
                fy += gout10y * dm[(i0+0)*nao+(l0+2)];
                fz += gout10z * dm[(i0+0)*nao+(l0+2)];
                fx += gout6x * dm[(i0+2)*nao+(l0+1)];
                fy += gout6y * dm[(i0+2)*nao+(l0+1)];
                fz += gout6z * dm[(i0+2)*nao+(l0+1)];
                fx += gout2x * dm[(i0+4)*nao+(l0+0)];
                fy += gout2y * dm[(i0+4)*nao+(l0+0)];
                fz += gout2z * dm[(i0+4)*nao+(l0+0)];
                fx += gout11x * dm[(i0+4)*nao+(l0+2)];
                fy += gout11y * dm[(i0+4)*nao+(l0+2)];
                fz += gout11z * dm[(i0+4)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+1)];
                fy = gout7y * dm[(i0+0)*nao+(l0+1)];
                fz = gout7z * dm[(i0+0)*nao+(l0+1)];
                fx += gout3x * dm[(i0+2)*nao+(l0+0)];
                fy += gout3y * dm[(i0+2)*nao+(l0+0)];
                fz += gout3z * dm[(i0+2)*nao+(l0+0)];
                fx += gout12x * dm[(i0+2)*nao+(l0+2)];
                fy += gout12y * dm[(i0+2)*nao+(l0+2)];
                fz += gout12z * dm[(i0+2)*nao+(l0+2)];
                fx += gout8x * dm[(i0+4)*nao+(l0+1)];
                fy += gout8y * dm[(i0+4)*nao+(l0+1)];
                fz += gout8z * dm[(i0+4)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                break;
                case 3:
                fx = gout1x * dm[(j0+0)*nao+(k0+1)];
                fy = gout1y * dm[(j0+0)*nao+(k0+1)];
                fz = gout1z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+0)];
                fy = gout4y * dm[(j0+0)*nao+(k0+0)];
                fz = gout4z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+0)*nao+(k0+2)];
                fy += gout7y * dm[(j0+0)*nao+(k0+2)];
                fz += gout7z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(k0+1)];
                fy = gout10y * dm[(j0+0)*nao+(k0+1)];
                fz = gout10z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+2)];
                fy += gout3y * dm[(j0+0)*nao+(k0+2)];
                fz += gout3z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(k0+1)];
                fy = gout6y * dm[(j0+0)*nao+(k0+1)];
                fz = gout6z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(k0+0)];
                fy = gout9y * dm[(j0+0)*nao+(k0+0)];
                fz = gout9z * dm[(j0+0)*nao+(k0+0)];
                fx += gout12x * dm[(j0+0)*nao+(k0+2)];
                fy += gout12y * dm[(j0+0)*nao+(k0+2)];
                fz += gout12z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+2), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+0)];
                fy = gout5y * dm[(j0+0)*nao+(k0+0)];
                fz = gout5z * dm[(j0+0)*nao+(k0+0)];
                fx += gout8x * dm[(j0+0)*nao+(k0+2)];
                fy += gout8y * dm[(j0+0)*nao+(k0+2)];
                fz += gout8z * dm[(j0+0)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+1), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+1), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+1), fz);
                fx = gout11x * dm[(j0+0)*nao+(k0+1)];
                fy = gout11y * dm[(j0+0)*nao+(k0+1)];
                fz = gout11z * dm[(j0+0)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+2), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+2), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+2), fz);
                fx = gout1x * dm[(i0+1)*nao+(k0+1)];
                fy = gout1y * dm[(i0+1)*nao+(k0+1)];
                fz = gout1z * dm[(i0+1)*nao+(k0+1)];
                fx += gout0x * dm[(i0+3)*nao+(k0+0)];
                fy += gout0y * dm[(i0+3)*nao+(k0+0)];
                fz += gout0z * dm[(i0+3)*nao+(k0+0)];
                fx += gout3x * dm[(i0+3)*nao+(k0+2)];
                fy += gout3y * dm[(i0+3)*nao+(k0+2)];
                fz += gout3z * dm[(i0+3)*nao+(k0+2)];
                fx += gout2x * dm[(i0+5)*nao+(k0+1)];
                fy += gout2y * dm[(i0+5)*nao+(k0+1)];
                fz += gout2z * dm[(i0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+1)*nao+(k0+0)];
                fy = gout4y * dm[(i0+1)*nao+(k0+0)];
                fz = gout4z * dm[(i0+1)*nao+(k0+0)];
                fx += gout7x * dm[(i0+1)*nao+(k0+2)];
                fy += gout7y * dm[(i0+1)*nao+(k0+2)];
                fz += gout7z * dm[(i0+1)*nao+(k0+2)];
                fx += gout6x * dm[(i0+3)*nao+(k0+1)];
                fy += gout6y * dm[(i0+3)*nao+(k0+1)];
                fz += gout6z * dm[(i0+3)*nao+(k0+1)];
                fx += gout5x * dm[(i0+5)*nao+(k0+0)];
                fy += gout5y * dm[(i0+5)*nao+(k0+0)];
                fz += gout5z * dm[(i0+5)*nao+(k0+0)];
                fx += gout8x * dm[(i0+5)*nao+(k0+2)];
                fy += gout8y * dm[(i0+5)*nao+(k0+2)];
                fz += gout8z * dm[(i0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+1), fz);
                fx = gout10x * dm[(i0+1)*nao+(k0+1)];
                fy = gout10y * dm[(i0+1)*nao+(k0+1)];
                fz = gout10z * dm[(i0+1)*nao+(k0+1)];
                fx += gout9x * dm[(i0+3)*nao+(k0+0)];
                fy += gout9y * dm[(i0+3)*nao+(k0+0)];
                fz += gout9z * dm[(i0+3)*nao+(k0+0)];
                fx += gout12x * dm[(i0+3)*nao+(k0+2)];
                fy += gout12y * dm[(i0+3)*nao+(k0+2)];
                fz += gout12z * dm[(i0+3)*nao+(k0+2)];
                fx += gout11x * dm[(i0+5)*nao+(k0+1)];
                fy += gout11y * dm[(i0+5)*nao+(k0+1)];
                fz += gout11z * dm[(i0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+2), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+1)];
                fy = gout4y * dm[(j0+0)*nao+(l0+1)];
                fz = gout4z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+0)*nao+(l0+2)];
                fy += gout10y * dm[(j0+0)*nao+(l0+2)];
                fz += gout10z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+1)];
                fy = gout7y * dm[(j0+0)*nao+(l0+1)];
                fz = gout7z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+0)*nao+(l0+2)];
                fy += gout9y * dm[(j0+0)*nao+(l0+2)];
                fz += gout9z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+1)];
                fy = gout6y * dm[(j0+0)*nao+(l0+1)];
                fz = gout6z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+1), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+0)*nao+(l0+2)];
                fy += gout12y * dm[(j0+0)*nao+(l0+2)];
                fz += gout12z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+2), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+1)];
                fy = gout5y * dm[(j0+0)*nao+(l0+1)];
                fz = gout5z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+0)*nao+(l0+2)];
                fy += gout11y * dm[(j0+0)*nao+(l0+2)];
                fz += gout11z * dm[(j0+0)*nao+(l0+2)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+1), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+1)];
                fy = gout8y * dm[(j0+0)*nao+(l0+1)];
                fz = gout8z * dm[(j0+0)*nao+(l0+1)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+2), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+1)];
                fy = gout4y * dm[(i0+1)*nao+(l0+1)];
                fz = gout4z * dm[(i0+1)*nao+(l0+1)];
                fx += gout0x * dm[(i0+3)*nao+(l0+0)];
                fy += gout0y * dm[(i0+3)*nao+(l0+0)];
                fz += gout0z * dm[(i0+3)*nao+(l0+0)];
                fx += gout9x * dm[(i0+3)*nao+(l0+2)];
                fy += gout9y * dm[(i0+3)*nao+(l0+2)];
                fz += gout9z * dm[(i0+3)*nao+(l0+2)];
                fx += gout5x * dm[(i0+5)*nao+(l0+1)];
                fy += gout5y * dm[(i0+5)*nao+(l0+1)];
                fz += gout5z * dm[(i0+5)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout10x * dm[(i0+1)*nao+(l0+2)];
                fy += gout10y * dm[(i0+1)*nao+(l0+2)];
                fz += gout10z * dm[(i0+1)*nao+(l0+2)];
                fx += gout6x * dm[(i0+3)*nao+(l0+1)];
                fy += gout6y * dm[(i0+3)*nao+(l0+1)];
                fz += gout6z * dm[(i0+3)*nao+(l0+1)];
                fx += gout2x * dm[(i0+5)*nao+(l0+0)];
                fy += gout2y * dm[(i0+5)*nao+(l0+0)];
                fz += gout2z * dm[(i0+5)*nao+(l0+0)];
                fx += gout11x * dm[(i0+5)*nao+(l0+2)];
                fy += gout11y * dm[(i0+5)*nao+(l0+2)];
                fz += gout11z * dm[(i0+5)*nao+(l0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout7x * dm[(i0+1)*nao+(l0+1)];
                fy = gout7y * dm[(i0+1)*nao+(l0+1)];
                fz = gout7z * dm[(i0+1)*nao+(l0+1)];
                fx += gout3x * dm[(i0+3)*nao+(l0+0)];
                fy += gout3y * dm[(i0+3)*nao+(l0+0)];
                fz += gout3z * dm[(i0+3)*nao+(l0+0)];
                fx += gout12x * dm[(i0+3)*nao+(l0+2)];
                fy += gout12y * dm[(i0+3)*nao+(l0+2)];
                fz += gout12z * dm[(i0+3)*nao+(l0+2)];
                fx += gout8x * dm[(i0+5)*nao+(l0+1)];
                fy += gout8y * dm[(i0+5)*nao+(l0+1)];
                fz += gout8z * dm[(i0+5)*nao+(l0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                break;
                }
            }
        }
    }
}
__global__
static void rys_vjk_ip1_2011(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_2011(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_2020(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;
    double *gx = rw + 128 * nroots;
    double *gy = gx + 768;
    double *gz = gy + 768;
    double *rlrk = gz + 768;
    double *Rpq = rlrk + 192;
    if (gout_id == 0) {
        gx[0] = 1.;
        gy[0] = 1.;
    }
    double s0, s1, s2;
    double Ix, Iy, Iz;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        if (gout_id == 0) {
            rlrk[0] = xlxk;
            rlrk[64] = ylyk;
            rlrk[128] = zlzk;
        }
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            __syncthreads();
            double xlxk = rlrk[0];
            double ylyk = rlrk[64];
            double zlzk = rlrk[128];
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xkl = rk[0] + rlrk[0] * al_akl;
                double ykl = rk[1] + rlrk[64] * al_akl;
                double zkl = rk[2] + rlrk[128] * al_akl;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                __syncthreads();
                if (gout_id == 0) {
                    Rpq[0] = xpq;
                    Rpq[64] = ypq;
                    Rpq[128] = zpq;
                }
                rys_roots_rs(nroots, theta, rr, omega, rw, 64, gout_id, 4);
                for (int irys = 0; irys < nroots; ++irys) {
                    __syncthreads();
                    double rt = rw[irys*128];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double rt_akl = rt_aa * aij;
                    double b00 = .5 * rt_aa;
                    double b01 = .5/akl * (1 - rt_akl);
                    for (int n = gout_id; n < 3; n += 4) {
                        if (n == 2) {
                            gz[0] = rw[irys*128+64] * fac;
                        }
                        double *_gx = gx + n * 768;
                        double xjxi = rjri[n];
                        double Rpa = xjxi * aj_aij;
                        double c0x = Rpa - rt_aij * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = c0x * s0;
                        _gx[64] = s1;
                        s2 = c0x * s1 + 1 * b10 * s0;
                        _gx[128] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 2 * b10 * s0;
                        _gx[192] = s2;
                        double xlxk = rlrk[n*64];
                        double Rqc = xlxk * al_akl;
                        double cpx = Rqc + rt_akl * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = cpx * s0;
                        _gx[256] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        _gx[512] = s2;
                        s0 = _gx[64];
                        s1 = cpx * s0;
                        s1 += 1 * b00 * _gx[0];
                        _gx[320] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 1 * b00 * _gx[256];
                        _gx[576] = s2;
                        s0 = _gx[128];
                        s1 = cpx * s0;
                        s1 += 2 * b00 * _gx[64];
                        _gx[384] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 2 * b00 * _gx[320];
                        _gx[640] = s2;
                        s0 = _gx[192];
                        s1 = cpx * s0;
                        s1 += 3 * b00 * _gx[128];
                        _gx[448] = s1;
                        s2 = cpx*s1 + 1 * b01 *s0;
                        s2 += 3 * b00 * _gx[384];
                        _gx[704] = s2;
                    }
                    __syncthreads();
                    switch (gout_id) {
                    case 0:
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[0];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[704] - 2 * gx[576]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[64];
                    Iz = gz[64];
                    gout1x += ai2 * gx[576] * Iy * Iz;
                    gout1y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout1z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[256];
                    Iz = gz[64];
                    gout2x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout2y += ai2 * gy[320] * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[0];
                    Iz = gz[256];
                    gout3x += (ai2 * gx[448] - 2 * gx[320]) * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[64];
                    Iz = gz[320];
                    gout4x += ai2 * gx[320] * Iy * Iz;
                    gout4y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout4z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[512];
                    Iz = gz[64];
                    gout5x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout5y += ai2 * gy[576] * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[256];
                    Iz = gz[256];
                    gout6x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout6y += ai2 * gy[320] * Ix * Iz;
                    gout6z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[320];
                    Iz = gz[320];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout7z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[0];
                    Iz = gz[576];
                    gout8x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout8y += ai2 * gy[64] * Ix * Iz;
                    gout8z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    break;
                    case 1:
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[64];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout0y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[0];
                    Iz = gz[128];
                    gout1x += ai2 * gx[576] * Iy * Iz;
                    gout1y += ai2 * gy[64] * Ix * Iz;
                    gout1z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[384];
                    Iz = gz[0];
                    gout2x += ai2 * gx[320] * Iy * Iz;
                    gout2y += (ai2 * gy[448] - 2 * gy[320]) * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[64];
                    Iz = gz[256];
                    gout3x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout3y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[0];
                    Iz = gz[384];
                    gout4x += ai2 * gx[320] * Iy * Iz;
                    gout4y += ai2 * gy[64] * Ix * Iz;
                    gout4z += (ai2 * gz[448] - 2 * gz[320]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[640];
                    Iz = gz[0];
                    gout5x += ai2 * gx[64] * Iy * Iz;
                    gout5y += (ai2 * gy[704] - 2 * gy[576]) * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[320];
                    Iz = gz[256];
                    gout6x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout6y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout6z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[256];
                    Iz = gz[384];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[320] * Ix * Iz;
                    gout7z += (ai2 * gz[448] - 2 * gz[320]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[128];
                    Iz = gz[512];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout8z += ai2 * gz[576] * Ix * Iy;
                    break;
                    case 2:
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[0];
                    Iz = gz[64];
                    gout0x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[256];
                    Iz = gz[0];
                    gout1x += (ai2 * gx[448] - 2 * gx[320]) * Iy * Iz;
                    gout1y += ai2 * gy[320] * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[320];
                    Iz = gz[64];
                    gout2x += ai2 * gx[320] * Iy * Iz;
                    gout2y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[0];
                    Iz = gz[320];
                    gout3x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[512];
                    Iz = gz[0];
                    gout4x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout4y += ai2 * gy[576] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[576];
                    Iz = gz[64];
                    gout5x += ai2 * gx[64] * Iy * Iz;
                    gout5y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[256];
                    Iz = gz[320];
                    gout6x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout6y += ai2 * gy[320] * Ix * Iz;
                    gout6z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[0];
                    Iz = gz[512];
                    gout7x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout7y += ai2 * gy[64] * Ix * Iz;
                    gout7z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[64];
                    Iz = gz[576];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout8z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    break;
                    case 3:
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[128];
                    Iz = gz[0];
                    gout0x += ai2 * gx[576] * Iy * Iz;
                    gout0y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[320];
                    Iz = gz[0];
                    gout1x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout1y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[256];
                    Iz = gz[128];
                    gout2x += ai2 * gx[320] * Iy * Iz;
                    gout2y += ai2 * gy[320] * Ix * Iz;
                    gout2z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[128];
                    Iz = gz[256];
                    gout3x += ai2 * gx[320] * Iy * Iz;
                    gout3y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[576];
                    Iz = gz[0];
                    gout4x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout4y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[512];
                    Iz = gz[128];
                    gout5x += ai2 * gx[64] * Iy * Iz;
                    gout5y += ai2 * gy[576] * Ix * Iz;
                    gout5z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[384];
                    Iz = gz[256];
                    gout6x += ai2 * gx[64] * Iy * Iz;
                    gout6y += (ai2 * gy[448] - 2 * gy[320]) * Ix * Iz;
                    gout6z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[64];
                    Iz = gz[512];
                    gout7x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout7y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout7z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[0];
                    Iz = gz[640];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[64] * Ix * Iz;
                    gout8z += (ai2 * gz[704] - 2 * gz[576]) * Ix * Iy;
                    break;
                    }
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+0)*nao+(k0+4)];
                fy += gout6y * dm[(l0+0)*nao+(k0+4)];
                fz += gout6z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+0)*nao+(k0+3)];
                fy += gout5y * dm[(l0+0)*nao+(k0+3)];
                fz += gout5z * dm[(l0+0)*nao+(k0+3)];
                fx += gout8x * dm[(l0+0)*nao+(k0+5)];
                fy += gout8y * dm[(l0+0)*nao+(k0+5)];
                fz += gout8z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+2)];
                fy += gout4y * dm[(l0+0)*nao+(k0+2)];
                fz += gout4z * dm[(l0+0)*nao+(k0+2)];
                fx += gout7x * dm[(l0+0)*nao+(k0+4)];
                fy += gout7y * dm[(l0+0)*nao+(k0+4)];
                fz += gout7z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+4)];
                fy += gout1y * dm[(j0+0)*nao+(i0+4)];
                fz += gout1z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+2)];
                fy = gout2y * dm[(j0+0)*nao+(i0+2)];
                fz = gout2z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+0)];
                fy = gout3y * dm[(j0+0)*nao+(i0+0)];
                fz = gout3z * dm[(j0+0)*nao+(i0+0)];
                fx += gout4x * dm[(j0+0)*nao+(i0+4)];
                fy += gout4y * dm[(j0+0)*nao+(i0+4)];
                fz += gout4z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+2)];
                fy = gout5y * dm[(j0+0)*nao+(i0+2)];
                fz = gout5z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+0)];
                fy = gout6y * dm[(j0+0)*nao+(i0+0)];
                fz = gout6z * dm[(j0+0)*nao+(i0+0)];
                fx += gout7x * dm[(j0+0)*nao+(i0+4)];
                fy += gout7y * dm[(j0+0)*nao+(i0+4)];
                fz += gout7z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+2)];
                fy = gout8y * dm[(j0+0)*nao+(i0+2)];
                fz = gout8z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                case 1:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+0)*nao+(k0+4)];
                fy += gout6y * dm[(l0+0)*nao+(k0+4)];
                fz += gout6z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+0)*nao+(k0+3)];
                fy += gout5y * dm[(l0+0)*nao+(k0+3)];
                fz += gout5z * dm[(l0+0)*nao+(k0+3)];
                fx += gout8x * dm[(l0+0)*nao+(k0+5)];
                fy += gout8y * dm[(l0+0)*nao+(k0+5)];
                fz += gout8z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout4x * dm[(l0+0)*nao+(k0+2)];
                fy += gout4y * dm[(l0+0)*nao+(k0+2)];
                fz += gout4z * dm[(l0+0)*nao+(k0+2)];
                fx += gout7x * dm[(l0+0)*nao+(k0+4)];
                fy += gout7y * dm[(l0+0)*nao+(k0+4)];
                fz += gout7z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+1)];
                fy = gout0y * dm[(j0+0)*nao+(i0+1)];
                fz = gout0z * dm[(j0+0)*nao+(i0+1)];
                fx += gout1x * dm[(j0+0)*nao+(i0+5)];
                fy += gout1y * dm[(j0+0)*nao+(i0+5)];
                fz += gout1z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(i0+3)];
                fy = gout2y * dm[(j0+0)*nao+(i0+3)];
                fz = gout2z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+1)];
                fy = gout3y * dm[(j0+0)*nao+(i0+1)];
                fz = gout3z * dm[(j0+0)*nao+(i0+1)];
                fx += gout4x * dm[(j0+0)*nao+(i0+5)];
                fy += gout4y * dm[(j0+0)*nao+(i0+5)];
                fz += gout4z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+3)];
                fy = gout5y * dm[(j0+0)*nao+(i0+3)];
                fz = gout5z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+1)];
                fy = gout6y * dm[(j0+0)*nao+(i0+1)];
                fz = gout6z * dm[(j0+0)*nao+(i0+1)];
                fx += gout7x * dm[(j0+0)*nao+(i0+5)];
                fy += gout7y * dm[(j0+0)*nao+(i0+5)];
                fz += gout7z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout8x * dm[(j0+0)*nao+(i0+3)];
                fy = gout8y * dm[(j0+0)*nao+(i0+3)];
                fz = gout8z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                case 2:
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+0)*nao+(k0+3)];
                fy += gout4y * dm[(l0+0)*nao+(k0+3)];
                fz += gout4z * dm[(l0+0)*nao+(k0+3)];
                fx += gout7x * dm[(l0+0)*nao+(k0+5)];
                fy += gout7y * dm[(l0+0)*nao+(k0+5)];
                fz += gout7z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+0)*nao+(k0+4)];
                fy += gout6y * dm[(l0+0)*nao+(k0+4)];
                fz += gout6z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+0)*nao+(k0+3)];
                fy += gout5y * dm[(l0+0)*nao+(k0+3)];
                fz += gout5z * dm[(l0+0)*nao+(k0+3)];
                fx += gout8x * dm[(l0+0)*nao+(k0+5)];
                fy += gout8y * dm[(l0+0)*nao+(k0+5)];
                fz += gout8z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+2)];
                fy = gout0y * dm[(j0+0)*nao+(i0+2)];
                fz = gout0z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+0)];
                fy = gout1y * dm[(j0+0)*nao+(i0+0)];
                fz = gout1z * dm[(j0+0)*nao+(i0+0)];
                fx += gout2x * dm[(j0+0)*nao+(i0+4)];
                fy += gout2y * dm[(j0+0)*nao+(i0+4)];
                fz += gout2z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+2)];
                fy = gout3y * dm[(j0+0)*nao+(i0+2)];
                fz = gout3z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                fx += gout5x * dm[(j0+0)*nao+(i0+4)];
                fy += gout5y * dm[(j0+0)*nao+(i0+4)];
                fz += gout5z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+2)];
                fy = gout6y * dm[(j0+0)*nao+(i0+2)];
                fz = gout6z * dm[(j0+0)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+0)];
                fy = gout7y * dm[(j0+0)*nao+(i0+0)];
                fz = gout7z * dm[(j0+0)*nao+(i0+0)];
                fx += gout8x * dm[(j0+0)*nao+(i0+4)];
                fy += gout8y * dm[(j0+0)*nao+(i0+4)];
                fz += gout8z * dm[(j0+0)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                case 3:
                fx = gout1x * dm[(l0+0)*nao+(k0+1)];
                fy = gout1y * dm[(l0+0)*nao+(k0+1)];
                fz = gout1z * dm[(l0+0)*nao+(k0+1)];
                fx += gout4x * dm[(l0+0)*nao+(k0+3)];
                fy += gout4y * dm[(l0+0)*nao+(k0+3)];
                fz += gout4z * dm[(l0+0)*nao+(k0+3)];
                fx += gout7x * dm[(l0+0)*nao+(k0+5)];
                fy += gout7y * dm[(l0+0)*nao+(k0+5)];
                fz += gout7z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout3x * dm[(l0+0)*nao+(k0+2)];
                fy += gout3y * dm[(l0+0)*nao+(k0+2)];
                fz += gout3z * dm[(l0+0)*nao+(k0+2)];
                fx += gout6x * dm[(l0+0)*nao+(k0+4)];
                fy += gout6y * dm[(l0+0)*nao+(k0+4)];
                fz += gout6z * dm[(l0+0)*nao+(k0+4)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+1)];
                fy = gout2y * dm[(l0+0)*nao+(k0+1)];
                fz = gout2z * dm[(l0+0)*nao+(k0+1)];
                fx += gout5x * dm[(l0+0)*nao+(k0+3)];
                fy += gout5y * dm[(l0+0)*nao+(k0+3)];
                fz += gout5z * dm[(l0+0)*nao+(k0+3)];
                fx += gout8x * dm[(l0+0)*nao+(k0+5)];
                fy += gout8y * dm[(l0+0)*nao+(k0+5)];
                fz += gout8z * dm[(l0+0)*nao+(k0+5)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+3)];
                fy = gout0y * dm[(j0+0)*nao+(i0+3)];
                fz = gout0z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(i0+1)];
                fy = gout1y * dm[(j0+0)*nao+(i0+1)];
                fz = gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+5)];
                fy += gout2y * dm[(j0+0)*nao+(i0+5)];
                fz += gout2z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(i0+3)];
                fy = gout3y * dm[(j0+0)*nao+(i0+3)];
                fz = gout3z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+1)];
                fy = gout4y * dm[(j0+0)*nao+(i0+1)];
                fz = gout4z * dm[(j0+0)*nao+(i0+1)];
                fx += gout5x * dm[(j0+0)*nao+(i0+5)];
                fy += gout5y * dm[(j0+0)*nao+(i0+5)];
                fz += gout5z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+3)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+3)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(j0+0)*nao+(i0+3)];
                fy = gout6y * dm[(j0+0)*nao+(i0+3)];
                fz = gout6z * dm[(j0+0)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+4)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+4)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+4)*nao+(l0+0), fz);
                fx = gout7x * dm[(j0+0)*nao+(i0+1)];
                fy = gout7y * dm[(j0+0)*nao+(i0+1)];
                fz = gout7z * dm[(j0+0)*nao+(i0+1)];
                fx += gout8x * dm[(j0+0)*nao+(i0+5)];
                fy += gout8y * dm[(j0+0)*nao+(i0+5)];
                fz += gout8z * dm[(j0+0)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+5)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+5)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+5)*nao+(l0+0), fz);
                break;
                }
            }
            if (do_k) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+2)];
                fy += gout3y * dm[(j0+0)*nao+(k0+2)];
                fz += gout3z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+0)*nao+(k0+4)];
                fy += gout6y * dm[(j0+0)*nao+(k0+4)];
                fz += gout6z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                fx += gout5x * dm[(j0+0)*nao+(k0+3)];
                fy += gout5y * dm[(j0+0)*nao+(k0+3)];
                fz += gout5z * dm[(j0+0)*nao+(k0+3)];
                fx += gout8x * dm[(j0+0)*nao+(k0+5)];
                fy += gout8y * dm[(j0+0)*nao+(k0+5)];
                fz += gout8z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+0)*nao+(k0+2)];
                fy += gout4y * dm[(j0+0)*nao+(k0+2)];
                fz += gout4z * dm[(j0+0)*nao+(k0+2)];
                fx += gout7x * dm[(j0+0)*nao+(k0+4)];
                fy += gout7y * dm[(j0+0)*nao+(k0+4)];
                fz += gout7z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout3x * dm[(i0+0)*nao+(k0+2)];
                fy += gout3y * dm[(i0+0)*nao+(k0+2)];
                fz += gout3z * dm[(i0+0)*nao+(k0+2)];
                fx += gout6x * dm[(i0+0)*nao+(k0+4)];
                fy += gout6y * dm[(i0+0)*nao+(k0+4)];
                fz += gout6z * dm[(i0+0)*nao+(k0+4)];
                fx += gout2x * dm[(i0+2)*nao+(k0+1)];
                fy += gout2y * dm[(i0+2)*nao+(k0+1)];
                fz += gout2z * dm[(i0+2)*nao+(k0+1)];
                fx += gout5x * dm[(i0+2)*nao+(k0+3)];
                fy += gout5y * dm[(i0+2)*nao+(k0+3)];
                fz += gout5z * dm[(i0+2)*nao+(k0+3)];
                fx += gout8x * dm[(i0+2)*nao+(k0+5)];
                fy += gout8y * dm[(i0+2)*nao+(k0+5)];
                fz += gout8z * dm[(i0+2)*nao+(k0+5)];
                fx += gout1x * dm[(i0+4)*nao+(k0+0)];
                fy += gout1y * dm[(i0+4)*nao+(k0+0)];
                fz += gout1z * dm[(i0+4)*nao+(k0+0)];
                fx += gout4x * dm[(i0+4)*nao+(k0+2)];
                fy += gout4y * dm[(i0+4)*nao+(k0+2)];
                fz += gout4z * dm[(i0+4)*nao+(k0+2)];
                fx += gout7x * dm[(i0+4)*nao+(k0+4)];
                fy += gout7y * dm[(i0+4)*nao+(k0+4)];
                fz += gout7z * dm[(i0+4)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+4), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+3), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+0)];
                fy = gout8y * dm[(j0+0)*nao+(l0+0)];
                fz = gout8z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+5), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+2), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+0)];
                fy = gout7y * dm[(j0+0)*nao+(l0+0)];
                fz = gout7z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+4), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+4)*nao+(l0+0)];
                fy += gout1y * dm[(i0+4)*nao+(l0+0)];
                fz += gout1z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+2)*nao+(l0+0)];
                fy = gout2y * dm[(i0+2)*nao+(l0+0)];
                fz = gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout4x * dm[(i0+4)*nao+(l0+0)];
                fy += gout4y * dm[(i0+4)*nao+(l0+0)];
                fz += gout4z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout5x * dm[(i0+2)*nao+(l0+0)];
                fy = gout5y * dm[(i0+2)*nao+(l0+0)];
                fz = gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+4)*nao+(l0+0)];
                fy += gout7y * dm[(i0+4)*nao+(l0+0)];
                fz += gout7z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout8x * dm[(i0+2)*nao+(l0+0)];
                fy = gout8y * dm[(i0+2)*nao+(l0+0)];
                fz = gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                break;
                case 1:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+2)];
                fy += gout3y * dm[(j0+0)*nao+(k0+2)];
                fz += gout3z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+0)*nao+(k0+4)];
                fy += gout6y * dm[(j0+0)*nao+(k0+4)];
                fz += gout6z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                fx += gout5x * dm[(j0+0)*nao+(k0+3)];
                fy += gout5y * dm[(j0+0)*nao+(k0+3)];
                fz += gout5z * dm[(j0+0)*nao+(k0+3)];
                fx += gout8x * dm[(j0+0)*nao+(k0+5)];
                fy += gout8y * dm[(j0+0)*nao+(k0+5)];
                fz += gout8z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+0)*nao+(k0+2)];
                fy += gout4y * dm[(j0+0)*nao+(k0+2)];
                fz += gout4z * dm[(j0+0)*nao+(k0+2)];
                fx += gout7x * dm[(j0+0)*nao+(k0+4)];
                fy += gout7y * dm[(j0+0)*nao+(k0+4)];
                fz += gout7z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+1)*nao+(k0+0)];
                fy = gout0y * dm[(i0+1)*nao+(k0+0)];
                fz = gout0z * dm[(i0+1)*nao+(k0+0)];
                fx += gout3x * dm[(i0+1)*nao+(k0+2)];
                fy += gout3y * dm[(i0+1)*nao+(k0+2)];
                fz += gout3z * dm[(i0+1)*nao+(k0+2)];
                fx += gout6x * dm[(i0+1)*nao+(k0+4)];
                fy += gout6y * dm[(i0+1)*nao+(k0+4)];
                fz += gout6z * dm[(i0+1)*nao+(k0+4)];
                fx += gout2x * dm[(i0+3)*nao+(k0+1)];
                fy += gout2y * dm[(i0+3)*nao+(k0+1)];
                fz += gout2z * dm[(i0+3)*nao+(k0+1)];
                fx += gout5x * dm[(i0+3)*nao+(k0+3)];
                fy += gout5y * dm[(i0+3)*nao+(k0+3)];
                fz += gout5z * dm[(i0+3)*nao+(k0+3)];
                fx += gout8x * dm[(i0+3)*nao+(k0+5)];
                fy += gout8y * dm[(i0+3)*nao+(k0+5)];
                fz += gout8z * dm[(i0+3)*nao+(k0+5)];
                fx += gout1x * dm[(i0+5)*nao+(k0+0)];
                fy += gout1y * dm[(i0+5)*nao+(k0+0)];
                fz += gout1z * dm[(i0+5)*nao+(k0+0)];
                fx += gout4x * dm[(i0+5)*nao+(k0+2)];
                fy += gout4y * dm[(i0+5)*nao+(k0+2)];
                fz += gout4z * dm[(i0+5)*nao+(k0+2)];
                fx += gout7x * dm[(i0+5)*nao+(k0+4)];
                fy += gout7y * dm[(i0+5)*nao+(k0+4)];
                fz += gout7z * dm[(i0+5)*nao+(k0+4)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+4), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+1), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+3), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+0)];
                fy = gout8y * dm[(j0+0)*nao+(l0+0)];
                fz = gout8z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+5), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+2), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+0)];
                fy = gout7y * dm[(j0+0)*nao+(l0+0)];
                fz = gout7z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+4), fz);
                fx = gout0x * dm[(i0+1)*nao+(l0+0)];
                fy = gout0y * dm[(i0+1)*nao+(l0+0)];
                fz = gout0z * dm[(i0+1)*nao+(l0+0)];
                fx += gout1x * dm[(i0+5)*nao+(l0+0)];
                fy += gout1y * dm[(i0+5)*nao+(l0+0)];
                fz += gout1z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+3)*nao+(l0+0)];
                fy = gout2y * dm[(i0+3)*nao+(l0+0)];
                fz = gout2z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+1)*nao+(l0+0)];
                fy = gout3y * dm[(i0+1)*nao+(l0+0)];
                fz = gout3z * dm[(i0+1)*nao+(l0+0)];
                fx += gout4x * dm[(i0+5)*nao+(l0+0)];
                fy += gout4y * dm[(i0+5)*nao+(l0+0)];
                fz += gout4z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout5x * dm[(i0+3)*nao+(l0+0)];
                fy = gout5y * dm[(i0+3)*nao+(l0+0)];
                fz = gout5z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout6x * dm[(i0+1)*nao+(l0+0)];
                fy = gout6y * dm[(i0+1)*nao+(l0+0)];
                fz = gout6z * dm[(i0+1)*nao+(l0+0)];
                fx += gout7x * dm[(i0+5)*nao+(l0+0)];
                fy += gout7y * dm[(i0+5)*nao+(l0+0)];
                fz += gout7z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout8x * dm[(i0+3)*nao+(l0+0)];
                fy = gout8y * dm[(i0+3)*nao+(l0+0)];
                fz = gout8z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                break;
                case 2:
                fx = gout1x * dm[(j0+0)*nao+(k0+1)];
                fy = gout1y * dm[(j0+0)*nao+(k0+1)];
                fz = gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout4x * dm[(j0+0)*nao+(k0+3)];
                fy += gout4y * dm[(j0+0)*nao+(k0+3)];
                fz += gout4z * dm[(j0+0)*nao+(k0+3)];
                fx += gout7x * dm[(j0+0)*nao+(k0+5)];
                fy += gout7y * dm[(j0+0)*nao+(k0+5)];
                fz += gout7z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+2)];
                fy += gout3y * dm[(j0+0)*nao+(k0+2)];
                fz += gout3z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+0)*nao+(k0+4)];
                fy += gout6y * dm[(j0+0)*nao+(k0+4)];
                fz += gout6z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                fx += gout5x * dm[(j0+0)*nao+(k0+3)];
                fy += gout5y * dm[(j0+0)*nao+(k0+3)];
                fz += gout5z * dm[(j0+0)*nao+(k0+3)];
                fx += gout8x * dm[(j0+0)*nao+(k0+5)];
                fy += gout8y * dm[(j0+0)*nao+(k0+5)];
                fz += gout8z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+1)];
                fy = gout1y * dm[(i0+0)*nao+(k0+1)];
                fz = gout1z * dm[(i0+0)*nao+(k0+1)];
                fx += gout4x * dm[(i0+0)*nao+(k0+3)];
                fy += gout4y * dm[(i0+0)*nao+(k0+3)];
                fz += gout4z * dm[(i0+0)*nao+(k0+3)];
                fx += gout7x * dm[(i0+0)*nao+(k0+5)];
                fy += gout7y * dm[(i0+0)*nao+(k0+5)];
                fz += gout7z * dm[(i0+0)*nao+(k0+5)];
                fx += gout0x * dm[(i0+2)*nao+(k0+0)];
                fy += gout0y * dm[(i0+2)*nao+(k0+0)];
                fz += gout0z * dm[(i0+2)*nao+(k0+0)];
                fx += gout3x * dm[(i0+2)*nao+(k0+2)];
                fy += gout3y * dm[(i0+2)*nao+(k0+2)];
                fz += gout3z * dm[(i0+2)*nao+(k0+2)];
                fx += gout6x * dm[(i0+2)*nao+(k0+4)];
                fy += gout6y * dm[(i0+2)*nao+(k0+4)];
                fz += gout6z * dm[(i0+2)*nao+(k0+4)];
                fx += gout2x * dm[(i0+4)*nao+(k0+1)];
                fy += gout2y * dm[(i0+4)*nao+(k0+1)];
                fz += gout2z * dm[(i0+4)*nao+(k0+1)];
                fx += gout5x * dm[(i0+4)*nao+(k0+3)];
                fy += gout5y * dm[(i0+4)*nao+(k0+3)];
                fz += gout5z * dm[(i0+4)*nao+(k0+3)];
                fx += gout8x * dm[(i0+4)*nao+(k0+5)];
                fy += gout8y * dm[(i0+4)*nao+(k0+5)];
                fz += gout8z * dm[(i0+4)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+3), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+0)];
                fy = gout7y * dm[(j0+0)*nao+(l0+0)];
                fz = gout7z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+4), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+1), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+3), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+0)];
                fy = gout8y * dm[(j0+0)*nao+(l0+0)];
                fz = gout8z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+2)*nao+(l0+0)];
                fy = gout0y * dm[(i0+2)*nao+(l0+0)];
                fz = gout0z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout2x * dm[(i0+4)*nao+(l0+0)];
                fy += gout2y * dm[(i0+4)*nao+(l0+0)];
                fz += gout2z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+2)*nao+(l0+0)];
                fy = gout3y * dm[(i0+2)*nao+(l0+0)];
                fz = gout3z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                fx += gout5x * dm[(i0+4)*nao+(l0+0)];
                fy += gout5y * dm[(i0+4)*nao+(l0+0)];
                fz += gout5z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout6x * dm[(i0+2)*nao+(l0+0)];
                fy = gout6y * dm[(i0+2)*nao+(l0+0)];
                fz = gout6z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                fx += gout8x * dm[(i0+4)*nao+(l0+0)];
                fy += gout8y * dm[(i0+4)*nao+(l0+0)];
                fz += gout8z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                break;
                case 3:
                fx = gout1x * dm[(j0+0)*nao+(k0+1)];
                fy = gout1y * dm[(j0+0)*nao+(k0+1)];
                fz = gout1z * dm[(j0+0)*nao+(k0+1)];
                fx += gout4x * dm[(j0+0)*nao+(k0+3)];
                fy += gout4y * dm[(j0+0)*nao+(k0+3)];
                fz += gout4z * dm[(j0+0)*nao+(k0+3)];
                fx += gout7x * dm[(j0+0)*nao+(k0+5)];
                fy += gout7y * dm[(j0+0)*nao+(k0+5)];
                fz += gout7z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+0)*nao+(k0+2)];
                fy += gout3y * dm[(j0+0)*nao+(k0+2)];
                fz += gout3z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+0)*nao+(k0+4)];
                fy += gout6y * dm[(j0+0)*nao+(k0+4)];
                fz += gout6z * dm[(j0+0)*nao+(k0+4)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+1)];
                fy = gout2y * dm[(j0+0)*nao+(k0+1)];
                fz = gout2z * dm[(j0+0)*nao+(k0+1)];
                fx += gout5x * dm[(j0+0)*nao+(k0+3)];
                fy += gout5y * dm[(j0+0)*nao+(k0+3)];
                fz += gout5z * dm[(j0+0)*nao+(k0+3)];
                fx += gout8x * dm[(j0+0)*nao+(k0+5)];
                fy += gout8y * dm[(j0+0)*nao+(k0+5)];
                fz += gout8z * dm[(j0+0)*nao+(k0+5)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+1)*nao+(k0+1)];
                fy = gout1y * dm[(i0+1)*nao+(k0+1)];
                fz = gout1z * dm[(i0+1)*nao+(k0+1)];
                fx += gout4x * dm[(i0+1)*nao+(k0+3)];
                fy += gout4y * dm[(i0+1)*nao+(k0+3)];
                fz += gout4z * dm[(i0+1)*nao+(k0+3)];
                fx += gout7x * dm[(i0+1)*nao+(k0+5)];
                fy += gout7y * dm[(i0+1)*nao+(k0+5)];
                fz += gout7z * dm[(i0+1)*nao+(k0+5)];
                fx += gout0x * dm[(i0+3)*nao+(k0+0)];
                fy += gout0y * dm[(i0+3)*nao+(k0+0)];
                fz += gout0z * dm[(i0+3)*nao+(k0+0)];
                fx += gout3x * dm[(i0+3)*nao+(k0+2)];
                fy += gout3y * dm[(i0+3)*nao+(k0+2)];
                fz += gout3z * dm[(i0+3)*nao+(k0+2)];
                fx += gout6x * dm[(i0+3)*nao+(k0+4)];
                fy += gout6y * dm[(i0+3)*nao+(k0+4)];
                fz += gout6z * dm[(i0+3)*nao+(k0+4)];
                fx += gout2x * dm[(i0+5)*nao+(k0+1)];
                fy += gout2y * dm[(i0+5)*nao+(k0+1)];
                fz += gout2z * dm[(i0+5)*nao+(k0+1)];
                fx += gout5x * dm[(i0+5)*nao+(k0+3)];
                fy += gout5y * dm[(i0+5)*nao+(k0+3)];
                fz += gout5z * dm[(i0+5)*nao+(k0+3)];
                fx += gout8x * dm[(i0+5)*nao+(k0+5)];
                fy += gout8y * dm[(i0+5)*nao+(k0+5)];
                fz += gout8z * dm[(i0+5)*nao+(k0+5)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+3), fz);
                fx = gout7x * dm[(j0+0)*nao+(l0+0)];
                fy = gout7y * dm[(j0+0)*nao+(l0+0)];
                fz = gout7z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+2), fz);
                fx = gout6x * dm[(j0+0)*nao+(l0+0)];
                fy = gout6y * dm[(j0+0)*nao+(l0+0)];
                fz = gout6z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+4), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+4), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+4), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+1), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+3), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+3), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+3), fz);
                fx = gout8x * dm[(j0+0)*nao+(l0+0)];
                fy = gout8y * dm[(j0+0)*nao+(l0+0)];
                fz = gout8z * dm[(j0+0)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+5), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+5), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+5), fz);
                fx = gout0x * dm[(i0+3)*nao+(l0+0)];
                fy = gout0y * dm[(i0+3)*nao+(l0+0)];
                fz = gout0z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+5)*nao+(l0+0)];
                fy += gout2y * dm[(i0+5)*nao+(l0+0)];
                fz += gout2z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout3x * dm[(i0+3)*nao+(l0+0)];
                fy = gout3y * dm[(i0+3)*nao+(l0+0)];
                fz = gout3z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+0)];
                fy = gout4y * dm[(i0+1)*nao+(l0+0)];
                fz = gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout5x * dm[(i0+5)*nao+(l0+0)];
                fy += gout5y * dm[(i0+5)*nao+(l0+0)];
                fz += gout5z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+3), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+3), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+3), fz);
                fx = gout6x * dm[(i0+3)*nao+(l0+0)];
                fy = gout6y * dm[(i0+3)*nao+(l0+0)];
                fz = gout6z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+4), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+4), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+4), fz);
                fx = gout7x * dm[(i0+1)*nao+(l0+0)];
                fy = gout7y * dm[(i0+1)*nao+(l0+0)];
                fz = gout7z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+5)*nao+(l0+0)];
                fy += gout8y * dm[(i0+5)*nao+(l0+0)];
                fz += gout8z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+5), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+5), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+5), fz);
                break;
                }
            }
        }
    }
}
__global__
static void rys_vjk_ip1_2020(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_2020(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_2100(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double gout14x, gout14y, gout14z;
    double gout15x, gout15y, gout15z;
    double gout16x, gout16y, gout16z;
    double gout17x, gout17y, gout17z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        gout14x = 0;
        gout14y = 0;
        gout14z = 0;
        gout15x = 0;
        gout15y = 0;
        gout15z = 0;
        gout16x = 0;
        gout16y = 0;
        gout16z = 0;
        gout17x = 0;
        gout17y = 0;
        gout17z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xqc = xlxk * al_akl;
                double yqc = ylyk * al_akl;
                double zqc = zlzk * al_akl;
                double xkl = rk[0] + xqc;
                double ykl = rk[1] + yqc;
                double zkl = rk[2] + zqc;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                rys_roots_rs(nroots, theta, rr, omega, rw, nsq_per_block, 0, 1);
                if (task_id >= ntasks) {
                    continue;
                }
                for (int irys = 0; irys < nroots; ++irys) {
                    double wt = rw[(2*irys+1)*nsq_per_block] * fac;
                    double rt = rw[ 2*irys   *nsq_per_block];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    ai2 = rjri[5];
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double c0x = rjri[0] * aj_aij - xpq*rt_aij;
                    double trr_10x = c0x * 1;
                    double trr_20x = c0x * trr_10x + 1*b10 * 1;
                    double trr_30x = c0x * trr_20x + 2*b10 * trr_10x;
                    double trr_40x = c0x * trr_30x + 3*b10 * trr_20x;
                    double hrr_3100x = trr_40x - rjri[0] * trr_30x;
                    fx = ai2 * hrr_3100x;
                    double c0y = rjri[1] * aj_aij - ypq*rt_aij;
                    double trr_10y = c0y * 1;
                    fy = ai2 * trr_10y;
                    double c0z = rjri[2] * aj_aij - zpq*rt_aij;
                    double trr_10z = c0z * wt;
                    fz = ai2 * trr_10z;
                    double hrr_1100x = trr_20x - rjri[0] * trr_10x;
                    fx -= 2 * hrr_1100x;
                    double hrr_2100x = trr_30x - rjri[0] * trr_20x;
                    gout0x +=  fx  * 1 * wt;
                    gout0y += hrr_2100x *  fy  * wt;
                    gout0z += hrr_2100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_2100x;
                    double trr_20y = c0y * trr_10y + 1*b10 * 1;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_10z;
                    double hrr_0100x = trr_10x - rjri[0] * 1;
                    fx -= 1 * hrr_0100x;
                    fy -= 1 * 1;
                    gout1x +=  fx  * trr_10y * wt;
                    gout1y += hrr_1100x *  fy  * wt;
                    gout1z += hrr_1100x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_2100x;
                    fy = ai2 * trr_10y;
                    double trr_20z = c0z * trr_10z + 1*b10 * wt;
                    fz = ai2 * trr_20z;
                    fx -= 1 * hrr_0100x;
                    fz -= 1 * wt;
                    gout2x +=  fx  * 1 * trr_10z;
                    gout2y += hrr_1100x *  fy  * trr_10z;
                    gout2z += hrr_1100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    double trr_30y = c0y * trr_20y + 2*b10 * trr_10y;
                    fy = ai2 * trr_30y;
                    fz = ai2 * trr_10z;
                    fy -= 2 * trr_10y;
                    gout3x +=  fx  * trr_20y * wt;
                    gout3y += hrr_0100x *  fy  * wt;
                    gout3z += hrr_0100x * trr_20y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * trr_20z;
                    fy -= 1 * 1;
                    fz -= 1 * wt;
                    gout4x +=  fx  * trr_10y * trr_10z;
                    gout4y += hrr_0100x *  fy  * trr_10z;
                    gout4z += hrr_0100x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * hrr_1100x;
                    fy = ai2 * trr_10y;
                    double trr_30z = c0z * trr_20z + 2*b10 * trr_10z;
                    fz = ai2 * trr_30z;
                    fz -= 2 * trr_10z;
                    gout5x +=  fx  * 1 * trr_20z;
                    gout5y += hrr_0100x *  fy  * trr_20z;
                    gout5z += hrr_0100x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_30x;
                    double hrr_1100y = trr_20y - rjri[1] * trr_10y;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_10z;
                    fx -= 2 * trr_10x;
                    double hrr_0100y = trr_10y - rjri[1] * 1;
                    gout6x +=  fx  * hrr_0100y * wt;
                    gout6y += trr_20x *  fy  * wt;
                    gout6z += trr_20x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    double hrr_2100y = trr_30y - rjri[1] * trr_20y;
                    fy = ai2 * hrr_2100y;
                    fz = ai2 * trr_10z;
                    fx -= 1 * 1;
                    fy -= 1 * hrr_0100y;
                    gout7x +=  fx  * hrr_1100y * wt;
                    gout7y += trr_10x *  fy  * wt;
                    gout7z += trr_10x * hrr_1100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_20z;
                    fx -= 1 * 1;
                    fz -= 1 * wt;
                    gout8x +=  fx  * hrr_0100y * trr_10z;
                    gout8y += trr_10x *  fy  * trr_10z;
                    gout8z += trr_10x * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    double trr_40y = c0y * trr_30y + 3*b10 * trr_20y;
                    double hrr_3100y = trr_40y - rjri[1] * trr_30y;
                    fy = ai2 * hrr_3100y;
                    fz = ai2 * trr_10z;
                    fy -= 2 * hrr_1100y;
                    gout9x +=  fx  * hrr_2100y * wt;
                    gout9y += 1 *  fy  * wt;
                    gout9z += 1 * hrr_2100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_2100y;
                    fz = ai2 * trr_20z;
                    fy -= 1 * hrr_0100y;
                    fz -= 1 * wt;
                    gout10x +=  fx  * hrr_1100y * trr_10z;
                    gout10y += 1 *  fy  * trr_10z;
                    gout10z += 1 * hrr_1100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * hrr_1100y;
                    fz = ai2 * trr_30z;
                    fz -= 2 * trr_10z;
                    gout11x +=  fx  * hrr_0100y * trr_20z;
                    gout11y += 1 *  fy  * trr_20z;
                    gout11z += 1 * hrr_0100y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_30x;
                    fy = ai2 * trr_10y;
                    double hrr_1100z = trr_20z - rjri[2] * trr_10z;
                    fz = ai2 * hrr_1100z;
                    fx -= 2 * trr_10x;
                    double hrr_0100z = trr_10z - rjri[2] * wt;
                    gout12x +=  fx  * 1 * hrr_0100z;
                    gout12y += trr_20x *  fy  * hrr_0100z;
                    gout12z += trr_20x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * hrr_1100z;
                    fx -= 1 * 1;
                    fy -= 1 * 1;
                    gout13x +=  fx  * trr_10y * hrr_0100z;
                    gout13y += trr_10x *  fy  * hrr_0100z;
                    gout13z += trr_10x * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_20x;
                    fy = ai2 * trr_10y;
                    double hrr_2100z = trr_30z - rjri[2] * trr_20z;
                    fz = ai2 * hrr_2100z;
                    fx -= 1 * 1;
                    fz -= 1 * hrr_0100z;
                    gout14x +=  fx  * 1 * hrr_1100z;
                    gout14y += trr_10x *  fy  * hrr_1100z;
                    gout14z += trr_10x * 1 *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_30y;
                    fz = ai2 * hrr_1100z;
                    fy -= 2 * trr_10y;
                    gout15x +=  fx  * trr_20y * hrr_0100z;
                    gout15y += 1 *  fy  * hrr_0100z;
                    gout15z += 1 * trr_20y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_20y;
                    fz = ai2 * hrr_2100z;
                    fy -= 1 * 1;
                    fz -= 1 * hrr_0100z;
                    gout16x +=  fx  * trr_10y * hrr_1100z;
                    gout16y += 1 *  fy  * hrr_1100z;
                    gout16z += 1 * trr_10y *  fz ;
                    ai2 = rjri[5];
                    fx = ai2 * trr_10x;
                    fy = ai2 * trr_10y;
                    double trr_40z = c0z * trr_30z + 3*b10 * trr_20z;
                    double hrr_3100z = trr_40z - rjri[2] * trr_30z;
                    fz = ai2 * hrr_3100z;
                    fz -= 2 * hrr_1100z;
                    gout17x +=  fx  * 1 * hrr_2100z;
                    gout17y += 1 *  fy  * hrr_2100z;
                    gout17z += 1 * 1 *  fz ;
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+0)];
                fy = gout6y * dm[(l0+0)*nao+(k0+0)];
                fz = gout6z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout12x * dm[(l0+0)*nao+(k0+0)];
                fy = gout12y * dm[(l0+0)*nao+(k0+0)];
                fz = gout12z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+0)];
                fy = gout7y * dm[(l0+0)*nao+(k0+0)];
                fz = gout7z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout13x * dm[(l0+0)*nao+(k0+0)];
                fy = gout13y * dm[(l0+0)*nao+(k0+0)];
                fz = gout13z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+0)];
                fy = gout8y * dm[(l0+0)*nao+(k0+0)];
                fz = gout8z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout14x * dm[(l0+0)*nao+(k0+0)];
                fy = gout14y * dm[(l0+0)*nao+(k0+0)];
                fz = gout14z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+0), fz);
                fx = gout9x * dm[(l0+0)*nao+(k0+0)];
                fy = gout9y * dm[(l0+0)*nao+(k0+0)];
                fz = gout9z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+1), fz);
                fx = gout15x * dm[(l0+0)*nao+(k0+0)];
                fy = gout15y * dm[(l0+0)*nao+(k0+0)];
                fz = gout15z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+2), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+0), fz);
                fx = gout10x * dm[(l0+0)*nao+(k0+0)];
                fy = gout10y * dm[(l0+0)*nao+(k0+0)];
                fz = gout10z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+1), fz);
                fx = gout16x * dm[(l0+0)*nao+(k0+0)];
                fy = gout16y * dm[(l0+0)*nao+(k0+0)];
                fz = gout16z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+2), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+0), fz);
                fx = gout11x * dm[(l0+0)*nao+(k0+0)];
                fy = gout11y * dm[(l0+0)*nao+(k0+0)];
                fz = gout11z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+1), fz);
                fx = gout17x * dm[(l0+0)*nao+(k0+0)];
                fy = gout17y * dm[(l0+0)*nao+(k0+0)];
                fz = gout17z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+1)];
                fy += gout1y * dm[(j0+0)*nao+(i0+1)];
                fz += gout1z * dm[(j0+0)*nao+(i0+1)];
                fx += gout2x * dm[(j0+0)*nao+(i0+2)];
                fy += gout2y * dm[(j0+0)*nao+(i0+2)];
                fz += gout2z * dm[(j0+0)*nao+(i0+2)];
                fx += gout3x * dm[(j0+0)*nao+(i0+3)];
                fy += gout3y * dm[(j0+0)*nao+(i0+3)];
                fz += gout3z * dm[(j0+0)*nao+(i0+3)];
                fx += gout4x * dm[(j0+0)*nao+(i0+4)];
                fy += gout4y * dm[(j0+0)*nao+(i0+4)];
                fz += gout4z * dm[(j0+0)*nao+(i0+4)];
                fx += gout5x * dm[(j0+0)*nao+(i0+5)];
                fy += gout5y * dm[(j0+0)*nao+(i0+5)];
                fz += gout5z * dm[(j0+0)*nao+(i0+5)];
                fx += gout6x * dm[(j0+1)*nao+(i0+0)];
                fy += gout6y * dm[(j0+1)*nao+(i0+0)];
                fz += gout6z * dm[(j0+1)*nao+(i0+0)];
                fx += gout7x * dm[(j0+1)*nao+(i0+1)];
                fy += gout7y * dm[(j0+1)*nao+(i0+1)];
                fz += gout7z * dm[(j0+1)*nao+(i0+1)];
                fx += gout8x * dm[(j0+1)*nao+(i0+2)];
                fy += gout8y * dm[(j0+1)*nao+(i0+2)];
                fz += gout8z * dm[(j0+1)*nao+(i0+2)];
                fx += gout9x * dm[(j0+1)*nao+(i0+3)];
                fy += gout9y * dm[(j0+1)*nao+(i0+3)];
                fz += gout9z * dm[(j0+1)*nao+(i0+3)];
                fx += gout10x * dm[(j0+1)*nao+(i0+4)];
                fy += gout10y * dm[(j0+1)*nao+(i0+4)];
                fz += gout10z * dm[(j0+1)*nao+(i0+4)];
                fx += gout11x * dm[(j0+1)*nao+(i0+5)];
                fy += gout11y * dm[(j0+1)*nao+(i0+5)];
                fz += gout11z * dm[(j0+1)*nao+(i0+5)];
                fx += gout12x * dm[(j0+2)*nao+(i0+0)];
                fy += gout12y * dm[(j0+2)*nao+(i0+0)];
                fz += gout12z * dm[(j0+2)*nao+(i0+0)];
                fx += gout13x * dm[(j0+2)*nao+(i0+1)];
                fy += gout13y * dm[(j0+2)*nao+(i0+1)];
                fz += gout13z * dm[(j0+2)*nao+(i0+1)];
                fx += gout14x * dm[(j0+2)*nao+(i0+2)];
                fy += gout14y * dm[(j0+2)*nao+(i0+2)];
                fz += gout14z * dm[(j0+2)*nao+(i0+2)];
                fx += gout15x * dm[(j0+2)*nao+(i0+3)];
                fy += gout15y * dm[(j0+2)*nao+(i0+3)];
                fz += gout15z * dm[(j0+2)*nao+(i0+3)];
                fx += gout16x * dm[(j0+2)*nao+(i0+4)];
                fy += gout16y * dm[(j0+2)*nao+(i0+4)];
                fz += gout16z * dm[(j0+2)*nao+(i0+4)];
                fx += gout17x * dm[(j0+2)*nao+(i0+5)];
                fy += gout17y * dm[(j0+2)*nao+(i0+5)];
                fz += gout17z * dm[(j0+2)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
            }
            if (do_k) {
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout6x * dm[(j0+1)*nao+(k0+0)];
                fy += gout6y * dm[(j0+1)*nao+(k0+0)];
                fz += gout6z * dm[(j0+1)*nao+(k0+0)];
                fx += gout12x * dm[(j0+2)*nao+(k0+0)];
                fy += gout12y * dm[(j0+2)*nao+(k0+0)];
                fz += gout12z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout7x * dm[(j0+1)*nao+(k0+0)];
                fy += gout7y * dm[(j0+1)*nao+(k0+0)];
                fz += gout7z * dm[(j0+1)*nao+(k0+0)];
                fx += gout13x * dm[(j0+2)*nao+(k0+0)];
                fy += gout13y * dm[(j0+2)*nao+(k0+0)];
                fz += gout13z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(k0+0)];
                fy = gout2y * dm[(j0+0)*nao+(k0+0)];
                fz = gout2z * dm[(j0+0)*nao+(k0+0)];
                fx += gout8x * dm[(j0+1)*nao+(k0+0)];
                fy += gout8y * dm[(j0+1)*nao+(k0+0)];
                fz += gout8z * dm[(j0+1)*nao+(k0+0)];
                fx += gout14x * dm[(j0+2)*nao+(k0+0)];
                fy += gout14y * dm[(j0+2)*nao+(k0+0)];
                fz += gout14z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(k0+0)];
                fy = gout3y * dm[(j0+0)*nao+(k0+0)];
                fz = gout3z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+1)*nao+(k0+0)];
                fy += gout9y * dm[(j0+1)*nao+(k0+0)];
                fz += gout9z * dm[(j0+1)*nao+(k0+0)];
                fx += gout15x * dm[(j0+2)*nao+(k0+0)];
                fy += gout15y * dm[(j0+2)*nao+(k0+0)];
                fz += gout15z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(k0+0)];
                fy = gout4y * dm[(j0+0)*nao+(k0+0)];
                fz = gout4z * dm[(j0+0)*nao+(k0+0)];
                fx += gout10x * dm[(j0+1)*nao+(k0+0)];
                fy += gout10y * dm[(j0+1)*nao+(k0+0)];
                fz += gout10z * dm[(j0+1)*nao+(k0+0)];
                fx += gout16x * dm[(j0+2)*nao+(k0+0)];
                fy += gout16y * dm[(j0+2)*nao+(k0+0)];
                fz += gout16z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+0)];
                fy = gout5y * dm[(j0+0)*nao+(k0+0)];
                fz = gout5z * dm[(j0+0)*nao+(k0+0)];
                fx += gout11x * dm[(j0+1)*nao+(k0+0)];
                fy += gout11y * dm[(j0+1)*nao+(k0+0)];
                fz += gout11z * dm[(j0+1)*nao+(k0+0)];
                fx += gout17x * dm[(j0+2)*nao+(k0+0)];
                fy += gout17y * dm[(j0+2)*nao+(k0+0)];
                fz += gout17z * dm[(j0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+1)*nao+(k0+0)];
                fy += gout1y * dm[(i0+1)*nao+(k0+0)];
                fz += gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                fx += gout3x * dm[(i0+3)*nao+(k0+0)];
                fy += gout3y * dm[(i0+3)*nao+(k0+0)];
                fz += gout3z * dm[(i0+3)*nao+(k0+0)];
                fx += gout4x * dm[(i0+4)*nao+(k0+0)];
                fy += gout4y * dm[(i0+4)*nao+(k0+0)];
                fz += gout4z * dm[(i0+4)*nao+(k0+0)];
                fx += gout5x * dm[(i0+5)*nao+(k0+0)];
                fy += gout5y * dm[(i0+5)*nao+(k0+0)];
                fz += gout5z * dm[(i0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+0)];
                fy = gout6y * dm[(i0+0)*nao+(k0+0)];
                fz = gout6z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+1)*nao+(k0+0)];
                fy += gout7y * dm[(i0+1)*nao+(k0+0)];
                fz += gout7z * dm[(i0+1)*nao+(k0+0)];
                fx += gout8x * dm[(i0+2)*nao+(k0+0)];
                fy += gout8y * dm[(i0+2)*nao+(k0+0)];
                fz += gout8z * dm[(i0+2)*nao+(k0+0)];
                fx += gout9x * dm[(i0+3)*nao+(k0+0)];
                fy += gout9y * dm[(i0+3)*nao+(k0+0)];
                fz += gout9z * dm[(i0+3)*nao+(k0+0)];
                fx += gout10x * dm[(i0+4)*nao+(k0+0)];
                fy += gout10y * dm[(i0+4)*nao+(k0+0)];
                fz += gout10z * dm[(i0+4)*nao+(k0+0)];
                fx += gout11x * dm[(i0+5)*nao+(k0+0)];
                fy += gout11y * dm[(i0+5)*nao+(k0+0)];
                fz += gout11z * dm[(i0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout12x * dm[(i0+0)*nao+(k0+0)];
                fy = gout12y * dm[(i0+0)*nao+(k0+0)];
                fz = gout12z * dm[(i0+0)*nao+(k0+0)];
                fx += gout13x * dm[(i0+1)*nao+(k0+0)];
                fy += gout13y * dm[(i0+1)*nao+(k0+0)];
                fz += gout13z * dm[(i0+1)*nao+(k0+0)];
                fx += gout14x * dm[(i0+2)*nao+(k0+0)];
                fy += gout14y * dm[(i0+2)*nao+(k0+0)];
                fz += gout14z * dm[(i0+2)*nao+(k0+0)];
                fx += gout15x * dm[(i0+3)*nao+(k0+0)];
                fy += gout15y * dm[(i0+3)*nao+(k0+0)];
                fz += gout15z * dm[(i0+3)*nao+(k0+0)];
                fx += gout16x * dm[(i0+4)*nao+(k0+0)];
                fy += gout16y * dm[(i0+4)*nao+(k0+0)];
                fz += gout16z * dm[(i0+4)*nao+(k0+0)];
                fx += gout17x * dm[(i0+5)*nao+(k0+0)];
                fy += gout17y * dm[(i0+5)*nao+(k0+0)];
                fz += gout17z * dm[(i0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout6x * dm[(j0+1)*nao+(l0+0)];
                fy += gout6y * dm[(j0+1)*nao+(l0+0)];
                fz += gout6z * dm[(j0+1)*nao+(l0+0)];
                fx += gout12x * dm[(j0+2)*nao+(l0+0)];
                fy += gout12y * dm[(j0+2)*nao+(l0+0)];
                fz += gout12z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout7x * dm[(j0+1)*nao+(l0+0)];
                fy += gout7y * dm[(j0+1)*nao+(l0+0)];
                fz += gout7z * dm[(j0+1)*nao+(l0+0)];
                fx += gout13x * dm[(j0+2)*nao+(l0+0)];
                fy += gout13y * dm[(j0+2)*nao+(l0+0)];
                fz += gout13z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+0)*nao+(l0+0)];
                fy = gout2y * dm[(j0+0)*nao+(l0+0)];
                fz = gout2z * dm[(j0+0)*nao+(l0+0)];
                fx += gout8x * dm[(j0+1)*nao+(l0+0)];
                fy += gout8y * dm[(j0+1)*nao+(l0+0)];
                fz += gout8z * dm[(j0+1)*nao+(l0+0)];
                fx += gout14x * dm[(j0+2)*nao+(l0+0)];
                fy += gout14y * dm[(j0+2)*nao+(l0+0)];
                fz += gout14z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout3x * dm[(j0+0)*nao+(l0+0)];
                fy = gout3y * dm[(j0+0)*nao+(l0+0)];
                fz = gout3z * dm[(j0+0)*nao+(l0+0)];
                fx += gout9x * dm[(j0+1)*nao+(l0+0)];
                fy += gout9y * dm[(j0+1)*nao+(l0+0)];
                fz += gout9z * dm[(j0+1)*nao+(l0+0)];
                fx += gout15x * dm[(j0+2)*nao+(l0+0)];
                fy += gout15y * dm[(j0+2)*nao+(l0+0)];
                fz += gout15z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout10x * dm[(j0+1)*nao+(l0+0)];
                fy += gout10y * dm[(j0+1)*nao+(l0+0)];
                fz += gout10z * dm[(j0+1)*nao+(l0+0)];
                fx += gout16x * dm[(j0+2)*nao+(l0+0)];
                fy += gout16y * dm[(j0+2)*nao+(l0+0)];
                fz += gout16z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                fx += gout11x * dm[(j0+1)*nao+(l0+0)];
                fy += gout11y * dm[(j0+1)*nao+(l0+0)];
                fz += gout11z * dm[(j0+1)*nao+(l0+0)];
                fx += gout17x * dm[(j0+2)*nao+(l0+0)];
                fy += gout17y * dm[(j0+2)*nao+(l0+0)];
                fz += gout17z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+1)*nao+(l0+0)];
                fy += gout1y * dm[(i0+1)*nao+(l0+0)];
                fz += gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+2)*nao+(l0+0)];
                fy += gout2y * dm[(i0+2)*nao+(l0+0)];
                fz += gout2z * dm[(i0+2)*nao+(l0+0)];
                fx += gout3x * dm[(i0+3)*nao+(l0+0)];
                fy += gout3y * dm[(i0+3)*nao+(l0+0)];
                fz += gout3z * dm[(i0+3)*nao+(l0+0)];
                fx += gout4x * dm[(i0+4)*nao+(l0+0)];
                fy += gout4y * dm[(i0+4)*nao+(l0+0)];
                fz += gout4z * dm[(i0+4)*nao+(l0+0)];
                fx += gout5x * dm[(i0+5)*nao+(l0+0)];
                fy += gout5y * dm[(i0+5)*nao+(l0+0)];
                fz += gout5z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+1)*nao+(l0+0)];
                fy += gout7y * dm[(i0+1)*nao+(l0+0)];
                fz += gout7z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+2)*nao+(l0+0)];
                fy += gout8y * dm[(i0+2)*nao+(l0+0)];
                fz += gout8z * dm[(i0+2)*nao+(l0+0)];
                fx += gout9x * dm[(i0+3)*nao+(l0+0)];
                fy += gout9y * dm[(i0+3)*nao+(l0+0)];
                fz += gout9z * dm[(i0+3)*nao+(l0+0)];
                fx += gout10x * dm[(i0+4)*nao+(l0+0)];
                fy += gout10y * dm[(i0+4)*nao+(l0+0)];
                fz += gout10z * dm[(i0+4)*nao+(l0+0)];
                fx += gout11x * dm[(i0+5)*nao+(l0+0)];
                fy += gout11y * dm[(i0+5)*nao+(l0+0)];
                fz += gout11z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+1)*nao+(l0+0)];
                fy += gout13y * dm[(i0+1)*nao+(l0+0)];
                fz += gout13z * dm[(i0+1)*nao+(l0+0)];
                fx += gout14x * dm[(i0+2)*nao+(l0+0)];
                fy += gout14y * dm[(i0+2)*nao+(l0+0)];
                fz += gout14z * dm[(i0+2)*nao+(l0+0)];
                fx += gout15x * dm[(i0+3)*nao+(l0+0)];
                fy += gout15y * dm[(i0+3)*nao+(l0+0)];
                fz += gout15z * dm[(i0+3)*nao+(l0+0)];
                fx += gout16x * dm[(i0+4)*nao+(l0+0)];
                fy += gout16y * dm[(i0+4)*nao+(l0+0)];
                fz += gout16z * dm[(i0+4)*nao+(l0+0)];
                fx += gout17x * dm[(i0+5)*nao+(l0+0)];
                fy += gout17y * dm[(i0+5)*nao+(l0+0)];
                fz += gout17z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
            }
        }
    }
}
__global__
static void rys_vjk_ip1_2100(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_2100(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_2110(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;
    double *gx = rw + 128 * nroots;
    double *gy = gx + 1024;
    double *gz = gy + 1024;
    double *rlrk = gz + 1024;
    double *Rpq = rlrk + 192;
    if (gout_id == 0) {
        gx[0] = 1.;
        gy[0] = 1.;
    }
    double s0, s1, s2;
    double Ix, Iy, Iz;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double gout9x, gout9y, gout9z;
    double gout10x, gout10y, gout10z;
    double gout11x, gout11y, gout11z;
    double gout12x, gout12y, gout12z;
    double gout13x, gout13y, gout13z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        if (gout_id == 0) {
            rlrk[0] = xlxk;
            rlrk[64] = ylyk;
            rlrk[128] = zlzk;
        }
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        gout9x = 0;
        gout9y = 0;
        gout9z = 0;
        gout10x = 0;
        gout10y = 0;
        gout10z = 0;
        gout11x = 0;
        gout11y = 0;
        gout11z = 0;
        gout12x = 0;
        gout12y = 0;
        gout12z = 0;
        gout13x = 0;
        gout13y = 0;
        gout13z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            __syncthreads();
            double xlxk = rlrk[0];
            double ylyk = rlrk[64];
            double zlzk = rlrk[128];
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xkl = rk[0] + rlrk[0] * al_akl;
                double ykl = rk[1] + rlrk[64] * al_akl;
                double zkl = rk[2] + rlrk[128] * al_akl;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                __syncthreads();
                if (gout_id == 0) {
                    Rpq[0] = xpq;
                    Rpq[64] = ypq;
                    Rpq[128] = zpq;
                }
                rys_roots_rs(nroots, theta, rr, omega, rw, 64, gout_id, 4);
                for (int irys = 0; irys < nroots; ++irys) {
                    __syncthreads();
                    double rt = rw[irys*128];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    double rt_akl = rt_aa * aij;
                    double b00 = .5 * rt_aa;
                    for (int n = gout_id; n < 3; n += 4) {
                        if (n == 2) {
                            gz[0] = rw[irys*128+64] * fac;
                        }
                        double *_gx = gx + n * 1024;
                        double xjxi = rjri[n];
                        double Rpa = xjxi * aj_aij;
                        double c0x = Rpa - rt_aij * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = c0x * s0;
                        _gx[64] = s1;
                        s2 = c0x * s1 + 1 * b10 * s0;
                        _gx[128] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 2 * b10 * s0;
                        _gx[192] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 3 * b10 * s0;
                        _gx[256] = s2;
                        double xlxk = rlrk[n*64];
                        double Rqc = xlxk * al_akl;
                        double cpx = Rqc + rt_akl * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = cpx * s0;
                        _gx[512] = s1;
                        s0 = _gx[64];
                        s1 = cpx * s0;
                        s1 += 1 * b00 * _gx[0];
                        _gx[576] = s1;
                        s0 = _gx[128];
                        s1 = cpx * s0;
                        s1 += 2 * b00 * _gx[64];
                        _gx[640] = s1;
                        s0 = _gx[192];
                        s1 = cpx * s0;
                        s1 += 3 * b00 * _gx[128];
                        _gx[704] = s1;
                        s0 = _gx[256];
                        s1 = cpx * s0;
                        s1 += 4 * b00 * _gx[192];
                        _gx[768] = s1;
                        s1 = _gx[256];
                        s0 = _gx[192];
                        _gx[448] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[128];
                        _gx[384] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[320] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[256] = s1 - xjxi * s0;
                        s1 = _gx[768];
                        s0 = _gx[704];
                        _gx[960] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[640];
                        _gx[896] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[576];
                        _gx[832] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[512];
                        _gx[768] = s1 - xjxi * s0;
                    }
                    __syncthreads();
                    switch (gout_id) {
                    case 0:
                    ai2 = rjri[5];
                    Ix = gx[896];
                    Iy = gy[0];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[960] - 2 * gx[832]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[64];
                    Iz = gz[64];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout1z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[256];
                    Iz = gz[64];
                    gout2x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout2y += ai2 * gy[320] * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[0];
                    Iz = gz[256];
                    gout3x += (ai2 * gx[704] - 2 * gx[576]) * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[64];
                    Iz = gz[320];
                    gout4x += ai2 * gx[576] * Iy * Iz;
                    gout4y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout4z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[512];
                    Iz = gz[64];
                    gout5x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout5y += ai2 * gy[576] * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[768];
                    Iz = gz[0];
                    gout6x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout6y += ai2 * gy[832] * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[832];
                    Iz = gz[64];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout7z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[512];
                    Iz = gz[320];
                    gout8x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout8y += ai2 * gy[576] * Ix * Iz;
                    gout8z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[0];
                    Iz = gz[512];
                    gout9x += (ai2 * gx[448] - 2 * gx[320]) * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[64];
                    Iz = gz[576];
                    gout10x += ai2 * gx[320] * Iy * Iz;
                    gout10y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout10z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[256];
                    Iz = gz[576];
                    gout11x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout11y += ai2 * gy[320] * Ix * Iz;
                    gout11z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[0];
                    Iz = gz[768];
                    gout12x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout12y += ai2 * gy[64] * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[64];
                    Iz = gz[832];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout13z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    break;
                    case 1:
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[64];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout0y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[0];
                    Iz = gz[128];
                    gout1x += ai2 * gx[832] * Iy * Iz;
                    gout1y += ai2 * gy[64] * Ix * Iz;
                    gout1z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[384];
                    Iz = gz[0];
                    gout2x += ai2 * gx[576] * Iy * Iz;
                    gout2y += (ai2 * gy[448] - 2 * gy[320]) * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[64];
                    Iz = gz[256];
                    gout3x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout3y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[0];
                    Iz = gz[384];
                    gout4x += ai2 * gx[576] * Iy * Iz;
                    gout4y += ai2 * gy[64] * Ix * Iz;
                    gout4z += (ai2 * gz[448] - 2 * gz[320]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[640];
                    Iz = gz[0];
                    gout5x += ai2 * gx[320] * Iy * Iz;
                    gout5y += (ai2 * gy[704] - 2 * gy[576]) * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[832];
                    Iz = gz[0];
                    gout6x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout6y += (ai2 * gy[896] - 1 * gy[768]) * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[768];
                    Iz = gz[128];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[832] * Ix * Iz;
                    gout7z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[640];
                    Iz = gz[256];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += (ai2 * gy[704] - 2 * gy[576]) * Ix * Iz;
                    gout8z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[64];
                    Iz = gz[512];
                    gout9x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout9y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout9z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[0];
                    Iz = gz[640];
                    gout10x += ai2 * gx[320] * Iy * Iz;
                    gout10y += ai2 * gy[64] * Ix * Iz;
                    gout10z += (ai2 * gz[704] - 2 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[384];
                    Iz = gz[512];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += (ai2 * gy[448] - 2 * gy[320]) * Ix * Iz;
                    gout11z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[64];
                    Iz = gz[768];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[0];
                    Iz = gz[896];
                    gout13x += ai2 * gx[64] * Iy * Iz;
                    gout13y += ai2 * gy[64] * Ix * Iz;
                    gout13z += (ai2 * gz[960] - 2 * gz[832]) * Ix * Iy;
                    break;
                    case 2:
                    ai2 = rjri[5];
                    Ix = gx[832];
                    Iy = gy[0];
                    Iz = gz[64];
                    gout0x += (ai2 * gx[896] - 1 * gx[768]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[256];
                    Iz = gz[0];
                    gout1x += (ai2 * gx[704] - 2 * gx[576]) * Iy * Iz;
                    gout1y += ai2 * gy[320] * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[320];
                    Iz = gz[64];
                    gout2x += ai2 * gx[576] * Iy * Iz;
                    gout2y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[0];
                    Iz = gz[320];
                    gout3x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[512];
                    Iz = gz[0];
                    gout4x += (ai2 * gx[448] - 2 * gx[320]) * Iy * Iz;
                    gout4y += ai2 * gy[576] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[576];
                    Iz = gz[64];
                    gout5x += ai2 * gx[320] * Iy * Iz;
                    gout5y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[768];
                    Iz = gz[64];
                    gout6x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout6y += ai2 * gy[832] * Ix * Iz;
                    gout6z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[512];
                    Iz = gz[256];
                    gout7x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout7y += ai2 * gy[576] * Ix * Iz;
                    gout7z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[576];
                    Iz = gz[320];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout8z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[0];
                    Iz = gz[576];
                    gout9x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout9y += ai2 * gy[64] * Ix * Iz;
                    gout9z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[256];
                    Iz = gz[512];
                    gout10x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout10y += ai2 * gy[320] * Ix * Iz;
                    gout10z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[320];
                    Iz = gz[576];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout11z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[0];
                    Iz = gz[832];
                    gout12x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout12y += ai2 * gy[64] * Ix * Iz;
                    gout12z += (ai2 * gz[896] - 1 * gz[768]) * Ix * Iy;
                    break;
                    case 3:
                    ai2 = rjri[5];
                    Ix = gx[768];
                    Iy = gy[128];
                    Iz = gz[0];
                    gout0x += ai2 * gx[832] * Iy * Iz;
                    gout0y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[320];
                    Iz = gz[0];
                    gout1x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout1y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[256];
                    Iz = gz[128];
                    gout2x += ai2 * gx[576] * Iy * Iz;
                    gout2y += ai2 * gy[320] * Ix * Iz;
                    gout2z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[128];
                    Iz = gz[256];
                    gout3x += ai2 * gx[576] * Iy * Iz;
                    gout3y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[576];
                    Iz = gz[0];
                    gout4x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout4y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[512];
                    Iz = gz[128];
                    gout5x += ai2 * gx[320] * Iy * Iz;
                    gout5y += ai2 * gy[576] * Ix * Iz;
                    gout5z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[896];
                    Iz = gz[0];
                    gout6x += ai2 * gx[64] * Iy * Iz;
                    gout6y += (ai2 * gy[960] - 2 * gy[832]) * Ix * Iz;
                    gout6z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[576];
                    Iz = gz[256];
                    gout7x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout7y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout7z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[512];
                    Iz = gz[384];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[576] * Ix * Iz;
                    gout8z += (ai2 * gz[448] - 2 * gz[320]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[128];
                    Iz = gz[512];
                    gout9x += ai2 * gx[320] * Iy * Iz;
                    gout9y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout9z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[320];
                    Iz = gz[512];
                    gout10x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout10y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout10z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[256];
                    Iz = gz[640];
                    gout11x += ai2 * gx[64] * Iy * Iz;
                    gout11y += ai2 * gy[320] * Ix * Iz;
                    gout11z += (ai2 * gz[704] - 2 * gz[576]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[128];
                    Iz = gz[768];
                    gout12x += ai2 * gx[64] * Iy * Iz;
                    gout12y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout12z += ai2 * gz[832] * Ix * Iy;
                    break;
                    }
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+2)];
                fy += gout9y * dm[(l0+0)*nao+(k0+2)];
                fz += gout9z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+1)];
                fy = gout6y * dm[(l0+0)*nao+(k0+1)];
                fz = gout6z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                fx += gout12x * dm[(l0+0)*nao+(k0+2)];
                fy += gout12y * dm[(l0+0)*nao+(k0+2)];
                fz += gout12z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+1)];
                fy = gout5y * dm[(l0+0)*nao+(k0+1)];
                fz = gout5z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+2)];
                fy += gout11y * dm[(l0+0)*nao+(k0+2)];
                fz += gout11z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+1)];
                fy = gout8y * dm[(l0+0)*nao+(k0+1)];
                fz = gout8z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+2)];
                fy += gout10y * dm[(l0+0)*nao+(k0+2)];
                fz += gout10z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+0), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+1)];
                fy = gout7y * dm[(l0+0)*nao+(k0+1)];
                fz = gout7z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+1), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                fx += gout13x * dm[(l0+0)*nao+(k0+2)];
                fy += gout13y * dm[(l0+0)*nao+(k0+2)];
                fz += gout13z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+4)];
                fy += gout1y * dm[(j0+0)*nao+(i0+4)];
                fz += gout1z * dm[(j0+0)*nao+(i0+4)];
                fx += gout2x * dm[(j0+1)*nao+(i0+2)];
                fy += gout2y * dm[(j0+1)*nao+(i0+2)];
                fz += gout2z * dm[(j0+1)*nao+(i0+2)];
                fx += gout3x * dm[(j0+2)*nao+(i0+0)];
                fy += gout3y * dm[(j0+2)*nao+(i0+0)];
                fz += gout3z * dm[(j0+2)*nao+(i0+0)];
                fx += gout4x * dm[(j0+2)*nao+(i0+4)];
                fy += gout4y * dm[(j0+2)*nao+(i0+4)];
                fz += gout4z * dm[(j0+2)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+2)];
                fy = gout5y * dm[(j0+0)*nao+(i0+2)];
                fz = gout5z * dm[(j0+0)*nao+(i0+2)];
                fx += gout6x * dm[(j0+1)*nao+(i0+0)];
                fy += gout6y * dm[(j0+1)*nao+(i0+0)];
                fz += gout6z * dm[(j0+1)*nao+(i0+0)];
                fx += gout7x * dm[(j0+1)*nao+(i0+4)];
                fy += gout7y * dm[(j0+1)*nao+(i0+4)];
                fz += gout7z * dm[(j0+1)*nao+(i0+4)];
                fx += gout8x * dm[(j0+2)*nao+(i0+2)];
                fy += gout8y * dm[(j0+2)*nao+(i0+2)];
                fz += gout8z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+0)];
                fy = gout9y * dm[(j0+0)*nao+(i0+0)];
                fz = gout9z * dm[(j0+0)*nao+(i0+0)];
                fx += gout10x * dm[(j0+0)*nao+(i0+4)];
                fy += gout10y * dm[(j0+0)*nao+(i0+4)];
                fz += gout10z * dm[(j0+0)*nao+(i0+4)];
                fx += gout11x * dm[(j0+1)*nao+(i0+2)];
                fy += gout11y * dm[(j0+1)*nao+(i0+2)];
                fz += gout11z * dm[(j0+1)*nao+(i0+2)];
                fx += gout12x * dm[(j0+2)*nao+(i0+0)];
                fy += gout12y * dm[(j0+2)*nao+(i0+0)];
                fz += gout12z * dm[(j0+2)*nao+(i0+0)];
                fx += gout13x * dm[(j0+2)*nao+(i0+4)];
                fy += gout13y * dm[(j0+2)*nao+(i0+4)];
                fz += gout13z * dm[(j0+2)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                break;
                case 1:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+2)];
                fy += gout9y * dm[(l0+0)*nao+(k0+2)];
                fz += gout9z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+1)];
                fy = gout6y * dm[(l0+0)*nao+(k0+1)];
                fz = gout6z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                fx += gout12x * dm[(l0+0)*nao+(k0+2)];
                fy += gout12y * dm[(l0+0)*nao+(k0+2)];
                fz += gout12z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+1)];
                fy = gout5y * dm[(l0+0)*nao+(k0+1)];
                fz = gout5z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+2)];
                fy += gout11y * dm[(l0+0)*nao+(k0+2)];
                fz += gout11z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+1)];
                fy = gout8y * dm[(l0+0)*nao+(k0+1)];
                fz = gout8z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+2), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+2)];
                fy += gout10y * dm[(l0+0)*nao+(k0+2)];
                fz += gout10z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+0), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+1)];
                fy = gout7y * dm[(l0+0)*nao+(k0+1)];
                fz = gout7z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+1), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                fx += gout13x * dm[(l0+0)*nao+(k0+2)];
                fy += gout13y * dm[(l0+0)*nao+(k0+2)];
                fz += gout13z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+1)];
                fy = gout0y * dm[(j0+0)*nao+(i0+1)];
                fz = gout0z * dm[(j0+0)*nao+(i0+1)];
                fx += gout1x * dm[(j0+0)*nao+(i0+5)];
                fy += gout1y * dm[(j0+0)*nao+(i0+5)];
                fz += gout1z * dm[(j0+0)*nao+(i0+5)];
                fx += gout2x * dm[(j0+1)*nao+(i0+3)];
                fy += gout2y * dm[(j0+1)*nao+(i0+3)];
                fz += gout2z * dm[(j0+1)*nao+(i0+3)];
                fx += gout3x * dm[(j0+2)*nao+(i0+1)];
                fy += gout3y * dm[(j0+2)*nao+(i0+1)];
                fz += gout3z * dm[(j0+2)*nao+(i0+1)];
                fx += gout4x * dm[(j0+2)*nao+(i0+5)];
                fy += gout4y * dm[(j0+2)*nao+(i0+5)];
                fz += gout4z * dm[(j0+2)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(i0+3)];
                fy = gout5y * dm[(j0+0)*nao+(i0+3)];
                fz = gout5z * dm[(j0+0)*nao+(i0+3)];
                fx += gout6x * dm[(j0+1)*nao+(i0+1)];
                fy += gout6y * dm[(j0+1)*nao+(i0+1)];
                fz += gout6z * dm[(j0+1)*nao+(i0+1)];
                fx += gout7x * dm[(j0+1)*nao+(i0+5)];
                fy += gout7y * dm[(j0+1)*nao+(i0+5)];
                fz += gout7z * dm[(j0+1)*nao+(i0+5)];
                fx += gout8x * dm[(j0+2)*nao+(i0+3)];
                fy += gout8y * dm[(j0+2)*nao+(i0+3)];
                fz += gout8z * dm[(j0+2)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+1)];
                fy = gout9y * dm[(j0+0)*nao+(i0+1)];
                fz = gout9z * dm[(j0+0)*nao+(i0+1)];
                fx += gout10x * dm[(j0+0)*nao+(i0+5)];
                fy += gout10y * dm[(j0+0)*nao+(i0+5)];
                fz += gout10z * dm[(j0+0)*nao+(i0+5)];
                fx += gout11x * dm[(j0+1)*nao+(i0+3)];
                fy += gout11y * dm[(j0+1)*nao+(i0+3)];
                fz += gout11z * dm[(j0+1)*nao+(i0+3)];
                fx += gout12x * dm[(j0+2)*nao+(i0+1)];
                fy += gout12y * dm[(j0+2)*nao+(i0+1)];
                fz += gout12z * dm[(j0+2)*nao+(i0+1)];
                fx += gout13x * dm[(j0+2)*nao+(i0+5)];
                fy += gout13y * dm[(j0+2)*nao+(i0+5)];
                fz += gout13z * dm[(j0+2)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                break;
                case 2:
                fx = gout4x * dm[(l0+0)*nao+(k0+1)];
                fy = gout4y * dm[(l0+0)*nao+(k0+1)];
                fz = gout4z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+2)];
                fy += gout10y * dm[(l0+0)*nao+(k0+2)];
                fz += gout10z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+1)];
                fy = gout7y * dm[(l0+0)*nao+(k0+1)];
                fz = gout7z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+2)];
                fy += gout9y * dm[(l0+0)*nao+(k0+2)];
                fz += gout9z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+1)];
                fy = gout6y * dm[(l0+0)*nao+(k0+1)];
                fz = gout6z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                fx += gout12x * dm[(l0+0)*nao+(k0+2)];
                fy += gout12y * dm[(l0+0)*nao+(k0+2)];
                fz += gout12z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+1)];
                fy = gout5y * dm[(l0+0)*nao+(k0+1)];
                fz = gout5z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+2)];
                fy += gout11y * dm[(l0+0)*nao+(k0+2)];
                fz += gout11z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+1)];
                fy = gout8y * dm[(l0+0)*nao+(k0+1)];
                fz = gout8z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+2)];
                fy = gout0y * dm[(j0+0)*nao+(i0+2)];
                fz = gout0z * dm[(j0+0)*nao+(i0+2)];
                fx += gout1x * dm[(j0+1)*nao+(i0+0)];
                fy += gout1y * dm[(j0+1)*nao+(i0+0)];
                fz += gout1z * dm[(j0+1)*nao+(i0+0)];
                fx += gout2x * dm[(j0+1)*nao+(i0+4)];
                fy += gout2y * dm[(j0+1)*nao+(i0+4)];
                fz += gout2z * dm[(j0+1)*nao+(i0+4)];
                fx += gout3x * dm[(j0+2)*nao+(i0+2)];
                fy += gout3y * dm[(j0+2)*nao+(i0+2)];
                fz += gout3z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+0)];
                fy = gout4y * dm[(j0+0)*nao+(i0+0)];
                fz = gout4z * dm[(j0+0)*nao+(i0+0)];
                fx += gout5x * dm[(j0+0)*nao+(i0+4)];
                fy += gout5y * dm[(j0+0)*nao+(i0+4)];
                fz += gout5z * dm[(j0+0)*nao+(i0+4)];
                fx += gout6x * dm[(j0+1)*nao+(i0+2)];
                fy += gout6y * dm[(j0+1)*nao+(i0+2)];
                fz += gout6z * dm[(j0+1)*nao+(i0+2)];
                fx += gout7x * dm[(j0+2)*nao+(i0+0)];
                fy += gout7y * dm[(j0+2)*nao+(i0+0)];
                fz += gout7z * dm[(j0+2)*nao+(i0+0)];
                fx += gout8x * dm[(j0+2)*nao+(i0+4)];
                fy += gout8y * dm[(j0+2)*nao+(i0+4)];
                fz += gout8z * dm[(j0+2)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+2)];
                fy = gout9y * dm[(j0+0)*nao+(i0+2)];
                fz = gout9z * dm[(j0+0)*nao+(i0+2)];
                fx += gout10x * dm[(j0+1)*nao+(i0+0)];
                fy += gout10y * dm[(j0+1)*nao+(i0+0)];
                fz += gout10z * dm[(j0+1)*nao+(i0+0)];
                fx += gout11x * dm[(j0+1)*nao+(i0+4)];
                fy += gout11y * dm[(j0+1)*nao+(i0+4)];
                fz += gout11z * dm[(j0+1)*nao+(i0+4)];
                fx += gout12x * dm[(j0+2)*nao+(i0+2)];
                fy += gout12y * dm[(j0+2)*nao+(i0+2)];
                fz += gout12z * dm[(j0+2)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                break;
                case 3:
                fx = gout4x * dm[(l0+0)*nao+(k0+1)];
                fy = gout4y * dm[(l0+0)*nao+(k0+1)];
                fz = gout4z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                fx += gout10x * dm[(l0+0)*nao+(k0+2)];
                fy += gout10y * dm[(l0+0)*nao+(k0+2)];
                fz += gout10z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+1)];
                fy = gout7y * dm[(l0+0)*nao+(k0+1)];
                fz = gout7z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                fx += gout9x * dm[(l0+0)*nao+(k0+2)];
                fy += gout9y * dm[(l0+0)*nao+(k0+2)];
                fz += gout9z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+0), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+1)];
                fy = gout6y * dm[(l0+0)*nao+(k0+1)];
                fz = gout6z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+1), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                fx += gout12x * dm[(l0+0)*nao+(k0+2)];
                fy += gout12y * dm[(l0+0)*nao+(k0+2)];
                fz += gout12z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+2), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+1)];
                fy = gout5y * dm[(l0+0)*nao+(k0+1)];
                fz = gout5z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+0), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                fx += gout11x * dm[(l0+0)*nao+(k0+2)];
                fy += gout11y * dm[(l0+0)*nao+(k0+2)];
                fz += gout11z * dm[(l0+0)*nao+(k0+2)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+1), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+1)];
                fy = gout8y * dm[(l0+0)*nao+(k0+1)];
                fz = gout8z * dm[(l0+0)*nao+(k0+1)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+3)];
                fy = gout0y * dm[(j0+0)*nao+(i0+3)];
                fz = gout0z * dm[(j0+0)*nao+(i0+3)];
                fx += gout1x * dm[(j0+1)*nao+(i0+1)];
                fy += gout1y * dm[(j0+1)*nao+(i0+1)];
                fz += gout1z * dm[(j0+1)*nao+(i0+1)];
                fx += gout2x * dm[(j0+1)*nao+(i0+5)];
                fy += gout2y * dm[(j0+1)*nao+(i0+5)];
                fz += gout2z * dm[(j0+1)*nao+(i0+5)];
                fx += gout3x * dm[(j0+2)*nao+(i0+3)];
                fy += gout3y * dm[(j0+2)*nao+(i0+3)];
                fz += gout3z * dm[(j0+2)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(i0+1)];
                fy = gout4y * dm[(j0+0)*nao+(i0+1)];
                fz = gout4z * dm[(j0+0)*nao+(i0+1)];
                fx += gout5x * dm[(j0+0)*nao+(i0+5)];
                fy += gout5y * dm[(j0+0)*nao+(i0+5)];
                fz += gout5z * dm[(j0+0)*nao+(i0+5)];
                fx += gout6x * dm[(j0+1)*nao+(i0+3)];
                fy += gout6y * dm[(j0+1)*nao+(i0+3)];
                fz += gout6z * dm[(j0+1)*nao+(i0+3)];
                fx += gout7x * dm[(j0+2)*nao+(i0+1)];
                fy += gout7y * dm[(j0+2)*nao+(i0+1)];
                fz += gout7z * dm[(j0+2)*nao+(i0+1)];
                fx += gout8x * dm[(j0+2)*nao+(i0+5)];
                fy += gout8y * dm[(j0+2)*nao+(i0+5)];
                fz += gout8z * dm[(j0+2)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+1)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+1)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+1)*nao+(l0+0), fz);
                fx = gout9x * dm[(j0+0)*nao+(i0+3)];
                fy = gout9y * dm[(j0+0)*nao+(i0+3)];
                fz = gout9z * dm[(j0+0)*nao+(i0+3)];
                fx += gout10x * dm[(j0+1)*nao+(i0+1)];
                fy += gout10y * dm[(j0+1)*nao+(i0+1)];
                fz += gout10z * dm[(j0+1)*nao+(i0+1)];
                fx += gout11x * dm[(j0+1)*nao+(i0+5)];
                fy += gout11y * dm[(j0+1)*nao+(i0+5)];
                fz += gout11z * dm[(j0+1)*nao+(i0+5)];
                fx += gout12x * dm[(j0+2)*nao+(i0+3)];
                fy += gout12y * dm[(j0+2)*nao+(i0+3)];
                fz += gout12z * dm[(j0+2)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+2)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+2)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+2)*nao+(l0+0), fz);
                break;
                }
            }
            if (do_k) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+2)];
                fy += gout9y * dm[(j0+0)*nao+(k0+2)];
                fz += gout9z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+1)*nao+(k0+1)];
                fy += gout6y * dm[(j0+1)*nao+(k0+1)];
                fz += gout6z * dm[(j0+1)*nao+(k0+1)];
                fx += gout3x * dm[(j0+2)*nao+(k0+0)];
                fy += gout3y * dm[(j0+2)*nao+(k0+0)];
                fz += gout3z * dm[(j0+2)*nao+(k0+0)];
                fx += gout12x * dm[(j0+2)*nao+(k0+2)];
                fy += gout12y * dm[(j0+2)*nao+(k0+2)];
                fz += gout12z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+1)];
                fy = gout5y * dm[(j0+0)*nao+(k0+1)];
                fz = gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout2x * dm[(j0+1)*nao+(k0+0)];
                fy += gout2y * dm[(j0+1)*nao+(k0+0)];
                fz += gout2z * dm[(j0+1)*nao+(k0+0)];
                fx += gout11x * dm[(j0+1)*nao+(k0+2)];
                fy += gout11y * dm[(j0+1)*nao+(k0+2)];
                fz += gout11z * dm[(j0+1)*nao+(k0+2)];
                fx += gout8x * dm[(j0+2)*nao+(k0+1)];
                fy += gout8y * dm[(j0+2)*nao+(k0+1)];
                fz += gout8z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout10x * dm[(j0+0)*nao+(k0+2)];
                fy += gout10y * dm[(j0+0)*nao+(k0+2)];
                fz += gout10z * dm[(j0+0)*nao+(k0+2)];
                fx += gout7x * dm[(j0+1)*nao+(k0+1)];
                fy += gout7y * dm[(j0+1)*nao+(k0+1)];
                fz += gout7z * dm[(j0+1)*nao+(k0+1)];
                fx += gout4x * dm[(j0+2)*nao+(k0+0)];
                fy += gout4y * dm[(j0+2)*nao+(k0+0)];
                fz += gout4z * dm[(j0+2)*nao+(k0+0)];
                fx += gout13x * dm[(j0+2)*nao+(k0+2)];
                fy += gout13y * dm[(j0+2)*nao+(k0+2)];
                fz += gout13z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout9x * dm[(i0+0)*nao+(k0+2)];
                fy += gout9y * dm[(i0+0)*nao+(k0+2)];
                fz += gout9z * dm[(i0+0)*nao+(k0+2)];
                fx += gout5x * dm[(i0+2)*nao+(k0+1)];
                fy += gout5y * dm[(i0+2)*nao+(k0+1)];
                fz += gout5z * dm[(i0+2)*nao+(k0+1)];
                fx += gout1x * dm[(i0+4)*nao+(k0+0)];
                fy += gout1y * dm[(i0+4)*nao+(k0+0)];
                fz += gout1z * dm[(i0+4)*nao+(k0+0)];
                fx += gout10x * dm[(i0+4)*nao+(k0+2)];
                fy += gout10y * dm[(i0+4)*nao+(k0+2)];
                fz += gout10z * dm[(i0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+1)];
                fy = gout6y * dm[(i0+0)*nao+(k0+1)];
                fz = gout6z * dm[(i0+0)*nao+(k0+1)];
                fx += gout2x * dm[(i0+2)*nao+(k0+0)];
                fy += gout2y * dm[(i0+2)*nao+(k0+0)];
                fz += gout2z * dm[(i0+2)*nao+(k0+0)];
                fx += gout11x * dm[(i0+2)*nao+(k0+2)];
                fy += gout11y * dm[(i0+2)*nao+(k0+2)];
                fz += gout11z * dm[(i0+2)*nao+(k0+2)];
                fx += gout7x * dm[(i0+4)*nao+(k0+1)];
                fy += gout7y * dm[(i0+4)*nao+(k0+1)];
                fz += gout7z * dm[(i0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+0)];
                fy = gout3y * dm[(i0+0)*nao+(k0+0)];
                fz = gout3z * dm[(i0+0)*nao+(k0+0)];
                fx += gout12x * dm[(i0+0)*nao+(k0+2)];
                fy += gout12y * dm[(i0+0)*nao+(k0+2)];
                fz += gout12z * dm[(i0+0)*nao+(k0+2)];
                fx += gout8x * dm[(i0+2)*nao+(k0+1)];
                fy += gout8y * dm[(i0+2)*nao+(k0+1)];
                fz += gout8z * dm[(i0+2)*nao+(k0+1)];
                fx += gout4x * dm[(i0+4)*nao+(k0+0)];
                fy += gout4y * dm[(i0+4)*nao+(k0+0)];
                fz += gout4z * dm[(i0+4)*nao+(k0+0)];
                fx += gout13x * dm[(i0+4)*nao+(k0+2)];
                fy += gout13y * dm[(i0+4)*nao+(k0+2)];
                fz += gout13z * dm[(i0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+2)*nao+(l0+0)];
                fy += gout3y * dm[(j0+2)*nao+(l0+0)];
                fz += gout3z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+1)*nao+(l0+0)];
                fy = gout6y * dm[(j0+1)*nao+(l0+0)];
                fz = gout6z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+2)*nao+(l0+0)];
                fy += gout12y * dm[(j0+2)*nao+(l0+0)];
                fz += gout12z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+1)*nao+(l0+0)];
                fy = gout2y * dm[(j0+1)*nao+(l0+0)];
                fz = gout2z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                fx += gout8x * dm[(j0+2)*nao+(l0+0)];
                fy += gout8y * dm[(j0+2)*nao+(l0+0)];
                fz += gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout11x * dm[(j0+1)*nao+(l0+0)];
                fy = gout11y * dm[(j0+1)*nao+(l0+0)];
                fz = gout11z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout4x * dm[(j0+2)*nao+(l0+0)];
                fy += gout4y * dm[(j0+2)*nao+(l0+0)];
                fz += gout4z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+0), fz);
                fx = gout7x * dm[(j0+1)*nao+(l0+0)];
                fy = gout7y * dm[(j0+1)*nao+(l0+0)];
                fz = gout7z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(l0+0)];
                fy = gout10y * dm[(j0+0)*nao+(l0+0)];
                fz = gout10z * dm[(j0+0)*nao+(l0+0)];
                fx += gout13x * dm[(j0+2)*nao+(l0+0)];
                fy += gout13y * dm[(j0+2)*nao+(l0+0)];
                fz += gout13z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+4)*nao+(l0+0)];
                fy += gout1y * dm[(i0+4)*nao+(l0+0)];
                fz += gout1z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+2)*nao+(l0+0)];
                fy = gout5y * dm[(i0+2)*nao+(l0+0)];
                fz = gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout9x * dm[(i0+0)*nao+(l0+0)];
                fy = gout9y * dm[(i0+0)*nao+(l0+0)];
                fz = gout9z * dm[(i0+0)*nao+(l0+0)];
                fx += gout10x * dm[(i0+4)*nao+(l0+0)];
                fy += gout10y * dm[(i0+4)*nao+(l0+0)];
                fz += gout10z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout2x * dm[(i0+2)*nao+(l0+0)];
                fy = gout2y * dm[(i0+2)*nao+(l0+0)];
                fz = gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+4)*nao+(l0+0)];
                fy += gout7y * dm[(i0+4)*nao+(l0+0)];
                fz += gout7z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout11x * dm[(i0+2)*nao+(l0+0)];
                fy = gout11y * dm[(i0+2)*nao+(l0+0)];
                fz = gout11z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout4x * dm[(i0+4)*nao+(l0+0)];
                fy += gout4y * dm[(i0+4)*nao+(l0+0)];
                fz += gout4z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout8x * dm[(i0+2)*nao+(l0+0)];
                fy = gout8y * dm[(i0+2)*nao+(l0+0)];
                fz = gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout12x * dm[(i0+0)*nao+(l0+0)];
                fy = gout12y * dm[(i0+0)*nao+(l0+0)];
                fz = gout12z * dm[(i0+0)*nao+(l0+0)];
                fx += gout13x * dm[(i0+4)*nao+(l0+0)];
                fy += gout13y * dm[(i0+4)*nao+(l0+0)];
                fz += gout13z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                break;
                case 1:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+2)];
                fy += gout9y * dm[(j0+0)*nao+(k0+2)];
                fz += gout9z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+1)*nao+(k0+1)];
                fy += gout6y * dm[(j0+1)*nao+(k0+1)];
                fz += gout6z * dm[(j0+1)*nao+(k0+1)];
                fx += gout3x * dm[(j0+2)*nao+(k0+0)];
                fy += gout3y * dm[(j0+2)*nao+(k0+0)];
                fz += gout3z * dm[(j0+2)*nao+(k0+0)];
                fx += gout12x * dm[(j0+2)*nao+(k0+2)];
                fy += gout12y * dm[(j0+2)*nao+(k0+2)];
                fz += gout12z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+1)];
                fy = gout5y * dm[(j0+0)*nao+(k0+1)];
                fz = gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout2x * dm[(j0+1)*nao+(k0+0)];
                fy += gout2y * dm[(j0+1)*nao+(k0+0)];
                fz += gout2z * dm[(j0+1)*nao+(k0+0)];
                fx += gout11x * dm[(j0+1)*nao+(k0+2)];
                fy += gout11y * dm[(j0+1)*nao+(k0+2)];
                fz += gout11z * dm[(j0+1)*nao+(k0+2)];
                fx += gout8x * dm[(j0+2)*nao+(k0+1)];
                fy += gout8y * dm[(j0+2)*nao+(k0+1)];
                fz += gout8z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout10x * dm[(j0+0)*nao+(k0+2)];
                fy += gout10y * dm[(j0+0)*nao+(k0+2)];
                fz += gout10z * dm[(j0+0)*nao+(k0+2)];
                fx += gout7x * dm[(j0+1)*nao+(k0+1)];
                fy += gout7y * dm[(j0+1)*nao+(k0+1)];
                fz += gout7z * dm[(j0+1)*nao+(k0+1)];
                fx += gout4x * dm[(j0+2)*nao+(k0+0)];
                fy += gout4y * dm[(j0+2)*nao+(k0+0)];
                fz += gout4z * dm[(j0+2)*nao+(k0+0)];
                fx += gout13x * dm[(j0+2)*nao+(k0+2)];
                fy += gout13y * dm[(j0+2)*nao+(k0+2)];
                fz += gout13z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+1)*nao+(k0+0)];
                fy = gout0y * dm[(i0+1)*nao+(k0+0)];
                fz = gout0z * dm[(i0+1)*nao+(k0+0)];
                fx += gout9x * dm[(i0+1)*nao+(k0+2)];
                fy += gout9y * dm[(i0+1)*nao+(k0+2)];
                fz += gout9z * dm[(i0+1)*nao+(k0+2)];
                fx += gout5x * dm[(i0+3)*nao+(k0+1)];
                fy += gout5y * dm[(i0+3)*nao+(k0+1)];
                fz += gout5z * dm[(i0+3)*nao+(k0+1)];
                fx += gout1x * dm[(i0+5)*nao+(k0+0)];
                fy += gout1y * dm[(i0+5)*nao+(k0+0)];
                fz += gout1z * dm[(i0+5)*nao+(k0+0)];
                fx += gout10x * dm[(i0+5)*nao+(k0+2)];
                fy += gout10y * dm[(i0+5)*nao+(k0+2)];
                fz += gout10z * dm[(i0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+1)*nao+(k0+1)];
                fy = gout6y * dm[(i0+1)*nao+(k0+1)];
                fz = gout6z * dm[(i0+1)*nao+(k0+1)];
                fx += gout2x * dm[(i0+3)*nao+(k0+0)];
                fy += gout2y * dm[(i0+3)*nao+(k0+0)];
                fz += gout2z * dm[(i0+3)*nao+(k0+0)];
                fx += gout11x * dm[(i0+3)*nao+(k0+2)];
                fy += gout11y * dm[(i0+3)*nao+(k0+2)];
                fz += gout11z * dm[(i0+3)*nao+(k0+2)];
                fx += gout7x * dm[(i0+5)*nao+(k0+1)];
                fy += gout7y * dm[(i0+5)*nao+(k0+1)];
                fz += gout7z * dm[(i0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+1)*nao+(k0+0)];
                fy = gout3y * dm[(i0+1)*nao+(k0+0)];
                fz = gout3z * dm[(i0+1)*nao+(k0+0)];
                fx += gout12x * dm[(i0+1)*nao+(k0+2)];
                fy += gout12y * dm[(i0+1)*nao+(k0+2)];
                fz += gout12z * dm[(i0+1)*nao+(k0+2)];
                fx += gout8x * dm[(i0+3)*nao+(k0+1)];
                fy += gout8y * dm[(i0+3)*nao+(k0+1)];
                fz += gout8z * dm[(i0+3)*nao+(k0+1)];
                fx += gout4x * dm[(i0+5)*nao+(k0+0)];
                fy += gout4y * dm[(i0+5)*nao+(k0+0)];
                fz += gout4z * dm[(i0+5)*nao+(k0+0)];
                fx += gout13x * dm[(i0+5)*nao+(k0+2)];
                fy += gout13y * dm[(i0+5)*nao+(k0+2)];
                fz += gout13z * dm[(i0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+2)*nao+(l0+0)];
                fy += gout3y * dm[(j0+2)*nao+(l0+0)];
                fz += gout3z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+1)*nao+(l0+0)];
                fy = gout6y * dm[(j0+1)*nao+(l0+0)];
                fz = gout6z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+2)*nao+(l0+0)];
                fy += gout12y * dm[(j0+2)*nao+(l0+0)];
                fz += gout12z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+1)*nao+(l0+0)];
                fy = gout2y * dm[(j0+1)*nao+(l0+0)];
                fz = gout2z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                fx += gout8x * dm[(j0+2)*nao+(l0+0)];
                fy += gout8y * dm[(j0+2)*nao+(l0+0)];
                fz += gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+1), fz);
                fx = gout11x * dm[(j0+1)*nao+(l0+0)];
                fy = gout11y * dm[(j0+1)*nao+(l0+0)];
                fz = gout11z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+2), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout4x * dm[(j0+2)*nao+(l0+0)];
                fy += gout4y * dm[(j0+2)*nao+(l0+0)];
                fz += gout4z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+0), fz);
                fx = gout7x * dm[(j0+1)*nao+(l0+0)];
                fy = gout7y * dm[(j0+1)*nao+(l0+0)];
                fz = gout7z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+1), fz);
                fx = gout10x * dm[(j0+0)*nao+(l0+0)];
                fy = gout10y * dm[(j0+0)*nao+(l0+0)];
                fz = gout10z * dm[(j0+0)*nao+(l0+0)];
                fx += gout13x * dm[(j0+2)*nao+(l0+0)];
                fy += gout13y * dm[(j0+2)*nao+(l0+0)];
                fz += gout13z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+1)*nao+(l0+0)];
                fy = gout0y * dm[(i0+1)*nao+(l0+0)];
                fz = gout0z * dm[(i0+1)*nao+(l0+0)];
                fx += gout1x * dm[(i0+5)*nao+(l0+0)];
                fy += gout1y * dm[(i0+5)*nao+(l0+0)];
                fz += gout1z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+3)*nao+(l0+0)];
                fy = gout5y * dm[(i0+3)*nao+(l0+0)];
                fz = gout5z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout9x * dm[(i0+1)*nao+(l0+0)];
                fy = gout9y * dm[(i0+1)*nao+(l0+0)];
                fz = gout9z * dm[(i0+1)*nao+(l0+0)];
                fx += gout10x * dm[(i0+5)*nao+(l0+0)];
                fy += gout10y * dm[(i0+5)*nao+(l0+0)];
                fz += gout10z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout2x * dm[(i0+3)*nao+(l0+0)];
                fy = gout2y * dm[(i0+3)*nao+(l0+0)];
                fz = gout2z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+1)*nao+(l0+0)];
                fy = gout6y * dm[(i0+1)*nao+(l0+0)];
                fz = gout6z * dm[(i0+1)*nao+(l0+0)];
                fx += gout7x * dm[(i0+5)*nao+(l0+0)];
                fy += gout7y * dm[(i0+5)*nao+(l0+0)];
                fz += gout7z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout11x * dm[(i0+3)*nao+(l0+0)];
                fy = gout11y * dm[(i0+3)*nao+(l0+0)];
                fz = gout11z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+1)*nao+(l0+0)];
                fy = gout3y * dm[(i0+1)*nao+(l0+0)];
                fz = gout3z * dm[(i0+1)*nao+(l0+0)];
                fx += gout4x * dm[(i0+5)*nao+(l0+0)];
                fy += gout4y * dm[(i0+5)*nao+(l0+0)];
                fz += gout4z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout8x * dm[(i0+3)*nao+(l0+0)];
                fy = gout8y * dm[(i0+3)*nao+(l0+0)];
                fz = gout8z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout12x * dm[(i0+1)*nao+(l0+0)];
                fy = gout12y * dm[(i0+1)*nao+(l0+0)];
                fz = gout12z * dm[(i0+1)*nao+(l0+0)];
                fx += gout13x * dm[(i0+5)*nao+(l0+0)];
                fy += gout13y * dm[(i0+5)*nao+(l0+0)];
                fz += gout13z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                break;
                case 2:
                fx = gout4x * dm[(j0+0)*nao+(k0+1)];
                fy = gout4y * dm[(j0+0)*nao+(k0+1)];
                fz = gout4z * dm[(j0+0)*nao+(k0+1)];
                fx += gout1x * dm[(j0+1)*nao+(k0+0)];
                fy += gout1y * dm[(j0+1)*nao+(k0+0)];
                fz += gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout10x * dm[(j0+1)*nao+(k0+2)];
                fy += gout10y * dm[(j0+1)*nao+(k0+2)];
                fz += gout10z * dm[(j0+1)*nao+(k0+2)];
                fx += gout7x * dm[(j0+2)*nao+(k0+1)];
                fy += gout7y * dm[(j0+2)*nao+(k0+1)];
                fz += gout7z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+2)];
                fy += gout9y * dm[(j0+0)*nao+(k0+2)];
                fz += gout9z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+1)*nao+(k0+1)];
                fy += gout6y * dm[(j0+1)*nao+(k0+1)];
                fz += gout6z * dm[(j0+1)*nao+(k0+1)];
                fx += gout3x * dm[(j0+2)*nao+(k0+0)];
                fy += gout3y * dm[(j0+2)*nao+(k0+0)];
                fz += gout3z * dm[(j0+2)*nao+(k0+0)];
                fx += gout12x * dm[(j0+2)*nao+(k0+2)];
                fy += gout12y * dm[(j0+2)*nao+(k0+2)];
                fz += gout12z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+1)];
                fy = gout5y * dm[(j0+0)*nao+(k0+1)];
                fz = gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout2x * dm[(j0+1)*nao+(k0+0)];
                fy += gout2y * dm[(j0+1)*nao+(k0+0)];
                fz += gout2z * dm[(j0+1)*nao+(k0+0)];
                fx += gout11x * dm[(j0+1)*nao+(k0+2)];
                fy += gout11y * dm[(j0+1)*nao+(k0+2)];
                fz += gout11z * dm[(j0+1)*nao+(k0+2)];
                fx += gout8x * dm[(j0+2)*nao+(k0+1)];
                fy += gout8y * dm[(j0+2)*nao+(k0+1)];
                fz += gout8z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+1)];
                fy = gout4y * dm[(i0+0)*nao+(k0+1)];
                fz = gout4z * dm[(i0+0)*nao+(k0+1)];
                fx += gout0x * dm[(i0+2)*nao+(k0+0)];
                fy += gout0y * dm[(i0+2)*nao+(k0+0)];
                fz += gout0z * dm[(i0+2)*nao+(k0+0)];
                fx += gout9x * dm[(i0+2)*nao+(k0+2)];
                fy += gout9y * dm[(i0+2)*nao+(k0+2)];
                fz += gout9z * dm[(i0+2)*nao+(k0+2)];
                fx += gout5x * dm[(i0+4)*nao+(k0+1)];
                fy += gout5y * dm[(i0+4)*nao+(k0+1)];
                fz += gout5z * dm[(i0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout10x * dm[(i0+0)*nao+(k0+2)];
                fy += gout10y * dm[(i0+0)*nao+(k0+2)];
                fz += gout10z * dm[(i0+0)*nao+(k0+2)];
                fx += gout6x * dm[(i0+2)*nao+(k0+1)];
                fy += gout6y * dm[(i0+2)*nao+(k0+1)];
                fz += gout6z * dm[(i0+2)*nao+(k0+1)];
                fx += gout2x * dm[(i0+4)*nao+(k0+0)];
                fy += gout2y * dm[(i0+4)*nao+(k0+0)];
                fz += gout2z * dm[(i0+4)*nao+(k0+0)];
                fx += gout11x * dm[(i0+4)*nao+(k0+2)];
                fy += gout11y * dm[(i0+4)*nao+(k0+2)];
                fz += gout11z * dm[(i0+4)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(k0+1)];
                fy = gout7y * dm[(i0+0)*nao+(k0+1)];
                fz = gout7z * dm[(i0+0)*nao+(k0+1)];
                fx += gout3x * dm[(i0+2)*nao+(k0+0)];
                fy += gout3y * dm[(i0+2)*nao+(k0+0)];
                fz += gout3z * dm[(i0+2)*nao+(k0+0)];
                fx += gout12x * dm[(i0+2)*nao+(k0+2)];
                fy += gout12y * dm[(i0+2)*nao+(k0+2)];
                fz += gout12z * dm[(i0+2)*nao+(k0+2)];
                fx += gout8x * dm[(i0+4)*nao+(k0+1)];
                fy += gout8y * dm[(i0+4)*nao+(k0+1)];
                fz += gout8z * dm[(i0+4)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout7x * dm[(j0+2)*nao+(l0+0)];
                fy += gout7y * dm[(j0+2)*nao+(l0+0)];
                fz += gout7z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+1), fz);
                fx = gout10x * dm[(j0+1)*nao+(l0+0)];
                fy = gout10y * dm[(j0+1)*nao+(l0+0)];
                fz = gout10z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+2)*nao+(l0+0)];
                fy += gout3y * dm[(j0+2)*nao+(l0+0)];
                fz += gout3z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+1)*nao+(l0+0)];
                fy = gout6y * dm[(j0+1)*nao+(l0+0)];
                fz = gout6z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+2)*nao+(l0+0)];
                fy += gout12y * dm[(j0+2)*nao+(l0+0)];
                fz += gout12z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+1)*nao+(l0+0)];
                fy = gout2y * dm[(j0+1)*nao+(l0+0)];
                fz = gout2z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                fx += gout8x * dm[(j0+2)*nao+(l0+0)];
                fy += gout8y * dm[(j0+2)*nao+(l0+0)];
                fz += gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+1), fz);
                fx = gout11x * dm[(j0+1)*nao+(l0+0)];
                fy = gout11y * dm[(j0+1)*nao+(l0+0)];
                fz = gout11z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+2)*nao+(l0+0)];
                fy = gout0y * dm[(i0+2)*nao+(l0+0)];
                fz = gout0z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                fx += gout5x * dm[(i0+4)*nao+(l0+0)];
                fy += gout5y * dm[(i0+4)*nao+(l0+0)];
                fz += gout5z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout9x * dm[(i0+2)*nao+(l0+0)];
                fy = gout9y * dm[(i0+2)*nao+(l0+0)];
                fz = gout9z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout2x * dm[(i0+4)*nao+(l0+0)];
                fy += gout2y * dm[(i0+4)*nao+(l0+0)];
                fz += gout2z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+2)*nao+(l0+0)];
                fy = gout6y * dm[(i0+2)*nao+(l0+0)];
                fz = gout6z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout10x * dm[(i0+0)*nao+(l0+0)];
                fy = gout10y * dm[(i0+0)*nao+(l0+0)];
                fz = gout10z * dm[(i0+0)*nao+(l0+0)];
                fx += gout11x * dm[(i0+4)*nao+(l0+0)];
                fy += gout11y * dm[(i0+4)*nao+(l0+0)];
                fz += gout11z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+2)*nao+(l0+0)];
                fy = gout3y * dm[(i0+2)*nao+(l0+0)];
                fz = gout3z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                fx += gout8x * dm[(i0+4)*nao+(l0+0)];
                fy += gout8y * dm[(i0+4)*nao+(l0+0)];
                fz += gout8z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout12x * dm[(i0+2)*nao+(l0+0)];
                fy = gout12y * dm[(i0+2)*nao+(l0+0)];
                fz = gout12z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                break;
                case 3:
                fx = gout4x * dm[(j0+0)*nao+(k0+1)];
                fy = gout4y * dm[(j0+0)*nao+(k0+1)];
                fz = gout4z * dm[(j0+0)*nao+(k0+1)];
                fx += gout1x * dm[(j0+1)*nao+(k0+0)];
                fy += gout1y * dm[(j0+1)*nao+(k0+0)];
                fz += gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout10x * dm[(j0+1)*nao+(k0+2)];
                fy += gout10y * dm[(j0+1)*nao+(k0+2)];
                fz += gout10z * dm[(j0+1)*nao+(k0+2)];
                fx += gout7x * dm[(j0+2)*nao+(k0+1)];
                fy += gout7y * dm[(j0+2)*nao+(k0+1)];
                fz += gout7z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout9x * dm[(j0+0)*nao+(k0+2)];
                fy += gout9y * dm[(j0+0)*nao+(k0+2)];
                fz += gout9z * dm[(j0+0)*nao+(k0+2)];
                fx += gout6x * dm[(j0+1)*nao+(k0+1)];
                fy += gout6y * dm[(j0+1)*nao+(k0+1)];
                fz += gout6z * dm[(j0+1)*nao+(k0+1)];
                fx += gout3x * dm[(j0+2)*nao+(k0+0)];
                fy += gout3y * dm[(j0+2)*nao+(k0+0)];
                fz += gout3z * dm[(j0+2)*nao+(k0+0)];
                fx += gout12x * dm[(j0+2)*nao+(k0+2)];
                fy += gout12y * dm[(j0+2)*nao+(k0+2)];
                fz += gout12z * dm[(j0+2)*nao+(k0+2)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(k0+1)];
                fy = gout5y * dm[(j0+0)*nao+(k0+1)];
                fz = gout5z * dm[(j0+0)*nao+(k0+1)];
                fx += gout2x * dm[(j0+1)*nao+(k0+0)];
                fy += gout2y * dm[(j0+1)*nao+(k0+0)];
                fz += gout2z * dm[(j0+1)*nao+(k0+0)];
                fx += gout11x * dm[(j0+1)*nao+(k0+2)];
                fy += gout11y * dm[(j0+1)*nao+(k0+2)];
                fz += gout11z * dm[(j0+1)*nao+(k0+2)];
                fx += gout8x * dm[(j0+2)*nao+(k0+1)];
                fy += gout8y * dm[(j0+2)*nao+(k0+1)];
                fz += gout8z * dm[(j0+2)*nao+(k0+1)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+1)*nao+(k0+1)];
                fy = gout4y * dm[(i0+1)*nao+(k0+1)];
                fz = gout4z * dm[(i0+1)*nao+(k0+1)];
                fx += gout0x * dm[(i0+3)*nao+(k0+0)];
                fy += gout0y * dm[(i0+3)*nao+(k0+0)];
                fz += gout0z * dm[(i0+3)*nao+(k0+0)];
                fx += gout9x * dm[(i0+3)*nao+(k0+2)];
                fy += gout9y * dm[(i0+3)*nao+(k0+2)];
                fz += gout9z * dm[(i0+3)*nao+(k0+2)];
                fx += gout5x * dm[(i0+5)*nao+(k0+1)];
                fy += gout5y * dm[(i0+5)*nao+(k0+1)];
                fz += gout5z * dm[(i0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+1)*nao+(k0+0)];
                fy = gout1y * dm[(i0+1)*nao+(k0+0)];
                fz = gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout10x * dm[(i0+1)*nao+(k0+2)];
                fy += gout10y * dm[(i0+1)*nao+(k0+2)];
                fz += gout10z * dm[(i0+1)*nao+(k0+2)];
                fx += gout6x * dm[(i0+3)*nao+(k0+1)];
                fy += gout6y * dm[(i0+3)*nao+(k0+1)];
                fz += gout6z * dm[(i0+3)*nao+(k0+1)];
                fx += gout2x * dm[(i0+5)*nao+(k0+0)];
                fy += gout2y * dm[(i0+5)*nao+(k0+0)];
                fz += gout2z * dm[(i0+5)*nao+(k0+0)];
                fx += gout11x * dm[(i0+5)*nao+(k0+2)];
                fy += gout11y * dm[(i0+5)*nao+(k0+2)];
                fz += gout11z * dm[(i0+5)*nao+(k0+2)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+1)*nao+(k0+1)];
                fy = gout7y * dm[(i0+1)*nao+(k0+1)];
                fz = gout7z * dm[(i0+1)*nao+(k0+1)];
                fx += gout3x * dm[(i0+3)*nao+(k0+0)];
                fy += gout3y * dm[(i0+3)*nao+(k0+0)];
                fz += gout3z * dm[(i0+3)*nao+(k0+0)];
                fx += gout12x * dm[(i0+3)*nao+(k0+2)];
                fy += gout12y * dm[(i0+3)*nao+(k0+2)];
                fz += gout12z * dm[(i0+3)*nao+(k0+2)];
                fx += gout8x * dm[(i0+5)*nao+(k0+1)];
                fy += gout8y * dm[(i0+5)*nao+(k0+1)];
                fz += gout8z * dm[(i0+5)*nao+(k0+1)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout4x * dm[(j0+0)*nao+(l0+0)];
                fy = gout4y * dm[(j0+0)*nao+(l0+0)];
                fz = gout4z * dm[(j0+0)*nao+(l0+0)];
                fx += gout7x * dm[(j0+2)*nao+(l0+0)];
                fy += gout7y * dm[(j0+2)*nao+(l0+0)];
                fz += gout7z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+1), fz);
                fx = gout10x * dm[(j0+1)*nao+(l0+0)];
                fy = gout10y * dm[(j0+1)*nao+(l0+0)];
                fz = gout10z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+2), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+2)*nao+(l0+0)];
                fy += gout3y * dm[(j0+2)*nao+(l0+0)];
                fz += gout3z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+0), fz);
                fx = gout6x * dm[(j0+1)*nao+(l0+0)];
                fy = gout6y * dm[(j0+1)*nao+(l0+0)];
                fz = gout6z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+1), fz);
                fx = gout9x * dm[(j0+0)*nao+(l0+0)];
                fy = gout9y * dm[(j0+0)*nao+(l0+0)];
                fz = gout9z * dm[(j0+0)*nao+(l0+0)];
                fx += gout12x * dm[(j0+2)*nao+(l0+0)];
                fy += gout12y * dm[(j0+2)*nao+(l0+0)];
                fz += gout12z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+2), fz);
                fx = gout2x * dm[(j0+1)*nao+(l0+0)];
                fy = gout2y * dm[(j0+1)*nao+(l0+0)];
                fz = gout2z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+0), fz);
                fx = gout5x * dm[(j0+0)*nao+(l0+0)];
                fy = gout5y * dm[(j0+0)*nao+(l0+0)];
                fz = gout5z * dm[(j0+0)*nao+(l0+0)];
                fx += gout8x * dm[(j0+2)*nao+(l0+0)];
                fy += gout8y * dm[(j0+2)*nao+(l0+0)];
                fz += gout8z * dm[(j0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+1), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+1), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+1), fz);
                fx = gout11x * dm[(j0+1)*nao+(l0+0)];
                fy = gout11y * dm[(j0+1)*nao+(l0+0)];
                fz = gout11z * dm[(j0+1)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+2), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+2), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+2), fz);
                fx = gout0x * dm[(i0+3)*nao+(l0+0)];
                fy = gout0y * dm[(i0+3)*nao+(l0+0)];
                fz = gout0z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+0)];
                fy = gout4y * dm[(i0+1)*nao+(l0+0)];
                fz = gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout5x * dm[(i0+5)*nao+(l0+0)];
                fy += gout5y * dm[(i0+5)*nao+(l0+0)];
                fz += gout5z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+1), fz);
                fx = gout9x * dm[(i0+3)*nao+(l0+0)];
                fy = gout9y * dm[(i0+3)*nao+(l0+0)];
                fz = gout9z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+2), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+5)*nao+(l0+0)];
                fy += gout2y * dm[(i0+5)*nao+(l0+0)];
                fz += gout2z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+3)*nao+(l0+0)];
                fy = gout6y * dm[(i0+3)*nao+(l0+0)];
                fz = gout6z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+1), fz);
                fx = gout10x * dm[(i0+1)*nao+(l0+0)];
                fy = gout10y * dm[(i0+1)*nao+(l0+0)];
                fz = gout10z * dm[(i0+1)*nao+(l0+0)];
                fx += gout11x * dm[(i0+5)*nao+(l0+0)];
                fy += gout11y * dm[(i0+5)*nao+(l0+0)];
                fz += gout11z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+2), fz);
                fx = gout3x * dm[(i0+3)*nao+(l0+0)];
                fy = gout3y * dm[(i0+3)*nao+(l0+0)];
                fz = gout3z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout7x * dm[(i0+1)*nao+(l0+0)];
                fy = gout7y * dm[(i0+1)*nao+(l0+0)];
                fz = gout7z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+5)*nao+(l0+0)];
                fy += gout8y * dm[(i0+5)*nao+(l0+0)];
                fz += gout8z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+1), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+1), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+1), fz);
                fx = gout12x * dm[(i0+3)*nao+(l0+0)];
                fy = gout12y * dm[(i0+3)*nao+(l0+0)];
                fz = gout12z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+2), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+2), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+2), fz);
                break;
                }
            }
        }
    }
}
__global__
static void rys_vjk_ip1_2110(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_2110(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

__device__ static
void _rys_vjk_ip1_2200(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *shl_quartet_idx, int ntasks)
{
    // sq is short for shl_quartet
    int sq_id = threadIdx.x;
    int nsq_per_block = blockDim.x;
    int gout_id = threadIdx.y;
    int gout_stride = blockDim.y;
    int iprim = bounds.iprim;
    int jprim = bounds.jprim;
    int kprim = bounds.kprim;
    int lprim = bounds.lprim;
    int nroots = bounds.nroots;
    int *ao_loc = envs.ao_loc;
    int nbas = envs.nbas;
    int nao = ao_loc[nbas];
    int *bas = envs.bas;
    double *env = envs.env;
    double omega = env[PTR_RANGE_OMEGA];
    extern __shared__ double rjri_cache[];
    double *rw = rjri_cache + iprim*jprim*6 + sq_id;
    double *gx = rw + 128 * nroots;
    double *gy = gx + 768;
    double *gz = gy + 768;
    double *rlrk = gz + 768;
    double *Rpq = rlrk + 192;
    if (gout_id == 0) {
        gx[0] = 1.;
        gy[0] = 1.;
    }
    double s0, s1, s2;
    double Ix, Iy, Iz;

    __syncthreads();
    ShellQuartet sq = shl_quartet_idx[0];
    int ish = sq.i;
    int jsh = sq.j;
    double *expi = env + bas[ish*BAS_SLOTS+PTR_EXP];
    double *expj = env + bas[jsh*BAS_SLOTS+PTR_EXP];
    double *ci = env + bas[ish*BAS_SLOTS+PTR_COEFF];
    double *cj = env + bas[jsh*BAS_SLOTS+PTR_COEFF];
    double *ri = env + bas[ish*BAS_SLOTS+PTR_BAS_COORD];
    double *rj = env + bas[jsh*BAS_SLOTS+PTR_BAS_COORD];
    double xjxi = rj[0] - ri[0];
    double yjyi = rj[1] - ri[1];
    double zjzi = rj[2] - ri[2];
    double rr_ij = xjxi*xjxi + yjyi*yjyi + zjzi*zjzi;
    int thread_id = nsq_per_block * gout_id + sq_id;
    int threads = nsq_per_block * gout_stride;
    for (int ij = thread_id; ij < iprim*jprim; ij += threads) {
        int ip = ij / jprim;
        int jp = ij % jprim;
        double ai = expi[ip];
        double aj = expj[jp];
        double aij = ai + aj;
        double *rjri = rjri_cache + ij*6;
        rjri[0] = xjxi;
        rjri[1] = yjyi;
        rjri[2] = zjzi;
        double theta_ij = ai * aj / aij;
        double Kab = exp(-theta_ij * rr_ij);
        rjri[3] = ci[ip] * cj[jp] * Kab;
        rjri[4] = aij;
        rjri[5] = ai * 2;
    }
    double gout0x, gout0y, gout0z;
    double gout1x, gout1y, gout1z;
    double gout2x, gout2y, gout2z;
    double gout3x, gout3y, gout3z;
    double gout4x, gout4y, gout4z;
    double gout5x, gout5y, gout5z;
    double gout6x, gout6y, gout6z;
    double gout7x, gout7y, gout7z;
    double gout8x, gout8y, gout8z;
    double ai2, fx, fy, fz;

    for (int task0 = 0; task0 < ntasks; task0 += nsq_per_block) {
        __syncthreads();
        int task_id = task0 + sq_id;
        double fac_sym = PI_FAC;
        ShellQuartet sq;
        if (task_id >= ntasks) {
            // To avoid __syncthreads blocking blocking idle warps, all remaining
            // threads compute a valid shell quartet with zero normalization factor
            sq = shl_quartet_idx[0];
            fac_sym = 0.;
        } else {
            sq = shl_quartet_idx[task_id];
        }
        int ish = sq.i;
        int jsh = sq.j;
        int ksh = sq.k;
        int lsh = sq.l;
        if (ksh == lsh) fac_sym *= .5;
        int i0 = ao_loc[ish];
        int j0 = ao_loc[jsh];
        int k0 = ao_loc[ksh];
        int l0 = ao_loc[lsh];
        double *expk = env + bas[ksh*BAS_SLOTS+PTR_EXP];
        double *expl = env + bas[lsh*BAS_SLOTS+PTR_EXP];
        double *ck = env + bas[ksh*BAS_SLOTS+PTR_COEFF];
        double *cl = env + bas[lsh*BAS_SLOTS+PTR_COEFF];
        double *rk = env + bas[ksh*BAS_SLOTS+PTR_BAS_COORD];
        double *rl = env + bas[lsh*BAS_SLOTS+PTR_BAS_COORD];
        double xlxk = rl[0] - rk[0];
        double ylyk = rl[1] - rk[1];
        double zlzk = rl[2] - rk[2];
        if (gout_id == 0) {
            rlrk[0] = xlxk;
            rlrk[64] = ylyk;
            rlrk[128] = zlzk;
        }
        
        gout0x = 0;
        gout0y = 0;
        gout0z = 0;
        gout1x = 0;
        gout1y = 0;
        gout1z = 0;
        gout2x = 0;
        gout2y = 0;
        gout2z = 0;
        gout3x = 0;
        gout3y = 0;
        gout3z = 0;
        gout4x = 0;
        gout4y = 0;
        gout4z = 0;
        gout5x = 0;
        gout5y = 0;
        gout5z = 0;
        gout6x = 0;
        gout6y = 0;
        gout6z = 0;
        gout7x = 0;
        gout7y = 0;
        gout7z = 0;
        gout8x = 0;
        gout8y = 0;
        gout8z = 0;
        for (int klp = 0; klp < kprim*lprim; ++klp) {
            int kp = klp / lprim;
            int lp = klp % lprim;
            double ak = expk[kp];
            double al = expl[lp];
            double akl = ak + al;
            double al_akl = al / akl;
            __syncthreads();
            double xlxk = rlrk[0];
            double ylyk = rlrk[64];
            double zlzk = rlrk[128];
            double theta_kl = ak * al_akl;
            double Kcd = exp(-theta_kl * (xlxk*xlxk+ylyk*ylyk+zlzk*zlzk));
            double ckcl = fac_sym * ck[kp] * cl[lp] * Kcd;
            for (int ijp = 0; ijp < iprim*jprim; ++ijp) {
                double *rjri = rjri_cache + ijp*6;
                double aij = rjri[4];
                double ai = rjri[5] * .5;
                double aj_aij = 1. - ai / aij;
                double xpa = rjri[0] * aj_aij;
                double ypa = rjri[1] * aj_aij;
                double zpa = rjri[2] * aj_aij;
                double xij = ri[0] + xpa;
                double yij = ri[1] + ypa;
                double zij = ri[2] + zpa;
                double xkl = rk[0] + rlrk[0] * al_akl;
                double ykl = rk[1] + rlrk[64] * al_akl;
                double zkl = rk[2] + rlrk[128] * al_akl;
                double xpq = xij - xkl;
                double ypq = yij - ykl;
                double zpq = zij - zkl;
                double cicj = rjri[3];
                double fac = cicj * ckcl / (aij*akl*sqrt(aij+akl));
                double theta = aij * akl / (aij + akl);
                double rr = xpq * xpq + ypq * ypq + zpq * zpq;
                __syncthreads();
                if (gout_id == 0) {
                    Rpq[0] = xpq;
                    Rpq[64] = ypq;
                    Rpq[128] = zpq;
                }
                rys_roots_rs(nroots, theta, rr, omega, rw, 64, gout_id, 4);
                for (int irys = 0; irys < nroots; ++irys) {
                    __syncthreads();
                    double rt = rw[irys*128];
                    double aij = rjri[4];
                    double rt_aa = rt / (aij + akl);
                    double rt_aij = rt_aa * akl;
                    double b10 = .5/aij * (1 - rt_aij);
                    for (int n = gout_id; n < 3; n += 4) {
                        if (n == 2) {
                            gz[0] = rw[irys*128+64] * fac;
                        }
                        double *_gx = gx + n * 768;
                        double xjxi = rjri[n];
                        double Rpa = xjxi * aj_aij;
                        double c0x = Rpa - rt_aij * Rpq[n*64];
                        s0 = _gx[0];
                        s1 = c0x * s0;
                        _gx[64] = s1;
                        s2 = c0x * s1 + 1 * b10 * s0;
                        _gx[128] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 2 * b10 * s0;
                        _gx[192] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 3 * b10 * s0;
                        _gx[256] = s2;
                        s0 = s1;
                        s1 = s2;
                        s2 = c0x * s1 + 4 * b10 * s0;
                        _gx[320] = s2;
                        s1 = _gx[320];
                        s0 = _gx[256];
                        _gx[512] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[192];
                        _gx[448] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[128];
                        _gx[384] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[64];
                        _gx[320] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[0];
                        _gx[256] = s1 - xjxi * s0;
                        s1 = _gx[512];
                        s0 = _gx[448];
                        _gx[704] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[384];
                        _gx[640] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[320];
                        _gx[576] = s1 - xjxi * s0;
                        s1 = s0;
                        s0 = _gx[256];
                        _gx[512] = s1 - xjxi * s0;
                    }
                    __syncthreads();
                    switch (gout_id) {
                    case 0:
                    ai2 = rjri[5];
                    Ix = gx[640];
                    Iy = gy[0];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[704] - 2 * gx[576]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[64];
                    Iz = gz[64];
                    gout1x += ai2 * gx[576] * Iy * Iz;
                    gout1y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout1z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[256];
                    Iz = gz[64];
                    gout2x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout2y += ai2 * gy[320] * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[0];
                    Iz = gz[256];
                    gout3x += (ai2 * gx[448] - 2 * gx[320]) * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[64];
                    Iz = gz[320];
                    gout4x += ai2 * gx[320] * Iy * Iz;
                    gout4y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout4z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[512];
                    Iz = gz[64];
                    gout5x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout5y += ai2 * gy[576] * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[256];
                    Iz = gz[256];
                    gout6x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout6y += ai2 * gy[320] * Ix * Iz;
                    gout6z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[320];
                    Iz = gz[320];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout7z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[0];
                    Iz = gz[576];
                    gout8x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout8y += ai2 * gy[64] * Ix * Iz;
                    gout8z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    break;
                    case 1:
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[64];
                    Iz = gz[0];
                    gout0x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout0y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[0];
                    Iz = gz[128];
                    gout1x += ai2 * gx[576] * Iy * Iz;
                    gout1y += ai2 * gy[64] * Ix * Iz;
                    gout1z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[384];
                    Iz = gz[0];
                    gout2x += ai2 * gx[320] * Iy * Iz;
                    gout2y += (ai2 * gy[448] - 2 * gy[320]) * Ix * Iz;
                    gout2z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[64];
                    Iz = gz[256];
                    gout3x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout3y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[0];
                    Iz = gz[384];
                    gout4x += ai2 * gx[320] * Iy * Iz;
                    gout4y += ai2 * gy[64] * Ix * Iz;
                    gout4z += (ai2 * gz[448] - 2 * gz[320]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[640];
                    Iz = gz[0];
                    gout5x += ai2 * gx[64] * Iy * Iz;
                    gout5y += (ai2 * gy[704] - 2 * gy[576]) * Ix * Iz;
                    gout5z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[320];
                    Iz = gz[256];
                    gout6x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout6y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout6z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[256];
                    Iz = gz[384];
                    gout7x += ai2 * gx[64] * Iy * Iz;
                    gout7y += ai2 * gy[320] * Ix * Iz;
                    gout7z += (ai2 * gz[448] - 2 * gz[320]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[128];
                    Iz = gz[512];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout8z += ai2 * gz[576] * Ix * Iy;
                    break;
                    case 2:
                    ai2 = rjri[5];
                    Ix = gx[576];
                    Iy = gy[0];
                    Iz = gz[64];
                    gout0x += (ai2 * gx[640] - 1 * gx[512]) * Iy * Iz;
                    gout0y += ai2 * gy[64] * Ix * Iz;
                    gout0z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[384];
                    Iy = gy[256];
                    Iz = gz[0];
                    gout1x += (ai2 * gx[448] - 2 * gx[320]) * Iy * Iz;
                    gout1y += ai2 * gy[320] * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[320];
                    Iz = gz[64];
                    gout2x += ai2 * gx[320] * Iy * Iz;
                    gout2y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout2z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[0];
                    Iz = gz[320];
                    gout3x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout3y += ai2 * gy[64] * Ix * Iz;
                    gout3z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[512];
                    Iz = gz[0];
                    gout4x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout4y += ai2 * gy[576] * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[576];
                    Iz = gz[64];
                    gout5x += ai2 * gx[64] * Iy * Iz;
                    gout5y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout5z += (ai2 * gz[128] - 1 * gz[0]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[256];
                    Iz = gz[320];
                    gout6x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout6y += ai2 * gy[320] * Ix * Iz;
                    gout6z += (ai2 * gz[384] - 1 * gz[256]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[128];
                    Iy = gy[0];
                    Iz = gz[512];
                    gout7x += (ai2 * gx[192] - 2 * gx[64]) * Iy * Iz;
                    gout7y += ai2 * gy[64] * Ix * Iz;
                    gout7z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[64];
                    Iz = gz[576];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout8z += (ai2 * gz[640] - 1 * gz[512]) * Ix * Iy;
                    break;
                    case 3:
                    ai2 = rjri[5];
                    Ix = gx[512];
                    Iy = gy[128];
                    Iz = gz[0];
                    gout0x += ai2 * gx[576] * Iy * Iz;
                    gout0y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout0z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[320];
                    Iy = gy[320];
                    Iz = gz[0];
                    gout1x += (ai2 * gx[384] - 1 * gx[256]) * Iy * Iz;
                    gout1y += (ai2 * gy[384] - 1 * gy[256]) * Ix * Iz;
                    gout1z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[256];
                    Iz = gz[128];
                    gout2x += ai2 * gx[320] * Iy * Iz;
                    gout2y += ai2 * gy[320] * Ix * Iz;
                    gout2z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[256];
                    Iy = gy[128];
                    Iz = gz[256];
                    gout3x += ai2 * gx[320] * Iy * Iz;
                    gout3y += (ai2 * gy[192] - 2 * gy[64]) * Ix * Iz;
                    gout3z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[576];
                    Iz = gz[0];
                    gout4x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout4y += (ai2 * gy[640] - 1 * gy[512]) * Ix * Iz;
                    gout4z += ai2 * gz[64] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[512];
                    Iz = gz[128];
                    gout5x += ai2 * gx[64] * Iy * Iz;
                    gout5y += ai2 * gy[576] * Ix * Iz;
                    gout5z += (ai2 * gz[192] - 2 * gz[64]) * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[384];
                    Iz = gz[256];
                    gout6x += ai2 * gx[64] * Iy * Iz;
                    gout6y += (ai2 * gy[448] - 2 * gy[320]) * Ix * Iz;
                    gout6z += ai2 * gz[320] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[64];
                    Iy = gy[64];
                    Iz = gz[512];
                    gout7x += (ai2 * gx[128] - 1 * gx[0]) * Iy * Iz;
                    gout7y += (ai2 * gy[128] - 1 * gy[0]) * Ix * Iz;
                    gout7z += ai2 * gz[576] * Ix * Iy;
                    ai2 = rjri[5];
                    Ix = gx[0];
                    Iy = gy[0];
                    Iz = gz[640];
                    gout8x += ai2 * gx[64] * Iy * Iz;
                    gout8y += ai2 * gy[64] * Ix * Iz;
                    gout8z += (ai2 * gz[704] - 2 * gz[576]) * Ix * Iy;
                    break;
                    }
                }
            }
        }
        if (task_id < ntasks) {
            int ia = bas[ish*BAS_SLOTS+ATOM_OF] - jk.atom_offset;
            double *dm = jk.dm;
            int do_j = jk.vj != NULL;
            int do_k = jk.vk != NULL;
            double *vj_x = jk.vj + (ia*3+0)*nao*nao;
            double *vj_y = jk.vj + (ia*3+1)*nao*nao;
            double *vj_z = jk.vj + (ia*3+2)*nao*nao;
            double *vk_x = jk.vk + (ia*3+0)*nao*nao;
            double *vk_y = jk.vk + (ia*3+1)*nao*nao;
            double *vk_z = jk.vk + (ia*3+2)*nao*nao;
            if (do_j) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+2), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+0)];
                fy = gout6y * dm[(l0+0)*nao+(k0+0)];
                fz = gout6z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+4), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+1), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+3), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+0)];
                fy = gout8y * dm[(l0+0)*nao+(k0+0)];
                fz = gout8z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+5), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+0), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+2), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+0)];
                fy = gout7y * dm[(l0+0)*nao+(k0+0)];
                fz = gout7z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+4), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+0)];
                fy = gout0y * dm[(j0+0)*nao+(i0+0)];
                fz = gout0z * dm[(j0+0)*nao+(i0+0)];
                fx += gout1x * dm[(j0+0)*nao+(i0+4)];
                fy += gout1y * dm[(j0+0)*nao+(i0+4)];
                fz += gout1z * dm[(j0+0)*nao+(i0+4)];
                fx += gout2x * dm[(j0+1)*nao+(i0+2)];
                fy += gout2y * dm[(j0+1)*nao+(i0+2)];
                fz += gout2z * dm[(j0+1)*nao+(i0+2)];
                fx += gout3x * dm[(j0+2)*nao+(i0+0)];
                fy += gout3y * dm[(j0+2)*nao+(i0+0)];
                fz += gout3z * dm[(j0+2)*nao+(i0+0)];
                fx += gout4x * dm[(j0+2)*nao+(i0+4)];
                fy += gout4y * dm[(j0+2)*nao+(i0+4)];
                fz += gout4z * dm[(j0+2)*nao+(i0+4)];
                fx += gout5x * dm[(j0+3)*nao+(i0+2)];
                fy += gout5y * dm[(j0+3)*nao+(i0+2)];
                fz += gout5z * dm[(j0+3)*nao+(i0+2)];
                fx += gout6x * dm[(j0+4)*nao+(i0+0)];
                fy += gout6y * dm[(j0+4)*nao+(i0+0)];
                fz += gout6z * dm[(j0+4)*nao+(i0+0)];
                fx += gout7x * dm[(j0+4)*nao+(i0+4)];
                fy += gout7y * dm[(j0+4)*nao+(i0+4)];
                fz += gout7z * dm[(j0+4)*nao+(i0+4)];
                fx += gout8x * dm[(j0+5)*nao+(i0+2)];
                fy += gout8y * dm[(j0+5)*nao+(i0+2)];
                fz += gout8z * dm[(j0+5)*nao+(i0+2)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                break;
                case 1:
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+2), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+0)];
                fy = gout6y * dm[(l0+0)*nao+(k0+0)];
                fz = gout6z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+4), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+1), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+3), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+0)];
                fy = gout8y * dm[(l0+0)*nao+(k0+0)];
                fz = gout8z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+5), fz);
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+0), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+2), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+0)];
                fy = gout7y * dm[(l0+0)*nao+(k0+0)];
                fz = gout7z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+4), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+1)];
                fy = gout0y * dm[(j0+0)*nao+(i0+1)];
                fz = gout0z * dm[(j0+0)*nao+(i0+1)];
                fx += gout1x * dm[(j0+0)*nao+(i0+5)];
                fy += gout1y * dm[(j0+0)*nao+(i0+5)];
                fz += gout1z * dm[(j0+0)*nao+(i0+5)];
                fx += gout2x * dm[(j0+1)*nao+(i0+3)];
                fy += gout2y * dm[(j0+1)*nao+(i0+3)];
                fz += gout2z * dm[(j0+1)*nao+(i0+3)];
                fx += gout3x * dm[(j0+2)*nao+(i0+1)];
                fy += gout3y * dm[(j0+2)*nao+(i0+1)];
                fz += gout3z * dm[(j0+2)*nao+(i0+1)];
                fx += gout4x * dm[(j0+2)*nao+(i0+5)];
                fy += gout4y * dm[(j0+2)*nao+(i0+5)];
                fz += gout4z * dm[(j0+2)*nao+(i0+5)];
                fx += gout5x * dm[(j0+3)*nao+(i0+3)];
                fy += gout5y * dm[(j0+3)*nao+(i0+3)];
                fz += gout5z * dm[(j0+3)*nao+(i0+3)];
                fx += gout6x * dm[(j0+4)*nao+(i0+1)];
                fy += gout6y * dm[(j0+4)*nao+(i0+1)];
                fz += gout6z * dm[(j0+4)*nao+(i0+1)];
                fx += gout7x * dm[(j0+4)*nao+(i0+5)];
                fy += gout7y * dm[(j0+4)*nao+(i0+5)];
                fz += gout7z * dm[(j0+4)*nao+(i0+5)];
                fx += gout8x * dm[(j0+5)*nao+(i0+3)];
                fy += gout8y * dm[(j0+5)*nao+(i0+3)];
                fz += gout8z * dm[(j0+5)*nao+(i0+3)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                break;
                case 2:
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+1), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+3), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+0)];
                fy = gout7y * dm[(l0+0)*nao+(k0+0)];
                fz = gout7z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+0)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+0)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+0)*nao+(j0+5), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+2), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+0)];
                fy = gout6y * dm[(l0+0)*nao+(k0+0)];
                fz = gout6z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+2)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+2)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+2)*nao+(j0+4), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+1), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+3), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+0)];
                fy = gout8y * dm[(l0+0)*nao+(k0+0)];
                fz = gout8z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+4)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+4)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+4)*nao+(j0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+2)];
                fy = gout0y * dm[(j0+0)*nao+(i0+2)];
                fz = gout0z * dm[(j0+0)*nao+(i0+2)];
                fx += gout1x * dm[(j0+1)*nao+(i0+0)];
                fy += gout1y * dm[(j0+1)*nao+(i0+0)];
                fz += gout1z * dm[(j0+1)*nao+(i0+0)];
                fx += gout2x * dm[(j0+1)*nao+(i0+4)];
                fy += gout2y * dm[(j0+1)*nao+(i0+4)];
                fz += gout2z * dm[(j0+1)*nao+(i0+4)];
                fx += gout3x * dm[(j0+2)*nao+(i0+2)];
                fy += gout3y * dm[(j0+2)*nao+(i0+2)];
                fz += gout3z * dm[(j0+2)*nao+(i0+2)];
                fx += gout4x * dm[(j0+3)*nao+(i0+0)];
                fy += gout4y * dm[(j0+3)*nao+(i0+0)];
                fz += gout4z * dm[(j0+3)*nao+(i0+0)];
                fx += gout5x * dm[(j0+3)*nao+(i0+4)];
                fy += gout5y * dm[(j0+3)*nao+(i0+4)];
                fz += gout5z * dm[(j0+3)*nao+(i0+4)];
                fx += gout6x * dm[(j0+4)*nao+(i0+2)];
                fy += gout6y * dm[(j0+4)*nao+(i0+2)];
                fz += gout6z * dm[(j0+4)*nao+(i0+2)];
                fx += gout7x * dm[(j0+5)*nao+(i0+0)];
                fy += gout7y * dm[(j0+5)*nao+(i0+0)];
                fz += gout7z * dm[(j0+5)*nao+(i0+0)];
                fx += gout8x * dm[(j0+5)*nao+(i0+4)];
                fy += gout8y * dm[(j0+5)*nao+(i0+4)];
                fz += gout8z * dm[(j0+5)*nao+(i0+4)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                break;
                case 3:
                fx = gout1x * dm[(l0+0)*nao+(k0+0)];
                fy = gout1y * dm[(l0+0)*nao+(k0+0)];
                fz = gout1z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+1), fz);
                fx = gout4x * dm[(l0+0)*nao+(k0+0)];
                fy = gout4y * dm[(l0+0)*nao+(k0+0)];
                fz = gout4z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+3), fz);
                fx = gout7x * dm[(l0+0)*nao+(k0+0)];
                fy = gout7y * dm[(l0+0)*nao+(k0+0)];
                fz = gout7z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+1)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+1)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+1)*nao+(j0+5), fz);
                fx = gout0x * dm[(l0+0)*nao+(k0+0)];
                fy = gout0y * dm[(l0+0)*nao+(k0+0)];
                fz = gout0z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+0), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+0), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+0), fz);
                fx = gout3x * dm[(l0+0)*nao+(k0+0)];
                fy = gout3y * dm[(l0+0)*nao+(k0+0)];
                fz = gout3z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+2), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+2), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+2), fz);
                fx = gout6x * dm[(l0+0)*nao+(k0+0)];
                fy = gout6y * dm[(l0+0)*nao+(k0+0)];
                fz = gout6z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+3)*nao+(j0+4), fx);
                atomicAdd(vj_y+(i0+3)*nao+(j0+4), fy);
                atomicAdd(vj_z+(i0+3)*nao+(j0+4), fz);
                fx = gout2x * dm[(l0+0)*nao+(k0+0)];
                fy = gout2y * dm[(l0+0)*nao+(k0+0)];
                fz = gout2z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+1), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+1), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+1), fz);
                fx = gout5x * dm[(l0+0)*nao+(k0+0)];
                fy = gout5y * dm[(l0+0)*nao+(k0+0)];
                fz = gout5z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+3), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+3), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+3), fz);
                fx = gout8x * dm[(l0+0)*nao+(k0+0)];
                fy = gout8y * dm[(l0+0)*nao+(k0+0)];
                fz = gout8z * dm[(l0+0)*nao+(k0+0)];
                atomicAdd(vj_x+(i0+5)*nao+(j0+5), fx);
                atomicAdd(vj_y+(i0+5)*nao+(j0+5), fy);
                atomicAdd(vj_z+(i0+5)*nao+(j0+5), fz);
                fx = gout0x * dm[(j0+0)*nao+(i0+3)];
                fy = gout0y * dm[(j0+0)*nao+(i0+3)];
                fz = gout0z * dm[(j0+0)*nao+(i0+3)];
                fx += gout1x * dm[(j0+1)*nao+(i0+1)];
                fy += gout1y * dm[(j0+1)*nao+(i0+1)];
                fz += gout1z * dm[(j0+1)*nao+(i0+1)];
                fx += gout2x * dm[(j0+1)*nao+(i0+5)];
                fy += gout2y * dm[(j0+1)*nao+(i0+5)];
                fz += gout2z * dm[(j0+1)*nao+(i0+5)];
                fx += gout3x * dm[(j0+2)*nao+(i0+3)];
                fy += gout3y * dm[(j0+2)*nao+(i0+3)];
                fz += gout3z * dm[(j0+2)*nao+(i0+3)];
                fx += gout4x * dm[(j0+3)*nao+(i0+1)];
                fy += gout4y * dm[(j0+3)*nao+(i0+1)];
                fz += gout4z * dm[(j0+3)*nao+(i0+1)];
                fx += gout5x * dm[(j0+3)*nao+(i0+5)];
                fy += gout5y * dm[(j0+3)*nao+(i0+5)];
                fz += gout5z * dm[(j0+3)*nao+(i0+5)];
                fx += gout6x * dm[(j0+4)*nao+(i0+3)];
                fy += gout6y * dm[(j0+4)*nao+(i0+3)];
                fz += gout6z * dm[(j0+4)*nao+(i0+3)];
                fx += gout7x * dm[(j0+5)*nao+(i0+1)];
                fy += gout7y * dm[(j0+5)*nao+(i0+1)];
                fz += gout7z * dm[(j0+5)*nao+(i0+1)];
                fx += gout8x * dm[(j0+5)*nao+(i0+5)];
                fy += gout8y * dm[(j0+5)*nao+(i0+5)];
                fz += gout8z * dm[(j0+5)*nao+(i0+5)];
                atomicAdd(vj_x+(k0+0)*nao+(l0+0), fx);
                atomicAdd(vj_y+(k0+0)*nao+(l0+0), fy);
                atomicAdd(vj_z+(k0+0)*nao+(l0+0), fz);
                break;
                }
            }
            if (do_k) {
                switch (gout_id) {
                case 0:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+2)*nao+(k0+0)];
                fy += gout3y * dm[(j0+2)*nao+(k0+0)];
                fz += gout3z * dm[(j0+2)*nao+(k0+0)];
                fx += gout6x * dm[(j0+4)*nao+(k0+0)];
                fy += gout6y * dm[(j0+4)*nao+(k0+0)];
                fz += gout6z * dm[(j0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+1)*nao+(k0+0)];
                fy = gout2y * dm[(j0+1)*nao+(k0+0)];
                fz = gout2z * dm[(j0+1)*nao+(k0+0)];
                fx += gout5x * dm[(j0+3)*nao+(k0+0)];
                fy += gout5y * dm[(j0+3)*nao+(k0+0)];
                fz += gout5z * dm[(j0+3)*nao+(k0+0)];
                fx += gout8x * dm[(j0+5)*nao+(k0+0)];
                fy += gout8y * dm[(j0+5)*nao+(k0+0)];
                fz += gout8z * dm[(j0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+2)*nao+(k0+0)];
                fy += gout4y * dm[(j0+2)*nao+(k0+0)];
                fz += gout4z * dm[(j0+2)*nao+(k0+0)];
                fx += gout7x * dm[(j0+4)*nao+(k0+0)];
                fy += gout7y * dm[(j0+4)*nao+(k0+0)];
                fz += gout7z * dm[(j0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(k0+0)];
                fy = gout0y * dm[(i0+0)*nao+(k0+0)];
                fz = gout0z * dm[(i0+0)*nao+(k0+0)];
                fx += gout1x * dm[(i0+4)*nao+(k0+0)];
                fy += gout1y * dm[(i0+4)*nao+(k0+0)];
                fz += gout1z * dm[(i0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+2)*nao+(k0+0)];
                fy = gout2y * dm[(i0+2)*nao+(k0+0)];
                fz = gout2z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(k0+0)];
                fy = gout3y * dm[(i0+0)*nao+(k0+0)];
                fz = gout3z * dm[(i0+0)*nao+(k0+0)];
                fx += gout4x * dm[(i0+4)*nao+(k0+0)];
                fy += gout4y * dm[(i0+4)*nao+(k0+0)];
                fz += gout4z * dm[(i0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+2)*nao+(k0+0)];
                fy = gout5y * dm[(i0+2)*nao+(k0+0)];
                fz = gout5z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(k0+0)];
                fy = gout6y * dm[(i0+0)*nao+(k0+0)];
                fz = gout6z * dm[(i0+0)*nao+(k0+0)];
                fx += gout7x * dm[(i0+4)*nao+(k0+0)];
                fy += gout7y * dm[(i0+4)*nao+(k0+0)];
                fz += gout7z * dm[(i0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout8x * dm[(i0+2)*nao+(k0+0)];
                fy = gout8y * dm[(i0+2)*nao+(k0+0)];
                fz = gout8z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+2)*nao+(l0+0)];
                fy += gout3y * dm[(j0+2)*nao+(l0+0)];
                fz += gout3z * dm[(j0+2)*nao+(l0+0)];
                fx += gout6x * dm[(j0+4)*nao+(l0+0)];
                fy += gout6y * dm[(j0+4)*nao+(l0+0)];
                fz += gout6z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+1)*nao+(l0+0)];
                fy = gout2y * dm[(j0+1)*nao+(l0+0)];
                fz = gout2z * dm[(j0+1)*nao+(l0+0)];
                fx += gout5x * dm[(j0+3)*nao+(l0+0)];
                fy += gout5y * dm[(j0+3)*nao+(l0+0)];
                fz += gout5z * dm[(j0+3)*nao+(l0+0)];
                fx += gout8x * dm[(j0+5)*nao+(l0+0)];
                fy += gout8y * dm[(j0+5)*nao+(l0+0)];
                fz += gout8z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout4x * dm[(j0+2)*nao+(l0+0)];
                fy += gout4y * dm[(j0+2)*nao+(l0+0)];
                fz += gout4z * dm[(j0+2)*nao+(l0+0)];
                fx += gout7x * dm[(j0+4)*nao+(l0+0)];
                fy += gout7y * dm[(j0+4)*nao+(l0+0)];
                fz += gout7z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+0)*nao+(l0+0)];
                fy = gout0y * dm[(i0+0)*nao+(l0+0)];
                fz = gout0z * dm[(i0+0)*nao+(l0+0)];
                fx += gout1x * dm[(i0+4)*nao+(l0+0)];
                fy += gout1y * dm[(i0+4)*nao+(l0+0)];
                fz += gout1z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+2)*nao+(l0+0)];
                fy = gout2y * dm[(i0+2)*nao+(l0+0)];
                fz = gout2z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+0)*nao+(l0+0)];
                fy = gout3y * dm[(i0+0)*nao+(l0+0)];
                fz = gout3z * dm[(i0+0)*nao+(l0+0)];
                fx += gout4x * dm[(i0+4)*nao+(l0+0)];
                fy += gout4y * dm[(i0+4)*nao+(l0+0)];
                fz += gout4z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+2)*nao+(l0+0)];
                fy = gout5y * dm[(i0+2)*nao+(l0+0)];
                fz = gout5z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+0)*nao+(l0+0)];
                fy = gout6y * dm[(i0+0)*nao+(l0+0)];
                fz = gout6z * dm[(i0+0)*nao+(l0+0)];
                fx += gout7x * dm[(i0+4)*nao+(l0+0)];
                fy += gout7y * dm[(i0+4)*nao+(l0+0)];
                fz += gout7z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout8x * dm[(i0+2)*nao+(l0+0)];
                fy = gout8y * dm[(i0+2)*nao+(l0+0)];
                fz = gout8z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
                break;
                case 1:
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+2)*nao+(k0+0)];
                fy += gout3y * dm[(j0+2)*nao+(k0+0)];
                fz += gout3z * dm[(j0+2)*nao+(k0+0)];
                fx += gout6x * dm[(j0+4)*nao+(k0+0)];
                fy += gout6y * dm[(j0+4)*nao+(k0+0)];
                fz += gout6z * dm[(j0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+1)*nao+(k0+0)];
                fy = gout2y * dm[(j0+1)*nao+(k0+0)];
                fz = gout2z * dm[(j0+1)*nao+(k0+0)];
                fx += gout5x * dm[(j0+3)*nao+(k0+0)];
                fy += gout5y * dm[(j0+3)*nao+(k0+0)];
                fz += gout5z * dm[(j0+3)*nao+(k0+0)];
                fx += gout8x * dm[(j0+5)*nao+(k0+0)];
                fy += gout8y * dm[(j0+5)*nao+(k0+0)];
                fz += gout8z * dm[(j0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(k0+0)];
                fy = gout1y * dm[(j0+0)*nao+(k0+0)];
                fz = gout1z * dm[(j0+0)*nao+(k0+0)];
                fx += gout4x * dm[(j0+2)*nao+(k0+0)];
                fy += gout4y * dm[(j0+2)*nao+(k0+0)];
                fz += gout4z * dm[(j0+2)*nao+(k0+0)];
                fx += gout7x * dm[(j0+4)*nao+(k0+0)];
                fy += gout7y * dm[(j0+4)*nao+(k0+0)];
                fz += gout7z * dm[(j0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+1)*nao+(k0+0)];
                fy = gout0y * dm[(i0+1)*nao+(k0+0)];
                fz = gout0z * dm[(i0+1)*nao+(k0+0)];
                fx += gout1x * dm[(i0+5)*nao+(k0+0)];
                fy += gout1y * dm[(i0+5)*nao+(k0+0)];
                fz += gout1z * dm[(i0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout2x * dm[(i0+3)*nao+(k0+0)];
                fy = gout2y * dm[(i0+3)*nao+(k0+0)];
                fz = gout2z * dm[(i0+3)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+1)*nao+(k0+0)];
                fy = gout3y * dm[(i0+1)*nao+(k0+0)];
                fz = gout3z * dm[(i0+1)*nao+(k0+0)];
                fx += gout4x * dm[(i0+5)*nao+(k0+0)];
                fy += gout4y * dm[(i0+5)*nao+(k0+0)];
                fz += gout4z * dm[(i0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout5x * dm[(i0+3)*nao+(k0+0)];
                fy = gout5y * dm[(i0+3)*nao+(k0+0)];
                fz = gout5z * dm[(i0+3)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+1)*nao+(k0+0)];
                fy = gout6y * dm[(i0+1)*nao+(k0+0)];
                fz = gout6z * dm[(i0+1)*nao+(k0+0)];
                fx += gout7x * dm[(i0+5)*nao+(k0+0)];
                fy += gout7y * dm[(i0+5)*nao+(k0+0)];
                fz += gout7z * dm[(i0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout8x * dm[(i0+3)*nao+(k0+0)];
                fy = gout8y * dm[(i0+3)*nao+(k0+0)];
                fz = gout8z * dm[(i0+3)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+2)*nao+(l0+0)];
                fy += gout3y * dm[(j0+2)*nao+(l0+0)];
                fz += gout3z * dm[(j0+2)*nao+(l0+0)];
                fx += gout6x * dm[(j0+4)*nao+(l0+0)];
                fy += gout6y * dm[(j0+4)*nao+(l0+0)];
                fz += gout6z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+1)*nao+(l0+0)];
                fy = gout2y * dm[(j0+1)*nao+(l0+0)];
                fz = gout2z * dm[(j0+1)*nao+(l0+0)];
                fx += gout5x * dm[(j0+3)*nao+(l0+0)];
                fy += gout5y * dm[(j0+3)*nao+(l0+0)];
                fz += gout5z * dm[(j0+3)*nao+(l0+0)];
                fx += gout8x * dm[(j0+5)*nao+(l0+0)];
                fy += gout8y * dm[(j0+5)*nao+(l0+0)];
                fz += gout8z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+0), fz);
                fx = gout1x * dm[(j0+0)*nao+(l0+0)];
                fy = gout1y * dm[(j0+0)*nao+(l0+0)];
                fz = gout1z * dm[(j0+0)*nao+(l0+0)];
                fx += gout4x * dm[(j0+2)*nao+(l0+0)];
                fy += gout4y * dm[(j0+2)*nao+(l0+0)];
                fz += gout4z * dm[(j0+2)*nao+(l0+0)];
                fx += gout7x * dm[(j0+4)*nao+(l0+0)];
                fy += gout7y * dm[(j0+4)*nao+(l0+0)];
                fz += gout7z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+1)*nao+(l0+0)];
                fy = gout0y * dm[(i0+1)*nao+(l0+0)];
                fz = gout0z * dm[(i0+1)*nao+(l0+0)];
                fx += gout1x * dm[(i0+5)*nao+(l0+0)];
                fy += gout1y * dm[(i0+5)*nao+(l0+0)];
                fz += gout1z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout2x * dm[(i0+3)*nao+(l0+0)];
                fy = gout2y * dm[(i0+3)*nao+(l0+0)];
                fz = gout2z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+1)*nao+(l0+0)];
                fy = gout3y * dm[(i0+1)*nao+(l0+0)];
                fz = gout3z * dm[(i0+1)*nao+(l0+0)];
                fx += gout4x * dm[(i0+5)*nao+(l0+0)];
                fy += gout4y * dm[(i0+5)*nao+(l0+0)];
                fz += gout4z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout5x * dm[(i0+3)*nao+(l0+0)];
                fy = gout5y * dm[(i0+3)*nao+(l0+0)];
                fz = gout5z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+1)*nao+(l0+0)];
                fy = gout6y * dm[(i0+1)*nao+(l0+0)];
                fz = gout6z * dm[(i0+1)*nao+(l0+0)];
                fx += gout7x * dm[(i0+5)*nao+(l0+0)];
                fy += gout7y * dm[(i0+5)*nao+(l0+0)];
                fz += gout7z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout8x * dm[(i0+3)*nao+(l0+0)];
                fy = gout8y * dm[(i0+3)*nao+(l0+0)];
                fz = gout8z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
                break;
                case 2:
                fx = gout1x * dm[(j0+1)*nao+(k0+0)];
                fy = gout1y * dm[(j0+1)*nao+(k0+0)];
                fz = gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout4x * dm[(j0+3)*nao+(k0+0)];
                fy += gout4y * dm[(j0+3)*nao+(k0+0)];
                fz += gout4z * dm[(j0+3)*nao+(k0+0)];
                fx += gout7x * dm[(j0+5)*nao+(k0+0)];
                fy += gout7y * dm[(j0+5)*nao+(k0+0)];
                fz += gout7z * dm[(j0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+2)*nao+(k0+0)];
                fy += gout3y * dm[(j0+2)*nao+(k0+0)];
                fz += gout3z * dm[(j0+2)*nao+(k0+0)];
                fx += gout6x * dm[(j0+4)*nao+(k0+0)];
                fy += gout6y * dm[(j0+4)*nao+(k0+0)];
                fz += gout6z * dm[(j0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+1)*nao+(k0+0)];
                fy = gout2y * dm[(j0+1)*nao+(k0+0)];
                fz = gout2z * dm[(j0+1)*nao+(k0+0)];
                fx += gout5x * dm[(j0+3)*nao+(k0+0)];
                fy += gout5y * dm[(j0+3)*nao+(k0+0)];
                fz += gout5z * dm[(j0+3)*nao+(k0+0)];
                fx += gout8x * dm[(j0+5)*nao+(k0+0)];
                fy += gout8y * dm[(j0+5)*nao+(k0+0)];
                fz += gout8z * dm[(j0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+2)*nao+(k0+0)];
                fy = gout0y * dm[(i0+2)*nao+(k0+0)];
                fz = gout0z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(k0+0)];
                fy = gout1y * dm[(i0+0)*nao+(k0+0)];
                fz = gout1z * dm[(i0+0)*nao+(k0+0)];
                fx += gout2x * dm[(i0+4)*nao+(k0+0)];
                fy += gout2y * dm[(i0+4)*nao+(k0+0)];
                fz += gout2z * dm[(i0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+2)*nao+(k0+0)];
                fy = gout3y * dm[(i0+2)*nao+(k0+0)];
                fz = gout3z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(k0+0)];
                fy = gout4y * dm[(i0+0)*nao+(k0+0)];
                fz = gout4z * dm[(i0+0)*nao+(k0+0)];
                fx += gout5x * dm[(i0+4)*nao+(k0+0)];
                fy += gout5y * dm[(i0+4)*nao+(k0+0)];
                fz += gout5z * dm[(i0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+2)*nao+(k0+0)];
                fy = gout6y * dm[(i0+2)*nao+(k0+0)];
                fz = gout6z * dm[(i0+2)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(k0+0)];
                fy = gout7y * dm[(i0+0)*nao+(k0+0)];
                fz = gout7z * dm[(i0+0)*nao+(k0+0)];
                fx += gout8x * dm[(i0+4)*nao+(k0+0)];
                fy += gout8y * dm[(i0+4)*nao+(k0+0)];
                fz += gout8z * dm[(i0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout4x * dm[(j0+3)*nao+(l0+0)];
                fy += gout4y * dm[(j0+3)*nao+(l0+0)];
                fz += gout4z * dm[(j0+3)*nao+(l0+0)];
                fx += gout7x * dm[(j0+5)*nao+(l0+0)];
                fy += gout7y * dm[(j0+5)*nao+(l0+0)];
                fz += gout7z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+0)*nao+(k0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+2)*nao+(l0+0)];
                fy += gout3y * dm[(j0+2)*nao+(l0+0)];
                fz += gout3z * dm[(j0+2)*nao+(l0+0)];
                fx += gout6x * dm[(j0+4)*nao+(l0+0)];
                fy += gout6y * dm[(j0+4)*nao+(l0+0)];
                fz += gout6z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+2)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+1)*nao+(l0+0)];
                fy = gout2y * dm[(j0+1)*nao+(l0+0)];
                fz = gout2z * dm[(j0+1)*nao+(l0+0)];
                fx += gout5x * dm[(j0+3)*nao+(l0+0)];
                fy += gout5y * dm[(j0+3)*nao+(l0+0)];
                fz += gout5z * dm[(j0+3)*nao+(l0+0)];
                fx += gout8x * dm[(j0+5)*nao+(l0+0)];
                fy += gout8y * dm[(j0+5)*nao+(l0+0)];
                fz += gout8z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+4)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+2)*nao+(l0+0)];
                fy = gout0y * dm[(i0+2)*nao+(l0+0)];
                fz = gout0z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+0)*nao+(l0+0)];
                fy = gout1y * dm[(i0+0)*nao+(l0+0)];
                fz = gout1z * dm[(i0+0)*nao+(l0+0)];
                fx += gout2x * dm[(i0+4)*nao+(l0+0)];
                fy += gout2y * dm[(i0+4)*nao+(l0+0)];
                fz += gout2z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+2)*nao+(l0+0)];
                fy = gout3y * dm[(i0+2)*nao+(l0+0)];
                fz = gout3z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+0)*nao+(l0+0)];
                fy = gout4y * dm[(i0+0)*nao+(l0+0)];
                fz = gout4z * dm[(i0+0)*nao+(l0+0)];
                fx += gout5x * dm[(i0+4)*nao+(l0+0)];
                fy += gout5y * dm[(i0+4)*nao+(l0+0)];
                fz += gout5z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+2)*nao+(l0+0)];
                fy = gout6y * dm[(i0+2)*nao+(l0+0)];
                fz = gout6z * dm[(i0+2)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout7x * dm[(i0+0)*nao+(l0+0)];
                fy = gout7y * dm[(i0+0)*nao+(l0+0)];
                fz = gout7z * dm[(i0+0)*nao+(l0+0)];
                fx += gout8x * dm[(i0+4)*nao+(l0+0)];
                fy += gout8y * dm[(i0+4)*nao+(l0+0)];
                fz += gout8z * dm[(i0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
                break;
                case 3:
                fx = gout1x * dm[(j0+1)*nao+(k0+0)];
                fy = gout1y * dm[(j0+1)*nao+(k0+0)];
                fz = gout1z * dm[(j0+1)*nao+(k0+0)];
                fx += gout4x * dm[(j0+3)*nao+(k0+0)];
                fy += gout4y * dm[(j0+3)*nao+(k0+0)];
                fz += gout4z * dm[(j0+3)*nao+(k0+0)];
                fx += gout7x * dm[(j0+5)*nao+(k0+0)];
                fy += gout7y * dm[(j0+5)*nao+(k0+0)];
                fz += gout7z * dm[(j0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(l0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(k0+0)];
                fy = gout0y * dm[(j0+0)*nao+(k0+0)];
                fz = gout0z * dm[(j0+0)*nao+(k0+0)];
                fx += gout3x * dm[(j0+2)*nao+(k0+0)];
                fy += gout3y * dm[(j0+2)*nao+(k0+0)];
                fz += gout3z * dm[(j0+2)*nao+(k0+0)];
                fx += gout6x * dm[(j0+4)*nao+(k0+0)];
                fy += gout6y * dm[(j0+4)*nao+(k0+0)];
                fz += gout6z * dm[(j0+4)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(l0+0), fz);
                fx = gout2x * dm[(j0+1)*nao+(k0+0)];
                fy = gout2y * dm[(j0+1)*nao+(k0+0)];
                fz = gout2z * dm[(j0+1)*nao+(k0+0)];
                fx += gout5x * dm[(j0+3)*nao+(k0+0)];
                fy += gout5y * dm[(j0+3)*nao+(k0+0)];
                fz += gout5z * dm[(j0+3)*nao+(k0+0)];
                fx += gout8x * dm[(j0+5)*nao+(k0+0)];
                fy += gout8y * dm[(j0+5)*nao+(k0+0)];
                fz += gout8z * dm[(j0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(l0+0), fz);
                fx = gout0x * dm[(i0+3)*nao+(k0+0)];
                fy = gout0y * dm[(i0+3)*nao+(k0+0)];
                fz = gout0z * dm[(i0+3)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(l0+0), fz);
                fx = gout1x * dm[(i0+1)*nao+(k0+0)];
                fy = gout1y * dm[(i0+1)*nao+(k0+0)];
                fz = gout1z * dm[(i0+1)*nao+(k0+0)];
                fx += gout2x * dm[(i0+5)*nao+(k0+0)];
                fy += gout2y * dm[(i0+5)*nao+(k0+0)];
                fz += gout2z * dm[(i0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(l0+0), fz);
                fx = gout3x * dm[(i0+3)*nao+(k0+0)];
                fy = gout3y * dm[(i0+3)*nao+(k0+0)];
                fz = gout3z * dm[(i0+3)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(l0+0), fz);
                fx = gout4x * dm[(i0+1)*nao+(k0+0)];
                fy = gout4y * dm[(i0+1)*nao+(k0+0)];
                fz = gout4z * dm[(i0+1)*nao+(k0+0)];
                fx += gout5x * dm[(i0+5)*nao+(k0+0)];
                fy += gout5y * dm[(i0+5)*nao+(k0+0)];
                fz += gout5z * dm[(i0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(l0+0), fz);
                fx = gout6x * dm[(i0+3)*nao+(k0+0)];
                fy = gout6y * dm[(i0+3)*nao+(k0+0)];
                fz = gout6z * dm[(i0+3)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(l0+0), fz);
                fx = gout7x * dm[(i0+1)*nao+(k0+0)];
                fy = gout7y * dm[(i0+1)*nao+(k0+0)];
                fz = gout7z * dm[(i0+1)*nao+(k0+0)];
                fx += gout8x * dm[(i0+5)*nao+(k0+0)];
                fy += gout8y * dm[(i0+5)*nao+(k0+0)];
                fz += gout8z * dm[(i0+5)*nao+(k0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(l0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(l0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(l0+0), fz);
                fx = gout1x * dm[(j0+1)*nao+(l0+0)];
                fy = gout1y * dm[(j0+1)*nao+(l0+0)];
                fz = gout1z * dm[(j0+1)*nao+(l0+0)];
                fx += gout4x * dm[(j0+3)*nao+(l0+0)];
                fy += gout4y * dm[(j0+3)*nao+(l0+0)];
                fz += gout4z * dm[(j0+3)*nao+(l0+0)];
                fx += gout7x * dm[(j0+5)*nao+(l0+0)];
                fy += gout7y * dm[(j0+5)*nao+(l0+0)];
                fz += gout7z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+1)*nao+(k0+0), fz);
                fx = gout0x * dm[(j0+0)*nao+(l0+0)];
                fy = gout0y * dm[(j0+0)*nao+(l0+0)];
                fz = gout0z * dm[(j0+0)*nao+(l0+0)];
                fx += gout3x * dm[(j0+2)*nao+(l0+0)];
                fy += gout3y * dm[(j0+2)*nao+(l0+0)];
                fz += gout3z * dm[(j0+2)*nao+(l0+0)];
                fx += gout6x * dm[(j0+4)*nao+(l0+0)];
                fy += gout6y * dm[(j0+4)*nao+(l0+0)];
                fz += gout6z * dm[(j0+4)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+3)*nao+(k0+0), fz);
                fx = gout2x * dm[(j0+1)*nao+(l0+0)];
                fy = gout2y * dm[(j0+1)*nao+(l0+0)];
                fz = gout2z * dm[(j0+1)*nao+(l0+0)];
                fx += gout5x * dm[(j0+3)*nao+(l0+0)];
                fy += gout5y * dm[(j0+3)*nao+(l0+0)];
                fz += gout5z * dm[(j0+3)*nao+(l0+0)];
                fx += gout8x * dm[(j0+5)*nao+(l0+0)];
                fy += gout8y * dm[(j0+5)*nao+(l0+0)];
                fz += gout8z * dm[(j0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(i0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(i0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(i0+5)*nao+(k0+0), fz);
                fx = gout0x * dm[(i0+3)*nao+(l0+0)];
                fy = gout0y * dm[(i0+3)*nao+(l0+0)];
                fz = gout0z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+0)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+0)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+0)*nao+(k0+0), fz);
                fx = gout1x * dm[(i0+1)*nao+(l0+0)];
                fy = gout1y * dm[(i0+1)*nao+(l0+0)];
                fz = gout1z * dm[(i0+1)*nao+(l0+0)];
                fx += gout2x * dm[(i0+5)*nao+(l0+0)];
                fy += gout2y * dm[(i0+5)*nao+(l0+0)];
                fz += gout2z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+1)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+1)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+1)*nao+(k0+0), fz);
                fx = gout3x * dm[(i0+3)*nao+(l0+0)];
                fy = gout3y * dm[(i0+3)*nao+(l0+0)];
                fz = gout3z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+2)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+2)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+2)*nao+(k0+0), fz);
                fx = gout4x * dm[(i0+1)*nao+(l0+0)];
                fy = gout4y * dm[(i0+1)*nao+(l0+0)];
                fz = gout4z * dm[(i0+1)*nao+(l0+0)];
                fx += gout5x * dm[(i0+5)*nao+(l0+0)];
                fy += gout5y * dm[(i0+5)*nao+(l0+0)];
                fz += gout5z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+3)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+3)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+3)*nao+(k0+0), fz);
                fx = gout6x * dm[(i0+3)*nao+(l0+0)];
                fy = gout6y * dm[(i0+3)*nao+(l0+0)];
                fz = gout6z * dm[(i0+3)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+4)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+4)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+4)*nao+(k0+0), fz);
                fx = gout7x * dm[(i0+1)*nao+(l0+0)];
                fy = gout7y * dm[(i0+1)*nao+(l0+0)];
                fz = gout7z * dm[(i0+1)*nao+(l0+0)];
                fx += gout8x * dm[(i0+5)*nao+(l0+0)];
                fy += gout8y * dm[(i0+5)*nao+(l0+0)];
                fz += gout8z * dm[(i0+5)*nao+(l0+0)];
                atomicAdd(vk_x+(j0+5)*nao+(k0+0), fx);
                atomicAdd(vk_y+(j0+5)*nao+(k0+0), fy);
                atomicAdd(vk_z+(j0+5)*nao+(k0+0), fz);
                break;
                }
            }
        }
    }
}
__global__
static void rys_vjk_ip1_2200(RysIntEnvVars envs, JKMatrix jk, BoundsInfo bounds,
                ShellQuartet *pool, uint32_t *batch_head)
{
    int b_id = blockIdx.x;
    int t_id = threadIdx.x + blockDim.x * threadIdx.y;
    ShellQuartet *shl_quartet_idx = pool + b_id * QUEUE_DEPTH1;
    extern __shared__ int batch_id[];
    if (t_id == 0) {
        batch_id[0] = atomicAdd(batch_head, 1);
    }
    __syncthreads();
    int nbatches_kl = (bounds.npairs_kl + QUEUE_DEPTH1 - 1) / QUEUE_DEPTH1;
    int nbatches = bounds.npairs_ij * nbatches_kl;
    while (batch_id[0] < nbatches) {
        int batch_ij = batch_id[0] / nbatches_kl;
        int batch_kl = batch_id[0] % nbatches_kl;
        int ntasks = _fill_jk_tasks_s2kl(shl_quartet_idx, envs, jk, bounds,
                                         batch_ij, batch_kl);
        if (ntasks > 0) {
            _rys_vjk_ip1_2200(envs, jk, bounds, shl_quartet_idx, ntasks);
            __syncthreads();
        }
        if (t_id == 0) {
            batch_id[0] = atomicAdd(batch_head, 1);
            atomicAdd(batch_head+1, ntasks);
        }
        __syncthreads();
    }
}

int rys_vjk_ip1_unrolled(RysIntEnvVars *envs, JKMatrix *jk, BoundsInfo *bounds,
                    ShellQuartet *pool, uint32_t *batch_head, int *scheme, int workers)
{
    int li = bounds->li;
    int lj = bounds->lj;
    int lk = bounds->lk;
    int ll = bounds->ll;
    int ijkl = li*125 + lj*25 + lk*5 + ll;
    int nroots = bounds->nroots;
    int iprim = bounds->iprim;
    int jprim = bounds->jprim;
    int ij_prims = iprim * jprim;
    int buflen = ij_prims*6;
    int nsq_per_block = 256;
    int gout_stride = 1;

    switch (ijkl) {
    case 36:
        nsq_per_block = 64;
        gout_stride = 4;
        break;
    case 56:
        nsq_per_block = 64;
        gout_stride = 4;
        break;
    case 60:
        nsq_per_block = 64;
        gout_stride = 4;
        break;
    case 136:
        nsq_per_block = 64;
        gout_stride = 4;
        break;
    case 156:
        nsq_per_block = 64;
        gout_stride = 4;
        break;
    case 160:
        nsq_per_block = 64;
        gout_stride = 4;
        break;
    case 180:
        nsq_per_block = 64;
        gout_stride = 4;
        break;
    case 256:
        nsq_per_block = 64;
        gout_stride = 4;
        break;
    case 260:
        nsq_per_block = 64;
        gout_stride = 4;
        break;
    case 280:
        nsq_per_block = 64;
        gout_stride = 4;
        break;
    case 300:
        nsq_per_block = 64;
        gout_stride = 4;
        break;
    }

#if CUDA_VERSION >= 12040
    switch (ijkl) {
    case 0: nsq_per_block *= 2; break;
    case 5: nsq_per_block *= 2; break;
    case 25: nsq_per_block *= 2; break;
    case 125: nsq_per_block *= 2; break;
    }
#endif

    dim3 threads(nsq_per_block, gout_stride);
    buflen += nroots*2 * nsq_per_block;
    switch (ijkl) {
    case 0:
        rys_vjk_ip1_0000<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 5:
        rys_vjk_ip1_0010<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 6:
        rys_vjk_ip1_0011<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 10:
        rys_vjk_ip1_0020<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 11:
        rys_vjk_ip1_0021<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 12:
        rys_vjk_ip1_0022<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 25:
        rys_vjk_ip1_0100<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 30:
        rys_vjk_ip1_0110<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 31:
        rys_vjk_ip1_0111<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 35:
        rys_vjk_ip1_0120<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 36:
        buflen += 4992;
        cudaFuncSetAttribute(rys_vjk_ip1_0121, cudaFuncAttributeMaxDynamicSharedMemorySize, buflen*sizeof(double));
        rys_vjk_ip1_0121<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 50:
        rys_vjk_ip1_0200<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 55:
        rys_vjk_ip1_0210<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 56:
        buflen += 4992;
        cudaFuncSetAttribute(rys_vjk_ip1_0211, cudaFuncAttributeMaxDynamicSharedMemorySize, buflen*sizeof(double));
        rys_vjk_ip1_0211<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 60:
        buflen += 3840;
        rys_vjk_ip1_0220<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 125:
        rys_vjk_ip1_1000<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 130:
        rys_vjk_ip1_1010<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 131:
        rys_vjk_ip1_1011<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 135:
        rys_vjk_ip1_1020<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 136:
        buflen += 3840;
        rys_vjk_ip1_1021<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 150:
        rys_vjk_ip1_1100<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 155:
        rys_vjk_ip1_1110<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 156:
        buflen += 4992;
        cudaFuncSetAttribute(rys_vjk_ip1_1111, cudaFuncAttributeMaxDynamicSharedMemorySize, buflen*sizeof(double));
        rys_vjk_ip1_1111<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 160:
        buflen += 3840;
        rys_vjk_ip1_1120<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 175:
        rys_vjk_ip1_1200<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 180:
        buflen += 3840;
        rys_vjk_ip1_1210<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 250:
        rys_vjk_ip1_2000<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 255:
        rys_vjk_ip1_2010<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 256:
        buflen += 3456;
        rys_vjk_ip1_2011<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 260:
        buflen += 2688;
        rys_vjk_ip1_2020<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 275:
        rys_vjk_ip1_2100<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 280:
        buflen += 3456;
        rys_vjk_ip1_2110<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    case 300:
        buflen += 2688;
        rys_vjk_ip1_2200<<<workers, threads, buflen*sizeof(double)>>>(*envs, *jk, *bounds, pool, batch_head); break;
    default: return 0;
    }
    return 1;
}
