import numpy
from pyscf.pbc import gto
import gpu4pyscf.pbc.grad.rhf as gpu_grad

from gpu4pyscf.pbc import dft as gpu_pbcdft
from gpu4pyscf.pbc.dft import multi_grid as gpu_multi_grid_mine

import gpu4pyscf.mpi as mpi

print_level = 0
if mpi.comm.rank == 0:
    print_level = 5

boxlen = 12
cell = gto.Cell()
cell.a = numpy.array([[boxlen, 0.0, 0.0], [0.0, boxlen, 0.0], [0.0, 0.0, boxlen]])
cell.atom = """
O   1.6131599999999927e+00 6.554399000000000086e+00 4.322530000000000427e+00
 H   1.428539999999999921e+00 5.878300000000000303e+00 5.021608999999999767e+00
 H   2.016700000000000159e+00 5.965879000000000154e+00 3.618549999999999933e+00
 O   3.162049999999999805e+00 8.750220000000000553e+00 4.021650000000000169e+00
 H   2.443400000000000016e+00 8.029849999999999710e+00 4.224420000000000286e+00
 H   3.217699999999999783e+00 9.223639999999999617e+00 4.884699999999999598e+00
 O   3.699879999999999836e+00 2.308800000000000019e-01 1.688099999999999934e+00
 H   3.378330000000000055e+00 -1.526800000000010094e-01 2.487979999999999858e+00
 H   3.611790000000000056e+00 -4.963400000000008916e-01 9.904600000000000071e-01
 O   2.761179999999999968e+00 4.815249999999999808e+00 2.635450000000000070e+00
 H   3.601900000000000102e+00 4.658520000000000216e+00 3.044760000000000133e+00
 H   2.664039999999999964e+00 4.084109999999999907e+00 1.901380000000000070e+00
 O   2.735829999999999984e+00 2.768990000000000062e+00 8.625249999999999861e-01
 H   3.225159999999999805e+00 2.987849999999999895e+00 2.081399999999999917e-02
 H   3.046959999999999891e+00 1.855429999999999913e+00 1.160919999999999952e+00
 O   6.286438999999999666e+00 2.290369999999999795e+00 8.821559999999999846e+00
 H   5.968110000000000248e+00 2.744099999999999984e+00 8.033289999999999154e+00
 H   6.777009999999999756e+00 3.062409999999999854e+00 9.332560000000000855e+00
 O   7.828409999999999869e+00 1.507100000000000106e-01 8.392839999999999634e+00
 H   7.342240000000000322e+00 9.850069999999999659e-01 8.599750000000000227e+00
 H   8.293810000000000571e+00 4.392679999999999918e-01 7.536319999999999908e+00
 O   8.023160000000000736e+00 4.406859999999999999e+00 3.091870000000000118e+00
 H   8.394849000000000672e+00 5.309750000000000192e+00 3.195619999999999905e+00
 H   8.640340999999999383e+00 3.670160000000000089e+00 3.449829999999999952e+00
 O   8.802900000000000169e-01 8.039229999999999876e+00 9.213679000000000840e+00
 H   8.415660000000000363e-01 7.193209999999999660e+00 8.674718999999999625e+00
 H   2.196639999999999704e-01 7.986270000000000202e+00 1.000949899999999992e+01
 O   9.064199999999999591e+00 6.924749000000000265e+00 3.520599999999999952e+00
 H   8.465909999999999158e+00 7.412720000000000198e+00 4.157799999999999940e+00
 H   9.988750000000001350e+00 6.725628999999999635e+00 3.939830000000000165e+00
 O   8.948019999999999641e+00 6.313640000000000363e-01 6.152389999999999581e+00
 H   9.044129999999999114e+00 1.401569999999999983e+00 5.500958999999999932e+00
 H   8.385590000000000543e+00 -1.140000000000807034e-03 5.602960000000000385e+00
 O   3.534730000000000150e+00 4.748949999999999783e+00 9.054114000000000217e+00
 H   4.178390000000000271e+00 4.482149999999999856e+00 8.334350999999999843e+00
 H   4.127229999999999954e+00 5.240140000000000242e+00 9.672067999999999444e+00
 O   3.358920000000000239e-01 2.494530000000000136e+00 9.636480000000000601e+00
 H   1.202860000000000040e+00 2.586090000000000000e+00 1.015203499999999970e+01
 H   5.128740000000000521e-01 1.707840000000000025e+00 8.991369999999999862e+00
 O   5.396978999999999971e+00 9.042310000000000514e+00 7.849829999999999863e+00
 H   4.806860000000000355e+00 9.104729999999999990e+00 8.584160000000000679e+00
 H   6.234930000000000305e+00 9.470853999999999218e+00 8.027789999999999537e+00
 O   5.312549999999999883e+00 7.267399000000000164e+00 3.871480000000000032e+00
 H   5.523480000000000167e+00 6.673678999999999917e+00 4.583090000000000330e+00
 H   4.439589999999999925e+00 7.688519000000000325e+00 4.027180000000000426e+00
 O   3.640109999999999957e+00 2.769089999999999829e+00 5.298849999999999838e+00
 H   4.295509000000000022e+00 2.899719999999999853e+00 4.492829000000000406e+00
 H   3.570539999999999825e+00 1.784980000000000011e+00 5.447809999999999597e+00
 O   6.166190000000000282e+00 1.170379999999999976e+00 1.786089999999999955e+00
 H   6.130580000000000140e+00 1.303779000000000021e+00 8.153810000000000224e-01
 H   5.323719999999999786e+00 6.682799999999999851e-01 1.850470000000000059e+00
 O   7.325309999999999988e+00 6.730889999999999596e+00 9.447380000000000777e+00
 H   7.661669999999999980e+00 5.848860000000000170e+00 9.777269999999999683e+00
 H   7.843130000000000379e+00 7.476448999999999678e+00 9.791760000000000019e+00
 O   3.425269999999999815e+00 1.819800000000000029e-01 6.263589999999999769e+00
 H   2.653529999999999944e+00 3.684780000000000277e-01 6.839879999999999960e+00
 H   4.165219999999999700e+00 -2.800999999999945200e-02 6.833870000000000111e+00
 O   6.161609999999999587e+00 6.738809999999999967e+00 6.811480000000000423e+00
 H   6.601549999999999585e+00 6.731049999999999756e+00 7.690310000000000201e+00
 H   5.582488999999999812e+00 7.491609999999999658e+00 7.133409999999999584e+00
 O   4.901989999999999625e+00 6.232380000000000031e+00 1.001759999999999984e+00
 H   5.761779999999999902e+00 6.497709999999999653e+00 7.855509999999999993e-01
 H   4.744989000000000345e+00 6.246579999999999799e+00 1.950139999999999985e+00
 O   8.405789999999999651e-01 5.232289999999999885e+00 8.191240000000000521e+00
 H   1.747789999999999955e+00 5.045410000000000394e+00 8.557000000000000384e+00
 H   3.454150000000000276e-01 4.583709999999999951e+00 8.686489999999999156e+00
 O   7.940299999999999692e+00 3.979019999999999779e+00 3.217780000000000085e-01
 H   8.036699999999999733e+00 3.972579999999999778e+00 1.309979000000000005e+00
 H   8.821790999999999272e+00 3.530229999999999979e+00 5.055900000000002059e-02
 O   7.478809000000000040e+00 8.373879999999999768e+00 5.016519999999999868e+00
 H   6.742009999999999614e+00 8.145239999999999370e+00 4.370790000000000397e+00
 H   7.221068999999999960e+00 7.880090000000000039e+00 5.826190000000000424e+00
 O   9.280849999999999156e+00 2.388329999999999842e+00 4.151980000000000004e+00
 H   9.183210000000000761e+00 1.827979999999999938e+00 3.245369999999999866e+00
 H   1.021161100000000133e+01 2.658679999999999932e+00 4.389090000000000380e+00
 O   1.254080000000000084e+00 4.645369999999999777e-01 7.895430000000000170e+00
 H   1.256469999999999976e+00 -4.633700000000011698e-01 8.309519999999999129e+00
 H   6.014380000000000281e-01 3.158309999999999729e-01 7.137828999999999979e+00
 O   1.296478000000000019e+00 3.772909999999999986e+00 5.187479999999999869e+00
 H   9.949799999999999756e-01 3.794970000000000176e+00 6.115859999999999630e+00
 H   2.239078999999999819e+00 3.482419999999999849e+00 5.262089999999999712e+00
 O   9.111838999999999800e+00 9.364479999999999471e-01 1.845920000000000005e+00
 H   9.328799999999999315e+00 1.572829999999999950e+00 1.035940000000000083e+00
 H   8.148089999999999833e+00 1.109220000000000095e+00 1.902290000000000036e+00
 O   9.042099999999999582e+00 8.202519999999999811e+00 1.245139999999999914e+00
 H   8.971420000000000172e+00 7.677189000000000263e+00 2.087380000000000013e+00
 H   8.952019999999999200e+00 9.136589999999999989e+00 1.590840000000000032e+00
 O   5.456690000000000040e+00 3.407529999999999948e+00 3.515839999999999854e+00
 H   5.689119999999999955e+00 2.640190000000000037e+00 2.893349999999999866e+00
 H   6.320500000000000007e+00 3.880230000000000068e+00 3.601630000000000109e+00
 O   3.395610000000000017e+00 8.342399999999999594e+00 9.689235000000000042e+00
 H   3.849619999999999820e+00 7.528200000000000003e+00 9.854933000000000831e+00
 H   2.440109999999999779e+00 8.079959000000000557e+00 9.598266999999999882e+00
 O   5.350819999999999688e+00 3.948150000000000048e+00 6.800580000000000069e+00
 H   5.628269999999999662e+00 4.827779999999999738e+00 6.499189999999999579e+00
 H   4.649670000000000414e+00 3.602860000000000174e+00 6.181708999999999676e+00
"""

cell.basis = "gth-tzv2p"
cell.ke_cutoff = 200  # kinetic energy cutoff in a.u.
cell.max_memory = 40000  # in MB
cell.precision = 1e-8  # integral precision
cell.pseudo = "gth-pade"
cell.verbose = print_level 
cell.use_loose_rcut = True  # integral screening based on shell radii
cell.use_particle_mesh_ewald = True  # use particle mesh ewald for nuclear repulsion
cell.build()

gpu_mf = gpu_pbcdft.RKS(cell)
gpu_mf.xc = "PBE"
gpu_mf.init_guess = "atom"
gpu_mf = gpu_multi_grid_mine.fftdf(gpu_mf)
gpu_mf.kernel()

gradient_object = gpu_grad.Gradients(gpu_mf)
de = gradient_object.kernel()
